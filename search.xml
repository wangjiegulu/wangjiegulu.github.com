<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[Huginn 的 docker 部署及数据迁移]]></title>
      <url>/2018/11/24/huginn_deployment_with_docker_and_data_migration/</url>
      <content type="html"><![CDATA[<h1 id="Huginn-的-docker-部署及数据迁移"><a href="#Huginn-的-docker-部署及数据迁移" class="headerlink" title="Huginn 的 docker 部署及数据迁移"></a>Huginn 的 docker 部署及数据迁移</h1><p>前两天因为要换 vps，其中之前部署的 Huginn 需要迁移到新的 vps。之前也有朋友问过关于 huginn 的数据备份和迁移的问题。这篇文章就讲下整个流程。</p>
<p>在 vps 上安装 huginn，我之前的博客- <a href="https://blog.wangjiegulu.com/2018/04/02/build_the_environment_for_huginn/">《Huginn及环境搭建》</a> 有讲到过 Huginn 的部署过程，过程比较复杂，要安装的东西也比较多，做迁移的时候要重新部署一遍，也比较容易出错。而 Huginn 有提供 docker 镜像，所以这次我们通过 docker 来搭建 Huginn 环境。</p>
<h2 id="安装-docker"><a href="#安装-docker" class="headerlink" title="安装 docker"></a>安装 docker</h2><p>我用的 vps 是 Debian，按照官方文档安装 docker，具体流程见这里：<a href="https://docs.docker.com/install/linux/docker-ce/debian/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/docker-ce/debian/</a>。</p>
<blockquote>
<p>安装过程不再赘述</p>
</blockquote>
<h2 id="拉取-huginn-镜像"><a href="#拉取-huginn-镜像" class="headerlink" title="拉取 huginn 镜像"></a>拉取 huginn 镜像</h2><p>首先登录到 vps。</p>
<p>执行 <code>docker search huginn</code> 来搜索所有公开的 huginn 镜像：</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/48963645-f99fc180-efd1-11e8-8806-357110a96ea8.png" width="800px"><br></div>

<p>上面高亮的就是我们要使用的镜像，拉取下来（默认拉取 lastest ）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull huginn/huginn</span><br></pre></td></tr></table></figure>
<h2 id="运行-huginn"><a href="#运行-huginn" class="headerlink" title="运行 huginn"></a>运行 huginn</h2><p>拉取完 huginn 之后，我们其余的环境配置（比如 mysql 安装等等）都不需要再配置了，镜像里面都有了，所以我们要做的就是直接运行 huginn：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --name huginn -p 3000:3000 huginn/huginn</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-itd</code>：包括如下 3 个命令：<ul>
<li><code>-t</code>：在新容器内指定一个伪终端或终端。</li>
<li><code>-i</code>：允许你对容器内的标准输入 (STDIN) 进行交互。</li>
<li><code>-d</code>：以新的进程在后台运行</li>
</ul>
</li>
<li><code>--name</code>：给这个容器取个别名叫 <code>huginn</code></li>
<li><code>-p</code>：容器内部的 3000 端口映射到我们 vps 主机的 3000 端口上</li>
</ul>
<p>执行 <code>docker ps</code> 来查看 huginn 是否有真正运行：</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/48963720-a3cc1900-efd3-11e8-97f7-8c473a4298c3.png" width="800px"><br></div>

<p>浏览器访问 <code>&lt;vps:ip&gt;:3000</code>，应该就能看到 huginn 页面了。但是这个时候因为数据还没有迁移，当前的 huginn 数据库是空的。</p>
<h2 id="数据备份"><a href="#数据备份" class="headerlink" title="数据备份"></a>数据备份</h2><p>关于 huginn 的备份，<a href="https://github.com/huginn/huginn/wiki/Backing-up-huginn" target="_blank" rel="noopener">官方 wiki 里面给出的方案</a> 是通过 <code>backup gem</code> 来进行备份，huginn 作者 给出了 <a href="https://github.com/huginn/huginn/blob/master/doc/deployment/backup/example_backup.rb" target="_blank" rel="noopener">备份的脚本</a>，具体 <code>backup</code> 的文档参考见：<a href="http://backup.github.io/backup/v4/" target="_blank" rel="noopener">http://backup.github.io/backup/v4/</a>。但是我这次做数据迁移的话，是直接通过 <code>mysqldump</code> 来导出数据库。</p>
<p>登录到 <code>旧的 vps</code>，然后执行如下命令来备份 mysql 数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump --single-transaction --opt -u huginn -ppassword huginn_production &gt; huginn_backupfile.sql</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：以上命令的参数需要替换：</p>
<ul>
<li>huginn：mysql 用户名</li>
<li>password：mysql 密码</li>
<li>huginn_production：数据库名</li>
</ul>
</blockquote>
<p>执行完成之后，就会生成一个名为 <code>huginn_backupfile.sql</code> 文件，里面就是你 huginn 的所有数据了，包括 <code>用户信息</code>，<code>scenarios</code>，<code>agent</code>，<code>events</code>，<code>user_credentials</code>，<code>Services</code> 等等。</p>
<h2 id="恢复数据"><a href="#恢复数据" class="headerlink" title="恢复数据"></a>恢复数据</h2><p>备份完之后，就要恢复数据，要恢复数据，得先把数据拷贝到 huginn 容器里面。</p>
<p>首先通过一下命令把文件从 <code>旧的 vps</code> 拷贝到 <code>新的 vps</code> <strong>主机</strong>上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp huginn_backupfile.sql root@&lt;新 vps ip&gt;:/home/wangjie/huginn_backupfile.sql</span><br></pre></td></tr></table></figure>
<p>注意，这个时候，文件是在你的 <code>新的 vps</code> 的<strong>主机</strong>上，你还需要把它拷贝到刚刚我们新建的 huginn 容器中，执行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp /home/wangjie/huginn_backupfile.sql huginn: /app/wjhuginn/huginn_backupfile.sql</span><br></pre></td></tr></table></figure>
<p>在 <code>新的 vps</code> 中对新部署的 <code>huginn</code> 进行 restore 数据，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -ppassword huginn_production &lt; huginn_backupfile.sql</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：默认情况下，huginn 镜像中的：</p>
<ul>
<li>数据库名：huginn_production</li>
<li>用户：root</li>
<li>密码：password</li>
</ul>
</blockquote>
<p>除了以上数据，我们还需要 restore 的是 huginn 中的 <code>.env</code> 文件，里面包含了我们的一些配置信息（比如，email，第三方 service key 等等），用同样的方法把 <code>旧的 vps</code> 中的 <code>.env</code> 拷贝到 <code>新的 vps</code>，然后覆盖掉即可。</p>
<h2 id="其它配置"><a href="#其它配置" class="headerlink" title="其它配置"></a>其它配置</h2><h3 id="修改-DNS-Host-Record"><a href="#修改-DNS-Host-Record" class="headerlink" title="修改 DNS Host Record"></a>修改 DNS Host Record</h3><p>把你的 ip 地址改成新的 vps 的 ip。</p>
<h3 id="配置-nginx-反向代理："><a href="#配置-nginx-反向代理：" class="headerlink" title="配置 nginx 反向代理："></a>配置 nginx 反向代理：</h3><p>如下配置，详情可参考 <a href="https://github.com/huginn/huginn/wiki/Nginx-reverse-proxy-configuration" target="_blank" rel="noopener">这里</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    # Make it available from the Internet</span><br><span class="line">    allow all;</span><br><span class="line"></span><br><span class="line">    listen 80;</span><br><span class="line"></span><br><span class="line">    # server names for this server.</span><br><span class="line">    # any requests that come in that match any these names will use the proxy.</span><br><span class="line">    server_name huginn.server.com;</span><br><span class="line">    access_log /var/log/nginx/huginn.server.com-access.log;</span><br><span class="line">    error_log /var/log/nginx/huginn.server.com-error.log;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:3000;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    listen 443 ssl;</span><br><span class="line"></span><br><span class="line">    # Setup SSL certificate with Let&apos;s Encript (https://letsencrypt.org/)</span><br><span class="line">    ssl_certificate /etc/letsencrypt/live/huginn.server.com/fullchain.pem;</span><br><span class="line">    ssl_certificate_key /etc/letsencrypt/live/huginn.server.com/privkey.pem;</span><br><span class="line">    include /etc/letsencrypt/options-ssl-nginx.conf;</span><br><span class="line">    ssl_trusted_certificate /etc/letsencrypt/live/huginn.server.com/chain.pem;</span><br><span class="line">    ssl_stapling on;</span><br><span class="line">    ssl_stapling_verify on;</span><br><span class="line"></span><br><span class="line">    if ($scheme != &quot;https&quot;) &#123;</span><br><span class="line">        return 301 https://$host$request_uri;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> automate </category>
            
            <category> docker </category>
            
        </categories>
        
        
        <tags>
            
            <tag> automate </tag>
            
            <tag> huginn </tag>
            
            <tag> mysql </tag>
            
            <tag> docker </tag>
            
            <tag> docker hub </tag>
            
            <tag> migration </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Huginn实现自动通过Telegram推送豆瓣高分电影]]></title>
      <url>/2018/11/16/douban_high_movie_huginn_telegram/</url>
      <content type="html"><![CDATA[<h1 id="Huginn实现自动通过telegram推送豆瓣高分电影"><a href="#Huginn实现自动通过telegram推送豆瓣高分电影" class="headerlink" title="Huginn实现自动通过telegram推送豆瓣高分电影"></a>Huginn实现自动通过telegram推送豆瓣高分电影</h1><p>之前博客<a href="https://blog.wangjiegulu.com/2018/04/03/huginn_douban_high_score_movies_and_slack/">《Huginn实现自动通过slack推送豆瓣高分电影》</a>有讲到过通过 Huginn 来实现自动获取豆瓣正在上映中的高分（设定分数超过7.8分）电影，并且自动通过 Slack 通知给我。那么怎样通过 Telegram 来进行推送呢？</p>
<h2 id="创建-Telegram-Bot"><a href="#创建-Telegram-Bot" class="headerlink" title="创建 Telegram Bot"></a>创建 Telegram Bot</h2><p>其实跟 Slack 一样，首先需要创建一个 telegram bot，然后通过 telegram bot 来进行通知。</p>
<p>具体我们可以参考 telegram 的官方文档：<a href="https://core.telegram.org/bots#6-botfather" target="_blank" rel="noopener">https://core.telegram.org/bots#6-botfather</a></p>
<p>这里创建 Bot 的方式跟 Slack 有所不同，需要通过跟 <code>BotFather</code> 进行对话来创建，打开 telegram 客户端，搜索 <code>BotFather</code>进入对话框：</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/48595853-74912880-e991-11e8-915c-7b2fbd82ccf0.png" width="400px"><br></div>

<p>给 <code>BotFather</code> 发送一个创建 Bot 的命令 <code>/newbot</code>：</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/48595984-f08b7080-e991-11e8-8989-5a65de625a0c.png" width="700px"><br></div>

<p>如上图所示，通过发送 <code>/newbot</code> 命令（消息）后，<code>BotFather</code> 会回复让你进行设置 <code>bot</code> 的 <code>name</code> 和 <code>user_name</code>，其中 <code>username</code> 必须要是 <code>bot</code> 结尾，我这里 <code>name</code> 和 <code>username</code> 都设置为 <code>angelia_bot</code>。</p>
<p>最后 <code>BotFather</code> 会回复创建成功，并且返回你创建的机器人的 <code>access token</code>，有了<code>access token</code>我们就能给 group 或者 channel 发送消息了。</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/48596207-fa61a380-e992-11e8-9cd5-0320c69303ea.png" width="700px"><br></div>

<h2 id="创建接收消息的频道Channel"><a href="#创建接收消息的频道Channel" class="headerlink" title="创建接收消息的频道Channel"></a>创建接收消息的频道Channel</h2><p>接下来我们需要创建一个用来接收消息的 <code>Channel</code>（当然，你用 <code>Group</code> 也可以，如果用 <code>Group</code> 的话，很多人加进来聊天发消息会比较乱，<code>Channel</code>的话，别人订阅之后就只能接受查看消息，比较符合我们现在的场景）。</p>
<p>创建完之后，通过访问 &lt;<a href="https://api.telegram.org/bot" target="_blank" rel="noopener">https://api.telegram.org/bot</a><bot-access-token\>/getUpdates&gt;，找到刚刚创建的 <code>channel</code>，拿到这个 <code>channel</code> 的id（应该是负数的id）。</bot-access-token\></p>
<blockquote>
<p>把上面的 url 中的 <code>&lt;bot-access-token&gt;</code> 替换成刚刚创建 <code>bot</code> 拿到的 <code>access token</code></p>
</blockquote>
<p>把刚刚我们创建的 <code>bot</code> 添加到我们创建的 <code>channel</code> 中：</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/48596921-0733c680-e996-11e8-9190-2533727bf27d.png" width="400px"><br></div>


<h2 id="创建发送-telegram-消息的-agent"><a href="#创建发送-telegram-消息的-agent" class="headerlink" title="创建发送 telegram 消息的 agent"></a>创建发送 telegram 消息的 agent</h2><p>之前的流程跟<a href="https://blog.wangjiegulu.com/2018/04/03/huginn_douban_high_score_movies_and_slack/">《Huginn实现自动通过slack推送豆瓣高分电影》</a>中的一样，只是最后需要创建一个发送到 telegram 的 agent。</p>
<p>如下：创建一个 <code>PostAgent</code>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"post_url"</span>: <span class="string">"&#123;% credential telegram_base_url %&#125;bot&#123;% credential telegram_bot_token %&#125;/sendPhoto"</span>,</span><br><span class="line">  <span class="attr">"expected_receive_period_in_days"</span>: <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"content_type"</span>: <span class="string">"json"</span>,</span><br><span class="line">  <span class="attr">"method"</span>: <span class="string">"post"</span>,</span><br><span class="line">  <span class="attr">"payload"</span>: &#123;</span><br><span class="line">    <span class="attr">"chat_id"</span>: <span class="string">"&#123;% credential telegram_movie_channel_id %&#125;"</span>,</span><br><span class="line">    <span class="attr">"photo"</span>: <span class="string">"&#123;&#123;image_url&#125;&#125;"</span>,</span><br><span class="line">    <span class="attr">"parse_mode"</span>: <span class="string">"Markdown"</span>,</span><br><span class="line">    <span class="attr">"caption"</span>: <span class="string">"*Title*: [&lt;&lt;&#123;&#123;title&#125;&#125;&gt;&gt;](&#123;&#123;detail_url&#125;&#125;) \n*Score*: &#123;&#123;score&#125;&#125;\n*Star*: &#123;&#123;star&#125;&#125;\n*Release*: &#123;&#123;release&#125;&#125;\n*Region*: &#123;&#123;region&#125;&#125;\n*Actors*: &#123;&#123;actors&#125;&#125;\n*Director*: &#123;&#123;director&#125;&#125;"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"emit_events"</span>: <span class="string">"false"</span>,</span><br><span class="line">  <span class="attr">"no_merge"</span>: <span class="string">"false"</span>,</span><br><span class="line">  <span class="attr">"output_mode"</span>: <span class="string">"clean"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每当检测到豆瓣上有新的上映中的电影超过7.8分，刚刚创建的 Channel 中即可查看到 <code>Bot</code> 的通知：</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/48597282-0308a880-e998-11e8-8df0-7f8ac6857608.png" width="600px"><br></div>

<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>如果你懒得上面的各种配置，ok，加入下面这个 channel，你就能收到通知啦：</p>
<blockquote>
<p><a href="https://t.me/angelia_movies" target="_blank" rel="noopener">https://t.me/angelia_movies</a></p>
</blockquote>
]]></content>
      
        <categories>
            
            <category> huginn </category>
            
            <category> automate </category>
            
            <category> telegram </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ifttt </tag>
            
            <tag> automate </tag>
            
            <tag> huginn </tag>
            
            <tag> integromat </tag>
            
            <tag> zapier </tag>
            
            <tag> geek </tag>
            
            <tag> douban </tag>
            
            <tag> movies </tag>
            
            <tag> telegram </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[构建自己的 Smart Life 私有云（二）-> 连通 IFTTT & Slack]]></title>
      <url>/2018/09/26/private-smart-life-cloud-b--working-with-ifttt-slack/</url>
      <content type="html"><![CDATA[<h1 id="构建自己的-Smart-Life-私有云（二）-gt-连通-IFTTT-amp-Slack"><a href="#构建自己的-Smart-Life-私有云（二）-gt-连通-IFTTT-amp-Slack" class="headerlink" title="构建自己的 Smart Life 私有云（二）-&gt; 连通 IFTTT &amp; Slack"></a>构建自己的 Smart Life 私有云（二）-&gt; 连通 IFTTT &amp; Slack</h1><p><a href="https://blog.wangjiegulu.com/2018/09/26/private-smart-life-cloud-a--hack-tuya-smart-plug/">上一篇</a>我们破解了涂鸦的插座，搭建了自己的 web 服务，暴露了一个接口来控制插座的开关。这篇我们配合 IFTTT、Slack 来控制插座：</p>
<ol>
<li>说 “OK Google” 唤醒 Google Assistant，然后说 “帮我打开卧室的电源”，最后插座被打开。</li>
<li>创建 Slack 机器人 <code>Angelia</code>，对它发消息“帮我打开卧室的电源”，然后插座打开， <code>Angelia</code> 回复说 “好的，已经打开”。</li>
<li>通过 Slack 机器人 <code>Angelia</code>，发送 Slash Commands，打开关闭插座。</li>
</ol>
<h2 id="创建自己私人的-Slack-Workspace"><a href="#创建自己私人的-Slack-Workspace" class="headerlink" title="创建自己私人的 Slack Workspace"></a>创建自己私人的 Slack Workspace</h2><p>打开 Slack，根据提示创建自己的 Slack Workspace: <a href="https://slack.com/create" target="_blank" rel="noopener">https://slack.com/create</a></p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46124165-111e3080-c255-11e8-88ba-7be984c00cf3.png" width="500px"><br></div>

<p>比如我的 Workspace 为 <a href="https://wangjie.slack.com" target="_blank" rel="noopener">https://wangjie.slack.com</a>。</p>
<h2 id="创建-Slack-App"><a href="#创建-Slack-App" class="headerlink" title="创建 Slack App"></a>创建 Slack App</h2><p>创建完毕登录之后，默认应该有 <code>#general</code>、<code>#random</code> 等 channel，但暂时不用这两个 channel。</p>
<p>接下来，我们来创建一个 App。</p>
<p>打开 <a href="https://api.slack.com/" target="_blank" rel="noopener">https://api.slack.com/</a>，点击 <code>Start Building</code></p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46124413-981fd880-c256-11e8-8cbb-572346f29fd7.png" width="600px"><br></div>

<p>输入 App 名称和你要添加到的 workspace。</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46124447-df0dce00-c256-11e8-959b-64a6fcd1bc84.png" width="600px"><br></div>

<h3 id="设置-Bot-信息"><a href="#设置-Bot-信息" class="headerlink" title="设置 Bot 信息"></a>设置 Bot 信息</h3><p>创建完毕之后，我们需要设置这个 app 的机器人相关信息，打开 <a href="https://api.slack.com/apps" target="_blank" rel="noopener">app 设置页面</a>，选择 <code>Bot Users</code>：</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46124676-1335be80-c258-11e8-89fa-b299badb545a.png" width="700px"><br></div>

<p>设置机器人的名称（Display name 和 Default name）。勾选 <code>Always Show My Bot as Online</code>，点击 <code>Save Changes</code>。</p>
<h3 id="设置-Events-API"><a href="#设置-Events-API" class="headerlink" title="设置 Events API"></a>设置 Events API</h3><p><a href="https://api.slack.com/bot-users#app-mentions-response" target="_blank" rel="noopener">Event API</a> 可以在各种时间发生的时候触发调用，比如 消息发送的时候、channels 改变的时候等等。</p>
<p>我们先回到我们的 web 服务，打开上一章创建的 <code>AngeliaController</code>，新增一个处理 Event 的 api：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(<span class="meta-string">"/say/at"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">say</span><span class="params">(<span class="meta">@RequestBody</span> request: <span class="type">BotEventRequestVo</span>)</span></span>: JSONObject &#123;</span><br><span class="line">    logger.info(<span class="string">"[slack event request]request -&gt; \n<span class="variable">$request</span>"</span>)</span><br><span class="line">    <span class="keyword">return</span> JsonResult.success(</span><br><span class="line">                    <span class="string">"token"</span> to request.token,</span><br><span class="line">                    <span class="string">"challenge"</span> to request.challenge,</span><br><span class="line">                    <span class="string">"message"</span> to message</span><br><span class="line">            )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">BotEventRequestVo</span></span>(</span><br><span class="line">        <span class="keyword">val</span> challenge: String?,</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> token: String?,</span><br><span class="line">        <span class="keyword">val</span> team_id: String?,</span><br><span class="line">        <span class="keyword">val</span> api_app_id: String?,</span><br><span class="line">        <span class="keyword">val</span> event: BotEventVo?,</span><br><span class="line">        <span class="keyword">val</span> type: String?,</span><br><span class="line">        <span class="keyword">val</span> event_id: String?,</span><br><span class="line">        <span class="keyword">val</span> event_time: String?,</span><br><span class="line">        <span class="keyword">val</span> authed_users: List&lt;String&gt;?</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">BotEventVo</span></span>(</span><br><span class="line">        <span class="keyword">val</span> type: String?,</span><br><span class="line">        <span class="keyword">val</span> user: String?,</span><br><span class="line">        <span class="keyword">val</span> text: String?,</span><br><span class="line">        <span class="keyword">val</span> client_msg_id: String?,</span><br><span class="line">        <span class="keyword">val</span> ts: String?,</span><br><span class="line">        <span class="keyword">val</span> channel: String?,</span><br><span class="line">        <span class="keyword">val</span> event_ts: String?,</span><br><span class="line">        <span class="keyword">val</span> channel_type: String?</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>构建，部署到服务器。</p>
<p>打开 Slack App 设置页面的 <code>Event Subscriptions</code>：</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46125203-abcd3e00-c25a-11e8-805f-d9f17bd235bc.png" width="700px"><br></div>

<p>在 <code>Request URL</code> 中填写刚刚在我们 web 服务上创建的接口 <code>http://[server ip]:xxx/angelia/say/at</code>，并且点击验证。</p>
<blockquote>
<p>注意：这里认证的依据是，你的接口 Response 需要返回请求中的 <code>challenge</code> 数据就算认证成功。</p>
</blockquote>
<p>然后在 <code>Subscribe to Bot Events</code> 中添加订阅的事件，需要增加的是 <a href="https://api.slack.com/events/message.im" target="_blank" rel="noopener">message.im</a></p>
<blockquote>
<p><code>message.im</code>表示当你跟 bot 的私聊中产生消息的时候（有可能是你发送消息给 Bot，也有可能是 Bot 发消息给你），事件就会触发。</p>
</blockquote>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46125314-21d1a500-c25b-11e8-83d1-89fbd8a596d1.png" width="600px"><br></div>

<p>点击保存。</p>
<p>这时，当你在 Slack 中发送消息给机器人的时候，你的 web 服务端就能收到请求了。</p>
<h3 id="处理事件"><a href="#处理事件" class="headerlink" title="处理事件"></a>处理事件</h3><p>你的 web 服务器收到请求之后，需要对此进行处理，所以你需要去解析发的消息中的信息，然后打开/关闭对应设备（插座）的开关。完善之前的 <code>say</code> 接口：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">lateinit</span> <span class="keyword">var</span> tuyaClientService: TuyaClientService</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">lateinit</span> <span class="keyword">var</span> angeliaSlackProperties: AngeliaSlackProperties</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Angelia 机器人 对话入口</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PostMapping(<span class="meta-string">"/say/at"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">say</span><span class="params">(<span class="meta">@RequestBody</span> request: <span class="type">BotEventRequestVo</span>)</span></span>: JSONObject &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">val</span> text = request.event?.text</span><br><span class="line">       <span class="keyword">val</span> eventType = request.event?.type</span><br><span class="line">       <span class="keyword">if</span> (eventType == <span class="string">"message"</span> <span class="comment">// 直接对话</span></span><br><span class="line">            ||</span><br><span class="line">            request.event.user != angeliaSlackProperties.angelia_id <span class="comment">// angelia自己发的忽略掉</span></span><br><span class="line">       ) &#123;</span><br><span class="line">          <span class="keyword">val</span> message = angeliaBotService.parseTuyaClient(text)</span><br><span class="line">                          ?: <span class="string">"Sorry, I can not understand."</span></span><br><span class="line"></span><br><span class="line">          angeliaSlackService.postMessage(JSONObject().apply &#123;</span><br><span class="line">              <span class="keyword">this</span>[<span class="string">"text"</span>] = <span class="string">"<span class="variable">$message</span>"</span></span><br><span class="line">              <span class="keyword">this</span>[<span class="string">"channel"</span>] = request.event.channel</span><br><span class="line">              <span class="keyword">this</span>[<span class="string">"as_user"</span>] = <span class="literal">true</span></span><br><span class="line">          &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> JsonResult.success(</span><br><span class="line">               <span class="string">"token"</span> to request.token,</span><br><span class="line">               <span class="string">"challenge"</span> to request.challenge,</span><br><span class="line">               <span class="string">"message"</span> to <span class="string">"Request eventId(<span class="subst">$&#123;request.event_id&#125;</span>) done."</span></span><br><span class="line">       )</span><br><span class="line">   &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">       angeliaSlackService.postMessage(JSONObject().apply &#123;</span><br><span class="line">           <span class="keyword">this</span>[<span class="string">"text"</span>] = <span class="string">"Sorry! Something is wrong: <span class="subst">$&#123;e.message&#125;</span>"</span></span><br><span class="line">           <span class="keyword">this</span>[<span class="string">"channel"</span>] = request.event?.channel</span><br><span class="line">           <span class="keyword">this</span>[<span class="string">"as_user"</span>] = <span class="literal">true</span></span><br><span class="line">       &#125;)</span><br><span class="line">       <span class="keyword">return</span> JsonResult.error(e.message)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码的逻辑很简单：</p>
<ul>
<li>首先，eventType是直接对话的（与机器人 bot 私聊），并且是我发给机器人的（机器人发给我的消息不用处理）才会去处理</li>
<li>然后通过 <code>angeliaBotService.parseTuyaClient()</code> 方法进行文本解析和处理</li>
<li>如果解析不出来，则返回 null，message 就是 “Sorry, I can not understand.”</li>
<li>最后返回 Response（带上 message），这里的 message 就是 Bot 发送给我的数据。</li>
</ul>
<p>这里需要做一些 Slack 的配置 slack.properties：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># token for bot</span><br><span class="line">angelia.slack.bot_token=Bearer xoxb-2923xxxxxxxxxxxxxxxxxxxx</span><br><span class="line"></span><br><span class="line"># slack api</span><br><span class="line">angelia.slack.api_base_url=https://slack.com/api</span><br><span class="line">angelia.slack.api_chat_post_message=/chat.postMessage</span><br><span class="line"></span><br><span class="line">angelia.slack.angelia_id=UCWxxxxxx</span><br></pre></td></tr></table></figure>
<p><code>angelia.slack.bot_token</code>：是 Bot 发送消息到 Slack 的token，这个 token 可以在 app 设置页面的 <code>OAuth &amp; Permissions</code> 中拿到</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46125989-09af5500-c25e-11e8-864b-18e3b6145aca.png" width="600px"><br></div>

<blockquote>
<p>注意：是下面的那个 <code>Bot User OAuth Access Token</code>，并且添加到配置文件的时候需要加上 <code>Bearer</code>（注意后面有个空格）</p>
</blockquote>
<p><code>angelia.slack.api_base_url</code> 和 <code>angelia.slack.api_chat_post_message</code> 是发送消息的 url，不用改动。</p>
<p><code>angelia.slack.angelia_id</code> 表示机器人的id，可以通过在 slack 左侧选中机器人右键复制链接，path 最后部分就是 id</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46126106-8d694180-c25e-11e8-84ae-ed01feda481d.png" width="250px"><br></div>

<p>最后，你就能在 slack 中打开与机器人聊天框，发送“关闭插座a”来控制插座：</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46126279-3748ce00-c25f-11e8-997d-b47d8a1ea6ce.jpg" width="300px"><br></div>

<h2 id="集成-Google-Assistant-和-IFTTT"><a href="#集成-Google-Assistant-和-IFTTT" class="headerlink" title="集成 Google Assistant 和 IFTTT"></a>集成 Google Assistant 和 IFTTT</h2><blockquote>
<p>首先确保你的手机装有 Google Assistant（Google Home 先不讨论。。。是的，我没买- -）。</p>
</blockquote>
<p>首先我们需要在 web 服务器端再创建如下一个接口：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 插座控制接口</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PostMapping(<span class="meta-string">"/control/plug"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">controlPlug</span><span class="params">(<span class="meta">@RequestBody</span> request: <span class="type">PlugRequestVo</span>)</span></span>: JSONObject &#123;</span><br><span class="line">   <span class="keyword">val</span> dev = tuyaClientProperties.findDev(request.alias)</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="literal">null</span> == dev) &#123;</span><br><span class="line">           JsonResult.error(<span class="string">"Device named <span class="subst">$&#123;request.alias&#125;</span> is not found"</span>)</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           tuyaClientService.controlPlug(dev.devId, request.turnOn)</span><br><span class="line">           JsonResult.success()</span><br><span class="line">       &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">       JsonResult.error(e.message)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">PlugRequestVo</span></span>(</span><br><span class="line">     <span class="keyword">val</span> alias: String,</span><br><span class="line">     <span class="keyword">val</span> turnOn: <span class="built_in">Boolean</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>构建部署到服务器。</p>
<p>然后打开IFTTT、注册（如果还没有账户）登录，创建 Applet</p>
<p><strong>This</strong>：选择 Google Assistant：</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46126650-abd03c80-c260-11e8-8cf1-c9446bfa4f83.jpg" width="300px"><br></div>

<p><strong>That</strong>：选择 Webhook：</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46126688-d8845400-c260-11e8-894c-b5d3e0df143b.jpg" width="300px"><br></div>

<blockquote>
<p>注意：POST 请求，在 body 中填写如上 json 数据。<br>关闭的 Applet 也是类似，把 body 中的 turnOn 改成 false 就可以了</p>
</blockquote>
<p>最后，你就可以通过 “OK, Google” 唤醒 Google Assistant，然后说”Turn on plug a”来打开插座了。</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46126863-5c3e4080-c261-11e8-8e3d-1f199e647201.jpg" width="300px"><br></div>

<h3 id="吐槽下涂鸦的-Google-Assistant"><a href="#吐槽下涂鸦的-Google-Assistant" class="headerlink" title="吐槽下涂鸦的 Google Assistant"></a>吐槽下涂鸦的 Google Assistant</h3><p>本来想直接使用 Google Assistant 的 Smart Life 的，但是一直没成功，很多人也在反映这个事情，不过貌似没什么效果（看下面这个评分，估计反映一直是被无视的- -）：</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46129424-39178f00-c269-11e8-803f-861c952e37bf.jpg" width="300px"><br></div>

<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46129520-8eec3700-c269-11e8-851f-4998f8d793f6.jpg" width="300px"><br>    <img src="https://user-images.githubusercontent.com/5423194/46129603-c824a700-c269-11e8-9f2a-267b03bc17aa.jpg" width="300px"><br></div>




<h2 id="使用-Slack-的-Slash-Command-控制"><a href="#使用-Slack-的-Slash-Command-控制" class="headerlink" title="使用 Slack 的 Slash Command 控制"></a>使用 Slack 的 Slash Command 控制</h2><p>在 web 服务中再新增两个接口用于 Slash Command：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 插座控制接口，For Slack command line(slash commands)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PostMapping(<span class="meta-string">"/plug/turnon"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">plugTurnOnForCommand</span><span class="params">(<span class="meta">@RequestBody</span> body: <span class="type">String</span>)</span></span>: JSONObject &#123;</span><br><span class="line">   <span class="keyword">return</span> JsonResult.success(<span class="string">"text"</span> to plugControlForCommand(body, <span class="literal">true</span>))</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* For Slack command line(slash commands)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PostMapping(<span class="meta-string">"/plug/turnoff"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">plugTurnOffForCommand</span><span class="params">(<span class="meta">@RequestBody</span> body: <span class="type">String</span>)</span></span>: JSONObject &#123;</span><br><span class="line">   <span class="keyword">return</span> JsonResult.success(<span class="string">"text"</span> to plugControlForCommand(body, <span class="literal">false</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* For Slack command line(slash commands) control</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">plugControlForCommand</span><span class="params">(body: <span class="type">String</span>, turnOn: <span class="type">Boolean</span>)</span></span>: String &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> body.split(<span class="string">"&amp;"</span>).map &#123;</span><br><span class="line">           <span class="keyword">val</span> pair = it.split(<span class="string">"="</span>)</span><br><span class="line">           Pair(pair[<span class="number">0</span>], URLDecoder.decode(pair[<span class="number">1</span>], <span class="string">"UTF-8"</span>))</span><br><span class="line">       &#125;.firstOrNull &#123;</span><br><span class="line">           it.first == <span class="string">"text"</span></span><br><span class="line">       &#125;?.let &#123;</span><br><span class="line">           <span class="keyword">val</span> dev = tuyaClientProperties.findContainsDev(it.second)</span><br><span class="line">           <span class="keyword">if</span> (<span class="literal">null</span> == dev) &#123;</span><br><span class="line">               <span class="string">"Sorry for failed command, Device named <span class="subst">$&#123;it.second&#125;</span> is not found."</span></span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               tuyaClientService.controlPlug(dev.devId, turnOn)</span><br><span class="line">               <span class="string">"<span class="subst">$&#123;if (turnOn) "Turn On" else "Turn Off"&#125;</span> Done(<span class="subst">$&#123;it.second&#125;</span>)."</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125; ?: <span class="string">"Sorry for failed command, Device name required."</span></span><br><span class="line">   &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">"Sorry for failed command, <span class="subst">$&#123;e.message&#125;</span>."</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打开 App 设置页面的 <code>Slash Commands</code>，</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46126962-a7f0ea00-c261-11e8-808a-6ccc8a63c049.png" width="600px"><br></div>

<p>点击 <code>Create New Command</code>，</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46127140-5dbc3880-c262-11e8-97fe-75fcb05fc7df.png" width="500px"><br></div>

<p>然后在聊天的输入框中就可以通过”/“显示 command 提示，选择命令，后面跟上你要执行该命令的设备别名就行了。</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46127236-a70c8800-c262-11e8-83a2-cdcfd8ebe10c.png" width="500px"><br></div>

<h2 id="其它场景"><a href="#其它场景" class="headerlink" title="其它场景"></a>其它场景</h2><p>还有其它很多场景可以实现。比如：</p>
<ul>
<li>结合 IFTTT，当离开家门100m远的时候，自动触发 webhook，让你的私有云帮你把电源、智能们关闭。</li>
<li>实时检测你的位置和家门，如果你不在家，自动调用 Google Calendar 确定你的日程安排，如果又没有外出的安排，则通过 Slack 发送 Interactive messages 到你手机上提醒，提供按钮一键锁门。</li>
<li>小细节，晚上手机充电的时候，可以设定手机一旦充满，关闭电源，又如果手机电源掉电过快，低于90%的电量，重新自动开启电源，确保你早上起床的时候手机电量肯定在某个值之上。</li>
<li>等等等等，太多的智能场景可以去实现。</li>
</ul>
<h2 id="章尾"><a href="#章尾" class="headerlink" title="章尾"></a>章尾</h2><p>现在越来越多的厂商制作着各种各样的智能设备，但是又在自己的一亩三分地固步自封。做个插座，提供一个 app 控制下开关、定个时、做个 schedule 就是所谓的智能了，你买了我的设备就必须要用我的软硬件产品。那些需要用户花心思去考虑什么时候我该怎么的设备不是冰冷的，没有生命的么？智能是人类赋予了设备生命，掌握了“思考”的能力，现在的生活如此多元化，再牛的公司也不可能覆盖你的所有生活领域，如果买了这样的智能设备但自此被囚困在这里，我想，这才是我非智能生活的开始吧。</p>
]]></content>
      
        <categories>
            
            <category> Smart Life </category>
            
            <category> IoT </category>
            
        </categories>
        
        
        <tags>
            
            <tag> kotlin </tag>
            
            <tag> java </tag>
            
            <tag> Smart Life </tag>
            
            <tag> Internet of Things </tag>
            
            <tag> IoT </tag>
            
            <tag> tuya </tag>
            
            <tag> plug </tag>
            
            <tag> IFTTT </tag>
            
            <tag> Google Assistant </tag>
            
            <tag> Slack </tag>
            
            <tag> J2EE </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[构建自己的 Smart Life 私有云（一）-> 破解涂鸦智能插座]]></title>
      <url>/2018/09/26/private-smart-life-cloud-a--hack-tuya-smart-plug/</url>
      <content type="html"><![CDATA[<h1 id="构建自己的-Smart-Life-私有云（一）-gt-破解涂鸦智能插座"><a href="#构建自己的-Smart-Life-私有云（一）-gt-破解涂鸦智能插座" class="headerlink" title="构建自己的 Smart Life 私有云（一）-&gt; 破解涂鸦智能插座"></a>构建自己的 Smart Life 私有云（一）-&gt; 破解涂鸦智能插座</h1><p>本系列文章的目标是通过自己搭建的<code>私有云</code>、<code>IFTTT</code>、<code>Slack</code>、<code>Google Assistant</code>、<code>涂鸦智能</code>、<code>图灵机器人</code>等等第三方服务，构建自己的“智能生活”基本的框架。</p>
<p>前段时间我在京东上购买了一个<a href="https://item.jd.com/29882207900.html" target="_blank" rel="noopener">涂鸦智能的插座</a>。涂鸦智能是一个把产品智能化的一个平台，从软件和硬件和云端上面提供给厂商一个一站式人工智能物联网的解决方案（<em>确实不是涂鸦智能的广告- -.</em>）。所以严格来说应该是“鹊起”基于涂鸦解决方案所开发出来的一个产品，基于涂鸦提供的一切规范，所有软硬云端的开发规范都可以在官网无权限限制地查看到（<a href="https://docs.tuya.com/cn/" target="_blank" rel="noopener">https://docs.tuya.com/cn/</a>）</p>
<h2 id="初试插座"><a href="#初试插座" class="headerlink" title="初试插座"></a>初试插座</h2><p>我首先下载了涂鸦的官方app：<a href="https://play.google.com/store/apps/details?id=com.tuya.smartlife&amp;hl=en_US" target="_blank" rel="noopener">Smart Life</a>，注册登录、智能配对插座，通过手机控制插座开关，一切顺利，还支持设置定时开关和 Schedule，而且手机控制到插座的反应十分灵敏（看样子应该使用了长链接）。</p>
<h2 id="破解插座"><a href="#破解插座" class="headerlink" title="破解插座"></a>破解插座</h2><p>当然使用官方 app 显然是无法满足我们需求，所以查看官方文档，发现文档中的 <a href="https://docs.tuya.com/cn/cloudapi/appAPI/tuya.m.device.dp.publish_1.0.html" target="_blank" rel="noopener">tuya.m.device.dp.publish</a> 接口正好可以满足我们的需求。</p>
<p>通过<a href="https://docs.tuya.com/cn/cloudapi/app_access.html" target="_blank" rel="noopener">接入指南</a>，我们可以知道接入方式提供了两种：</p>
<ol>
<li>MQTT，果然有使用长链接（app端默认用的应该就是长链接了）</li>
<li>https，这个目前比较适合我们，暂时不管延迟怎么样，先选择用 https 来验证控制的可行性</li>
</ol>
<p>下面有列出通用的参数：</p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>参数类型</th>
<th>是否必须</th>
<th>是否签名</th>
<th>参数描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>a</td>
<td>String</td>
<td>是</td>
<td>是</td>
<td>API名称</td>
</tr>
<tr>
<td>v</td>
<td>String</td>
<td>是</td>
<td>是</td>
<td>API接口版本</td>
</tr>
<tr>
<td>sid</td>
<td>String</td>
<td>否</td>
<td>是</td>
<td>用户登录授权成功后，ATOP颁发给应用的用户session</td>
</tr>
<tr>
<td>time</td>
<td>String</td>
<td>是</td>
<td>是</td>
<td>时间戳，格式为数字，大小到秒非毫秒，时区为标准时区，例如：1458010495。API服务端允许客户端请求最大时间误差为540分钟。</td>
</tr>
<tr>
<td>sign</td>
<td>String</td>
<td>是</td>
<td>否</td>
<td>API输入参数签名结果，签名算法参照下面的介绍</td>
</tr>
<tr>
<td>clientId</td>
<td>String</td>
<td>是</td>
<td>是</td>
<td>用户的APPID(注各平台不一样如:ios、android、云云对接的id都不一样)</td>
</tr>
<tr>
<td>lang</td>
<td>String</td>
<td>否</td>
<td>是</td>
<td>APP的语言，如”en”，“zh_cn”,错误信息根据语言自动翻译</td>
</tr>
<tr>
<td>ttid</td>
<td>String</td>
<td>否</td>
<td>是</td>
<td>APP渠道或云端渠道,如公司名,用于数据分析跟踪</td>
</tr>
<tr>
<td>os</td>
<td>String</td>
<td>是</td>
<td>是</td>
<td>手机操作系统，如”Android”，“ios”,云端可以写linux或写公司名</td>
</tr>
</tbody>
</table>
<p>上述我们无法拿到的是哪些呢？</p>
<ul>
<li>sid：登录后自然就能拿到了</li>
<li>sign：所有参数都有了，那sign自然能算出来（文档下面有sign算法）</li>
<li>clientId：这玩意就比较麻烦了，相当于一个apiKey</li>
<li>ttid：这个非必须，暂时可以不管</li>
</ul>
<p>所以只要拿到 clientId，我们就能</p>
<ul>
<li>通过 <a href="https://docs.tuya.com/cn/cloudapi/appAPI/userAPI/tuya.m.user.mobile.token.get_1.0.html" target="_blank" rel="noopener">tuya.m.user.email.token.get</a> 接口拿到登录用的 token</li>
<li>通过 <a href="tuya.m.user.mobile.passwd.login">tuya.m.user.mobile.passwd.login</a> 接口登录</li>
<li>然后通过 <a href="https://docs.tuya.com/cn/cloudapi/appAPI/tuya.m.device.dp.publish_1.0.html" target="_blank" rel="noopener">tuya.m.device.dp.publish</a> 接口下发指令</li>
</ul>
<p>那怎么去拿到 clientId 呢？反编译试试（大家应该都知道怎么做），class.dex 有点多，最后拿到了 </p>
<ul>
<li>client_id：<code>8qp5cfk*******3mpmc3</code>（这个打码了）</li>
<li>app_secret：<code>g75ktcvsae8**********e95j738tawg</code>（同样打码）</li>
</ul>
<h3 id="拿到登录-token"><a href="#拿到登录-token" class="headerlink" title="拿到登录 token"></a>拿到登录 token</h3><p>打开 <code>Postman</code>，<a href="https://docs.tuya.com/cn/cloudapi/appAPI/userAPI/tuya.m.user.mobile.token.get_1.0.html" target="_blank" rel="noopener">按照文档</a> POST <code>countryCode</code> 和 <code>mobile</code> 可以得到 token：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"api"</span>:<span class="string">"tuya.m.user.mobile.token.get"</span>,</span><br><span class="line">    <span class="attr">"result"</span>:&#123;</span><br><span class="line">        <span class="attr">"exponent"</span>:<span class="string">"3"</span>,</span><br><span class="line">        <span class="attr">"pExponent"</span>:<span class="string">"..."</span>,</span><br><span class="line">        <span class="attr">"publicKey"</span>:<span class="string">"..."</span>,</span><br><span class="line">        <span class="attr">"token"</span>:<span class="string">"..."</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"status"</span>:<span class="string">"ok"</span>,</span><br><span class="line">    <span class="attr">"success"</span>:<span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="通过-token-进行登录"><a href="#通过-token-进行登录" class="headerlink" title="通过 token 进行登录"></a>通过 token 进行登录</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"countryCode"</span>:<span class="string">"86"</span>,</span><br><span class="line">    <span class="attr">"mobile"</span>:<span class="string">"11745678923"</span>,</span><br><span class="line">    <span class="attr">"passwd"</span>:<span class="string">"根据获取token接口返回的公钥对 md5(明文密码) 进行rsa加密"</span>,</span><br><span class="line">    <span class="attr">"token"</span>:<span class="string">"126bb7570dcae343980b0607e6b35084"</span>,</span><br><span class="line">    <span class="attr">"ifencrypt"</span>:<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据<a href="https://docs.tuya.com/cn/cloudapi/appAPI/userAPI/tuya.m.user.mobile.passwd.login_1.0.html" target="_blank" rel="noopener">登录接口的文档</a>，密码需要使用 gettoken 接口返回的公钥对 md5之后的密码进行 rsa 加密，apk 反编译之后代码可以完全看到，直接拷贝即可</p>
<p>登录完之后，就可以拿到具体的 sid （sessionId）了，有了 sessionId，就可以去对插座进行下发指令。</p>
<h3 id="插座下发指令"><a href="#插座下发指令" class="headerlink" title="插座下发指令"></a>插座下发指令</h3><p>同样<a href="https://docs.tuya.com/cn/cloudapi/appAPI/tuya.m.device.dp.publish_1.0.html" target="_blank" rel="noopener">根据下发指令接口文档</a>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"devId"</span>: <span class="string">"002yt001sf000000sfV3"</span>,</span><br><span class="line">    <span class="attr">"dps"</span>: &#123;</span><br><span class="line">       <span class="attr">"1"</span>:<span class="number">1</span>,</span><br><span class="line">       <span class="attr">"2"</span>:<span class="number">5</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，POST 的数据除了 sid，还需要 devId 和 dps</p>
<p>dps 可以参考这里的文档：<a href="https://fchelp.cloud.alipay.com/queryArticleContent.htm?tntInstId=WRNQWLCN&amp;articleId=89429815&amp;helpCode=SCE_00000019" target="_blank" rel="noopener">https://fchelp.cloud.alipay.com/queryArticleContent.htm?tntInstId=WRNQWLCN&amp;articleId=89429815&amp;helpCode=SCE_00000019</a></p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/46066359-0dcc6b80-c1a7-11e8-8d29-5391b7f7f87a.png"><br></div>

<p>我们要控制插座开关的话，那就使用 <code>{&quot;1&quot;: true}</code> / <code>{&quot;1&quot;: false}</code> 即可</p>
<p>那 devId 呢？它代表我添加设备 id，那我怎么知道我刚给在 Smart Life 上添加的插座 id 呢？抓包试试（大家应该都知道），通过抓包，我们可以很容易拿到所有你绑定的 devId。</p>
<p>至此，我们可以通过 http 来控制插座的开关了。</p>
<h2 id="搭建自己的私有云项目"><a href="#搭建自己的私有云项目" class="headerlink" title="搭建自己的私有云项目"></a>搭建自己的私有云项目</h2><blockquote>
<p>我为自己的项目取名为 <code>Angelia</code>，安革利亚，古希腊神话人物之一，为“消息女神”。</p>
</blockquote>
<p>搭建 web 项目，新建 <code>AngeliaController</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="meta-string">"/angelia"</span>)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AngeliaController</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>增加 Tuya 的配置文件：tuyaclient.properties</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">tuya.client.client_id=xxxxxx</span><br><span class="line">tuya.client.app_secret=xxxxxx</span><br><span class="line">tuya.client.ttid=xxxxxx</span><br><span class="line">tuya.client.v=1.0</span><br><span class="line">tuya.client.base_url=https://a1.tuyacn.com/api.json</span><br><span class="line"></span><br><span class="line"># smart life app 登录手机号</span><br><span class="line">tuya.client.user_mobile=18511111111</span><br><span class="line">tuya.client.user_country_code=86</span><br><span class="line">tuya.client.user_rsa_encrypted_passwd=xxx</span><br><span class="line"></span><br><span class="line"># 设备信息</span><br><span class="line">tuya.client.lang=en</span><br><span class="line">tuya.client.os=Android</span><br><span class="line">tuya.client.os_system=9</span><br><span class="line">tuya.client.time_zone_id=Asia/Shanghai</span><br><span class="line">tuya.client.platform=Pixel</span><br><span class="line">tuya.client.sdk_version=2.6.4</span><br><span class="line">tuya.client.app_version=3.4.3</span><br><span class="line">tuya.client.app_rn_version=5.6</span><br><span class="line"># 设备 id，模拟手机的 deviceId</span><br><span class="line">tuya.client.device_id=e507510a0288accd7******</span><br><span class="line">tuya.client.imei=xxxxxx</span><br><span class="line">tuya.client.imsi=xxxxxx</span><br><span class="line"></span><br><span class="line"># 智能设备，可以多个：别名|id|dpid,别名|id|dpid,别名|id|dpid</span><br><span class="line"># dpid: 1. 开关；4.rgb；5. 档位；6. 温度；15. 红外数据</span><br><span class="line">tuya.client.dev_ids=[\</span><br><span class="line">  &#123;\</span><br><span class="line">    &quot;aliasList&quot;: [&quot;plug a&quot;, &quot;plug 1&quot;, &quot;插座a&quot;, &quot;洗手间总电源&quot;],\</span><br><span class="line">    &quot;devId&quot;: &quot;111222333&quot;,\</span><br><span class="line">    &quot;dpId&quot;: &quot;1&quot;\</span><br><span class="line">  &#125;,\</span><br><span class="line">  &#123;\</span><br><span class="line">    &quot;aliasList&quot;: [&quot;plug b&quot;, &quot;plug 2&quot;, &quot;插座b&quot;, &quot;卧室总电源&quot;],\</span><br><span class="line">    &quot;devId&quot;: &quot;12341234&quot;,\</span><br><span class="line">    &quot;dpId&quot;: &quot;1&quot;\</span><br><span class="line">  &#125;,\</span><br><span class="line">  // ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>以上，除了刚刚的那些必要的参数之类，在这个配置文件里面还增加了对所有设备的配置，每个设备对应它的 dpId，devId，还有别名（控制的时候不可能直接说 “devId 为 a1d2f32a1d2f32 的插座关掉”，而是说 “关掉插座1” / “关掉洗手间总电源”等等），每个设备别名可以有多个。</p>
<p>好了，回到 <code>AngeliaController</code>，新增一个接口：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 插座控制接口</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">lateinit</span> <span class="keyword">var</span> tuyaClientService: TuyaClientService</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">lateinit</span> <span class="keyword">var</span> tuyaClientProperties: TuyaClientProperties</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(<span class="meta-string">"/control/plug"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">controlPlug</span><span class="params">(<span class="meta">@RequestBody</span> request: <span class="type">PlugRequestVo</span>)</span></span>: JSONObject &#123;</span><br><span class="line">   <span class="keyword">val</span> dev = tuyaClientProperties.findDev(request.alias)</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="literal">null</span> == dev) &#123;</span><br><span class="line">           JsonResult.error(<span class="string">"Device named <span class="subst">$&#123;request.alias&#125;</span> is not found"</span>)</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           tuyaClientService.controlPlug(dev.devId, request.turnOn)</span><br><span class="line">           JsonResult.success()</span><br><span class="line">       &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">       JsonResult.error(e.message)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">PlugRequestVo</span></span>(</span><br><span class="line">     <span class="keyword">val</span> alias: String,</span><br><span class="line">     <span class="keyword">val</span> turnOn: <span class="built_in">Boolean</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>以上，该接口接收别名（alias）和开闭状态（turnOn）两个入参。首先，通过请求的别名去 properties 查找设备，如果找到，则通过 <code>tuyaClientService</code> 的 <code>controlPlug</code> 方法来下发指令，<code>controlPlug</code> 的实现就是刚刚上面说的 <code>获取登录接口-登录-下发指令</code>几步。</p>
<p>构建、部署，通过 Postman 访问 <code>http://localhost:xxxxx/angelia/control/plug</code>, body 设置为 <code>{&quot;alias&quot;: &quot;卧室总电源&quot;, &quot;turnOn&quot;: true}</code>，插座即可打开。</p>
]]></content>
      
        <categories>
            
            <category> Smart Life </category>
            
            <category> IoT </category>
            
        </categories>
        
        
        <tags>
            
            <tag> kotlin </tag>
            
            <tag> java </tag>
            
            <tag> Smart Life </tag>
            
            <tag> Internet of Things </tag>
            
            <tag> IoT </tag>
            
            <tag> tuya </tag>
            
            <tag> plug </tag>
            
            <tag> IFTTT </tag>
            
            <tag> Google Assistant </tag>
            
            <tag> Slack </tag>
            
            <tag> J2EE </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[理解 CI 和 CD 之间的区别（翻译）]]></title>
      <url>/2018/09/10/understanding-the-difference-between-ci-and-cd/</url>
      <content type="html"><![CDATA[<h1 id="理解-CI-和-CD-之间的区别"><a href="#理解-CI-和-CD-之间的区别" class="headerlink" title="理解 CI 和 CD 之间的区别"></a>理解 CI 和 CD 之间的区别</h1><blockquote>
<p>原文：<a href="https://thenewstack.io/understanding-the-difference-between-ci-and-cd/?utm_source=wanqu.co&amp;utm_campaign=Wanqu+Daily&amp;utm_medium=website" target="_blank" rel="noopener">https://thenewstack.io/understanding-the-difference-between-ci-and-cd/?utm_source=wanqu.co&amp;utm_campaign=Wanqu+Daily&amp;utm_medium=website</a></p>
</blockquote>
<p>有很多关于持续集成（CI）和持续交付（CD）的资料。很多文章用技术术语来进行解释，以及它们怎么帮助你的组织。可惜的是，在一些情况下，这些方法通常与特定工具、甚至供应商相关联。在公司食堂里非常常见的谈话可能是：</p>
<ol>
<li>你在你们团队里面使用持续集成吗？</li>
<li>当然，我们使用 X 工具</li>
</ol>
<p><em>让我来告诉你一些秘密</em>。持续集成和持续交付都是开发方法。它们没有链接到特定的工具或者供应商。尽管有DO（比如<a href="https://codefresh.io/" target="_blank" rel="noopener">Codefresh</a>）这样的工具和解决方法在这两方面帮助你，实际上，一个公司可以只使用 Bash 脚本和 Perl one-liners（不是真的使用，但是有可能的）来练习 CI / CD。</p>
<p>所以，我们不会陷入使用工具和技术术语来解释 CI / DI 的陷阱，我们将用最重要的东西来解释：人！</p>
<h2 id="关于人的故事-—-软件集成的黑暗时代"><a href="#关于人的故事-—-软件集成的黑暗时代" class="headerlink" title="关于人的故事 — 软件集成的黑暗时代"></a>关于人的故事 — 软件集成的黑暗时代</h2><p>Alice, Bob, Charlie, David, 和 Elizabeth，他们都在 <code>SoftwareCo</code> 公司。开发 <code>SuperBigProject</code> 应用。Alice, Bob, 和 Charlie 是开发者。David 是一个测试工程师。Elizabeth 是团队的项目经理。</p>
<p>开发应用的传统方法如下：</p>
<p>Alice, Bob, 和 Charlie 在它们各自的工作区，工作在3个不同的 feature。每个开发人员都以各自的方法编写和测试代码。他们使用一个长周期的 feature 分支，在它们合并进生产之前可能存在几周或者甚至几个月。</p>
<div style="text-align: center;"><br>    <image src="https://cdn.thenewstack.io/media/2018/08/8b059cb3-codefresh1.png" width="600px"><br></image></div>

<p>在某个时间点，Elizabeth（PM）召集整个团队，并宣布：“各位，我们需要构建一个 Release”。</p>
<p>此时，Alice, Bob, 和 Charlie 争先恐后地集成所有3个 feature 分支到同一个分支中。这是一个非常紧张的时刻，因为这些分支之前并没有合并一起进行测试过。由于错误的假设或者环境原因，会出现很多bug和问题（请记住，目前为止，所有 feature 仅仅在各自的工作站中进行过测试，彼此是隔离的）。</p>
<p>一旦这个高度紧张的时期结束了，合并的结果将传递给将执行额外的手动和自动测试的 David，此期间也很耗时, 因为他是可以根据发现的决定性 bug 的数量来批准或阻止发布的人。当他测试时, 所有的目光都落在了大卫身上, 因为他的测试可以暴露出严重的问题, 会导致 Release 的 delay。</p>
<p>最后，测试结束了，Elizabeth 高兴地宣布，该版本已经打包好，并运往客户。</p>
<p>那么，人们面对这个虚构的（又非常现实）的故事是什么感受呢？</p>
<ol>
<li>Alice, Bob, 和 Charlie（开发）都不高兴，因为他们总是在发布即将发生之前了解集成问题。集成期感觉就像交火, 同一时刻出现很多问题。</li>
<li>David（测试）也不高兴，因为他的工作实在不平衡。当他在等待开发在 feature 完成它们的工作的时候是和平时期。然后在测试阶段他陷于测试工作中，需要处理意想不到的测试场景，并且每个人都站在他的肩旁上看他。</li>
<li>Elizabeth（管理人员）也不高兴。集成阶段是项目的关键路径。这是一个紧张的时期, 任何意想不到的问题,都会阻碍推动产品的进一步交付。Elizabeth 一直梦想软件发布没有任何意外情况, 但这在现实中从来不会发生。项目时间线中的集成阶段总变成一个猜谜游戏。</li>
</ol>
<p>团队的每个人都不高兴（顺便一提，如果你的公司仍然在这样开发软件，请尝试了解这种开发工作流对团队的士气造成的损害）。</p>
<p>这里的主要问题是<strong>单一</strong>的“集成”阶段发生在每个产品发布。这是工作流的难点，它阻碍了团队进行无压力发布过程。</p>
<h2 id="在集成中增加“持续”"><a href="#在集成中增加“持续”" class="headerlink" title="在集成中增加“持续”"></a>在集成中增加“持续”</h2><p>现在我们已经知道了什么是“集成”，很容易理解“持续集成”的需要之处。俗话说，“<a href="https://martinfowler.com/bliki/FrequencyReducesDifficulty.html" target="_blank" rel="noopener">如果某事是痛苦的，那就多做它</a>”。持续集成实质上是通过高频率的重复集成步骤减轻它的痛苦。最显而易见的方法就是在每次 feature 合并后进行集成（而不是在宣布正式 release 之前等待）。</p>
<div style="text-align: center;"><br>    <image src="https://cdn.thenewstack.io/media/2018/08/cdc82f2b-codefresh2.png" width="600px"><br></image></div>

<p>当一个团队实践持续集成…</p>
<ol>
<li>所有 feature 分支都直接合并到主分支（主线）中。</li>
<li>开发人员不是孤立工作的。所有 feature 都是从主线开始开发的。</li>
<li>如果主线是健康的，而不是在它单独的工作站上工作，则一项 feature 被视为已完成。</li>
<li>测试在 feature 级别和主线级别都会被触发。</li>
</ol>
<p>这些是持续集成的要点！当然，还有更多的细节（实际上关于这个主题有一本<a href="https://martinfowler.com/books/duvall.html" target="_blank" rel="noopener">完整的书籍</a>）。但是重要的一点是，所有合并和测试并不是在一个单一的有压力的集成时刻，集成一直在连续的时刻发生。</p>
<p>持续集成是开发软件的一种更好的方法（相比于“简单”集成），因为它：</p>
<ol>
<li>减少在合并 feature 时出现的意外次数。</li>
<li>解决“在我的机子上没问题”的问题</li>
<li>将测试周期切片到每个 feature 逐渐合并到主线中的阶段（而不是一次性的）。</li>
</ol>
<p>其结果就是，一个使用 CI 的团队不是生活在过山车上 (在开发时期很平静，伴随着的是有压力的 release)，而是可以在如何接近完成项目的渐进方式中得到更好的可见性。</p>
<p>利用 CI 工作是现代软件开发的支柱之一。这一点上，该技术被非常好的记录和知晓。如果现在你们的软件项目中还没有实践 CI，你的组织没有任何借口不去实践它。</p>
<h2 id="软件交付的黑暗时代"><a href="#软件交付的黑暗时代" class="headerlink" title="软件交付的黑暗时代"></a>软件交付的黑暗时代</h2><p>现在我们知道了 “集成” 的历史，以及持续集成的工作原理，我们可以将它带到一个下一级，持续交付。</p>
<p>如果我们回到原来的故事，我们可以看到类似模式的发布方式正在发生：</p>
<div style="text-align: center;"><br>    <image src="https://cdn.thenewstack.io/media/2018/08/8d8eb43f-codefresh3.png" width="600px"><br></image></div>

<p>执行 Release 发布实质上是一个“大爆炸”事件。在软件被认为已经测试过，有人会负责包装和部署的过程。部署软件到生产也是一个非常有压力的阶段，传统来说会涉及到很多手动的步骤（和 checklists）。部署可能是很少次的（有的公司每六个月才会部署一次）。在极端情况下，部署可能只发生一次（瀑布流设计方法）。</p>
<p>只有到 deadline 时才交付软件，这会出现与不频繁集成一样的挑战：</p>
<ol>
<li>通常发现生产环境与需要在最后一刻进行额外配置的测试环境不同。</li>
<li>在测试环境中工作正常的功能在生产中被发现问题。</li>
<li>在发布时还没有准备就绪的功能，或者根本就不会交付给客户，或者他们进一步推迟发布日期。</li>
<li>发布导致开发人员（想要发布新功能）和运营（想要稳定，不想一次部署太多的新功能）之间的关系变得紧张。</li>
</ol>
<p>你应该能理解这里的模式。如果我们通过更频繁地来缓解“集成”阶段的痛苦，我们也可以为“交付”阶段做同样的事情。</p>
<h2 id="在交付中增加“持续”"><a href="#在交付中增加“持续”" class="headerlink" title="在交付中增加“持续”"></a>在交付中增加“持续”</h2><p>持续交付是尽可能频繁地组装和准备软件（就像它会被发布到生产那样）的实践。最极端的交付方式是在每个 feature 合并之后。</p>
<div style="text-align: center;"><br>    <image src="https://cdn.thenewstack.io/media/2018/08/3219a4ee-codefresh4.png" width="600px"><br></image></div>

<p>因此，CD，让 CI 走得更远一步。在每个 feature 合并到主线中，软件不仅要测试正确性，而且也要包装和部署到测试环境（比较理想地符合生产环境）。所有这一切都是以完全自动化的方式。注意，上图中缺少的草图 (表示手动步骤)。</p>
<p>还要注意，每个 feature 都是推送到生产的潜在<strong>候选者</strong>。不是所有候选人都会被发送到生产。根据组织，部署到生产的决定需要人工干预，人类只决定一个 release 是否应该发送到生产（但不会准备这个 release 本身）。这个 release 在测试环境已经被打包，测试和部署。</p>
<p>持续交付比持续集成更难采用。其原因是因为每个发布候选者都有可能达到生产，因此需要自动化整个生命周期：</p>
<ol>
<li>构建应该是可重复性和确定性的。</li>
<li>所有 release 步骤应该都是自动化的（它比听起来更难）。</li>
<li>所有的配置和关联的文件都应该存在于代码控制中 (而不仅仅是源代码)。</li>
<li>每个 feature / release 都应该在它的测试环境中被测试过（以动态方式创建和销毁的理想方法）。</li>
<li>所有测试套件都应自动化且相对快速（它也是比听起来更难）。</li>
</ol>
<p>虽然云当然可以帮助满足所有这些要求，但在软件团队 (开发人员和运营部门) 中需要一定程度的纪律，以便真正拥抱持续交付。</p>
<p>一旦 CD 落地，发布会变得微不足道，因为它们可以按个按钮就能执行。每个人（不仅仅是项目经理）都具有 release candidate <em>（译者：release 候选版本，以下对此术语不做翻译）</em>的可见性。当前的 release candidate 可能没有所有请求的功能，或者说它可能无法满足所有的要求，但是这对于发布过程来说并不重要。重要的其实是这个 release 是完整测试和打包的，准备就绪发送到生产（如果需要）。任何项目的相关人员可以给出绿灯并立即把 release 部署到生产。</p>
<p>如果你使用 CD，则软件的生命周期可以概括成如下：</p>
<div style="text-align: center;"><br>    <image src="https://cdn.thenewstack.io/media/2018/08/077b76c5-codefresh5.png" width="600px"><br></image></div>

<p>每个 release candidate 都是预先预备好的。一个人决定是否一个 release candidate 版本是否推送到生产。没有推送到生产的 Release Candidate 仍然会作为一个 artifact 储存起来，如果将来有需要可以进行召回。</p>
<p>就像持续集成一样，如果你想知道更多的细节，这里有<a href="https://martinfowler.com/books/continuousDelivery.html" target="_blank" rel="noopener">整本围绕持续交付的书籍</a>。</p>
<h2 id="额外奖励：持续部署"><a href="#额外奖励：持续部署" class="headerlink" title="额外奖励：持续部署"></a>额外奖励：持续部署</h2><p>CD 中的 “D” 也可以表示部署（Deployment）。这种开发方法建立在持续交付上, 基本上完全消除了所有人类干预。任何被发现准备就绪的 release candidate （并且通过所有质量测试）都会<em>立即</em>推送到生产。</p>
<div style="text-align: center;"><br>    <image src="https://cdn.thenewstack.io/media/2018/08/cd81028d-codefresh6.png" width="600px"><br></image></div>

<p>不可否认的是，只有极少数的公司可以这样做。没有人类干预直接推送到生产应该不能掉以轻心。在撰写这篇文章时，许多公司甚至都没有实践持续交付，更别说部署了。现在应该清楚的是，每种开发方法都需要建立在之前那些基础之上。</p>
<div style="text-align: center;"><br>    <image src="https://cdn.thenewstack.io/media/2018/08/9b53d1f0-codefresh7.png" width="600px"><br></image></div>

<p>在向上移动之前（译者：按上图向上移动），你的组织应该确保每个基础都是真正稳固的。在 Codefresh，我们已经看到了很多公司试图进入云时代，在他们没有真正的理解 CI/CD 管道时试图硬塞进现有的做法（为数据中心进行优化），并且其中一些做法现在已经过时。尝试采用持续部署而不完全拥抱持续交付是一场失败的战役。</p>
<p>另一种方法是查看这些方法涵盖的内容以及 CD 需要 CI 的方式,，如下图所示：</p>
<div style="text-align: center;"><br>    <image src="https://cdn.thenewstack.io/media/2018/08/f600b7cb-codefresh8.png" width="600px"><br></image></div>

<p>请确保以正确的顺序处理每个开发模式。针对持续交付是一个更现实的目标，可选的工具也很丰富。</p>
]]></content>
      
        <categories>
            
            <category> ci </category>
            
            <category> cd </category>
            
        </categories>
        
        
        <tags>
            
            <tag> CI </tag>
            
            <tag> Continuous Integration </tag>
            
            <tag> 持续集成 </tag>
            
            <tag> CD </tag>
            
            <tag> Continuous Delivery </tag>
            
            <tag> 持续交付 </tag>
            
            <tag> Continuous Deployment </tag>
            
            <tag> 持续部署 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android POJO 转换器 —> RapidOOO]]></title>
      <url>/2018/04/16/rapidooo-android-pojo-converter/</url>
      <content type="html"><![CDATA[<h1 id="RapidOOO"><a href="#RapidOOO" class="headerlink" title="RapidOOO"></a>RapidOOO</h1><p>Android POJO 转换器:根据 POJO 类编译时自动生成支持扩展互相绑定的领域对象。</p>
<p><a href="https://github.com/wangjiegulu/RapidOOO/blob/master/README_zh.md" target="_blank" rel="noopener">English Version</a></p>
<p><strong>Github:</strong> <a href="https://github.com/wangjiegulu/RapidOOO" target="_blank" rel="noopener">https://github.com/wangjiegulu/RapidOOO</a></p>
<h2 id="为什么使用-RapidOOO？"><a href="#为什么使用-RapidOOO？" class="headerlink" title="为什么使用 RapidOOO？"></a>为什么使用 RapidOOO？</h2><p>我们在领域驱动设计中经常会在不同层级之间传递数据，例如 <code>VO</code>, <code>PO</code>, <code>DO</code>, <code>DTO</code>, <code>BO</code>等。Android 的开发中也经常会遇到这些情况，比如在 <a href="https://github.com/android10/Android-CleanArchitecture" target="_blank" rel="noopener">Android-CleanArchitecture</a> 的 <a href="https://github.com/android10/Android-CleanArchitecture/blob/master/presentation/src/main/java/com/fernandocejas/android10/sample/presentation/mapper/UserModelDataMapper.java#L42" target="_blank" rel="noopener">UserModelDataMapper::transform</a>, <a href="https://github.com/android10/Android-CleanArchitecture/blob/master/data/src/main/java/com/fernandocejas/android10/sample/data/entity/mapper/UserEntityDataMapper.java#L42" target="_blank" rel="noopener">UserEntityDataMapper::transform</a> 等。手工地进行拷贝转换的过程不但繁琐，而且错误的风险比较大，在新增、删除字段时也增加了维护的成本。<a href="http://dozer.sourceforge.net/documentation/about.html" target="_blank" rel="noopener">Dozer</a> 可以很好地解决这个问题，但是在 Android 上可能就不太适用了。</p>
<p><strong>RapidOOO 可以做到:</strong></p>
<ol>
<li>在编译时针对指定的初始 POJO，可以自动生成 Java 类（比如 <code>UserVO</code>, <code>UserBO</code> 等），非反射。</li>
<li>可以在生成的 POJO 类中增加配置，添加新的字段（比如通过 User 中的 <code>gender</code> 在生成的 POJO（UserVO） 中扩展出一个 <code>genderDesc</code> 字段，并且与原来的 <code>gender</code> 类共存并进行双向绑定）</li>
<li>字段进行转换时可以通过指定 <code>conversionMethodName</code>, <code>inverseConversionMethodName</code> 等方法来进行特殊的转换，类似 <code>Databinding</code> 中的 <code>@BindingMethod</code>。</li>
<li>链式的 POJO 生成，如从 <code>User</code> 生成 <code>UserDO</code>, 从 <code>UserDO</code> 生成 <code>UserBO</code>, 从 <code>UserBO</code> 生成 <code>UserVO</code>…</li>
<li>生成类中自动生成转换方法 <code>UserBo.create(User user)</code>, <code>userBo.toUser()</code>。</li>
<li>支持 POJO <code>继承</code>.</li>
<li>支持对象池（比如 <code>android.support.v4.util.Pools</code>）。</li>
</ol>
<h2 id="怎么使用？"><a href="#怎么使用？" class="headerlink" title="怎么使用？"></a>怎么使用？</h2><p>Gradle <a href="http://search.maven.org/#search%7Cga%7C1%7Crapidooo" target="_blank" rel="noopener">Check Newest Version</a></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">"com.github.wangjiegulu:rapidooo-api:x.x.x"</span></span><br><span class="line">annotationProcessor <span class="string">"com.github.wangjiegulu:rapidooo-compiler:x.x.x"</span></span><br></pre></td></tr></table></figure>
<p>以下通过两个例子来说明:</p>
<p><strong>User POJO:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Integer gender;</span><br><span class="line">    <span class="comment">// getter setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Pet POJO:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long petId;</span><br><span class="line">    <span class="keyword">private</span> String petName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isCat;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> delete;</span><br><span class="line">    <span class="keyword">private</span> Boolean isDog;</span><br><span class="line">    <span class="keyword">private</span> Boolean clear;</span><br><span class="line">    <span class="keyword">private</span> User owner;</span><br><span class="line">    <span class="comment">// getter  settter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="POJO-转换为-BO"><a href="#POJO-转换为-BO" class="headerlink" title="POJO 转换为 BO"></a>POJO 转换为 BO</h3><p>创建 <code>BOGenerator</code> 类，配置以下注解:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OOOs</span>(suffix = BOGenerator.BO_SUFFIX, ooos = &#123;</span><br><span class="line">        <span class="meta">@OOO</span>(id = <span class="string">"user_bo_id"</span>, from = User.class, suffix = BOGenerator.BO_SUFFIX_USER),</span><br><span class="line">        <span class="meta">@OOO</span>(from = Pet.class, conversion = &#123;</span><br><span class="line">                <span class="meta">@OOOConversion</span>(</span><br><span class="line">                        fieldName = <span class="string">"owner"</span>,</span><br><span class="line">                        targetTypeId = <span class="string">"user_bo_id"</span>,</span><br><span class="line">                        targetFieldName = <span class="string">"ownerUser"</span>,</span><br><span class="line">                        replace = <span class="keyword">true</span></span><br><span class="line">                )</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BOGenerator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BO_SUFFIX = <span class="string">"BO"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BO_SUFFIX_USER = <span class="string">"_BO"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用 <code>@OOOs</code> 注解来进行转换的配置，通过 <code>@OOO</code> 注解来显示地指定需要转换成哪些类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OOO</span>(id = <span class="string">"user_bo_id"</span>, from = User.class, suffix = BOGenerator.BO_SUFFIX_USER)</span><br></pre></td></tr></table></figure>
<p>以上表示一个类的转换:</p>
<ul>
<li><strong>id:</strong>表示本地转换的 id，可以为任意字符串（需唯一），默认不设置 id。</li>
<li><strong>from:</strong>表示转换源，从 <code>User</code> 转换，必填。</li>
<li><strong>suffix:</strong>表示生成的 POJO 类的名字后缀，这里是 <code>_BO</code>，所以生成的类名为 <code>User_BO</code>，默认使用 <code>@OOOs</code> 中的 <code>suffix</code>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OOO</span>(from = Pet.class, conversion = &#123;</span><br><span class="line">      <span class="meta">@OOOConversion</span>(</span><br><span class="line">              fieldName = <span class="string">"owner"</span>,</span><br><span class="line">              targetTypeId = <span class="string">"user_bo_id"</span>,</span><br><span class="line">              targetFieldName = <span class="string">"ownerUser"</span>,</span><br><span class="line">              replace = <span class="keyword">true</span></span><br><span class="line">      )</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>以上也表示一个类的转换，但是可以通过 <code>@OOOConversion</code> 来新增一个字段:</p>
<ul>
<li><strong>fieldName:</strong>指定新的字段是从转换源 POJO 的哪个字段派生出来的</li>
<li><strong>targetTypeId:</strong>用来指定新的字段的类型id，需要与其它的 <code>@OOO</code> 指定的 <code>id</code> 一致；也可以通过 <code>targetType</code> 来指定 Class 类型。</li>
<li><strong>targetFieldName:</strong>指定新字段的名字，可以任意。</li>
<li><strong>replace:</strong>新的字段是否替换原来的字段（<strong>fieldName</strong>），如果 false，则共存。</li>
</ul>
<p>然后编译将会自动生成以下代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User_BO</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Long userId;</span><br><span class="line">  <span class="keyword">private</span> String username;</span><br><span class="line">  <span class="keyword">private</span> String nickname;</span><br><span class="line">  <span class="keyword">private</span> Integer age;</span><br><span class="line">  <span class="keyword">private</span> Integer gender;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getter setter</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User_BO <span class="title">create</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">    User_BO user_BO = <span class="keyword">new</span> User_BO();</span><br><span class="line">    user_BO.userId = user.getUserId();</span><br><span class="line">    user_BO.username = user.getUsername();</span><br><span class="line">    user_BO.nickname = user.getNickname();</span><br><span class="line">    user_BO.age = user.getAge();</span><br><span class="line">    user_BO.gender = user.getGender();</span><br><span class="line">    <span class="keyword">return</span> user_BO;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> User <span class="title">toUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setUserId(userId);</span><br><span class="line">    user.setUsername(username);</span><br><span class="line">    user.setNickname(nickname);</span><br><span class="line">    user.setAge(age);</span><br><span class="line">    user.setGender(gender);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PetBO</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Long petId;</span><br><span class="line">  <span class="keyword">private</span> String petName;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> isCat;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> delete;</span><br><span class="line">  <span class="keyword">private</span> Boolean isDog;</span><br><span class="line">  <span class="keyword">private</span> Boolean clear;</span><br><span class="line">  <span class="keyword">private</span> User_BO ownerUser;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getter setter</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PetBO <span class="title">create</span><span class="params">(Pet pet)</span> </span>&#123;</span><br><span class="line">    PetBO petBO = <span class="keyword">new</span> PetBO();</span><br><span class="line">    petBO.petId = pet.getPetId();</span><br><span class="line">    petBO.petName = pet.getPetName();</span><br><span class="line">    petBO.isCat = pet.isCat();</span><br><span class="line">    petBO.delete = pet.isDelete();</span><br><span class="line">    petBO.isDog = pet.getDog();</span><br><span class="line">    petBO.clear = pet.getClear();</span><br><span class="line">    petBO.ownerUser = User_BO.create(pet.getOwner());</span><br><span class="line">    <span class="keyword">return</span> petBO;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Pet <span class="title">toPet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Pet pet = <span class="keyword">new</span> Pet();</span><br><span class="line">    pet.setPetId(petId);</span><br><span class="line">    pet.setPetName(petName);</span><br><span class="line">    pet.setCat(isCat);</span><br><span class="line">    pet.setDelete(delete);</span><br><span class="line">    pet.setDog(isDog);</span><br><span class="line">    pet.setClear(clear);</span><br><span class="line">    pet.setOwner(ownerUser.toUser());</span><br><span class="line">    <span class="keyword">return</span> pet;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BO-转换为-VO"><a href="#BO-转换为-VO" class="headerlink" title="BO 转换为 VO"></a>BO 转换为 VO</h3><p>如下新建 <code>VOGenerator</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OOOs</span>(suffix = VOGenerator.VO_SUFFIX, fromSuffix = BOGenerator.BO_SUFFIX, ooosPackages = &#123;</span><br><span class="line">        VOGenerator.PACKAGE_BO</span><br><span class="line">&#125;, ooos = &#123;</span><br><span class="line">        <span class="meta">@OOO</span>(id = <span class="string">"user_vo_id"</span>, from = User_BO.class),</span><br><span class="line">        <span class="meta">@OOO</span>(from = User_BO.class<span class="comment">/*, suffix = VOGenerator.VO_SUFFIX_USER*/</span>,</span><br><span class="line">                fromSuffix = BOGenerator.BO_SUFFIX_USER,</span><br><span class="line">                conversion = &#123;</span><br><span class="line">                        <span class="meta">@OOOConversion</span>(</span><br><span class="line">                                fieldName = <span class="string">"gender"</span>,</span><br><span class="line">                                targetFieldName = <span class="string">"genderDesc"</span>,</span><br><span class="line">                                targetType = String.class,</span><br><span class="line">                                conversionMethodName = <span class="string">"conversionGender"</span>,</span><br><span class="line">                                inverseConversionMethodName = <span class="string">"inverseConversionGender"</span>,</span><br><span class="line">                                replace = <span class="keyword">false</span></span><br><span class="line">                        ),</span><br><span class="line">                        <span class="meta">@OOOConversion</span>(</span><br><span class="line">                                fieldName = <span class="string">"age"</span>,</span><br><span class="line">                                targetFieldName = <span class="string">"ageDes"</span>,</span><br><span class="line">                                targetType = String.class,</span><br><span class="line">                                conversionMethodName = <span class="string">"conversionAge"</span>,</span><br><span class="line">                                conversionMethodClass = AgeConversion.class,</span><br><span class="line">                                replace = <span class="keyword">true</span></span><br><span class="line">                        )</span><br><span class="line">                &#125;</span><br><span class="line">        ),</span><br><span class="line">        <span class="meta">@OOO</span>(from = PetBO.class,</span><br><span class="line">                conversion = &#123;</span><br><span class="line">                        <span class="meta">@OOOConversion</span>(</span><br><span class="line">                                fieldName = <span class="string">"ownerUser"</span>,</span><br><span class="line">                                targetFieldName = <span class="string">"ownerUser"</span>,</span><br><span class="line">                                targetTypeId = <span class="string">"user_vo_id"</span>,</span><br><span class="line">                                replace = <span class="keyword">true</span></span><br><span class="line">                        )</span><br><span class="line">                &#125;</span><br><span class="line">        )</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VOGenerator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String VO_SUFFIX = <span class="string">"VO"</span>;</span><br><span class="line">    <span class="comment">//    public static final String VO_SUFFIX_USER = "_VO";</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_BO = <span class="string">"com.wangjiegulu.rapidooo.depmodule.bll.xbo"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">conversionGender</span><span class="params">(Integer gender)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == gender) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"unknown"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (gender) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"female"</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"male"</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"unknown"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">inverseConversionGender</span><span class="params">(String genderDesc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (genderDesc) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"male"</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"female"</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是通过 <code>@OOOs</code> 注解来指定要生成的类，但这里使用了 <code>ooosPackages</code> 来指定哪些包下面的类需要进行转换。</p>
<p>转换源为上面生成的:<code>User_BO</code> 和 <code>PetBO</code>，生成的类名为 <code>UserVO</code> 和 <code>PetVO</code>。</p>
<p>在 <code>UserVO</code> 中扩展了两个字段:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OOOConversion</span>(</span><br><span class="line">       fieldName = <span class="string">"gender"</span>,</span><br><span class="line">       targetFieldName = <span class="string">"genderDesc"</span>,</span><br><span class="line">       targetType = String.class,</span><br><span class="line">       conversionMethodName = <span class="string">"conversionGender"</span>,</span><br><span class="line">       inverseConversionMethodName = <span class="string">"inverseConversionGender"</span>,</span><br><span class="line">       replace = <span class="keyword">false</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>从转换源的 <code>gender</code> 字段扩展出 <code>genderDesc</code> （用于在 View 上进行展示），类型为 <code>String</code> ，并且 <code>replace = false</code>（<code>gender</code> 与 <code>genderDesc</code> 共存）:</p>
<ul>
<li><strong>conversionMethodName:</strong>指定转换方法，从 <code>gender</code> 转换为 <code>genderDesc</code>。默认为不设置。</li>
<li><strong>inverseConversionMethodName:</strong>指定逆转换方法，从 <code>genderDesc</code> 转换为 <code>gender</code>。默认为不设置。</li>
</ul>
<blockquote>
<p><strong>注意:</strong><code>conversionMethodName</code> 和 <code>inverseConversionMethodName</code> 方法指定方法名字时，方法签名必须满足以下其一:</p>
<ul>
<li><code>public static [转换目标类型] conversionXxx([转换源字段类型] param)</code></li>
<li><code>public static [转换目标类型] conversionXxx([转换源 class 类型] param1, [转换源字段类型] param2)</code><br>如上面 <code>gender</code> 和 <code>genderDesc</code> 的转换:</li>
<li><code>public static String conversionGender(UserVO userVO, Integer gender)</code></li>
<li><code>public static Integer inverseConversionGender(String genderDesc)</code></li>
</ul>
</blockquote>
<p>通过设置以上两个方法，<code>gender</code> 和 <code>genderDesc</code> 两个字段会实现互相绑定，改变其中一个字段，另一个字段也会自动发生改变。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OOOConversion</span>(</span><br><span class="line">       fieldName = <span class="string">"age"</span>,</span><br><span class="line">       targetFieldName = <span class="string">"ageDes"</span>,</span><br><span class="line">       targetType = String.class,</span><br><span class="line">       conversionMethodName = <span class="string">"conversionAge"</span>,</span><br><span class="line">       conversionMethodClass = AgeConversion.class,</span><br><span class="line">       replace = <span class="keyword">true</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><code>UserVO</code> 中还从转换源的 <code>age</code> 扩展了一个 <code>ageDesc</code> 属性（替换掉 <code>age</code> 字段，不共存），并指定了 <code>conversionMethodName</code>，但是转换方法并不在 <code>VOGenerator</code> 类中，而是在 <code>AgeConversion</code> 类中，所以需要显示地进行指定 <code>conversionMethodClass</code>。</p>
<ul>
<li><strong>conversionMethodClass:</strong>转换方法所在的 Class，默认不设置则表示在当前的 <code>Generator</code> 类中。</li>
</ul>
<p>另外 <code>PetVO</code> 扩展了一个 <code>ownerUser</code>。</p>
<p>最后编译生成的代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserVO</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Long userId;</span><br><span class="line">  <span class="keyword">private</span> String username;</span><br><span class="line">  <span class="keyword">private</span> String nickname;</span><br><span class="line">  <span class="keyword">private</span> String ageDes;</span><br><span class="line">  <span class="keyword">private</span> Integer gender;</span><br><span class="line">  <span class="keyword">private</span> String genderDesc;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getter setter</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGender</span><span class="params">(Integer gender)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.gender = gender;</span><br><span class="line">    <span class="keyword">this</span>.genderDesc = VOGenerator.conversionGender(gender);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGenderDesc</span><span class="params">(String genderDesc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.genderDesc = genderDesc;</span><br><span class="line">    <span class="keyword">this</span>.gender = VOGenerator.inverseConversionGender(genderDesc);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> UserVO <span class="title">create</span><span class="params">(User_BO user_BO)</span> </span>&#123;</span><br><span class="line">    UserVO userVO = <span class="keyword">new</span> UserVO();</span><br><span class="line">    userVO.userId = user_BO.getUserId();</span><br><span class="line">    userVO.username = user_BO.getUsername();</span><br><span class="line">    userVO.nickname = user_BO.getNickname();</span><br><span class="line">    userVO.ageDes = AgeConversion.conversionAge(user_BO.getAge());</span><br><span class="line">    userVO.gender = user_BO.getGender();</span><br><span class="line">    userVO.genderDesc = VOGenerator.conversionGender(user_BO.getGender());</span><br><span class="line">    <span class="keyword">return</span> userVO;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> User_BO <span class="title">toUser_BO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User_BO user_BO = <span class="keyword">new</span> User_BO();</span><br><span class="line">    user_BO.setUserId(userId);</span><br><span class="line">    user_BO.setUsername(username);</span><br><span class="line">    user_BO.setNickname(nickname);</span><br><span class="line">    <span class="comment">// Loss field:age, recommend to use `inverseConversionMethodName`.</span></span><br><span class="line">    user_BO.setGender(gender);</span><br><span class="line">    <span class="keyword">return</span> user_BO;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意:</strong>以上 <code>User_BO</code>，由于 <code>age</code> 属性是 <code>replace</code>，并且只设置了 <code>conversionMethodName</code>，并没有设置 <code>inverseConversionMethodName</code>，所以在 <code>toUser_BO()</code> 方法进行逆转换时会丢失 <code>age</code> 属性，所以推荐使用 <code>inverseConversionMethodName</code>。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PetVO</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Long petId;</span><br><span class="line">  <span class="keyword">private</span> String petName;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> isCat;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> delete;</span><br><span class="line">  <span class="keyword">private</span> Boolean isDog;</span><br><span class="line">  <span class="keyword">private</span> Boolean clear;</span><br><span class="line">  <span class="keyword">private</span> UserVO ownerUser;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getter setter</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PetVO <span class="title">create</span><span class="params">(PetBO petBO)</span> </span>&#123;</span><br><span class="line">    PetVO petVO = <span class="keyword">new</span> PetVO();</span><br><span class="line">    petVO.petId = petBO.getPetId();</span><br><span class="line">    petVO.petName = petBO.getPetName();</span><br><span class="line">    petVO.isCat = petBO.isCat();</span><br><span class="line">    petVO.delete = petBO.isDelete();</span><br><span class="line">    petVO.isDog = petBO.getDog();</span><br><span class="line">    petVO.clear = petBO.getClear();</span><br><span class="line">    petVO.ownerUser = UserVO.create(petBO.getOwnerUser());</span><br><span class="line">    <span class="keyword">return</span> petVO;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PetBO <span class="title">toPetBO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    PetBO petBO = <span class="keyword">new</span> PetBO();</span><br><span class="line">    petBO.setPetId(petId);</span><br><span class="line">    petBO.setPetName(petName);</span><br><span class="line">    petBO.setCat(isCat);</span><br><span class="line">    petBO.setDelete(delete);</span><br><span class="line">    petBO.setDog(isDog);</span><br><span class="line">    petBO.setClear(clear);</span><br><span class="line">    petBO.setOwnerUser(ownerUser.toUser_BO());</span><br><span class="line">    <span class="keyword">return</span> petBO;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="对象池的使用"><a href="#对象池的使用" class="headerlink" title="对象池的使用"></a>对象池的使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OOOs</span>(suffix = <span class="string">"BO"</span>, ooos = &#123;</span><br><span class="line">        <span class="meta">@OOO</span>(from = Pet.class, pool = <span class="meta">@OOOPool</span>(</span><br><span class="line">            acquireMethod = <span class="string">"acquirePetBO"</span>, </span><br><span class="line">            releaseMethod = <span class="string">"releasePetBO"</span></span><br><span class="line">        ))</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectPoolBOGenerator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Pools.Pool&lt;PetBO&gt; petBOPool = <span class="keyword">new</span> Pools.SimplePool&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PetBO <span class="title">acquirePetBO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        PetBO petBO = petBOPool.acquire();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span> == petBO ? <span class="keyword">new</span> PetBO() : petBO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">releasePetBO</span><span class="params">(PetBO petBO)</span> </span>&#123;</span><br><span class="line">        petBOPool.release(petBO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上代码，通过添加 <code>@OOOPool</code> 注解，并指定 <code>acquireMethod</code> 和 <code>releaseMethod</code> 两个方法来创建和回收相应的对象即可（这里使用了 Android Support 包中的 <code>Pools.SimplePool</code> 来实现对象池）。</p>
<h1 id="License"><a href="#License" class="headerlink" title="License"></a>License</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Copyright 2018 Wang Jie</span><br><span class="line"></span><br><span class="line">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line">you may not use this file except in compliance with the License.</span><br><span class="line">You may obtain a copy of the License at</span><br><span class="line"></span><br><span class="line">  http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"></span><br><span class="line">Unless required by applicable law or agreed to in writing, software</span><br><span class="line">distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line">See the License for the specific language governing permissions and</span><br><span class="line">limitations under the License.</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> android </category>
            
            <category> pojo converter </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> annotations </tag>
            
            <tag> javabean </tag>
            
            <tag> pojo </tag>
            
            <tag> domain-driven-design </tag>
            
            <tag> apt </tag>
            
            <tag> javapoet </tag>
            
            <tag> annotation processor </tag>
            
            <tag> pojo converter </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Architecture Component Lifecycle（翻译）]]></title>
      <url>/2018/04/15/android_architecture_components_lifecycle/</url>
      <content type="html"><![CDATA[<h1 id="Android-Architecture-Component-Lifecycle（翻译）"><a href="#Android-Architecture-Component-Lifecycle（翻译）" class="headerlink" title="Android Architecture Component Lifecycle（翻译）"></a>Android Architecture Component Lifecycle（翻译）</h1><blockquote>
<p>原文：<a href="https://developer.android.com/topic/libraries/architecture/lifecycle" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/architecture/lifecycle</a></p>
</blockquote>
<p>生命周期感知的组件执行行为以响应另一个组件的生命周期状态的变化，比如 activities 和 fragments。这些组件可以帮助你生产更好的组织结构，通常是更容易维护的轻量代码。</p>
<p>一种常见的模式是在 activity 和 fragment 的生命周期方法中实现依赖组件的行为。但是，这种模式会导致较差的代码组织，并导致错误激增。通过使用生命周期感知的组件，你可以将相关组件的代码从生命周期方法中移动到组件本身中去。</p>
<p><a href="https://developer.android.com/reference/android/arch/lifecycle/package-summary.html" target="_blank" rel="noopener"><code>android.arch.lifecycle</code></a> 包提供了类和接口让你去构建 <em>生命周期感知</em> 组件 —— 它们是能基于当前 activity 或 fragment 生命周期状态来自动调整它们行为的组件。</p>
<blockquote>
<p><strong>注意</strong>：要导入 <a href="https://developer.android.com/reference/android/arch/lifecycle/package-summary.html" target="_blank" rel="noopener">android.arch.lifecycle</a> 到你的 Android 项目，可参阅 <a href="https://blog.wangjiegulu.com/2018/04/15/android_architecture_components_overview/#Lifecycle">增加 components 到你的项目中</a>。</p>
</blockquote>
<p>在 Android Framework 中定义的大部分 app components 都附加了 lifecycle。Lifecycles 是被操作系统或者你进程中的运行的 framework 代码所管理。它们是 android 工作原理的核心，你的应用程序必须关心它们。如果不这么做，可能会触发内存泄漏或者甚至是应用崩溃。</p>
<p>想象我们有一个 activity，它在屏幕上显示设备的位置信息。一个常用的实现可能如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLocationListener</span></span>(</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> context: Context,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> callback: (Location) -&gt; <span class="built_in">Unit</span></span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// connect to system location service</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">stop</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// disconnect from system location service</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> myLocationListener: MyLocationListener</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(...)</span></span> &#123;</span><br><span class="line">        myLocationListener = MyLocationListener(<span class="keyword">this</span>) &#123; location -&gt;</span><br><span class="line">            <span class="comment">// update UI</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStart</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart()</span><br><span class="line">        myLocationListener.start()</span><br><span class="line">        <span class="comment">// manage other components that need to respond</span></span><br><span class="line">        <span class="comment">// to the activity lifecycle</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStop</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onStop()</span><br><span class="line">        myLocationListener.stop()</span><br><span class="line">        <span class="comment">// manage other components that need to respond</span></span><br><span class="line">        <span class="comment">// to the activity lifecycle</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尽管这个例子看起来不错，在实际的 app 中，你最终会有太多的调用来管理 UI 和其它组件来响应生命周期的当前状态。管理多个组件会在生命周期方法中放置大量代码，比如 <a href="https://developer.android.com/reference/android/app/Activity.html#onStart(" target="_blank" rel="noopener"><code>onStart()</code></a>) 和 <a href="https://developer.android.com/reference/android/app/Activity.html#onStop(" target="_blank" rel="noopener"><code>onStop()</code></a>)，它会导致难以维护的问题。</p>
<p>此外，还不能保证组件在 activity 或者 fragment 在停止之前启动。如果我们需要执行长时间运行的操作的时候尤其如此。比如在 <a href="https://developer.android.com/reference/android/app/Activity.html#onStart(" target="_blank" rel="noopener"><code>onStart()</code></a>) 中执行一些配置检查。<a href="https://developer.android.com/reference/android/app/Activity.html#onStop(" target="_blank" rel="noopener"><code>onStop()</code></a>) 方法在 <a href="https://developer.android.com/reference/android/app/Activity.html#onStart(" target="_blank" rel="noopener"><code>onStart()</code></a>) 之前完成这点可能会引起争用条件，使得组件的生存期超过所需的时间。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> myLocationListener: MyLocationListener</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(...)</span></span> &#123;</span><br><span class="line">        myLocationListener = MyLocationListener(<span class="keyword">this</span>) &#123; location -&gt;</span><br><span class="line">            <span class="comment">// update UI</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStart</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart()</span><br><span class="line">        Util.checkUserStatus &#123; result -&gt;</span><br><span class="line">            <span class="comment">// what if this callback is invoked AFTER activity is stopped?</span></span><br><span class="line">            <span class="keyword">if</span> (result) &#123;</span><br><span class="line">                myLocationListener.start()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStop</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onStop()</span><br><span class="line">        myLocationListener.stop()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://developer.android.com/reference/android/arch/lifecycle/package-summary.html" target="_blank" rel="noopener"><code>android.arch.lifecycle</code></a> 包提供的类和接口可以帮助你使用弹性和独立的方式解决这些问题。</p>
<h2 id="Lifecycle"><a href="#Lifecycle" class="headerlink" title="Lifecycle"></a>Lifecycle</h2><p><a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 这个类持有了关于组件（比如 activity 和 fragment）生命周期状态的信息，并允许其它对象观察这个状态。</p>
<p><a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 使用两种主要的枚举来追踪关联组件的生命周期状态：</p>
<ul>
<li><p><strong>Event</strong></p>
<p>生命周期 event 从 framework 和 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 类中派发。这些事件在 activities 和 fragments 中映射到回调 events 中。</p>
</li>
<li><p><strong>State</strong></p>
<p>组件通过 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 对象追踪的当前状态。</p>
</li>
</ul>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/48882877-e36df600-ee57-11e8-91df-117c02e796ee.png" width="600px/"><br></div>

<p>将 states 视为图形的节点，将 events 视为这些节点之间的边。</p>
<p>一个类可以通过在它方法上增加一些注解来模拟组件的生命周期状态。然后你可以通过调用 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 类的 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html#addObserver(android.arch.lifecycle.LifecycleObserver" target="_blank" rel="noopener"><code>addObserver()</code></a>) 方法并传入一个 observer 的实例来增加一个 observer，如下例子所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObserver</span> : <span class="type">LifecycleObserver &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_RESUME)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">connectListener</span><span class="params">()</span></span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_PAUSE)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">disconnectListener</span><span class="params">()</span></span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上述的例子中，<code>myLifecycleOwner</code> 对象实现了 <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html" target="_blank" rel="noopener"><code>LifecycleOwner</code></a> 接口，它会在面再详细说明。</p>
<h2 id="LifecycleOwner"><a href="#LifecycleOwner" class="headerlink" title="LifecycleOwner"></a>LifecycleOwner</h2><p><a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html" target="_blank" rel="noopener"><code>LifecycleOwner</code></a> 是一个单方法的接口，表示这个类有一个 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener">Lifecycle</a>。它有一个方法，<a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html#getLifecycle(" target="_blank" rel="noopener"><code>getLifecycle()</code></a>)，它必须由类去实现。如果你尝试管理整个应用程序进程的 lifecycle，见 <a href="https://developer.android.com/reference/android/arch/lifecycle/ProcessLifecycleOwner.html" target="_blank" rel="noopener"><code>ProcessLifecycleOwner</code></a>。</p>
<p>这个接口抽象了单独的类，比如 <a href="https://developer.android.com/reference/android/support/v4/app/Fragment.html" target="_blank" rel="noopener"><code>Fragment</code></a> 和 <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html" target="_blank" rel="noopener"><code>AppCompatActivity</code></a> 的 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 所有权，允许编写组件来跟它们一起工作。任何自定义的应用类都可以实现 <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html" target="_blank" rel="noopener"><code>LifecycleOwner</code></a> 接口。</p>
<p>实现了 <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleObserver.html" target="_blank" rel="noopener"><code>LifecycleObserver</code></a> 的组件可以无缝与 <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html" target="_blank" rel="noopener"><code>LifecycleOwner</code></a> 一起工作，因为一个 owner 可以提供一个 lifecycle，observer 可以注册观察它。</p>
<p>对于位置追踪的例子，我们可以让 <code>MyLocationListener</code> 类实现 <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleObserver.html" target="_blank" rel="noopener"><code>LifecycleObserver</code></a> 并通过 Activity <a href="https://developer.android.com/reference/android/app/Activity.html#onCreate(android.os.Bundle" target="_blank" rel="noopener"><code>onCreate</code></a>) 方法中的 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 初始化它。这允许 <code>MyLocationListener</code> 类自给自足，意味着对生命周期状态变化做出反应的逻辑的声明是在 <code>MyLocationListener</code> 中，而不是 activity。让各个组件存储自己的逻辑使 activity 和 fragment 逻辑更易于管理。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> myLocationListener: MyLocationListener</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(...)</span></span> &#123;</span><br><span class="line">        myLocationListener = MyLocationListener(<span class="keyword">this</span>, lifecycle) &#123; location -&gt;</span><br><span class="line">            <span class="comment">// update UI</span></span><br><span class="line">        &#125;</span><br><span class="line">        Util.checkUserStatus &#123; result -&gt;</span><br><span class="line">            <span class="keyword">if</span> (result) &#123;</span><br><span class="line">                myLocationListener.enable()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个常用的用例是，如果 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 当前不是一个好的状态，则避免调用某些回调。举例，如果回调在保存 activity 状态后运行 fragment 事务，它可能会触发一个崩溃，所以我们永远都不希望执行这个回调。</p>
<p>为了让用例简单，<a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 类允许其它对象去查询当前的状态。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLocationListener</span></span>(</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> context: Context,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> lifecycle: Lifecycle,</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> callback: (Location) -&gt; <span class="built_in">Unit</span></span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> enabled = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_START)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">            <span class="comment">// connect</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">enable</span><span class="params">()</span></span> &#123;</span><br><span class="line">        enabled = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">if</span> (lifecycle.currentState.isAtLeast(Lifecycle.State.STARTED)) &#123;</span><br><span class="line">            <span class="comment">// connect if not connected</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_STOP)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">stop</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// disconnect if connected</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这个实现，我们的 <code>LocationListener</code> 类是完全生命周期感知的。如果我们需要从其它的 activity 和 fragment 去使用 <code>LocationListener</code>，我们只需要初始化它。所有 setup 和 teardown 的操作都是自己类本身管理的。</p>
<p>如果库提供的类需要与 Android 生命周期一起使用，我们推荐使用生命周期感知的组件。你的库 client 端可以轻松集成这些组件，而无需在 client 端进行手动生命周期管理。</p>
<h3 id="实现一个自定义的-LifecycleOwner"><a href="#实现一个自定义的-LifecycleOwner" class="headerlink" title="实现一个自定义的 LifecycleOwner"></a>实现一个自定义的 LifecycleOwner</h3><p>在 Support Library 26.1.0 及以上版本，Fragments 和 Activities 已经使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html" target="_blank" rel="noopener"><code>LifecycleOwner</code></a> 接口实现。</p>
<p>如果你要自定义一个 <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html" target="_blank" rel="noopener"><code>LifecycleOwner</code></a> 的类，你可以使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleRegistry.html" target="_blank" rel="noopener">LifecycleRegistry</a> 类，但是需要在这个 class 中转发 events，如下示例：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> : <span class="type">AppCompatActivity</span></span>(), LifecycleOwner &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mLifecycleRegistry: LifecycleRegistry</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line"></span><br><span class="line">        mLifecycleRegistry = LifecycleRegistry(<span class="keyword">this</span>)</span><br><span class="line">        mLifecycleRegistry.markState(Lifecycle.State.CREATED)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStart</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart()</span><br><span class="line">        mLifecycleRegistry.markState(Lifecycle.State.STARTED)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getLifecycle</span><span class="params">()</span></span>: Lifecycle &#123;</span><br><span class="line">        <span class="keyword">return</span> mLifecycleRegistry</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="生命周期感知组件的最佳实践"><a href="#生命周期感知组件的最佳实践" class="headerlink" title="生命周期感知组件的最佳实践"></a>生命周期感知组件的最佳实践</h2><ul>
<li>保持你的 UI Controllers （activities 和 fragments）尽可能简洁。它们不应该去尝试获取它们自己的数据。而是应该使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 去做，然后观察一个 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 对象去响应对 view 的更改。</li>
<li>在你的 UI Controllers 中尝试编写数据驱动的 UI，它负责在数据改变时更新 views，或者通知用户的行为给 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a>。</li>
<li>把数据逻辑代码放在 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 类中。<a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 应该作为 UI Controller 和 app 其余部分之间的连接器。不过要小心，<a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 不负责去获取数据（比如，从网络）。<a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 应该调用适当的组件去获取数据，然后提供结果给 UI Controller。</li>
<li>使用 <a href="https://developer.android.com/topic/libraries/data-binding/index.html" target="_blank" rel="noopener">Data Binding</a> 在你的 views 和 UI Controller 之间去维护一个清晰的接口。这让你可以使你的 views 更具声明性，并最大限度地减少你需要在 activities 和 fragments 中编写的更新代码。如果还是希望使用 Java 语言来做这些，使用像 <a href="http://jakewharton.github.io/butterknife/" target="_blank" rel="noopener">Butter Knife</a> 的库来避免模版代码和做更好的抽象。</li>
<li>如果你的 UI 是复杂的，考虑创建一个 <a href="http://www.gwtproject.org/articles/mvp-architecture.html#presenter" target="_blank" rel="noopener">presenter</a> 类来处理 UI 改动。这可能是个费力的任务，但是它会让你的 UI 组件变得更容易测试。   </li>
<li>避免在你的 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 中引用 <a href="https://developer.android.com/reference/android/view/View.html" target="_blank" rel="noopener"><code>View</code></a> 和 <a href="https://developer.android.com/reference/android/app/Activity.html" target="_blank" rel="noopener"><code>Activity</code></a> context。如果 <code>ViewModel</code> 寿命比 activity 长（比如配置改变的情况），你的 activity 会泄漏并且 gc 不会正确处理它。</li>
</ul>
<h2 id="生命周期感知组件的用例"><a href="#生命周期感知组件的用例" class="headerlink" title="生命周期感知组件的用例"></a>生命周期感知组件的用例</h2><p>生命周期感知组件可以让你在各种情况下更轻松地管理生命周期。以下是几个例子：</p>
<ul>
<li>在粗粒度和细粒度的位置更新之间切换。使用生命周期感知组件，在位置应用可见时启用细粒度位置更新，并在应用处于后台时切换到粗粒度更新。<a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a>，一个生命周期感知的组件，当你的用户改变位置时，允许你的 app 自动更新 UI。</li>
<li>停止和启动视频缓冲。使用生命周期感知组件来尽可能快地开始视频缓冲，但会推迟播放，直到应用程序完全启动。你还可以使用生命周期感知组件在应用被销毁时终止缓冲。</li>
<li>启动和停止网络连接。使用生命周期感知组件当 app 在前台时启用网络数据的实时更新（流），也在 app 进入到后台的时候自动暂停。</li>
<li>暂停和恢复动画绘图。使用生命周期感知组件当 app 在后台时暂停动画绘制，当 app 在前台时恢复绘制。</li>
</ul>
<h2 id="对停止事件的处理"><a href="#对停止事件的处理" class="headerlink" title="对停止事件的处理"></a>对停止事件的处理</h2><p>当 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 属于一个 <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html" target="_blank" rel="noopener"><code>AppCompatActivity</code></a> 或者 <a href="https://developer.android.com/reference/android/support/v4/app/Fragment.html" target="_blank" rel="noopener"><code>Fragment</code></a>，当  <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html" target="_blank" rel="noopener"><code>AppCompatActivity</code></a> 或者 <a href="https://developer.android.com/reference/android/support/v4/app/Fragment.html" target="_blank" rel="noopener"><code>Fragment</code></a> 的 <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html#onSaveInstanceState(android.os.Bundle" target="_blank" rel="noopener"><code>onSaveInstanceState()</code></a>) 被调用时，事件被派发，使得<a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 的状态变为 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.State.html#CREATED" target="_blank" rel="noopener"><code>CREATED</code></a> 和 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.Event.html#ON_STOP" target="_blank" rel="noopener"><code>ON_STOP</code></a>。</p>
<p>当 <a href="https://developer.android.com/reference/android/support/v4/app/Fragment.html" target="_blank" rel="noopener"><code>Fragment</code></a> 或者 <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html" target="_blank" rel="noopener"><code>AppCompatActivity</code></a> 的状态被保存在 <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html#onSaveInstanceState(android.os.Bundle" target="_blank" rel="noopener"><code>onSaveInstanceState()</code></a>)，它的 UI 被认为是不可变的，直到 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.Event.html#ON_START" target="_blank" rel="noopener"><code>ON_START</code></a> 被调用。在保存状态后尝试修改 UI 可能会导致应用程序的导航状态不一致，这就是为什么当应用在保存状态后运行 <a href="https://developer.android.com/reference/android/support/v4/app/FragmentTransaction.html" target="_blank" rel="noopener"><code>FragmentTransaction</code></a> 时，<a href="https://developer.android.com/reference/android/support/v4/app/FragmentManager.html" target="_blank" rel="noopener"><code>FragmentManager</code></a> 将引发异常的原因。详情见 <a href="https://developer.android.com/reference/android/support/v4/app/FragmentTransaction.html#commit(" target="_blank" rel="noopener"><code>commit()</code></a>)。</p>
<p><a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 防止这种边界情况发生，它通过当 observer 关联的 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 不是至少是 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.State.html#STARTED" target="_blank" rel="noopener"><code>STARTED</code></a>，则避免调用它的 observer。在幕后，它在决定调用 obserfver 之前调用了 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.State.html#isAtLeast(android.arch.lifecycle.Lifecycle.State" target="_blank" rel="noopener"><code>isAtLeast()</code></a>)。</p>
<p>不幸的是，<a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html" target="_blank" rel="noopener"><code>AppCompatActivity</code></a> 的 <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html#onStop(" target="_blank" rel="noopener"><code>onStop()</code></a>) 方法是在 <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html#onSaveInstanceState(android.os.Bundle" target="_blank" rel="noopener"><code>onSaveInstanceState()</code></a>) 之后，这就留下了一个空隙，即不允许 UI 状态改变，但生命周期还未到 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.State.html#CREATED" target="_blank" rel="noopener"><code>CREATED</code></a> 状态。</p>
<p>为了防止这个问题，<a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 类在版本 <code>beta2</code> 及以下标记状态为 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.State.html#CREATED" target="_blank" rel="noopener"><code>CREATED</code></a> 而不经过事件派发，所以检查当前状态的任何代码都会获得真正的值，即使在 <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html#onStop(" target="_blank" rel="noopener"><code>onStop()</code></a>) 被系统调用之前，该事件才被调度。</p>
<p>不幸的是，这个解决方案会有两个主要的问题：</p>
<ul>
<li>在 API level 23 及以下，Android 系统实际上保存了一个 activity 的状态，即使它被另一个 activity <em>部分</em> 覆盖。换句话说，Android 系统调用 <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html#onSaveInstanceState(android.os.Bundle" target="_blank" rel="noopener"><code>onSaveInstanceState()</code></a>)，但是它不一定调用 <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html#onStop(" target="_blank" rel="noopener"><code>onStop()</code></a>)。这将创建一个可能较长的时间间隔，观察者仍然认为生命周期是 active 的，尽管它的 UI 状态无法修改。</li>
<li>任何想要向 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 类公开类似行为的类都必须实现生命周期 <code>beta2</code> 及以下版本提供的解决方法。</li>
</ul>
<blockquote>
<p><strong>注意</strong>：为了使此流程更简单，并提供与旧版本更好的兼容性，从版本 <strong>1.0.0-rc1</strong> 开始，<a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener">Lifecycle</a> 对象在 <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html#onSaveInstanceState(android.os.Bundle" target="_blank" rel="noopener">onSaveInstanceState()</a>) 被调用（没有等 <a href="https://developer.android.com/reference/android/support/v7/app/AppCompatActivity.html#onStop(" target="_blank" rel="noopener">onStop</a>) 方法被调用），派发标记 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.State.html#CREATED" target="_blank" rel="noopener">CREATED</a> 和 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.Event.html#ON_STOP" target="_blank" rel="noopener">ON_STOP</a>。这不太可能影响你的代码，但这是你需要注意的，因为这与 API level 26 及以下的 <a href="https://developer.android.com/reference/android/app/Activity.html" target="_blank" rel="noopener">Activity</a> 类中调用顺序不一致。</p>
</blockquote>
<h2 id="额外资源"><a href="#额外资源" class="headerlink" title="额外资源"></a>额外资源</h2><p>尝试生命周期组件 <a href="https://codelabs.developers.google.com/codelabs/android-lifecycles/#0" target="_blank" rel="noopener">codelab</a>，并查阅 Architecture Components <a href="https://github.com/googlesamples/android-architecture-components/tree/master/BasicSample" target="_blank" rel="noopener">BasicSample</a>。生命周期感知组件也在 <a href="https://github.com/googlesamples/android-sunflower" target="_blank" rel="noopener">Sunflower</a> demo app 中使用。</p>
]]></content>
      
        <categories>
            
            <category> Android Architecture Component </category>
            
            <category> kotlin </category>
            
            <category> DataBinding </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> architecture </tag>
            
            <tag> Android Architecture Component </tag>
            
            <tag> aac </tag>
            
            <tag> ViewModel </tag>
            
            <tag> LiveData </tag>
            
            <tag> DataBinding </tag>
            
            <tag> Lifecycles </tag>
            
            <tag> 翻译 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Architecture Component ViewModel（翻译）]]></title>
      <url>/2018/04/15/android_architecture_components_viewmodel/</url>
      <content type="html"><![CDATA[<h1 id="Android-Architecture-Component-ViewModel（翻译）"><a href="#Android-Architecture-Component-ViewModel（翻译）" class="headerlink" title="Android Architecture Component ViewModel（翻译）"></a>Android Architecture Component ViewModel（翻译）</h1><blockquote>
<p>原文：<a href="https://developer.android.com/topic/libraries/architecture/viewmodel" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/architecture/viewmodel</a></p>
</blockquote>
<p><a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 被设计为以生命周期意识的方式存储和管理 UI 相关的数据的类。<a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 类允许数据在屏幕旋转之后保存下来。</p>
<blockquote>
<p><strong>注意</strong>：要导入 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener">ViewModel</a> 到你的 Android 项目中，请查阅 <a href="https://developer.android.com/topic/libraries/architecture/adding-components.html#lifecycle" target="_blank" rel="noopener">添加 components 到你的项目中</a>。</p>
</blockquote>
<p>Android Framework 会管理 UI Controllers 的生命周期，比如 activities 和 fragment。Framework 可能会决定去销毁或重建一个 UI Controller 来响应某些完全超出你控制范围的用户操作或设备事件。</p>
<p>如果系统销毁或者重建一个 UI Controller，你存储在其中的任何瞬态 UI 相关数据都将丢失。举个例子，你的应用可能会在其中一个 activity 中包含用户列表。当 activity 因为配置改变而重建时，新的 activity 会去重新拉取用户列表数据。对于简单的数据，activity 可以使用 <a href="https://developer.android.com/reference/android/app/Activity.html#onSaveInstanceState(android.os.Bundle" target="_blank" rel="noopener"><code>onSaveInstanceState()</code></a>) 方法并在 <a href="https://developer.android.com/reference/android/app/Activity.html#onCreate(android.os.Bundle" target="_blank" rel="noopener"><code>onCreate</code></a>) 方法中从 bundle 中还原数据，但是这个方法只适用于可以序列化和反序列化的少量的数据，而不是潜在的大量数据，如用户列表或 bitmaps。</p>
<p>另一个问题，UI Controllers 频繁地去进行异步调用，它可能会需要一段时间之后才返回。UI Controller 需要管理这些调用并确保系统会在销毁之后为避免潜在的内存泄漏而把它们清理掉。这种管理需要大量的维护，并且在为配置更改重建对象的情况下，这是对资源的浪费，因为对象可能不得不重新执行它已经执行过的调用。</p>
<p>UI Controllers，比如 activities 和 fragments 主要负责 UI 数据的显示，对用户行为作出反应，或者处理与操作系统的通信，比如权限请求。要求 UI Controllers 也负责从数据库或网络加载数据会让类变得臃肿。将过多的责任分配给 UI Controller 可能会导致单个类尝试单独处理 app 的所有工作，而不是将工作委派给其他类。以这种方式为 UI Controller 分配过多的责任也会使测试变得更加困难。</p>
<p>将 view 数据所有权从 UI Controller 逻辑剥离时更容易，更高效的。</p>
<h2 id="实现一个-ViewModel"><a href="#实现一个-ViewModel" class="headerlink" title="实现一个 ViewModel"></a>实现一个 ViewModel</h2><p>对于 UI Controller，Architecture Components 提供了一个 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 帮助类，让它负责为 UI 准备数据。在配置发生变化时，<a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 对象会自动保留，所以它们持有的数据会立刻对于下一个 activity 或者 fragment 实例变得可用。举例，如果你需要在你的 app 中显示一个用户列表，确保你给 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 分配获取和持有用户列表数据的职责，而不是给 activity 或者 fragment，如下代码所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyViewModel</span> : <span class="type">ViewModel</span></span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> users: MutableLiveData&lt;List&lt;User&gt;&gt;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getUsers</span><span class="params">()</span></span>: LiveData&lt;List&lt;User&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!::users.isInitialized) &#123;</span><br><span class="line">            users = MutableLiveData()</span><br><span class="line">            loadUsers()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> users</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">loadUsers</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// Do an asynchronous operation to fetch users.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可以从 activity 中如下方式进行访问：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// Create a ViewModel the first time the system calls an activity's onCreate() method.</span></span><br><span class="line">        <span class="comment">// Re-created activities receive the same MyViewModel instance created by the first activity.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> model = ViewModelProviders.of(<span class="keyword">this</span>).<span class="keyword">get</span>(MyViewModel::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">        model.getUsers().observe(<span class="keyword">this</span>, Observer&lt;List&lt;User&gt;&gt;&#123; users -&gt;</span><br><span class="line">            <span class="comment">// update UI</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 activity 被重建，它会收到同一个 <code>MyViewModel</code> 实例，也就是第一个 activity 创建的那个。当所有拥有者 activity 结束完成，framework 会调用 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 对象的 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html#onCleared(" target="_blank" rel="noopener"><code>onCleared()</code></a>) 方法，以便于它可以清理资源。</p>
<blockquote>
<p>警告：<a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener">ViewModel</a> 一定不能引用 view，<a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener">Lifecycle</a>，或者任何可能会持有 activity context 的引用的类。</p>
</blockquote>
<p><a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 对象被设计为比生命周期比 views，<a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html" target="_blank" rel="noopener"><code>LifecycleOwners</code></a> 长。这个设计也意味着你可以更容易写覆盖 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 的测试，因为你不需要知道 view 和 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 对象。<a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 对象可以包含 <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleObserver.html" target="_blank" rel="noopener"><code>LifecycleObservers</code></a>，比如 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 对象。但是 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 对象一定不能观察生命周期感知的 observables 的改变，比如 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 对象。如果 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a>需要 <a href="https://developer.android.com/reference/android/app/Application.html" target="_blank" rel="noopener"><code>Application</code></a>，比如需要获取系统服务，它可以继承 <a href="https://developer.android.com/reference/android/arch/lifecycle/AndroidViewModel.html" target="_blank" rel="noopener"><code>AndroidViewModel</code></a> 类，它有一个接收 <a href="https://developer.android.com/reference/android/app/Application.html" target="_blank" rel="noopener"><code>Application</code></a> 的构造方法，因为 <a href="https://developer.android.com/reference/android/app/Application.html" target="_blank" rel="noopener"><code>Application</code></a> 类继承 <a href="https://developer.android.com/reference/android/content/Context.html" target="_blank" rel="noopener"><code>Context</code></a>。</p>
<h2 id="ViewModel-的生命周期"><a href="#ViewModel-的生命周期" class="headerlink" title="ViewModel 的生命周期"></a>ViewModel 的生命周期</h2><p>当获取 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 时，<a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 对象的作用域是被传入 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModelProvider.html" target="_blank" rel="noopener"><code>ViewModelProvider</code></a>的 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a>。<a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 会留在内存中，直到 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 的范围是永久消失为止：对于 activity，当它 finish 的情况下，对于 fragment，当它 detached 的情况下。</p>
<p>示图 1 展示了一个 activity 各种生命周期状态，当它经历了一个旋转，再 finish。插图也展示了 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 的整个周期，在关联的 activity 生命周期的旁边。此特定关系图说明了 activity 的状态。同样的基本状态也适用于 fragment 的生命周期。</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/48878990-e6132000-ee44-11e8-986b-269898892b39.png" width="550px/"><br></div>

<p>你通常要请求一个 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 在第一次调用 activity 对象的 <a href="https://developer.android.com/reference/android/app/Activity.html#onCreate(android.os.Bundle" target="_blank" rel="noopener"><code>onCreate</code></a>) 方法。在 activity 的生命周期中，系统可能会调用多次 <a href="https://developer.android.com/reference/android/app/Activity.html#onCreate(android.os.Bundle" target="_blank" rel="noopener"><code>onCreate</code></a>)，比如当设备屏幕旋转。<a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 会从当你第一次请求 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 一直存在，直到 activity finished 并 destroyed。</p>
<h2 id="在-fragments-之间共享数据"><a href="#在-fragments-之间共享数据" class="headerlink" title="在 fragments 之间共享数据"></a>在 fragments 之间共享数据</h2><p>在一个 activity 中多个 fragments 需要互相通信是很常见的。想象一个常见的 master-detail fragments 的情况，其中用户在一个 fragment 的列表中选择一个 item，另一个 fragment 显示所选 item 的内容。这种情况从来都不是不重要的，因为这两个 fragment 都需要定义一些接口描述，并且 owner activity 必须将两者绑定在一起。另外，两个 fragment 都必须处理另一个 fragment 是否已被创建或者可见的场景。</p>
<p>这个常见的痛点可以通过 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 对象来解决。这些 fragment 可以共享一个 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a>，使用它们的 activity scope 来处理这个通信，如下示例：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SharedViewModel</span> : <span class="type">ViewModel</span></span>() &#123;</span><br><span class="line">    <span class="keyword">val</span> selected = MutableLiveData&lt;Item&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">select</span><span class="params">(item: <span class="type">Item</span>)</span></span> &#123;</span><br><span class="line">        selected.value = item</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MasterFragment</span> : <span class="type">Fragment</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> itemSelector: Selector</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> model: SharedViewModel</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        model = activity?.run &#123;</span><br><span class="line">            ViewModelProviders.of(<span class="keyword">this</span>).<span class="keyword">get</span>(SharedViewModel::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">        &#125; ?: <span class="keyword">throw</span> Exception(<span class="string">"Invalid Activity"</span>)</span><br><span class="line">        itemSelector.setOnClickListener &#123; item -&gt;</span><br><span class="line">            <span class="comment">// Update the UI</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DetailFragment</span> : <span class="type">Fragment</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> model: SharedViewModel</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        model = activity?.run &#123;</span><br><span class="line">            ViewModelProviders.of(<span class="keyword">this</span>).<span class="keyword">get</span>(SharedViewModel::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">        &#125; ?: <span class="keyword">throw</span> Exception(<span class="string">"Invalid Activity"</span>)</span><br><span class="line">        model.selected.observe(<span class="keyword">this</span>, Observer&lt;Item&gt; &#123; item -&gt;</span><br><span class="line">            <span class="comment">// Update the UI</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要注意的是两个 fragment 在获取 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModelProvider.html" target="_blank" rel="noopener">ViewModelProvider</a> 的时候都使用 <a href="https://developer.android.com/reference/android/app/Fragment.html#getActivity(" target="_blank" rel="noopener"><code>getActivity()</code></a>)。结果，两个 fragment 都接受一个相同的 <code>SharedViewModel</code> 实力，它的范围是 activity。</p>
<p>这个方法有下面几个好处：</p>
<ul>
<li>Activity 不需要做任何事情，或者知道关于这个通信的任何事情</li>
<li>Fragments 不需要知道互相之间除了 <code>SharedViewModel</code> 契约的其它任何事情。如果其中一个 fragments 消失了，另一个照常保持工作。</li>
<li>每一个 fragments 都有它自己的生命周期，并不受到另一个生命周期的影响。如果一个 fragment replace 另外一个，UI 会继续工作，不会有问题。</li>
</ul>
<h2 id="使用-ViewModel-替换-Loaders"><a href="#使用-ViewModel-替换-Loaders" class="headerlink" title="使用 ViewModel 替换 Loaders"></a>使用 ViewModel 替换 Loaders</h2><p>Loader 类，比如 <a href="https://developer.android.com/reference/android/content/CursorLoader.html" target="_blank" rel="noopener"><code>CursorLoader</code></a>，会频繁地使用来保持 app 中的 UI 数据与数据库保持同步。你可以通过几个其它类使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 来替换 loader。使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 从数据加载操作中隔离你的 UI controller，这意味着你在这些类中拥有更少的强引用。</p>
<p>在一个使用 loaders 的常用方法，app 可能使用 <a href="https://developer.android.com/reference/android/content/CursorLoader.html" target="_blank" rel="noopener"><code>CursorLoader</code></a> 来观察数据库的内容。当数据库中的值发生改变，loader 会自动触发一个重新加在并更新 UI：</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/48879871-c41b9c80-ee48-11e8-8b26-c051ca94d272.png" width="600px/"><br></div>

<p><a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 与 <a href="https://developer.android.com/topic/libraries/architecture/room.html" target="_blank" rel="noopener">Room</a> 和 <a href="https://developer.android.com/topic/libraries/architecture/livedata.html" target="_blank" rel="noopener">LiveData</a> 一起使用来替换 loader。<a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 确保数据在设备配置改变时存活。<a href="https://developer.android.com/topic/libraries/architecture/room.html" target="_blank" rel="noopener">Room</a> 会在数据库发生改变时通知你的 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a>，然后 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener">LiveData</a> 反过来使用最新的数据更新你的 UI。</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/48880164-1c06d300-ee4a-11e8-98b1-cc4dad768914.png" width="600px/"><br></div>

<h2 id="额外资源"><a href="#额外资源" class="headerlink" title="额外资源"></a>额外资源</h2><p><a href="https://medium.com/google-developers/lifecycle-aware-data-loading-with-android-architecture-components-f95484159de4" target="_blank" rel="noopener">本文</a> 描述了如何使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 和 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 来替换 <a href="https://developer.android.com/reference/android/content/AsyncTaskLoader.html" target="_blank" rel="noopener"><code>AsyncTaskLoader</code></a>。</p>
<p>当你的数据变得越来越复杂，你可以选择用一个单独的类专门用来加载数据。<a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 的目的是为 UI Controller 封装数据，使得当设置配置改变时让数据存活。更多关于跨配置改变去加载，持久化，管理数据的详情，见 <a href="https://developer.android.com/topic/libraries/architecture/saving-states.html" target="_blank" rel="noopener">保存 UI 状态</a>。</p>
<p><a href="https://developer.android.com/topic/libraries/architecture/guide.html#fetching_data" target="_blank" rel="noopener">Android App Architecture 指南</a> 建议构建一个 repository 类来处理这些函数。</p>
<p><a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 被用在 Android 生命周期 <a href="https://codelabs.developers.google.com/codelabs/android-lifecycles/#0" target="_blank" rel="noopener">codelab</a> 和 <a href="https://github.com/googlesamples/android-sunflower" target="_blank" rel="noopener">Sunflower</a> demo app。也可以参阅 Architecture Components <a href="https://github.com/googlesamples/android-architecture-components/tree/master/BasicSample" target="_blank" rel="noopener">BasicSample</a>。</p>
]]></content>
      
        <categories>
            
            <category> Android Architecture Component </category>
            
            <category> kotlin </category>
            
            <category> DataBinding </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> architecture </tag>
            
            <tag> Android Architecture Component </tag>
            
            <tag> aac </tag>
            
            <tag> ViewModel </tag>
            
            <tag> LiveData </tag>
            
            <tag> DataBinding </tag>
            
            <tag> Lifecycles </tag>
            
            <tag> 翻译 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Architecture Component LiveData（翻译）]]></title>
      <url>/2018/04/15/android_architecture_components_livedata/</url>
      <content type="html"><![CDATA[<h1 id="Android-Architecture-Component-LiveData（翻译）"><a href="#Android-Architecture-Component-LiveData（翻译）" class="headerlink" title="Android Architecture Component LiveData（翻译）"></a>Android Architecture Component LiveData（翻译）</h1><blockquote>
<p>原文：<a href="https://developer.android.com/topic/libraries/architecture/livedata" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/architecture/livedata</a></p>
</blockquote>
<p><a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 是一个可观察数据的持有类。不像常规的 observable，LiveData 是生命周期感知的，这意味着它关心其它 app 组件的生命周期，比如 activities，fragments，或者 services。这种感知可确保 LiveData 仅更新处于活动生命周期状态的 app 组件 observers。</p>
<blockquote>
<p>要导入 LiveData 到你的 Android 项目中，见<a href="https://developer.android.com/topic/libraries/architecture/adding-components.html#lifecycle" target="_blank" rel="noopener">增加 Components 到你的项目中</a></p>
</blockquote>
<p>LiveData 认为，如果观察者的生命周期处于 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.State.html#STARTED" target="_blank" rel="noopener">STARTED</a> 或 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.State.html#RESUMED" target="_blank" rel="noopener">RESUME</a> 状态，则该观察者 (以 <a href="https://developer.android.com/reference/android/arch/lifecycle/Observer.html" target="_blank" rel="noopener">Observer</a> 类呈现) 处于活动状态。LiveData 只通知活动状态的 observers 进行更新。注册到 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 的非活动状态的 observers 不会接收到改变通知。</p>
<p>你可以注册配对一个 observer 和实现了 <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html" target="_blank" rel="noopener"><code>LifecycleOwner</code></a> 接口的对象。这种关系允许在相应 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 对象进入到 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.State.html#DESTROYED" target="_blank" rel="noopener"><code>DESTROYED</code></a> 的时候删除相应的 observer。这对 activities 和 fragments 特别有帮助，因为它们可以安全地观察 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 对象，并且不需要去担心泄漏 —— activites 和 framgents 在销毁时，它们会立即被取消订阅。</p>
<p>关于如何使用 LiveData 的更多详情，见 <a href="https://developer.android.com/topic/libraries/architecture/livedata#work_livedata" target="_blank" rel="noopener">使用 LiveData 对象</a>。</p>
<h2 id="使用-LiveData-的优势"><a href="#使用-LiveData-的优势" class="headerlink" title="使用 LiveData 的优势"></a>使用 LiveData 的优势</h2><p>使用 LiveData 提供了以下优势：</p>
<ul>
<li><p>确保您的 UI 与您的数据状态相匹配</p>
<p>LiveData 遵循观察者模式。当生命周期状态改变时，LiveData 通知 <a href="https://developer.android.com/reference/android/arch/lifecycle/Observer.html" target="_blank" rel="noopener"><code>Observer</code></a> 对象。你可以巩固你的代码在这些 observer 对象中更新 UI。Observer 在每次有变化是更新 UI，而不只是在每次 app 数据变化时更新 UI。</p>
</li>
<li><p>没有内存泄漏</p>
<p>Observer 绑定到 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 对象，并在其关联的生命周期销毁后进行清理。</p>
</li>
<li><p>没有因为 activities 停止导致的崩溃</p>
<p>如果 Observer 的生命周期处于非活动状态，例如在后台堆栈中的活动的情况下，则它不会接收任何 LiveData 事件。</p>
</li>
<li><p>无需手动的生命周期处理</p>
<p>UI 组件只是观察相关数据，不会停止或恢复观察。LiveData 会自动管理所有这些，因为它在观察时了解相关的生命周期状态更改。</p>
</li>
<li><p>始终是最新的数据</p>
<p>如果生命周期变为非活动状态，它将在再次处于活动状态时接收最新数据。例如，后台的活动在返回到前台后立即接收最新数据。</p>
</li>
<li><p>正确的配置更改</p>
<p>如果由于配置更改，比如设备旋转，而重新创建 activity 或 fragment，它将立即接收最新的可用数据。</p>
</li>
<li><p>共享资源</p>
<p>您可以使用单例模式扩展 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 对象来包装系统服务，以便在 app 中共享这些服务。<code>LiveData</code> 对象连接到系统服务一次，然后任何需要资源的观察者都可以只监听 <code>LiveData</code> 对象。有关详情，请参阅 <a href="https://developer.android.com/topic/libraries/architecture/livedata#extend_livedata" target="_blank" rel="noopener">扩展 LiveData</a>。</p>
</li>
</ul>
<h2 id="使用-LiveData-对象"><a href="#使用-LiveData-对象" class="headerlink" title="使用 LiveData 对象"></a>使用 LiveData 对象</h2><p>跟随以下几步来使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 对象：</p>
<ol>
<li>创建一个 <code>LiveData</code> 的实例来持有某个类型的数据。这通常是在你的 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 类中做的。</li>
<li>创建一个定义了 <a href="https://developer.android.com/reference/android/arch/lifecycle/Observer.html#onChanged(T" target="_blank" rel="noopener"><code>onChanged()</code></a>) 方法的 <a href="https://developer.android.com/reference/android/arch/lifecycle/Observer.html" target="_blank" rel="noopener"><code>Observer</code></a> 对象，它会在 <code>LiveData</code> 对象持有的数据发生改变时进行控制处理。你通常要在 UI controller 中创建 <code>Observer</code> 对象，比如在 activity 或者 fragment。</li>
<li>使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html#observe(android.arch.lifecycle.LifecycleOwner,%0Aandroid.arch.lifecycle.Observer%3CT%3E" target="_blank" rel="noopener"><code>observe()</code></a>) 方法来把 <code>Observer</code> 对象 attach 到 <code>LiveData</code> 对象上。<code>observe()</code> 方法接收一个 <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html" target="_blank" rel="noopener"><code>LifecycleOwner</code></a> 对象。这将 <code>Observer</code> 对象订阅到 <code>LiveData</code> 对象上，以便它收到改变的通知。你通常会 attach <code>Observer</code> 到 UI Controller 上，比如 activity 或者 fragment。</li>
</ol>
<blockquote>
<p>你可以使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html#observeForever(android.arch.lifecycle.Observer%3CT%3E" target="_blank" rel="noopener">observeForever(Observer)</a>) 方法以不关联一个 <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html" target="_blank" rel="noopener">LifecycleOwner</a> 对象的方式来注册一个 observer。在这种情况下，observer 被认为始终处于活动状态，因此始终会收到有关改变的通知。你可以使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html#removeObserver(android.arch.lifecycle.Observer%3CT%3E" target="_blank" rel="noopener">removeObserver(Observer)</a>) 方法来移除这些 observer 的调用。</p>
</blockquote>
<p>当你更新存储在 <code>LiveData</code> 对象的值的时候，它会触发所有注册的 observers 只要关联的 <code>LifecycleOwner</code> 的状态是 active 的。</p>
<p>LiveData 允许 UI Controller 的 observer 去订阅更新。当持有数据的 <code>LiveData</code> 对象更新时，UI 会在响应中自动更新。</p>
<h3 id="创建-LiveData-对象"><a href="#创建-LiveData-对象" class="headerlink" title="创建 LiveData 对象"></a>创建 LiveData 对象</h3><p>LiveData 是一个可用于任何数据的一个包装，包括实现了 <a href="https://developer.android.com/reference/java/util/Collections.html" target="_blank" rel="noopener"><code>Collections</code></a> 的对象，比如 <a href="https://developer.android.com/reference/java/util/List.html" target="_blank" rel="noopener"><code>List</code></a>。一个 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 对象通常存储在 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 对象中，并且通过 getter 方法访问，就像下面演示的那样：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NameViewModel</span> : <span class="type">ViewModel</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a LiveData with a String</span></span><br><span class="line">    <span class="keyword">val</span> currentName: MutableLiveData&lt;String&gt; <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        MutableLiveData&lt;String&gt;()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rest of the ViewModel...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最初，<code>LiveData</code> 对象中的数据没有被设置。</p>
<blockquote>
<p>注意：确保存储的更新 UI 的 <strong>LiveData</strong> 对象是在 <strong>ViewModel</strong> 对象中，而不是 activity 或者 fragment，原因如下：</p>
<ul>
<li>避免臃肿的 activities 和 fragments。现在这些 UI Controllers 是负责展示数据，而不持有数据的状态。</li>
<li>要从特定的 activity 或者 fragment 实例中解耦 <strong>LiveData</strong> 实例，并且允许 <strong>LiveData</strong> 对象在配置更改后继续生存。</li>
</ul>
</blockquote>
<p>你可以在 <a href="https://developer.android.com/topic/libraries/architecture/viewmodel.html" target="_blank" rel="noopener">ViewModel 指南</a> 中了解更多关于 <code>ViewModel</code> 类型使用的好处。</p>
<h3 id="观察-LiveData-对象"><a href="#观察-LiveData-对象" class="headerlink" title="观察 LiveData 对象"></a>观察 LiveData 对象</h3><p>在大多情况下，一个 app 组件的 <a href="https://developer.android.com/reference/android/app/Activity.html#onCreate(android.os.Bundle" target="_blank" rel="noopener"><code>onCreate()</code></a>) 方法是开始观察 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 对象比较正确的地方，愿意如下：</p>
<ul>
<li>可以确保系统不会在 activity 或者 fragment 的 <a href="https://developer.android.com/reference/android/app/Activity.html#onResume(" target="_blank" rel="noopener">onResume()</a>) 有过多的调用。</li>
<li>可以确保 activity 或者 fragment 状态变为 active 时有数据可以尽快显示出来。一旦一个 app 组件处于 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.State.html#STARTED" target="_blank" rel="noopener">STARTED</a>，它会从它观察中的 <code>LiveData</code> 对象接收到最近的数据。这只会在观察了 <code>LiveData</code> 时才会发生这种情况。</li>
</ul>
<p>通常情况下，LiveData 仅在数据更改时提供更新，并且仅向 active 状态的 observer 提供更新。这个行为的一个例外是，observer 在从 inactive 状态更改为 active 状态时也会收到更新。此外，observer 第二次从 inactive 到 active 状态，只有自从上次变成 active 为止数据改变了，它才会接收到更新。</p>
<p>下面的例子说明了如何开始观察一个 <code>LiveData</code> 对象：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NameActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mModel: NameViewModel</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Other code to setup the activity...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get the ViewModel.</span></span><br><span class="line">        mModel = ViewModelProviders.of(<span class="keyword">this</span>).<span class="keyword">get</span>(NameViewModel::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create the observer which updates the UI.</span></span><br><span class="line">        <span class="keyword">val</span> nameObserver = Observer&lt;String&gt; &#123; newName -&gt;</span><br><span class="line">            <span class="comment">// Update the UI, in this case, a TextView.</span></span><br><span class="line">            mNameTextView.text = newName</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Observe the LiveData, passing in this activity as the LifecycleOwner and the observer.</span></span><br><span class="line">        mModel.currentName.observe(<span class="keyword">this</span>, nameObserver)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>nameObserver</code> 作为参数传入的 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html#observe(android.arch.lifecycle.LifecycleOwner,%0Aandroid.arch.lifecycle.Observer%3CT%3E" target="_blank" rel="noopener"><code>observe()</code></a>) 被调用之后，<a href="https://developer.android.com/reference/android/arch/lifecycle/Observer.html#onChanged(T" target="_blank" rel="noopener"><code>onChanged()</code></a>) 立刻就会被调用并提供存储在 <code>mCurrentName</code> 中最近的值。如果 <code>LiveData</code> 对象 <code>mCurrentName</code> 中没有被设置值，则 <code>onChanged()</code> 不会被调用。</p>
<h3 id="更新-LiveData-对象"><a href="#更新-LiveData-对象" class="headerlink" title="更新 LiveData 对象"></a>更新 LiveData 对象</h3><p>LiveData 没有公开可用的方法用来存储更新存储的数据。<a href="https://developer.android.com/reference/android/arch/lifecycle/MutableLiveData.html" target="_blank" rel="noopener"><code>MutableLiveData</code></a> 类暴露公开了 <a href="https://developer.android.com/reference/android/arch/lifecycle/MutableLiveData.html#setValue(T" target="_blank" rel="noopener"><code>setValue(T)</code></a>) 和 <a href="https://developer.android.com/reference/android/arch/lifecycle/MutableLiveData.html#postValue(T" target="_blank" rel="noopener"><code>postValue(T)</code></a>) 方法，如果你需要编辑存储在 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 对象中的值，你必须要使用它们。通常，<code>MutableLiveData</code> 被在 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 中被使用，<code>ViewModel</code> 只暴露不可编辑的 <code>LiveData</code> 对象给 observers。</p>
<p>当你设置了 observer 关系之后，你可以更新 <code>LiveData</code> 对象中的值，就如下面例子展示的，当用户按下按钮时触发所有 observers：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mButton.setOnClickListener &#123;</span><br><span class="line">    <span class="keyword">val</span> anotherName = <span class="string">"John Doe"</span></span><br><span class="line">    mModel.currentName.setValue(anotherName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在例子中调用 <code>setValue(T)</code>，observers 调用它们的 <a href="https://developer.android.com/reference/android/arch/lifecycle/Observer.html#onChanged(T" target="_blank" rel="noopener"><code>onChanged()</code></a>) 方法，值为 <code>John Doe</code>。例子展示了一个按钮被按下，但由于各种原因，可以调用 <code>setValue()</code> 或 <code>postValue()</code> 来更新 <code>mName</code>，包括在网络请求的 response 中，或者数据库加载完成；在所有情况中，调用 <code>setValue()</code> 和 <code>postValue()</code> 会触发 observers 并更新 UI。</p>
<blockquote>
<p>注意：你必须在主线程调用 <a href="https://developer.android.com/reference/android/arch/lifecycle/MutableLiveData.html#setValue(T" target="_blank" rel="noopener">setValue(T)</a>) 更新 <strong>LiveData</strong> 对象。如果代码执行在一个工作线程，你可以使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/MutableLiveData.html#postValue(T" target="_blank" rel="noopener">postValue(T)</a>) 方法来更新 <strong>LiveData</strong> 对象。</p>
</blockquote>
<h3 id="结合-Room-使用-LiveData"><a href="#结合-Room-使用-LiveData" class="headerlink" title="结合 Room 使用 LiveData"></a>结合 Room 使用 LiveData</h3><p>持久化库 <a href="https://developer.android.com/training/data-storage/room/index.html" target="_blank" rel="noopener">Room</a> 支持 observable 查询，它返回 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 对象。Observable 查询被作为数据访问对象（DAO）的一部分被编写。</p>
<p>Room 生成所有必要的代码来在数据库更新时更新 <code>LiveData</code> 对象。如果需要，被生成的代码在后台线程运行异步查询。这个模式可用于使 UI 中显示的数据与存储在数据库中的数据保持同步。你可以在 <a href="https://developer.android.com/topic/libraries/architecture/room.html" target="_blank" rel="noopener">Room 持久化库指南</a> 了解更多关于 Room 和 DAOs。</p>
<h3 id="扩展-LiveData"><a href="#扩展-LiveData" class="headerlink" title="扩展 LiveData"></a>扩展 LiveData</h3><p>如果 observer 的生命周期是 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.State.html#STARTED" target="_blank" rel="noopener"><code>STARTED</code></a> 或者 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.State.html#RESUMED" target="_blank" rel="noopener"><code>RESUMED</code></a> 状态，LiveData 则认为 observer 处于 active 状态，下面的代码展示了如何扩展继承 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 类：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StockLiveData</span></span>(symbol: String) : LiveData&lt;BigDecimal&gt;() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mStockManager = StockManager(symbol)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mListener = &#123; price: BigDecimal -&gt;</span><br><span class="line">        value = price</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActive</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mStockManager.requestPriceUpdates(mListener)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onInactive</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mStockManager.removeUpdates(mListener)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上述例子的 price listener 的实现中包含了以下几个重要的方法：</p>
<ul>
<li><a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html#onActive(" target="_blank" rel="noopener"><code>onActive()</code></a>) 方法在 <code>LiveData</code> 对象有一个 active observer 的时候被调用。这意味着你需要在这个方法中开始观察 stock price 的更新。</li>
<li><a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html#onInactive(" target="_blank" rel="noopener"><code>onInactive()</code></a>) 方法在 <code>LiveData</code> 对象没有任何一个 active observer 的时候被调用。因为没有 observers 正在监听，所以没有理由与 <code>StockManager</code> 服务保持连接。</li>
<li><a href="https://developer.android.com/reference/android/arch/lifecycle/MutableLiveData.html#setValue(T" target="_blank" rel="noopener"><code>setValue(T)</code></a>) 方法更新 <code>LiveData</code> 实例的值，并且通知任何 active 状态的 observers 关于这次改变。</li>
</ul>
<p>你可以如下使用 <code>StockLiveData</code> 类：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityCreated</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onActivityCreated(savedInstanceState)</span><br><span class="line">    <span class="keyword">val</span> myPriceListener: LiveData&lt;BigDecimal&gt; = ...</span><br><span class="line">    myPriceListener.observe(<span class="keyword">this</span>, Observer&lt;BigDecimal&gt; &#123; price: BigDecimal? -&gt;</span><br><span class="line">        <span class="comment">// Update the UI.</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html#observe(android.arch.lifecycle.LifecycleOwner,%0Aandroid.arch.lifecycle.Observer%3CT%3E" target="_blank" rel="noopener"><code>observe()</code></a>) 方法传入 fragment 作为第一个参数，它是 <a href="https://developer.android.com/reference/android/arch/lifecycle/LifecycleOwner.html" target="_blank" rel="noopener"><code>LifecycleOwner</code></a> 的一个实例。这样做表示此 observer 绑定到与所有者关联的 <a href="https://developer.android.com/reference/android/arch/lifecycle/Lifecycle.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 对象，意味着：</p>
<ul>
<li>如果 <code>Lifecycle</code> 对象不处于 active 状态了，那么就算值改变了 observer 也不会回调。</li>
<li>在 <code>Lifecycle</code> 对象被销毁了，observer 会自动被移除。</li>
</ul>
<p><code>LiveData</code> 对象是生命周期感知的事实，这意味着你可以在多个 activity，fragment，service 之间共享它们。为了保持例子简单，你可以把 <code>LiveData</code> 类作为一个单例实现，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StockLiveData</span></span>(symbol: String) : LiveData&lt;BigDecimal&gt;() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mStockManager: StockManager = StockManager(symbol)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mListener = &#123; price: BigDecimal -&gt;</span><br><span class="line">        value = price</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActive</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mStockManager.requestPriceUpdates(mListener)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onInactive</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mStockManager.removeUpdates(mListener)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> sInstance: StockLiveData</span><br><span class="line"></span><br><span class="line">        <span class="meta">@MainThread</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(symbol: <span class="type">String</span>)</span></span>: StockLiveData &#123;</span><br><span class="line">            sInstance = <span class="keyword">if</span> (::sInstance.isInitialized) sInstance <span class="keyword">else</span> StockLiveData(symbol)</span><br><span class="line">            <span class="keyword">return</span> sInstance</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，你可以在 fragment 中使用它，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFragment</span> : <span class="type">Fragment</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityCreated</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        StockLiveData.<span class="keyword">get</span>(symbol).observe(<span class="keyword">this</span>, Observer&lt;BigDecimal&gt; &#123; price: BigDecimal? -&gt;</span><br><span class="line">            <span class="comment">// Update the UI.</span></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>多个 fragments 和 activities 可以观察这个 <code>MyPriceListener</code> 实例。LiveData 只会在它们中的一个或多个是可见和 active 的才会连接到系统服务。</p>
<h2 id="转换-LiveData"><a href="#转换-LiveData" class="headerlink" title="转换 LiveData"></a>转换 LiveData</h2><p>储存在 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 的数据在派发给 observers 之前，你可能需要做一些改变，或者你可能需要基于另一个值返回一个不同的 <code>LiveData</code> 实例。<a href="https://developer.android.com/reference/android/arch/lifecycle/package-summary.html" target="_blank" rel="noopener"><code>Lifecycle</code></a> 包提供了 <a href="https://developer.android.com/reference/android/arch/lifecycle/Transformations.html" target="_blank" rel="noopener"><code>Transformations</code></a> 类，它包含了一些帮助的方法来支持这些场景。</p>
<p><a href="https://developer.android.com/reference/android/arch/lifecycle/Transformations.html#map(android.arch.lifecycle.LiveData%3CX%3E,%20android.arch.core.util.Function%3CX,%20Y%3E" target="_blank" rel="noopener"><code>Transformations.map()</code></a>)</p>
<p>对存储在 <code>LiveData</code> 对象中的值执行函数，并将结果发送到下游。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> userLiveData: LiveData&lt;User&gt; = UserLiveData()</span><br><span class="line"><span class="keyword">val</span> userName: LiveData&lt;String&gt; = Transformations.map(userLiveData) &#123;</span><br><span class="line">    user -&gt; <span class="string">"<span class="subst">$&#123;user.name&#125;</span> <span class="subst">$&#123;user.lastName&#125;</span>"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://developer.android.com/reference/android/arch/lifecycle/Transformations.html#switchMap(android.arch.lifecycle.LiveData%3CX%3E,%20android.arch.core.util.Function%3CX,%20android.arch.lifecycle.LiveData%3CY%3E%3E" target="_blank" rel="noopener"><code>Transformations.switchMap()</code></a>)</p>
<p>类似于 <code>map()</code>，对存储在 <code>LiveData</code> 对象中的值执行函数，并在下游展开和调度结果。传入 <code>switchMap()</code> 的函数必须返回一个 <code>LiveData</code> 对象，如下面例子所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getUser</span><span class="params">(id: <span class="type">String</span>)</span></span>: LiveData&lt;User&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">val</span> userId: LiveData&lt;String&gt; = ...</span><br><span class="line"><span class="keyword">val</span> user = Transformations.switchMap(userId) &#123; id -&gt; getUser(id) &#125;</span><br></pre></td></tr></table></figure>
<p>你可以使用转换方法在 observer 的整个生命周期中传输信息。transformations 不会被计算，除非一个 observer 正在监听返回的 <code>LiveData</code> 对象。因为 transformations 是懒计算的，与生命周期相关的行为被隐式传递，而不需要额外的显式调用或依赖。</p>
<p>如果你觉得你在 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 对象中需要一个 <code>Lifecycle</code> 对象，transformation 是一个更好的解决方案。举个例子，假设你有一个 UI 组件，它接收一个 address 并返回一个 该 address 的 postal code。你可以针对该组件实现单纯的 <code>ViewModel</code>，如下代码所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyViewModel</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> repository: PostalCodeRepository) : ViewModel() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPostalCode</span><span class="params">(address: <span class="type">String</span>)</span></span>: LiveData&lt;String&gt; &#123;</span><br><span class="line">        <span class="comment">// DON'T DO THIS</span></span><br><span class="line">        <span class="keyword">return</span> repository.getPostCode(address)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么当每次调用 <code>getPostalCode()</code>时，UI 组件需要从上一个 <code>LiveData</code> 对象反注册，并注册到新的实例。另外，如果 UI component 被重建，它会触发另一个 <code>repository.getPostCode()</code> 调用而不是使用之前调用的结果。</p>
<p>对此你实现 postal code 查找作为 address 输入的转换，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyViewModel</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> repository: PostalCodeRepository) : ViewModel() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> addressInput = MutableLiveData&lt;String&gt;()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> postalCode: LiveData&lt;String&gt; =</span><br><span class="line">            Transformations.switchMap(addressInput) &#123; address -&gt; repository.getPostCode(address) &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setInput</span><span class="params">(address: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        addressInput.value = address</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个例子中，<code>postalCode</code> field 是 <code>public</code> 和 <code>final</code> 的，因为这个 field 永远不会改变。<code>postalCode</code> 这个 field 被定义为 <code>addressInput</code> 的一个转换，这意味着 <code>repository.getPostCode()</code> 在 <code>addressInput</code> 改变时被调用。在 <code>repository.getPostCode()</code> 被调用的时候，如果有一个 active 的 observer 则是真的，如果没有 active 的 observer，在添加 observer 之前，不进行任何计算。</p>
<p>这个机制允许低级别的 app 去创建按需懒计算的 <code>LiveData</code> 对象。一个 <code>ViewModel</code> 对象可以轻松地获取 <code>LiveData</code> 对象的引用，然后在其基础上定义转换规则。</p>
<h3 id="创建新的转换"><a href="#创建新的转换" class="headerlink" title="创建新的转换"></a>创建新的转换</h3><p>在你的应用中可能有十几个不同且有用的特定转换，但默认情况下是不提供的。要实现你自己的 transformation 你可以使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/MediatorLiveData.html" target="_blank" rel="noopener"><code>MediatorLiveData</code></a> 类，它监听其它 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 对象并处理它们发出的事件。<code>MediatorLiveData</code> 正确地将其状态传送到源 <code>LiveData</code> 对象。学习关于这个模式的详情，查看 <a href="https://developer.android.com/reference/android/arch/lifecycle/Transformations.html" target="_blank" rel="noopener"><code>Transformations</code></a> 类的参考文档。</p>
<h2 id="合并多个-LiveData-源"><a href="#合并多个-LiveData-源" class="headerlink" title="合并多个 LiveData 源"></a>合并多个 LiveData 源</h2><p><a href="https://developer.android.com/reference/android/arch/lifecycle/MediatorLiveData.html" target="_blank" rel="noopener"><code>MediatorLiveData</code></a> 是 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html" target="_blank" rel="noopener"><code>LiveData</code></a> 的一个子类，它允许你去合并多个 LiveData 源。 每当任何原始 LiveData 源对象更改时，<code>MediatorLiveData</code> 对象的 observers 会被触发。</p>
<p>举个例子，如果你在你的 UI 有一个 <code>LiveData</code> 对象，它可以从本地数据库和网络中更新，然后你可以增加下面几个源到 <code>MediatorLiveData</code> 对象：</p>
<ul>
<li>一个 <code>LiveData</code> 对象，与存储在数据库中的数据相关联。</li>
<li>一个 <code>LiveData</code> 对象，于访问网络的数据相关联。</li>
</ul>
<p>你的 activity 只需要去观察 <code>MediatorLiveData</code> 对象来从上面两种源中接收更新。有详细示例，见 <a href="">App Architecture 指南</a> 的 <a href="https://developer.android.com/topic/libraries/architecture/guide.html#addendum" target="_blank" rel="noopener">附录: 公开网络状态</a> 栏。</p>
<h2 id="额外资源"><a href="#额外资源" class="headerlink" title="额外资源"></a>额外资源</h2><p><code>LiveData</code> 被使用在了 <a href="https://github.com/googlesamples/android-sunflower" target="_blank" rel="noopener">Sunflower</a> 的 demo app 中。</p>
<p>也可以查看 Architecture Components <a href="https://github.com/googlesamples/android-architecture-components/tree/master/BasicSample" target="_blank" rel="noopener">BasicSample</a>。</p>
<p>了解更多详情关于与 <a href="https://developer.android.com/training/snackbar" target="_blank" rel="noopener">Snackbar</a> Message，navigation events，和 other events 一起使用 <code>LiveData</code>，查看<a href="https://medium.com/google-developers/livedata-with-snackbar-navigation-and-other-events-the-singleliveevent-case-ac2622673150" target="_blank" rel="noopener">本文</a>。</p>
]]></content>
      
        <categories>
            
            <category> Android Architecture Component </category>
            
            <category> kotlin </category>
            
            <category> DataBinding </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> architecture </tag>
            
            <tag> Android Architecture Component </tag>
            
            <tag> aac </tag>
            
            <tag> ViewModel </tag>
            
            <tag> LiveData </tag>
            
            <tag> DataBinding </tag>
            
            <tag> Lifecycles </tag>
            
            <tag> 翻译 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Architecture Component DataBinding -- 双向绑定（翻译）]]></title>
      <url>/2018/04/15/android_architecture_components_binding_two_way/</url>
      <content type="html"><![CDATA[<h1 id="Android-Architecture-Component-DataBinding-–-双向绑定（翻译）"><a href="#Android-Architecture-Component-DataBinding-–-双向绑定（翻译）" class="headerlink" title="Android Architecture Component DataBinding – 双向绑定（翻译）"></a>Android Architecture Component DataBinding – 双向绑定（翻译）</h1><blockquote>
<p>原文：<a href="https://developer.android.com/topic/libraries/data-binding/two-way" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/data-binding/two-way</a></p>
</blockquote>
<p>要使用双向数据绑定，你可以在一个属性上设置一个值，并设置一个监听器来响应这个属性的变化：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;CheckBox</span><br><span class="line">    android:id=<span class="string">"@+id/rememberMeCheckBox"</span></span><br><span class="line">    android:checked=<span class="string">"@&#123;viewmodel.rememberMe&#125;"</span></span><br><span class="line">    android:onCheckedChanged=<span class="string">"@&#123;viewmodel.rememberMeChanged&#125;"</span></span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<p>双向绑定为这个过程提供了一个捷径：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;CheckBox</span><br><span class="line">    android:id=<span class="string">"@+id/rememberMeCheckBox"</span></span><br><span class="line">    android:checked=<span class="string">"@=&#123;viewmodel.rememberMe&#125;"</span></span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<p>使用 <code>@={}</code> 记号，重点是里面的 “=” 号，接收对属性的数据更改，并同时监听用户更新。</p>
<p>为了对返回数据中的变化做出反应，你可以让你的 layout variable 是一个 <code>Observable</code> 的实现，通常是 <a href="https://developer.android.com/reference/android/databinding/BaseObservable" target="_blank" rel="noopener"><code>BaseObservable</code></a>，并使用 <a href="https://developer.android.com/reference/android/databinding/Bindable" target="_blank" rel="noopener"><code>@Bindable</code></a> 注解，如下代码片段：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginViewModel</span> : <span class="type">BaseObservable &#123;</span></span></span><br><span class="line">    <span class="comment">// val data = ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bindable</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getRememberMe</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">data</span>.rememberMe</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setRememberMe</span><span class="params">(value: <span class="type">Boolean</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// Avoids infinite loops.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">data</span>.rememberMe != value) &#123;</span><br><span class="line">            <span class="keyword">data</span>.rememberMe = value</span><br><span class="line"></span><br><span class="line">            <span class="comment">// React to the change.</span></span><br><span class="line">            saveData()</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Notify observers of a new value.</span></span><br><span class="line">            notifyPropertyChanged(BR.remember_me)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为 bindable 属性的 getter 方法是 <code>getRememberMe()</code>，则相应的 setter 方法自动使用 <code>setRememberMe()</code> 这个名字。</p>
<p>更多关于 <code>BaseObservable</code> 和 <code>@Bindable</code> 的信息，见 <a href="https://developer.android.com/topic/libraries/data-binding/observability" target="_blank" rel="noopener">使用可观察的数据对象</a>。</p>
<h2 id="自定义属性实现双向绑定"><a href="#自定义属性实现双向绑定" class="headerlink" title="自定义属性实现双向绑定"></a>自定义属性实现双向绑定</h2><p>平台提供了 <a href="https://developer.android.com/topic/libraries/data-binding/two-way#two-way-attributes" target="_blank" rel="noopener">最常用的双向绑定属性</a> 双向绑定实现和监听器改变，你可以作为你 app 的一部分去使用。如果你想使用自定义属性的双向绑定，你需要使用 <a href="https://developer.android.com/reference/android/databinding/InverseBindingAdapter" target="_blank" rel="noopener"><code>@InverseBindingAdapter</code></a> 和 <a href="https://developer.android.com/reference/android/databinding/InverseBindingMethod" target="_blank" rel="noopener"><code>@InverseBindingMethod</code></a> 注解。</p>
<p>举个例子，如果你想在名为 <code>MyView</code> 的自定义 view 上面开启 <code>&quot;time&quot;</code> 属性的双向绑定，通过以下几步完成：</p>
<ol>
<li><p>在设置初始值的方法上添加注解，并在值使用 <code>@BindingAdapter</code> 更改时进行更新：</p>
 <figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">"time"</span>)</span></span><br><span class="line"><span class="meta">@JvmStatic</span> <span class="function"><span class="keyword">fun</span> <span class="title">setTime</span><span class="params">(view: <span class="type">MyView</span>, newValue: <span class="type">Time</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 这里很重要，要打破潜在的死循环</span></span><br><span class="line">    <span class="keyword">if</span> (view.time != newValue) &#123;</span><br><span class="line">        view.time = newValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在读取 view 值的方法上添加 <code>@InverseBindingAdapter</code> 注解：</p>
 <figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@InverseBindingAdapter(<span class="meta-string">"time"</span>)</span></span><br><span class="line"><span class="meta">@JvmStatic</span> <span class="function"><span class="keyword">fun</span> <span class="title">getTime</span><span class="params">(view: <span class="type">MyView</span>)</span></span> : Time &#123;</span><br><span class="line">    <span class="keyword">return</span> view.getTime()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>此时，Data Binding 知道在数据更改时要执行的操作（它会调用加了 <a href="https://developer.android.com/reference/android/databinding/BindingAdapter" target="_blank" rel="noopener"><code>@BindingAdapter</code></a> 注解的方法）和当属性发生改变时（它会调用加了<a href="https://developer.android.com/reference/android/databinding/InverseBindingListener" target="_blank" rel="noopener"><code>InverseBindingListener</code></a>注解的方法）。但是，它不知道属性何时或如何被更改。</p>
<p>为此，你需要在 view 上面设置监听器。它可以自定义监听器，关联到你自定义的 view，或者它是一般事件，比如失去焦点，文本的变化等。在方法上增加一个 <code>@BindingAdapter</code> 注解，为属性设置一个改变的监听器：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">"app:timeAttrChanged"</span>)</span></span><br><span class="line"><span class="meta">@JvmStatic</span> <span class="function"><span class="keyword">fun</span> <span class="title">setListeners</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        view: <span class="type">MyView</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        attrChange: <span class="type">InverseBindingListener</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Set a listener for click, focus, touch, etc.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个监听器包含一个 <code>InverseBindingListener</code> 作为参数。你使用 <code>InverseBindingListener</code> 来告诉 data binding 系统属性被修改了。系统会开始调用加了 <code>@InverseBindingAdapter</code> 注解的方法，等等。</p>
<blockquote>
<p>每一个双向绑定生成了一个<strong>合成的事件属性</strong>。这个属性与基属性具有一个相同的名字，但是它包含了一个 “<strong>AttrChanged</strong>” 的后缀。合成事件属性允许库去创建一个使用 <strong>@BindingAdapter</strong> 注解的方法，以便将事件监听器与 View 的相应的实例相关联。</p>
</blockquote>
<p>在实践中，这个监听器中包含了一些不平凡的逻辑，包括单向数据绑定的监听器。举例见 text attribute change 的 adapter，<a href="https://android.googlesource.com/platform/frameworks/data-binding/+/3b920788e90bb0abe615a5d5c899915f0014444b/extensions/baseAdapters/src/main/java/android/databinding/adapters/TextViewBindingAdapter.java#344" target="_blank" rel="noopener">TextViewBindingAdapter</a></p>
<h2 id="转换器"><a href="#转换器" class="headerlink" title="转换器"></a>转换器</h2><p>如果绑定到一个 <a href="https://developer.android.com/reference/android/view/View" target="_blank" rel="noopener"><code>View</code></a> 的变量需要在展示出来之前被格式化，转换，某种方法修改，它可能需要一个 <code>Converter</code> 对象。</p>
<p>举个例子，用一个 <code>EditText</code> 对象展示一个日期：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/birth_date"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">"@=&#123;Converter.dateToString(viewmodel.birthDate)&#125;"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>viewmodel.birthDate</code> 属性包含了一个类型 <code>Long</code> 的值，所以它需要通过一个抓暖气来格式化。</p>
<p>因为正在使用双向表达式，所以还需要一个逆转换器，让库知道如何将用户提供的字符串转换回支持数据类型，在这里是 <code>Long</code>。这个过程是通过将 <a href="https://developer.android.com/reference/android/databinding/InverseMethod" target="_blank" rel="noopener"><code>@InverseMethod</code></a> 注解添加到其中一个转换器中，并让这个批注引用逆转换器来完成的。此配置的示例出现在下面的代码段中：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> Converter &#123;</span><br><span class="line">    <span class="meta">@InverseMethod(<span class="meta-string">"stringToDate"</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">dateToString</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        view: <span class="type">EditText</span>, oldValue: <span class="type">Long</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        value: <span class="type">Long</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>: String &#123;</span><br><span class="line">        <span class="comment">// Converts long to String.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">stringToDate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        view: <span class="type">EditText</span>, oldValue: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        value: <span class="type">String</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>: <span class="built_in">Long</span> &#123;</span><br><span class="line">        <span class="comment">// Converts String to long.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用双向绑定的死循环"><a href="#使用双向绑定的死循环" class="headerlink" title="使用双向绑定的死循环"></a>使用双向绑定的死循环</h2><p>使用双向数据绑定时，注意不要引入死循环。当用户改变一个属性，<code>@InverseBindingAdapter</code> 注解的方法会被调用，并将该值分配给后端属性。这反过来又会调用使用 <code>@BindingAdapter</code> 注解的方法，这将触发对使用 <code>@InverseBindingAdapter</code> 注解的方法的另一个调用，等等。</p>
<p>因为这个原因，在 <code>@BindingAdapter</code> 注解的方法中通过对比新旧的值来打破潜在可能的死循环是很重要的。</p>
<h2 id="双向属性"><a href="#双向属性" class="headerlink" title="双向属性"></a>双向属性</h2><p>当你使用以下表中属性时，平台提供了内置的双向数据绑定。有关平台如何提供此支持的详细信息，请参阅相应 binding adapters 的实现:</p>
<table>
<thead>
<tr>
<th>类</th>
<th>属性</th>
<th>Binding Adapter</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/AdapterView" target="_blank" rel="noopener">AdapterView</a></td>
<td>android:selectedItemPosition<br>android:selection</td>
<td><a href="https://android.googlesource.com/platform/frameworks/data-binding/+/3b920788e90bb0abe615a5d5c899915f0014444b/extensions/baseAdapters/src/main/java/android/databinding/adapters/AdapterViewBindingAdapter.java" target="_blank" rel="noopener">AdapterViewBindingAdapter</a></td>
</tr>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/CalendarView" target="_blank" rel="noopener">CalendarView</a></td>
<td>android:date</td>
<td><a href="https://android.googlesource.com/platform/frameworks/data-binding/+/3b920788e90bb0abe615a5d5c899915f0014444b/extensions/baseAdapters/src/main/java/android/databinding/adapters/CalendarViewBindingAdapter.java" target="_blank" rel="noopener">CalendarViewBindingAdapter</a></td>
</tr>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/CompoundButton" target="_blank" rel="noopener">CompoundButton</a></td>
<td><a href="https://developer.android.com/reference/android/R.attr#checked" target="_blank" rel="noopener">android:checked</a></td>
<td><a href="https://android.googlesource.com/platform/frameworks/data-binding/+/3b920788e90bb0abe615a5d5c899915f0014444b/extensions/baseAdapters/src/main/java/android/databinding/adapters/CompoundButtonBindingAdapter.java" target="_blank" rel="noopener">CompoundButtonBindingAdapter</a></td>
</tr>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/DatePicker" target="_blank" rel="noopener">DatePicker</a></td>
<td>android:year<br>android:month<br>android:day</td>
<td><a href="https://android.googlesource.com/platform/frameworks/data-binding/+/3b920788e90bb0abe615a5d5c899915f0014444b/extensions/baseAdapters/src/main/java/android/databinding/adapters/DatePickerBindingAdapter.java" target="_blank" rel="noopener">DatePickerBindingAdapter</a></td>
</tr>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/NumberPicker" target="_blank" rel="noopener">NumberPicker</a></td>
<td><a href="https://developer.android.com/reference/android/R.attr#value" target="_blank" rel="noopener">android:value</a></td>
<td><a href="https://android.googlesource.com/platform/frameworks/data-binding/+/3b920788e90bb0abe615a5d5c899915f0014444b/extensions/baseAdapters/src/main/java/android/databinding/adapters/NumberPickerBindingAdapter.java" target="_blank" rel="noopener">NumberPickerBindingAdapter</a></td>
</tr>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/RadioButton" target="_blank" rel="noopener">RadioButton</a></td>
<td><a href="https://developer.android.com/reference/android/R.attr#checkedButton" target="_blank" rel="noopener">android:checkedButton</a></td>
<td><a href="https://android.googlesource.com/platform/frameworks/data-binding/+/3b920788e90bb0abe615a5d5c899915f0014444b/extensions/baseAdapters/src/main/java/android/databinding/adapters/RadioGroupBindingAdapter.java" target="_blank" rel="noopener">RadioGroupBindingAdapter</a></td>
</tr>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/RatingBar" target="_blank" rel="noopener">RatingBar</a></td>
<td><a href="https://developer.android.com/reference/android/R.attr#rating" target="_blank" rel="noopener">android:rating</a></td>
<td><a href="https://android.googlesource.com/platform/frameworks/data-binding/+/3b920788e90bb0abe615a5d5c899915f0014444b/extensions/baseAdapters/src/main/java/android/databinding/adapters/RatingBarBindingAdapter.java" target="_blank" rel="noopener">RatingBarBindingAdapter</a></td>
</tr>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/SeekBar" target="_blank" rel="noopener">SeekBar</a></td>
<td><a href="https://developer.android.com/reference/android/R.attr#progress" target="_blank" rel="noopener">android:progress</a></td>
<td><a href="https://android.googlesource.com/platform/frameworks/data-binding/+/3b920788e90bb0abe615a5d5c899915f0014444b/extensions/baseAdapters/src/main/java/android/databinding/adapters/SeekBarBindingAdapter.java" target="_blank" rel="noopener">SeekBarBindingAdapter</a></td>
</tr>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/TabHost" target="_blank" rel="noopener">TabHost</a></td>
<td>android:currentTab</td>
<td><a href="https://android.googlesource.com/platform/frameworks/data-binding/+/3b920788e90bb0abe615a5d5c899915f0014444b/extensions/baseAdapters/src/main/java/android/databinding/adapters/TabHostBindingAdapter.java" target="_blank" rel="noopener">TabHostBindingAdapter</a></td>
</tr>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/TextView" target="_blank" rel="noopener">TextView</a></td>
<td><a href="https://developer.android.com/reference/android/R.attr#text" target="_blank" rel="noopener">android:text</a></td>
<td><a href="https://android.googlesource.com/platform/frameworks/data-binding/+/3b920788e90bb0abe615a5d5c899915f0014444b/extensions/baseAdapters/src/main/java/android/databinding/adapters/TextViewBindingAdapter.java" target="_blank" rel="noopener">TextViewBindingAdapter</a></td>
</tr>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/TimePicker" target="_blank" rel="noopener">TimePicker</a></td>
<td>android:hour<br>android:minute</td>
<td><a href="https://android.googlesource.com/platform/frameworks/data-binding/+/3b920788e90bb0abe615a5d5c899915f0014444b/extensions/baseAdapters/src/main/java/android/databinding/adapters/TimePickerBindingAdapter.java" target="_blank" rel="noopener">TimePickerBindingAdapter</a></td>
</tr>
</tbody>
</table>
]]></content>
      
        <categories>
            
            <category> Android Architecture Component </category>
            
            <category> kotlin </category>
            
            <category> DataBinding </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> architecture </tag>
            
            <tag> Android Architecture Component </tag>
            
            <tag> aac </tag>
            
            <tag> ViewModel </tag>
            
            <tag> LiveData </tag>
            
            <tag> DataBinding </tag>
            
            <tag> Lifecycles </tag>
            
            <tag> 翻译 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Architecture Component DataBinding -- Architecture（翻译）]]></title>
      <url>/2018/04/15/android_architecture_components_binding_architecture/</url>
      <content type="html"><![CDATA[<h1 id="Android-Architecture-Component-DataBinding-–-Architecture（翻译）"><a href="#Android-Architecture-Component-DataBinding-–-Architecture（翻译）" class="headerlink" title="Android Architecture Component DataBinding – Architecture（翻译）"></a>Android Architecture Component DataBinding – Architecture（翻译）</h1><blockquote>
<p>原文：<a href="https://developer.android.com/topic/libraries/data-binding/architecture" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/data-binding/architecture</a></p>
</blockquote>
<p>AndroidX 库包含了 <a href="https://developer.android.com/topic/libraries/architecture/index.html" target="_blank" rel="noopener">Architecture Components</a>，你可以使用它来设计具有鲁棒性，可测试性，可维护性的 apps。Data Binding 库与 Architecture Components 无缝协作，以进一步简化了 UI 的开发。在 Architecture Components 中，你 app 的 layout 可以绑定到数据，它已经帮助你管理 UI 控制器的生命周期，并通知有关数据中的改动。</p>
<p>本文展示如何把 Architecture Components 继承进你的 app，来让你的 app 进一步增强使用 Data Binding 库的好处。</p>
<h2 id="使用-LiveData-来通知-UI-数据的更改"><a href="#使用-LiveData-来通知-UI-数据的更改" class="headerlink" title="使用 LiveData 来通知 UI 数据的更改"></a>使用 LiveData 来通知 UI 数据的更改</h2><p>你可以使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData" target="_blank" rel="noopener"><code>LiveData</code></a> 对象作为 data binding 源在数据变化时候自动通知 UI。更多 Architecture Component 相关详情见 <a href="https://developer.android.com/topic/libraries/architecture/livedata" target="_blank" rel="noopener">LiveData 概要</a>。</p>
<p>不像实现 <a href="https://developer.android.com/reference/android/databinding/Observable.html" target="_blank" rel="noopener"><code>Observable</code></a> —— 比如 <a href=""> observable fields</a> —— <code>LiveData</code> 对象知道观察者订阅数据变化的生命周期。这点可以引发很多好处，这已经在 <a href="https://developer.android.com/topic/libraries/architecture/livedata.html#the_advantages_of_using_livedata" target="_blank" rel="noopener">LiveData 的优势</a> 中解释了。在 Android Studio 3.1 及以上，你可以在你的 data binding 代码中用 <code>LiveData</code> 对象 替换 <a href="https://developer.android.com/topic/libraries/data-binding/observability.html#observable_fields" target="_blank" rel="noopener">observable fields</a>。</p>
<p>要在你的绑定类中使用 <code>LiveData</code> 对象，你需要指定一个 lifecycle owner 来定义 <code>LiveData</code> 对象的范围。下面的例子在绑定类初始化后，指定了这个 activity 作为 lifecycle owner：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewModelActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// Inflate view and obtain an instance of the binding class.</span></span><br><span class="line">        <span class="keyword">val</span> binding: UserBinding = DataBindingUtil.setContentView(<span class="keyword">this</span>, R.layout.user)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Specify the current activity as the lifecycle owner.</span></span><br><span class="line">        binding.setLifecycleOwner(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你使用了一个 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel" target="_blank" rel="noopener">ViewModel</a> 组件，在 <a href="https://developer.android.com/topic/libraries/data-binding/architecture#viewmodel" target="_blank" rel="noopener">使用 ViewModel 管理 UI 相关的数据</a>中解释，来绑定数据到 layout。在 <code>ViewModel</code> 组件中，你可以使用 <code>LiveData</code> 来改变数据或合并多个数据源。下面的例子展示了如何改变 <code>ViewModel</code> 中的数据源：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScheduleViewModel</span> : <span class="type">ViewModel</span></span>() &#123;</span><br><span class="line">    <span class="keyword">val</span> userName: LiveData</span><br><span class="line"></span><br><span class="line">    init &#123;</span><br><span class="line">        <span class="keyword">val</span> result = Repository.userName</span><br><span class="line">        userName = Transformations.map(result) &#123; result -&gt; result.value &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用-ViewModel-管理-UI-相关的数据"><a href="#使用-ViewModel-管理-UI-相关的数据" class="headerlink" title="使用 ViewModel 管理 UI 相关的数据"></a>使用 ViewModel 管理 UI 相关的数据</h2><p>Data Binding 库与 <code>ViewModel</code> 组件无缝协作，它暴露 layout observes 数据并对其更改做出反应。与 Data Binding 使用 <code>ViewModel</code> 组件允许你把 UI 逻辑从 layout 移动到组件中，使得更容易测试。Data Binding 库确保在需要时从数据源绑定和取消绑定 views。剩下的大部分工作都是为了确保你暴露了正确的数据。更多关于这个 Architecture Component，见 <a href="https://developer.android.com/topic/libraries/architecture/viewmodel.html" target="_blank" rel="noopener">ViewModel 概要</a>。</p>
<p>要将 <code>ViewModel</code> 组件与 Data Binding 库一起使用，你必须要实例化你的组件，它继承自 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener">ViewModel</a> 类，获取一个你绑定类的实例，然后把 <code>ViewModel</code> 组件赋值到绑定类中。下面的例子展示了如何跟库一起使用组建：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewModelActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="comment">// Obtain the ViewModel component.</span></span><br><span class="line">        UserModel userModel = ViewModelProviders.of(getActivity())</span><br><span class="line">                                                  .<span class="keyword">get</span>(UserModel.<span class="keyword">class</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Inflate view and obtain an instance of the binding class.</span></span><br><span class="line">        <span class="keyword">val</span> binding: UserBinding = DataBindingUtil.setContentView(<span class="keyword">this</span>, R.layout.user)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Assign the component to a property in the binding class.</span></span><br><span class="line">        binding.viewmodel = userModel</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在你的 layout 中，在你的 views 绑定表达式中分配相应的 <code>ViewModel</code> 组件的属性和方法：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">CheckBox</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/rememberMeCheckBox"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:checked</span>=<span class="string">"@&#123;viewmodel.rememberMe&#125;"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:onCheckedChanged</span>=<span class="string">"@&#123;() -&gt; viewmodel.rememberMeChanged()&#125;"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="使用一个-Observable-ViewModel-对-binding-adapters-进行更多的控制"><a href="#使用一个-Observable-ViewModel-对-binding-adapters-进行更多的控制" class="headerlink" title="使用一个 Observable ViewModel 对 binding adapters 进行更多的控制"></a>使用一个 Observable ViewModel 对 binding adapters 进行更多的控制</h2><p>你可以使用一个 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 组件实现 <a href="https://developer.android.com/reference/android/databinding/Observable.html" target="_blank" rel="noopener"><code>Observable</code></a> 在数据改变时通知其它 app 组件，就像如何使用 <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData" target="_blank" rel="noopener"><code>LiveData</code></a> 对象。</p>
<p>在某些情况下, 您可能更喜欢使用实现 <a href="https://developer.android.com/reference/android/databinding/Observable.html" target="_blank" rel="noopener"><code>Observable</code></a> 接口的 <code>ViewModel</code> 组件，而不是使用 <code>LiveData</code> 对象，即使失去 <code>LiveData</code> 的生命周期管理功能。使用实现 <code>Observable</code> 的 <code>ViewModel</code> 组件可让你更好地控制应用中的binding adapters。举例，这个模式让你可以更好地控制数据更改时的通知，它还允许你指定自定义方法，以便在双向数据绑定中设置属性的值。</p>
<p>要实现一个 observable <code>ViewModel</code> 组件，你必须创建一个类继承 <a href="https://developer.android.com/reference/android/arch/lifecycle/ViewModel.html" target="_blank" rel="noopener"><code>ViewModel</code></a> 类并实现 <a href="https://developer.android.com/reference/android/databinding/Observable.html" target="_blank" rel="noopener"><code>Observable</code></a> 接口。当一个观察者订阅或取消订阅来使用 <a href="https://developer.android.com/reference/android/databinding/Observable.html#addOnPropertyChangedCallback(android.databinding.Observable.OnPropertyChangedCallback" target="_blank" rel="noopener"><code>addOnPropertyChangedCallback()</code></a>) 和 <a href="https://developer.android.com/reference/android/databinding/Observable.html#removeOnPropertyChangedCallback(android.databinding.Observable.OnPropertyChangedCallback" target="_blank" rel="noopener"><code>removeOnPropertyChangedCallback()</code></a>) 进行通知时，你可以提供自定义逻辑。你也可以在属性改变时运行在 <a href="https://developer.android.com/reference/android/databinding/BaseObservable.html#notifyPropertyChanged(int" target="_blank" rel="noopener"><code>notifyPropertyChanged()</code></a>) 方法中时提供自定义逻辑。下面的例子展示了如何实现一个 observable <code>ViewModel</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A ViewModel that is also an Observable,</span></span><br><span class="line"><span class="comment"> * to be used with the Data Binding Library.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">ObservableViewModel</span> : <span class="type">ViewModel</span></span>(), Observable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> callbacks: PropertyChangeRegistry = PropertyChangeRegistry()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">addOnPropertyChangedCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            callback: <span class="type">Observable</span>.<span class="type">OnPropertyChangedCallback</span>)</span></span> &#123;</span><br><span class="line">        callbacks.add(callback)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">removeOnPropertyChangedCallback</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            callback: <span class="type">Observable</span>.<span class="type">OnPropertyChangedCallback</span>)</span></span> &#123;</span><br><span class="line">        callbacks.remove(callback)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies observers that all properties of this instance have changed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">notifyChange</span><span class="params">()</span></span> &#123;</span><br><span class="line">        callbacks.notifyCallbacks(<span class="keyword">this</span>, <span class="number">0</span>, <span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notifies observers that a specific property has changed. The getter for the</span></span><br><span class="line"><span class="comment">     * property that changes should be marked with the <span class="doctag">@Bindable</span> annotation to</span></span><br><span class="line"><span class="comment">     * generate a field in the BR class to be used as the fieldId parameter.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fieldId The generated BR id for the Bindable field.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">notifyPropertyChanged</span><span class="params">(fieldId: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        callbacks.notifyCallbacks(<span class="keyword">this</span>, fieldId, <span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Android Architecture Component </category>
            
            <category> kotlin </category>
            
            <category> DataBinding </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> architecture </tag>
            
            <tag> Android Architecture Component </tag>
            
            <tag> aac </tag>
            
            <tag> ViewModel </tag>
            
            <tag> LiveData </tag>
            
            <tag> DataBinding </tag>
            
            <tag> Lifecycles </tag>
            
            <tag> 翻译 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Architecture Component DataBinding -- Binding adapters（翻译）]]></title>
      <url>/2018/04/15/android_architecture_components_binding_adapters/</url>
      <content type="html"><![CDATA[<h1 id="Android-Architecture-Component-DataBinding-–-Binding-adapters（翻译）"><a href="#Android-Architecture-Component-DataBinding-–-Binding-adapters（翻译）" class="headerlink" title="Android Architecture Component DataBinding – Binding adapters（翻译）"></a>Android Architecture Component DataBinding – Binding adapters（翻译）</h1><blockquote>
<p>原文：<a href="https://developer.android.com/topic/libraries/data-binding/binding-adapters" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/data-binding/binding-adapters</a></p>
</blockquote>
<p>Binding adapters 负责对设置值进行适当的框架调用。一个例子是像调用 <a href="https://developer.android.com/reference/android/widget/TextView.html#setText(char[],%20int,%20int" target="_blank" rel="noopener"><code>setText()</code></a>) 方法去设置属性值。另一个例子是像调用 <a href="https://developer.android.com/reference/android/view/View.html#setOnClickListener(android.view.View.OnClickListener" target="_blank" rel="noopener"><code>setOnClickListener()</code></a>) 方法去设置一个事件监听器。</p>
<p>Data Binding 库允许你去指定设置一个值的方法，提供你自己的绑定逻辑，以及通过使用 adapters 来指定返回对象的类型。</p>
<h2 id="设置属性值"><a href="#设置属性值" class="headerlink" title="设置属性值"></a>设置属性值</h2><p>每当绑定的值改变，生成的绑定类必须调用一个 view 的表达式 的 setter 方法。你可以让 Data Binding 自动确定方法，显式声明方法或提供自定义逻辑以选择方法。</p>
<h3 id="自动选择方法"><a href="#自动选择方法" class="headerlink" title="自动选择方法"></a>自动选择方法</h3><p>对于名为 <code>name</code> 的属性，库会自动尝试寻找方法 <code>setExample(arg)</code>，它接受一个相应的类型作为参数。不考虑属性的命名空间，在搜索方法时只使用属性名称和类型。</p>
<p>举个例子，给定 <code>android:text=&quot;@{user.name}&quot;</code> 表达式，库会自动寻找一个 <code>setText(args)</code> 的方法，它接收一个 <code>user.getName()</code> 返回值的类型的参数。如果 <code>user.getName()</code> 返回类型是 <code>String</code>，库会去寻找一个接收一个 <code>String</code> 类型参数的 <code>setText()</code> 方法。如果 <code>user.getName()</code> 返回类型是 <code>int</code>，库会去寻找一个接收一个 <code>int</code> 类型参数的 <code>setText()</code> 方法。表达式必须返回正确的类型，必要时你可以去对返回值进行转型。</p>
<p>甚至没有给定名字的属性存在，Data Binding 也能正常工作。你可以通过 data binding 为任何 setter 创建属性。下面 layout 自动使用 <a href="https://developer.android.com/reference/android/support/v4/widget/DrawerLayout.html#setScrimColor(int" target="_blank" rel="noopener"><code>setScrimColor(int)</code></a>) 和 <a href="https://developer.android.com/reference/android/support/v4/widget/DrawerLayout.html#setDrawerListener(android.support.v4.widget.DrawerLayout.DrawerListener" target="_blank" rel="noopener"><code>setDrawerListener(DrawerListener)</code></a>) 方法作为 <code>app:scrimColor</code> 和 <code>app:drawerListener</code> 属性的 setter 方法。分别为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">android.support.v4.widget.DrawerLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:scrimColor</span>=<span class="string">"@&#123;@color/scrim&#125;"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:drawerListener</span>=<span class="string">"@&#123;fragment.drawerListener&#125;"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="指定自定义方法名"><a href="#指定自定义方法名" class="headerlink" title="指定自定义方法名"></a>指定自定义方法名</h3><p>一些属性的 setter 与名称不匹配。在这种情况下，属性可以使用 <a href="https://developer.android.com/reference/android/databinding/BindingMethods.html" target="_blank" rel="noopener"><code>BindingMethods</code></a> 注解进行 setter 的关联。注解可以与类一起使用，并且可以包含多个 <a href="https://developer.android.com/reference/android/databinding/BindingMethod.html" target="_blank" rel="noopener"><code>BindingMethod</code></a> 注解，每一个都有一个重命名的方法。BindingMethods 注解可以被加在你 app 中的任何类上面。下面的例子中，<code>android:tint</code> 属性与 <a href="https://developer.android.com/reference/android/widget/ImageView.html#setImageTintList(android.content.res.ColorStateList" target="_blank" rel="noopener"><code>setImageTintList(ColorStateList)</code></a>) 方法关联，而不是 <code>setTint()</code> 方法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingMethods(value = [</span></span><br><span class="line"><span class="meta">    BindingMethod(</span></span><br><span class="line"><span class="meta">        type = android.widget.ImageView::class,</span></span><br><span class="line"><span class="meta">        attribute = <span class="meta-string">"android:tint"</span>,</span></span><br><span class="line"><span class="meta">        method = <span class="meta-string">"setImageTintList"</span>)</span>])</span><br></pre></td></tr></table></figure>
<p>大多数情况下，你不需要重命名 Android Framework 类中的 setters。属性已经使用名称约定实现了自动查找匹配方法。</p>
<h3 id="提供自定义逻辑"><a href="#提供自定义逻辑" class="headerlink" title="提供自定义逻辑"></a>提供自定义逻辑</h3><p>一些属性需要自定义绑定逻辑。举个例子，没有一个与 <code>android:paddingLeft</code> 属性关联的 setter。但是提供了 <code>setPadding(left, top, right, bottom)</code>。一个带有 <a href="https://developer.android.com/reference/android/databinding/BindingAdapter.html" target="_blank" rel="noopener"><code>BindingAdapter</code></a> 注解的，静态的 binding adapter 方法可以允许你自定义属性调用的 setter 是怎么样的。</p>
<p>Android Framework 类的属性已经创建了 <code>BindingAdapter</code> 注解。举例，下面的例子展示了 <code>paddingLeft</code> 属性的 binding adapter：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">"android:paddingLeft"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setPaddingLeft</span><span class="params">(view: <span class="type">View</span>, padding: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    view.setPadding(padding,</span><br><span class="line">                view.getPaddingTop(),</span><br><span class="line">                view.getPaddingRight(),</span><br><span class="line">                view.getPaddingBottom())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数类型是很重要的，第一个参数决定了与属性相关联的 view 的类型。第二个参数决定了给定属性表达式中接收的类型。</p>
<p>Binding adapter 对其它类型的自定义是很有用的。举例，一个工作线程中自定义加载器可以被调用来加载图片。</p>
<p>如果与 Android Framework 冲突，你定义的 binding adapters 会覆盖它。</p>
<p>你的 adapters 也可以接收多个属性，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">"imageUrl"</span>, <span class="meta-string">"error"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">loadImage</span><span class="params">(view: <span class="type">ImageView</span>, url: <span class="type">String</span>, error: <span class="type">Drawable</span>)</span></span> &#123;</span><br><span class="line">    Picasso.<span class="keyword">get</span>().load(url).error(error).into(view)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可以如下在你的 layout 中使用 adapter。注意，<code>@drawable/venueError</code> 引用了你 app 中的 resource。使用 <code>@{}</code> 包围使它成为一个合法的 binding 表达式。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ImageView</span> <span class="attr">app:imageUrl</span>=<span class="string">"@&#123;venue.imageUrl&#125;"</span> <span class="attr">app:error</span>=<span class="string">"@&#123;@drawable/venueError&#125;"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Data Binding Library 忽略了自定义命名空间以用于匹配。</p>
</blockquote>
<p>如果，<code>imageUrl</code> 和 <code>error</code> 都被 <a href="https://developer.android.com/reference/android/widget/ImageView.html" target="_blank" rel="noopener"><code>ImageView</code></a> 对象使用，并且 <code>imageUrl</code> 是一个 String，<code>error</code> 是一个 <a href="https://developer.android.com/reference/android/graphics/drawable/Drawable.html" target="_blank" rel="noopener"><code>Drawable</code></a>，adapter 就会被调用。如果你希望它们任何属性被调用时就让 adapter 调用，你可以设置 <a href="https://developer.android.com/reference/android/databinding/BindingAdapter.html#requireAll(" target="_blank" rel="noopener"><code>requireAll</code></a>) 标志为 <code>false</code>，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(value = [<span class="meta-string">"imageUrl"</span>, <span class="meta-string">"placeholder"</span>], requireAll = false)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setImageUrl</span><span class="params">(imageView: <span class="type">ImageView</span>, url: <span class="type">String</span>, placeHolder: <span class="type">Drawable</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (url == <span class="literal">null</span>) &#123;</span><br><span class="line">        imageView.setImageDrawable(placeholder);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        MyImageLoader.loadInto(imageView, url, placeholder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当有冲突时，你的 binding adapters 覆盖默认的 data binding adapters。</p>
</blockquote>
<p>Binding adapter 方法可以选择在处理器中返回旧值。一个方法声明旧值和新值时应该首先声明 <em>所有</em> 属性的旧值，然后再是新值，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">"android:paddingLeft"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setPaddingLeft</span><span class="params">(view: <span class="type">View</span>, oldPadding: <span class="type">Int</span>, newPadding: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (oldPadding != newPadding) &#123;</span><br><span class="line">        view.setPadding(padding,</span><br><span class="line">                    view.getPaddingTop(),</span><br><span class="line">                    view.getPaddingRight(),</span><br><span class="line">                    view.getPaddingBottom())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>事件处理器只能与只有一个抽象方法的接口或抽象类一起使用，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">"android:onLayoutChange"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setOnLayoutChangeListener</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        view: <span class="type">View</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        oldValue: <span class="type">View</span>.<span class="type">OnLayoutChangeListener</span>?,</span></span></span><br><span class="line"><span class="function"><span class="params">        newValue: <span class="type">View</span>.<span class="type">OnLayoutChangeListener</span>?</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldValue != <span class="literal">null</span>) &#123;</span><br><span class="line">            view.removeOnLayoutChangeListener(oldValue)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newValue != <span class="literal">null</span>) &#123;</span><br><span class="line">            view.addOnLayoutChangeListener(newValue)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如下在你的 layout 中使用事件处理器：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">View</span> <span class="attr">android:onLayoutChange</span>=<span class="string">"@&#123;() -&gt; handler.layoutChanged()&#125;"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>当一个监听器有多个方法，必须要把它分割成多个监听器。比如，<a href="https://developer.android.com/reference/android/view/View.OnAttachStateChangeListener.html" target="_blank" rel="noopener"><code>View.OnAttachStateChangeListener</code></a> 有两个方法：<a href="https://developer.android.com/reference/android/view/View.OnAttachStateChangeListener.html#onViewAttachedToWindow(android.view.View" target="_blank" rel="noopener"><code>onViewAttachedToWindow(View)</code></a>) 和 <a href="https://developer.android.com/reference/android/view/View.OnAttachStateChangeListener.html#onViewDetachedFromWindow(android.view.View" target="_blank" rel="noopener"><code>onViewDetachedFromWindow(View)</code></a>)。对此，库提供了两个接口来区分属性和处理器：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Translation from provided interfaces in Java:</span></span><br><span class="line"><span class="meta">@TargetApi(Build.VERSION_CODES.HONEYCOMB_MR1)</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OnViewDetachedFromWindow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onViewDetachedFromWindow</span><span class="params">(v: <span class="type">View</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@TargetApi(Build.VERSION_CODES.HONEYCOMB_MR1)</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OnViewAttachedToWindow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onViewAttachedToWindow</span><span class="params">(v: <span class="type">View</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为改变其中一个监听器也会影响另一个，所以你需要一个任意或者全部属性的 adapter。你可以在注解中设置 <a href="https://developer.android.com/reference/android/databinding/BindingAdapter.html#requireAll(" target="_blank" rel="noopener"><code>requireAll</code></a>) 为 <code>false</code> 来指定不是所有属性都必须设置一个绑定表达式，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(</span></span><br><span class="line"><span class="meta">        <span class="meta-string">"android:onViewDetachedFromWindow"</span>,</span></span><br><span class="line"><span class="meta">        <span class="meta-string">"android:onViewAttachedToWindow"</span>,</span></span><br><span class="line"><span class="meta">        requireAll = false</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setListener</span><span class="params">(view: <span class="type">View</span>, detach: <span class="type">OnViewDetachedFromWindow</span>?, attach: <span class="type">OnViewAttachedToWindow</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB_MR1) &#123;</span><br><span class="line">        <span class="keyword">val</span> newListener: View.OnAttachStateChangeListener?</span><br><span class="line">        newListener = <span class="keyword">if</span> (detach == <span class="literal">null</span> &amp;&amp; attach == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="literal">null</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">object</span> : View.OnAttachStateChangeListener &#123;</span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewAttachedToWindow</span><span class="params">(v: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">                    attach?.onViewAttachedToWindow(v)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewDetachedFromWindow</span><span class="params">(v: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">                    detach?.onViewDetachedFromWindow(v)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> oldListener: View.OnAttachStateChangeListener? =</span><br><span class="line">                ListenerUtil.trackListener(view, newListener, R.id.onAttachStateChangeListener)</span><br><span class="line">        <span class="keyword">if</span> (oldListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            view.removeOnAttachStateChangeListener(oldListener)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            view.addOnAttachStateChangeListener(newListener)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的例子比一般的稍微复杂一点，因为 <a href="https://developer.android.com/reference/android/view/View.html" target="_blank" rel="noopener"><code>View</code></a> 类使用 <a href="https://developer.android.com/reference/android/view/View.html#addOnAttachStateChangeListener(android.view.View.OnAttachStateChangeListener" target="_blank" rel="noopener"><code>addOnAttachStateChangeListener()</code></a>) 和 <a href="https://developer.android.com/reference/android/view/View.html#removeOnAttachStateChangeListener(android.view.View.OnAttachStateChangeListener" target="_blank" rel="noopener"><code>removeOnAttachStateChangeListener()</code></a>) 方法而不是 <a href="https://developer.android.com/reference/android/view/View.OnAttachStateChangeListener.html" target="_blank" rel="noopener"><code>OnAttachStateChangeListener</code></a> 的 setter 方法。<code>android.databinding.adapters.ListenerUtil</code> 类帮助保持跟踪之前的监听器，以便于它们在 binding adapter 中便于移除。</p>
<p>通过在接口 <code>OnViewDetachedFromWindow</code> 和 <code>OnViewAttachedToWindow</code> 添加 <code>@TargetApi(VERSION_CODES.HONEYCOMB_MR1)</code> 注解，data binding 代码生成器知道 监听器应该只会在 Android 3.1（API level 12）及以上才会生成，支持的版本与 <a href="https://developer.android.com/reference/android/view/View.html#addOnAttachStateChangeListener(android.view.View.OnAttachStateChangeListener" target="_blank" rel="noopener"><code>addOnAttachStateChangeListener()</code></a>) 方法相同。</p>
<h2 id="对象转化"><a href="#对象转化" class="headerlink" title="对象转化"></a>对象转化</h2><h3 id="自动对象转化"><a href="#自动对象转化" class="headerlink" title="自动对象转化"></a>自动对象转化</h3><p>当一个 <a href="https://developer.android.com/reference/java/lang/Object.html" target="_blank" rel="noopener"><code>Object</code></a> 从绑定表达式中返回时，库选择方法来设置属性的值。<code>Object</code> 被转换为所选方法的参数类型。使用 <a href="https://developer.android.com/reference/android/databinding/ObservableMap.html" target="_blank" rel="noopener"><code>ObservableMap</code></a> 类来存储数据这个行为在 app 中是很方便的，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;TextView</span><br><span class="line">   android:text=<span class="string">'@&#123;userMap["lastName"]&#125;'</span></span><br><span class="line">   android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">   android:layout_height=<span class="string">"wrap_content"</span> /&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>你也可以使用 <strong>object.key</strong> 的方式引用值。比如，上面例子中的 @{<strong>userMap[“lastName”]</strong>} 可以被替换为 @{<strong>userMap.lastName</strong>}</p>
</blockquote>
<p>表达式中的 <code>userMap</code> 对象返回一个值，它自动转型成 用户通过 <code>android:text</code> 属性设置值的 <code>setText(CharSequence)</code> 方法的参数类型。如果参数类型产生歧义的，你必须要在表达式中进行类型转换。</p>
<h3 id="自定义转换"><a href="#自定义转换" class="headerlink" title="自定义转换"></a>自定义转换</h3><p>在一些情况下，在两个特殊的类型之间自定义转换是需要的。比如，View 的 <code>android:background</code> 属性期望是一个 <a href="https://developer.android.com/reference/android/graphics/drawable/Drawable.html" target="_blank" rel="noopener"><code>Drawable</code></a>，但是指定的 <code>color</code> 值是一个 integer。下面的例子展示了属性期望是 <code>Drawable</code>，但是提供的却是 integer：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;View</span><br><span class="line">   android:background=<span class="string">"@&#123;isError ? @color/red : @color/white&#125;"</span></span><br><span class="line">   android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">   android:layout_height=<span class="string">"wrap_content"</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>每当期望一个 <code>Drawable</code> 并返回一个 integer 时，<code>int</code> 应该要被转换成一个 <a href="https://developer.android.com/reference/android/graphics/drawable/ColorDrawable.html" target="_blank" rel="noopener"><code>ColorDrawable</code></a>。这个转换可以通过使用一个带有 <a href="https://developer.android.com/reference/android/databinding/BindingConversion.html" target="_blank" rel="noopener"><code>BindingConversion</code></a> static 的方法做到：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingConversion</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">convertColorToDrawable</span><span class="params">(color: <span class="type">Int</span>)</span></span> = ColorDrawable(color)</span><br></pre></td></tr></table></figure>
<p>但是，绑定表达式中提供的值类型必须是一致的。不能在同一表达式中使用不同的类型，如下示例所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;View</span><br><span class="line">   android:background=<span class="string">"@&#123;isError ? @drawable/error : @color/white&#125;"</span></span><br><span class="line">   android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">   android:layout_height=<span class="string">"wrap_content"</span>/&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Android Architecture Component </category>
            
            <category> kotlin </category>
            
            <category> DataBinding </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> architecture </tag>
            
            <tag> Android Architecture Component </tag>
            
            <tag> aac </tag>
            
            <tag> ViewModel </tag>
            
            <tag> LiveData </tag>
            
            <tag> DataBinding </tag>
            
            <tag> Lifecycles </tag>
            
            <tag> 翻译 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Architecture Component DataBinding -- 生成的绑定类（翻译）]]></title>
      <url>/2018/04/15/android_architecture_components_generated_binding/</url>
      <content type="html"><![CDATA[<h1 id="Android-Architecture-Component-DataBinding-–-生成的绑定类（翻译）"><a href="#Android-Architecture-Component-DataBinding-–-生成的绑定类（翻译）" class="headerlink" title="Android Architecture Component DataBinding – 生成的绑定类（翻译）"></a>Android Architecture Component DataBinding – 生成的绑定类（翻译）</h1><blockquote>
<p>原文：<a href="https://developer.android.com/topic/libraries/data-binding/generated-binding" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/data-binding/generated-binding</a></p>
</blockquote>
<p>Data Binding 库生成绑定类来用于访问 layout 的 variable 和 views。本文展示了如何创建和自定义生成的绑定类。</p>
<p>生成的绑定类链接 layout 中的 variables 和 views。绑定类的名字和包名都是可以<a href="https://developer.android.com/topic/libraries/data-binding/generated-binding#custom_binding_class_names" target="_blank" rel="noopener">自定义的</a>。所有生成的绑定类都继承自 <a href="https://developer.android.com/reference/android/databinding/ViewDataBinding.html" target="_blank" rel="noopener"><code>ViewDataBinding</code></a> 类。</p>
<p>每个 layout 文件都会生成一个 binding class。默认情况下，类名基于 layout 文件的名字。将其转换为 Pascal 大小写, 并向其添加 <em>Binding</em> 后缀。上面的 layout 名字是 <code>activity_main.xml</code> 所以相应生成的类是 <code>ActivityMainBinding</code>。这个类会持有从 layout 属性（比如，<code>user</code> 变量）到 layout 的 views 的所有绑定，并知道如何为绑定表达式赋值。</p>
<h2 id="创建一个-binding-对象"><a href="#创建一个-binding-对象" class="headerlink" title="创建一个 binding 对象"></a>创建一个 binding 对象</h2><p>Binding 对象在 inflating layout 之后马上创建来确保 layout 中 view 层级在使用表达式绑定到 views 之前没有被修改。最常用绑定对象到 layout 的方式是使用绑定类的静态方法。你可以使用绑定类的 <code>inflate()</code> 方法来 inflate view 层级和绑定对象到它自身。如下例子：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> binding: MyLayoutBinding = MyLayoutBinding.inflate(layoutInflater)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有一个 <code>inflate()</code> 方法的替代版本，它除了 <a href="https://developer.android.com/reference/android/view/LayoutInflater.html" target="_blank" rel="noopener"><code>LayoutInflater</code></a> 对象之外还需要一个 <a href="https://developer.android.com/reference/android/view/ViewGroup.html" target="_blank" rel="noopener"><code>ViewGroup</code></a> 对象，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> binding: MyLayoutBinding = MyLayoutBinding.inflate(getLayoutInflater(), viewGroup, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure>
<p>如果 layout 是使用不同的机制 inflate 的，它可以单独去绑定，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> binding: MyLayoutBinding = MyLayoutBinding.bind(viewRoot)</span><br></pre></td></tr></table></figure>
<p>有时无法事先知道绑定类型。在这个情况下，binding 可以使用 <a href="https://developer.android.com/reference/android/databinding/DataBindingUtil.html" target="_blank" rel="noopener"><code>DataBindingUtil</code></a> 类来创建，如下代码片段：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> rootView = LayoutInflater.from(<span class="keyword">this</span>).inflate(layoutId, parent, attachToParent)</span><br><span class="line"><span class="keyword">val</span> binding: ViewDataBinding? = DataBindingUtil.bind(viewRoot)</span><br></pre></td></tr></table></figure>
<p>如果你在 <a href="https://developer.android.com/reference/android/app/Fragment.html" target="_blank" rel="noopener"><code>Fragment</code></a>，<a href="https://developer.android.com/reference/android/widget/ListView.html" target="_blank" rel="noopener"><code>ListView</code></a>，<a href="https://developer.android.com/reference/android/support/v7/widget/RecyclerView.html" target="_blank" rel="noopener"><code>RecyclerView</code></a> adapter 中使用 data binding，你可能更喜欢使用 bindings classes 的 <a href="https://developer.android.com/reference/android/databinding/DataBindingUtil.html#inflate(android.view.LayoutInflater,%20int,%20android.view.ViewGroup,%20boolean,%20android.databinding.DataBindingComponent" target="_blank" rel="noopener"><code>inflate</code></a>) 方法，或者 <a href="https://developer.android.com/reference/android/databinding/DataBindingUtil" target="_blank" rel="noopener"><code>DataBindingUtil</code></a> 类，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> listItemBinding = ListItemBinding.inflate(layoutInflater, viewGroup, <span class="literal">false</span>)</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">val</span> listItemBinding = DataBindingUtil.inflate(layoutInflater, R.layout.list_item, viewGroup, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure>
<h2 id="具有-ID-的-Views"><a href="#具有-ID-的-Views" class="headerlink" title="具有 ID 的 Views"></a>具有 ID 的 Views</h2><p>Data Binding 库在绑定类中为每个 layout 中带有 ID 的 view 创建了一个不可改变的属性。比如，下面的 layout 中，Data Binding 库创建了 <code>firstName</code> 和 <code>lastName</code> 两个 <code>TextView</code> 了行的属性：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;layout xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span><br><span class="line">   &lt;<span class="keyword">data</span>&gt;</span><br><span class="line">       &lt;variable name=<span class="string">"user"</span> type=<span class="string">"com.example.User"</span>/&gt;</span><br><span class="line">   &lt;/<span class="keyword">data</span>&gt;</span><br><span class="line">   &lt;LinearLayout</span><br><span class="line">       android:orientation=<span class="string">"vertical"</span></span><br><span class="line">       android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">       android:layout_height=<span class="string">"match_parent"</span>&gt;</span><br><span class="line">       &lt;TextView android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">           android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">           android:text=<span class="string">"@&#123;user.firstName&#125;"</span></span><br><span class="line">   android:id=<span class="string">"@+id/firstName"</span>/&gt;</span><br><span class="line">       &lt;TextView android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">           android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">           android:text=<span class="string">"@&#123;user.lastName&#125;"</span></span><br><span class="line">  android:id=<span class="string">"@+id/lastName"</span>/&gt;</span><br><span class="line">   &lt;/LinearLayout&gt;</span><br><span class="line">&lt;/layout&gt;</span><br></pre></td></tr></table></figure>
<p>库一次从 view 层级中取出包括 IDs 的 views。对于 layout 中的每个 view 来说，这个机制会比调用 <a href="https://developer.android.com/reference/android/app/Activity.html#findViewById(int" target="_blank" rel="noopener"><code>findViewById()</code></a>) 方法更快。</p>
<p>如果它们没有 data binding 则不必要，但是在一些情况下，仍然需要从代码中访问 view。</p>
<h2 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h2><p>Data Binding 库针对每个在 layout 声明了的 variable 生成访问方法。比如，下面的 layout 在绑定类中为 <code>user</code>，<code>image</code> 和 <code>note</code> 生成 setter 和 getter 方法：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"android.graphics.drawable.Drawable"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"com.example.User"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"image"</span> <span class="attr">type</span>=<span class="string">"Drawable"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">type</span>=<span class="string">"String"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="ViewStubs"><a href="#ViewStubs" class="headerlink" title="ViewStubs"></a>ViewStubs</h2><p>不像普通的 View，<a href="https://developer.android.com/reference/android/view/ViewStub.html" target="_blank" rel="noopener"><code>ViewStub</code></a> 对象以不可见的 view 作为开始。当它们被设置可见或者明确地 inflate 时，它们通过 inflating 另一个 layout 来替换它们自己。</p>
<p>因为 <code>ViewStub</code> 本质上在 view 层级上是不可见的，binding 对象中的 view 也必须消失来运行 gc 回收。因为 view 是 final 的，一个 <a href="https://developer.android.com/reference/android/databinding/ViewStubProxy.html" target="_blank" rel="noopener"><code>ViewStubProxy</code></a> 对象在生成的绑定类中取代 <code>ViewStub</code>，使你可以在 <code>ViewStub</code> 存在时访问它，并在 <code>ViewStub</code> 被 inflate 时访问 view 层次结构。</p>
<p>当 inflate 另一个 layout，必须为新 layout 建立绑定。因此，<code>ViewStubProxy</code> 必须监听 <code>ViewStub</code> 的 <a href="https://developer.android.com/reference/android/view/ViewStub.OnInflateListener.html" target="_blank" rel="noopener"><code>OnInflateListener</code></a>，并在需要时建立绑定。因为只有一个监听器可以在给定的时间里存在，<code>ViewStubProxy</code> 允许你去设置一个 <code>OnInflateListener</code>，它会在建立绑定后回调。</p>
<h2 id="立即绑定"><a href="#立即绑定" class="headerlink" title="立即绑定"></a>立即绑定</h2><p>当一个 variable 或者 observable 对象改变时，binding 会在下一帧之前调度变化。但是有时 binding 需要立即执行。要强制执行，使用 <a href="https://developer.android.com/reference/android/databinding/ViewDataBinding.html#executePendingBindings(" target="_blank" rel="noopener"><code>executePendingBindings()</code></a>) 方法。</p>
<h2 id="高级绑定"><a href="#高级绑定" class="headerlink" title="高级绑定"></a>高级绑定</h2><h3 id="动态变量"><a href="#动态变量" class="headerlink" title="动态变量"></a>动态变量</h3><p>有时，是不知道特定的绑定类的。比如，一个针对任意布局的 <a href="https://developer.android.com/reference/android/support/v7/widget/RecyclerView.Adapter.html" target="_blank" rel="noopener"><code>RecyclerView.Adapter</code></a> 是不知道具体特定的绑定类的。在调用 <a href="https://developer.android.com/reference/android/support/v7/widget/RecyclerView.Adapter.html#onBindViewHolder(VH,%20int" target="_blank" rel="noopener">onBindViewHolder()</a>) 方式时，它仍必须要分配 binding 的值。</p>
<p>在下面的例子中，所有 <code>RecyclerView</code> 绑定的布局都有一个 <code>item</code> 变量。<code>BindingHolder</code> 对象有一个 <code>getBinding()</code> 方法返回 <a href="https://developer.android.com/reference/android/databinding/ViewDataBinding.html" target="_blank" rel="noopener"><code>ViewDataBinding</code></a> 基类。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBindViewHolder</span><span class="params">(holder: <span class="type">BindingHolder</span>, position: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    item: T = mItems.<span class="keyword">get</span>(position)</span><br><span class="line">    holder.binding.setVariable(BR.item, item);</span><br><span class="line">    holder.binding.executePendingBindings();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Data Binding 库在 module 包下生成了一个名为 <strong>BR</strong> 的类，它包含了用户数据绑定的 resources IDs。在上面的例子中，库自动生成了 <strong>BR.item</strong> 变量。</p>
</blockquote>
<h2 id="后台线程"><a href="#后台线程" class="headerlink" title="后台线程"></a>后台线程</h2><p>只要数据模型不是集合，你可以在后台线程中更改数据模型。Data Binding 在计算时期对每个variable / field 进行本地化，以避免任何并发问题。</p>
<h2 id="自定义绑定类名"><a href="#自定义绑定类名" class="headerlink" title="自定义绑定类名"></a>自定义绑定类名</h2><p>默认情况下，一个绑定名字是基于 layout 的名字生成的，以大写字母开头，移除下划线（<code>_</code> ），大写下一个字母，添加后缀单词 <strong>Binding</strong>。这个类被放置在这个 module 包下的 <code>databinding</code> 包中。比如，layout 文件 <code>contact_item.xml</code> 生成 <code>ContactItemBinding</code> 类。如果 module 包是 <code>com.example.my.app</code>，则绑定类则放置在 <code>com.example.my.app.databinding</code> 包中。</p>
<p>通过调整 <code>data</code> 标签的 <code>class</code> 属性，绑定类可以重命名或放置在不同的包中。举例，下面的 layout 在当前的 module 的 <code>databinding</code> 包中 生成 <code>ContactItem</code> 类：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">data</span> <span class="class"><span class="keyword">class</span>="<span class="title">ContactItem</span>"&gt;</span></span><br><span class="line">    …</span><br><span class="line">&lt;/<span class="keyword">data</span>&gt;</span><br></pre></td></tr></table></figure>
<p>你可以通过在类名之前加上句点的方式在不同的包中生成绑定类。下面的例子在 module 包中生成绑定类：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">data</span> <span class="class"><span class="keyword">class</span>=".<span class="title">ContactItem</span>"&gt;</span></span><br><span class="line">    …</span><br><span class="line">&lt;/<span class="keyword">data</span>&gt;</span><br></pre></td></tr></table></figure>
<p>你也可以是用全包名来指定生成绑定类的名字。下面例子在 <code>com.example</code> 包中创建 <code>ContactItem</code> 绑定类：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">data</span> <span class="class"><span class="keyword">class</span>="<span class="title">com</span>.<span class="title">example</span>.<span class="title">ContactItem</span>"&gt;</span></span><br><span class="line">    …</span><br><span class="line">&lt;/<span class="keyword">data</span>&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Android Architecture Component </category>
            
            <category> kotlin </category>
            
            <category> DataBinding </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> architecture </tag>
            
            <tag> Android Architecture Component </tag>
            
            <tag> aac </tag>
            
            <tag> ViewModel </tag>
            
            <tag> LiveData </tag>
            
            <tag> DataBinding </tag>
            
            <tag> Lifecycles </tag>
            
            <tag> 翻译 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Architecture Component DataBinding -- 使用可观察的数据对象（翻译）]]></title>
      <url>/2018/04/15/android_architecture_components_observability/</url>
      <content type="html"><![CDATA[<h1 id="Android-Architecture-Component-DataBinding-–-使用可观察的数据对象（翻译）"><a href="#Android-Architecture-Component-DataBinding-–-使用可观察的数据对象（翻译）" class="headerlink" title="Android Architecture Component DataBinding – 使用可观察的数据对象（翻译）"></a>Android Architecture Component DataBinding – 使用可观察的数据对象（翻译）</h1><blockquote>
<p>原文：<a href="https://developer.android.com/topic/libraries/data-binding/observability" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/data-binding/observability</a></p>
</blockquote>
<p>可观察性是指对象将其数据的变化通知他人的能力。Data Binding 库允许你去创建对象，属性，可观察集合。</p>
<p>任何普通的对象都可以使用 Data Binding，但是修改修改之后不会自动引发 UI 的更新。Data Binding 可以使数据对象能够在其数据更改时通知其他对象，也就是监听器。有 3 种不同的可观察类的类型：<a href="https://developer.android.com/topic/libraries/data-binding/observability#observable_objects" target="_blank" rel="noopener"><code>objects</code></a>，<a href="https://developer.android.com/topic/libraries/data-binding/observability#observable_fields" target="_blank" rel="noopener"><code>fields</code></a> 和 <a href="https://developer.android.com/topic/libraries/data-binding/observability#observable_collections" target="_blank" rel="noopener"><code>collections</code></a>。</p>
<p>当这些可观察的数据对象之一绑定到 UI，并且数据对象的属性发生改变时，UI 将自动更新。</p>
<h2 id="Observable-fields"><a href="#Observable-fields" class="headerlink" title="Observable fields"></a>Observable fields</h2><p>创建实现了 <a href="https://developer.android.com/reference/android/databinding/Observable.html" target="_blank" rel="noopener"><code>Observable</code></a> 接口的类会涉及到一些工作，如果你的类只有几个属性，这就不值得这么做。在这种情况下，你可以使用泛型 <a href="https://developer.android.com/reference/android/databinding/Observable.html" target="_blank" rel="noopener"><code>Observable</code></a> 类和下面几种特定于原生的类来使得属性变得可观察：</p>
<ul>
<li><a href="https://developer.android.com/reference/android/databinding/ObservableBoolean.html" target="_blank" rel="noopener"><code>ObservableBoolean</code></a></li>
<li><a href="https://developer.android.com/reference/android/databinding/ObservableByte.html" target="_blank" rel="noopener"><code>ObservableByte</code></a></li>
<li><a href="https://developer.android.com/reference/android/databinding/ObservableChar.html" target="_blank" rel="noopener"><code>ObservableChar</code></a></li>
<li><a href="https://developer.android.com/reference/android/databinding/ObservableShort.html" target="_blank" rel="noopener"><code>ObservableShort</code></a></li>
<li><a href="https://developer.android.com/reference/android/databinding/ObservableInt.html" target="_blank" rel="noopener"><code>ObservableInt</code></a></li>
<li><a href="https://developer.android.com/reference/android/databinding/ObservableLong.html" target="_blank" rel="noopener"><code>ObservableLong</code></a></li>
<li><a href="https://developer.android.com/reference/android/databinding/ObservableFloat.html" target="_blank" rel="noopener"><code>ObservableFloat</code></a></li>
<li><a href="https://developer.android.com/reference/android/databinding/ObservableDouble.html" target="_blank" rel="noopener"><code>ObservableDouble</code></a></li>
<li><a href="https://developer.android.com/reference/android/databinding/ObservableParcelable.html" target="_blank" rel="noopener"><code>ObservableParcelable</code></a></li>
</ul>
<p>Observable fields 是仅包含了一个属性的可观察对象。原始数据类型版本是为了避免访问时的装箱和拆箱操作。要使用这个机制，创建一个在 Java 语言中的 <code>public final</code> 属性或者在 Kotlin 语言中的只读属性，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">val</span> firstName = ObservableField&lt;String&gt;()</span><br><span class="line">    <span class="keyword">val</span> lastName = ObservableField&lt;String&gt;()</span><br><span class="line">    <span class="keyword">val</span> age = ObservableInt()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要访问属性的值，使用 <a href="https://developer.android.com/reference/android/databinding/ObservableField.html#set" target="_blank" rel="noopener"><code>set()</code></a> 和 <a href="https://developer.android.com/reference/android/databinding/ObservableField.html#get" target="_blank" rel="noopener"><code>get()</code></a> 访问器方法，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user.firstName = <span class="string">"Google"</span></span><br><span class="line"><span class="keyword">val</span> age = user.age</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Android Studio 3.1 或者更高的版本允许你使用 LiveData 替换 Obervable 对象，它可以给你的 app 带来额外的好处。更多详情见 <a href="https://developer.android.com/topic/libraries/data-binding/architecture.html#livedata" target="_blank" rel="noopener">当数据改变时使用 LiveData 通知 UI</a>。</p>
</blockquote>
<h3 id="Observable-collections"><a href="#Observable-collections" class="headerlink" title="Observable collections"></a>Observable collections</h3><p>一些 app 使用动态结构来保存数据。Observable collections 允许你使用一个 key 来访问这些结构。<a href="https://developer.android.com/reference/android/databinding/ObservableArrayMap.html" target="_blank" rel="noopener"><code>ObservableArrayMap</code></a> 类在 key 是引用类型时候（比如 <code>String</code>）是很有用的，比如下面的例子：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ObservableArrayMap&lt;String, Any&gt;().apply &#123;</span><br><span class="line">    put(<span class="string">"firstName"</span>, <span class="string">"Google"</span>)</span><br><span class="line">    put(<span class="string">"lastName"</span>, <span class="string">"Inc."</span>)</span><br><span class="line">    put(<span class="string">"age"</span>, <span class="number">17</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 layout 中，可以使用 string keys 来访问，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"android.databinding.ObservableMap"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"ObservableMap&lt;String, Object&gt;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">"@&#123;user.lastName&#125;"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">"@&#123;String.valueOf(1 + (Integer)user.age)&#125;"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p><a href="https://developer.android.com/reference/android/databinding/ObservableArrayList.html" target="_blank" rel="noopener"><code>ObservableArrayList</code></a> 类在 key 是 integer 时很有用，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ObservableArrayList&lt;Any&gt;().apply &#123;</span><br><span class="line">    add(<span class="string">"Google"</span>)</span><br><span class="line">    add(<span class="string">"Inc."</span>)</span><br><span class="line">    add(<span class="number">17</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 layout 中，list 可以通过 indexes 访问，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"android.databinding.ObservableList"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"com.example.my.app.Fields"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"ObservableList&lt;Object&gt;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">'@&#123;user[Fields.LAST_NAME]&#125;'</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">'@&#123;String.valueOf(1 + (Integer)user[Fields.AGE])&#125;'</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Observable-objects"><a href="#Observable-objects" class="headerlink" title="Observable objects"></a>Observable objects</h2><p>一个实现了 <a href="https://developer.android.com/reference/android/databinding/Observable.html" target="_blank" rel="noopener"><code>Observable</code></a> 接口的类允许监听器的注册来针对 observable 对象上属性被改变时希望收到通知。</p>
<p><a href="https://developer.android.com/reference/android/databinding/Observable.html" target="_blank" rel="noopener"><code>Observable</code></a> 接口有一个增加和移除监听器的机制，但是你必须决定什么时候发送通知。为了让开发更简单，Data Binding 库提供了 <a href="https://developer.android.com/reference/android/databinding/BaseObservable.html" target="_blank" rel="noopener"><code>BaseObservable</code></a> 类，它实现了监听器的注册机制。实现了 <code>BaseObservable</code> 的类负责属性变化时的通知。在 getter 方法上面增加 <a href="https://developer.android.com/reference/android/databinding/Bindable.html" target="_blank" rel="noopener"><code>Bindable</code></a> 注解，在 setter 方法上面调用 <a href="https://developer.android.com/reference/android/databinding/BaseObservable.html#notifyPropertyChanged(int" target="_blank" rel="noopener"><code>notifyPropertyChanged()</code></a>) 方法，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> : <span class="type">BaseObservable</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@get:Bindable</span></span><br><span class="line">    <span class="keyword">var</span> firstName: String = <span class="string">""</span></span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            field = value</span><br><span class="line">            notifyPropertyChanged(BR.firstName)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@get:Bindable</span></span><br><span class="line">    <span class="keyword">var</span> lastName: String = <span class="string">""</span></span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            field = value</span><br><span class="line">            notifyPropertyChanged(BR.lastName)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Data Binding 在 module 包下面（包含了 resource ids）生成了一个名为 <code>BR</code> 的类用于数据绑定。<a href="https://developer.android.com/reference/android/databinding/Bindable.html" target="_blank" rel="noopener"><code>Bindable</code></a> 注解在编译时期在 <code>BR</code> 类中生成了一个 entry。如果数据类不能被修改，<a href="https://developer.android.com/reference/android/databinding/Observable.html" target="_blank" rel="noopener"><code>Observable</code></a> 接口可以通过使用一个<a href="https://developer.android.com/reference/android/databinding/PropertyChangeRegistry.html" target="_blank" rel="noopener"><code>PropertyChangeRegistry</code></a>来有效地注册和通知监听器的方式被实现。</p>
]]></content>
      
        <categories>
            
            <category> Android Architecture Component </category>
            
            <category> kotlin </category>
            
            <category> DataBinding </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> architecture </tag>
            
            <tag> Android Architecture Component </tag>
            
            <tag> aac </tag>
            
            <tag> ViewModel </tag>
            
            <tag> LiveData </tag>
            
            <tag> DataBinding </tag>
            
            <tag> Lifecycles </tag>
            
            <tag> 翻译 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Architecture Component DataBinding -- 布局和表达式（翻译）]]></title>
      <url>/2018/04/15/android_architecture_components_databinding_expressions/</url>
      <content type="html"><![CDATA[<h1 id="Android-Architecture-Component-DataBinding-–-布局和表达式（翻译）"><a href="#Android-Architecture-Component-DataBinding-–-布局和表达式（翻译）" class="headerlink" title="Android Architecture Component DataBinding – 布局和表达式（翻译）"></a>Android Architecture Component DataBinding – 布局和表达式（翻译）</h1><blockquote>
<p>原文：<a href="https://developer.android.com/topic/libraries/data-binding/expressions" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/data-binding/expressions</a></p>
</blockquote>
<p>表达式语言允许你编写表达式用于 view 派发的事件。Data binding 库自动生成要将 layout 中的 views 与数据对象绑定所需的类。</p>
<p>Data binding 布局有稍微的差别，从 layout 的根节点开始，然后是 <code>data</code> 标签和 <code>view</code> 根标签。这个 view 标签就是你在非 binding 布局文件的根标签。下面代码展示了一个 layout 文件的例子：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"com.example.User"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:text</span>=<span class="string">"@&#123;user.firstName&#125;"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:text</span>=<span class="string">"@&#123;user.lastName&#125;"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在 <code>data</code> 中的 <code>user</code> 变量描述了一个可能会在这个布局中使用的属性。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"com.example.User"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>布局中的表达式是使用 <code>&quot;@{}&quot;</code> 语法写在属性里面。这里，<code>TextView</code> 文本用来设置 <code>user</code> 变量的 <code>firstName</code> 属性。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:text</span>=<span class="string">"@&#123;user.firstName&#125;"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>布局表达式应该保持短小而简洁，因为它们不能被单元测试并且 IDE 支持有限。为了简化布局表达式，你可以使用自定义的 <a href="https://developer.android.com/topic/libraries/data-binding/binding-adapters" target="_blank" rel="noopener">binding adapters</a>。</p>
</blockquote>
<h2 id="数据对象"><a href="#数据对象" class="headerlink" title="数据对象"></a>数据对象</h2><p>假设我们现在有一个简单的对象来描述 <code>User</code> 实体：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span></span>(<span class="keyword">val</span> firstName: String, <span class="keyword">val</span> lastName: String)</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> String firstName;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> String lastName;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String firstName, String lastName)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">      <span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种类型的对象永远不会改变数据。在应用中，通常会有一次读取的数据此后永远不会更改的情况。还可以使用遵循一组约定的对象，例如在 java 中使用访问器方法，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String firstName;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String lastName;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String firstName, String lastName)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">      <span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getFirstName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.firstName;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getLastName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.lastName;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从数据绑定的角度来看，这两个类是等价的。用于 <a href="https://developer.android.com/reference/android/widget/TextView.html#attr_android:text" target="_blank" rel="noopener"><code>android:text</code></a> 属性的表达式 <code>@{user.firstName}</code> 访问前者类的 <code>firstName</code>属性，访问后者的 <code>getFirstName()</code> 方法。或者如果存在的话会访问 <code>firstName()</code> 方法。</p>
<h2 id="绑定数据"><a href="#绑定数据" class="headerlink" title="绑定数据"></a>绑定数据</h2><p>每个 layout 文件都会生成一个 binding class。默认情况下，类名基于 layout 文件的名字。将其转换为 Pascal 大小写, 并向其添加 <em>Binding</em> 后缀。上面的 layout 名字是 <code>activity_main.xml</code> 所以相应生成的类是 <code>ActivityMainBinding</code>。这个类会持有从 layout 属性（比如，<code>user</code> 变量）到 layout 的 views 的所有绑定，并知道如何为绑定表达式赋值。推荐的方法去创建 binding 是在 inflating 布局的时候，如下代码所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> binding: ActivityMainBinding = DataBindingUtil.setContentView(</span><br><span class="line">            <span class="keyword">this</span>, R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">    binding.user = User(<span class="string">"Test"</span>, <span class="string">"User"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在运行时，app 在 UI 上显示 <strong>Test</strong> 用户。或者你可以使用 <a href="https://developer.android.com/reference/android/view/LayoutInflater.html" target="_blank" rel="noopener"><code>LayoutInflater</code></a> 来获取 view，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> binding: ActivityMainBinding = ActivityMainBinding.inflate(getLayoutInflater())</span><br></pre></td></tr></table></figure>
<p>如果你在 <a href="https://developer.android.com/reference/android/app/Fragment.html" target="_blank" rel="noopener"><code>Fragment</code></a>，<a href="https://developer.android.com/reference/android/widget/ListView.html" target="_blank" rel="noopener"><code>ListView</code></a>，<a href="https://developer.android.com/reference/android/support/v7/widget/RecyclerView.html" target="_blank" rel="noopener"><code>RecyclerView</code></a> adapter 中使用 data binding，你可能更喜欢使用 bindings classes 的 <a href="https://developer.android.com/reference/android/databinding/DataBindingUtil.html#inflate(android.view.LayoutInflater,%20int,%20android.view.ViewGroup,%20boolean,%20android.databinding.DataBindingComponent" target="_blank" rel="noopener"><code>inflate</code></a>) 方法，或者 <a href="https://developer.android.com/reference/android/databinding/DataBindingUtil" target="_blank" rel="noopener"><code>DataBindingUtil</code></a> 类，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> listItemBinding = ListItemBinding.inflate(layoutInflater, viewGroup, <span class="literal">false</span>)</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">val</span> listItemBinding = DataBindingUtil.inflate(layoutInflater, R.layout.list_item, viewGroup, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure>
<h2 id="表达语言"><a href="#表达语言" class="headerlink" title="表达语言"></a>表达语言</h2><h3 id="常见功能"><a href="#常见功能" class="headerlink" title="常见功能"></a>常见功能</h3><p>表达式语言看起来很像托管代码中找到的表达式。你可以在表达式语言中使用以下操作符和关键字：</p>
<ul>
<li>数学，<code>+ - / * %</code></li>
<li>字符串连接，<code>+</code></li>
<li>逻辑，<code>&amp;&amp; ||</code></li>
<li>二进制，<code>&amp; | ^</code></li>
<li>一元，<code>+ - ! ~</code></li>
<li>移位，<code>&gt;&gt; &gt;&gt;&gt; &lt;&lt;</code></li>
<li>比较，<code>== &gt; &lt; &gt;= &lt;=</code></li>
<li><code>instanceof</code></li>
<li>分组，<code>()</code></li>
<li>源文本 - 字符，字符串，数字，<code>null</code></li>
<li>转型</li>
<li>方法调用</li>
<li>属性访问</li>
<li>数组访问</li>
<li>三元操作法 <code>?:</code></li>
</ul>
<p>举例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">android:text="@&#123;String.valueOf(index + 1)&#125;"</span><br><span class="line">android:visibility="@&#123;age <span class="tag">&lt; <span class="attr">13</span> ? <span class="attr">View.GONE</span> <span class="attr">:</span> <span class="attr">View.VISIBLE</span>&#125;"</span></span><br><span class="line"><span class="tag"><span class="attr">android:transitionName</span>=<span class="string">'@&#123;"image_" + id&#125;'</span></span></span><br></pre></td></tr></table></figure>
<h3 id="缺失操作"><a href="#缺失操作" class="headerlink" title="缺失操作"></a>缺失操作</h3><p>下面在代码中可以使用的操作在表达式语法中是缺失的：</p>
<ul>
<li><code>this</code></li>
<li><code>super</code></li>
<li><code>new</code></li>
<li>显示泛型调用</li>
</ul>
<h3 id="空合运算符"><a href="#空合运算符" class="headerlink" title="空合运算符"></a>空合运算符</h3><p>空合运算符（<code>??</code>）如果左边不是 <code>null</code> 则选择左边，否则选右边。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:text="@&#123;user.displayName ?? user.lastName&#125;"</span><br></pre></td></tr></table></figure>
<p>这在功能上等效于：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:text="@&#123;user.displayName != null ? user.displayName : user.lastName&#125;"</span><br></pre></td></tr></table></figure>
<h3 id="属性引用"><a href="#属性引用" class="headerlink" title="属性引用"></a>属性引用</h3><p>表达式可以通过使用以下格式引用类中的属性，该格式对于字段，getters 和 <a href="https://developer.android.com/reference/android/databinding/ObservableField.html" target="_blank" rel="noopener"><code>ObservableField</code></a> 对象是相同的：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:text="@&#123;user.lastName&#125;"</span><br></pre></td></tr></table></figure>
<h3 id="避免空指针异常"><a href="#避免空指针异常" class="headerlink" title="避免空指针异常"></a>避免空指针异常</h3><p>生成的 data binding 代码会自动检查 <code>null</code> 和避免空指针异常。举例，在表达式 <code>@{user.name}</code>，如果 <code>user</code> 是 null，<code>user.name</code> 被赋值 <code>null</code> 的默认值。如果你引用了 <code>user.age</code>，age 是 <code>int</code> 类型，那么 data binding 使用默认值 <code>0</code>。</p>
<h3 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h3><p>常用的集合，比如 arrays，lists，sparse list 和 map，可以方便地使用 <code>[]</code> 来访问。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"android.util.SparseArray"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"java.util.Map"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"java.util.List"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"list"</span> <span class="attr">type</span>=<span class="string">"List&lt;String&gt;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"sparse"</span> <span class="attr">type</span>=<span class="string">"SparseArray&lt;String&gt;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"map"</span> <span class="attr">type</span>=<span class="string">"Map&lt;String, String&gt;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"index"</span> <span class="attr">type</span>=<span class="string">"int"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"key"</span> <span class="attr">type</span>=<span class="string">"String"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">…</span><br><span class="line">android:text="@&#123;list[index]&#125;"</span><br><span class="line">…</span><br><span class="line">android:text="@&#123;sparse[index]&#125;"</span><br><span class="line">…</span><br><span class="line">android:text="@&#123;map[key]&#125;"</span><br></pre></td></tr></table></figure>
<blockquote>
<p>你还可以使用 <strong>object.key</strong> 表示法引用 map 中的值。举例，上面例子中的 @{<strong>map[key]</strong>} 我们可以替换为 @{<strong>map.key</strong>}。</p>
</blockquote>
<h3 id="String-源文本"><a href="#String-源文本" class="headerlink" title="String 源文本"></a>String 源文本</h3><p>你可以使用单引号包围属性值，这允许您在表达式中使用双引号，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:text='@&#123;map["firstName"]&#125;'</span><br></pre></td></tr></table></figure>
<p>也可以使用双引号来包围属性值。当我们这样做时，字符串文本应使用反引号 `：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:text="@&#123;map[`firstName`]&#125;"</span><br></pre></td></tr></table></figure>
<h3 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h3><p>你可以在表达式中使用以下语法来访问 resources：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:padding="@&#123;large? @dimen/largePadding : @dimen/smallPadding&#125;"</span><br></pre></td></tr></table></figure>
<p>格式化 string 和 plurals 可能需要通过提供参数来计算：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android:text="@&#123;@string/nameFormat(firstName, lastName)&#125;"</span><br><span class="line">android:text="@&#123;@plurals/banana(bananaCount)&#125;"</span><br></pre></td></tr></table></figure>
<p>当一个 plural 使用多个参数，则所有参数都应该被传入：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  Have an orange</span><br><span class="line">  Have %d oranges</span><br><span class="line"></span><br><span class="line">android:text="@&#123;@plurals/orange(orangeCount, orangeCount)&#125;"</span><br></pre></td></tr></table></figure>
<p>一些资源需要显式类型计算，如下表所示:</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>普通引用</th>
<th>表达式引用</th>
</tr>
</thead>
<tbody>
<tr>
<td>String[]</td>
<td>@array</td>
<td>@stringArray</td>
</tr>
<tr>
<td>int[]</td>
<td>@array</td>
<td>@intArray</td>
</tr>
<tr>
<td>TypedArray</td>
<td>@array</td>
<td>@typedArray</td>
</tr>
<tr>
<td>Animator</td>
<td>@animator</td>
<td>@animator</td>
</tr>
<tr>
<td>StateListAnimator</td>
<td>@animator</td>
<td>@stateListAnimator</td>
</tr>
<tr>
<td>color</td>
<td>int</td>
<td>@color</td>
<td>@color</td>
</tr>
<tr>
<td>ColorStateList</td>
<td>@color</td>
<td>@colorStateList</td>
</tr>
</tbody>
</table>
<h2 id="事件处理"><a href="#事件处理" class="headerlink" title="事件处理"></a>事件处理</h2><p>Data binding 允许你编写表达式来处理从 views 派发的事件（比如，<a href="https://developer.android.com/reference/android/view/View.OnClickListener.html#onClick(android.view.View" target="_blank" rel="noopener"><code>onClick</code></a>) 方法）。事件属性名由监听器方法名确定，但有少数例外。举例，<a href="https://developer.android.com/reference/android/view/View.OnClickListener.html" target="_blank" rel="noopener"><code>View.OnClickListener</code></a> 有一个方法 <a href="https://developer.android.com/reference/android/view/View.OnClickListener.html#onClick(android.view.View" target="_blank" rel="noopener"><code>onClick</code></a>)，所以这个 event 的属性是 <code>android:onClick</code>。</p>
<p>对于点击事件，有一些特殊的事件处理器不使用 <code>android:onClick</code> 而需要一个属性，以避免冲突。你可以使用下面属性来避免这种类型的冲突：</p>
<table>
<thead>
<tr>
<th>类</th>
<th>监听器设置</th>
<th>属性</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/SearchView.html" target="_blank" rel="noopener"><code>SearchView</code></a></td>
<td><a href="https://developer.android.com/reference/android/widget/SearchView.html#setOnSearchClickListener(android.view.View.OnClickListener" target="_blank" rel="noopener"><code>setOnSearchClickListener(View.OnClickListener)</code></a>)</td>
<td>android:onSearchClick</td>
</tr>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/ZoomControls.html" target="_blank" rel="noopener"><code>ZoomControls</code></a></td>
<td><a href="https://developer.android.com/reference/android/widget/ZoomControls.html#setOnZoomInClickListener(android.view.View.OnClickListener" target="_blank" rel="noopener"><code>setOnZoomInClickListener(View.OnClickListener)</code></a>)</td>
<td>android:onZoomIn</td>
</tr>
<tr>
<td><a href="https://developer.android.com/reference/android/widget/ZoomControls.html" target="_blank" rel="noopener"><code>ZoomControls</code></a></td>
<td><a href="https://developer.android.com/reference/android/widget/ZoomControls.html#setOnZoomOutClickListener(android.view.View.OnClickListener" target="_blank" rel="noopener"><code>setOnZoomOutClickListener(View.OnClickListener)</code></a>)</td>
<td>android:onZoomOut</td>
</tr>
</tbody>
</table>
<p>你可以使用以下机制来处理事件：</p>
<ul>
<li><a href="https://developer.android.com/topic/libraries/data-binding/expressions#method_references" target="_blank" rel="noopener">方法引用</a>：在你的表达式中，你可以引用符合监听器方法签名的方法。当表达式计算结果是方法引用时，Data binding 包装方法引用和所有者的对象，并在目标 view 上设置监听器。如果表达式计算结果为 <code>null</code>，Data binding 不会创建监听器并且设置监听器为 <code>null</code>。</li>
<li><a href="https://developer.android.com/topic/libraries/data-binding/expressions#listener_bindings" target="_blank" rel="noopener">监听器绑定</a>：当事件发生时，lambda 表达式会被计算。Data binding 总是创建监听器并设置在 view 上。当事件被派发，监听器将计算 lambda 表达式。</li>
</ul>
<h3 id="方法引用"><a href="#方法引用" class="headerlink" title="方法引用"></a>方法引用</h3><p>事件可以直接绑定到处理的方法上，类似 <a href="https://developer.android.com/reference/android/view/View.html#attr_android:onClick" target="_blank" rel="noopener"><code>android:onClick</code></a> 可以被分配到一个 Activity 中的一个方法上。与 <a href="https://developer.android.com/reference/android/view/View.html" target="_blank" rel="noopener"><code>View</code></a> <code>onClick</code> 属性相比，一个主要的优势是表达式在编译时期被处理，因此如果方法不存在或者签名不准确，你将会收到一个编译错误。</p>
<p>方法引用与监听器绑定两者的主要区别是实际的监听器实现在数据被绑定时创建，而不是在事件触发的时候。如果你希望在事件发生的时候计算表达式，你应该使用<a href="https://developer.android.com/topic/libraries/data-binding/expressions#listener_bindings" target="_blank" rel="noopener">监听器绑定</a>。</p>
<p>要将事件分配给它的处理器，就使用正常的绑定表达式，值是要调用的方法名。例如，思考下面的布局数据对象示例：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHandlers</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onClickFriend</span><span class="params">(view: <span class="type">View</span>)</span></span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>绑定表达式可以为一个 view 分配一个点击监听器到 <code>onClickFriend()</code> 方法，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"handlers"</span> <span class="attr">type</span>=<span class="string">"com.example.MyHandlers"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"com.example.User"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:text</span>=<span class="string">"@&#123;user.firstName&#125;"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:onClick</span>=<span class="string">"@&#123;handlers::onClickFriend&#125;"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>表达式中的方法签名必须跟监听器对象的方法签名确切匹配。</p>
</blockquote>
<h3 id="监听器绑定"><a href="#监听器绑定" class="headerlink" title="监听器绑定"></a>监听器绑定</h3><p>监听器绑定是在事件发生的时候绑定表达式。它们与方法引用相似，但是它们允许你运行任意数据绑定表达式。这个功能在 Android Gradle Plugin 2.0 及之后版本可用。</p>
<p>在方法引用，方法的参数必须跟事件监听器的参数匹配。在监听器绑定中，你只需要返回值与监听器期望的返回值（除非是 void）匹配即可。举例，思考下面包含 <code>onSaveClick()</code> 方法的 presenter 类：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Presenter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onSaveClick</span><span class="params">(task: <span class="type">Task</span>)</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着，你可以绑定点击事件到 <code>onSaveClick()</code> 方法， 如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;</span><br><span class="line">&lt;layout xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span><br><span class="line">    &lt;<span class="keyword">data</span>&gt;</span><br><span class="line">        &lt;variable name=<span class="string">"task"</span> type=<span class="string">"com.android.example.Task"</span> /&gt;</span><br><span class="line">        &lt;variable name=<span class="string">"presenter"</span> type=<span class="string">"com.android.example.Presenter"</span> /&gt;</span><br><span class="line">    &lt;/<span class="keyword">data</span>&gt;</span><br><span class="line">    &lt;LinearLayout android:layout_width=<span class="string">"match_parent"</span> android:layout_height=<span class="string">"match_parent"</span>&gt;</span><br><span class="line">        &lt;Button android:layout_width=<span class="string">"wrap_content"</span> android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">        android:onClick=<span class="string">"@&#123;() -&gt; presenter.onSaveClick(task)&#125;"</span> /&gt;</span><br><span class="line">    &lt;/LinearLayout&gt;</span><br><span class="line">&lt;/layout&gt;</span><br></pre></td></tr></table></figure>
<p>当一个回调在表达式中被使用，data binding 自动创建必要的监听器并根据事件注册它。当 view 触发这个事件，data binding 计算所给的表达。与正则表达式绑定一样，在计算这些监听器表达式时，你仍然得到数据绑定的 null 和线程安全性。</p>
<p>在上面的例子中，我们没有定义传入 <a href="https://developer.android.com/reference/android/view/View.OnClickListener.html#onClick(android.view.View" target="_blank" rel="noopener"><code>onClick(View)</code></a>) 的 <code>view</code> 参数。监听器绑定针对监听器参数提供了两种选择：你可以忽略方法的所有参数或者命名它们。如果你更喜欢命名参数，则可以在表达式中使用它们。比如，上面的表达式可以按照以下重写：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:onClick="@&#123;(view) -&gt; presenter.onSaveClick(task)&#125;"</span><br></pre></td></tr></table></figure>
<p>或者你想在表达式中使用参数，它可以如下工作：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Presenter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onSaveClick</span><span class="params">(view: <span class="type">View</span>, task: <span class="type">Task</span>)</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:onClick="@&#123;(theView) -&gt; presenter.onSaveClick(theView, task)&#125;"</span><br></pre></td></tr></table></figure>
<p>你可以使用 lambda 表达式使用多个参数：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Presenter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onCompletedChanged</span><span class="params">(task: <span class="type">Task</span>, completed: <span class="type">Boolean</span>)</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">CheckBox</span> <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span> <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:onCheckedChanged</span>=<span class="string">"@&#123;(cb, isChecked) -&gt; presenter.completeChanged(task, isChecked)&#125;"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果你监听的事件返回的的类型不是 <code>void</code>，你的表达式也必须返回相同类型的类型。举例，如果你想监听 long click 事件，你的表达式应该返回一个 boolean。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Presenter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onLongClick</span><span class="params">(view: <span class="type">View</span>, task: <span class="type">Task</span>)</span></span>: <span class="built_in">Boolean</span> &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:onLongClick="@&#123;(theView) -&gt; presenter.onLongClick(theView, task)&#125;"</span><br></pre></td></tr></table></figure>
<p>如果因为 <code>null</code> 对象无法计算表达式，data binding 会返回那个类型的默认值。比如，引用类型的 <code>null</code>，<code>int</code> 类型的 <code>0</code>，<code>boolean</code> 类型的 <code>false</code> 等等。</p>
<p>如果你需要在表达式中使用条件（比如，三元），你可以把 <code>void</code> 作为一个符号使用。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:onClick="@&#123;(v) -&gt; v.isVisible() ? doSomething() : void&#125;"</span><br></pre></td></tr></table></figure>
<p><strong>避免复杂的监听器</strong></p>
<p>监听器表达式是强大的，并且可以使得你的代码更容易阅读。另一方面，包含负责表达式的监听器会使得你的 layout 难以阅读和维护。这些表达式应该非常简单，就像将可用数据从 UI 传递到回调方法一样。你应该在从监听器表达式调用的回调方法中实现任何业务逻辑。</p>
<h2 id="Imports-variables-和-includes"><a href="#Imports-variables-和-includes" class="headerlink" title="Imports, variables, 和 includes"></a>Imports, variables, 和 includes</h2><p>Data binding 库提供了 imports，variables，includes 等功能。Imports 让你在 layout 文件中引用类变得更简单。Variables 允许你描述一个可以在绑定表达式中使用的属性。Includes 让你在 app 中复用复杂的 layouts。</p>
<h3 id="Imports"><a href="#Imports" class="headerlink" title="Imports"></a>Imports</h3><p>Imports 允许你在 layouts 文件中简单地引用类，就像托管代码中那样。在 <code>data</code> 标签中可以有零个或者多个 <code>import</code> 标签。下面的示例代码在 layout 文件中导入 <a href="https://developer.android.com/reference/android/view/View.html" target="_blank" rel="noopener"><code>View</code></a> 类：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"android.view.View"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>导入 <a href="https://developer.android.com/reference/android/view/View.html" target="_blank" rel="noopener"><code>View</code></a> 类允许你从绑定表达式中引用它。下面的代码展示了如何引用 <code>View</code> 类中的 <a href="https://developer.android.com/reference/android/view/View.html#VISIBLE" target="_blank" rel="noopener"><code>VISIBLE</code></a> 和 <a href="https://developer.android.com/reference/android/view/View.html#GONE" target="_blank" rel="noopener"><code>GONE</code></a> 常量：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:text</span>=<span class="string">"@&#123;user.lastName&#125;"</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:visibility</span>=<span class="string">"@&#123;user.isAdult ? View.VISIBLE : View.GONE&#125;"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h4><p>当类名冲突时，其中一个应该被重命名一个别名。下面例子重命名 <code>com.example.real.estate</code> 包中的 <code>View</code> 为 <code>Vista</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"android.view.View"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"com.example.real.estate.View"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">alias</span>=<span class="string">"Vista"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>你可以在 layout 文件中使用 <code>Vista</code> 去引用 <code>com.example.real.estate.View</code> 和使用 <code>View</code> 引用 <code>android.view.View</code>。</p>
<h4 id="Import-其它-class"><a href="#Import-其它-class" class="headerlink" title="Import 其它 class"></a>Import 其它 class</h4><p>导入的类型可以在 variables 和表达式中作为类型来引用。下面的例子展示了 <code>User</code> 和 <code>List</code> 作为变量的类型使用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"com.example.User"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"java.util.List"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"User"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"userList"</span> <span class="attr">type</span>=<span class="string">"List&lt;User&gt;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Android Studio 目前还不能处理导入，所以对于完成导入的变量，你的 IDE 还不能自动补全。你的 app 仍然会编译，并且你可以通过定义的变量的完全限定名来解决 IDE 问题。</p>
</blockquote>
<p>你还可以使用导入的类型对表达式的一部分进行转型。下面的例子把 <code>connection</code> 属性转型为 <code>User</code> 类型：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:text</span>=<span class="string">"@&#123;((User)(user.connection)).lastName&#125;"</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>被导入的类型在表达式中可能也会被引用静态属性和方法来使用。下面的代码导入来 <code>MyStringUtils</code> 类并引用了它的 <code>capitalize</code> 方法：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"com.example.MyStringUtils"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"com.example.User"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:text</span>=<span class="string">"@&#123;MyStringUtils.capitalize(user.lastName)&#125;"</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">   <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>就像托管代码那样，<code>java.lang.*</code> 是被自动导入了的。</p>
<h3 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h3><p>在 <code>data</code> 标签下你可以使用多个 <code>variable</code> 标签。每个 <code>variable</code> 标签描述了一个属性，它会在 layout 文件的绑定表达式中被使用。下面的例子声明了 <code>user</code>，<code>image</code> 和 <code>note</code> 变量：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">import</span> <span class="attr">type</span>=<span class="string">"android.graphics.drawable.Drawable"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"com.example.User"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"image"</span> <span class="attr">type</span>=<span class="string">"Drawable"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"note"</span> <span class="attr">type</span>=<span class="string">"String"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Variable 类型会在编译时期被检查，所以如果一个变量实现了 <a href="https://developer.android.com/reference/android/databinding/Observable.html" target="_blank" rel="noopener"><code>Observable</code></a> 或者是一个 <a href="https://developer.android.com/topic/libraries/data-binding/observability.html#observable_collections" target="_blank" rel="noopener"><code>observable collection</code></a>，则会反映在类型中。如果 variable 是没有实现 <code>Observable</code> 接口的一个基类或者一个接口，那这个 variable 就<em>不能</em>被观察。</p>
<p>当不同的配置有不同的配置文件时（比如，横向或者纵向），variables 将被组合。这些 layout 文件之间不能有冲突的 variable 定义。</p>
<p>生成的 binding 类针对每个描述的 variable 都有一个 setter 和 getter 方法。这些 variables 值都是代码中的默认值，直到 setter 方法被调用 —— 引用类型的 <code>null</code>，<code>int</code> 类型的 <code>0</code>，<code>boolean</code> 类型的 <code>false</code> 等等。</p>
<p>一个名为 <code>context</code> 的特殊的 variable 会被生成以便于根据需要可以在绑定表达式中使用。<code>context</code> 值是从根 view 的 <a href="https://developer.android.com/reference/android/view/View.html#getContext(" target="_blank" rel="noopener"><code>getContext()</code></a>) 方法返回的 <a href="https://developer.android.com/reference/android/content/Context.html" target="_blank" rel="noopener"><code>Context</code></a> 对象。<code>context</code> 变量会被具有该名称的显式变量声明所覆盖。</p>
<h3 id="Includes"><a href="#Includes" class="headerlink" title="Includes"></a>Includes</h3><p>通过使用 app 命名空间和属性中的变量名，可以将变量从包含布局传递到包含的布局绑定中。下面的例子展示了 <code>name.xml</code> 和 <code>contact.xml</code> 中的 <code>user</code> 变量。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:bind</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"com.example.User"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">"@layout/name"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">bind:user</span>=<span class="string">"@&#123;user&#125;"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">"@layout/contact"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">bind:user</span>=<span class="string">"@&#123;user&#125;"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Data Binding 不支持将其作为 merge 标签的直接子级包括在内。举例，<em>下面的 layout 不支持</em>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:bind</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"com.example.User"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">merge</span>&gt;</span><span class="comment">&lt;!-- Doesn't work --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">"@layout/name"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">bind:user</span>=<span class="string">"@&#123;user&#125;"</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">"@layout/contact"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">bind:user</span>=<span class="string">"@&#123;user&#125;"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">merge</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Android Architecture Component </category>
            
            <category> kotlin </category>
            
            <category> DataBinding </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> architecture </tag>
            
            <tag> Android Architecture Component </tag>
            
            <tag> aac </tag>
            
            <tag> ViewModel </tag>
            
            <tag> LiveData </tag>
            
            <tag> DataBinding </tag>
            
            <tag> Lifecycles </tag>
            
            <tag> 翻译 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Architecture Component DataBinding -- Get Started（翻译）]]></title>
      <url>/2018/04/15/android_architecture_components_databinding_get_started/</url>
      <content type="html"><![CDATA[<h1 id="Android-Architecture-Component-DataBinding-–-Get-Started（翻译）"><a href="#Android-Architecture-Component-DataBinding-–-Get-Started（翻译）" class="headerlink" title="Android Architecture Component DataBinding – Get Started（翻译）"></a>Android Architecture Component DataBinding – Get Started（翻译）</h1><blockquote>
<p>原文：<a href="https://developer.android.com/topic/libraries/data-binding/start" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/data-binding/start</a></p>
</blockquote>
<p>学习如何让你的开发环境准备好使用 Data Binding 库，包括支持 android studio 中的 Data Binding 代码。</p>
<p>Data Binding 库提供了灵活性和广泛的兼容性 —— 它是一个支持库，所以你可以在运行 Android 4.0（API level 14）及以上版本的设备上使用它。</p>
<p>推荐在你的项目中使用最新的 Android Gradle 插件。但是，data binding 支持 1.5.0 及以上版本。更多详情，见如何<a href="https://developer.android.com/studio/releases/gradle-plugin.html#updating-plugin" target="_blank" rel="noopener">更新 Android Gradle 插件</a>。</p>
<h2 id="构建环境"><a href="#构建环境" class="headerlink" title="构建环境"></a>构建环境</h2><p>要开始使用 Data Binding，在 Android SDK Manager 的 <strong>Support Repository</strong> 中下载库。更多详情见<a href="https://developer.android.com/studio/intro/update.html" target="_blank" rel="noopener">更新 IDE 和 SDK Tools</a>。</p>
<p>要配置你的 app 使用 data binding，在你的 app module 的 <code>build.gradle</code> 文件中增加 <code>dataBinding</code> 标签，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    dataBinding &#123;</span><br><span class="line">        enabled = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：如果你的 app 依赖了使用 data binding 的库，就算你的 app module 没有直接使用 data binding，也必须在你的 app moudle 中进行配置。</p>
</blockquote>
<h2 id="Android-Studio-支持-data-binding"><a href="#Android-Studio-支持-data-binding" class="headerlink" title="Android Studio 支持 data binding"></a>Android Studio 支持 data binding</h2><p>Android studio 支持 Data Binding 代码的许多编辑功能。举例，它支持以下 data binding 表达式的功能：</p>
<ul>
<li>语法高亮</li>
<li>表达式语言的语法错误标记</li>
<li>xml 代码编译</li>
<li>引用，包括 <a href="https://www.jetbrains.com/help/idea/2017.1/navigation-in-source-code.html" target="_blank" rel="noopener">导航</a> （比如导航跳转到声明）和 <a href="https://www.jetbrains.com/help/idea/2017.1/viewing-inline-documentation.html" target="_blank" rel="noopener">快速文档</a></li>
</ul>
<blockquote>
<p>小心：数组和<a href="https://docs.oracle.com/javase/tutorial/java/generics/types.html" target="_blank" rel="noopener">泛型类型</a>，比如 <a href="https://developer.android.com/reference/android/databinding/Observable.html" target="_blank" rel="noopener">Observable</a> 类，可能错误提示不准确。</p>
</blockquote>
<p><strong>Layout Editor</strong> 的 <strong>Preview</strong> 窗口会展示 data binding 表达式的默认值如果提供了的话。举例，<strong>Preview</strong> 窗口在如下声明的 <code>TextView</code> 控件中显示 <code>my_default</code> 值：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">"@&#123;user.firstName, default=my_default&#125;"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果你只需要在项目的设计阶段显示默认值，你可以使用 <code>tools</code> 属性来代替默认的表达式值，就像 <a href="https://developer.android.com/studio/write/tool-attributes.html" target="_blank" rel="noopener">Tools Attributes Reference</a> 中描述的那样。</p>
<h2 id="用于绑定类的新-data-binding-编译器"><a href="#用于绑定类的新-data-binding-编译器" class="headerlink" title="用于绑定类的新 data binding 编译器"></a>用于绑定类的新 data binding 编译器</h2><p>Android Gradle plugin 版本 <code>3.1.0-alpha06</code> 包括了一个新的 data binding 编译器用于生成绑定类。在大多数情况下，新的编译器会增量创建绑定类，这加快了构建过程。学习更多关于绑定类，见 <strong><a href="https://developer.android.com/topic/libraries/data-binding/generated-binding" target="_blank" rel="noopener">生成的绑定类</a></strong>。</p>
<p>以前版本的 data binding 编译器在编译你的托管代码的同一步骤中生成绑定类。如果你的托管代码编译失败，你可能会得到多个 binding class 找不到的错误。新的 data binding 编译器通过在编译器生成你的 app 之前生成绑定类来避免这些错误。</p>
<p>要打开新的 data binding 编译器，在你的 <code>gradle.properties</code> 文件中增加如下选项：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android.databinding.enableV2=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>你也可以在 gradle 命令行中增加以下参数来启用新的编译器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Pandroid.databinding.enableV2=true</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：Android Plugin 3.1 版本的新的 data binding 编译器向后不兼容。你需要在启用此功能的情况下生成所有绑定类，以使用增量编译。但是，Android Plugin 3.2 版中的新编译器与以前版本生成的绑定类兼容。新的编译器在 3.2 版本中默认启用。</p>
</blockquote>
<p>启用新的 data binding 编译器时，会有以下行为变化：</p>
<ul>
<li>在编译你的托管代码之前，Android Gradle plugin 会为你的 layouts 生成 binding class。</li>
<li>如果一个 layout 包含在多个目标资源配置，对于所有共享相同的资源 id（不包括视图类型）的views，data binding 库会使用 <code>android.view.View</code> 作为默认的 view 类型</li>
<li>Library modules 的 Binding class，会被编译打包到相应的 AAR 文件中。 App modules 依赖的这些 library modules 不需要再去生成这些 binding class。更多关于 AAR 文件的详情，见 <a href="https://developer.android.com/studio/projects/android-library" target="_blank" rel="noopener">创建一个 Android 库</a>。</li>
<li>一个 module 的 binding adapters 不能更改模块依赖的 adapter 的行为。Binding adapters 只能影响自己 module 的代码 和 module 的使用者的代码。</li>
</ul>
]]></content>
      
        <categories>
            
            <category> Android Architecture Component </category>
            
            <category> kotlin </category>
            
            <category> DataBinding </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> architecture </tag>
            
            <tag> Android Architecture Component </tag>
            
            <tag> aac </tag>
            
            <tag> ViewModel </tag>
            
            <tag> LiveData </tag>
            
            <tag> DataBinding </tag>
            
            <tag> Lifecycles </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Architecture Component DataBinding -- 概要（翻译）]]></title>
      <url>/2018/04/15/android_architecture_components_databinding_overview/</url>
      <content type="html"><![CDATA[<h1 id="Android-Architecture-Component-DataBinding-–-概要（翻译）"><a href="#Android-Architecture-Component-DataBinding-–-概要（翻译）" class="headerlink" title="Android Architecture Component DataBinding – 概要（翻译）"></a>Android Architecture Component DataBinding – 概要（翻译）</h1><blockquote>
<p>原文：<a href="https://developer.android.com/topic/libraries/data-binding/index" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/data-binding/index</a></p>
</blockquote>
<p>Data Binding 库是一个允许你在你的 app 中使用声明性格式而非动态的方式绑定 layout 的 UI 组件到数据源的支持库。</p>
<p>Layout 通常是使用代码在 activities 中调用 UI 层额的方法来定义的。举例，下面代码调用 <code>[findViewById](https://developer.android.com/reference/android/app/Activity.html#findViewById(int))</code> 来找到一个 <code>[TextView](https://developer.android.com/reference/android/widget/TextView.html)</code> 控件并把它绑定到 <code>viewModel</code> 变量的 <code>userName</code> 属性：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">findViewById&lt;TextView&gt;(R.id.sample_text).apply &#123;</span><br><span class="line">    text = viewModel.userName</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面的例子展示了怎样使用 Data Binding 库直接在 layout 文件中将 text 分配给控件。这样就不需要调用以上任何的 java 代码。注意在分配表达式中使用 <code>@{}</code> 语法:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">"@&#123;viewmodel.userName&#125;"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过对 layout 文件中的绑定组件，你可以移除 Activities 中很多的 UI 层的调用，使其更简单和更易于维护。这还可以提高应用的性能，并有助于防止内存泄漏和空指针异常。</p>
<h2 id="使用-Data-Binding-库"><a href="#使用-Data-Binding-库" class="headerlink" title="使用 Data Binding 库"></a>使用 Data Binding 库</h2><p>通过以下页面了解如何在 android 应用中使用 Data Binding 库。</p>
<h3 id="Get-Started"><a href="#Get-Started" class="headerlink" title="Get Started"></a><a href="https://developer.android.com/topic/libraries/data-binding/start.html" target="_blank" rel="noopener">Get Started</a></h3><p>了解如何让你的开发环境准备好使用 data binding 库，包括支持 android studio 中的 data binding 代码。</p>
<h3 id="布局和绑定表达式"><a href="#布局和绑定表达式" class="headerlink" title="布局和绑定表达式"></a><a href="https://developer.android.com/topic/libraries/data-binding/expressions.html" target="_blank" rel="noopener">布局和绑定表达式</a></h3><p>表达式语言允许你编写连接变量到 layout 中的 view 的表达式。Data binding 库会自动生成将 layout 中的 view 与数据对象绑定所需的类。该库提供了 import，variables 等功能，包括可在 layout 中使用的功能。</p>
<p>这些库的特性与你存在的布局是无缝共存的。举例，可以在表达式中使用的绑定变量是被定义在  UI 布局的根标签同级的 <code>data</code> 标签。两者标签都被包含在一个 <code>layout</code> 标签中，就如下面例子中这样：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">"viewmodel"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">"com.myapp.data.ViewModel"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ConstraintLayout...</span> /&gt;</span> <span class="comment">&lt;!-- UI layout's root element --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="使用可观察的数据对象"><a href="#使用可观察的数据对象" class="headerlink" title="使用可观察的数据对象"></a><a href="https://developer.android.com/topic/libraries/data-binding/observability.html" target="_blank" rel="noopener">使用可观察的数据对象</a></h3><p>Data binding 库提供了类和方法来很容易地观察数据的改变。当底层数据源发生改变时，你不需要担心刷新 UI。你可以使变量或其属性是可观察的。这个库允许你使对象，字段，集合可观察化。</p>
<h3 id="生成绑定类"><a href="#生成绑定类" class="headerlink" title="生成绑定类"></a><a href="https://developer.android.com/topic/libraries/data-binding/generated-binding.html" target="_blank" rel="noopener">生成绑定类</a></h3><p>Data binding 库会生成绑定类，用来访问 layout 的变量和 views。此页展示如何使用和自定义生成的绑定类。</p>
<h3 id="Binding-adapters"><a href="#Binding-adapters" class="headerlink" title="Binding adapters"></a><a href="https://developer.android.com/topic/libraries/data-binding/binding-adapters.html" target="_blank" rel="noopener">Binding adapters</a></h3><p>对于每个布局表达式，都有一个绑定适配器，用来进行设置框架调用需要的相应的属性或者监听器。举例，binding adapter 可以负责调用 <code>setText()</code> 方法来设置文本属性或调用 <code>setOnclickListener()</code> 方法将监听器添加到 click ·。大部分通用的 binding adapters，比如这一章例子中使用的 <code>android:text</code> 属性的 adapters 是可用的，它在 <code>android.databinding.adapters</code> 包中。常见 binding adapters 的列表，见 <a href="https://android.googlesource.com/platform/frameworks/data-binding/+/studio-master-dev/extensions/baseAdapters/src/main/java/androidx/databinding/adapters" target="_blank" rel="noopener">adapters</a>。你可以创建自己的 adapters，如下面的例子：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">"app:goneUnless"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">goneUnless</span><span class="params">(view: <span class="type">View</span>, visible: <span class="type">Boolean</span>)</span></span> &#123;</span><br><span class="line">    view.visibility = <span class="keyword">if</span> (visible) View.VISIBLE <span class="keyword">else</span> View.GONE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="绑定布局-views-到-Architecture-Components"><a href="#绑定布局-views-到-Architecture-Components" class="headerlink" title="绑定布局 views 到 Architecture Components"></a><a href="https://developer.android.com/topic/libraries/data-binding/architecture.html" target="_blank" rel="noopener">绑定布局 views 到 Architecture Components</a></h3><p>Android Support Library 包括了 <a href="https://developer.android.com/topic/libraries/architecture/index.html" target="_blank" rel="noopener">Architecture Components</a>，它可以帮助你设计具有鲁棒性，可测试性，可维护性的 app。你可以使用 Architecture Components 和 Data Binding 库来进一步简化 UI 的开发。</p>
<h3 id="双向数据绑定"><a href="#双向数据绑定" class="headerlink" title="双向数据绑定"></a><a href="https://developer.android.com/topic/libraries/data-binding/two-way" target="_blank" rel="noopener">双向数据绑定</a></h3><p>Data Binding 库支持双向绑定。用于这类绑定支持接收对属性的数据更改，同时监听用户对该属性的修改的能力。</p>
]]></content>
      
        <categories>
            
            <category> Android Architecture Component </category>
            
            <category> kotlin </category>
            
            <category> DataBinding </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> architecture </tag>
            
            <tag> Android Architecture Component </tag>
            
            <tag> aac </tag>
            
            <tag> ViewModel </tag>
            
            <tag> LiveData </tag>
            
            <tag> DataBinding </tag>
            
            <tag> Lifecycles </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Architecture Component -- 概要（翻译）]]></title>
      <url>/2018/04/15/android_architecture_components_overview/</url>
      <content type="html"><![CDATA[<h1 id="Android-Architecture-Component-–-概要（翻译）"><a href="#Android-Architecture-Component-–-概要（翻译）" class="headerlink" title="Android Architecture Component – 概要（翻译）"></a>Android Architecture Component – 概要（翻译）</h1><blockquote>
<p>写在前面：抽空整理一下 Android Architecture Component 官方文档的翻译，根据官方文档会分成很多篇，当自己回顾做个笔记，也方便大家参考。</p>
<p>注：以下 “Android Architecture Component”，Android 体系结构组件，在译文中均不做具体翻译。<br><br><br>原文：</p>
<ul>
<li><a href="https://developer.android.com/topic/libraries/architecture/index" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/architecture/index</a></li>
<li><a href="https://developer.android.com/topic/libraries/architecture/adding-components" target="_blank" rel="noopener">https://developer.android.com/topic/libraries/architecture/adding-components</a></li>
</ul>
</blockquote>
<h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>Android Architecture Components 是一系列可以帮助你设计具有鲁棒性，可测试性，可维护性的 app。从管理 UI 组件生命周期和处理数据持久类开始。</p>
<ul>
<li>轻松管理应用的生命周期。新的 <a href="https://developer.android.com/topic/libraries/architecture/lifecycle" target="_blank" rel="noopener">lifecycle-aware components</a> 可以帮助你管理 Activity 和 Fragment 的生命周期。配置被改变时重建，避免内存泄漏并轻松地加载数据到UI。</li>
<li>使用 <a href="https://developer.android.com/topic/libraries/architecture/livedata" target="_blank" rel="noopener">LiveData</a> 来构建数据对象，它会在底层数据库修改时通知给 View。</li>
<li><a href="https://developer.android.com/topic/libraries/architecture/viewmodel" target="_blank" rel="noopener">ViewModel</a> 存储了 UI 相关的对象，它不会在 app 被旋转时销毁。</li>
<li><a href="https://developer.android.com/topic/libraries/architecture/room" target="_blank" rel="noopener">Room</a> 是一个 SQLite 对象映射库。使用它可以避免模版代码并简单地转换 SQLite 数据表数据到 Java 对象)。Room 提供了编译时期的 SQLite 语句的检查，并可以返回 RxJava，Flowable 和 LiveData 观察者。</li>
</ul>
<h2 id="增加-Components-到你的项目中"><a href="#增加-Components-到你的项目中" class="headerlink" title="增加 Components 到你的项目中"></a>增加 Components 到你的项目中</h2><p>在开始之前，我们推荐先阅读 Architecture Components <a href="https://developer.android.com/topic/libraries/architecture/guide.html" target="_blank" rel="noopener">App 体系结构指南</a>。这个指南中有一些有用的准则可以运用到所有的 Android App 中，并且展示了怎么一起使用 Architecture Components。</p>
<p>Architecture Components 目前在 Google Maven 仓库中已经可用，以下步骤：</p>
<h3 id="增加-Google-Maven-仓库"><a href="#增加-Google-Maven-仓库" class="headerlink" title="增加 Google Maven 仓库"></a>增加 Google Maven 仓库</h3><p>Android Studio 项目没有被配置默认访问这个仓库。</p>
<p>增加到你的项目中，打开你<strong>项目</strong>(不是你 app 或者 module 的)的 <code>build.gradle</code> 文件，在以下一行增加 <code>google()</code> 仓库：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">        google()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="声明依赖"><a href="#声明依赖" class="headerlink" title="声明依赖"></a>声明依赖</h3><p>打开你 <strong>app 或者 module</strong> 的 <code>build.gradle</code> 文件并增加你需要的 artifacts 作为依赖。你可以增加所有的依赖，或者选择子集。</p>
<h4 id="Android-X"><a href="#Android-X" class="headerlink" title="Android X"></a>Android X</h4><p>当前版本的 Arch Components 是使用 Android X 包开发的。这些被列出的表示可用的，并且名称于之前版本（1.x）不同。</p>
<p>更多 AndroidX 相关的重构的信息，还有它们是如何影响类包和模块 id的，请看 AndroidX <a href="https://developer.android.com/topic/libraries/support-library/refactor" target="_blank" rel="noopener">重构文档</a></p>
<h4 id="Kotlin"><a href="#Kotlin" class="headerlink" title="Kotlin"></a>Kotlin</h4><p>Kotlin extesion modules 如以下用 <code>// use -ktx for Kotlin</code> 标签的则是支持的，替换它即可，比如：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">"androidx.lifecycle:lifecycle-viewmodel:$lifecycle_version"</span> <span class="comment">// use -ktx for Kotlin</span></span><br></pre></td></tr></table></figure>
<p>以及</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">"androidx.lifecycle:lifecycle-viewmodel-ktx:$lifecycle_version"</span></span><br></pre></td></tr></table></figure>
<p>包括 Kotlin extensions 的文档的更多信息，可以看这里 <a href="https://developer.android.com/kotlin/ktx" target="_blank" rel="noopener">ktx documentation</a>。</p>
<blockquote>
<p>对于基于 Kotlin 的app，确保你使用了 <strong>kapt</strong> 代替 <strong>annotationProcessor</strong>。你应该再增加 <strong>kotlin-kapt</strong> 插件。</p>
</blockquote>
<h4 id="Futures"><a href="#Futures" class="headerlink" title="Futures"></a>Futures</h4><p>Futures 依赖。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="keyword">def</span> futures_version = <span class="string">"1.0.0-alpha02"</span></span><br><span class="line"></span><br><span class="line">    implementation <span class="string">"androidx.concurrent:concurrent-futures:$futures_version"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Lifecycle"><a href="#Lifecycle" class="headerlink" title="Lifecycle"></a>Lifecycle</h4><p><a href="https://developer.android.com/topic/libraries/architecture/lifecycle.html" target="_blank" rel="noopener">Lifecycle</a> 依赖，包括 <a href="https://developer.android.com/topic/libraries/architecture/livedata.html" target="_blank" rel="noopener">LiveData</a> 和 <a href="https://developer.android.com/topic/libraries/architecture/viewmodel.html" target="_blank" rel="noopener">ViewModel</a></p>
<p><strong>AndroidX</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="keyword">def</span> lifecycle_version = <span class="string">"2.0.0"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ViewModel and LiveData</span></span><br><span class="line">    implementation <span class="string">"androidx.lifecycle:lifecycle-extensions:$lifecycle_version"</span></span><br><span class="line">    <span class="comment">// alternatively - just ViewModel</span></span><br><span class="line">    implementation <span class="string">"androidx.lifecycle:lifecycle-viewmodel:$lifecycle_version"</span> <span class="comment">// use -ktx for Kotlin</span></span><br><span class="line">    <span class="comment">// alternatively - just LiveData</span></span><br><span class="line">    implementation <span class="string">"androidx.lifecycle:lifecycle-livedata:$lifecycle_version"</span></span><br><span class="line">    <span class="comment">// alternatively - Lifecycles only (no ViewModel or LiveData). Some UI</span></span><br><span class="line">    <span class="comment">//     AndroidX libraries use this lightweight import for Lifecycle</span></span><br><span class="line">    implementation <span class="string">"androidx.lifecycle:lifecycle-runtime:$lifecycle_version"</span></span><br><span class="line"></span><br><span class="line">    annotationProcessor <span class="string">"androidx.lifecycle:lifecycle-compiler:$lifecycle_version"</span> <span class="comment">// use kapt for Kotlin</span></span><br><span class="line">    <span class="comment">// alternately - if using Java8, use the following instead of lifecycle-compiler</span></span><br><span class="line">    implementation <span class="string">"androidx.lifecycle:lifecycle-common-java8:$lifecycle_version"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - ReactiveStreams support for LiveData</span></span><br><span class="line">    implementation <span class="string">"androidx.lifecycle:lifecycle-reactivestreams:$lifecycle_version"</span> <span class="comment">// use -ktx for Kotlin</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - Test helpers for LiveData</span></span><br><span class="line">    testImplementation <span class="string">"androidx.arch.core:core-testing:$lifecycle_version"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Pre-AndroidX</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="keyword">def</span> lifecycle_version = <span class="string">"1.1.1"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ViewModel and LiveData</span></span><br><span class="line">    implementation <span class="string">"android.arch.lifecycle:extensions:$lifecycle_version"</span></span><br><span class="line">    <span class="comment">// alternatively - just ViewModel</span></span><br><span class="line">    implementation <span class="string">"android.arch.lifecycle:viewmodel:$lifecycle_version"</span> <span class="comment">// use -ktx for Kotlin</span></span><br><span class="line">    <span class="comment">// alternatively - just LiveData</span></span><br><span class="line">    implementation <span class="string">"android.arch.lifecycle:livedata:$lifecycle_version"</span></span><br><span class="line">    <span class="comment">// alternatively - Lifecycles only (no ViewModel or LiveData).</span></span><br><span class="line">    <span class="comment">//     Support library depends on this lightweight import</span></span><br><span class="line">    implementation <span class="string">"android.arch.lifecycle:runtime:$lifecycle_version"</span></span><br><span class="line"></span><br><span class="line">    annotationProcessor <span class="string">"android.arch.lifecycle:compiler:$lifecycle_version"</span> <span class="comment">// use kapt for Kotlin</span></span><br><span class="line">    <span class="comment">// alternately - if using Java8, use the following instead of compiler</span></span><br><span class="line">    implementation <span class="string">"android.arch.lifecycle:common-java8:$lifecycle_version"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - ReactiveStreams support for LiveData</span></span><br><span class="line">    implementation <span class="string">"android.arch.lifecycle:reactivestreams:$lifecycle_version"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - Test helpers for LiveData</span></span><br><span class="line">    testImplementation <span class="string">"android.arch.core:core-testing:$lifecycle_version"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Room"><a href="#Room" class="headerlink" title="Room"></a>Room</h4><p><a href="https://developer.android.com/topic/libraries/architecture/room.html" target="_blank" rel="noopener">Room</a> 依赖，包括 <a href="https://developer.android.com/topic/libraries/architecture/room.html#db-migration-testing" target="_blank" rel="noopener">测试 Room 迁移</a> 和 <a href="https://developer.android.com/training/data-storage/room/accessing-data.html#query-rxjava" target="_blank" rel="noopener">Room RxJava</a></p>
<p><strong>AndroidX</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="keyword">def</span> room_version = <span class="string">"2.1.0-alpha02"</span></span><br><span class="line"></span><br><span class="line">    implementation <span class="string">"androidx.room:room-runtime:$room_version"</span></span><br><span class="line">    annotationProcessor <span class="string">"androidx.room:room-compiler:$room_version"</span> <span class="comment">// use kapt for Kotlin</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - RxJava support for Room</span></span><br><span class="line">    implementation <span class="string">"androidx.room:room-rxjava2:$room_version"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - Guava support for Room, including Optional and ListenableFuture</span></span><br><span class="line">    implementation <span class="string">"androidx.room:room-guava:$room_version"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Test helpers</span></span><br><span class="line">    testImplementation <span class="string">"androidx.room:room-testing:$room_version"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Pre-AndroidX</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="keyword">def</span> room_version = <span class="string">"1.1.1"</span></span><br><span class="line"></span><br><span class="line">    implementation <span class="string">"android.arch.persistence.room:runtime:$room_version"</span></span><br><span class="line">    annotationProcessor <span class="string">"android.arch.persistence.room:compiler:$room_version"</span> <span class="comment">// use kapt for Kotlin</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - RxJava support for Room</span></span><br><span class="line">    implementation <span class="string">"android.arch.persistence.room:rxjava2:$room_version"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - Guava support for Room, including Optional and ListenableFuture</span></span><br><span class="line">    implementation <span class="string">"android.arch.persistence.room:guava:$room_version"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Test helpers</span></span><br><span class="line">    testImplementation <span class="string">"android.arch.persistence.room:testing:$room_version"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Paging"><a href="#Paging" class="headerlink" title="Paging"></a>Paging</h4><p><a href="https://developer.android.com/topic/libraries/architecture/paging.html" target="_blank" rel="noopener">Paging</a>依赖</p>
<p><strong>AndroidX</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="keyword">def</span> paging_version = <span class="string">"2.1.0-beta01"</span></span><br><span class="line"></span><br><span class="line">    implementation <span class="string">"androidx.paging:paging-runtime:$paging_version"</span> <span class="comment">// use -ktx for Kotlin</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// alternatively - without Android dependencies for testing</span></span><br><span class="line">    testImplementation <span class="string">"androidx.paging:paging-common:$paging_version"</span> <span class="comment">// use -ktx for Kotlin</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - RxJava support</span></span><br><span class="line">    implementation <span class="string">"androidx.paging:paging-rxjava2:$paging_version"</span> <span class="comment">// use -ktx for Kotlin</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Pre-AndroidX</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="keyword">def</span> paging_version = <span class="string">"1.0.0"</span></span><br><span class="line"></span><br><span class="line">    implementation <span class="string">"android.arch.paging:runtime:$paging_version"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// alternatively - without Android dependencies for testing</span></span><br><span class="line">    testImplementation <span class="string">"android.arch.paging:common:$paging_version"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - RxJava support</span></span><br><span class="line">    implementation <span class="string">"android.arch.paging:rxjava2:$paging_version"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Navigation"><a href="#Navigation" class="headerlink" title="Navigation"></a>Navigation</h4><p><a href="https://developer.android.com/topic/libraries/architecture/navigation/navigation-implementing.html" target="_blank" rel="noopener">Navigation</a> 依赖</p>
<p>Navigation 相关的类已经存在于 androidx.navigation 包中，但是当前依赖于 Support Library 27.1.1 和 关联的 Arch component 版本。AndroidX dependencies 依赖的 Navigation 版本将会在未来发布。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="keyword">def</span> nav_version = <span class="string">"1.0.0-alpha07"</span></span><br><span class="line"></span><br><span class="line">    implementation <span class="string">"android.arch.navigation:navigation-fragment:$nav_version"</span> <span class="comment">// use -ktx for Kotlin</span></span><br><span class="line">    implementation <span class="string">"android.arch.navigation:navigation-ui:$nav_version"</span> <span class="comment">// use -ktx for Kotlin</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - Test helpers</span></span><br><span class="line">    <span class="comment">// this library depends on the Kotlin standard library</span></span><br><span class="line">    androidTestImplementation <span class="string">"android.arch.navigation:navigation-testing:$nav_version"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Safe-args"><a href="#Safe-args" class="headerlink" title="Safe args"></a>Safe args</h4><p><a href="https://developer.android.com/topic/libraries/architecture/navigation/navigation-implementing.html#Safe-args" target="_blank" rel="noopener">Safe args</a> 依赖，增加下面的 <strong>classPath</strong> 到你<strong>最顶层</strong>的 <code>build.gradle</code> 文件中</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">"android.arch.navigation:navigation-safe-args-gradle-plugin:1.0.0-alpha07"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>增加 <strong>你的 app 或者 module</strong> 的 <code>build.gradle</code> 文件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">"androidx.navigation.safeargs"</span></span><br></pre></td></tr></table></figure>
<h4 id="WorkManager"><a href="#WorkManager" class="headerlink" title="WorkManager"></a>WorkManager</h4><p><a href="https://developer.android.com/topic/libraries/architecture/workmanager.html" target="_blank" rel="noopener">WorkManager</a> 依赖。</p>
<p>WorkManager 相关的类已经存在于 androidx.navigation 包中，但是当前依赖于 Support Library 27.1.1 和 关联的 Arch component 版本。AndroidX dependencies 依赖的 WorkManager 版本将会在未来发布。</p>
<p>WorkManager 需要 <code>compileSdk</code> 版本 28 或者更高。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="keyword">def</span> work_version = <span class="string">"1.0.0-alpha11"</span></span><br><span class="line"></span><br><span class="line">    implementation <span class="string">"android.arch.work:work-runtime:$work_version"</span> <span class="comment">// use -ktx for Kotlin</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - Firebase JobDispatcher support</span></span><br><span class="line">    implementation <span class="string">"android.arch.work:work-firebase:$work_version"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - Test helpers</span></span><br><span class="line">    androidTestImplementation <span class="string">"android.arch.work:work-testing:$work_version"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Android Architecture Component </category>
            
            <category> kotlin </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> architecture </tag>
            
            <tag> Android Architecture Component </tag>
            
            <tag> aac </tag>
            
            <tag> ViewModel </tag>
            
            <tag> LiveData </tag>
            
            <tag> DataBinding </tag>
            
            <tag> Lifecycles </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Huginn实现自动通过slack推送豆瓣高分电影]]></title>
      <url>/2018/04/03/huginn_douban_high_score_movies_and_slack/</url>
      <content type="html"><![CDATA[<h1 id="Huginn实现自动通过slack推送豆瓣高分电影"><a href="#Huginn实现自动通过slack推送豆瓣高分电影" class="headerlink" title="Huginn实现自动通过slack推送豆瓣高分电影"></a>Huginn实现自动通过slack推送豆瓣高分电影</h1><blockquote>
<p>如果尚未安装 Huginn，可以参考<a href="https://blog.wangjiegulu.com/2018/04/02/build_the_environment_for_huginn/">这里</a></p>
</blockquote>
<p>想象下以下场景：每当有正在上映的电影在豆瓣上的评分超过7.8分，则 huginn 自动编辑一条信息并通过 <a href="https://slack.com" target="_blank" rel="noopener"><code>Slack</code></a> （当然也可以用 telegram 等app）通知到我电脑或者手机上。收到信息后，点击不喜欢忽略，或者点击购票按钮直接进入到购票页面。甚至 Huginn 可以结合 <code>Google Calendar</code> 查询你这几天的行程安排，推送高分电影信息的同时给你选择一个比较合适观看电影的时间点，购买好电影票后，huginn 又自动帮你把日程事件写入到 <code>Google Calendar</code> 中，并设置提醒。是不是很酷？！</p>
<p>Huginn 就如你的贴心管家，按照你的意愿自动帮你完成很多事情。</p>
<p>我们先来实现 <code>每当有正在上映的电影在豆瓣上的评分超过7.8分，则给我推送 Slack 信息</code> 这一部分需求。</p>
<p>最后达到的效果如下：</p>
<div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/38308823-d6afbb92-384a-11e8-8db6-4f6def8ff371.png" width="300px/"><br>    <br>手机端效果<br></div><br><div style="text-align: center;"><br>    <img src="https://user-images.githubusercontent.com/5423194/38308728-9a9ba6f2-384a-11e8-9cf5-541e828207e2.png" width="600px/"><br>    <br>PC端效果<br></div>

<h2 id="创建-Agents"><a href="#创建-Agents" class="headerlink" title="创建 Agents"></a>创建 Agents</h2><p>首先进入 Huginn 首页（默认<code>localhost:3000</code>），左上角进入 <code>Scenarios</code>：</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38248922-84a7d57e-377c-11e8-8073-443bd59fd2f1.png" width="500px/"><br></div>

<p>我的理解：<strong>Scenario</strong> 代表一种场景，一般会包含多个 <strong>agent</strong>，一个 agent 表示进行一次事件的处理或者变换。拿我们现在的例子来说，<strong>自动通过slack推送豆瓣高分电影</strong> 这一整个就是一个 <code>Scenario</code>，但是这个 <code>Scenario</code> 会有很多的 <code>agent</code>s 组成，比如：</p>
<ul>
<li>有一个 agent 是用来从豆瓣网页获取当前上映中的所有电影和它们的分数等信息；</li>
<li>一个 agent 是用来从第一个 agent 里面拿到的所有电影进行过滤，过滤的标准就是 <code>score &gt; 7.8</code>，</li>
<li>还有一个 agent 是用来把过滤后的电影通过 slack 推送到我们手机上。</li>
</ul>
<p>看着跟 <code>RxJava</code> 的观察者模式是不是很像？第一个从豆瓣页面拉取数据的过程就像是 <code>Observable</code>，然后其它的 agent 就像很多的 <code>operator</code> 用来把数据进行转换和变化，最终通知到 <code>subscriber</code>，这里的 <code>subscriber</code> 就是我们自己。我们通过 huginn 订阅了 <code>豆瓣高分电影</code>，就是这么简单。</p>
<p>点击左下角的 <code>New Scenario</code> 创建一个名为 <code>douban_high_score_movie</code> 的 Scenario。</p>
<h3 id="创建获取数据-agent"><a href="#创建获取数据-agent" class="headerlink" title="创建获取数据 agent"></a>创建获取数据 agent</h3><blockquote>
<p>第一个 agent 用来从豆瓣官网获取所有正在上映的电影</p>
</blockquote>
<p>在 <code>douban_high_score_movie</code> 的 Scenario 中点击 <code>+ New Agent</code> 来创建第一个 Agent。</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38249853-b1eac0d4-377f-11e8-8242-022b28113653.png" width="500px/"><br></div>

<p>如上图，你需要去决定你要创建的 agent 的类型（<a href="https://github.com/huginn/huginn/wiki/Agent-Types-&amp;-Descriptions" target="_blank" rel="noopener">这里</a>是目前 Huginn 支持的所有的类型）。</p>
<p>我们通过输入 “web” 来进行过滤选择 <code>Website Agent</code>。</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38283656-c5dc2f5a-37e9-11e8-8f3c-bd7d8d8d7c5e.png" width="700px/"><br></div>

<p>上图，左边是我们需要去配置的地方；右边是每个设置对应的说明。</p>
<ul>
<li><strong>Name：</strong>给这个 agent 取个名字，我们这里取名为 <code>step1_get_douban_playing_movies</code>，表示这个 agent 是 <code>douban_high_score_movie</code> 这个 Scenario 的第一步，是用来从豆瓣获取当前正在上映的所有电影。</li>
<li><strong>Schedule：</strong>表示调度周期，表示在什么时候自动执行这个 agent，比如 <code>Every 1d</code> 表示每一天执行一次、<code>Every 2h</code> 表示每2小时执行一次、<code>8pm</code> 表示每天下午8点执行等等；这里我们选择 <code>3pm</code>，每天下午3点执行一次。</li>
<li><strong>Keep events：</strong>表示事件保留的时间；比如我们从豆瓣上获取到所有上映的电影，每一部电影信息都是一个 event，Huginn会把这些 event 保留在本地，你可以通过这个参数来设置这些 events 在本地保留多少时间，超过这个时间，Huginn会把数据清除。我们这里设置1小时（为什么只设置为1小时，<a href="#keep_useless">下面我们会再讨论</a>）。</li>
<li><strong>Sources：</strong>表示这个 agent 处理的数据来源是哪个 agent。我们现在创建的 agent 是第一个 agent，是从豆瓣网站上获取正在上映的所有电影，所以不需要从其他 agent 传递数据（也就是上面说的 events）过来，所以这个留空。</li>
<li><strong>Receivers：</strong>表示这个 agent 处理完数据之后把这些数据传入到哪个 agent。还是用 <code>RxJava</code> 做类比，因为每个 agnet 都有可能只是整个观察者模式中的一个操作符，用来转化数据，数据转化完之后，可能还需要其他 agent 把这些数据做进一步的转化。</li>
<li><strong>Scenarios：</strong>表示这个 agent 是数据哪个 Scenario 的。</li>
<li><strong>Options：</strong>这个非常关键，就是通过这个配置文件（JSON）来进行网络请求和豆瓣电影数据解析相关的操作的，这个我们重点讲下。</li>
</ul>
<blockquote>
<p><strong>注意：</strong>以上没提到的配置可以留空</p>
</blockquote>
<h4 id="Options-配置"><a href="#Options-配置" class="headerlink" title="Options 配置"></a>Options 配置</h4><p>Options 配置其实就是一个 JSON 文件。Website Agent 的 Options 主要的元素有如下：</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38284371-684365f8-37ed-11e8-8125-b94a2a35e12b.png" width="500px/"><br></div>

<ul>
<li><strong>url：</strong>网站地址，表示我需要从哪个网站获取数据，现在我们是从豆瓣，所以需要输入豆瓣正在上映的网址，这里我们输入 <code>https://movie.douban.com/cinema/nowplaying/hangzhou/</code>，当然最后一个地点可以根据你的常驻地点做相应的修改。</li>
<li><strong>type：</strong>数据解析的类型，支持的类型有 <code>xml</code>、<code>html</code>、<code>json</code>、<code>text</code> 四种，当前豆瓣网址返回的当然是 html 了，所以这里我们填写 <code>html</code>。如果其他场景，比如 调用第三方开放的 api，返回的类型可能就是 <code>json</code> 或者 <code>xml</code>了。</li>
<li><strong>mode：</strong>表示获取数据的模式，我们这里选择 <code>on_change</code>。<ul>
<li>on_change：在数据有更改时才会获取作为 events。</li>
<li>merge：把新数据和输入的数据进行合并。</li>
<li>all：获取所有数据。</li>
</ul>
</li>
<li><strong>extract：</strong>用来配置（JSON）从这个网站解析出真正我们想要的数据。如果 <code>type</code> 是 <code>html</code>，则每个数据通过 <code>css</code> 选择器或者 <code>xpath</code> 来解析出真正的数据。</li>
</ul>
<blockquote>
<p><strong>注意：</strong> <code>on_change</code> 这个设置在我们现在的场景下其实用处不大，这个<a href="#keep_useless">下面我们会再讨论</a>。</p>
</blockquote>
<p>最后的 options 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"expected_update_period_in_days"</span>: <span class="string">"2"</span>,</span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"https://movie.douban.com/cinema/nowplaying/hangzhou/"</span>,</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"html"</span>,</span><br><span class="line">  <span class="attr">"mode"</span>: <span class="string">"on_change"</span>,</span><br><span class="line">  <span class="attr">"extract"</span>: &#123;</span><br><span class="line">    <span class="attr">"title"</span>: &#123;</span><br><span class="line">      <span class="attr">"css"</span>: <span class="string">"li[@data-category='nowplaying']"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"@data-title"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"score"</span>: &#123;</span><br><span class="line">      <span class="attr">"css"</span>: <span class="string">"li[@data-category='nowplaying']"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"@data-score"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"star"</span>: &#123;</span><br><span class="line">      <span class="attr">"css"</span>: <span class="string">"li[@data-category='nowplaying']"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"@data-star"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"release"</span>: &#123;</span><br><span class="line">      <span class="attr">"css"</span>: <span class="string">"li[@data-category='nowplaying']"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"@data-release"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"region"</span>: &#123;</span><br><span class="line">      <span class="attr">"css"</span>: <span class="string">"li[@data-category='nowplaying']"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"@data-region"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"actors"</span>: &#123;</span><br><span class="line">      <span class="attr">"css"</span>: <span class="string">"li[@data-category='nowplaying']"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"@data-actors"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"director"</span>: &#123;</span><br><span class="line">      <span class="attr">"css"</span>: <span class="string">"li[@data-category='nowplaying']"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"@data-director"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"detail_url"</span>: &#123;</span><br><span class="line">      <span class="attr">"css"</span>: <span class="string">"li[@data-category='nowplaying']/ul/li/a[@data-psource='poster']"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"@href"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"image_url"</span>: &#123;</span><br><span class="line">      <span class="attr">"css"</span>: <span class="string">"li[@data-category='nowplaying']/ul/li/a[@data-psource='poster']/img"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"@src"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上可以看出，我们从豆瓣的每部电影中获取了以下信息：</p>
<ul>
<li>title：电影名字</li>
<li>score：电影分数，满分10分</li>
<li>star：电影分数，满分50分</li>
<li>release：上映日期</li>
<li>region：地区</li>
<li>actors：演员</li>
<li>director：导演</li>
<li>detail_url：详细 url</li>
<li>image_url：电影封面</li>
</ul>
<blockquote>
<p><strong>注意：</strong>获取具体 xpath 比较简单的方法：通过 chrome 右键的 <code>inspect</code> 来复制拿到。</p>
</blockquote>
<p>以上配置完毕后，点击下面的 <code>Dry Run</code>，应该就会出现以下页面</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38285255-f7211d02-37f1-11e8-84ee-c6b74401094e.png" width="650px/"><br></div>

<p>最后进行保存。第一个 agent 就创建完毕了。</p>
<p>同时，这个 agent 在运行的过程中会生成以下 events：</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38285762-5520c52c-37f4-11e8-9db5-ffa0f1116924.png" width="700px/"><br></div>


<h3 id="创建过滤-agnet"><a href="#创建过滤-agnet" class="headerlink" title="创建过滤 agnet"></a>创建过滤 agnet</h3><p><code>step1_get_douban_playing_movies</code> 把所有正在上映的电影数据从豆瓣上拉取下来并解析好，生成一个个 events。然后我们第二个 agent 就需要从这些 events 里面进行过滤筛选出所有分数大于 <code>7.8</code>（具体的标准可以自己定） 的电影。相当于 RxJava 的 filter 操作符吧。</p>
<p>同样创建 agent，选择为 <code>TriggerAgent</code>，名字为 <code>step2_pick_high_score_movies</code>。这是把 <strong>Sources</strong> 填写为第一个 agent 的名字，即 <code>step1_get_douban_playing_movies</code>，表示我要创建的 agent 处理的数据（events）是从 <code>step1_get_douban_playing_movies</code> 来的。</p>
<p>然后重点还是在 Options 中</p>
<ul>
<li><strong>keep_event：</strong>表示是否把我从 <code>step1_get_douban_playing_movies</code> 这个 agent 收到的 events 原封不动地再传给下一个 agent（下一个 agent 我们还没创建），我们设置为 true。因为下一个 agent 我们是用来把数据通过 slack 发送到给我们自己的，那肯定需要第一个 agent 中获取到的例如电影名字、分数等信息。</li>
<li><strong>rules：</strong>表示我们过滤的规则，可以多个，具体下面说。</li>
<li><strong>must_match：</strong>表示 rules 中我必须要满足几个规则，如果是1，则意味着 rules 中所有的规则是或关系（只要满足 rules 中的1个规则即可）；默认不填写的话是<strong>必须要满足 rules 中所有的规则。</strong>，因为我们这里只需要满足一个分数大于7.8就可以，所以可以不填写。</li>
</ul>
<p>最后 Options 的配置如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"expected_receive_period_in_days"</span>: <span class="string">"2"</span>,</span><br><span class="line">  <span class="attr">"keep_event"</span>: <span class="string">"true"</span>,</span><br><span class="line">  <span class="attr">"rules"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"field&gt;=value"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"7.8"</span>,</span><br><span class="line">      <span class="attr">"path"</span>: <span class="string">"$.score"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"Looks like your pattern matched in '&#123;&#123;value&#125;&#125;'!"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，在 <strong>rules</strong> 中添加一个规则，<strong>type</strong> 表示匹配规则，<code>field&gt;=value</code>：</p>
<ul>
<li><strong>field</strong>: 通过下面 path 从 events 匹配出来的数据，这里是 <code>$.score</code>，所以表示的是电影的分数；</li>
<li><strong>value</strong>：表示下面 json 的 <code>value</code> 字段的值，这里为 <code>7.8</code>。</li>
</ul>
<p>通过简单的表达式 <code>field&gt;=value</code> 来设定匹配规则：电影分数 &gt;= 7.8分。</p>
<p>至此，第二个 agent 创建完毕。</p>
<p>你同样可以通过下面的 <code>Dry Run</code> 来进行测试，测试时因为有 <code>Sources</code>，需要你构造一些假数据作为输入来运行。</p>
<h3 id="创建去重-agnet"><a href="#创建去重-agnet" class="headerlink" title="创建去重 agnet"></a>创建去重 agnet</h3><p><code>step2_pick_high_score_movies</code>用来把 <code>step1_get_douban_playing_movies</code> 中从豆瓣官网获取的电影信息进行高分的过滤（分数&gt;=7.8）。</p>
<p>我们还需要创建一个去重的 agent，来避免重复给我们自己推送高分电影（因为我们现在获取的频率是每天进行获取检测，但是电影总不可能是每部电影只上映一天吧，第二天获取的时候肯定有第一天获取的数据）。</p>
<p>这里大家可能会有个问题，因为我们在配置第一个 agent 的时候，已经把 <code>mode</code> 已经设置为 <code>on_change</code> 了，为什么还是会有重复数据呢？因为这里的电影信息中，有诸如 <code>分数</code> 这类的数据，这些数据是随时可能会有变化的，虽然是同一个电影，但是分数从 <code>8.1</code> 上升到 <code>8.2</code>，那 Huginn 也会认为满足了 <code>on_change</code> 条件，所以会造成重复推送。所以，我们还需要单独做去重处理。</p>
<p><span id="keep_useless"></span></p>
<blockquote>
<p><strong>注意：</strong> 之前提到过 <code>on_change</code> 等设置在第一个 agent 其实用处不大，同样也是由于上面说的原因，我们也不知道同样的电影什么时候分数会发生变化，就算用了 <code>on_change</code>，也可能会把之前获取过的数据拿到。所以第一个 agent 的 keep_event 设置的时间比较短，因为这些 events 提供给 <code>on_change</code> 匹配意义不大，所以还是节省空间，设置短一点。</p>
</blockquote>
<p>创建 agent，type 选择 <code>DeDuplicationAgent</code>，名字取为 <code>step2_1_deduplication_high_score_movies</code>，<strong>Sources</strong> 填写为上一个 agent 的名字，即 <code>step2_pick_high_score_movies</code>。</p>
<blockquote>
<p><strong>注意：</strong>这里 <strong>keep_event</strong> 设置了90天，因为一旦经过我们这个 agent 去重后，events 假设保留1小时，那下一天我再去获取所有上映的电影并高分过滤后，因为昨天的数据（events）已经被清空了，所以就没办法做比较去重了，所以会导致重复数据。所以这里保存时间应该要&gt;=电影上映的时长，所以这里设置为90天，即3个月左右。</p>
</blockquote>
<p>DeDuplicationAgent 的 Options 填写就比较简单了</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38286554-8fa7b166-37f8-11e8-9d8b-601bf37c895e.png" width="500px/"><br></div>

<ul>
<li><strong>Property：</strong>填写你要去重依据的字段，我们这里根据电影名字来去重，也就是 <code>title</code>。</li>
<li><strong>Lookback：</strong>表示去重的时候跟之前的多少条历史 events 做比较，同一时期一起上映的电影应该不会超过100部，所以设置为100了。</li>
</ul>
<h3 id="创建-slack-通知的-agent"><a href="#创建-slack-通知的-agent" class="headerlink" title="创建 slack 通知的 agent"></a>创建 slack 通知的 agent</h3><blockquote>
<p>如果需要通过 telegram 进行通知，请看这里<a href="https://blog.wangjiegulu.com/2018/11/16/douban_high_movie_huginn_telegram/">《Huginn实现自动通过Telegram推送豆瓣高分电影》</a></p>
</blockquote>
<p>Huginn 自带有一个 <code>SlackAgent</code>，用来发送 slack 消息。</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38287159-d1b96f10-37fb-11e8-835f-0b9e620ab075.png" width="700px/"><br></div>

<p>它使用了 <a href="https://api.slack.com/incoming-webhooks" target="_blank" rel="noopener">incoming-webhooks</a> 来实现消息的发送。</p>
<p>但是为了有更多的可玩性，我们这里选择，自己创建一个 <code>slack app</code>，然后通过它的 open api 实现。</p>
<p>因此，我们需要创建一个 <code>PostAgent</code>。但是在此之前我们先来配置好 Slack 环境。</p>
<h4 id="配置-Slack-环境"><a href="#配置-Slack-环境" class="headerlink" title="配置 Slack 环境"></a>配置 Slack 环境</h4><p>安装 Slack：<a href="https://slack.com" target="_blank" rel="noopener">https://slack.com</a></p>
<ul>
<li>Google Play for Android：<a href="https://play.google.com/store/apps/details?id=com.Slack" target="_blank" rel="noopener">https://play.google.com/store/apps/details?id=com.Slack</a></li>
</ul>
<p>创建自己的 workspace（单独创建一个自己私有的，注意不要使用公司、团队的 workspace），比如我的是 <code>https://wangjie.slack.com</code>。</p>
<p>在自己私有的 workspace 中创建一个私有的 channel：<code>#huginn-movie</code></p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38288443-62b02016-3803-11e8-8733-ded2ac3b535b.png" width="300px/"><br></div>

<p>这个 channel 就是用来接收高分电影的数据了，当然你也可以使用 <code>#general</code>。</p>
<p>然后我们创建一个自己的 app，用来发送电影信息。进入 <a href="https://api.slack.com/" target="_blank" rel="noopener">https://api.slack.com/</a></p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38288591-4f2cf702-3804-11e8-9b96-fe8561c21e9c.png" width="300px/"><br></div>

<p>点击 <code>Start Building</code>，</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38288667-a0cc323a-3804-11e8-9a7d-6da84babc266.png" width="500px/"><br></div>

<ul>
<li><strong>App Name：</strong>可以随意填写</li>
<li><strong>Development Slack Workspace：</strong>选择你刚刚创建的私有的 workspace</li>
</ul>
<p>在 <code>Add features and functionality</code> 中点击 <code>Permissions</code> 进入权限配置。</p>
<p>在 <code>Scope</code> 中添加如下权限：</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38288837-a0438740-3805-11e8-821e-5e91a1bf401e.png" width="550px/"><br></div>

<p>添加完以上所有权限后，点击保存，然后重新打开 <code>Permissions</code>，点击下面按钮安装我们的这个 app 到 slack。</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38288942-31655e06-3806-11e8-92af-63c67f778570.png" width="550px/"><br></div>

<p><span id="slack_token"><br>安装完毕之后，再次进入 <code>Permissions</code>，拷贝 <code>OAuth Access Token</code>：</span></p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38289144-4ad7c56c-3807-11e8-9599-4e64dd704258.png" width="550px/"><br></div>

<p>然后，我们就可以使用我们的 token 来访问 slack 的 open api 了，具体文档在这里：<a href="https://api.slack.com/web" target="_blank" rel="noopener">https://api.slack.com/web</a>。</p>
<p>我们需要的发送消息到 <code>#huginn-movie</code> channel 的接口文档：<br> <a href="https://api.slack.com/methods/chat.postMessage" target="_blank" rel="noopener">https://api.slack.com/methods/chat.postMessage</a></p>
<p>有了 api 文档，有了 token，一切就好办了。</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38289564-69cd36bc-3809-11e8-820f-8f7cddaf64cb.png" width="650px/"><br></div>

<p>由上述文档，我们可以通过 post 请求，把我们要发送的电影信息封装到 <code>attachments</code> 参数中执行请求即可。</p>
<p>而且 <code>attachments</code> 参数可以参考文档 <a href="https://api.slack.com/docs/message-attachments" target="_blank" rel="noopener">https://api.slack.com/docs/message-attachments</a> 来封装信息。</p>
<p>Slack 环境一切就绪，接下来，回到 Huginn。</p>
<h4 id="创建-Agent-发送-Slack-消息"><a href="#创建-Agent-发送-Slack-消息" class="headerlink" title="创建 Agent 发送 Slack 消息"></a>创建 Agent 发送 Slack 消息</h4><p>创建 <code>PostAgent</code>（注意，不是 <code>SlackAgent</code>），取名为 <code>step3_high_score_movies_to_slack_post</code>。<strong>Sources</strong> 填写为 <code>step2_1_deduplication_high_score_movies</code>，因为这个 agent 需要把去重后的电影信息通过 slack 发送给我们。</p>
<p>最终的 Options 配置如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"post_url"</span>: <span class="string">"&#123;% credential slack_huginn_url_post_message %&#125;"</span>,</span><br><span class="line">  <span class="attr">"expected_receive_period_in_days"</span>: <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"content_type"</span>: <span class="string">"json"</span>,</span><br><span class="line">  <span class="attr">"method"</span>: <span class="string">"post"</span>,</span><br><span class="line">  <span class="attr">"payload"</span>: &#123;</span><br><span class="line">    <span class="attr">"channel"</span>: <span class="string">"huginn-movie"</span>,</span><br><span class="line">    <span class="attr">"username"</span>: <span class="string">"Douban Movie"</span>,</span><br><span class="line">    <span class="attr">"icon_url"</span>: <span class="string">"https://img3.doubanio.com/pics/douban-icons/favicon_48x48.png"</span>,</span><br><span class="line">    <span class="attr">"attachments"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"fallback"</span>: <span class="string">"Required plain-text summary of the attachment."</span>,</span><br><span class="line">        <span class="attr">"mrkdwn_in"</span>: [</span><br><span class="line">          <span class="string">"text"</span>,</span><br><span class="line">          <span class="string">"pretext"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"color"</span>: <span class="string">"#36a64f"</span>,</span><br><span class="line">        <span class="attr">"pretext"</span>: <span class="string">"Hi~ &lt;@&#123;% credential  slack_at_user_id %&#125;&gt;, There is *high score* movie."</span>,</span><br><span class="line">        <span class="attr">"author_name"</span>: <span class="string">"&#123;&#123;director&#125;&#125;"</span>,</span><br><span class="line">        <span class="attr">"author_link"</span>: <span class="string">"&#123;&#123;detail_url&#125;&#125;"</span>,</span><br><span class="line">        <span class="attr">"author_icon"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"《&#123;&#123;title&#125;&#125;》"</span>,</span><br><span class="line">        <span class="attr">"title_link"</span>: <span class="string">"&#123;&#123;detail_url&#125;&#125;"</span>,</span><br><span class="line">        <span class="attr">"text"</span>: <span class="string">"*Actors*: &#123;&#123;actors&#125;&#125;"</span>,</span><br><span class="line">        <span class="attr">"fields"</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"title"</span>: <span class="string">"Score"</span>,</span><br><span class="line">            <span class="attr">"value"</span>: <span class="string">"&#123;&#123;score&#125;&#125;"</span>,</span><br><span class="line">            <span class="attr">"short"</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"title"</span>: <span class="string">"Star"</span>,</span><br><span class="line">            <span class="attr">"value"</span>: <span class="string">"&#123;&#123;star&#125;&#125;"</span>,</span><br><span class="line">            <span class="attr">"short"</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"title"</span>: <span class="string">"Region"</span>,</span><br><span class="line">            <span class="attr">"value"</span>: <span class="string">"&#123;&#123;region&#125;&#125;"</span>,</span><br><span class="line">            <span class="attr">"short"</span>: <span class="literal">true</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">"title"</span>: <span class="string">"Release"</span>,</span><br><span class="line">            <span class="attr">"value"</span>: <span class="string">"&#123;&#123;release&#125;&#125;"</span>,</span><br><span class="line">            <span class="attr">"short"</span>: <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"image_url"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="attr">"thumb_url"</span>: <span class="string">"&#123;&#123;image_url&#125;&#125;"</span>,</span><br><span class="line">        <span class="attr">"footer"</span>: <span class="string">"Slack"</span>,</span><br><span class="line">        <span class="attr">"footer_icon"</span>: <span class="string">"https://platform.slack-edge.com/img/default_application_icon.png"</span>,</span><br><span class="line">        <span class="attr">"ts"</span>: <span class="string">"&#123;&#123;\"now\" | date: \"%s\"&#125;&#125;"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Content-Type"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">    <span class="attr">"Authorization"</span>: <span class="string">"&#123;% credential slack_huginn_token %&#125;"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"emit_events"</span>: <span class="string">"false"</span>,</span><br><span class="line">  <span class="attr">"no_merge"</span>: <span class="string">"false"</span>,</span><br><span class="line">  <span class="attr">"output_mode"</span>: <span class="string">"clean"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是：</p>
<ul>
<li><code>{\% credential slack_huginn_url_post_message %\}</code>：此类的表达式为 <a href="https://github.com/huginn/huginn/wiki/Formatting-Events-using-Liquid" target="_blank" rel="noopener">Liquid-interpolated</a>，具体的值配置在 <code>Credentials</code> 中，可以理解为全局定义，在 <code>Credentials</code> 中配置好 <code>key-value</code> 之后，可以在其它地方以诸如 <code>{\% credential key \%}</code> 的方式来使用，这里不做过多介绍了。</li>
</ul>
<p><span id="slack_at_anyone"></span></p>
<ul>
<li>在消息中使用Slack 中的 <code>@</code> 某人的功能时，需要拿到对应用户的 ID，可以的获取方式可以通过在 slack 中选中名字然后 <code>Copy link</code> 的方式拿到用户链接，用户连接的最后就是 ID。</li>
</ul>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38290017-c49db6c8-380b-11e8-817c-bbd1aa25396e.png" width="300px/"><br></div>

<p>保存该 Agent，至此，所需的所有的 Agent 都已经创建完毕了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>整个 Scenario 的事件流程图如下：</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/38290316-44ee5e12-380d-11e8-9da2-d6d995fb3e1a.png" width="300px/"><br></div>

<p>Huginn 还支持公开你创建的 Scenario，提供给其它人使用，以上的代码也已经公开：</p>
<p><a href="http://h.wangjiegulu.com/scenarios/8/export.json" target="_blank" rel="noopener">http://h.wangjiegulu.com/scenarios/8/export.json</a></p>
<p>大家可以直接下载使用，不过需要在 <code>Credentials</code> 中配置如下参数：</p>
<ul>
<li><strong>slack_huginn_token：</strong>你创建的 Slack App 的 OAuth Access Token，具体方式可以参考<a href="#slack_token">这里</a></li>
<li><strong>slack_at_user_id：</strong>你需要 @ 的 slack 用户 ID，填写你自己的，拿到你 ID 的方式可以参考<a href="#slack_at_anyone">这里</a></li>
<li><strong>slack_huginn_url_post_message：</strong>填写 <code>https://slack.com/api/chat.postMessage</code> 即可。</li>
</ul>
<p>除了以上例子，Huginn 还可以完成更多奇思妙想，限制你的只有你的想象力。</p>
]]></content>
      
        <categories>
            
            <category> huginn </category>
            
            <category> automate </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ifttt </tag>
            
            <tag> automate </tag>
            
            <tag> huginn </tag>
            
            <tag> integromat </tag>
            
            <tag> zapier </tag>
            
            <tag> geek </tag>
            
            <tag> douban </tag>
            
            <tag> movies </tag>
            
            <tag> slack </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Huginn及环境搭建]]></title>
      <url>/2018/04/02/build_the_environment_for_huginn/</url>
      <content type="html"><![CDATA[<h1 id="Huginn-及环境搭建"><a href="#Huginn-及环境搭建" class="headerlink" title="Huginn 及环境搭建"></a>Huginn 及环境搭建</h1><h2 id="什么是-Huginn-？"><a href="#什么是-Huginn-？" class="headerlink" title="什么是 Huginn ？"></a>什么是 Huginn ？</h2><p>Huginn 是一个可以通过构建 agents 来帮你实现在线自动化任务的系统。它们可以理解 web，监听事件，按你所需地去执行一些行为。Huginn 的 agents 创建和消费事件，通过有向图表来进行转播。你可以把它当作部署在你自己的服务器上的破解版本的 IFTTT 或 Zapier。</p>
<p><img src="https://raw.githubusercontent.com/huginn/huginn/master/doc/imgs/the-name.png" alt=""></p>
<p>你可以用 Huginn 做什么？</p>
<ul>
<li>追踪天气并在明天下雨（雪）的时候邮件通知给你（明天不要忘记带伞）。</li>
<li>列出你关心的条目，并在 Twitter 发生改变的时候电子邮件通知给你。（例如，想知道在机器学习领域发生了什么有趣的事情吗？Huginn 将在 Twitter 上观察“machine learning”这个词，并告诉你什么时候讨论会高高峰。）</li>
<li>帮你观察旅游机票和购物优惠信息。</li>
<li>抓取任意网站并在发生变化时电子邮件通知你。</li>
<li>连接到 Adioso, HipChat, Basecamp, Growl, FTP, IMAP, Jabber, JIRA, MQTT, nextbus, Pushbullet, Pushover, RSS, Bash, Slack, StubHub, translation APIs, Twilio, Twitter, Wunderground, and 微博等第三方.</li>
<li>发送和接收 WebHooks。</li>
<li>其它很多很多你能想到的。</li>
</ul>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>以 <code>Debian</code> 服务器为例，进行环境搭建（大家可以选择购买VPS）。</p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Huginn 的安装主要包括以下组件：</p>
<ol>
<li>Packages / Dependencies</li>
<li>Ruby</li>
<li>System Users</li>
<li>Database</li>
<li>Huginn</li>
<li>Nginx</li>
</ol>
<h3 id="1-Packages-Dependencies"><a href="#1-Packages-Dependencies" class="headerlink" title="1. Packages / Dependencies"></a>1. Packages / Dependencies</h3><p>Debian 中 <code>sudo</code> 并没有默认安装。确保你的系统是最新的，然后安装它。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># run as root!</span><br><span class="line">apt-get update -y</span><br><span class="line">apt-get upgrade -y</span><br><span class="line">apt-get install sudo -y</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意：</strong>在安装过程中，需要手动编辑一些文件。如果你熟悉 vim，请使用下面的命令将其设置为默认编辑器。如果你对 vim 不熟悉，请跳过此操作并继续使用默认编辑器。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Install vim and set as default editor</span><br><span class="line">sudo apt-get install -y vim</span><br><span class="line">sudo update-alternatives --set editor /usr/bin/vim.basic</span><br></pre></td></tr></table></figure>
<p>导入 node.js 库 (如果是 Ubuntu 或者 Debian Jessie 的话可以跳过)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sL https://deb.nodesource.com/setup_0.12 | sudo bash -</span><br></pre></td></tr></table></figure>
<p>安装需要的 packages：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y runit build-essential git zlib1g-dev libyaml-dev libssl-dev libgdbm-dev libreadline-dev libncurses5-dev libffi-dev curl openssh-server checkinstall libxml2-dev libxslt-dev libcurl4-openssl-dev libicu-dev logrotate python-docutils pkg-config cmake nodejs graphviz</span><br></pre></td></tr></table></figure>
<h4 id="Debian-Stretch"><a href="#Debian-Stretch" class="headerlink" title="Debian Stretch"></a>Debian Stretch</h4><p>由于 Debian Stretch 的 runit 不会自动启动，但是这会被init系统处理。另外，Ruby需要 OpenSSL 1.0 开发包而不是 1.1的。对于默认安装使用这些包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y runit-systemd libssl1.0-dev</span><br></pre></td></tr></table></figure>
<h3 id="2-Ruby"><a href="#2-Ruby" class="headerlink" title="2. Ruby"></a>2. Ruby</h3><p>在生产中使用带有 Huginn 的 Ruby 版本管理器（如 <a href="http://rvm.io/" target="_blank" rel="noopener">RVM</a>，<a href="https://github.com/sstephenson/rbenv" target="_blank" rel="noopener">rbenv</a> 或 <a href="https://github.com/postmodern/chruby" target="_blank" rel="noopener">chruby</a>）会频繁导致难以诊断的问题。版本管理器不受支持，我们强烈建议所有人按照以下说明使用系统 Ruby。</p>
<p>如果存在的话，删除旧版本的 Ruby：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove -y ruby1.8 ruby1.9</span><br></pre></td></tr></table></figure>
<p>下载 Ruby，然后编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir /tmp/ruby &amp;&amp; cd /tmp/ruby</span><br><span class="line">curl -L --progress http://cache.ruby-lang.org/pub/ruby/2.4/ruby-2.4.2.tar.bz2 | tar xj</span><br><span class="line">cd ruby-2.4.2</span><br><span class="line">./configure --disable-install-rdoc</span><br><span class="line">make -j`nproc`</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<p>安装 bundler 和 foreman:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gem install rake bundler foreman --no-ri --no-rdoc</span><br></pre></td></tr></table></figure>
<h3 id="3-System-Users"><a href="#3-System-Users" class="headerlink" title="3. System Users"></a>3. System Users</h3><p>为 Huginn 创建一个用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo adduser --disabled-login --gecos &apos;Huginn&apos; huginn</span><br></pre></td></tr></table></figure>
<h3 id="4-Database"><a href="#4-Database" class="headerlink" title="4. Database"></a>4. Database</h3><p>安装数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y mysql-server mysql-client libmysqlclient-dev</span><br><span class="line"></span><br><span class="line"># 选择一个 MySQL root 密码 (可以任意), 输入并按回车,</span><br><span class="line"># 重复输入 MySQL root 密码 然后按回车</span><br></pre></td></tr></table></figure>
<p>对于 Debian Stretch, 替换 libmysqlclient-dev 为 default-libmysqlclient-dev。</p>
<p>检查你安装的 MySQL 版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql --version</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql_secure_installation</span><br></pre></td></tr></table></figure>
<p>登录 MySQL：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line"># 输入 MySQL root 密码</span><br></pre></td></tr></table></figure>
<p>为 Huginn 创建一个用户，替换 命令中的 $password 为你真实的密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE USER &apos;huginn&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;$password&apos;;</span><br></pre></td></tr></table></figure>
<p>支持 long indexes，你需要确保可以使用 InnoDB engine：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET default_storage_engine=INNODB;</span><br><span class="line"></span><br><span class="line"># 如果失败，检查你的 MySQL 配置文件 (e.g. `/etc/mysql/*.cnf`, `/etc/mysql/conf.d/*`)</span><br><span class="line"># 设置 &quot;innodb = off&quot;</span><br></pre></td></tr></table></figure>
<p>给予 Huginn 用户必要的数据库相关权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER, LOCK TABLES ON `huginn_production`.* TO &apos;huginn&apos;@&apos;localhost&apos;;</span><br></pre></td></tr></table></figure>
<p>退出 database 会话：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; \q</span><br></pre></td></tr></table></figure>
<p>尝试使用新的用户链接到新的数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo -u huginn -H mysql -u huginn -p -D huginn_production</span><br><span class="line"></span><br><span class="line"># Type the password you replaced $password with earlier</span><br></pre></td></tr></table></figure>
<p>你应该回看到 <code>ERROR 1049 (42000): Unknown database &#39;huginn_production&#39;</code>，这是正常的，因为我们会稍后创建数据库。</p>
<h3 id="5-Huginn"><a href="#5-Huginn" class="headerlink" title="5. Huginn"></a>5. Huginn</h3><h4 id="Clone-源代码"><a href="#Clone-源代码" class="headerlink" title="Clone 源代码"></a>Clone 源代码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># We&apos;ll install Huginn into the home directory of the user &quot;huginn&quot;</span><br><span class="line">cd /home/huginn</span><br><span class="line"></span><br><span class="line"># Clone Huginn repository</span><br><span class="line">sudo -u huginn -H git clone https://github.com/huginn/huginn.git -b master huginn</span><br><span class="line"></span><br><span class="line"># Go to Huginn installation folder</span><br><span class="line">cd /home/huginn/huginn</span><br><span class="line"></span><br><span class="line"># Copy the example Huginn config</span><br><span class="line">sudo -u huginn -H cp .env.example .env</span><br><span class="line"></span><br><span class="line"># Create the log/, tmp/pids/ and tmp/sockets/ directories</span><br><span class="line">sudo -u huginn mkdir -p log tmp/pids tmp/sockets</span><br><span class="line"></span><br><span class="line"># Make sure Huginn can write to the log/ and tmp/ directories</span><br><span class="line">sudo chown -R huginn log/ tmp/</span><br><span class="line">sudo chmod -R u+rwX,go-w log/ tmp/</span><br><span class="line"></span><br><span class="line"># Make sure permissions are set correctly</span><br><span class="line">sudo chmod -R u+rwX,go-w log/</span><br><span class="line">sudo chmod -R u+rwX tmp/</span><br><span class="line">sudo -u huginn -H chmod o-rwx .env</span><br><span class="line"></span><br><span class="line"># Copy the example Unicorn config</span><br><span class="line">sudo -u huginn -H cp config/unicorn.rb.example config/unicorn.rb</span><br></pre></td></tr></table></figure>
<h4 id="配置它"><a href="#配置它" class="headerlink" title="配置它"></a>配置它</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Update Huginn config file and follow the instructions</span><br><span class="line">sudo -u huginn -H editor .env</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DATABASE_ADAPTER=mysql2</span><br><span class="line">DATABASE_RECONNECT=true</span><br><span class="line">DATABASE_NAME=huginn_production</span><br><span class="line">DATABASE_POOL=20</span><br><span class="line">DATABASE_USERNAME=huginn</span><br><span class="line">DATABASE_PASSWORD=&apos;$password&apos;</span><br><span class="line">#DATABASE_HOST=your-domain-here.com</span><br><span class="line">#DATABASE_PORT=3306</span><br><span class="line">#DATABASE_SOCKET=/tmp/mysql.sock</span><br><span class="line"></span><br><span class="line">DATABASE_ENCODING=utf8</span><br><span class="line"># MySQL only: If you are running a MySQL server &gt;=5.5.3, you should</span><br><span class="line"># set DATABASE_ENCODING to utf8mb4 instead of utf8 so that the</span><br><span class="line"># database can hold 4-byte UTF-8 characters like emoji.</span><br><span class="line">#DATABASE_ENCODING=utf8mb4</span><br></pre></td></tr></table></figure>
<p><strong>重要：</strong> 取消注释 RAILS_ENV 设置，以便于在生产环节运行 Huginn。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RAILS_ENV=production</span><br></pre></td></tr></table></figure>
<p>如果需要改变 Unicorn 配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Increase the amount of workers if you expect to have a high load instance.</span><br><span class="line"># 2 are enough for most use cases, if the server has less then 2GB of RAM</span><br><span class="line"># decrease the worker amount to 1</span><br><span class="line">sudo -u huginn -H editor config/unicorn.rb</span><br></pre></td></tr></table></figure>
<p><strong>重要：</strong>确保 <code>.env</code> 和 <code>unicorn.rb</code> 都符合你的配置。</p>
<h4 id="安装-Gems"><a href="#安装-Gems" class="headerlink" title="安装 Gems"></a>安装 Gems</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u huginn -H bundle install --deployment --without development test</span><br></pre></td></tr></table></figure>
<h4 id="初始化-Database"><a href="#初始化-Database" class="headerlink" title="初始化 Database"></a>初始化 Database</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Create the database</span><br><span class="line">sudo -u huginn -H bundle exec rake db:create RAILS_ENV=production</span><br><span class="line"></span><br><span class="line"># Migrate to the latest version</span><br><span class="line">sudo -u huginn -H bundle exec rake db:migrate RAILS_ENV=production</span><br><span class="line"></span><br><span class="line"># Create admin user and example agents using the default admin/password login</span><br><span class="line">sudo -u huginn -H bundle exec rake db:seed RAILS_ENV=production SEED_USERNAME=admin SEED_PASSWORD=password</span><br></pre></td></tr></table></figure>
<h4 id="编译-Assets"><a href="#编译-Assets" class="headerlink" title="编译 Assets"></a>编译 Assets</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u huginn -H bundle exec rake assets:precompile RAILS_ENV=production</span><br></pre></td></tr></table></figure>
<h4 id="安装初始脚本"><a href="#安装初始脚本" class="headerlink" title="安装初始脚本"></a>安装初始脚本</h4><p>Huginn 使用 <a href="http://ddollar.github.io/foreman/" target="_blank" rel="noopener">foreman</a> 来生成基于 <code>Procfile</code> 的初始化脚本。</p>
<p>编辑 <a href="https://github.com/huginn/huginn/blob/master/Procfile" target="_blank" rel="noopener"><code>Procfile</code></a> 来针对生产选择一个推荐的版本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u huginn -H editor Procfile</span><br></pre></td></tr></table></figure>
<p>注释<a href="https://github.com/huginn/huginn/blob/master/Procfile#L6-L7" target="_blank" rel="noopener">这两行</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">web: bundle exec rails server -p $&#123;PORT-3000&#125; -b $&#123;IP-0.0.0.0&#125;</span><br><span class="line">jobs: bundle exec rails runner bin/threaded.rb</span><br></pre></td></tr></table></figure>
<p>取消注释<a href="https://github.com/huginn/huginn/blob/master/Procfile#L6-L7" target="_blank" rel="noopener">这几行</a>或者<a href="https://github.com/huginn/huginn/blob/master/Procfile#L28-L31" target="_blank" rel="noopener">这些</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># web: bundle exec unicorn -c config/unicorn.rb</span><br><span class="line"># jobs: bundle exec rails runner bin/threaded.rb</span><br></pre></td></tr></table></figure>
<p>Export 初始化 scripts:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bundle exec rake production:export</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意：</strong>每次你修改了 <code>.env</code> 或者你的 procfile 文件，你都必须要重新 export 出事 script。</p>
</blockquote>
<h4 id="设置-Logrotate"><a href="#设置-Logrotate" class="headerlink" title="设置 Logrotate"></a>设置 Logrotate</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp deployment/logrotate/huginn /etc/logrotate.d/huginn</span><br></pre></td></tr></table></figure>
<h4 id="确保你的-Huginn-实例正在运行"><a href="#确保你的-Huginn-实例正在运行" class="headerlink" title="确保你的 Huginn 实例正在运行"></a>确保你的 Huginn 实例正在运行</h4><p>sudo bundle exec rake production:status</p>
<h3 id="6-Nginx"><a href="#6-Nginx" class="headerlink" title="6. Nginx"></a>6. Nginx</h3><blockquote>
<p><strong>注意：</strong>Nginx 是 Huginn 官方支持的 web 服务器。如果你不会或者不想使用 Nginx 作为你的 web 服务器，参考 wiki 的文章来使用配置 <a href="https://github.com/huginn/huginn/wiki/Apache-Huginn-configuration" target="_blank" rel="noopener">apache</a></p>
</blockquote>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y nginx</span><br></pre></td></tr></table></figure>
<h4 id="网站配置"><a href="#网站配置" class="headerlink" title="网站配置"></a>网站配置</h4><p>复制示例网站配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp deployment/nginx/huginn /etc/nginx/sites-available/huginn</span><br><span class="line">sudo ln -s /etc/nginx/sites-available/huginn /etc/nginx/sites-enabled/huginn</span><br></pre></td></tr></table></figure>
<p>确保编辑配置文件以匹配你的设置，如果你正在运行多个nginx站点，请从 <code>listen</code> 指令中删除 <code>default_server</code> 参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Change YOUR_SERVER_FQDN to the fully-qualified</span><br><span class="line"># domain name of your host serving Huginn.</span><br><span class="line">sudo editor /etc/nginx/sites-available/huginn</span><br></pre></td></tr></table></figure>
<p><strong>如果 huginn 是唯一可用的 nginx 网站</strong>，删除默认的 nginx 网站：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rm /etc/nginx/sites-enabled/default</span><br></pre></td></tr></table></figure>
<h3 id="Restart"><a href="#Restart" class="headerlink" title="Restart"></a>Restart</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service nginx restart</span><br></pre></td></tr></table></figure>
<p>完成。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="https://github.com/huginn/huginn" target="_blank" rel="noopener">https://github.com/huginn/huginn</a></li>
<li><a href="https://github.com/huginn/huginn/blob/master/doc/manual/installation.md" target="_blank" rel="noopener">https://github.com/huginn/huginn/blob/master/doc/manual/installation.md</a></li>
</ol>
]]></content>
      
        <categories>
            
            <category> huginn </category>
            
            <category> automate </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ifttt </tag>
            
            <tag> automate </tag>
            
            <tag> huginn </tag>
            
            <tag> integromat </tag>
            
            <tag> zapier </tag>
            
            <tag> geek </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[上传到多个Maven仓库的Gradle插件RapidMavenPushPlugin]]></title>
      <url>/2018/03/16/rapid_maven_push_plugin_for_android/</url>
      <content type="html"><![CDATA[<h1 id="RapidMavenPushPlugin"><a href="#RapidMavenPushPlugin" class="headerlink" title="RapidMavenPushPlugin"></a>RapidMavenPushPlugin</h1><p>用于上传你的 library 库到多个 Maven 仓库的 Gradle 插件。</p>
<p><strong>Github: <a href="https://github.com/wangjiegulu/RapidMavenPushPlugin" target="_blank" rel="noopener">https://github.com/wangjiegulu/RapidMavenPushPlugin</a></strong></p>
<h2 id="1-怎么使用"><a href="#1-怎么使用" class="headerlink" title="1. 怎么使用"></a>1. 怎么使用</h2><h3 id="1-1-添加依赖"><a href="#1-1-添加依赖" class="headerlink" title="1.1 添加依赖"></a>1.1 添加依赖</h3><p>在你项目根目录的 <code>build.gradle</code> 文件中增加 <code>RapidMavenPushPlugin</code> 依赖：</p>
<p><strong><a href="http://search.maven.org/#search%7Cga%7C1%7Crapidmavenpush" target="_blank" rel="noopener">检查最新版本</a></strong></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">'com.android.tools.build:gradle:3.0.1'</span></span><br><span class="line">        <span class="keyword">classpath</span>(<span class="string">'com.github.wangjiegulu:rapidmavenpush:x.x.x'</span>) &#123;</span><br><span class="line">            <span class="keyword">exclude</span> <span class="keyword">group</span>: <span class="string">'com.android.tools.build'</span>, module: <span class="string">'gradle'</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-创建-properties-files"><a href="#1-2-创建-properties-files" class="headerlink" title="1.2 创建 properties files"></a>1.2 创建 properties files</h3><p>现在你有3个 Maven 仓库（<code>maven type</code>s），所以需要创建3个 maven properties archive 文件和1个通用的 archive properties 文件（properties 文件的名字和位置可以是任意的）：</p>
<ul>
<li><strong>maven_local.properties</strong>: 上传 archives 到本地的 maven 仓库, 默认在你电脑的 <code>~/.m2/repository</code>。</li>
<li><strong>maven_company.properties</strong>: 上传 archives 到你公司的 maven 仓库，他部署在你公司的服务器上面。</li>
<li><strong>maven_central.properties</strong>: 上传 archives 到 maven 中央库。</li>
<li><strong>common.properties</strong>: 上面3个 maven 仓库的通用 properties。</li>
</ul>
<blockquote>
<p><strong>NOTE</strong>: 当 <code>project.afterEvaluate</code> 时, 所有 properties 都会被自动注入到 <code>project.ext</code>中，所以在那之后你可以以诸如 <code>$POM_ARCHIVE_ID</code> 的方式来使用它们。</p>
</blockquote>
<h4 id="1-2-1-maven-common-properties"><a href="#1-2-1-maven-common-properties" class="headerlink" title="1.2.1 maven_common.properties"></a>1.2.1 maven_common.properties</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># project info</span><br><span class="line">POM_ARCHIVE_GROUP=com.github.wangjiegulu</span><br><span class="line">#POM_ARCHIVE_VERSION_NAME=0.0.1-SNAPSHOT (command typed)</span><br><span class="line"># aar or jar</span><br><span class="line">POM_PACKAGING=aar</span><br><span class="line">POM_DESC=test-mavenpush-plugin</span><br><span class="line">POM_URL=https://github.com/wangjiegulu</span><br><span class="line">POM_SCM_URL=scm:git@github.com:wangjiegulu</span><br><span class="line">POM_SCM_CONNECTION=scm:git@github.com:wangjiegulu</span><br><span class="line">POM_SCM_DEV_CONNECTION=git@github.com:wangjiegulu</span><br><span class="line">POM_LICENCE_NAME=The Apache Software License, Version 2.0</span><br><span class="line">POM_LICENCE_URL=http://www.apache.org/licenses/LICENSE-2.0.txt</span><br><span class="line">POM_LICENCE_DIST=wangjie</span><br><span class="line">POM_DEVELOPER_ID=wangjie</span><br><span class="line">POM_DEVELOPER_NAME=Wang Jie</span><br><span class="line">POM_DEVELOPER_EMAIL=tiantian.china.2@gmail.com</span><br></pre></td></tr></table></figure>
<h4 id="1-2-2-maven-local-properties"><a href="#1-2-2-maven-local-properties" class="headerlink" title="1.2.2 maven_local.properties"></a>1.2.2 maven_local.properties</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># maven repository</span><br><span class="line">POM_REPOSITORY_URL=/Users/wangjie/.m2/repository</span><br><span class="line">POM_REPOSITORY_URL_SNAPSHOT=/Users/wangjie/.m2/repository</span><br><span class="line">POM_SIGN=false</span><br><span class="line"></span><br><span class="line"># project info</span><br><span class="line">POM_ARCHIVE_ID=mavenpush-plugin-depmodule-local</span><br></pre></td></tr></table></figure>
<h4 id="1-2-3-maven-central-properties"><a href="#1-2-3-maven-central-properties" class="headerlink" title="1.2.3 maven_central.properties"></a>1.2.3 maven_central.properties</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POM_OSSRH_USERNAME=username</span><br><span class="line">POM_OSSRH_PASSWORD=password</span><br><span class="line"></span><br><span class="line"># maven repository</span><br><span class="line">POM_REPOSITORY_URL=https://oss.sonatype.org/service/local/staging/deploy/maven2/</span><br><span class="line">POM_REPOSITORY_URL_SNAPSHOT=https://oss.sonatype.org/content/repositories/snapshots/</span><br><span class="line"></span><br><span class="line">POM_SIGN=true</span><br><span class="line"># Already configure in ~/.gradle/gradle.properties</span><br><span class="line">#signing.keyId=</span><br><span class="line">#signing.password=</span><br><span class="line">#signing.secretKeyRingFile=</span><br><span class="line"></span><br><span class="line"># project info</span><br><span class="line">POM_ARCHIVE_ID=mavenpush-plugin-depmodule</span><br></pre></td></tr></table></figure>
<h3 id="1-3-应用-Plugin-amp-properties"><a href="#1-3-应用-Plugin-amp-properties" class="headerlink" title="1.3 应用 Plugin &amp; properties"></a>1.3 应用 Plugin &amp; properties</h3><p>在你 library 的 <code>build.gradle</code> 文件中, 你需要以如下方式来 apply RapidMavenPushPlugin 插件：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'com.github.wangjiegulu.plg.rapidmavenpush'</span></span><br><span class="line"></span><br><span class="line">rapidMavenPush &#123;</span><br><span class="line">    <span class="comment">// 如果是 true，会在编译时期打印被注入的 properties</span></span><br><span class="line">    printProperties = <span class="keyword">true</span></span><br><span class="line">    <span class="comment">// 如果是 true，在注入 properties 发生错误时会终止编译</span></span><br><span class="line">    abortOnError = <span class="keyword">false</span></span><br><span class="line">    <span class="comment">// 是否禁用 Rapid Maven Push Plugin</span></span><br><span class="line">    disable = <span class="keyword">false</span></span><br><span class="line">    <span class="comment">// 如果 `POM_MAVEN_TYPE` 没有被设置，则使用默认的 maven type。</span></span><br><span class="line">    defaultMavenType = <span class="string">'local'</span></span><br><span class="line">    mavens &#123;</span><br><span class="line">        maven &#123;</span><br><span class="line">            mavenType = <span class="string">'local'</span></span><br><span class="line">            propertyFiles = [</span><br><span class="line">                    <span class="keyword">file</span>(<span class="string">"mavenupload/maven_common.properties"</span>),</span><br><span class="line">                    <span class="keyword">file</span>(<span class="string">"mavenupload/maven_local.properties"</span>)</span><br><span class="line">            ]</span><br><span class="line">            <span class="comment">// Property Inject Mode: If the properties is already set, replace it or skip</span></span><br><span class="line">            <span class="comment">// property 注入模式：如果 properties 已经被设置过，则替换还是跳过</span></span><br><span class="line">            propertyInjectMode = <span class="string">'replace'</span></span><br><span class="line">        &#125;</span><br><span class="line">        maven &#123;</span><br><span class="line">            mavenType = <span class="string">'company'</span></span><br><span class="line">            propertyFiles = [</span><br><span class="line">                    <span class="keyword">file</span>(<span class="string">"mavenupload/maven_common.properties"</span>),</span><br><span class="line">                    <span class="keyword">file</span>(<span class="string">"mavenupload/maven_company.properties"</span>)</span><br><span class="line">            ]</span><br><span class="line">            propertyInjectMode = <span class="string">'replace'</span></span><br><span class="line">        &#125;</span><br><span class="line">        maven &#123;</span><br><span class="line">            mavenType = <span class="string">'central'</span></span><br><span class="line">            propertyFiles = [</span><br><span class="line">                    <span class="keyword">file</span>(<span class="string">"mavenupload/maven_common.properties"</span>),</span><br><span class="line">                    <span class="keyword">file</span>(<span class="string">"mavenupload/maven_central.properties"</span>)</span><br><span class="line">            ]</span><br><span class="line">            propertyInjectMode = <span class="string">'replace'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-4-上传-Archives"><a href="#1-4-上传-Archives" class="headerlink" title="1.4 上传 Archives"></a>1.4 上传 Archives</h3><p>在编译之后，rapid maven push plugin 自动创建了一个名为 <code>rapidUploadArchives</code> 的 task。</p>
<p>执行这个 task !</p>
<p><strong>上传 archives 到本地仓库:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew clean :depmodule:rapidUploadArchives -PPOM_MAVEN_TYPE=local</span><br></pre></td></tr></table></figure>
<p><strong>上传 archives to 到中央库:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew clean :depmodule:rapidUploadArchives -PPOM_MAVEN_TYPE=central</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>NOTE</strong>: 如果你没有在 <code>build.gradle</code> 使用 <code>ext.POM_MAVEN_TYPE=xxx</code> 的方式进行设置的话，<code>POM_MAVEN_TYPE</code> 参数是必要的。</p>
</blockquote>
<h3 id="1-5-支持的-parameters-amp-properties"><a href="#1-5-支持的-parameters-amp-properties" class="headerlink" title="1.5 支持的 parameters &amp; properties"></a>1.5 支持的 parameters &amp; properties</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// maven type, 只能通过在 `build.gradle` 设置 `ext.POM_MAVEN_TYPE=xxx` 或者在命令行中设置 `-PPOM_MAVEN_TYPE=xxx` 或者在 `gradle.properties` 中设置 `PPOM_MAVEN_TYPE=xxx`</span><br><span class="line">POM_MAVEN_TYPE</span><br><span class="line"></span><br><span class="line">// maven repository parameters</span><br><span class="line">POM_REPOSITORY_URL</span><br><span class="line">POM_REPOSITORY_URL_SNAPSHOT</span><br><span class="line">POM_OSSRH_USERNAME</span><br><span class="line">POM_OSSRH_PASSWORD</span><br><span class="line"></span><br><span class="line">// sign parameters</span><br><span class="line">POM_SIGN</span><br><span class="line">signing.keyId</span><br><span class="line">signing.password</span><br><span class="line">signing.secretKeyRingFile</span><br><span class="line"></span><br><span class="line">// archive parameters</span><br><span class="line">POM_ARCHIVE_GROUP</span><br><span class="line">POM_ARCHIVE_ID</span><br><span class="line">POM_ARCHIVE_VERSION_NAME</span><br><span class="line">POM_PACKAGING</span><br><span class="line">POM_DESC</span><br><span class="line">POM_URL</span><br><span class="line">POM_SCM_URL</span><br><span class="line">POM_SCM_CONNECTION</span><br><span class="line">POM_SCM_DEV_CONNECTION</span><br><span class="line">POM_LICENCE_NAME</span><br><span class="line">POM_LICENCE_URL</span><br><span class="line">POM_LICENCE_DIST</span><br><span class="line">POM_DEVELOPER_ID</span><br><span class="line">POM_DEVELOPER_NAME</span><br><span class="line">POM_DEVELOPER_EMAIL</span><br></pre></td></tr></table></figure>
<h1 id="License"><a href="#License" class="headerlink" title="License"></a>License</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Copyright 2018 Wang Jie</span><br><span class="line"></span><br><span class="line">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line">you may not use this file except in compliance with the License.</span><br><span class="line">You may obtain a copy of the License at</span><br><span class="line"></span><br><span class="line">  http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"></span><br><span class="line">Unless required by applicable law or agreed to in writing, software</span><br><span class="line">distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line">See the License for the specific language governing permissions and</span><br><span class="line">limitations under the License.</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> flutter </category>
            
            <category> dart </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> java </tag>
            
            <tag> gradle </tag>
            
            <tag> gradle plugin </tag>
            
            <tag> maven </tag>
            
            <tag> repository </tag>
            
            <tag> plugin </tag>
            
            <tag> aar </tag>
            
            <tag> jar </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[编写第一个Flutter App（翻译）]]></title>
      <url>/2018/03/01/write_your_first_flutter_app/</url>
      <content type="html"><![CDATA[<p><strong>以下代码 Github 地址：<a href="https://github.com/wangjiegulu/flutter_test_01" target="_blank" rel="noopener">https://github.com/wangjiegulu/flutter_test_01</a></strong></p>
<h1 id="编写你的第一个Flutter-App"><a href="#编写你的第一个Flutter-App" class="headerlink" title="编写你的第一个Flutter App"></a>编写你的第一个Flutter App</h1><blockquote>
<p>原文：<a href="https://flutter.io/get-started/codelab/" target="_blank" rel="noopener">https://flutter.io/get-started/codelab/</a></p>
</blockquote>
<p>这个你创建第一个Flutter app的指南。如果你熟悉面向对象的代码，基本的编程概念，比如变量，循环，和条件，你就可以完成本教程。你不需要之前有Dart或者手机的编程经验。</p>
<ul>
<li><a href="#step-1-create-the-starting-flutter-app">第1步：创建启动 Flutter app</a></li>
<li><a href="#step-2-use-an-external-package">第2步：使用外部包</a></li>
<li><a href="#step-3-add-a-stateful-widget">第3步：增加一个 Stateful widget</a></li>
<li><a href="#step-4-create-an-infinite-scrolling-listview">第4步：创建一个无限滚动的 ListView</a></li>
<li><a href="#step-5-add-interactivity">第5步：增加交互</a></li>
<li><a href="#step-6-navigate-to-a-new-screen">第6步：导航到一个新的页面</a></li>
<li><a href="#step-7-change-the-ui-using-themes">第7步：使用 Theme 来改变 UI</a></li>
<li><a href="#well-done">干得不错！</a></li>
</ul>
<p><strong>你将构建什么</strong></p>
<p>你将要实现一个简单的手机 app，为一个初创公司去生成一些推荐的名字。用户可以选择和取消选择这些名字，并保存最好的一些名字。代码一次生成10个名字。当用户滚动时，新的一批名字就会被生成。用户可以点击 app bar 右上角的按钮进入一个新的页面来仅展示被喜欢的名字。</p>
<p>Gif 动图展示了 app 完成之后的运行效果。</p>
<div style="text-align: center;"><br><img src="https://flutter.io/get-started/codelab/images/startup-namer-app.gif"><br></div>

<p><strong>你将学到什么</strong></p>
<ul>
<li>Flutter app 的基础结构。</li>
<li>查询和使用包来扩展特性。</li>
<li>使用热重载来实现快速的开发周期。</li>
<li>怎么去实现一个 stateful widget 。</li>
<li>怎么去创建一个无限，懒加载的列表。</li>
<li>怎么去创建和导航到第二个页面。</li>
<li>怎么去使用 Theme 来改变 app 的外观。</li>
</ul>
<p><strong>你将使用什么</strong></p>
<ul>
<li>Flutter SDK：Flutter SDK 包括 Flutter 的引擎，framework， widget ，工具和 Dart SDK。这个 codelab 需要 v0.1.4 或者更新。</li>
<li>Android Studio IDE：这个 codelab 具备 Android Studio IDE，但是你也可以使用其它的 IDE，或者使用命令行工作。</li>
<li>你的 IDE 插件：你的 IDE 上面必须分别安装 Flutter 和 Dart 插件。除了 Android Studio，Flutter 和 Dart 插件在 <a href="https://code.visualstudio.com/download" target="_blank" rel="noopener">VS Code</a> 和 <a href="https://www.jetbrains.com/idea/download/#section=mac" target="_blank" rel="noopener">IntelliJ</a> IDE。</li>
</ul>
<p>关于怎么搭建你的环境，可以在 <a href="https://flutter.io/get-started/install/" target="_blank" rel="noopener"></a> 查看更多信息。</p>
<p><span id="step-1-create-the-starting-flutter-app"></span></p>
<h2 id="第1步：创建启动-Flutter-app"><a href="#第1步：创建启动-Flutter-app" class="headerlink" title="第1步：创建启动 Flutter app"></a>第1步：创建启动 Flutter app</h2><p>根据 <a href="https://flutter.io/get-started/test-drive/#create-app" target="_blank" rel="noopener">开始你的第一个 Flutter app</a> 的介绍，创建一个简单，模版的 Flutter app。给项目取名为 <strong>startup_namer</strong> (替换掉 <em>myapp</em>)。您将修改这个 app 来创建完成的 app。</p>
<p>在这个 codelab 中，你主要编辑 dart 代码存放处的 <strong>lib/main.dart</strong>。</p>
<blockquote>
<p><strong>提示：</strong>当复制代码到你的 app 中，缩进可能会歪斜。你可以使用 Flutter 工具来自动修正它们：</p>
<ul>
<li>Android Studio / IntelliJ IDEA: 在 dart 代码上右键并选择 <strong>Reformat Code with dartfmt</strong>。</li>
<li>VS Code: 右键并选择 <strong>Format Document</strong>。</li>
<li>Ternimal: 运行 flutter format <filename>。</filename></li>
</ul>
</blockquote>
<ol>
<li><p>替换 lib/main.dart。</p>
<p> 删除 <strong>lib/main.dart</strong> 中的所有代码。使用下面的代码进行替换，它会在屏幕的中央展示 “Hello World”。</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() =&gt; runApp(<span class="keyword">new</span> MyApp());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MaterialApp(</span><br><span class="line">      title: <span class="string">'Welcome to Flutter'</span>,</span><br><span class="line">      home: <span class="keyword">new</span> Scaffold(</span><br><span class="line">        appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">          title: <span class="keyword">new</span> Text(<span class="string">'Welcome to Flutter'</span>),</span><br><span class="line">        ),</span><br><span class="line">        body: <span class="keyword">new</span> Center(</span><br><span class="line">          child: <span class="keyword">new</span> Text(<span class="string">'Hello World'</span>),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行App，你将会看到如下的屏幕</p>
</li>
</ol>
<div style="text-align: center;"><br><img src="https://flutter.io/get-started/codelab/images/hello-world-screenshot.png"><br></div>

<h3 id="观察"><a href="#观察" class="headerlink" title="观察"></a>观察</h3><ul>
<li>这个例子创建了一个 Material app。<a href="https://material.io/guidelines/" target="_blank" rel="noopener">Material</a> 是手机和 web 上的标准的设计语言。Flutter 提供了丰富的 Material   widget 。</li>
<li>main 方法制定了一个宽箭头（<code>=&gt;</code>）标志，这是一行函数或者方法的简写。</li>
<li>App 继承了 StatelessWidget，这使得 app 本身称为了一个 widget。在 Flutter 中，几乎所有一切都是 widget，包括 alignment, padding, 和 layout。</li>
<li>Material 库中的 Scaffold，提供了一个默认的 app bar，title，和一个 body 属性，它持有了主页面的 widget 树。widget 的子树可能相当复杂。</li>
<li>Widget 的主要的工作是提供一个 <code>build()</code> 方法，它描述了如何根据其他较低级别的 widget 显示 widget。</li>
<li>这个例子中的 widget 树的构成是一个中心的 widget 包含了一个文本的子 child widget。中心 widget 将它的 widget 子树对齐到屏幕的中心。</li>
</ul>
<hr>
<p><span id="step-2-use-an-external-package"></span></p>
<h2 id="第2步：使用外部包"><a href="#第2步：使用外部包" class="headerlink" title="第2步：使用外部包"></a>第2步：使用外部包</h2><p>在这一步，我将使用一个名为 <strong>english_words</strong> 的开源包，它包含了几千个最常用的英文单词和常用的工具方法。</p>
<p>在 <a href="https://pub.dartlang.org/flutter/" target="_blank" rel="noopener">pub.dartlang.org</a>，你可以找到 <a href="https://pub.dartlang.org/packages/english_words" target="_blank" rel="noopener">english_words</a>，以及很多其它的开源包。</p>
<ol>
<li><p>pubspec 文件为 Flutter app 管理 assets。在 <strong>pubspec.yaml</strong>，增加 <strong>english_words</strong> (3.1.0或者更高) 到依赖列表。新增行在下面已被高亮：</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line"><span class="attr">flutter:</span></span><br><span class="line"><span class="attr">sdk:</span> <span class="string">flutter</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">cupertino_icons:</span> <span class="string">^0.1.0</span></span><br><span class="line"><span class="attr">english_words:</span> <span class="string">^3.1.0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Android Studio’s editor 视图查看 pubspec，点击右上角的 <strong>Packages get</strong>。这会把包拉取到你的项目中。你会在控制台上看到以下信息：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flutter packages get</span><br><span class="line">Running &quot;flutter packages get&quot; in startup_namer...</span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <strong>lib/main.dart</strong>，增加一个 <code>english_words</code> 的导入，就如高亮展示的那样：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:english_words/english_words.dart'</span>;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>由于你的输入，Android Studio 针对库会给你一些导入的建议。然后将导入字符串呈现为灰色，让你知道倒入的库你没有使用它（目前为止）。
</code></pre><ol>
<li><p>使用 English words 包生成文本，用来替换掉之前的 “Hello World” 字符串。</p>
<blockquote>
<p><strong>提示：</strong>“Pascal case” （也称为 “大驼峰式命名法”），表示字符串中的每个单词，包括第一个单词，首字母大写。所以，“uppercamelcase” 就变成 “UpperCamelCase”。</p>
</blockquote>
<p> 做以下改变，如下面高亮处：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:english_words/english_words.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() =&gt; runApp(<span class="keyword">new</span> MyApp());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">final</span> wordPair = <span class="keyword">new</span> WordPair.random();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MaterialApp(</span><br><span class="line">      title: <span class="string">'Welcome to Flutter'</span>,</span><br><span class="line">      home: <span class="keyword">new</span> Scaffold(</span><br><span class="line">        appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">          title: <span class="keyword">new</span> Text(<span class="string">'Welcome to Flutter'</span>),</span><br><span class="line">        ),</span><br><span class="line">        body: <span class="keyword">new</span> Center(</span><br><span class="line">          <span class="comment">//child: new Text('Hello World'), // Replace the highlighted text...</span></span><br><span class="line">          child: <span class="keyword">new</span> Text(wordPair.asPascalCase),  <span class="comment">// With this highlighted text.</span></span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li>如果 app 正在运行中，使用热重载按钮（<img src="https://flutter.io/get-started/codelab/images/hot-reload-button.png" alt="">）来更新运行中的 app。每一次你点击了热重载，或者保存了项目，你将会看见不同的词对，它在运行的 app 中是随机的。这是因为词对在 build 方法中被生成。在每次 MaterialApp 需要渲染或者在 Flutter Inspector 中切换平台的时候。</li>
</ol>
<div style="text-align: center;"><br><img src="https://flutter.io/get-started/codelab/images/step2-screenshot.png"><br></div>

<h3 id="问题？"><a href="#问题？" class="headerlink" title="问题？"></a>问题？</h3><p>如果你的 app 没有正确运行，排查错误。如果需要，请使用以下链接的代码来追踪。</p>
<ul>
<li><a href="https://gist.githubusercontent.com/Sfshaza/bb51e3b7df4ebbf3dfd02a4a38db2655/raw/57c25b976ec34d56591cb898a3df0b320e903b99/pubspec.yaml" target="_blank" rel="noopener"><strong>pubspec.yaml</strong></a> (<strong>pubspec.yaml</strong> 不会再次修改了。)</li>
<li><a href="https://gist.githubusercontent.com/Sfshaza/bb51e3b7df4ebbf3dfd02a4a38db2655/raw/57c25b976ec34d56591cb898a3df0b320e903b99/main.dart" target="_blank" rel="noopener"><strong>lib/main.dart</strong></a></li>
</ul>
<hr>
<p><span id="step-3-add-a-stateful-widget"></span></p>
<h2 id="第3步：增加一个-Stateful-widget"><a href="#第3步：增加一个-Stateful-widget" class="headerlink" title="第3步：增加一个 Stateful widget"></a>第3步：增加一个 Stateful widget</h2><p>State<em>less</em> widget 是不可改变的，意味着它们的属性不能被修改 —— 所有值都是 final 的。</p>
<p>State<em>ful</em> widgets 维护了状态，它可能会在 widget 的生命周期内被修改。实现一个 statful widget 需要两个类：1）一个 StatefulWidget 类，用来创建一个实例 2）一个 State 类。StatefulWidget 类本身是不可变的，但 State 类在整个 widget 的生命周期中保持不变。</p>
<p>在这一步中，你将会增加一个 stateful widget，RandomWords，增加它的 State class，RandomWordsState。State 类中将最终维护这个 widget 中推荐喜欢的词对。</p>
<ol>
<li><p>增加  stateful RandomWords widget 到你的 main.dart 中。它可以被放在任何地方，甚至 MyApp 之外，但是这里的解决方案放在了文件的底部。RandomWords widget 除了创建它的 State 类没有什么特别的。</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomWords</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  createState() =&gt; <span class="keyword">new</span> RandomWordsState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>增加 RandomWordsState 类。app 的大部分代码将会写在这个类中，它维护拉这个 widget 中的 state。这个类会保存生成的词对，会被用户无限滚动，用户通过列表切换中的心图标来添加或删除它们。</p>
<p> 你将逐步编写这个类。作为开始，通过以下高亮的文本来创建一个最小的 class：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomWordsState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">RandomWords</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在增加了 state class 之后，IDE 警告这个类缺少一个 build 方法。然后，你将增加一个基本的 build 方法通过从 MyApp 转移生成词对的代码到 RandomWordsState 来生成词对：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomWordsState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">RandomWords</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">final</span> wordPair = <span class="keyword">new</span> WordPair.random();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Text(wordPair.asPascalCase);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>通过以下高亮改变，从 MyApp 中移除生成词对的代码：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">final</span> wordPair = <span class="keyword">new</span> WordPair.random();  <span class="comment">// Delete this line</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MaterialApp(</span><br><span class="line">      title: <span class="string">'Welcome to Flutter'</span>,</span><br><span class="line">      home: <span class="keyword">new</span> Scaffold(</span><br><span class="line">        appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">          title: <span class="keyword">new</span> Text(<span class="string">'Welcome to Flutter'</span>),</span><br><span class="line">       ),</span><br><span class="line">        body: <span class="keyword">new</span> Center(</span><br><span class="line">          <span class="comment">//child: new Text(wordPair.asPascalCase), // Change the highlighted text to...</span></span><br><span class="line">          child: <span class="keyword">new</span> RandomWords(), <span class="comment">// ... this highlighted text</span></span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>重启 app，如果你尝试去热重载，你可能会看到一个警告：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Reloading...</span><br><span class="line">Not all changed program elements ran during view reassembly; consider</span><br><span class="line">restarting.</span><br></pre></td></tr></table></figure>
<p>这可能是误报，但考虑重新启动以确保你的更改反映在 app UI 中。</p>
<p>app 应该会跟以前一样，每次你热重载或者保存的时候展示一个词对。</p>
<div style="text-align: center;"><br><img src="https://flutter.io/get-started/codelab/images/step3-screenshot.png"><br></div>

<h3 id="问题？-1"><a href="#问题？-1" class="headerlink" title="问题？"></a>问题？</h3><p>如果你的 app 没有正确运行，排查错误。如果需要，请使用以下链接的代码来追踪。</p>
<ul>
<li><a href="https://gist.githubusercontent.com/Sfshaza/d7f13ddd8888556232476be8578efe40/raw/329c397b97309ce99f834bf70ebb90778baa5cfe/main.dart" target="_blank" rel="noopener">lib/main.dart</a></li>
</ul>
<hr>
<p><span id="step-4-create-an-infinite-scrolling-listview"></span></p>
<h2 id="第4步：创建一个无限滚动的-ListView"><a href="#第4步：创建一个无限滚动的-ListView" class="headerlink" title="第4步：创建一个无限滚动的 ListView"></a>第4步：创建一个无限滚动的 ListView</h2><p>在这一步，你将扩展 RandomWordsState 来生成和展示一个列表的词对。当用户滚动时，展示在 ListView widget 的列表会无限滚动。ListView 的 <code>builder</code> factory 构造方法允许你根据需要实现懒加载。</p>
<ol>
<li><p>在 RandomWordsState 类中增加一个 <code>_suggestions</code> list 来保存推荐的词对。注意变量以下划线（<code>_</code>）开头。在 Dart 语言中，以下划线作为前缀标志代表私有。</p>
<p> 也增加一个 <code>biggerFont</code> 变量来使字体变大。</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomWordsState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">RandomWords</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> _suggestions = &lt;WordPair&gt;[];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> _biggerFont = <span class="keyword">const</span> TextStyle(fontSize: <span class="number">18.0</span>);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 RandomWordsState 类中增加一个 <code>_buildSuggestions()</code> 方法。这个方法构建展示词对的 ListView。</p>
<p> ListView 类提供了一个 builder 属性，<code>itemBuilder</code>，以匿名方法的方式指定一个工厂构造器和回调方法。两个参数会被传入到方法中 —— BuildContext，和行迭代器，<code>i</code>。迭代器从0开始，每一次方法被调用时递增，每个推荐词对配对一次。这个模型允许在用户滚动时推荐列表无限滚动。</p>
<p> 增加以下高亮行：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomWordsState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">RandomWords</span>&gt; </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  Widget _buildSuggestions() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ListView.builder(</span><br><span class="line">      padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">16.0</span>),</span><br><span class="line">      <span class="comment">// The itemBuilder callback is called, once per suggested word pairing,</span></span><br><span class="line">      <span class="comment">// and places each suggestion into a ListTile row.</span></span><br><span class="line">      <span class="comment">// For even rows, the function adds a ListTile row for the word pairing.</span></span><br><span class="line">      <span class="comment">// For odd rows, the function adds a Divider widget to visually</span></span><br><span class="line">      <span class="comment">// separate the entries. Note that the divider may be difficult</span></span><br><span class="line">      <span class="comment">// to see on smaller devices.</span></span><br><span class="line">      itemBuilder: (context, i) &#123;</span><br><span class="line">        <span class="comment">// Add a one-pixel-high divider widget before each row in theListView.</span></span><br><span class="line">        <span class="keyword">if</span> (i.isOdd) <span class="keyword">return</span> <span class="keyword">new</span> Divider();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The syntax "i ~/ 2" divides i by 2 and returns an integer result.</span></span><br><span class="line">        <span class="comment">// For example: 1, 2, 3, 4, 5 becomes 0, 1, 1, 2, 2.</span></span><br><span class="line">        <span class="comment">// This calculates the actual number of word pairings in the ListView,</span></span><br><span class="line">        <span class="comment">// minus the divider widgets.</span></span><br><span class="line">        <span class="keyword">final</span> index = i ~/ <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// If you've reached the end of the available word pairings...</span></span><br><span class="line">        <span class="keyword">if</span> (index &gt;= _suggestions.length) &#123;</span><br><span class="line">          <span class="comment">// ...then generate 10 more and add them to the suggestions list.</span></span><br><span class="line">          _suggestions.addAll(generateWordPairs().take(<span class="number">10</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> _buildRow(_suggestions[index]);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>_buildSuggestions</code> 方法在每个词配对时调用。这个方法在一个 ListTile 中展示一个新的配对，在下一步中它允许你在行中增加交互。</p>
<p> 在 <code>RandomWordsState</code> 中增加一个 <code>_buildRow</code> 方法：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomWordsState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">RandomWords</span>&gt; </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  Widget _buildRow(WordPair pair) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ListTile(</span><br><span class="line">      title: <span class="keyword">new</span> Text(</span><br><span class="line">        pair.asPascalCase,</span><br><span class="line">        style: _biggerFont,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <code>_buildSuggestions()</code> 来更新 RandomWordsState 的 build 方法，而不是直接调用生成词对的库。修改以下高亮改变：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomWordsState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">RandomWords</span>&gt; </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">final</span> wordPair = <span class="keyword">new</span> WordPair.random(); <span class="comment">// Delete these two lines.</span></span><br><span class="line">    Return <span class="keyword">new</span> Text(wordPair.asPascalCase);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Scaffold (</span><br><span class="line">      appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">        title: <span class="keyword">new</span> Text(<span class="string">'Startup Name Generator'</span>),</span><br><span class="line">      ),</span><br><span class="line">    body: _buildSuggestions(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新 MyApp 的 build 方法。在 MyApp 中移除 Scaffold 和 AppBar 实例。这些应该由 RandomWordsState 去管理，这让在下一步中导航到另一个页面时修改 app bar 的名字更简单。</p>
<p> 用下面高亮的 build 方法替换原生的方法：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MaterialApp(</span><br><span class="line">      title: <span class="string">'Startup Name Generator'</span>,</span><br><span class="line">      home: <span class="keyword">new</span> RandomWords(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>重启 app，你将看到一个词对列表。按你想要的去滚动列表，你会看到新的词对。</p>
<div style="text-align: center;"><br><img src="https://flutter.io/get-started/codelab/images/step4-screenshot.png"><br></div>

<h3 id="问题？-2"><a href="#问题？-2" class="headerlink" title="问题？"></a>问题？</h3><p>如果你的 app 没有正确运行，排查错误。如果需要，请使用以下链接的代码来追踪。</p>
<ul>
<li><a href="https://gist.githubusercontent.com/Sfshaza/d7f13ddd8888556232476be8578efe40/raw/329c397b97309ce99f834bf70ebb90778baa5cfe/main.dart" target="_blank" rel="noopener">lib/main.dart</a></li>
</ul>
<hr>
<p><span id="step-5-add-interactivity"></span></p>
<h2 id="第5步：增加交互"><a href="#第5步：增加交互" class="headerlink" title="第5步：增加交互"></a>第5步：增加交互</h2><p>在这一步，你将在没行增加一个可点击的心型图标。当用户点击 list 中的每行时，切换它的 “喜欢” 状态，这会触发词对在保存的集合中增加或者删除。</p>
<ol>
<li><p>在 RandomWordsState 中增加一个 <code>_saved</code> 集合。这个集合存储了用户喜欢了的词对。集合首选 List，因为正确的实现是 Set 不允许重复的条目。</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomWordsState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">RandomWords</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> _suggestions = &lt;WordPair&gt;[];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> _saved = <span class="keyword">new</span> <span class="built_in">Set</span>&lt;WordPair&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> _biggerFont = <span class="keyword">const</span> TextStyle(fontSize: <span class="number">18.0</span>);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <code>_buildRow</code> 方法中，增加一个 <code>alreadySaved</code> 检查来确保词对是否已经添加到喜欢集合中了。</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Widget _buildRow(WordPair pair) &#123;</span><br><span class="line">  <span class="keyword">final</span> alreadySaved = _saved.contains(pair);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <code>_buildRow()</code>，增加一个心型的图标到 ListTile 来启用喜欢状态。稍后，你会在这个心型图标上增加一个交互。</p>
<p> 增加以下高亮：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Widget _buildRow(WordPair pair) &#123;</span><br><span class="line">  <span class="keyword">final</span> alreadySaved = _saved.contains(pair);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ListTile(</span><br><span class="line">    title: <span class="keyword">new</span> Text(</span><br><span class="line">      pair.asPascalCase,</span><br><span class="line">      style: _biggerFont,</span><br><span class="line">    ),</span><br><span class="line">    trailing: <span class="keyword">new</span> Icon(</span><br><span class="line">      alreadySaved ? Icons.favorite : Icons.favorite_border,</span><br><span class="line">      color: alreadySaved ? Colors.red : <span class="keyword">null</span>,</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启 app，现在你会看到每行都有心型图标，但是它们还不能交互。</p>
</li>
<li><p>在 <code>_buildRow</code> 方法中让心形图标可点击。如果一个词对已经被添加到喜欢集合，再次点击会从喜欢集合中删除。当心形图标被点击，调用<code>setState()</code>方法来通知系统状态被改变。</p>
<p> 增加高亮行：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Widget _buildRow(WordPair pair) &#123;</span><br><span class="line">  <span class="keyword">final</span> alreadySaved = _saved.contains(pair);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ListTile(</span><br><span class="line">    title: <span class="keyword">new</span> Text(</span><br><span class="line">      pair.asPascalCase,</span><br><span class="line">      style: _biggerFont,</span><br><span class="line">    ),</span><br><span class="line">    trailing: <span class="keyword">new</span> Icon(</span><br><span class="line">      alreadySaved ? Icons.favorite : Icons.favorite_border,</span><br><span class="line">      color: alreadySaved ? Colors.red : <span class="keyword">null</span>,</span><br><span class="line">    ),</span><br><span class="line">    onTap: () &#123;</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        <span class="keyword">if</span> (alreadySaved) &#123;</span><br><span class="line">          _saved.remove(pair);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          _saved.add(pair);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p><strong>提示：</strong>在 Flutter 响应式风格框架中，调用 <strong>setState()</strong> 触发 State 对象的 <strong>build()</strong> 方法的调用，结果更新在 UI 中。</p>
</blockquote>
<p>热重载 app，你应该会看到点击任意行来喜欢，取消喜欢条目。注意，点击一行会生成从心型图标发出的隐式墨迹飞溅动画。</p>
<div style="text-align: center;"><br><img src="https://flutter.io/get-started/codelab/images/step5-screenshot.png"><br></div>

<h3 id="问题？-3"><a href="#问题？-3" class="headerlink" title="问题？"></a>问题？</h3><p>如果你的 app 没有正确运行，排查错误。如果需要，请使用以下链接的代码来追踪。</p>
<ul>
<li><a href="https://gist.githubusercontent.com/Sfshaza/d7f13ddd8888556232476be8578efe40/raw/329c397b97309ce99f834bf70ebb90778baa5cfe/main.dart" target="_blank" rel="noopener">lib/main.dart</a></li>
</ul>
<hr>
<p><span id="step-6-navigate-to-a-new-screen"></span></p>
<h2 id="第6步：导航到新的页面"><a href="#第6步：导航到新的页面" class="headerlink" title="第6步：导航到新的页面"></a>第6步：导航到新的页面</h2><p>在这一步，你将增加一个新的页面（在 Flutter 被称为 <em>router</em>）用来展示喜欢的集合。你将会学习到怎么从首页导航到一个新的页面。</p>
<p>在 Fluter，Navigator 管理包含了 app 路由页面的栈。压入一个页面到 Navigator 的栈，更新展示那个页面。从 Navigator 弹出一个页面，返回展示上一个页面。</p>
<ol>
<li><p>在 RandomWordsState 的 build 方法中增加一个列表图标到 AppBar 上。当用户点击这个列表图标，一个包含了喜欢的条目的新页面被压入到 Navigator，展示图标。</p>
<blockquote>
<p><strong>提示：</strong>一些widget属性接收单个 widget（<strong>child</strong>），其它的属性，如 <strong>action</strong>，接收一个数组 widgets（<strong>children</strong>），通过中括号（[]）标明。</p>
</blockquote>
<p> 在 build 方法中增加图标和它对应的 action：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomWordsState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">RandomWords</span>&gt; </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Scaffold(</span><br><span class="line">      appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">        title: <span class="keyword">new</span> Text(<span class="string">'Startup Name Generator'</span>),</span><br><span class="line">        actions: &lt;Widget&gt;[</span><br><span class="line">          <span class="keyword">new</span> IconButton(icon: <span class="keyword">new</span> Icon(Icons.list), onPressed: _pushSaved),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">      body: _buildSuggestions(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 RandomWordsState 类中增加一个 <code>_pushSaved()</code> 方法。</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomWordsState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">RandomWords</span>&gt; </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">void</span> _pushSaved() &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 热重载 app，列表图标出现在 app bar 上。点击它还不会发生任何事情，因为 <code>_pushSaved</code> 方法是空的。</p>
</li>
<li><p>当用户点击 app bar 上的列表图标，构建一个页面并压入 Navigator 的栈中。这个 action 会改变屏幕去展示新的页面。</p>
<p> 新页面的内容在 MaterialPageRoute 的 <code>builder</code> 属性中通过匿名方法构建。</p>
<p> 增加调用 <code>Navigator.push</code>，如下高亮代码展示，把页面压入到 Navigator 的栈里。</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _pushSaved() &#123;</span><br><span class="line">  Navigator.of(context).push(</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>增加 MaterialPageRoute 和它的 builder。现在，增加生成 ListTile 行的代码。ListTile 的 <code>divideTiles()</code> 方法在每个 ListTile 之间添加水平间距。分割变量保存最后一行，由 convienice 函数 <code>toList()</code> 转换为列表。</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _pushSaved() &#123;</span><br><span class="line">  Navigator.of(context).push(</span><br><span class="line">    <span class="keyword">new</span> MaterialPageRoute(</span><br><span class="line">      builder: (context) &#123;</span><br><span class="line">        <span class="keyword">final</span> tiles = _saved.map(</span><br><span class="line">              (pair) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ListTile(</span><br><span class="line">              title: <span class="keyword">new</span> Text(</span><br><span class="line">                pair.asPascalCase,</span><br><span class="line">                style: _biggerFont,</span><br><span class="line">              ),</span><br><span class="line">            );</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">final</span> divided = ListTile</span><br><span class="line">            .divideTiles(</span><br><span class="line">          context: context,</span><br><span class="line">          tiles: tiles,</span><br><span class="line">        )</span><br><span class="line">            .toList();</span><br><span class="line">      &#125;,</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>builder 属性返回一个 Scaffold，包含了新页面的 app bar，名为 “Save Suggestions”。新页面 body 的构成是一个 ListView 包含了 ListTiles 行；每行由分隔符分割。</p>
<p> 增加以下高亮代码：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _pushSaved() &#123;</span><br><span class="line">  Navigator.of(context).push(</span><br><span class="line">    <span class="keyword">new</span> MaterialPageRoute(</span><br><span class="line">      builder: (context) &#123;</span><br><span class="line">        <span class="keyword">final</span> tiles = _saved.map(</span><br><span class="line">              (pair) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ListTile(</span><br><span class="line">              title: <span class="keyword">new</span> Text(</span><br><span class="line">                pair.asPascalCase,</span><br><span class="line">                style: _biggerFont,</span><br><span class="line">              ),</span><br><span class="line">            );</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">final</span> divided = ListTile</span><br><span class="line">            .divideTiles(</span><br><span class="line">          context: context,</span><br><span class="line">          tiles: tiles,</span><br><span class="line">        )</span><br><span class="line">            .toList();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Scaffold(</span><br><span class="line">          appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">            title: <span class="keyword">new</span> Text(<span class="string">'Saved Suggestions'</span>),</span><br><span class="line">          ),</span><br><span class="line">          body: <span class="keyword">new</span> ListView(children: divided),</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>热重载 app，喜欢其中的一些条目并点击 app bar 上的列表图标。新页面展示出来，且包含了喜欢的条目。注意 Navigator 在 app bar 上增加了一个 “Back” 按钮。你不需要明确地实现 Navigator.pop。点击返回按钮来返回首页。</p>
 <div style="text-align: center;"><br> <img src="https://flutter.io/get-started/codelab/images/step6a-screenshot.png"><br> <img src="https://flutter.io/get-started/codelab/images/step6b-screenshot.png"><br> </div>

</li>
</ol>
<h3 id="问题？-4"><a href="#问题？-4" class="headerlink" title="问题？"></a>问题？</h3><p>如果你的 app 没有正确运行，排查错误。如果需要，请使用以下链接的代码来追踪。</p>
<ul>
<li><a href="https://gist.githubusercontent.com/Sfshaza/d7f13ddd8888556232476be8578efe40/raw/329c397b97309ce99f834bf70ebb90778baa5cfe/main.dart" target="_blank" rel="noopener">lib/main.dart</a></li>
</ul>
<hr>
<p><span id="step-7-change-the-ui-using-themes"></span></p>
<h2 id="第7步：使用-Theme-来改变-UI"><a href="#第7步：使用-Theme-来改变-UI" class="headerlink" title="第7步：使用 Theme 来改变 UI"></a>第7步：使用 Theme 来改变 UI</h2><p>在这一步，你将玩转 app 的 theme。<strong>Theme</strong>会控制你的 app 的视觉和感觉。你可以使用默认的 theme，这依赖于物理设备或者模拟器，或者你可以自定义 theme 来反映出你的品牌。</p>
<ol>
<li><p>你可以很简单地通过配置 ThemeData 类来改变 app 的主题。你的 app当前使用的是默认的主题，但是你将修改主要颜色为白色。</p>
<p> 通过增加高亮的代码到 MyApop 来改变 app 的主题为白色：</p>
 <figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MaterialApp(</span><br><span class="line">      title: <span class="string">'Startup Name Generator'</span>,</span><br><span class="line">      theme: <span class="keyword">new</span> ThemeData(</span><br><span class="line">        primaryColor: Colors.white,</span><br><span class="line">      ),</span><br><span class="line">      home: <span class="keyword">new</span> RandomWords(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>热重载 app，注意，整个背景都是白色的，甚至是 app bar。</p>
</li>
<li><p>作为读者的联系，使用 <a href="https://docs.flutter.io/flutter/material/ThemeData-class.html" target="_blank" rel="noopener">ThemeData</a> 来改变 UI 的其它方面。Material 库中的 <a href="https://docs.flutter.io/flutter/material/Colors-class.html" target="_blank" rel="noopener">Colors</a> 类提供了很多颜色常量可以使用，然后热重载使得 UI 实验变的又快又简单。</p>
 <div style="text-align: center;"><br> <img src="https://flutter.io/get-started/codelab/images/step7-themes.png"><br> </div>

</li>
</ol>
<h3 id="问题？-5"><a href="#问题？-5" class="headerlink" title="问题？"></a>问题？</h3><p>如果你的 app 没有正确运行，排查错误。如果需要，请使用以下链接的代码来追踪。</p>
<ul>
<li><a href="https://gist.githubusercontent.com/Sfshaza/d7f13ddd8888556232476be8578efe40/raw/329c397b97309ce99f834bf70ebb90778baa5cfe/main.dart" target="_blank" rel="noopener">lib/main.dart</a></li>
</ul>
<hr>
<p><span id="well-done"></span></p>
<h2 id="干得不错"><a href="#干得不错" class="headerlink" title="干得不错"></a>干得不错</h2><p>你已写了一个运行在 iOS 和 Android 的具有交互性的 Flutter app。在这个 codelab，你已经：</p>
<ul>
<li>从头创建了一个 Flutter app。</li>
<li>编写 Dart 代码。</li>
<li>使用外部第三方库。</li>
<li>使用热重载来进行快速的开发周期。</li>
<li>实现了 stateful widget，给你的 app 增加了互动性。</li>
<li>使用 ListView 和 ListTiles 创建了一个懒加载，无限滚动的列表。</li>
<li>创建了一个页面，且增加了在主页和新的页面之前移动的逻辑。</li>
<li>学习改变 app 主题外观和主题</li>
</ul>
]]></content>
      
        <categories>
            
            <category> flutter </category>
            
            <category> dart </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> flutter </tag>
            
            <tag> ios </tag>
            
            <tag> dart </tag>
            
            <tag> widget </tag>
            
            <tag> fuchsia </tag>
            
            <tag> Google </tag>
            
            <tag> codelab </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[在Android上编写模块化项目（翻译）]]></title>
      <url>/2018/02/13/writing_a_modular_project_on_android/</url>
      <content type="html"><![CDATA[<blockquote>
<p>原文：<a href="https://medium.com/mindorks/writing-a-modular-project-on-android-304f3b09cb37" target="_blank" rel="noopener">https://medium.com/mindorks/writing-a-modular-project-on-android-304f3b09cb37</a></p>
</blockquote>
<h1 id="在Android上编写模块化项目（翻译）"><a href="#在Android上编写模块化项目（翻译）" class="headerlink" title="在Android上编写模块化项目（翻译）"></a>在Android上编写模块化项目（翻译）</h1><p>当我们在 Android Studio 上创建一个新的项目时，自带一个 <code>app</code> module。这时我们大多数人编写整个应用的地方。每次点击 <code>run</code> 按钮都会触发我们整个所有 module 上的 gradle 构建，并检查所有文件是否有变化。这就是为什么 gradle 构建会在更大的应用程序上花费 <a href="https://eng.uber.com/android-monorepo/" target="_blank" rel="noopener">10分钟</a>的时间，并且减慢开发者的<a href="https://imgs.xkcd.com/comics/compiling.png" target="_blank" rel="noopener">输出</a>。</p>
<p>要解决这个问题，复杂的应用程序，如 Uber 决定对它们的应用程序进行模块化并从中<a href="https://www.youtube.com/watch?v=j6CiHlapado" target="_blank" rel="noopener">获得</a>了很多。下面是试用模块化项目的一些优势：</p>
<a id="more"></a>
<ul>
<li><a href="https://proandroiddev.com/modular-architecture-for-faster-build-time-d58397cb7bfe" target="_blank" rel="noopener">更快</a>的 gradle 构建</li>
<li>跨应用/模块复用通用的功能</li>
<li>易于插拔到<a href="https://developer.android.com/topic/instant-apps/overview.html#features" target="_blank" rel="noopener">Instant apps</a></li>
<li>更好的团队工作，一个人可以单独负责一个模块</li>
<li>更流畅地git flows</li>
</ul>
<p>由于上述优势，当我刚开始<a href="https://github.com/karntrehan/Posts/" target="_blank" rel="noopener">Posts</a>这个应用时，我就在始终坚持使用模块化方法。对此，Android 团队已经给我们提供了一些<a href="https://developer.android.com/google/play/publishing/multiple-apks.html#CreatingApks" target="_blank" rel="noopener">工具</a>，但是我确实遇到了一些障碍，一下是我学习到的内容：</p>
<h2 id="我该怎么分割我的-modules-？"><a href="#我该怎么分割我的-modules-？" class="headerlink" title="我该怎么分割我的 modules ？"></a>我该怎么分割我的 modules ？</h2><p>你的应用程序是流程集构成的，比如，Google Play 有<strong>应用详情</strong>流，它包含了简要，描述详情，应用截图，评论活动等。</p>
<p><img src="https://user-images.githubusercontent.com/5423194/36140651-ed8f0d6c-10dc-11e8-9733-e306fd72f9d0.jpeg" alt=""></p>
<p>所有这些都可以归为同一模块 —— <code>app-details</code>。</p>
<p>你的应用会包含多个类似流程的模块，有 <code>authentication</code>, <code>settings</code>, <code>on-boarding</code>等等。当然还有一些不需要UI元素呈现的模块如 —— <code>notifications</code>, <code>analytics</code>, <code>first-fetch</code>等等。这些模块包含与流程有关的 activities, repositories, entities和依赖注入相关东西。</p>
<div style="text-align: center;"><br><img src="https://user-images.githubusercontent.com/5423194/36140945-09253f5a-10de-11e8-8ded-003e53fd78b6.png"><br></div>

<p>但是这些模块中总是有一些共同的功能和工具。这就是为什么你需要一个 core 模块。</p>
<h2 id="什么是-core-模块-？"><a href="#什么是-core-模块-？" class="headerlink" title="什么是 core 模块 ？"></a>什么是 core 模块 ？</h2><p><code>Core</code> 模块是一个你项目中简单的 module 库。core 库可以（除其它外），</p>
<ul>
<li>给你的依赖注入框架提供全局依赖，如 <a href="https://github.com/karntrehan/Posts/blob/master/core/src/main/java/com/karntrehan/posts/core/di/NetworkModule.kt" target="_blank" rel="noopener">Retrofit</a>, <a href="https://github.com/karntrehan/Posts/blob/master/core/src/main/java/com/karntrehan/posts/core/di/StorageModule.kt" target="_blank" rel="noopener">SharedPreferences</a>等等。</li>
<li>包含工具类和<a href="https://github.com/karntrehan/Posts/tree/master/core/src/main/java/com/karntrehan/posts/core/extensions" target="_blank" rel="noopener">扩展方法</a></li>
<li>包含<a href="https://github.com/karntrehan/Posts/blob/master/core/src/main/java/com/karntrehan/posts/core/networking/Outcome.kt" target="_blank" rel="noopener">全局类</a>和回调</li>
<li>在 application 类中的<a href="https://github.com/karntrehan/Posts/blob/master/core/src/main/java/com/karntrehan/posts/core/application/CoreApp.kt" target="_blank" rel="noopener">初始化库</a>，如 Firebase Analytics，Crashlytics，LeakCanary，Stetho等等</li>
</ul>
<h2 id="怎么使用第三方库？"><a href="#怎么使用第三方库？" class="headerlink" title="怎么使用第三方库？"></a>怎么使用第三方库？</h2><p>核心(<code>core</code>)模块的其中一个职责是为你的功能(<code>feature</code>)模块提供外部依赖。这使得很容易实现在你的 <code>feature</code> 模块中共享相同版本的库。只需要在你的 <code>core</code> 模块的 dependencies 中使用 <code>api</code>，这样你就能在所有 <code>feature</code> 模块中使用它们。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    api fileTree(<span class="string">include:</span> [<span class="string">'*.jar'</span>], <span class="string">dir:</span> <span class="string">'libs'</span>)</span><br><span class="line">    api deps.support.appCompat</span><br><span class="line">    api deps.support.recyclerView</span><br><span class="line">    api deps.support.cardView</span><br><span class="line">    api deps.support.support</span><br><span class="line">    api deps.support.designSupport</span><br><span class="line"></span><br><span class="line">    api deps.android.lifecycleExt</span><br><span class="line">    api deps.android.lifecycleCommon</span><br><span class="line">    api deps.android.roomRuntime</span><br><span class="line">    api deps.android.roomRx</span><br><span class="line"></span><br><span class="line">    api deps.kotlin.stdlib</span><br><span class="line"></span><br><span class="line">    api deps.reactivex.rxJava</span><br><span class="line">    api deps.reactivex.rxAndroid</span><br><span class="line"></span><br><span class="line">    api deps.google.dagger</span><br><span class="line">    kapt deps.google.daggerProcessor</span><br><span class="line"></span><br><span class="line">    api deps.square.picasso</span><br><span class="line">    api deps.square.okhttpDownloader</span><br><span class="line"></span><br><span class="line">    api deps.square.retrofit</span><br><span class="line">    api deps.square.okhttp</span><br><span class="line">    api deps.square.gsonConverter</span><br><span class="line">    api deps.square.retrofitRxAdapter</span><br><span class="line"></span><br><span class="line">    implementation deps.facebook.stetho</span><br><span class="line">    implementation deps.facebook.networkInterceptor</span><br><span class="line"></span><br><span class="line">    testApi deps.test.junit</span><br><span class="line">    androidTestApi deps.test.testRunner</span><br><span class="line">    androidTestApi deps.test.espressoCore</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有种依赖的可能性是只有对 <code>feature-a</code> 模块有用，但是在 <code>feature-b</code> 中无用。对于这种情况，我推荐在你的 core 的依赖中使用 <code>api</code>，因为 proguard 注意到而不会包含在 <code>feature-b</code> instant app 中。</p>
<h2 id="怎么使用-Room-？"><a href="#怎么使用-Room-？" class="headerlink" title="怎么使用 Room ？"></a>怎么使用 Room ？</h2><p>这个困扰我挺久的时间。我们希望把我们的数据库定义到 <code>core</code> 模块中，因为它是我们应用程序要共享的通用的功能。为了让 Room 工作，你需要一个包含了所有 entity 类的数据库文件。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Database(entities = [Post::class, User::class, Comment::class], version = 1,exportSchema = false)</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PostDb</span> : <span class="type">RoomDatabase</span></span>() &#123;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">postDao</span><span class="params">()</span></span>: PostDao</span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">userDao</span><span class="params">()</span></span>: UserDao</span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">commentDao</span><span class="params">()</span></span>: CommentDao</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，如上面提到的，我们的 entity 类是被定义在 <code>feature</code> 模块中，而且 <code>core</code> 模块不能去访问它们。这是我碰到障碍的地方，经过一番思考后，你做了一件最棒的事，寻求 <a href="https://github.com/yigit" target="_blank" rel="noopener">Yigit</a> 的帮助。</p>
<p>Yigit 阐明了观点，你必须要在每个 <code>feature</code>模块中都创建一个新的 db 文件，然后每个模块一个数据库。</p>
<p>这有几个好处：</p>
<ul>
<li><a href="https://medium.com/google-developers/understanding-migrations-with-room-f01e04b07929" target="_blank" rel="noopener">迁移</a>是模块化的</li>
<li>即时 app 仅包含它们需要的表</li>
<li>查询会更快</li>
</ul>
<p>缺点：</p>
<ul>
<li>跨模块数据关系将不可能</li>
</ul>
<p><em>注意：为了 Room 的注解能够工作，不要忘记在你的 <code>feature</code> 模块中增加下面依赖</em></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kapt <span class="string">"android.arch.persistence.room:compiler:$&#123;versions.room&#125;"</span></span><br></pre></td></tr></table></figure>
<h2 id="怎么使用-Dagger-2-？"><a href="#怎么使用-Dagger-2-？" class="headerlink" title="怎么使用 Dagger 2 ？"></a>怎么使用 Dagger 2 ？</h2><p>同样的问题 Dagger 也遇到了。我的 core 模块中的 application 类不能访问和初始化我 <code>feature</code> 模块中的组件。这是从属组件完美的用例。</p>
<p>你的 core 组件定义了它想要暴露给依赖组件的依赖关系</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component(modules = [AppModule::class, NetworkModule::class, StorageModule::class, ImageModule::class])</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CoreComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">context</span><span class="params">()</span></span>: Context</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">retrofit</span><span class="params">()</span></span>: Retrofit</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">picasso</span><span class="params">()</span></span>: Picasso</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">sharedPreferences</span><span class="params">()</span></span>: SharedPreferences</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">scheduler</span><span class="params">()</span></span>: Scheduler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>您的模块组件将 <code>CoreComponent</code> 定义为依赖项，并使用传递的依赖</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ListScope</span></span><br><span class="line"><span class="meta">@Component(dependencies = [CoreComponent::class], modules = [ListModule::class])</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ListComponent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">inject</span><span class="params">(listActivity: <span class="type">ListActivity</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="meta">@ListScope</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*Uses parent's provided dependencies like Picasso, Context and Retrofit*/</span></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@ListScope</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">adapter</span><span class="params">(picasso: <span class="type">Picasso</span>)</span></span>: ListAdapter = ListAdapter(picasso)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@ListScope</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">postDb</span><span class="params">(context: <span class="type">Context</span>)</span></span>: PostDb = Room.databaseBuilder(context, PostDb::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>, <span class="type">Constants.Posts.DB_NAME).build</span></span>()</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@ListScope</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">postService</span><span class="params">(retrofit: <span class="type">Retrofit</span>)</span></span>: PostService = retrofit.create(PostService::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="在哪里初始化我的-components-？"><a href="#在哪里初始化我的-components-？" class="headerlink" title="在哪里初始化我的 components ？"></a>在哪里初始化我的 components ？</h2><p>我为我的功能的所有组件创建了一个单例 holder。这个 holder 用于创建，维护和销毁我的 component 实例。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="keyword">object</span> PostDH &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> listComponent: ListComponent? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">listComponent</span><span class="params">()</span></span>: ListComponent &#123;</span><br><span class="line">        <span class="keyword">if</span> (listComponent == <span class="literal">null</span>)</span><br><span class="line">            listComponent = DaggerListComponent.builder().coreComponent(CoreApp.coreComponent).build()</span><br><span class="line">        <span class="keyword">return</span> listComponent <span class="keyword">as</span> ListComponent</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">destroyListComponent</span><span class="params">()</span></span> &#123;</span><br><span class="line">        listComponent = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>注意：为了 Dagger 的注解能够工作，不要忘记在你的 <code>feature</code> 模块中增加下面依赖</em></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kapt <span class="string">"com.google.dagger:dagger-compiler:$&#123;versions.dagger&#125;"</span></span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>尽管把你的单独的 application 转成模块化有一些棘手，其中一些我试图通过上面的方法来解决，优点是深刻的。如果您在模块中遇到任何障碍，请随时在下面提及它们，我们可以一起讨论解决方案。</p>
<p>谢谢。</p>
]]></content>
      
        <categories>
            
            <category> android </category>
            
            <category> gradle plugin </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> architecture </tag>
            
            <tag> 翻译 </tag>
            
            <tag> framework </tag>
            
            <tag> dagger2 </tag>
            
            <tag> modular </tag>
            
            <tag> room </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android端生成META-INF信息文件的Gradle插件 RapidMetaInfPlugin]]></title>
      <url>/2018/02/05/Android%E7%AB%AF%E7%94%9F%E6%88%90META-INF%E4%BF%A1%E6%81%AF%E6%96%87%E4%BB%B6%E7%9A%84Gradle%E6%8F%92%E4%BB%B6%20RapidMetaInfPlugin/</url>
      <content type="html"><![CDATA[<h1 id="Android端生成META-INF信息文件的Gradle插件-RapidMetaInfPlugin"><a href="#Android端生成META-INF信息文件的Gradle插件-RapidMetaInfPlugin" class="headerlink" title="Android端生成META-INF信息文件的Gradle插件 RapidMetaInfPlugin"></a>Android端生成META-INF信息文件的Gradle插件 RapidMetaInfPlugin</h1><h2 id="1-需求背景"><a href="#1-需求背景" class="headerlink" title="1. 需求背景"></a>1. 需求背景</h2><p>最近新遇到了一个需求，想在自己的一些库中写入版本信息，在别人使用了我的库后，我可以通过apk文件检测出依赖了我的哪个版本的库。感觉这个需求有点多余？那就举个例子吧。</p>
<p>比如，我编写了一个开源库：<a href="https://github.com/wangjiegulu/RapidORM" target="_blank" rel="noopener">RapidORM</a>，并<a href="http://blog.wangjiegulu.com/2015/04/02/Android-%E4%BD%BF%E7%94%A8Gradle%E6%8F%90%E4%BA%A4%E8%87%AA%E5%B7%B1%E5%BC%80%E6%BA%90Android%E5%BA%93%E5%88%B0Maven%E4%B8%AD%E5%BF%83%E5%BA%93/">上传到了Maven中心库</a> ，假设一个我不认识的开发者（暂且称它为<code>X</code>）在编写app，这个app中的代码对我来说是完全未知的，但是他通过在<code>build.gradle</code>中添加了如下依赖：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">"com.github.wangjiegulu:rapidorm:1.0.0"</span></span><br><span class="line">compile <span class="string">"com.github.wangjiegulu:rapidorm-api:1.0.0"</span></span><br><span class="line">apt <span class="string">"com.github.wangjiegulu:rapidorm-compiler:1.0.0"</span></span><br></pre></td></tr></table></figure>
<p>很明显，<code>X</code>依赖了我写的<code>RapidORM</code>库。并且打包成了Apk文件然后发布。这时我下载了这个apk，并且希望得到这个apk中依赖的<code>RapidORM</code>版本是多少？这个<code>RapidORM</code>在构建这个aar时的开发环境是怎么样的？反编译可能有希望能拿到<code>RapidORM</code>具体的版本号，但是aar当时的构建环境就无法得知了。</p>
<p>这时，我就希望在我发布<code>RapidORM</code>的Release版本的时候能够在aar中携带好一些自定义的参数，并且这些信息会在依赖了这个库的开发者<code>X</code>构建apk的时候跟随保存到apk文件中。</p>
<p>比较典型的一个例子当你依赖了<code>RxJava</code>这个库，我们构建apk完成之后，会发现在我们的apk文件中的<code>META-INF</code>文件夹下面会有一个<code>rxjava.properties</code>文件，打开这个文件就会发现如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version=1.0</span><br><span class="line">Implementation-Title=io.reactivex.rxjava2#rxjava;2.1.2</span><br><span class="line">Implementation-Version=2.1.2</span><br><span class="line">Built-Status=integration</span><br><span class="line">Built-By=travis</span><br><span class="line">Built-OS=Linux</span><br><span class="line">Build-Date=2017-07-23_08:21:58</span><br><span class="line">Gradle-Version=2.14</span><br><span class="line">Module-Owner=benjchristensen@netflix.com</span><br><span class="line">Module-Email=benjchristensen@netflix.com</span><br><span class="line">Module-Source=</span><br><span class="line">Module-Origin=https://github.com/ReactiveX/RxJava.git</span><br><span class="line">Change=e4fbe4c</span><br><span class="line">Branch=e4fbe4cfcb3c240d14a42a586eecbbd74cb379d2</span><br><span class="line">Build-Host=testing-gce-361876de-b66f-4569-b841-e037b0fee9af</span><br><span class="line">Build-Job=LOCAL</span><br><span class="line">Build-Number=LOCAL</span><br><span class="line">Build-Id=LOCAL</span><br><span class="line">Created-By=1.7.0_80-b15 (Oracle Corporation)</span><br><span class="line">Build-Java-Version=1.7.0_80</span><br><span class="line">X-Compile-Target-JDK=1.6</span><br><span class="line">X-Compile-Source-JDK=1.6</span><br></pre></td></tr></table></figure>
<p>很显然，这个文件中包含了：<code>RxJava版本号</code>, <code>构建的CI信息</code>，<code>构建时间</code>, <code>Gradle版本</code>, <code>模块负责人信息</code>, <code>git分支</code>, <code>JDK版本</code>等等。</p>
<p>通过这个方式，我可以在任意的apk中拿到它依赖的<code>RxJava</code>的信息。</p>
<p>当然，你可以通过在<code>build.gradle</code>进行如下配置来过排除这个<code>rxjava.properties</code>文件（但是不建议这么做，这个文件也许能在你遇到问题时给你帮助）：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    packagingOptions &#123;</span><br><span class="line">        exclude <span class="string">'META-INF/rxjava.properties'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-RapidMetaInfPlugin-Gradle-插件"><a href="#2-RapidMetaInfPlugin-Gradle-插件" class="headerlink" title="2. RapidMetaInfPlugin Gradle 插件"></a>2. RapidMetaInfPlugin Gradle 插件</h2><blockquote>
<p><strong>RapidMetaInfPlugin:</strong> <a href="https://github.com/wangjiegulu/RapidMetaInfPlugin" target="_blank" rel="noopener">https://github.com/wangjiegulu/RapidMetaInfPlugin</a></p>
</blockquote>
<p>因此，写了 <a href="https://github.com/wangjiegulu/RapidMetaInfPlugin" target="_blank" rel="noopener">RapidMetaInfPlugin</a> 这个 Gradle 插件。</p>
<p>这次先说说怎么使用这个插件，以后抽时间再写一篇 Gradle 插件编写教程。之前也写过一个Gradle插件（详情见<a href="http://blog.wangjiegulu.com/2017/04/19/Android-Gradle-%E6%8F%92%E4%BB%B6-DiscardFilePlugin%EF%BC%88class%E6%B3%A8%E5%85%A5-%E6%B8%85%E7%A9%BA%E7%B1%BB%E5%92%8C%E6%96%B9%E6%B3%95%EF%BC%89/">Android Gradle 插件 DiscardFilePlugin（清空类和方法）</a>）也挺实用的。</p>
<h3 id="2-1-最终效果"><a href="#2-1-最终效果" class="headerlink" title="2.1 最终效果"></a>2.1 最终效果</h3><p>通过这个插件，我们可以在<code>apk</code>或者<code>aar</code>（<code>app</code>依赖后合并到<code>apk</code>）中写入任意信息。</p>
<p><img src="https://github.com/wangjiegulu/RapidMetaInfPlugin/raw/master/images/apk_meta_inf.png" width="600px"></p>
<p>以上在这个<code>apk</code>的<code>META-INF</code>中生成了一个名为<code>DAL_REQUEST.properties</code>的文件，内容中包含了<code>dal_request</code>这个库的名字、版本号和url。</p>
<h3 id="2-2-如何使用"><a href="#2-2-如何使用" class="headerlink" title="2.2 如何使用"></a>2.2 如何使用</h3><p>在你的<code>buildscript</code>的<code>dependencies</code>中添加<code>classpath</code>依赖（<a href="http://search.maven.org/#search%7Cga%7C1%7CRapidMetaInf" target="_blank" rel="noopener">点击这里获取最新版本</a>）：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">        google()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        classpath (<span class="string">'com.github.wangjiegulu:rapidmetainf:x.x.x'</span>)&#123;</span><br><span class="line">            exclude <span class="string">group:</span> <span class="string">'com.android.tools.build'</span>, <span class="string">module:</span> <span class="string">'gradle'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在你的apk或者aar的<code>build.gradle</code>文件的顶部写入以下代码来使用插件：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.github.wangjiegulu.plg.rapidmetainf'</span></span><br></pre></td></tr></table></figure>
<p>然后通过如下方式填写你需要写进<code>META-INF</code>目录中的文件信息：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rapidmetainf &#123;</span><br><span class="line">    metaInfName <span class="string">'DAL_REQUEST.properties'</span></span><br><span class="line">    metaInfProperties <span class="string">"archiveName=$dbarchiveName"</span>,</span><br><span class="line">            <span class="string">"archiveVersion=$dbarchiveVersion"</span>,</span><br><span class="line">            <span class="string">"archiveUrl=$dbarchiveUrl"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，<code>metaInfName</code>表示在<code>META-INF</code>目录中生成的文件名称（文件名任意取，但是不能以”.”开头），<code>metaInfProperties</code>表示要写入文件的数据，这个变量为数组类型，可通过Groovy语法来编写，比如通过<code>$符号来引用ext</code>，通过如下命令参数的方式等等：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">rapidmetainf &#123;</span><br><span class="line">    metaInfName <span class="string">'DAL_REQUEST_DEMO.properties'</span></span><br><span class="line"></span><br><span class="line">    String[] infArray = <span class="keyword">new</span> String[<span class="number">10</span>]</span><br><span class="line">    <span class="comment">// ./gradlew clean build -PcommandKey=commandValue</span></span><br><span class="line">    infArray[<span class="number">0</span>] = <span class="string">"propertyFromCommand=$&#123;getParameter('commandKey')&#125;"</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; infArray.length; i++)&#123;</span><br><span class="line">        infArray[i] = <span class="string">"array_item_key_$i=array_item_value_$i"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    metaInfProperties infArray</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> getParameter(String key) &#123;</span><br><span class="line">    <span class="comment">// -D</span></span><br><span class="line">    String value = System.getProperty(key)</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != value &amp;&amp; value.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// -P</span></span><br><span class="line">    <span class="keyword">if</span> (hasProperty(key)) &#123;</span><br><span class="line">        <span class="keyword">return</span> getProperty(key)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上，CI构建时就可使用命令<code>./gradlew clean build -PcommandKey=commandValue</code>来把<code>commandValue</code>写入到文件中。</p>
]]></content>
      
        <categories>
            
            <category> android </category>
            
            <category> gradle plugin </category>
            
        </categories>
        
        
        <tags>
            
            <tag> android </tag>
            
            <tag> gradle </tag>
            
            <tag> gradle plugin </tag>
            
            <tag> Android Studio </tag>
            
            <tag> META-INF </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[IFCTT，即If Copy Then That，一个基于IFTTT的`This`实现]]></title>
      <url>/2017/12/20/Android-App-IFCTT%EF%BC%8C%E5%8D%B3If-Copy-Then-That%EF%BC%8C%E4%B8%80%E4%B8%AA%E5%9F%BA%E4%BA%8EIFTTT%E7%9A%84-This-%E5%AE%9E%E7%8E%B0/</url>
      <content type="html"><![CDATA[<p>IFCTT，即：<code>If Copy Then That</code>，是一个基于IFTTT（<code>If This Then That</code>）的”This”实现，它打通了”用户手机端操作”与”This条件触发”之间的桥梁，让这个过程更具方便性和快捷性。通过手机端的Copy动作，以”Tagged Email”的方式连接到IFTTT，从而触发IFTTT中所有支持的”That”行为。用户只需要复制然后选择触发IFTTT的”Hash Tag”即可，它支持用户配置多种”Hash Tag”来进行多种自定义方式内容传输，比如：</p>
<ul>
<li>手机端执行拷贝Url地址（随时随地，任何地方，如Twitter/Facebook/Instagram/wechat/weibo/blog…），一键通过IFCTT &amp; IFTTT，保存链接对应的文章到Instapaper/Pocket，最低成本实现Read it later</li>
<li>手机端执行拷贝文章内容，一键通过IFCTT &amp; IFTTT，保存发送对应的内容到Evernote/Google doc/kindle…</li>
<li>等等</li>
</ul>
<p>使用IFCTT需要以下几个条件：</p>
<ul>
<li>你需要拥有IFTTT账号，并开启相应的Applets</li>
<li>你需要使用与IFTTT相同的Email账号在IFCTT中进行smtp授权和配置</li>
</ul>
<p>首先，下载安装IFCTT App<font color="#FF2D51">（12月21日～12月28日圣诞节免限中）</font>：</p>
<font color="#FF2D51"><strong>Google Play：<a href="https://play.google.com/store/apps/details?id=com.wangjie.ifctt" target="_blank" rel="noopener">https://play.google.com/store/apps/details?id=com.wangjie.ifctt</a></strong></font>

<a id="more"></a>
<h2 id="IFCTT-Email配置"><a href="#IFCTT-Email配置" class="headerlink" title="IFCTT Email配置"></a>IFCTT Email配置</h2><blockquote>
<p><strong>根据你在IFTTT使用的邮箱来进行配置(推荐使用Gmail)</strong></p>
</blockquote>
<h3 id="1-Gmail邮箱配置"><a href="#1-Gmail邮箱配置" class="headerlink" title="1. Gmail邮箱配置"></a>1. Gmail邮箱配置</h3><p><span id="app_password"></span></p>
<h3 id="1-1-生成应用专用密码"><a href="#1-1-生成应用专用密码" class="headerlink" title="1.1 生成应用专用密码"></a>1.1 生成应用专用密码</h3><p>首先需要为IFCTT生成一个App专用密码，打开以下链接并登陆Google账号：</p>
<p><a href="https://support.google.com/accounts/answer/185833" target="_blank" rel="noopener">https://support.google.com/accounts/answer/185833</a></p>
<p>选择app为<code>Mail</code>：</p>
<p><img src="http://blog.wangjiegulu.com/web/ifctt/ifctt_email_configuration/app_password_01.png" width="700px/"></p>
<p>选择设备为<code>Other (Custom name)</code>：</p>
<p><img src="http://blog.wangjiegulu.com/web/ifctt/ifctt_email_configuration/app_password_02.png" width="700px/"></p>
<p>然后在输入框中填入<code>IFCTT</code>：</p>
<p><img src="http://blog.wangjiegulu.com/web/ifctt/ifctt_email_configuration/app_password_03.png" width="700px/"></p>
<p>然后，点击<code>GENERATE</code>：</p>
<p><img src="http://blog.wangjiegulu.com/web/ifctt/ifctt_email_configuration/app_password_04.png" width="700px/"></p>
<p><strong>以上黄色区域中的16个字符的密码就是我们需要的专用密码，选中复制</strong></p>
<h3 id="1-2-在IFCTT中配置Gmail"><a href="#1-2-在IFCTT中配置Gmail" class="headerlink" title="1.2 在IFCTT中配置Gmail"></a>1.2 在IFCTT中配置Gmail</h3><p>打开IFCTT，进入<code>Settings</code> -&gt; <code>Email Configuration</code> 并填写相关信息：</p>
<p><img src="http://blog.wangjiegulu.com/web/ifctt/ifctt_email_configuration/ifctt_email_configuration_01.png" width="400px/"></p>
<blockquote>
<p><strong>注意</strong>：</p>
<p><strong>password</strong>：为<a href="#app_password">1.1 生成应用专用密码</a>中生成的应用专用密码<br><strong>Extra properties</strong>：如果你使用的是Gmail邮箱，则内容不需要改动，保持最初始的状态即可</p>
</blockquote>
<h2 id="怎么使用IFCTT自带默认的Hash-tags"><a href="#怎么使用IFCTT自带默认的Hash-tags" class="headerlink" title="怎么使用IFCTT自带默认的Hash tags"></a>怎么使用IFCTT自带默认的Hash tags</h2><p>在安装完IFCTT之后，首次进入，app会自动帮你创建以下5个默认的Hash tags：</p>
<ul>
<li><strong>#instapaper</strong>：这个标签会使得当你复制了文本内容时，此标签会识别当前复制的内容，如果是链接，则通过IFTTT推送到你的<code>instapaper</code></li>
<li><strong>#box</strong>：这个标签会使得当你复制了文本内容时，此标签会通过IFTTT推送到你的box，把内容追加保存在box的路径为<code>IFTTT/Email/IFCTT</code>的文件中</li>
<li><strong>#evernote</strong>：这个标签会使得当你复制了文本内容时，此标签会通过IFTTT推送到你的<code>evernote</code>，把内容追加保存在<code>evernote</code>的名为<code>IFTTT/Email/IFCTT</code>的文件中</li>
<li><strong>#pocket</strong>：这个标签会使得当你复制了文本内容时，此标签会识别当前复制的内容，如果是链接，则通过IFTTT推送到你的<code>pocket</code></li>
<li><strong>#googledoc</strong>：这个标签会使得当你复制了文本内容时，此标签会通过IFTTT推送到你的<code>google docs</code>，把内容追加保存在<code>google docs</code>的名为<code>IFTTT/Email/IFCTT</code>的文件中</li>
</ul>
<p>第一次进入后，所有的Hash tags都是默认<code>OFF</code>状态的，如下图所示：</p>
<p><img src="http://blog.wangjiegulu.com/web/ifctt/ifctt_use_default_hash_tags/hash_tag_disabled.png" width="350/"></p>
<p>下面以开启<code>instapaper</code>这个Hash tag为例</p>
<p>首先点击进入<code>#instapaper</code>的编辑页面，如下图：</p>
<p><img src="http://blog.wangjiegulu.com/web/ifctt/ifctt_use_default_hash_tags/instapaper_detail.png" width="350/"></p>
<p>首先如上图中，先点击开启按钮</p>
<p>然后因为默认的Hash tag所对应的<code>IFTTT Applet</code>都已经创建好了，所以可以直接进入IFTTT的Applet界面添加并开启，如上图，点击红色字体部分或者<code>IFTTT</code>的图标，将会打开如下<code>IFTTT</code>的Applet界面：</p>
<p><img src="http://blog.wangjiegulu.com/web/ifctt/ifctt_use_default_hash_tags/ifttt_instapaper_applet.png" width="350/"></p>
<p>点击开启图标，这时IFTTT可能会让你绑定你的instapaper账号，按照流程正常绑定即可（如果以前已经绑定过了则不需要再次绑定），操作完毕后，IFTTT的instapaper applet就会开启。</p>
<p>最后返回到IFCTT <code>#instapaper</code>的编辑页面，点击右上角进行保存，成功后回到首页，instapaper的card将会变成彩色。</p>
<p>其他IFCTT自带默认的Hash tags开启方式都类似。</p>
<h2 id="创建自定义的Hash-tags"><a href="#创建自定义的Hash-tags" class="headerlink" title="创建自定义的Hash tags"></a>创建自定义的Hash tags</h2><p>除了<a href="http://blog.wangjiegulu.com/web/ifctt/ifctt_use_default_hash_tags/ifctt_use_default_hash_tags.md">使用IFCTT提供的默认Hash tags</a>之外，你还可以创建自己的Hash tags，现在我们来创建一个Hash tags实现如下功能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当你复制了一段文字后，点击此标签后，自动通过IFTTT在你的`Twitter`上发送一条推特</span><br></pre></td></tr></table></figure>
<p><img src="http://blog.wangjiegulu.com/web/ifctt/ifctt_create_custom_hash_tags/main_hash_tag.png" width="350/"></p>
<p>点击首页右上角的<code>+</code>按钮，添加一个Hash tag，</p>
<p><img src="http://blog.wangjiegulu.com/web/ifctt/ifctt_create_custom_hash_tags/new_twitter_hash_tag.png" width="350/"></p>
<p><span id="tag_twitter"><br>如上，填写<code>tag</code>为<code>twitter</code>（可以自己任意填写）和note（任意填写），除了填写以上信息，还需要在IFTTT中创建对应的<code>IFTTT Applet</code>，点击上图红色字或者IFTTT的图标，即会进入到IFTTT界面，点击下图顶部的<code>+</code>按钮来创建<code>IFTTT Applet</code>：</span></p>
<p><img src="http://blog.wangjiegulu.com/web/ifctt/ifctt_create_custom_hash_tags/ifttt_my_applet.png" width="350/"></p>
<p><code>this</code>（trigger）选择<code>Email</code>，并选择<strong><code>Send IFTTT an email tagged</code></strong>（必须）：</p>
<p><img src="http://blog.wangjiegulu.com/web/ifctt/ifctt_create_custom_hash_tags/ifttt_this_twitter.png" width="350/"></p>
<p>上图中的<code>Tag</code>输入为<code>twitter</code>（<a href="#tag_twitter">必须要与IFCTT中的一致</a>！），</p>
<p><code>that</code>（action）选择<code>Twitter</code>，并选择<strong><code>Post a tweet</code></strong>，然后设置如下：</p>
<p><img src="http://blog.wangjiegulu.com/web/ifctt/ifctt_create_custom_hash_tags/ifttt_post_a_tweet.png" width="350/"></p>
<p>上面中的<code>body</code>就是指的就是IFCTT中的复制内容</p>
<p>提交成功后，返回到IFCTT中的创建页面提交，这时Hash tag创建成功</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ifttt </tag>
            
            <tag> ifctt </tag>
            
            <tag> automate </tag>
            
            <tag> huginn </tag>
            
            <tag> hash tag </tag>
            
            <tag> google play </tag>
            
            <tag> clipboard </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[应朋友死皮白咧地邀请贴一个招聘广告]]></title>
      <url>/2017/09/25/%E5%BA%94%E6%9C%8B%E5%8F%8B%E6%AD%BB%E7%9A%AE%E7%99%BD%E5%92%A7%E5%9C%B0%E9%82%80%E8%AF%B7%E8%B4%B4%E4%B8%80%E4%B8%AA%E6%8B%9B%E8%81%98%E5%B9%BF%E5%91%8A/</url>
      <content type="html"><![CDATA[<blockquote>
<p>应朋友<strike>死皮白咧地</strike>邀请在这里贴一个招聘广告，<strong>注意：以下的联系方式都是我朋友的</strong></p>
</blockquote>
<h1 id="招聘【阿里巴巴ICBU内部推荐快速通道】"><a href="#招聘【阿里巴巴ICBU内部推荐快速通道】" class="headerlink" title="招聘【阿里巴巴ICBU内部推荐快速通道】"></a>招聘【阿里巴巴ICBU内部推荐快速通道】</h1><h3 id="ICBU技术部介绍："><a href="#ICBU技术部介绍：" class="headerlink" title="ICBU技术部介绍："></a>ICBU技术部介绍：</h3><p>作为阿里巴巴集团提出的eWTP建设的重要部队，国际无线技术部旨在以优秀的无线技术服务全球中小企业。我们面临的技术挑战有：全球化环境下复杂的技术与网络环境、国际贸易复杂的业务流程与规则、国际物流的信息跟踪等履约规范建立、跨境贸易沟通下的语言障碍等。通过深入对技术的全球化布局提升极致的用户体验，研究最新的无线技术如IoT等将业务化繁为简，丰富的无线相机能力和语言翻译服务让沟通全方位无障碍。让全球企业受惠eWTP，无线技术大有可为！ </p>
<p>招聘Android、IOS、Java工程师<br>投递邮箱：dechong.wc@alibaba-inc.com</p>
<a id="more"></a>
<h3 id="无线研发岗位要求："><a href="#无线研发岗位要求：" class="headerlink" title="无线研发岗位要求："></a>无线研发岗位要求：</h3><p>根据业务需求，基于IOS/Android平台进行应用程序开发；参与移动平台软件框架的研究，设计和实现、关键技术验证和选型等工作；带领并指导开发工程师、程序员进行代码开发等工作；<br>1. 本科及以上学历，计算机或相关专业；<br>2. 三年及以上手机应用实际开发经验，三年以上IOS/Android开发经验，五年以上C/C+/Java开发经验；<br>3. 精通Objective-C、Mac OS X、Xcode；<br>4. 精通IOS/AndroidSDK中的UI、网络、数据库、XML/JSON解析等开发技巧；<br>5. 有多个完整的IOS/Android项目经验，至少参加过一个完整的商业级手机应用或游戏开发项目；<br>6. 熟悉各种主流手机特性，深刻理解手机客户端软件及服务端开发特点；<br>7. 精通常用软件架构模式，熟悉各种算法与数据结构，多线程，网络编程（Socket、http/web service）等；</p>
<h3 id="JAVA开发岗位要求："><a href="#JAVA开发岗位要求：" class="headerlink" title="JAVA开发岗位要求："></a>JAVA开发岗位要求：</h3><p>从用户和技术出发，负责零售通网站业务产品相关的架构设计与开发； 对现有产品和系统进行改进和优化，实现面向未来的系统规划、设计和落地。<br>1. Java基础扎实，理解io、多线程、集合等基础框架，对JVM原理有一定的了解；<br>2. 对于你用过的开源框架，能了解到它的原理和机制；对Spring、ibatis开源框架熟悉；<br>3. 掌握多线程及高性能的设计与编码及性能调优；有高并发应用开发经验；<br>4. 对技术有浓厚兴趣，学习能力强，适应能力好，抗压能力强；</p>
<h6 id="期待你的加入～"><a href="#期待你的加入～" class="headerlink" title="期待你的加入～"></a>期待你的加入～</h6>]]></content>
      
        
        <tags>
            
            <tag> jobs </tag>
            
            <tag> alibaba </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android焦点流程代码分析]]></title>
      <url>/2017/08/04/Android-Android%E7%84%A6%E7%82%B9%E6%B5%81%E7%A8%8B%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<p>通过View的<code>View::focusSearch</code>进行焦点搜索对应方向上的下一个可以获取焦点的View：</p>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">focusSearch</span><span class="params">(@FocusRealDirection <span class="keyword">int</span> direction)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> mParent.focusSearch(<span class="keyword">this</span>, direction);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><span id="focusSearch"><br>不断地调用父控件来进行搜索，focusSearch有两个实现：<code>ViewGroup</code>和<code>RecyclerView</code>，先看<code>ViewGroup</code>：</span></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">focusSearch</span><span class="params">(View focused, <span class="keyword">int</span> direction)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (isRootNamespace()) &#123;</span><br><span class="line">       <span class="comment">// root namespace means we should consider ourselves the top of the</span></span><br><span class="line">       <span class="comment">// tree for focus searching; otherwise we could be focus searching</span></span><br><span class="line">       <span class="comment">// into other tabs.  see LocalActivityManager and TabHost for more info</span></span><br><span class="line">       <span class="keyword">return</span> FocusFinder.getInstance().findNextFocus(<span class="keyword">this</span>, focused, direction);</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> mParent.focusSearch(focused, direction);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><span id="FocusFinder.findNextFocus"><br>如果是最顶层，则直接调用<code>FocusFinder::findNextFocus</code>方法进行搜索；否则调用父控件的<code>focusSearch</code>。<code>FocusFinder::findNextFocus</code>如下：</span></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> View <span class="title">findNextFocus</span><span class="params">(ViewGroup root, View focused, Rect focusedRect, <span class="keyword">int</span> direction)</span> </span>&#123;</span><br><span class="line">   View next = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (focused != <span class="keyword">null</span>) &#123;</span><br><span class="line">       next = findNextUserSpecifiedFocus(root, focused, direction);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (next != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> next;</span><br><span class="line">   &#125;</span><br><span class="line">   ArrayList&lt;View&gt; focusables = mTempList;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       focusables.clear();</span><br><span class="line">       root.addFocusables(focusables, direction);</span><br><span class="line">       <span class="keyword">if</span> (!focusables.isEmpty()) &#123;</span><br><span class="line">           next = findNextFocus(root, focused, focusedRect, direction, focusables);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">       focusables.clear();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的<code>root</code>参数代表的是最顶层的view。</p>
<p>首先，通过尝试通过<code>findNextUserSpecifiedFocus</code>来查找下一个“指定的”可获得焦点的View，这个指定是开发者通过SDK自带的<code>setNextFocusLeftId</code>等方法进行手动设置的。如果查找到指定的下一个可获得焦点的View，则返回该View；否则，执行<code>View::addFocusables</code>方法，通过这个最顶层的View去拿到所有直接或间接的<code>Focusable</code>的子View，并添加到<code>ArrayList&lt;View&gt; focusables</code>中。</p>
<p><code>View::addFolcusables</code>方法中有4种实现：</p>
<p>第一种是View中默认实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFocusables</span><span class="params">(ArrayList&lt;View&gt; views, @FocusDirection <span class="keyword">int</span> direction,</span></span></span><br><span class="line"><span class="function"><span class="params">            @FocusableMode <span class="keyword">int</span> focusableMode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (views == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isFocusable()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((focusableMode &amp; FOCUSABLES_TOUCH_MODE) == FOCUSABLES_TOUCH_MODE</span><br><span class="line">                &amp;&amp; !isFocusableInTouchMode()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        views.add(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如果自己是focusable的话，直接把自己添加进去。</p>
<p>第二种是<code>ViewGroup</code>实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFocusables</span><span class="params">(ArrayList&lt;View&gt; views, <span class="keyword">int</span> direction, <span class="keyword">int</span> focusableMode)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">int</span> focusableCount = views.size();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">int</span> descendantFocusability = getDescendantFocusability();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (descendantFocusability != FOCUS_BLOCK_DESCENDANTS) &#123;</span><br><span class="line">       <span class="keyword">if</span> (shouldBlockFocusForTouchscreen()) &#123;</span><br><span class="line">           focusableMode |= FOCUSABLES_TOUCH_MODE;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> count = mChildrenCount;</span><br><span class="line">       <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">           <span class="keyword">final</span> View child = children[i];</span><br><span class="line">           <span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE) &#123;</span><br><span class="line">               child.addFocusables(views, direction, focusableMode);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// we add ourselves (if focusable) in all cases except for when we are</span></span><br><span class="line">   <span class="comment">// FOCUS_AFTER_DESCENDANTS and there are some descendants focusable.  this is</span></span><br><span class="line">   <span class="comment">// to avoid the focus search finding layouts when a more precise search</span></span><br><span class="line">   <span class="comment">// among the focusable children would be more interesting.</span></span><br><span class="line">   <span class="keyword">if</span> ((descendantFocusability != FOCUS_AFTER_DESCENDANTS</span><br><span class="line">           <span class="comment">// No focusable descendants</span></span><br><span class="line">           || (focusableCount == views.size())) &amp;&amp;</span><br><span class="line">           (isFocusableInTouchMode() || !shouldBlockFocusForTouchscreen())) &#123;</span><br><span class="line">       <span class="keyword">super</span>.addFocusables(views, direction, focusableMode);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>先会处理自身ViewGroup与它后代的关系(descendantFocusability)，前面提到过，可能的几种情况：</p>
<ul>
<li><strong>FOCUS_BEFORE_DESCENDANTS</strong>: ViewGroup本身先对焦点进行处理，如果没有处理则分发给child View进行处理</li>
<li><strong>FOCUS_AFTER_DESCENDANTS</strong>: 先分发给Child View进行处理，如果所有的Child View都没有处理，则自己再处理</li>
<li><strong>FOCUS_BLOCK_DESCENDANTS</strong>: ViewGroup本身进行处理，不管是否处理成功，都不会分发给ChildView进行处理</li>
</ul>
</blockquote>
<p>所以，以上：</p>
<p>1. 如果不是<code>FOCUS_BLOCK_DESCENDANTS</code>，则首先检查<code>blockForTouchscreen</code>并重置掉<code>focusableMode</code>，然后遍历所有的子View，调用<code>child::addFocusables</code>。<br>2. 如果不是<code>FOCUS_AFTER_DESCENDANTS</code>或者没有focusable的子View时自己处理，所以把自己加入到<code>views</code>中。</p>
<p>第三种是<code>ViewPager</code>实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFocusables</span><span class="params">(ArrayList&lt;View&gt; views, <span class="keyword">int</span> direction, <span class="keyword">int</span> focusableMode)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">int</span> focusableCount = views.size();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">int</span> descendantFocusability = getDescendantFocusability();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (descendantFocusability != FOCUS_BLOCK_DESCENDANTS) &#123;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; getChildCount(); i++) &#123;</span><br><span class="line">           <span class="keyword">final</span> View child = getChildAt(i);</span><br><span class="line">           <span class="keyword">if</span> (child.getVisibility() == VISIBLE) &#123;</span><br><span class="line">               ItemInfo ii = infoForChild(child);</span><br><span class="line">               <span class="keyword">if</span> (ii != <span class="keyword">null</span> &amp;&amp; ii.position == mCurItem) &#123;</span><br><span class="line">                   child.addFocusables(views, direction, focusableMode);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// we add ourselves (if focusable) in all cases except for when we are</span></span><br><span class="line">   <span class="comment">// FOCUS_AFTER_DESCENDANTS and there are some descendants focusable.  this is</span></span><br><span class="line">   <span class="comment">// to avoid the focus search finding layouts when a more precise search</span></span><br><span class="line">   <span class="comment">// among the focusable children would be more interesting.</span></span><br><span class="line">   <span class="keyword">if</span> (descendantFocusability != FOCUS_AFTER_DESCENDANTS</span><br><span class="line">           || (focusableCount == views.size())) &#123; <span class="comment">// No focusable descendants</span></span><br><span class="line">       <span class="comment">// Note that we can't call the superclass here, because it will</span></span><br><span class="line">       <span class="comment">// add all views in.  So we need to do the same thing View does.</span></span><br><span class="line">       <span class="keyword">if</span> (!isFocusable()) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> ((focusableMode &amp; FOCUSABLES_TOUCH_MODE) == FOCUSABLES_TOUCH_MODE</span><br><span class="line">               &amp;&amp; isInTouchMode() &amp;&amp; !isFocusableInTouchMode()) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (views != <span class="keyword">null</span>) &#123;</span><br><span class="line">           views.add(<span class="keyword">this</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与<code>ViewGroup</code>基本一致，在<code>descendantFocusability</code>不是<code>FOCUS_BLOCK_DESCENDANTS</code>时，遍历子View时判断view是否属于当前的page，如果是才加进去。如果不是<code>FOCUS_AFTER_DESCENDANTS</code>或者没有focusable的子View时自己处理，所以把自己加入到<code>views</code>中。</p>
<p>第四种是<code>RecyclerView</code>实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFocusables</span><span class="params">(ArrayList&lt;View&gt; views, <span class="keyword">int</span> direction, <span class="keyword">int</span> focusableMode)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (mLayout == <span class="keyword">null</span> || !mLayout.onAddFocusables(<span class="keyword">this</span>, views, direction, focusableMode)) &#123;</span><br><span class="line">       <span class="keyword">super</span>.addFocusables(views, direction, focusableMode);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>LayoutManager::onAddFocusables</code>来进行管理，如果返回false，则直接调用父类<code>ViewGroup</code>的方法，看下<code>LayoutManager::onAddFocusables</code>的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onAddFocusables</span><span class="params">(RecyclerView recyclerView, ArrayList&lt;View&gt; views,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">int</span> direction, <span class="keyword">int</span> focusableMode)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接返回false，并且没有看到相关的<code>LayoutManager</code>对该方法的重写，所以，这里应该是直接调用了父类<code>ViewGroup</code>的方法。</p>
<p><code>addFocusables</code>方法完毕，回到 <a href="#FocusFinder.findNextFocus">FocusFinder::findNextFocus</a> 方法中通过<code>root.addFocusables(focusables, direction);</code>加入所有可获取焦点的View之后，在非空的情况下调用如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">next = findNextFocus(root, focused, focusedRect, direction, focusables);</span><br></pre></td></tr></table></figure>
<p>所以重点是<code>FocusFinder::findNextFocus</code>方法的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> View <span class="title">findNextFocus</span><span class="params">(ViewGroup root, View focused, Rect focusedRect,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">int</span> direction, ArrayList&lt;View&gt; focusables)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (focused != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (focusedRect == <span class="keyword">null</span>) &#123;</span><br><span class="line">           focusedRect = mFocusedRect;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// fill in interesting rect from focused</span></span><br><span class="line">       focused.getFocusedRect(focusedRect);</span><br><span class="line">       root.offsetDescendantRectToMyCoords(focused, focusedRect);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (focusedRect == <span class="keyword">null</span>) &#123;</span><br><span class="line">           focusedRect = mFocusedRect;</span><br><span class="line">           <span class="comment">// make up a rect at top left or bottom right of root</span></span><br><span class="line">           <span class="keyword">switch</span> (direction) &#123;</span><br><span class="line">               <span class="keyword">case</span> View.FOCUS_RIGHT:</span><br><span class="line">               <span class="keyword">case</span> View.FOCUS_DOWN:</span><br><span class="line">                   setFocusTopLeft(root, focusedRect);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> View.FOCUS_FORWARD:</span><br><span class="line">                   <span class="keyword">if</span> (root.isLayoutRtl()) &#123;</span><br><span class="line">                       setFocusBottomRight(root, focusedRect);</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       setFocusTopLeft(root, focusedRect);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">case</span> View.FOCUS_LEFT:</span><br><span class="line">               <span class="keyword">case</span> View.FOCUS_UP:</span><br><span class="line">                   setFocusBottomRight(root, focusedRect);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> View.FOCUS_BACKWARD:</span><br><span class="line">                   <span class="keyword">if</span> (root.isLayoutRtl()) &#123;</span><br><span class="line">                       setFocusTopLeft(root, focusedRect);</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       setFocusBottomRight(root, focusedRect);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">switch</span> (direction) &#123;</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_FORWARD:</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_BACKWARD:</span><br><span class="line">           <span class="keyword">return</span> findNextFocusInRelativeDirection(focusables, root, focused, focusedRect,</span><br><span class="line">                   direction);</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_UP:</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_DOWN:</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_LEFT:</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_RIGHT:</span><br><span class="line">           <span class="keyword">return</span> findNextFocusInAbsoluteDirection(focusables, root, focused,</span><br><span class="line">                   focusedRect, direction);</span><br><span class="line">       <span class="keyword">default</span>:</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown direction: "</span> + direction);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果focused不是null，说明当前获取到焦点的View存在，则获得绘制焦点的Rect到focusedRect，然后根据rootView遍历所有ParentView从子View纠正坐标到根View坐标。</li>
<li>如果focused是null，则说明当前没有View获取到焦点，则把focusedRect根据不同的direction重置为“一点”。</li>
</ul>
<p>最后根据direction调用<code>FocusFinder::findNextFocusInAbsoluteDirection</code>方法进行对比查找“下一个”View。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">View <span class="title">findNextFocusInAbsoluteDirection</span><span class="params">(ArrayList&lt;View&gt; focusables, ViewGroup root, View focused,</span></span></span><br><span class="line"><span class="function"><span class="params">       Rect focusedRect, <span class="keyword">int</span> direction)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// initialize the best candidate to something impossible</span></span><br><span class="line">   <span class="comment">// (so the first plausible view will become the best choice)</span></span><br><span class="line">   mBestCandidateRect.set(focusedRect);</span><br><span class="line">   <span class="keyword">switch</span>(direction) &#123;</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_LEFT:</span><br><span class="line">           mBestCandidateRect.offset(focusedRect.width() + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_RIGHT:</span><br><span class="line">           mBestCandidateRect.offset(-(focusedRect.width() + <span class="number">1</span>), <span class="number">0</span>);</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_UP:</span><br><span class="line">           mBestCandidateRect.offset(<span class="number">0</span>, focusedRect.height() + <span class="number">1</span>);</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_DOWN:</span><br><span class="line">           mBestCandidateRect.offset(<span class="number">0</span>, -(focusedRect.height() + <span class="number">1</span>));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   View closest = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">int</span> numFocusables = focusables.size();</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numFocusables; i++) &#123;</span><br><span class="line">       View focusable = focusables.get(i);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// only interested in other non-root views</span></span><br><span class="line">       <span class="keyword">if</span> (focusable == focused || focusable == root) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// get focus bounds of other view in same coordinate system</span></span><br><span class="line">       focusable.getFocusedRect(mOtherRect);</span><br><span class="line">       root.offsetDescendantRectToMyCoords(focusable, mOtherRect);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (isBetterCandidate(direction, focusedRect, mOtherRect, mBestCandidateRect)) &#123;</span><br><span class="line">           mBestCandidateRect.set(mOtherRect);</span><br><span class="line">           closest = focusable;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> closest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先把最优选择mBestCandidateRect设置为focusedRect，根据方向做1像素的偏移便于对比。遍历所有刚刚查询出来的<code>focusables</code>，拿到每一个的<code>focusedRect</code>区域并进行转换，然后通过<code>FocusFinder::isBetterCandidate</code>方法进行对比，然后拿到更好的，遍历完成后就是最优选择。接下来看下<code>FocusFinder::isBetterCandidate</code>方法来了解下是怎么做对比的：</p>
<p>下面代码意思是：以source这个rect来说，作为对应derection上下一个focus view，rect1是否比rect2更优？</p>
<p><span id="FocusFinder.isBetterCandidate"></span></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isBetterCandidate</span><span class="params">(<span class="keyword">int</span> direction, Rect source, Rect rect1, Rect rect2)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// to be a better candidate, need to at least be a candidate in the first</span></span><br><span class="line">   <span class="comment">// place :)</span></span><br><span class="line">   <span class="keyword">if</span> (!isCandidate(source, rect1, direction)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// we know that rect1 is a candidate.. if rect2 is not a candidate,</span></span><br><span class="line">   <span class="comment">// rect1 is better</span></span><br><span class="line">   <span class="keyword">if</span> (!isCandidate(source, rect2, direction)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// if rect1 is better by beam, it wins</span></span><br><span class="line">   <span class="keyword">if</span> (beamBeats(direction, source, rect1, rect2)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// if rect2 is better, then rect1 cant' be :)</span></span><br><span class="line">   <span class="keyword">if</span> (beamBeats(direction, source, rect2, rect1)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// otherwise, do fudge-tastic comparison of the major and minor axis</span></span><br><span class="line">   <span class="keyword">return</span> (getWeightedDistanceFor(</span><br><span class="line">                   majorAxisDistance(direction, source, rect1),</span><br><span class="line">                   minorAxisDistance(direction, source, rect1))</span><br><span class="line">           &lt; getWeightedDistanceFor(</span><br><span class="line">                   majorAxisDistance(direction, source, rect2),</span><br><span class="line">                   minorAxisDistance(direction, source, rect2)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先确定rect1是否<code>isCandidate</code>？<code>isCandidate</code>做的逻辑简单来说就是确定rect是否满足给定的derection作为下一个focus view这个条件，它的判断依据如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isCandidate</span><span class="params">(Rect srcRect, Rect destRect, <span class="keyword">int</span> direction)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">switch</span> (direction) &#123;</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_LEFT:</span><br><span class="line">           <span class="keyword">return</span> (srcRect.right &gt; destRect.right || srcRect.left &gt;= destRect.right) </span><br><span class="line">                   &amp;&amp; srcRect.left &gt; destRect.left;</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_RIGHT:</span><br><span class="line">           <span class="keyword">return</span> (srcRect.left &lt; destRect.left || srcRect.right &lt;= destRect.left)</span><br><span class="line">                   &amp;&amp; srcRect.right &lt; destRect.right;</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_UP:</span><br><span class="line">           <span class="keyword">return</span> (srcRect.bottom &gt; destRect.bottom || srcRect.top &gt;= destRect.bottom)</span><br><span class="line">                   &amp;&amp; srcRect.top &gt; destRect.top;</span><br><span class="line">       <span class="keyword">case</span> View.FOCUS_DOWN:</span><br><span class="line">           <span class="keyword">return</span> (srcRect.top &lt; destRect.top || srcRect.bottom &lt;= destRect.top)</span><br><span class="line">                   &amp;&amp; srcRect.bottom &lt; destRect.bottom;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"direction must be one of "</span></span><br><span class="line">           + <span class="string">"&#123;FOCUS_UP, FOCUS_DOWN, FOCUS_LEFT, FOCUS_RIGHT&#125;."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码比较简单。再回到 <a href="#FocusFinder.isBetterCandidate">FocusFinder::isBetterCandidate</a> 的代码逻辑：</p>
<ul>
<li>如果rect1不满足基本条件，则肯定返回false（基本的条件都不满足）</li>
<li>如果rect2不满足基本条件，则返回true，认为rect1更优</li>
<li>如果都满足基本条件的情况下，通过<code>FocusFinder::beamBeats</code>方法来判断哪种更优</li>
</ul>
<p>接下来看下<code>FocusFinder::beamBeats</code>的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">beamBeats</span><span class="params">(<span class="keyword">int</span> direction, Rect source, Rect rect1, Rect rect2)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">boolean</span> rect1InSrcBeam = beamsOverlap(direction, source, rect1);</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">boolean</span> rect2InSrcBeam = beamsOverlap(direction, source, rect2);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// if rect1 isn't exclusively in the src beam, it doesn't win</span></span><br><span class="line">   <span class="keyword">if</span> (rect2InSrcBeam || !rect1InSrcBeam) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// we know rect1 is in the beam, and rect2 is not</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// if rect1 is to the direction of, and rect2 is not, rect1 wins.</span></span><br><span class="line">   <span class="comment">// for example, for direction left, if rect1 is to the left of the source</span></span><br><span class="line">   <span class="comment">// and rect2 is below, then we always prefer the in beam rect1, since rect2</span></span><br><span class="line">   <span class="comment">// could be reached by going down.</span></span><br><span class="line">   <span class="keyword">if</span> (!isToDirectionOf(direction, source, rect2)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// for horizontal directions, being exclusively in beam always wins</span></span><br><span class="line">   <span class="keyword">if</span> ((direction == View.FOCUS_LEFT || direction == View.FOCUS_RIGHT)) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;        </span><br><span class="line"></span><br><span class="line">   <span class="comment">// for vertical directions, beams only beat up to a point:</span></span><br><span class="line">   <span class="comment">// now, as long as rect2 isn't completely closer, rect1 wins</span></span><br><span class="line">   <span class="comment">// e.g for direction down, completely closer means for rect2's top</span></span><br><span class="line">   <span class="comment">// edge to be closer to the source's top edge than rect1's bottom edge.</span></span><br><span class="line">   <span class="keyword">return</span> (majorAxisDistance(direction, source, rect1)</span><br><span class="line">           &lt; majorAxisDistanceToFarEdge(direction, source, rect2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过<code>beamsOverlap</code>方法来判断两个rect与source是否重叠等等。<strong>注意的是，在水平情况下，如果rect1重叠，则就是最优解（为什么？比较奇怪）</strong>，最后<strong>如果是竖直情况</strong>，通过<code>FocusFinder::majorAxisDistance</code>方法来判断哪个离source最近。如果还是比较不出，则通过<code>getWeightedDistanceFor</code>方法来通过“主要距离”和“次要距离”做一个综合的比较。</p>
<h2 id="RecyclerView"><a href="#RecyclerView" class="headerlink" title="RecyclerView"></a>RecyclerView</h2><p>继续 <a href="#focusSearch">focusSearch</a> 代码的分析，刚刚只跟了<code>ViewGroup</code>，还有一个实现是<code>RecyclerView</code>的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">focusSearch</span><span class="params">(View focused, <span class="keyword">int</span> direction)</span> </span>&#123;</span><br><span class="line">   View result = mLayout.onInterceptFocusSearch(focused, direction);</span><br><span class="line">   <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过<code>onInterceptFocusSearch</code>进行拦截，如果返回具体的focus View，则直接返回；否则继续往下；<code>onInterceptFocusSearch</code>实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">onInterceptFocusSearch</span><span class="params">(View focused, <span class="keyword">int</span> direction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认为空实现，返回null，也没有其它的子类进行重写，所以暂时不管这个处理，继续看<code>focusSearch</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">focusSearch</span><span class="params">(View focused, <span class="keyword">int</span> direction)</span> </span>&#123;</span><br><span class="line">   View result = mLayout.onInterceptFocusSearch(focused, direction);</span><br><span class="line">   <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">boolean</span> canRunFocusFailure = mAdapter != <span class="keyword">null</span> &amp;&amp; mLayout != <span class="keyword">null</span></span><br><span class="line">           &amp;&amp; !isComputingLayout() &amp;&amp; !mLayoutFrozen;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> FocusFinder ff = FocusFinder.getInstance();</span><br><span class="line">   <span class="keyword">if</span> (canRunFocusFailure</span><br><span class="line">           &amp;&amp; (direction == View.FOCUS_FORWARD || direction == View.FOCUS_BACKWARD)) &#123;</span><br><span class="line">       <span class="comment">// convert direction to absolute direction and see if we have a view there and if not</span></span><br><span class="line">       <span class="comment">// tell LayoutManager to add if it can.</span></span><br><span class="line">       <span class="keyword">boolean</span> needsFocusFailureLayout = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">if</span> (mLayout.canScrollVertically()) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> absDir =</span><br><span class="line">                   direction == View.FOCUS_FORWARD ? View.FOCUS_DOWN : View.FOCUS_UP;</span><br><span class="line">           <span class="keyword">final</span> View found = ff.findNextFocus(<span class="keyword">this</span>, focused, absDir);</span><br><span class="line">           needsFocusFailureLayout = found == <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">if</span> (FORCE_ABS_FOCUS_SEARCH_DIRECTION) &#123;</span><br><span class="line">               <span class="comment">// Workaround for broken FOCUS_BACKWARD in API 15 and older devices.</span></span><br><span class="line">               direction = absDir;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!needsFocusFailureLayout &amp;&amp; mLayout.canScrollHorizontally()) &#123;</span><br><span class="line">           <span class="keyword">boolean</span> rtl = mLayout.getLayoutDirection() == ViewCompat.LAYOUT_DIRECTION_RTL;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> absDir = (direction == View.FOCUS_FORWARD) ^ rtl</span><br><span class="line">                   ? View.FOCUS_RIGHT : View.FOCUS_LEFT;</span><br><span class="line">           <span class="keyword">final</span> View found = ff.findNextFocus(<span class="keyword">this</span>, focused, absDir);</span><br><span class="line">           needsFocusFailureLayout = found == <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">if</span> (FORCE_ABS_FOCUS_SEARCH_DIRECTION) &#123;</span><br><span class="line">               <span class="comment">// Workaround for broken FOCUS_BACKWARD in API 15 and older devices.</span></span><br><span class="line">               direction = absDir;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (needsFocusFailureLayout) &#123;</span><br><span class="line">           consumePendingUpdateOperations();</span><br><span class="line">           <span class="keyword">final</span> View focusedItemView = findContainingItemView(focused);</span><br><span class="line">           <span class="keyword">if</span> (focusedItemView == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">// panic, focused view is not a child anymore, cannot call super.</span></span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           eatRequestLayout();</span><br><span class="line">           mLayout.onFocusSearchFailed(focused, direction, mRecycler, mState);</span><br><span class="line">           resumeRequestLayout(<span class="keyword">false</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       result = ff.findNextFocus(<span class="keyword">this</span>, focused, direction);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       result = ff.findNextFocus(<span class="keyword">this</span>, focused, direction);</span><br><span class="line">       <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; canRunFocusFailure) &#123;</span><br><span class="line">           consumePendingUpdateOperations();</span><br><span class="line">           <span class="keyword">final</span> View focusedItemView = findContainingItemView(focused);</span><br><span class="line">           <span class="keyword">if</span> (focusedItemView == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">// panic, focused view is not a child anymore, cannot call super.</span></span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           eatRequestLayout();</span><br><span class="line">           result = mLayout.onFocusSearchFailed(focused, direction, mRecycler, mState);</span><br><span class="line">           resumeRequestLayout(<span class="keyword">false</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (result != <span class="keyword">null</span> &amp;&amp; !result.hasFocusable()) &#123;</span><br><span class="line">       <span class="keyword">if</span> (getFocusedChild() == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// Scrolling to this unfocusable view is not meaningful since there is no currently</span></span><br><span class="line">           <span class="comment">// focused view which RV needs to keep visible.</span></span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">super</span>.focusSearch(focused, direction);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// If the next view returned by onFocusSearchFailed in layout manager has no focusable</span></span><br><span class="line">       <span class="comment">// views, we still scroll to that view in order to make it visible on the screen.</span></span><br><span class="line">       <span class="comment">// If it's focusable, framework already calls RV's requestChildFocus which handles</span></span><br><span class="line">       <span class="comment">// bringing this newly focused item onto the screen.</span></span><br><span class="line">       requestChildOnScreen(result, <span class="keyword">null</span>);</span><br><span class="line">       <span class="keyword">return</span> focused;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> isPreferredNextFocus(focused, result, direction)</span><br><span class="line">           ? result : <span class="keyword">super</span>.focusSearch(focused, direction);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们暂时只考虑<code>direction</code>为left，top，right，down的情况，则进入最外面if的else分支：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">focusSearch</span><span class="params">(View focused, <span class="keyword">int</span> direction)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    result = ff.findNextFocus(<span class="keyword">this</span>, focused, direction);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; canRunFocusFailure) &#123;</span><br><span class="line">     consumePendingUpdateOperations();</span><br><span class="line">     <span class="keyword">final</span> View focusedItemView = findContainingItemView(focused);</span><br><span class="line">     <span class="keyword">if</span> (focusedItemView == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="comment">// panic, focused view is not a child anymore, cannot call super.</span></span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     eatRequestLayout();</span><br><span class="line">     result = mLayout.onFocusSearchFailed(focused, direction, mRecycler, mState);</span><br><span class="line">     resumeRequestLayout(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过<code>FocusFinder::findNextFocus</code>方法来获取下一个应该获得焦点的View，这里获取的结果与 <a href="#FocusFinder.findNextFocus">FocusFinder::findNextFocus</a> 逻辑一致。</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> source code </tag>
            
            <tag> focus </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android内存泄漏你所要知道的一切（翻译）]]></title>
      <url>/2017/07/25/Android-Android%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E4%BD%A0%E6%89%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="Android内存泄漏你所要知道的一切"><a href="#Android内存泄漏你所要知道的一切" class="headerlink" title="Android内存泄漏你所要知道的一切"></a>Android内存泄漏你所要知道的一切</h1><blockquote>
<p>原文：<a href="https://blog.aritraroy.in/everything-you-need-to-know-about-memory-leaks-in-android-apps-655f191ca859" target="_blank" rel="noopener">https://blog.aritraroy.in/everything-you-need-to-know-about-memory-leaks-in-android-apps-655f191ca859</a></p>
</blockquote>
<p>写一个Android app很简单，但是<strong>写一个超高品质的内存高效的Android app并不简单</strong>。从我的个人经验来说，我曾经比较关注和感兴趣构建我app的新特性，功能和UI组件。</p>
<p>我主要倾向于工作在具有更多视觉冲击力的东西，而不是花时间在没有人一眼会注意到的东西上面。我开始养成了避免或者给app优化等事情更低优先级的习惯（检测和修复内存泄漏就是其中的一个）。</p>
<p>这自然而然导致我承担起了技术负债，从长远来看，它开始影响我的应用的性能和质量。我满满地改变了我的心态，比起去年我更多地以“性能为重点”。</p>
<a id="more"></a>
<p><strong>内存泄漏的概念对很多的开发者来说是非常艰巨的。</strong>他们觉得这是困难，耗时，无聊和不必要的，但幸运的是，这些都不是真的。一旦你开始深入，你将绝对会爱上它。</p>
<p>在本文中，我将尝试让这个话题尽可能地简单，这样即使是新的开发者也能从他们的职业生涯一开始就能构建高质量和高性能的Android apps。</p>
<h2 id="垃圾收集器是你的朋友，但不一直是"><a href="#垃圾收集器是你的朋友，但不一直是" class="headerlink" title="垃圾收集器是你的朋友，但不一直是"></a>垃圾收集器是你的朋友，但不一直是</h2><p><strong>Java是一个强大的语言</strong>。在Android中，我们不会（有时候我们会）像 C 或者 C++ 那样去写代码来让我们自己去管理整个内存分配和释放。</p>
<p>现在浮现在我脑中的第一个问题就是，既然Java有了一个内置专用的内存管理系统，它会在我们不需要时清理内存，那么为什么我们还需要关心这个呢。<em>是垃圾收集器不够完善？</em></p>
<p>不，当然不是。<strong>垃圾收集器的工作原理就是如此</strong>。但是我们自己编程错误有时就会阻止垃圾收集器收集大量不必要的内存。</p>
<p>所以基本上，都是我们自己的错误才导致了一切的混乱。<strong>垃圾收集器是Java最好的成就之一</strong>，它值得被尊重。</p>
<p><strong><a href="https://blog.aritraroy.in/what-my-2-years-of-android-development-have-taught-me-the-hard-way-52b495ba5c51" target="_blank" rel="noopener">推荐阅读</a></strong></p>
<h2 id="垃圾收集器“更多的一点”"><a href="#垃圾收集器“更多的一点”" class="headerlink" title="垃圾收集器“更多的一点”"></a>垃圾收集器“更多的一点”</h2><p>在进一步之前，你需要了解一点垃圾收集器的工作原理。<strong>它的原理非常简单</strong>，但是它的内部有时候非常复杂。但是不用担心，我们将主要关注简单的部分。</p>
<p><img src="http://images2015.cnblogs.com/blog/378300/201707/378300-20170724130625383-711376452.png" alt=""></p>
<p>每一个Android（或者Java）应用程序都有一个从对象开始获取实例化、方法被调用的起点。<strong>所以我们可以认为这个起点是内存树的“root”</strong>。一些对象直接保持了一个对“root”的引用，并且从它们中实例化其它对象，保持这些对象的引用等等。</p>
<p>因而，形成了创建内存树的引用链。所以，垃圾收集器从GC roots开始，然后直接或间接遍历对象链接到根。在这个过程的最后，存在一些GC从来没有访问到的对象。</p>
<p><strong>这些是你的垃圾（或者dead objects）</strong>，这些对象就是我们所钟爱的垃圾收集器有资格去收集的。</p>
<p>到目前为止，这似乎是一个童话故事，但让我们深入了解一下开始真正的乐趣。</p>
<p><strong>Bonus:</strong> 如果你希望学习更多关于垃圾收集器，我强烈推荐你看下 <a href="https://www.youtube.com/watch?v=UnaNQgzw4zY" target="_blank" rel="noopener">这里</a> 和 <a href="http://www.cubrid.org/blog/dev-platform/understanding-java-garbage-collection/" target="_blank" rel="noopener">这里</a> 。</p>
<h2 id="那么现在，什么是内存泄漏呢？"><a href="#那么现在，什么是内存泄漏呢？" class="headerlink" title="那么现在，什么是内存泄漏呢？"></a>那么现在，什么是内存泄漏呢？</h2><p>知道现在，你有了一个简单想法的垃圾收集器，那么，在Android apps中内存管理师怎么工作的。现在，让我们关注于更详细的内存泄漏这个话题。</p>
<p>简单来说，<strong>内存泄漏发生在当你长时间持有一个已经达到目的的对象</strong>。实际的概念就这么简单。</p>
<p>每个对象都有它自己的生命，之后它需要说拜拜，然后释放内存。但是如果一些对象持有这个对象（直接或间接），那么垃圾收集器就无法收集它。<strong>这就是我们的朋友，内存泄漏</strong>。</p>
<p>但是有个好消息就是你不需要担心你app中的每一处的内存泄漏。并不是所有的内存泄漏都会伤害你的app。</p>
<p>有一些泄漏真的非常小（泄漏了几千字节的内存），有些存在于Android framework本身（是的，你没看错），这些你不能也不需要去修复。他们通常对于你的app影响很小并且你可以安全地忽略它们。</p>
<p>但是也存在其它的可以<strong>让你的应用程序崩溃，使它像地狱一样滞留，并将其逐字缩小</strong>。这些是你要关注的东西。</p>
<p><strong><a href="https://blog.aritraroy.in/20-awesome-open-source-android-apps-to-boost-your-development-skills-b62832cf0fa4" target="_blank" rel="noopener">推荐阅读</a></strong></p>
<h2 id="为什么你真的需要解决内存泄漏？"><a href="#为什么你真的需要解决内存泄漏？" class="headerlink" title="为什么你真的需要解决内存泄漏？"></a>为什么你真的需要解决内存泄漏？</h2><p>没有人希望使用<strong>一个缓慢的、迟钝的、吃很多内存、每用几分钟就会crash的app</strong>。对于用户长时间使用，它真的会创建一个糟糕的体验，然后你就有永远失去用户的可能性。</p>
<p><img src="http://images2015.cnblogs.com/blog/378300/201707/378300-20170724160146731-1663679590.png" alt=""></p>
<p>随着用户继续使用你的app，堆内存也不断地增长，如果你的app中有内存泄漏，那么GC就无法释放你无用的内存。所以你app的堆内存就会经常增长，直到达到一个死亡的点，<strong>这时将没有更多的内存分配给你的app，从而导致可怕的 <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/OutOfMemoryError.html" target="_blank" rel="noopener">OutOfMemoryError</a> 并最终让你的应用程序崩溃。</strong></p>
<p>你还要必须记住一件事情，垃圾收集器是一个繁重的过程，<em>垃圾收集器跑得越少，对你的app就越好。</em></p>
<p>App正在被使用，对内存保持着增长状态，一个小的GC将启动并尝试清除刚刚死亡的对象。现在这些小的GC同时运行着（在单独的线程上），并且不会减缓你的app（2-5ms的暂停）。</p>
<p><strong>但是如果你的app内部有严重的内存泄漏的问题</strong>，那么这些小的GC无法去回收这些内存，并且堆还在持续增长，从而迫使更大的GC被启动，这通常是一个”<a href="https://plumbr.eu/blog/garbage-collection/minor-gc-vs-major-gc-vs-full-gc" target="_blank" rel="noopener">停止世界</a> 的GC”，它会暂停整个app主线程（大约50-100ms），从而<strong>使你的app严重滞后，甚至有时几乎不可用</strong>。</p>
<p>所以现在你知道这些内存泄漏可能对你的应用程序产生的影响，以及<strong>为什么需要立即修复它们</strong>，为用户提供他们应得的最佳体验。</p>
<h2 id="怎么去检测这些内存泄漏？"><a href="#怎么去检测这些内存泄漏？" class="headerlink" title="怎么去检测这些内存泄漏？"></a>怎么去检测这些内存泄漏？</h2><p>目前为止，你应该相当信服你需要修复这些隐藏在你app中的内存泄漏。<strong>但是怎么去实际检测它们呢？</strong></p>
<p>不错的是，对于这点Android Studio提供了一个非常有用且强大的工具，<strong>Monitors</strong>。这个显示器不仅展示了内存使用，同样还有网络、CPU、GPU使用（更多信息查看<a href="https://developer.android.com/studio/profile/android-monitor.html" target="_blank" rel="noopener">这里</a>）。</p>
<p><img src="http://images2015.cnblogs.com/blog/378300/201707/378300-20170724162545262-106537289.png" alt=""></p>
<p>当你在使用和调试你的app时，应该密切关注这个内存监视器。<em>内存泄漏的第一症状是当你持续使用你的app时内存使用图表经常增长</em>，并且从不下降，甚至在你切换到后台后。</p>
<p><a href="https://developer.android.com/studio/profile/am-allocation.html" target="_blank" rel="noopener">Allocation Tracker</a>可以派上用场，你可以使用它来检查分配给应用程序中不同类型对象的内存百分比。</p>
<p>但是这本身还不够，因为你现在需要使用<strong>Dump Java Heap</strong>选项来创建一个实际表示给定时间内存快照的<a href="https://developer.android.com/studio/profile/am-hprof.html" target="_blank" rel="noopener">heap dump</a>。看起来是一个无聊和重复性的工作，对吧？对，它确实是。</p>
<p><img src="http://images2015.cnblogs.com/blog/378300/201707/378300-20170724163402043-410997.png" alt=""></p>
<p>我们工程师往往是懒惰的，<strong>这点 <a href="https://github.com/square/leakcanary" target="_blank" rel="noopener">LeakCanary</a> 来救援了</strong>。这个库随着你的app一起运行。在需要时dump出内存，寻找潜在的内存泄漏并且通过一个清晰有用的stack trace来寻找泄漏的根源。</p>
<p><em>LeakCanary 让任何人在他们的app中检测泄漏变得超级简单</em>。我不能再感谢 <a href="https://twitter.com/piwai" target="_blank" rel="noopener">Py</a>(来自 <a href="https://github.com/square" target="_blank" rel="noopener">Square</a>)写了如此惊人和拯救了生命的库了。奖励！</p>
<p><strong>Bonus</strong>: 如果你想详细学习怎么充分使用这个库，看<a href="https://realm.io/news/droidcon-ricau-memory-leaks-leakcanary/" target="_blank" rel="noopener">这里</a>。</p>
<p><a href="https://blog.aritraroy.in/50-ultimate-resources-to-master-android-development-15165d6bc376" target="_blank" rel="noopener">推荐阅读</a></p>
<h2 id="一些实际常见的内存泄漏情况并怎么去解决它们"><a href="#一些实际常见的内存泄漏情况并怎么去解决它们" class="headerlink" title="一些实际常见的内存泄漏情况并怎么去解决它们"></a>一些实际常见的内存泄漏情况并怎么去解决它们</h2><p>从我们经验来看，有几个最常见的可能会导致内存泄漏的场景，它们都非常相似，你会在日常的Android开发中遇到这些情况。</p>
<p>一旦你知道这些内存泄漏发生在什么时候，什么地方，怎么发生，你就可以更容易对此进行修复。</p>
<h3 id="Unregistered-Listeners"><a href="#Unregistered-Listeners" class="headerlink" title="Unregistered Listeners"></a>Unregistered Listeners</h3><p>有很多场景，你在Activity（或者Fragment）中进行了一个监听器的注册，但是忘记把它反注册掉。<strong>如果运气不好，这个很容易导致一个巨大的内存泄漏</strong>。一般情况下，这些监听器是平衡的，所以如果你在某些地方注册了它，你也需要在那里反注册它。</p>
<p>现在我们来看一个简单的例子。假设你要在你的app中接收到位置的更新，你要做的事就是拿到一个 <a href="https://developer.android.com/reference/android/location/LocationManager.html" target="_blank" rel="noopener">LocationManager</a> 系统服务，然后为位置更新注册一个listener。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerLocationUpdates</span><span class="params">()</span></span>&#123;</span><br><span class="line">mManager = (LocationManager) getSystemService(LOCATION_SERVICE);</span><br><span class="line">mManager.requestLocationUpdates(LocationManager.GPS_PROVIDER,</span><br><span class="line">            TimeUnit.MINUTES.toMillis(<span class="number">1</span>), </span><br><span class="line">            <span class="number">100</span>, </span><br><span class="line">            <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你在Activity本身实现了listener接口，<em>因此 LocationManager 持有了一个它的引用</em>。现在你的Activity是时候要销毁了，Android Framework将会调用它的 onDestroy() 方法，但是垃圾收集器将不能从内存中把这个实例删除，因为 LocationManager 仍然持有了它的强引用。</p>
<p><strong>解决方案非常简单</strong>。仅仅在 onDestroy() 方法中反注册掉listener，这个很好实现。这是我们大多数人忘记甚至不知道的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    <span class="keyword">if</span> (mManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mManager.removeUpdates(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h3><p>内部类在Java中非常常见，由于它的简洁性，Android开发者经常使用在各种任务中。但是由于不恰当的使用，<em>这些内部类也导致了潜在的内存泄漏。</em></p>
<p>让我们再在一个简单例子的帮助下看看，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BadActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> TextView mMessageView;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.layout_bad_activity);</span><br><span class="line">        mMessageView = (TextView) findViewById(R.id.messageView);</span><br><span class="line">        <span class="keyword">new</span> LongRunningTask().execute();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">LongRunningTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Void</span>, <span class="title">Void</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Am finally done!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(String result)</span> </span>&#123;</span><br><span class="line">            mMessageView.setText(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个非常简单的Activity，它在后台（也许是复杂的数据库查询或者一个缓慢的网络请求）启动了一个耗时任务。在Task完成时，结果被展示在 TextView。看起来一切都很好？</p>
<p>不，当然不是。问题在于<strong>非静态内部类持有一个外部类的隐式引用</strong>（也就是Activity本身）。现在如果我们旋转了屏幕或者如果这个耗时的任务比Activity生命长，那么它不会让垃圾收集器把整个Activity实例从内存回收。<strong>一个简单的错误导致了一个巨大的内存泄漏</strong>。</p>
<p>但是解决方案还是非常简单，看了你就明白了，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AsyncTask mLongRunningTask;</span><br><span class="line">    <span class="keyword">private</span> TextView mMessageView;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.layout_good_activity);</span><br><span class="line">        mMessageView = (TextView) findViewById(R.id.messageView);</span><br><span class="line">        mLongRunningTask = <span class="keyword">new</span> LongRunningTask(mMessageView).execute();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        mLongRunningTask.cancel(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LongRunningTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Void</span>, <span class="title">Void</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;TextView&gt; messageViewReference;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LongRunningTask</span><span class="params">(TextView messageView)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.messageViewReference = <span class="keyword">new</span> WeakReference&lt;&gt;(messageView);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</span><br><span class="line">            String message = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (!isCancelled()) &#123;</span><br><span class="line">                message = <span class="string">"I am finally done!"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(String result)</span> </span>&#123;</span><br><span class="line">            TextView view = messageViewReference.get();</span><br><span class="line">            <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                view.setText(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如你所见，<strong>我把非静态内部类改成了静态内部类</strong>，这样静态内部类就不会持有任何外部类的隐式引用。但是我们不能通过静态上下文去访问外部类的非静态变量（比如 TextView），所以我们不得不通过构造方法传递我们需要的对象引用到内部类。</p>
<p>我强烈推荐使用 WeakReference 包装这个对象引用来防止进一步的内存泄漏。你需要开始学习关于<strong>在Java中各个可用的引用类型</strong>。</p>
<h3 id="匿名类"><a href="#匿名类" class="headerlink" title="匿名类"></a>匿名类</h3><p>匿名类是很多开发者最喜欢的，因为它们被定义的方式使得用它们编写代码非常容易和简洁。但是根据我的经验<strong>这些匿名类是内存泄漏最常见的原因</strong>。</p>
<p>匿名类没有什么，但是非静态内部类会由于前面我讲到过的同样的理由引发潜在的内存泄漏。你已经在app的一系列地方用到了它，<strong>但是你不知道如果错误的使用可能会对你app的性能有严重的影响</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MoviesActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> TextView mNoOfMoviesThisWeek;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.layout_movies_activity);</span><br><span class="line">        mNoOfMoviesThisWeek = (TextView) findViewById(R.id.no_of_movies_text_view);</span><br><span class="line">        MoviesRepository repository = ((MoviesApp) getApplication()).getRepository();</span><br><span class="line">        repository.getMoviesThisWeek()</span><br><span class="line">                .enqueue(<span class="keyword">new</span> Callback&lt;List&lt;Movie&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;List&lt;Movie&gt;&gt; call,</span></span></span><br><span class="line"><span class="function"><span class="params">                                           Response&lt;List&lt;Movie&gt;&gt; response)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">int</span> numberOfMovies = response.body().size();</span><br><span class="line">                        mNoOfMoviesThisWeek.setText(<span class="string">"No of movies this week: "</span> + String.valueOf(numberOfMovies));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;List&lt;Movie&gt;&gt; call, Throwable t)</span> </span>&#123;</span><br><span class="line">                        <span class="comment">// Oops.</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，我们使用了一个非常流行的库 <a href="https://github.com/square/retrofit" target="_blank" rel="noopener">Retrofit</a> 来执行一个网络请求并把结果显示在 TextView 上。很明显，Callable 对象持有了一个外部Activity类的引用。</p>
<p>如果这个网络请求执行速度非常慢，并且在调用结束之前 Activity 因为某种情况被旋转了屏幕或者被销毁，<strong>那么整个Activity实例都会被泄漏</strong>。</p>
<p>不管是否必须，使用静态内部类来代替匿名内部类通常是明智之举。不是我突然告诉你完全停止使用匿名类，而是你必须要懂得判断什么时候能用什么时候不能用。</p>
<p><a href="https://blog.aritraroy.in/why-you-should-start-using-kotlin-to-supercharge-your-android-development-in-2017-61db1f11d666" target="_blank" rel="noopener">推荐阅读</a></p>
<h3 id="Bitmaps"><a href="#Bitmaps" class="headerlink" title="Bitmaps"></a>Bitmaps</h3><p>在你app中看到的所有图片都没关系，除了 <a href="https://developer.android.com/reference/android/graphics/Bitmap.html" target="_blank" rel="noopener">Bitmap</a> ，它包含了图像的整个像素数据。</p>
<p>这些 bitmaps 对象一般非常重，<strong>如果处理不当可能会引发明显的内存泄漏</strong>，并最终让你的app因为 <a href="https://developer.android.com/reference/java/lang/OutOfMemoryError.html" target="_blank" rel="noopener">OutOfMemoryError</a> 而崩溃。你在app中使用的图片相关的 bitmap 内存 都会由Android Framework 自身自动管理，如果你手动处理 Bitmap，确保在使用后进行 <a href="https://developer.android.com/reference/android/graphics/Bitmap.html#recycle%28%29" target="_blank" rel="noopener">recycle()</a>。</p>
<p><strong>你还必须学会怎么去正确地管理这些bitmaps</strong>，加载大的Bitmap时通过压缩，以及使用bitmap缓存池来尽可能减少内存的占用。<a href="https://developer.android.com/training/displaying-bitmaps/manage-memory.html" target="_blank" rel="noopener">这里</a> 有一个理解 bitmap 处理的很好的资源。</p>
<h3 id="Contexts"><a href="#Contexts" class="headerlink" title="Contexts"></a>Contexts</h3><p>另一个相当常见的内存泄漏是滥用 context 实例。<a href="https://developer.android.com/reference/android/content/Context.html" target="_blank" rel="noopener">Context</a> 只是一个抽象类，它有很多类（比如 Activity，Application，Service 等等）继承它并提供它们自己的功能。</p>
<blockquote>
<p><em>如果你要在 Android 中完成任务，那么 Context 对象就是你的老板。</em></p>
</blockquote>
<p>但是这些 contexts 有一些不同之处。非常重要的一点是<strong>理解 Activity级别的Context 和 Application级别的Context 之间的区别</strong>，分别用在什么情况下。</p>
<p>在错误的地方使用 Activity context 会持有整个 Activity 的引用并引发潜在的内存泄漏。<a href="https://medium.com/@ali.muzaffar/which-context-should-i-use-in-android-e3133d00772c#.mruk222z2" target="_blank" rel="noopener">这里</a>有篇很好的文章作为开始。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>现在你肯定知道垃圾收集器是怎么工作的，什么是内存泄漏，它们如何对你的app产生重大的影响。你也学习了怎样检测和修复这些内存泄漏。</p>
<p><strong>没有任何借口，从现在开始让我们开始构建一个高质量，高性能的 Android app</strong>。检测和修复内存泄漏不仅会让你的app的用户体验更好，而且会慢慢地让你成为一个更好的开发者。</p>
<p>本文最初发表于 <a href="http://techbeacon.com/" target="_blank" rel="noopener">TechBeacon</a>.</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> memory leak </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[使用Google Cloud Platform(GCP GCE)安装SSR+BBR教程]]></title>
      <url>/2017/05/29/gcp-ssr/</url>
      <content type="html"><![CDATA[<h1 id="使用Google-Cloud-Platform-GCP-GCE-安装SSR-BBR教程"><a href="#使用Google-Cloud-Platform-GCP-GCE-安装SSR-BBR教程" class="headerlink" title="使用Google Cloud Platform(GCP GCE)安装SSR+BBR教程"></a>使用Google Cloud Platform(GCP GCE)安装SSR+BBR教程</h1><p>GCP是原GCE，其优美的界面和丰富的功能深得各类程序员的喜好。近日发现Google Cloud Platform对大陆优化好，并且送300美金（12个月）的礼品卡。特此一试，效果甚好，故收集教程并集合关于Google Cloud Platform(GCP GCE)安装SS+BBR。</p>
<h2 id="创建实例"><a href="#创建实例" class="headerlink" title="创建实例"></a>创建实例</h2><p>在左侧的菜单中找到 计算引擎 –  VM 实例<br>通过创建实例或者单击加号来创建一个虚拟机。</p>
<ul>
<li>名称：随意输入</li>
<li>地区：建议<code>asia-east1-c</code></li>
<li>机器类型：小型（建议）/微型</li>
<li>启动磁盘单击更改 – Ubuntu 16.04 LTS</li>
<li>防火墙：允许HTTP流量，允许HTTPS流量</li>
</ul>
<h2 id="初步配置"><a href="#初步配置" class="headerlink" title="初步配置"></a>初步配置</h2><ul>
<li><p>左侧导航 – 计算 – 网络</p>
</li>
<li><p>外部IP地址 – 选择一个ip – 类型调整为静态</p>
</li>
<li><p>防火墙规则 – 创建防火墙规则（未提及的全部默认）：流量方向<code>入站</code>、来源ip地址<code>0.0.0.0/0</code>、协议和端口<code>全部允许</code></p>
</li>
<li><p>防火墙规则 – 创建防火墙规则（未提及的全部默认）：流量方向<code>出站</code>、来源ip地址<code>0.0.0.0/0</code>、协议和端口<code>全部允许（注意要创建两次防火墙规则，一次出站，一次入站）</code></p>
</li>
</ul>
<h2 id="配置SS以及BBR"><a href="#配置SS以及BBR" class="headerlink" title="配置SS以及BBR"></a>配置SS以及BBR</h2><p>进入实例控制台 – SSH – 在浏览器窗口中打开</p>
<h3 id="获取root权限"><a href="#获取root权限" class="headerlink" title="获取root权限"></a>获取root权限</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br></pre></td></tr></table></figure>
<h3 id="安装SS（根据脚本提示来）"><a href="#安装SS（根据脚本提示来）" class="headerlink" title="安装SS（根据脚本提示来）"></a>安装SS（根据脚本提示来）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate https://raw.githubusercontent.com/teddysun/shadowsocks_install/master/shadowsocksR.sh</span><br><span class="line">chmod +x shadowsocksR.sh</span><br><span class="line">./shadowsocksR.sh 2&gt;&amp;1 | tee shadowsocksR.log</span><br></pre></td></tr></table></figure>
<p>服务器端口：默认为 8989<br>密码：默认为 teddysun.com<br>加密方式：默认为 aes-256-cfb<br>协议（Protocol）：默认为 origin<br>混淆（obfs）：默认为 plain</p>
<h3 id="安装BBR加速"><a href="#安装BBR加速" class="headerlink" title="安装BBR加速"></a>安装BBR加速</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate https://github.com/teddysun/across/raw/master/bbr.sh &amp;&amp; chmod +x bbr.sh &amp;&amp; ./bbr.sh</span><br></pre></td></tr></table></figure>
<h3 id="重置VM实例"><a href="#重置VM实例" class="headerlink" title="重置VM实例"></a>重置VM实例</h3><h3 id="重复第一步和第二步，输入"><a href="#重复第一步和第二步，输入" class="headerlink" title="重复第一步和第二步，输入"></a>重复第一步和第二步，输入</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl net.ipv4.tcp_available_congestion_control</span><br></pre></td></tr></table></figure>
<p>若出现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_available_congestion_control = bbr cubic reno</span><br></pre></td></tr></table></figure>
<h3 id="第三第四步可以合并为一步，通过ShadowsocksR-BBR加速一键安装包"><a href="#第三第四步可以合并为一步，通过ShadowsocksR-BBR加速一键安装包" class="headerlink" title="第三第四步可以合并为一步，通过ShadowsocksR+BBR加速一键安装包"></a>第三第四步可以合并为一步，通过<a href="http://suiyuanjian.com/139.html" target="_blank" rel="noopener">ShadowsocksR+BBR加速一键安装包</a></h3><h2 id="问题及参考"><a href="#问题及参考" class="headerlink" title="问题及参考"></a>问题及参考</h2><p>无法连接外网：</p>
<ul>
<li>在VM实例的网络选项中要勾选外网IP地址，不然无法联上外网。</li>
</ul>
<p>创建步骤参考自：</p>
<ul>
<li><a href="https://sspai.com/post/39361" target="_blank" rel="noopener">如何免费打造一个安全稳定超高速的科学上网环境</a></li>
<li><a href="https://www.91yun.org/archives/2297" target="_blank" rel="noopener">GOOGLE COMPUTE ENGINE(GCE)注册开VPS教程</a></li>
<li><a href="https://github.com/kaiye/kaiye.github.com/issues/9" target="_blank" rel="noopener">拥有一架 Google 的小飞机是一种怎样的体验</a></li>
</ul>
<p>SSR/SS相关问题：</p>
<ul>
<li><a href="https://shadowsocks.be/9.html" target="_blank" rel="noopener">SSR一键脚本</a></li>
</ul>
<p>BBR相关问题：</p>
<ul>
<li><a href="https://teddysun.com/489.html" target="_blank" rel="noopener">一键安装最新内核并开启BBR脚本</a></li>
</ul>
<blockquote>
<p>–随缘箭·版权所有：<a href="https://suiyuanjian.com/124.html" target="_blank" rel="noopener">使用Google Cloud Platform(GCP GCE)安装SSR+BBR教程</a>–</p>
</blockquote>
]]></content>
      
        
        <tags>
            
            <tag> google cloud platform </tag>
            
            <tag> gcp </tag>
            
            <tag> ssr </tag>
            
            <tag> shadowsocks </tag>
            
            <tag> shadowsocksr </tag>
            
            <tag> vpn </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Gradle 插件 DiscardFilePlugin（class注入&清空类和方法）]]></title>
      <url>/2017/04/19/Android-Gradle-%E6%8F%92%E4%BB%B6-DiscardFilePlugin%EF%BC%88class%E6%B3%A8%E5%85%A5-%E6%B8%85%E7%A9%BA%E7%B1%BB%E5%92%8C%E6%96%B9%E6%B3%95%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="Android-Gradle-插件-DiscardFilePlugin（清空类和方法）"><a href="#Android-Gradle-插件-DiscardFilePlugin（清空类和方法）" class="headerlink" title="Android Gradle 插件 DiscardFilePlugin（清空类和方法）"></a>Android Gradle 插件 DiscardFilePlugin（清空类和方法）</h1><p>An android gradle plugin for discard class or method in compile time.</p>
<p>用于在编译构建时期忽略清空类和方法的一个Android Gradle插件。</p>
<p><strong>Github: <a href="https://github.com/wangjiegulu/DiscardFilePlugin" target="_blank" rel="noopener">https://github.com/wangjiegulu/DiscardFilePlugin</a></strong></p>
<h2 id="1-1-使用场景"><a href="#1-1-使用场景" class="headerlink" title="1.1 使用场景"></a>1.1 使用场景</h2><p>在实际的生产中，我们总是会在我们的app中增加一些调试的工具，比如在<code>debug</code>模式下加入<code>DebugPanelActivity</code>（调试面板工具页面，提供比如“切换服务器”等操作）。我们需要在正式上线的release版本中清空相关类和方法，或者修改<code>boolean isProductionEnvironment()</code>方法，让它永远返回<code>true</code>，<strong>以此来避免上线之后调试相关代码通过反编译等手段暴露出来。</strong></p>
<a id="more"></a>
<h2 id="1-2-Discard注解"><a href="#1-2-Discard注解" class="headerlink" title="1.2 @Discard注解"></a>1.2 <code>@Discard</code>注解</h2><h3 id="1-2-1-Target"><a href="#1-2-1-Target" class="headerlink" title="1.2.1 Target"></a>1.2.1 Target</h3><ul>
<li><p><code>ElementType.METHOD</code>: 表示清空方法中的代码，编译过程中该方法中代码被清空。</p>
</li>
<li><p><code>ElementType.TYPE</code>: 表示清空类，其实是清空类中的所有方法。</p>
</li>
</ul>
<h3 id="1-2-2-参数"><a href="#1-2-2-参数" class="headerlink" title="1.2.2 参数"></a>1.2.2 参数</h3><h4 id="1-2-2-1-apply"><a href="#1-2-2-1-apply" class="headerlink" title="1.2.2.1 apply"></a>1.2.2.1 <code>apply</code></h4><p><code>apply</code>参数规范：<code>key==exceptValue</code></p>
<p>表示当<code>key==exceptValue</code>时，Discard才会生效，才会真正在编译时去对方法或者类进行清空。因此可以在每个方法或者类中去进行不同的配置，在不同状态下通过如下方式对不同方法进行Discard：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Discard</span>(apply = <span class="string">"test1==true"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMethod_1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"testMethod_1..."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Discard</span>(apply = <span class="string">"test2==true"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMethod_2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"testMethod_2..."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>gradle assembleDebug -Ptest1=true -Ptest2=false</code>来构建时，<code>testMethod_1()</code>方法会被discard，而<code>testMethod_2()</code>不会被discard。构建完毕反编译class结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Discard</span>(apply = <span class="string">"test1==true"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMethod_1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Discard</span>(apply = <span class="string">"test2==true"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMethod_2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"testMethod_2..."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-2-2-2-srcCode"><a href="#1-2-2-2-srcCode" class="headerlink" title="1.2.2.2 srcCode"></a>1.2.2.2 <code>srcCode</code></h4><p>替换方法的方法体，如果不设置，默认discard方法实现：</p>
<ul>
<li>返回类型为<code>void</code>: discard后方法体为<code>{}</code></li>
<li>返回类型为原始数据类型：discard后方法返回默认值，比如<code>{ return 0; }</code></li>
<li>返回类型为类对象时： discard后方法返回为<code>{ return null; }</code></li>
</ul>
<p>可以如下填写具体的方法体代码块：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Discard</span>(srcCode = <span class="string">"&#123;super.onCreate($1); System.out.println(\"this: \" + $0);&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        usernameEt = (EditText) findViewById(R.id.activity_main_username_et);</span><br><span class="line">        passwordEt = (EditText) findViewById(R.id.activity_main_password_et);</span><br><span class="line">        setTestAccount();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>discard之后的class反编译代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Discard</span>(</span><br><span class="line">        srcCode = <span class="string">"&#123;super.onCreate($1); System.out.println(\"this: \" + $0);&#125;"</span></span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle var1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(var1);</span><br><span class="line">        System.out.println(<span class="string">"this: "</span> + <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>方法的<code>$0</code>表示当前对象<code>this</code>，方法参数依次为<code>$1, $2, $3...</code>，<a href="http://jboss-javassist.github.io/javassist/tutorial/tutorial2.html#alter" target="_blank" rel="noopener">详细文档参考这里</a></p>
<h4 id="1-2-2-3-makeClassNames"><a href="#1-2-2-3-makeClassNames" class="headerlink" title="1.2.2.3 makeClassNames"></a>1.2.2.3 <code>makeClassNames</code></h4><p>可以在这里指定具体的类名，在discard时对未在classPath的类进行make。<strong>不常用，可以省略。</strong></p>
<h4 id="1-2-2-4-enable"><a href="#1-2-2-4-enable" class="headerlink" title="1.2.2.4 enable"></a>1.2.2.4 <code>enable</code></h4><p>表示该方法或者类的discard是否开启，默认为<code>true</code>，比较典型的场景为，在类上面增加<code>@Discard</code>对该类所有方法进行discard，但是需要某个方法不discard，这时可以使用<code>@Discard(enable = false)</code>来对方法进行排除在<code>discard</code>范围外。</p>
<h2 id="1-3-使用方式"><a href="#1-3-使用方式" class="headerlink" title="1.3 使用方式"></a>1.3 使用方式</h2><h3 id="Gradle-Check-newest-version"><a href="#Gradle-Check-newest-version" class="headerlink" title="Gradle(Check newest version):"></a>Gradle(<a href="http://search.maven.org/#search%7Cga%7C1%7Cdiscardfile" target="_blank" rel="noopener">Check newest version</a>):</h3><p><code>build.gradle</code> in Project:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">'com.android.tools.build:gradle:2.2.2'</span></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">        classpath <span class="string">'com.github.wangjiegulu:discardfile:x.x.x'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>build.gradle</code> in <code>app</code> or <code>library</code>:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.github.wangjiegulu.plg.discardfile'</span></span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">	compile <span class="string">'com.github.wangjiegulu:discardfile-api:x.x.x'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-3-1-build-gradle"><a href="#1-3-1-build-gradle" class="headerlink" title="1.3.1. build.gradle"></a>1.3.1. <code>build.gradle</code></h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用插件</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.github.wangjiegulu.plg.discardfile'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置需要修改的类所属在那些包下</span></span><br><span class="line">discard &#123;</span><br><span class="line">    includePackagePath <span class="string">'com.wangjie.plg.discardfile.sample.ui'</span>, <span class="string">'com.wangjie.plg.discardfile.sample.include'</span></span><br><span class="line">    excludePackagePath <span class="string">'com.wangjie.plg.discardfile.sample.exclude'</span><span class="comment">/*, 'com.wangjie.plg.discardfile.sample.ui.MainActivity'*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-3-2-使用-Discard注解"><a href="#1-3-2-使用-Discard注解" class="headerlink" title="1.3.2. 使用@Discard注解"></a>1.3.2. 使用<code>@Discard</code>注解</h3><p>创建自定义apply配置(<code>publish</code>和<code>disable</code>两种apply配置)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplyConstants</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Publish</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PUBLISH = <span class="string">"publish"</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String _TRUE = PUBLISH + <span class="string">"==true"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DISABLE</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DISABLE = <span class="string">"disable"</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String _TRUE = DISABLE + <span class="string">"==true"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在需要清空的类上添加<code>@Discard</code>注解，<code>apply = ApplyConstants.Publish._TRUE</code>表示只有在<code>publish=true</code>的情况下，才会执行Discard。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Discard</span>(apply = ApplyConstants.Publish._TRUE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IncludeClassC</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 因为IncludeClassC类增加了`<span class="doctag">@Discard</span>`注解，所以该方法也会被discard。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onIncludeMethodC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onIncludeMethodC..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 替换该方法的实现为：&#123;System.out.println("onIncludeMethodC_2... injected!");&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Discard</span>(apply = ApplyConstants.Publish._TRUE, srcCode = <span class="string">"&#123;System.out.println(\"onIncludeMethodC_2... injected!\");&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onIncludeMethodC_2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onIncludeMethodC_2..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 替换该方法永远返回true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Discard</span>(apply = ApplyConstants.Publish._TRUE, srcCode = <span class="string">"&#123;return true;&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onIncludeMethodC_3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onIncludeMethodC_3..."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 因为IncludeClassC类增加了`<span class="doctag">@Discard</span>`注解，所以该方法也会被discard。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onIncludeMethodC_4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onIncludeMethodC_4..."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 由于使用了`<span class="doctag">@Discard</span>`注解进行显式地声明禁用了本地的discard，所以该方法不会被discard</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Discard</span>(apply = ApplyConstants.Publish._TRUE, enable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">onIncludeMethodC_5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onIncludeMethodC_5..."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 替换该方法永远返回"hello world"字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Discard</span>(apply = ApplyConstants.Publish._TRUE, srcCode = <span class="string">"&#123;return \"hello world injected!\";&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">onIncludeMethodC_6</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onIncludeMethodC_6..."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-3-3-build运行"><a href="#1-3-3-build运行" class="headerlink" title="1.3.3. build运行"></a>1.3.3. build运行</h3><p>通过以下命令进行构建：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle clean assembleFullDebug -Ppublish=true -Pdisable=true</span><br></pre></td></tr></table></figure>
<p>命令编译完成之后，该类的<code>class</code>文件将会根据配置的<code>@Discard</code>注解被自动修改成如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build/intermediates/transforms/discardFile/.../IncludeClassC.class</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Discard</span>(</span><br><span class="line">    apply = <span class="string">"publish==true"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IncludeClassC</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IncludeClassC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onIncludeMethodC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object var10000 = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Discard</span>(</span><br><span class="line">        apply = <span class="string">"publish==true"</span>,</span><br><span class="line">        srcCode = <span class="string">"&#123;System.out.println(\"onIncludeMethodC_2... injected!\");&#125;"</span></span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onIncludeMethodC_2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onIncludeMethodC_2... injected!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Discard</span>(</span><br><span class="line">        apply = <span class="string">"publish==true"</span>,</span><br><span class="line">        srcCode = <span class="string">"&#123;return true;&#125;"</span></span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onIncludeMethodC_3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onIncludeMethodC_4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Discard</span>(</span><br><span class="line">        apply = <span class="string">"publish==true"</span>,</span><br><span class="line">        enable = <span class="keyword">false</span></span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">onIncludeMethodC_5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"onIncludeMethodC_5..."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Discard</span>(</span><br><span class="line">        apply = <span class="string">"publish==true"</span>,</span><br><span class="line">        srcCode = <span class="string">"&#123;return \"hello world injected!\";&#125;"</span></span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">onIncludeMethodC_6</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello world injected!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> gradle </tag>
            
            <tag> gradle plugin </tag>
            
            <tag> discard </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[NDK配置]]></title>
      <url>/2017/04/11/NDK%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h1 id="NDK-配置"><a href="#NDK-配置" class="headerlink" title="NDK 配置"></a>NDK 配置</h1><p>Android SDK中下载<code>NDK</code>, <code>LLDB</code></p>
<h2 id="Android-mk-和-Application-mk"><a href="#Android-mk-和-Application-mk" class="headerlink" title="Android.mk 和 Application.mk"></a>Android.mk 和 Application.mk</h2><p>简单来说</p>
<ul>
<li>Android.mk 用来描述需要生成哪些模块的 .so 文件</li>
<li>Application.mk 用来描述如何生成 .so 文件，生成静态库还是动态库</li>
</ul>
<a id="more"></a>
<p>这里给出示例文件</p>
<p>Android.mk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := $(call my-dir)</span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">LOCAL_MODULE := gaussianBlur</span><br><span class="line">LOCAL_SRC_FILES := blur.cpp</span><br><span class="line">LOCAL_LDLIBS := -llog</span><br><span class="line">include $(BUILD_SHARED_LIBRARY)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>宏函数 my-dir 是由编译系统提供的，会返回当前目录的路径（当前目录指的是包含 Android.mk 的目录）</p>
</li>
<li><p>CLEAR_VARS 这个变量也是由编译系统提供的，会清除很多 LOCAL_XXX 变量</p>
</li>
<li><p>以上两行命令基本上是固定的，不需要去动</p>
</li>
<li><p>LOCAL_MODULE 指定模块名称，会自动生成相应的 libgaussianBlur.so 文件</p>
</li>
<li><p>LOCAL_SRC_FILES 指定这个模块要编译的 C++ 文件</p>
</li>
<li><p>LOCAL_LDLIBS 指定这个模块里会用到哪些原生 API, 详见 Android NDK Native APIs</p>
</li>
<li><p>BUILD_SHARED_LIBRARY 根据你之前定义的 LOCAL_XXX 变量，决定要编译啥，如何去编译，这行命令一般也不需要动，固定的</p>
</li>
</ul>
<p>Application.mk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">APP_STL := gnustl_static</span><br></pre></td></tr></table></figure>
<ul>
<li>APP_STL 指定使用哪些 C++ 运行时, 详见 C++ Library Support</li>
</ul>
<p>Android.mk 和 Application.mk 都放在 jni 目录下,，<br>项目文件结构如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">|____app</span><br><span class="line">| |____src</span><br><span class="line">| | |____main</span><br><span class="line">| | | |____jni</span><br><span class="line">| | | | |____Android.mk</span><br><span class="line">| | | | |____Application.mk</span><br><span class="line">| | | | |____blur.cpp</span><br></pre></td></tr></table></figure>
<h3 id="如何使用-C-代码"><a href="#如何使用-C-代码" class="headerlink" title="如何使用 C++ 代码?"></a>如何使用 C++ 代码?</h3><p>前面已经给出了 Android.mk 和 Application.mk 的示例，下面在 build.gradle 里配置 externalNativeBuild 就可以自动编译 C++ 代码了</p>
<p>示例内容如下</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">defaultConfig &#123;</span><br><span class="line">	applicationId <span class="string">"com.example.app"</span></span><br><span class="line">	minSdkVersion <span class="number">16</span></span><br><span class="line">	targetSdkVersion <span class="number">24</span></span><br><span class="line">	versionCode <span class="number">102</span></span><br><span class="line">	versionName <span class="string">"0.2"</span></span><br><span class="line">	externalNativeBuild &#123;</span><br><span class="line">		ndkBuild &#123;</span><br><span class="line">			arguments <span class="string">"NDK_APPLICATION_MK:=src/main/jni/Application.mk"</span></span><br><span class="line">			cFlags <span class="string">"-DTEST_C_FLAG1"</span>, <span class="string">"-DTEST_C_FLAG2"</span></span><br><span class="line">			cppFlags <span class="string">"-DTEST_CPP_FLAG2"</span>, <span class="string">"-DTEST_CPP_FLAG2"</span></span><br><span class="line">			abiFilters <span class="string">"armeabi-v7a"</span>, <span class="string">"armeabi"</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">externalNativeBuild &#123;</span><br><span class="line">	ndkBuild &#123;</span><br><span class="line">		path <span class="string">"src/main/jni/Android.mk"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>path 用来指定 Android.mk 的路径</li>
<li>arguments 用来指定 Application.mk 的路径</li>
<li>abiFilters 用来指定生成哪些平台的 .so 文件</li>
<li>cFlags 和 cppFlags 是用来设置环境变量的, 一般不需要动，和示例一样就好，<br>好了，现在运行项目，就可以将 blur.cpp 自动编译为 libgaussianBlur.so 文件了</li>
</ul>
<h3 id="手动生成-so-文件"><a href="#手动生成-so-文件" class="headerlink" title="手动生成 .so 文件"></a>手动生成 .so 文件</h3><p>如果能直接引用生成好的 .so 文件，可以避免重复编译 .so 文件，从而加快应用 build 速度</p>
<p>下面是手动生成 .so 文件的步骤</p>
<h4 id="进入-main-目录"><a href="#进入-main-目录" class="headerlink" title="进入 main 目录"></a>进入 main 目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd app/src/main</span><br></pre></td></tr></table></figure>
<h4 id="生成-so-文件"><a href="#生成-so-文件" class="headerlink" title="生成 .so 文件"></a>生成 .so 文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/lee/Library/Android/sdk/ndk-bundle/ndk-build NDK_PROJECT_PATH=. NDK_APPLICATION_MK=./jni/Application.mk NDK_LIBS_OUT=./jniLibs</span><br></pre></td></tr></table></figure>
<p>执行这个命令后，会在 app/src/main/jniLibs 目录生成各个平台的 .so 文件<br>如果需要把 .so 文件共享给其他人，把这些平台下的 .so 文件发给其他人就好了</p>
<ul>
<li>NDK_PROJECT_PATH 指定项目路径, 会自动读取这个目录下的 jni/Android.mk 文件</li>
<li>NDK_APPLICATION_MK 指定 Application.mk 的位置</li>
<li>NDK_LIBS_OUT 指定将生成的 .so 文件放到哪个目录，默认 Android Studio 会读取 jniLibs 目录下的 .so 文件, 所以我们把 .so 文件生成到这</li>
</ul>
<p>测试结果: （测试均在 clean 项目后进行）<br>引用 .so 文件前平均耗时 1m 27s<br>引用 .so 文件后平均耗时 47s<br>我们可以看到 build 速度快了将近一倍</p>
<p>调试 NDK<br>让 NDK_LOG 变量为1，就可以打印日志信息</p>
<p>ndk-build -e NDK_LOG=1</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://jk2k.com/2016/09/how-to-use-ndk-and-generate-so-file-in-android-studio/" target="_blank" rel="noopener">http://jk2k.com/2016/09/how-to-use-ndk-and-generate-so-file-in-android-studio/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ndk </tag>
            
            <tag> jni </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[CPP Note]]></title>
      <url>/2017/04/10/CPP-Note/</url>
      <content type="html"><![CDATA[<p>hello.cpp -&gt; 编译代码<code>g++ hello.cpp -o a</code> -&gt; <code>a.out</code></p>
<p>区分大小写的编程语言</p>
<a id="more"></a>
<h3 id="内置类型"><a href="#内置类型" class="headerlink" title="内置类型"></a>内置类型</h3><p>一些基本类型可以使用一个或多个类型修饰符进行修饰：</p>
<ul>
<li><strong>signed</strong>: char, int</li>
<li><strong>unsigned</strong>: char, int</li>
<li><strong>short</strong>: int</li>
<li><strong>long</strong>: int, double</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>字节</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>bool</strong></td>
<td></td>
</tr>
<tr>
<td><strong>char</strong></td>
<td>1</td>
</tr>
<tr>
<td><strong>int</strong></td>
<td>4, 2(short), 8(long)</td>
</tr>
<tr>
<td><strong>float</strong></td>
<td>4</td>
</tr>
<tr>
<td><strong>double</strong></td>
<td>8</td>
</tr>
<tr>
<td><strong>void</strong></td>
<td></td>
</tr>
<tr>
<td><strong>wchar_t</strong>（宽字符型）</td>
<td>2, 4</td>
</tr>
</tbody>
</table>
<h3 id="typedef-声明"><a href="#typedef-声明" class="headerlink" title="typedef 声明"></a>typedef 声明</h3><p>使用 <code>typedef</code> 为一个已有的类型取一个新的名字:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> feet;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">feet distance;</span><br></pre></td></tr></table></figure>
<h3 id="枚举类型"><a href="#枚举类型" class="headerlink" title="枚举类型"></a>枚举类型</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">enum enum-name &#123; list of names &#125; var-list;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">enum color &#123; red, green, blue &#125; c;</span><br><span class="line">c = blue;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">enum color &#123; red, green=5, blue &#125;;</span><br></pre></td></tr></table></figure>
<p>则 blue = 6</p>
<h3 id="变量定义"><a href="#变量定义" class="headerlink" title="变量定义"></a>变量定义</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">type variable_list;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>    i, j, k;</span><br><span class="line"><span class="keyword">char</span>   c, ch;</span><br><span class="line"><span class="keyword">float</span>  f, salary;</span><br><span class="line"><span class="keyword">double</span> d;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> d = <span class="number">3</span>, f = <span class="number">5</span>;    <span class="comment">// d 和 f 的声明 </span></span><br><span class="line"><span class="keyword">int</span> d = <span class="number">3</span>, f = <span class="number">5</span>;           <span class="comment">// 定义并初始化 d 和 f</span></span><br><span class="line">byte z = <span class="number">22</span>;                <span class="comment">// 定义并初始化 z</span></span><br><span class="line"><span class="keyword">char</span> x = <span class="string">'x'</span>;               <span class="comment">// 变量 x 的值为 'x'</span></span><br></pre></td></tr></table></figure>
<h3 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h3><p>变量声明向编译器保证变量以给定的类型和名称存在，这样编译器在不需要知道变量完整细节的情况下也能继续进一步的编译。变量声明只在编译时有它的意义，在程序连接时编译器需要实际的变量声明。</p>
<h3 id="全局变量默认值"><a href="#全局变量默认值" class="headerlink" title="全局变量默认值"></a>全局变量默认值</h3><table>
<thead>
<tr>
<th>类型</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>int</td>
<td>0</td>
</tr>
<tr>
<td>char</td>
<td>‘\0’</td>
</tr>
<tr>
<td>float</td>
<td>0</td>
</tr>
<tr>
<td>double</td>
<td>0</td>
</tr>
<tr>
<td>pointer</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><blockquote>
<p>0x 或 0X 表示十六进制，0 表示八进制，不带前缀则默认表示十进制。</p>
</blockquote>
<h4 id="整数常量"><a href="#整数常量" class="headerlink" title="整数常量"></a>整数常量</h4><p>也可以带一个或者多个后缀：</p>
<ul>
<li>‘<strong>U</strong>‘: unsigned</li>
<li>‘<strong>L</strong>‘: long</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">85         // 十进制</span><br><span class="line">0213       // 八进制 </span><br><span class="line">0x4b       // 十六进制 </span><br><span class="line">30         // 整数 </span><br><span class="line">30u        // 无符号整数 </span><br><span class="line">30l        // 长整数 </span><br><span class="line">30ul       // 无符号长整数</span><br></pre></td></tr></table></figure>
<h4 id="浮点常量"><a href="#浮点常量" class="headerlink" title="浮点常量"></a>浮点常量</h4><p>由整数部分、小数点、小数部分和指数部分组成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">3.14159       // 合法的 </span><br><span class="line">314159E-5L    // 合法的 </span><br><span class="line">510E          // 非法的：不完整的指数</span><br><span class="line">210f          // 非法的：没有小数或指数</span><br><span class="line">.e55          // 非法的：缺少整数或分数</span><br></pre></td></tr></table></figure>
<h4 id="布尔常量"><a href="#布尔常量" class="headerlink" title="布尔常量"></a>布尔常量</h4><ul>
<li><strong>true</strong>: 值代表真。</li>
<li><strong>false</strong>: 值代表假。</li>
</ul>
<blockquote>
<p>不应把 true 的值看成 1，把 false 的值看成 0。</p>
</blockquote>
<h4 id="字符常量"><a href="#字符常量" class="headerlink" title="字符常量"></a>字符常量</h4><p>字符常量是括在单引号中。如果常量以 L（仅当大写时）开头，则表示它是一个宽字符常量（例如 L’x’），此时它必须存储在 wchar_t 类型的变量中。否则，它就是一个窄字符常量（例如 ‘x’），此时它可以存储在 char 类型的简单变量中。</p>
<table>
<thead>
<tr>
<th>转义序列</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>\</td>
<td>\ 字符</td>
</tr>
<tr>
<td>\’</td>
<td>‘ 字符</td>
</tr>
<tr>
<td>\”</td>
<td>“ 字符</td>
</tr>
<tr>
<td>\?</td>
<td>? 字符</td>
</tr>
<tr>
<td>\a</td>
<td>警报铃声</td>
</tr>
<tr>
<td>\b</td>
<td>退格键</td>
</tr>
<tr>
<td>\f</td>
<td>换页符</td>
</tr>
<tr>
<td>\n</td>
<td>换行符</td>
</tr>
<tr>
<td>\r</td>
<td>回车</td>
</tr>
<tr>
<td>\t</td>
<td>水平制表符</td>
</tr>
<tr>
<td>\v</td>
<td>垂直制表符</td>
</tr>
</tbody>
</table>
<p>\ooo|一到三位的八进制数|<br>\xhh . . .|一个或多个数字的十六进制数|</p>
<h4 id="字符串常量"><a href="#字符串常量" class="headerlink" title="字符串常量"></a>字符串常量</h4><p>下面这三种形式所显示的字符串是相同的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;hello, dear&quot;</span><br><span class="line"></span><br><span class="line">&quot;hello, \</span><br><span class="line"></span><br><span class="line">dear&quot;</span><br><span class="line"></span><br><span class="line">&quot;hello, &quot; &quot;d&quot; &quot;ear&quot;</span><br></pre></td></tr></table></figure>
<h3 id="定义常量"><a href="#定义常量" class="headerlink" title="定义常量"></a>定义常量</h3><p>两种简单的定义常量的方式：</p>
<ul>
<li>使用 <strong>#define</strong> 预处理器。</li>
<li>使用 <strong>const</strong> 关键字。</li>
</ul>
<h4 id="define-预处理器"><a href="#define-预处理器" class="headerlink" title="#define 预处理器"></a>#define 预处理器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define identifier value</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#define LENGTH 10   </span><br><span class="line">#define WIDTH  5</span><br><span class="line">#define NEWLINE &apos;\n&apos;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line"></span><br><span class="line">   int area;  </span><br><span class="line"></span><br><span class="line">   area = LENGTH * WIDTH;</span><br><span class="line">   cout &lt;&lt; area;</span><br><span class="line">   cout &lt;&lt; NEWLINE;</span><br><span class="line">   return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="const-关键字"><a href="#const-关键字" class="headerlink" title="const 关键字"></a>const 关键字</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const type variable = value;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">int</span>  LENGTH = <span class="number">10</span>;</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">int</span>  WIDTH  = <span class="number">5</span>;</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> NEWLINE = <span class="string">'\n'</span>;</span><br><span class="line">   <span class="keyword">int</span> area;  </span><br><span class="line"></span><br><span class="line">   area = LENGTH * WIDTH;</span><br><span class="line">   <span class="built_in">cout</span> &lt;&lt; area;</span><br><span class="line">   <span class="built_in">cout</span> &lt;&lt; NEWLINE;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="修饰符类型"><a href="#修饰符类型" class="headerlink" title="修饰符类型"></a>修饰符类型</h3><p>可以不写 int，只写单词 unsigned、short 或 unsigned、long，int 是隐含的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsigned x;</span><br><span class="line">unsigned <span class="keyword">int</span> y;</span><br></pre></td></tr></table></figure>
<h3 id="类型限定符"><a href="#类型限定符" class="headerlink" title="类型限定符"></a>类型限定符</h3><table>
<thead>
<tr>
<th>限定符</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>const</td>
<td>const 类型的对象在程序执行期间不能被修改改变。</td>
</tr>
<tr>
<td>volatile</td>
<td>修饰符 volatile 告诉编译器，变量的值可能以程序未明确指定的方式被改变。</td>
</tr>
<tr>
<td>restrict</td>
<td>由 restrict 修饰的指针是唯一一种访问它所指向的对象的方式。只有 C99 增加了新的类型限定符 restrict。</td>
</tr>
</tbody>
</table>
<h3 id="存储类"><a href="#存储类" class="headerlink" title="存储类"></a>存储类</h3><p>存储类定义 C++ 程序中变量/函数的范围（可见性）和生命周期。</p>
<ul>
<li>auto: 从 C++ 11 开始不再是 C++ 存储类说明符</li>
<li>register: 从 C++ 11 开始被弃用</li>
<li>static</li>
<li>extern</li>
<li>mutable</li>
<li>thread_local (C++11)</li>
</ul>
<h4 id="auto-存储类"><a href="#auto-存储类" class="headerlink" title="auto 存储类"></a>auto 存储类</h4><p>声明变量时根据初始化表达式自动推断该变量的类型、声明函数时函数返回值的占位符。使用极少且多余，在C++11中已删除这一用法。</p>
<h4 id="register-存储类"><a href="#register-存储类" class="headerlink" title="register 存储类"></a>register 存储类</h4><p>register 存储类用于定义存储在寄存器中而不是 RAM 中的局部变量。这意味着变量的最大尺寸等于寄存器的大小（通常是一个词），且不能对它应用一元的 ‘&amp;’ 运算符（因为它没有内存位置）。</p>
<p>寄存器只用于需要快速访问的变量，比如计数器。还应注意的是，定义 ‘register’ 并不意味着变量将被存储在寄存器中，它意味着变量可能存储在寄存器中，这取决于硬件和实现的限制。</p>
<h4 id="static-存储类"><a href="#static-存储类" class="headerlink" title="static 存储类"></a>static 存储类</h4><p>static 存储类指示编译器在程序的生命周期内保持局部变量的存在，而不需要在每次它进入和离开作用域时进行创建和销毁。</p>
<p><strong>static 可用于局部变量和全局变量</strong></p>
<h4 id="extern-存储类"><a href="#extern-存储类" class="headerlink" title="extern 存储类"></a>extern 存储类</h4><p>extern 存储类用于提供一个全局变量的引用，全局变量对所有的程序文件都是可见的。<br>通过 extern 声明其它文件的变量，然后在本文件中使用。</p>
<h4 id="mutable-存储类"><a href="#mutable-存储类" class="headerlink" title="mutable 存储类"></a>mutable 存储类</h4><p>mutable 说明符仅适用于类的对象，它允许对象的成员替代常量。也就是说，mutable 成员可以通过 const 成员函数修改。</p>
<h4 id="thread-local-存储类"><a href="#thread-local-存储类" class="headerlink" title="thread_local 存储类"></a>thread_local 存储类</h4><p>使用 thread_local 说明符声明的变量仅可在它在其上创建的线程上访问。 变量在创建线程时创建，并在销毁线程时销毁。 每个线程都有其自己的变量副本。<br>thread_local 说明符可以与 static 或 extern 合并。<br>可以将 thread_local 仅应用于数据声明和定义，thread_local 不能用于函数声明或定义。</p>
<h3 id="杂项运算符"><a href="#杂项运算符" class="headerlink" title="杂项运算符"></a>杂项运算符</h3><table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>sizeof</td>
<td>sizeof 运算符返回变量的大小。例如，sizeof(a) 将返回 4，其中 a 是整数。</td>
</tr>
<tr>
<td>Condition ? X : Y</td>
<td>条件运算符。如果 Condition 为真 ? 则值为 X : 否则值为 Y。</td>
</tr>
<tr>
<td>,</td>
<td>逗号运算符会顺序执行一系列运算。整个逗号表达式的值是以逗号分隔的列表中的最后一个表达式的值。</td>
</tr>
<tr>
<td>.（点）和 -&gt;（箭头）</td>
<td>成员运算符用于引用类、结构和共用体的成员。</td>
</tr>
<tr>
<td>Cast</td>
<td>强制转换运算符把一种数据类型转换为另一种数据类型。例如，int(2.2000) 将返回 2。</td>
</tr>
<tr>
<td>&amp;</td>
<td>指针运算符 &amp; 返回变量的地址。例如 &a; 将给出变量的实际地址。</td>
</tr>
<tr>
<td>*</td>
<td>指针运算符 * 指向一个变量。例如，*var; 将指向变量 var。</td>
</tr>
</tbody>
</table>
<h3 id="函数参数"><a href="#函数参数" class="headerlink" title="函数参数"></a>函数参数</h3><table>
<thead>
<tr>
<th>调用类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>传值调用</td>
<td>该方法把参数的实际值复制给函数的形式参数。在这种情况下，修改函数内的形式参数对实际参数没有影响。</td>
</tr>
<tr>
<td>指针调用</td>
<td>该方法把参数的地址复制给形式参数。在函数内，该地址用于访问调用中要用到的实际参数。这意味着，修改形式参数会影响实际参数。</td>
</tr>
<tr>
<td>引用调用</td>
<td>该方法把参数的引用复制给形式参数。在函数内，该引用用于访问调用中要用到的实际参数。这意味着，修改形式参数会影响实际参数。</td>
</tr>
</tbody>
</table>
<p><strong>默认情况下，C++ 使用传值调用来传递参数。</strong>一般来说，这意味着函数内的代码不能改变用于调用函数的参数。之前提到的实例，调用 max() 函数时，使用了相同的方法。</p>
<h3 id="参数的默认值"><a href="#参数的默认值" class="headerlink" title="参数的默认值"></a>参数的默认值</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b=<span class="number">20</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result;</span><br><span class="line"></span><br><span class="line">  result = a + b;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">result = sum(<span class="number">1</span>, <span class="number">2</span>); <span class="comment">// 3</span></span><br><span class="line">result = sum(<span class="number">1</span>); <span class="comment">// 21</span></span><br></pre></td></tr></table></figure>
<h3 id="Lambda-函数与表达式"><a href="#Lambda-函数与表达式" class="headerlink" title="Lambda 函数与表达式"></a>Lambda 函数与表达式</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 有参数：[capture](parameters)-&gt;return-type&#123;body&#125;</span></span><br><span class="line">[](<span class="keyword">int</span> x, <span class="keyword">int</span> y)&#123; <span class="keyword">return</span> x &lt; y ; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无参数：[capture](parameters)&#123;body&#125;</span></span><br><span class="line">[]&#123; ++global_x; &#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回类型可以被明确的指定:</span></span><br><span class="line">[](<span class="keyword">int</span> x, <span class="keyword">int</span> y) -&gt; <span class="keyword">int</span> &#123; <span class="keyword">int</span> z = x + y; <span class="keyword">return</span> z + x; &#125;</span><br></pre></td></tr></table></figure>
<p>变量传递有传值和传引用的区别。可以通过前面的[]来指定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[]      // 沒有定义任何变量。使用未定义变量会引发错误。</span><br><span class="line">[x, &amp;y] // x以传值方式传入（默认），y以引用方式传入。</span><br><span class="line">[&amp;]     // 任何被使用到的外部变量都隐式地以引用方式加以引用。</span><br><span class="line">[=]     // 任何被使用到的外部变量都隐式地以传值方式加以引用。</span><br><span class="line">[&amp;, x]  // x显式地以传值方式加以引用。其余变量以引用方式加以引用。</span><br><span class="line">[=, &amp;z] // z显式地以引用方式加以引用。其余变量以传值方式加以引用。</span><br></pre></td></tr></table></figure>
<p>对于[=]或[&amp;]的形式，lambda 表达式可以直接使用 this 指针。但是，对于[]的形式，如果要使用 this 指针，必须显式传入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[this]() &#123; this-&gt;someFunc(); &#125;();</span><br></pre></td></tr></table></figure>
<h3 id="数学运算"><a href="#数学运算" class="headerlink" title="数学运算"></a>数学运算</h3><p>引用数学头文件 \<cmath\></cmath\></p>
<p>sin, cos, tan, log, pow, hypot(两数总和平方根), fabs（绝对值）</p>
<h3 id="随机数"><a href="#随机数" class="headerlink" title="随机数"></a>随机数</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置种子</span></span><br><span class="line">srand( (<span class="keyword">unsigned</span>)time( <span class="literal">NULL</span> ) );</span><br><span class="line"></span><br><span class="line">rand();</span><br></pre></td></tr></table></figure>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><h4 id="声明数组"><a href="#声明数组" class="headerlink" title="声明数组"></a>声明数组</h4><blockquote>
<p>数组是一个常量指针</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// type arrayName [ arraySize ];</span></span><br><span class="line"><span class="keyword">double</span> balance[<span class="number">10</span>];</span><br></pre></td></tr></table></figure>
<h4 id="初始化数组"><a href="#初始化数组" class="headerlink" title="初始化数组"></a>初始化数组</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> balance[<span class="number">5</span>] = &#123;<span class="number">1000.0</span>, <span class="number">2.0</span>, <span class="number">3.4</span>, <span class="number">17.0</span>, <span class="number">50.0</span>&#125;;</span><br><span class="line"><span class="keyword">double</span> balance[] = &#123;<span class="number">1000.0</span>, <span class="number">2.0</span>, <span class="number">3.4</span>, <span class="number">17.0</span>, <span class="number">50.0</span>&#125;;</span><br><span class="line"></span><br><span class="line">balance[<span class="number">4</span>] = <span class="number">50.0</span>; <span class="comment">//</span></span><br></pre></td></tr></table></figure>
<p>直接初始化 char 数组是特殊的, <strong>这种初始化要记得字符是以一个 null 结尾的</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">char a1[] = &#123;&apos;C&apos;, &apos;+&apos;, &apos;+&apos;&#125;;          // 初始化，没有 null</span><br><span class="line">char a2[] = &#123;&apos;C&apos;, &apos;+&apos;, &apos;+&apos;, &apos;\0&apos;&#125;;    // 初始化，明确有 null</span><br><span class="line">char a3[] = &quot;C++&quot;;                    // null 终止符自动添加</span><br><span class="line">const char a4[6] = &quot;runoob&quot;;          // 报错，没有 null 的位置</span><br></pre></td></tr></table></figure>
<h3 id="指针变量声明"><a href="#指针变量声明" class="headerlink" title="指针变量声明"></a>指针变量声明</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type *var-name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>    *ip;    <span class="comment">/* 一个整型的指针 */</span></span><br><span class="line"><span class="keyword">double</span> *dp;    <span class="comment">/* 一个 double 型的指针 */</span></span><br><span class="line"><span class="keyword">float</span>  *fp;    <span class="comment">/* 一个浮点型的指针 */</span></span><br><span class="line"><span class="keyword">char</span>   *ch;    <span class="comment">/* 一个字符型的指针 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> var = <span class="number">20</span>;</span><br><span class="line"><span class="comment">// int *ip = &amp;var</span></span><br><span class="line"><span class="keyword">int</span> *ip;</span><br><span class="line">ip = &amp;var;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"var: "</span> &lt;&lt; var &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 20</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"ip: "</span> &lt;&lt; ip &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 0x7fff50bbe874</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"*ip: "</span> &lt;&lt; *ip &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 20</span></span><br></pre></td></tr></table></figure>
<h4 id="NULL-指针"><a href="#NULL-指针" class="headerlink" title="NULL 指针"></a>NULL 指针</h4><p>NULL 指针是一个定义在标准库中的值为零的常量：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *nullP = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span>(!nullP)&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"nullP: "</span> &lt;&lt; nullP &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// 0x0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="指针的算术运算"><a href="#指针的算术运算" class="headerlink" title="指针的算术运算"></a>指针的算术运算</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptr++</span><br></pre></td></tr></table></figure>
<p>假设 ptr 是一个指向地址 1000 的整型指针，是一个 32 位的整数(4个字节)，,ptr 将指向位置 1004，因为 ptr 每增加一次，它都将指向下一个整数位置，即当前位置往后移 4 个字节。</p>
<p>如果 ptr 指向一个地址为 1000 的字符(1个字节)，上面的运算会导致指针指向位置 1001，因为下一个字符位置是在 1001。</p>
<p><strong>数组是一个常量指针</strong></p>
<h4 id="传递指针给函数"><a href="#传递指针给函数" class="headerlink" title="传递指针给函数"></a>传递指针给函数</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *pr;</span><br><span class="line"><span class="keyword">int</span> **ppr;</span><br><span class="line">pr = &amp;var;</span><br><span class="line">ppr = &amp;pr;</span><br><span class="line"></span><br><span class="line">funPointer(pr);</span><br><span class="line">funPointer(*ppr);</span><br><span class="line"><span class="keyword">int</span> var = <span class="number">20</span>;</span><br><span class="line">funPointer(&amp;var);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">funPointer</span><span class="params">(<span class="keyword">int</span> *p)</span></span>&#123;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"[funPointer]*p: "</span> &lt;&lt; *p &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="从函数返回指针"><a href="#从函数返回指针" class="headerlink" title="从函数返回指针"></a>从函数返回指针</h4><p>C++ 不支持在函数外返回局部变量的地址，除非定义局部变量为 static 变量。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> var = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> *fp2p = funPointer2(&amp;var);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"*fp2p:"</span> &lt;&lt; *fp2p &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> * <span class="title">funPointer2</span><span class="params">(<span class="keyword">int</span> *p)</span> </span>&#123;</span><br><span class="line">    p++;</span><br><span class="line">    p--;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="引用-vs-指针"><a href="#引用-vs-指针" class="headerlink" title="引用 vs 指针"></a>引用 vs 指针</h3><p>引用很容易与指针混淆，它们之间有三个主要的不同：</p>
<ul>
<li>不存在空引用。引用必须连接到一块合法的内存。</li>
<li>一旦引用被初始化为一个对象，就不能被指向到另一个对象。指针可以在任何时候指向到另一个对象。</li>
<li>引用必须在创建时被初始化。指针可以在任何时间被初始化。</li>
</ul>
<h4 id="创建引用"><a href="#创建引用" class="headerlink" title="创建引用"></a>创建引用</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明简单的变量</span></span><br><span class="line"><span class="keyword">int</span>    i;</span><br><span class="line"><span class="keyword">double</span> d;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明引用变量</span></span><br><span class="line"><span class="keyword">int</span>&amp;    r = i; <span class="comment">// r 是一个初始化为 i 的整型引用</span></span><br><span class="line"><span class="keyword">double</span>&amp; s = d; <span class="comment">// s 是一个初始化为 d 的 double 型引用</span></span><br></pre></td></tr></table></figure>
<p>在这些声明中，<strong>&amp;</strong> 读作引用。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> swapA = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> swapB = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">swapWithRef(swapA, swapB);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swapWithRef</span><span class="params">(<span class="keyword">int</span> &amp;a, <span class="keyword">int</span> &amp;b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> temp = a;</span><br><span class="line">    a = b;</span><br><span class="line">    b = temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> swapA = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> swapB = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">swapWithPointer(&amp;swapAP, &amp;swapBP);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swapWithPointer</span><span class="params">(<span class="keyword">int</span> *a, <span class="keyword">int</span> *b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> temp = *a; <span class="comment">// 局部变量temp的值为[a指针指向的值](1)</span></span><br><span class="line">    *a = *b; <span class="comment">// a指针指向的值改为[b指针指向的值](2)</span></span><br><span class="line">    *b = temp; <span class="comment">// b指针指向的值改为temp(1)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="把引用作为返回值"><a href="#把引用作为返回值" class="headerlink" title="把引用作为返回值"></a>把引用作为返回值</h4><p>当函数返回一个引用时，则返回一个指向返回值的隐式指针。这样，函数就可以放在赋值语句的左边。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> vals[] = &#123;<span class="number">10.1</span>, <span class="number">12.6</span>, <span class="number">33.1</span>, <span class="number">24.1</span>, <span class="number">50.0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> &amp;<span class="title">setValues</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> vals[i];   <span class="comment">// 返回第 i 个元素的引用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setValues(<span class="number">1</span>) = <span class="number">20.17</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"vals: "</span> &lt;&lt; vals[<span class="number">1</span>] &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<p>返回一个对局部变量的引用是不合法的，但是，可以返回一个对静态变量的引用。</p>
<h4 id="日期-amp-时间"><a href="#日期-amp-时间" class="headerlink" title="日期 &amp; 时间"></a>日期 &amp; 时间</h4><p>C/C++ 标准库, 引用 \<ctime\> 头文件</ctime\></p>
<p><code>有四个与时间相关的类型：clock_t、time_t、size_t 和 tm</code></p>
<p>构类型 tm 把日期和时间以 C 结构的形式保存</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tm</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> tm_sec;   <span class="comment">// 秒，正常范围从 0 到 59，但允许至 61</span></span><br><span class="line">  <span class="keyword">int</span> tm_min;   <span class="comment">// 分，范围从 0 到 59</span></span><br><span class="line">  <span class="keyword">int</span> tm_hour;  <span class="comment">// 小时，范围从 0 到 23</span></span><br><span class="line">  <span class="keyword">int</span> tm_mday;  <span class="comment">// 一月中的第几天，范围从 1 到 31</span></span><br><span class="line">  <span class="keyword">int</span> tm_mon;   <span class="comment">// 月，范围从 0 到 11</span></span><br><span class="line">  <span class="keyword">int</span> tm_year;  <span class="comment">// 自 1900 年起的年数</span></span><br><span class="line">  <span class="keyword">int</span> tm_wday;  <span class="comment">// 一周中的第几天，范围从 0 到 6，从星期日算起</span></span><br><span class="line">  <span class="keyword">int</span> tm_yday;  <span class="comment">// 一年中的第几天，范围从 0 到 365，从 1 月 1 日算起</span></span><br><span class="line">  <span class="keyword">int</span> tm_isdst; <span class="comment">// 夏令时</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">time_t</span> now = time(<span class="number">0</span>); <span class="comment">// 基于当前系统的当前日期/时间</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"now: "</span> &lt;&lt; now &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *dt = ctime(&amp;now); <span class="comment">// 把 now 转换为字符串形式</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"本地日期和时间："</span> &lt;&lt; dt &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把 now 转换为 tm 结构</span></span><br><span class="line">tm *gmtm = gmtime(&amp;now);</span><br><span class="line">dt = asctime(gmtm);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"UTC 日期和时间："</span> &lt;&lt; dt &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">tm *ltm = localtime(&amp;now);</span><br><span class="line"><span class="comment">// 输出 tm 结构的各个组成部分</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"Year: "</span>&lt;&lt; <span class="number">1900</span> + ltm-&gt;tm_year &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"Month: "</span>&lt;&lt; <span class="number">1</span> + ltm-&gt;tm_mon&lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"Day: "</span>&lt;&lt;  ltm-&gt;tm_mday &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"Time: "</span>&lt;&lt; ltm-&gt;tm_hour &lt;&lt; <span class="string">":"</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; ltm-&gt;tm_min &lt;&lt; <span class="string">":"</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; ltm-&gt;tm_sec &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<h3 id="标准输出流（cout）"><a href="#标准输出流（cout）" class="headerlink" title="标准输出流（cout）"></a>标准输出流（cout）</h3><p>预定义的对象 <code>cout</code> 是 <code>ostream</code> 类的一个实例, 流插入运算符 <code>&lt;&lt;</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> str[] = <span class="string">"Hello C++"</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"Value of str is : "</span> &lt;&lt; str &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<h3 id="标准输入流（cin）"><a href="#标准输入流（cin）" class="headerlink" title="标准输入流（cin）"></a>标准输入流（cin）</h3><p>预定义的对象 cin 是 istream 类的一个实例。流提取运算符 <code>&gt;&gt;</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> name[<span class="number">50</span>];</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"请输入您的名称： "</span>;</span><br><span class="line"><span class="built_in">cin</span> &gt;&gt; name;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"您的名称是： "</span> &lt;&lt; name &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<h3 id="标准错误流（cerr）"><a href="#标准错误流（cerr）" class="headerlink" title="标准错误流（cerr）"></a>标准错误流（cerr）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> str[] = <span class="string">"Fake Error..."</span>;</span><br><span class="line"><span class="built_in">cerr</span> &lt;&lt; <span class="string">"Error message: "</span> &lt;&lt; str &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<h3 id="标准日志流（clog）"><a href="#标准日志流（clog）" class="headerlink" title="标准日志流（clog）"></a>标准日志流（clog）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> strLog[] = <span class="string">"Fake Log..."</span>;</span><br><span class="line"><span class="built_in">clog</span> &lt;&lt; <span class="string">"Log message: "</span> &lt;&lt; strLog &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><h4 id="定义结构"><a href="#定义结构" class="headerlink" title="定义结构"></a>定义结构</h4><p>使用 <strong>struct</strong> 语句。struct 语句定义了一个包含多个成员的新的数据类型</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">type_name</span> &#123;</span></span><br><span class="line">member_type1 member_name1;</span><br><span class="line">member_type2 member_name2;</span><br><span class="line">member_type3 member_name3;</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">&#125; object_names;</span><br></pre></td></tr></table></figure>
<p>type_name 是结构体类型的名称，member_type1 member_name1 是标准的变量定义，比如 int i; 或者 float f; 或者其他有效的变量定义。在结构定义的末尾，最后一个分号之前，您可以指定一个或多个结构变量，这是可选的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Books</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="keyword">char</span>  title[<span class="number">50</span>];</span><br><span class="line">   <span class="keyword">char</span>  author[<span class="number">50</span>];</span><br><span class="line">   <span class="keyword">char</span>  subject[<span class="number">100</span>];</span><br><span class="line">   <span class="keyword">int</span>   book_id;</span><br><span class="line">&#125; book;</span><br></pre></td></tr></table></figure>
<h4 id="访问结构成员"><a href="#访问结构成员" class="headerlink" title="访问结构成员"></a>访问结构成员</h4><p>使用成员访问运算符（<strong>.</strong>）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Book</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> title[<span class="number">50</span>];</span><br><span class="line">    <span class="keyword">char</span> author[<span class="number">50</span>];</span><br><span class="line">    <span class="keyword">char</span> subject[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">int</span> book_id;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">Book book1;</span><br><span class="line"><span class="built_in">strcpy</span>(book1.title, <span class="string">"c++"</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(book1.author, <span class="string">"wangjie"</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(book1.subject, <span class="string">"c++ subject"</span>);</span><br><span class="line">book1.book_id = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"book1 title: "</span> &lt;&lt; book1.title &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"book1 author: "</span> &lt;&lt; book1.author &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"book1 subject: "</span> &lt;&lt; book1.subject &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"book1 book_id: "</span> &lt;&lt; book1.book_id &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<h4 id="结构作为函数参数"><a href="#结构作为函数参数" class="headerlink" title="结构作为函数参数"></a>结构作为函数参数</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printBook</span><span class="params">(struct Book book)</span></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"[printBook]book title: "</span> &lt;&lt; book.title &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"[printBook]book author: "</span> &lt;&lt; book.author &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"[printBook]book subject: "</span> &lt;&lt; book.subject &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"[printBook]book book_id: "</span> &lt;&lt; book.book_id &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Book book2;</span><br><span class="line"></span><br><span class="line"><span class="built_in">strcpy</span>(book2.title, <span class="string">"java"</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(book2.author, <span class="string">"wangjie"</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(book2.subject, <span class="string">"java subject"</span>);</span><br><span class="line">book2.book_id = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">printBook(book2);</span><br></pre></td></tr></table></figure>
<h4 id="指向结构的指针"><a href="#指向结构的指针" class="headerlink" title="指向结构的指针"></a>指向结构的指针</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Book *book1P = &amp;book1;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"book1P-&gt;title: "</span> &lt;&lt; book1P-&gt;title &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"book1P-&gt;author: "</span> &lt;&lt; book1P-&gt;author &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"book1P-&gt;subject: "</span> &lt;&lt; book1P-&gt;subject &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"book1P-&gt;book_id: "</span> &lt;&lt; book1P-&gt;book_id &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<p><strong>为了使用指向该结构的指针访问结构的成员，您必须使用 <code>-&gt;</code> 运算符</strong></p>
<h4 id="typedef-关键字"><a href="#typedef-关键字" class="headerlink" title="typedef 关键字"></a>typedef 关键字</h4><p>定义结构的方式，可以为创建的类型取一个”别名”:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="keyword">char</span>  title[<span class="number">50</span>];</span><br><span class="line">   <span class="keyword">char</span>  author[<span class="number">50</span>];</span><br><span class="line">   <span class="keyword">char</span>  subject[<span class="number">100</span>];</span><br><span class="line">   <span class="keyword">int</span>   book_id;</span><br><span class="line">&#125;Books;</span><br></pre></td></tr></table></figure>
<p>可以使用 typedef 关键字来定义非结构类型:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">int</span> *pint32;</span><br><span class="line">pint32 x, y, z;</span><br></pre></td></tr></table></figure>
<p>x, y 和 z 都是指向长整型 long int 的指针。</p>
<h3 id="类和对象"><a href="#类和对象" class="headerlink" title="类和对象"></a>类和对象</h3><h4 id="创建类"><a href="#创建类" class="headerlink" title="创建类"></a>创建类</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">double</span> length;</span><br><span class="line">    <span class="keyword">double</span> breadth;</span><br><span class="line">    <span class="keyword">double</span> height;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="成员函数"><a href="#成员函数" class="headerlink" title="成员函数"></a>成员函数</h4><p>范围解析运算符 <strong>::</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">double</span> length;</span><br><span class="line">    <span class="keyword">double</span> breadth;</span><br><span class="line">    <span class="keyword">double</span> height;</span><br><span class="line">    <span class="comment">// 成员函数定义</span></span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">getVolume</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 成员函数声明</span></span><br><span class="line"><span class="keyword">double</span> Box::getVolume(<span class="keyword">void</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>-&gt;height * <span class="keyword">this</span>-&gt;breadth * <span class="keyword">this</span>-&gt;length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="类访问修饰符"><a href="#类访问修饰符" class="headerlink" title="类访问修饰符"></a>类访问修饰符</h3><p><code>public</code>, <code>protected</code>, <code>private</code>(默认)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> &#123;</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">  <span class="comment">// public members go here</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">  <span class="comment">// protected members go here</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">  <span class="comment">// private members go here</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>public</code>成员在程序中类的外部是可访问的.</p>
<p><code>private</code>成员变量或函数在类的外部是不可访问的，甚至是不可查看的。只有类和友元函数可以访问私有成员。</p>
<p><code>protected</code>成员变量或函数与私有成员十分相似，但有一点不同，保护成员在派生类（即子类）中是可访问的。</p>
<h3 id="类的构造函数"><a href="#类的构造函数" class="headerlink" title="类的构造函数"></a>类的构造函数</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Box::Box(<span class="keyword">double</span> length, <span class="keyword">double</span> breadth, <span class="keyword">double</span> height)&#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;length = length;</span><br><span class="line">    <span class="keyword">this</span>-&gt;breadth = breadth;</span><br><span class="line">    <span class="keyword">this</span>-&gt;height = height;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"box created2..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Box::Box(<span class="keyword">double</span> length, <span class="keyword">double</span> breadth, <span class="keyword">double</span> height) : length(length), breadth(breadth), height(height)&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"box created 初始化列表..."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="类的析构函数"><a href="#类的析构函数" class="headerlink" title="类的析构函数"></a>类的析构函数</h3><p>类的析构函数是类的一种特殊的成员函数，它会在每次删除所创建的对象时执行。<br>析构函数的名称与类的名称是完全相同的，只是在前面加了个波浪号（~）作为前缀，它不会返回任何值，也不能带有任何参数。析构函数有助于在跳出程序（比如关闭文件、释放内存等）前释放资源。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~Box();</span><br><span class="line"></span><br><span class="line">Box::~Box() &#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Object is being deleted"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="拷贝构造函数"><a href="#拷贝构造函数" class="headerlink" title="拷贝构造函数"></a>拷贝构造函数</h3><p><a href="http://www.runoob.com/cplusplus/cpp-copy-constructor.html" target="_blank" rel="noopener">http://www.runoob.com/cplusplus/cpp-copy-constructor.html</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">classname (<span class="keyword">const</span> classname &amp;obj) &#123;</span><br><span class="line">   <span class="comment">// 构造函数的主体</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Line( <span class="keyword">const</span> Line &amp;obj);      <span class="comment">// 拷贝构造函数</span></span><br><span class="line"></span><br><span class="line">Line::Line(<span class="keyword">const</span> Line &amp;obj)&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"调用拷贝构造函数并为指针 ptr 分配内存"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    ptr = <span class="keyword">new</span> <span class="keyword">int</span>;</span><br><span class="line">    *ptr = *obj.ptr; <span class="comment">// 拷贝值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="友元函数"><a href="#友元函数" class="headerlink" title="友元函数"></a>友元函数</h3><p>类的友元函数是定义在类外部，但有权访问类的所有私有（private）成员和保护（protected）成员。尽管友元函数的原型有在类的定义中出现过，但是友元函数并不是成员函数。<br>友元可以是一个函数，该函数被称为友元函数；友元也可以是一个类，该类被称为友元类，在这种情况下，整个类及其所有成员都是友元。</p>
<p><strong>friend</strong>关键字</p>
<p>声明类 ClassTwo 的所有成员函数作为类 ClassOne 的友元，需要在类 ClassOne 的定义中放置如下声明：<br><code>friend class ClassTwo;</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Box</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="keyword">double</span> width;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">   <span class="keyword">double</span> length;</span><br><span class="line">   <span class="function"><span class="keyword">friend</span> <span class="keyword">void</span> <span class="title">printWidth</span><span class="params">( Box box )</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">setWidth</span><span class="params">( <span class="keyword">double</span> wid )</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请注意：printWidth() 不是任何类的成员函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printWidth</span><span class="params">( Box box )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">/* 因为 printWidth() 是 Box 的友元，它可以直接访问该类的任何成员 */</span></span><br><span class="line">   <span class="built_in">cout</span> &lt;&lt; <span class="string">"Width of box : "</span> &lt;&lt; box.width &lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="内联函数"><a href="#内联函数" class="headerlink" title="内联函数"></a>内联函数</h3><p>内联函数是通常与类一起使用。如果一个函数是内联的，那么在编译时，编译器会把该函数的代码副本放置在每个调用该函数的地方。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">Max</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> (x &gt; y)? x : y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"Max (20,10): "</span> &lt;&lt; Max(<span class="number">20</span>,<span class="number">10</span>) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"Max (0,200): "</span> &lt;&lt; Max(<span class="number">0</span>,<span class="number">200</span>) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"Max (100,1010): "</span> &lt;&lt; Max(<span class="number">100</span>,<span class="number">1010</span>) &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<h4 id="this-指针"><a href="#this-指针" class="headerlink" title="this 指针"></a>this 指针</h4><p>每一个对象都能通过 this 指针来访问自己的地址。this 指针是所有成员函数的隐含参数。因此，在成员函数内部，它可以用来指向调用对象。</p>
<p>友元函数没有 this 指针，因为友元不是类的成员。只有成员函数才有 this 指针。</p>
<h4 id="指向类的指针"><a href="#指向类的指针" class="headerlink" title="指向类的指针"></a>指向类的指针</h4><p>一个指向 C++ 类的指针与指向结构的指针类似，访问指向类的指针的成员，需要使用成员访问运算符 -&gt;，就像访问指向结构的指针一样。与所有的指针一样，您必须在使用指针之前，对指针进行初始化。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Box *boxBPr = &amp;boxB;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"*boxBPr-&gt;getVolume(): "</span> &lt;&lt; boxBPr-&gt;getVolume() &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<h4 id="类的静态成员"><a href="#类的静态成员" class="headerlink" title="类的静态成员"></a>类的静态成员</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> objectCount;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化类 Box 的静态成员</span></span><br><span class="line"><span class="keyword">int</span> Box::objectCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"static objects: "</span> &lt;&lt; Box::objectCount &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">static bool staticFunc();</span><br><span class="line"></span><br><span class="line">Box::staticFunc();</span><br></pre></td></tr></table></figure>
<h4 id="基类-amp-派生类"><a href="#基类-amp-派生类" class="headerlink" title="基类 &amp; 派生类"></a>基类 &amp; 派生类</h4><p>一个类可以派生自多个类，这意味着，它可以从多个基类继承数据和函数。定义一个派生类，我们使用一个类派生列表来指定基类。类派生列表以一个或多个基类命名，形式如下：</p>
<p><code>class derived-class: access-specifier base-class</code></p>
<p><code>access-specifier</code> 是 <code>public</code>、<code>protected</code> 或 <code>private</code> 其中的一个，默认为 <code>private</code>，<code>base-class</code> 是之前定义过的某个类的名称。</p>
<p>一个派生类继承了所有的基类方法，但下列情况除外：</p>
<ul>
<li>基类的构造函数、析构函数和拷贝构造函数。</li>
<li>基类的重载运算符。</li>
<li>基类的友元函数。</li>
</ul>
<h4 id="继承类型"><a href="#继承类型" class="headerlink" title="继承类型"></a>继承类型</h4><p>我们几乎不使用 protected 或 private 继承，通常使用 public 继承。当使用不同类型的继承时，遵循以下几个规则：</p>
<ul>
<li>公有继承（<strong>public</strong>）：当一个类派生自<strong>公有</strong>基类时，基类的<strong>公有</strong>成员也是派生类的<strong>公有</strong>成员，基类的<strong>保护</strong>成员也是派生类的<strong>保护</strong>成员，基类的<strong>私有</strong>成员不能直接被派生类访问，但是可以通过调用基类的<strong>公有</strong>和<strong>保护</strong>成员来访问。</li>
<li>保护继承（<strong>protected</strong>）： 当一个类派生自<strong>保护</strong>基类时，基类的<strong>公有</strong>和<strong>保护</strong>成员将成为派生类的<strong>保护</strong>成员。</li>
<li>私有继承（<strong>private</strong>）：当一个类派生自<strong>私有</strong>基类时，基类的<strong>公有</strong>和<strong>保护</strong>成员将成为派生类的<strong>私有</strong>成员。</li>
</ul>
<h4 id="多继承"><a href="#多继承" class="headerlink" title="多继承"></a>多继承</h4><p>多继承即一个子类可以有多个父类，它继承了多个父类的特性。<br>语法如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> &lt;派生类名&gt;:</span>&lt;继承方式<span class="number">1</span>&gt;&lt;基类名<span class="number">1</span>&gt;,&lt;继承方式<span class="number">2</span>&gt;&lt;基类名<span class="number">2</span>&gt;,…</span><br><span class="line">&#123;</span><br><span class="line">&lt;派生类类体&gt;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span>:</span> <span class="keyword">public</span> Shape, <span class="keyword">public</span> PaintCost&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="函数重载"><a href="#函数重载" class="headerlink" title="函数重载"></a>函数重载</h4><p>当您调用一个重载函数或重载运算符时，编译器通过把您所使用的参数类型与定义中的参数类型进行比较，决定选用最合适的定义。选择最合适的重载函数或重载运算符的过程，称为重载决策。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Rectangle::print(<span class="keyword">int</span> intValue) &#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"int value: "</span> &lt;&lt; intValue &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Rectangle::print(<span class="keyword">int</span> *intValue) &#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"*int value: "</span> &lt;&lt; *intValue &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Rectangle::print(<span class="keyword">double</span> doubleValue) &#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"double value: "</span> &lt;&lt; doubleValue &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Rectangle::print(<span class="keyword">const</span> <span class="keyword">char</span> *c) &#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"char values: "</span> &lt;&lt; c &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rect.print(<span class="number">3</span>);</span><br><span class="line">rect.print(<span class="number">3.3</span>);</span><br><span class="line"><span class="keyword">int</span> intValue = <span class="number">300</span>;</span><br><span class="line">rect.print(&amp;intValue);</span><br><span class="line">rect.print(<span class="string">"hello print string."</span>);</span><br></pre></td></tr></table></figure>
<h4 id="运算符重载"><a href="#运算符重载" class="headerlink" title="运算符重载"></a>运算符重载</h4><p>可以重定义或重载大部分 C++ 内置的运算符。这样，您就能使用自定义类型的运算符。</p>
<p>重载的运算符是带有特殊名称的函数，函数名是由关键字 operator 和其后要重载的运算符符号构成的。与其他函数一样，重载运算符有一个返回类型和一个参数列表。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Box <span class="keyword">operator</span>+(<span class="keyword">const</span> Box&amp;);</span><br></pre></td></tr></table></figure>
<p>声明加法运算符用于把两个 Box 对象相加，返回最终的 Box 对象。</p>
<p>大多数的重载运算符可被定义为普通的非成员函数或者被定义为类成员函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Box <span class="keyword">operator</span>+(<span class="keyword">const</span> Box&amp;, <span class="keyword">const</span> Box&amp;);</span><br><span class="line"></span><br><span class="line">Box Box::<span class="keyword">operator</span>+(Box &amp;b) &#123;</span><br><span class="line">    Box resultBox;</span><br><span class="line">    resultBox.width = <span class="keyword">this</span>-&gt;width + b.width;</span><br><span class="line">    resultBox.height = <span class="keyword">this</span>-&gt;height + b.height;</span><br><span class="line">    resultBox.breadth = <span class="keyword">this</span>-&gt;breadth + b.breadth;</span><br><span class="line">    resultBox.length = <span class="keyword">this</span>-&gt;length + b.length;</span><br><span class="line">    <span class="keyword">return</span> resultBox;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="可重载运算符"><a href="#可重载运算符" class="headerlink" title="可重载运算符"></a>可重载运算符</h5><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>+</td>
<td>-</td>
<td>*</td>
<td>/</td>
<td>%</td>
<td>^</td>
</tr>
<tr>
<td>&amp;</td>
<td>\</td>
<td></td>
<td>~</td>
<td>!</td>
<td>,</td>
<td>=</td>
</tr>
<tr>
<td>&lt;</td>
<td>&gt;</td>
<td>&lt;=</td>
<td>&gt;=</td>
<td>++</td>
<td>–</td>
</tr>
<tr>
<td>&lt;&lt;</td>
<td>&gt;&gt;</td>
<td>==</td>
<td>!=</td>
<td>&amp;&amp;</td>
<td>\</td>
<td>\</td>
<td></td>
</tr>
<tr>
<td>+=</td>
<td>-=</td>
<td>/=</td>
<td>%=</td>
<td>^=</td>
<td>&amp;=</td>
</tr>
<tr>
<td>\</td>
<td></td>
<td>=</td>
<td>*=</td>
<td>&lt;&lt;=</td>
<td>&gt;&gt;=</td>
<td>[]</td>
<td>()</td>
</tr>
<tr>
<td>-&gt;</td>
<td>-&gt;*</td>
<td>new</td>
<td>new []</td>
<td>delete</td>
<td>delete []</td>
</tr>
</tbody>
</table>
<h5 id="不可重载运算符"><a href="#不可重载运算符" class="headerlink" title="不可重载运算符"></a>不可重载运算符</h5><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>::</td>
<td>.*</td>
<td>.</td>
<td>?:</td>
</tr>
</tbody>
</table>
<p>运算符重载实例: <a href="http://www.runoob.com/cplusplus/cpp-overloading.html" target="_blank" rel="noopener">http://www.runoob.com/cplusplus/cpp-overloading.html</a></p>
<h4 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in Shape class</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">getArea</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// in Rectangle class</span></span><br><span class="line"><span class="keyword">int</span> Rectangle::getArea() &#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Rectangle::getArea()"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> width * height;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// in Triangle class</span></span><br><span class="line"><span class="keyword">int</span> Triangle::getArea() &#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Triangle::getArea()"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> width * height;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Shape *shapePtr;</span><br><span class="line">shapePtr = &amp;rect;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"&amp;rect pointer-&gt;getArea(): "</span> &lt;&lt; shapePtr-&gt;getArea() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="function">Triangle <span class="title">triangle</span><span class="params">(<span class="number">3</span>, <span class="number">4</span>)</span></span>;</span><br><span class="line">shapePtr = &amp;triangle;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"&amp;triangle pointer-&gt;getArea(): "</span> &lt;&lt; shapePtr-&gt;getArea() &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// out put</span><br><span class="line">&amp;rect pointer-&gt;getArea(): Rectangle::getArea()</span><br><span class="line">&amp;triangle pointer-&gt;getArea(): Triangle::getArea()</span><br></pre></td></tr></table></figure>
<p>调用函数 area() 被编译器设置为基类中的版本，这就是所谓的<strong>静态多态</strong>，或<strong>静态链接</strong> - 函数调用在程序执行前就准备好了。有时候这也被称为<strong>早绑定</strong>，因为 area() 函数在程序编译期间就已经设置好了。</p>
<p>放置关键字<strong>virtual</strong>后，编译器看的是指针的内容，而不是它的类型。</p>
<h4 id="虚函数"><a href="#虚函数" class="headerlink" title="虚函数"></a>虚函数</h4><p><strong>虚函数</strong> 是在基类中使用关键字 virtual 声明的函数。在派生类中重新定义基类中定义的虚函数时，会告诉编译器不要静态链接到该函数。</p>
<p>我们想要的是在程序中任意点可以根据所调用的对象类型来选择调用的函数，这种操作被称为<strong>动态链接</strong>，或<strong>后期绑定</strong>。</p>
<h4 id="纯虚函数"><a href="#纯虚函数" class="headerlink" title="纯虚函数"></a>纯虚函数</h4><p>您可能想要在基类中定义虚函数，以便在派生类中重新定义该函数更好地适用于对象，但是您在基类中又不能对虚函数给出有意义的实现，这个时候就会用到纯虚函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pure virtual function</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">area</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><strong>= 0</strong> 告诉编译器，函数没有主体，上面的虚函数是纯虚函数。</p>
<h4 id="文件和流"><a href="#文件和流" class="headerlink" title="文件和流"></a>文件和流</h4><table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>ofstream</td>
<td>该数据类型表示输出文件流，用于创建文件并向文件写入信息。</td>
</tr>
<tr>
<td>ifstream</td>
<td>该数据类型表示输入文件流，用于从文件读取信息。</td>
</tr>
<tr>
<td>fstream</td>
<td>该数据类型通常表示文件流，且同时具有 ofstream 和 ifstream 两种功能，这意味着它可以创建文件，向文件写入信息，从文件读取信息。</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>模式标志</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>ios::app</td>
<td>追加模式。所有写入都追加到文件末尾。</td>
</tr>
<tr>
<td>ios::ate</td>
<td>文件打开后定位到文件末尾。</td>
</tr>
<tr>
<td>ios::in</td>
<td>打开文件用于读取。</td>
</tr>
<tr>
<td>ios::out</td>
<td>打开文件用于写入。</td>
</tr>
<tr>
<td>ios::trunc</td>
<td>如果该文件已经存在，其内容将在打开文件之前被截断，即把文件长度设为 0。</td>
</tr>
</tbody>
</table>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *filePath = <span class="string">"/Users/wangjie/work/cpp/HelloCpp/com.wangjie.cpptest/file_temp"</span>;</span><br><span class="line">ofstream outfile;</span><br><span class="line">outfile.open(filePath, ios::trunc);</span><br><span class="line">outfile &lt;&lt; <span class="string">"temp"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">outfile.close();</span><br><span class="line"></span><br><span class="line">ifstream infile;</span><br><span class="line">infile.open(filePath);</span><br><span class="line"><span class="keyword">char</span> data[<span class="number">100</span>];</span><br><span class="line">infile &gt;&gt; data;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; data &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">infile.close();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定位到 fileObject 的第 n 个字节（假设是 ios::beg）</span></span><br><span class="line">fileObject.seekg( n );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把文件的读指针从 fileObject 当前位置向后移 n 个字节</span></span><br><span class="line">fileObject.seekg( n, ios::cur );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把文件的读指针从 fileObject 末尾往回移 n 个字节</span></span><br><span class="line">fileObject.seekg( n, ios::end );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定位到 fileObject 的末尾</span></span><br><span class="line">fileObject.seekg( <span class="number">0</span>, ios::end );</span><br></pre></td></tr></table></figure>
<h4 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h4><p>抛出异常:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">division</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">if</span>( b == <span class="number">0</span> )</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="string">"Division by zero condition!"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> (a/b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>C++ 提供了一系列标准的异常，定义在 <exception> 中。</exception></p>
<p>定义新的异常：</p>
<table>
<thead>
<tr>
<th>异常</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>std::exception</td>
<td>该异常是所有标准 C++ 异常的父类。</td>
</tr>
<tr>
<td>std::bad_alloc</td>
<td>该异常可以通过 new 抛出。</td>
</tr>
<tr>
<td>std::bad_cast</td>
<td>该异常可以通过 dynamic_cast 抛出。</td>
</tr>
<tr>
<td>std::bad_exception</td>
<td>这在处理 C++ 程序中无法预期的异常时非常有用。</td>
</tr>
<tr>
<td>std::bad_typeid</td>
<td>该异常可以通过 typeid 抛出。</td>
</tr>
<tr>
<td>std::logic_error</td>
<td>理论上可以通过读取代码来检测到的异常。</td>
</tr>
<tr>
<td>std::domain_error</td>
<td>当使用了一个无效的数学域时，会抛出该异常。</td>
</tr>
<tr>
<td>std::invalid_argument</td>
<td>当使用了无效的参数时，会抛出该异常。</td>
</tr>
<tr>
<td>std::length_error</td>
<td>当创建了太长的 std::string 时，会抛出该异常。</td>
</tr>
<tr>
<td>std::out_of_range</td>
<td>该异常可以通过方法抛出，例如 std::vector 和 std::bitset&lt;&gt;::operator[]()。</td>
</tr>
<tr>
<td>std::runtime_error</td>
<td>理论上不可以通过读取代码来检测到的异常。</td>
</tr>
<tr>
<td>std::overflow_error</td>
<td>当发生数学上溢时，会抛出该异常。</td>
</tr>
<tr>
<td>std::range_error</td>
<td>当尝试存储超出范围的值时，会抛出该异常。</td>
</tr>
<tr>
<td>std::underflow_error</td>
<td>当发生数学下溢时，会抛出该异常。</td>
</tr>
</tbody>
</table>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;exception&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MyException</span> :</span> <span class="keyword">public</span> exception</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="keyword">char</span> * <span class="title">what</span> <span class="params">()</span> <span class="keyword">const</span> <span class="title">throw</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"C++ Exception"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">throw</span> MyException();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span>(MyException&amp; e)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"MyException caught"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; e.what() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span>(<span class="built_in">std</span>::exception&amp; e)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//其他的错误</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="动态内存"><a href="#动态内存" class="headerlink" title="动态内存"></a>动态内存</h4><p>内存分为两个部分：</p>
<ul>
<li>栈：在函数内部声明的所有变量都将占用栈内存。</li>
<li>堆：这是程序中未使用的内存，在程序运行时可用于动态分配内存。</li>
</ul>
<p>很多时候，您无法提前预知需要多少内存来存储某个定义变量中的特定信息，所需内存的大小需要在运行时才能确定。<br>在 C++ 中，您可以使用特殊的运算符为给定类型的变量在运行时分配堆内的内存，这会返回所分配的空间地址。这种运算符即 <strong>new</strong> 运算符。</p>
<p>如果您不需要动态分配内存，可以使用 <strong>delete</strong> 运算符，删除之前由 new 运算符分配的内存。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span>* pvalue  = <span class="literal">NULL</span>; <span class="comment">// 初始化为 null 的指针</span></span><br><span class="line">pvalue  = <span class="keyword">new</span> <span class="keyword">double</span>;   <span class="comment">// 为变量请求内存</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span>* pvalue  = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span>( !(pvalue  = <span class="keyword">new</span> <span class="keyword">double</span> ))</span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">cout</span> &lt;&lt; <span class="string">"Error: out of memory."</span> &lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">   <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// new 与 malloc() 函数相比，其主要的优点是，new 不只是分配了内存，它还创建了对象。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> pvalue; <span class="comment">// 释放 pvalue 所指向的内存</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* pvalue  = <span class="literal">NULL</span>;   <span class="comment">// 初始化为 null 的指针</span></span><br><span class="line">pvalue  = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">20</span>]; <span class="comment">// 为变量请求内存</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> [] pvalue;        <span class="comment">// 删除 pvalue 所指向的数组</span></span><br></pre></td></tr></table></figure>
<h4 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h4><p>定义命名空间:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> namespace_name &#123;</span><br><span class="line">   <span class="comment">// 代码声明</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> first_space &#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"Inside first_space"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> second_space &#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"Inside second_space"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">first_space::func();</span><br><span class="line">second_space::func();</span><br></pre></td></tr></table></figure>
<p>可以使用 using namespace 指令，这样在使用命名空间时就可以不用在前面加上命名空间的名称。</p>
<p>using 指令也可以用来指定命名空间中的特定项目。例如，如果您只打算使用 std 命名空间中的 cout 部分，您可以使用如下的语句：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cout</span>;</span><br></pre></td></tr></table></figure>
<h4 id="不连续的命名空间"><a href="#不连续的命名空间" class="headerlink" title="不连续的命名空间"></a>不连续的命名空间</h4><p>命名空间可以定义在几个不同的部分中，因此命名空间是由几个单独定义的部分组成的。一个命名空间的各个组成部分可以分散在多个文件中。</p>
<p>下面的命名空间定义可以是定义一个新的命名空间，也可以是为已有的命名空间增加新的元素：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> namespace_name &#123;</span><br><span class="line">   <span class="comment">// 代码声明</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="函数模板"><a href="#函数模板" class="headerlink" title="函数模板"></a>函数模板</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> T <span class="keyword">const</span>&amp; <span class="title">maxTemplate</span><span class="params">(T <span class="keyword">const</span>&amp; a, T <span class="keyword">const</span>&amp; b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a &lt; b ? b : a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"maxTemplate(1, 2): "</span> &lt;&lt; maxTemplate(<span class="number">1</span>, <span class="number">2</span>) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"maxTemplate(1.0, 2.0): "</span> &lt;&lt; maxTemplate(<span class="number">1.0</span>, <span class="number">2.0</span>) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"maxTemplate(\"a\", \"b\"): "</span> &lt;&lt; maxTemplate(<span class="string">"a"</span>, <span class="string">"b"</span>) &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<h4 id="类模板"><a href="#类模板" class="headerlink" title="类模板"></a>类模板</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">type</span>&gt; <span class="title">class</span> <span class="title">class</span>-<span class="title">name</span> &#123;</span></span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="预处理器"><a href="#预处理器" class="headerlink" title="预处理器"></a>预处理器</h4><p>预处理器是一些指令，指示编译器在实际编译之前所需完成的预处理。<br>所有的预处理器指令都是以井号（#）开头，只有空格字符可以出现在预处理指令之前。预处理指令不是 C++ 语句，所以它们不会以分号（;）结尾。<br>我们已经看到，之前所有的实例中都有 #include 指令。这个宏用于把头文件包含到源文件中。</p>
<p>C++ 还支持很多预处理指令，比如 #include、#define、#if、#else、#line 等，让我们一起看看这些重要指令。</p>
<h5 id="define-预处理"><a href="#define-预处理" class="headerlink" title="#define 预处理"></a>#define 预处理</h5><p>#define 预处理指令用于创建符号常量。该符号常量通常称为宏，指令的一般形式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define macro-name replacement-text</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PI 3.14159</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Value of PI :"</span> &lt;&lt; PI &lt;&lt; <span class="built_in">endl</span>; </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN(a, b) (a &lt; b ? a : b)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; <span class="string">"#MIN(1, 2): "</span> &lt;&lt; MIN(<span class="number">1</span>, <span class="number">2</span>) &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<p>条件编译: <a href="http://www.runoob.com/cplusplus/cpp-preprocessor.html" target="_blank" rel="noopener">http://www.runoob.com/cplusplus/cpp-preprocessor.html</a></p>
<h3 id="信号处理"><a href="#信号处理" class="headerlink" title="信号处理"></a>信号处理</h3><p>信号是由操作系统传给进程的中断，会提早终止一个程序。在 UNIX、LINUX、Mac OS X 或 Windows 系统上，可以通过按 Ctrl+C 产生中断。</p>
<p>有些信号不能被程序捕获，但是下表所列信号可以在程序中捕获，并可以基于信号采取适当的动作。这些信号是定义在 C++ 头文件 <csignal> 中。</csignal></p>
<table>
<thead>
<tr>
<th>信号</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>SIGABRT</td>
<td>程序的异常终止，如调用 abort。</td>
</tr>
<tr>
<td>SIGFPE</td>
<td>错误的算术运算，比如除以零或导致溢出的操作。</td>
</tr>
<tr>
<td>SIGILL</td>
<td>检测非法指令。</td>
</tr>
<tr>
<td>SIGINT</td>
<td>接收到交互注意信号。</td>
</tr>
<tr>
<td>SIGSEGV</td>
<td>非法访问内存。</td>
</tr>
<tr>
<td>SIGTERM</td>
<td>发送到程序的终止请求。</td>
</tr>
</tbody>
</table>
<h4 id="signal-函数"><a href="#signal-函数" class="headerlink" title="signal() 函数"></a>signal() 函数</h4><p>用来捕获突发事件。以下是 signal() 函数的语法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (*signal (<span class="keyword">int</span> sig, <span class="keyword">void</span> (*func)(<span class="keyword">int</span>)))(<span class="keyword">int</span>);</span><br></pre></td></tr></table></figure>
<p>这个函数接收两个参数：第一个参数是一个整数，代表了信号的编号；第二个参数是一个指向信号处理函数的指针。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">signalHandler</span><span class="params">( <span class="keyword">int</span> signum )</span></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Interrupt signal ("</span> &lt;&lt; signum &lt;&lt; <span class="string">") received.\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理并关闭</span></span><br><span class="line">    <span class="comment">// 终止程序  </span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">exit</span>(signum);  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 注册信号 SIGINT 和信号处理程序</span></span><br><span class="line">    signal(SIGINT, signalHandler);  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">       <span class="built_in">cout</span> &lt;&lt; <span class="string">"Going to sleep...."</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">       sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Going to sleep....</span><br><span class="line">Going to sleep....</span><br><span class="line">Going to sleep....</span><br><span class="line">[按 Ctrl+C 来中断程序]</span><br><span class="line">Interrupt signal (2) received.</span><br></pre></td></tr></table></figure>
<h4 id="raise-函数"><a href="#raise-函数" class="headerlink" title="raise() 函数"></a>raise() 函数</h4><p>可以使用函数 raise() 生成信号，该函数带有一个整数信号编号作为参数，语法如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">raise</span> <span class="params">(signal sig)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在这里，sig 是要发送的信号的编号，这些信号包括：SIGINT、SIGABRT、SIGFPE、SIGILL、SIGSEGV、SIGTERM、SIGHUP。以下是我们使用 raise() 函数内部生成信号的实例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">signalHandler</span><span class="params">( <span class="keyword">int</span> signum )</span></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Interrupt signal ("</span> &lt;&lt; signum &lt;&lt; <span class="string">") received.\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理并关闭</span></span><br><span class="line">    <span class="comment">// 终止程序 </span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">exit</span>(signum);  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 注册信号 SIGINT 和信号处理程序</span></span><br><span class="line">    signal(SIGINT, signalHandler);  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(++i)&#123;</span><br><span class="line">       <span class="built_in">cout</span> &lt;&lt; <span class="string">"Going to sleep...."</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">       <span class="keyword">if</span>( i == <span class="number">3</span> )&#123;</span><br><span class="line">          raise( SIGINT);</span><br><span class="line">       &#125;</span><br><span class="line">       sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Going to sleep....</span><br><span class="line">Going to sleep....</span><br><span class="line">Going to sleep....</span><br><span class="line">Interrupt signal (2) received.</span><br></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> cpp </tag>
            
            <tag> c++ </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]使用RecyclerView替代ListView（四：SeizeRecyclerView）]]></title>
      <url>/2017/03/29/Android-%E4%BD%BF%E7%94%A8RecyclerView%E6%9B%BF%E4%BB%A3ListView%EF%BC%88%E5%9B%9B%EF%BC%9ASeizeRecyclerView%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="Android-使用RecyclerView替代ListView（四：SeizeRecyclerView）"><a href="#Android-使用RecyclerView替代ListView（四：SeizeRecyclerView）" class="headerlink" title="[Android]使用RecyclerView替代ListView（四：SeizeRecyclerView）"></a>[Android]使用RecyclerView替代ListView（四：SeizeRecyclerView）</h1><p>在RecyclerView的开发过程中，可能会遇到一些窘境，比如，下图是今日头条的视频详情页面：</p>
<a id="more"></a>
<p><img src="http://images2015.cnblogs.com/blog/378300/201703/378300-20170329202135217-815673664.png" alt=""> <img src="http://images2015.cnblogs.com/blog/378300/201703/378300-20170329202140514-614081911.png" alt=""></p>
<p>除去播放器外，其它组件应该是一个RecyclerView，但是这个RecyclerView中的item有两种类型：</p>
<ul>
<li><p>一种是上部的推荐视频</p>
</li>
<li><p>一种是下面的评论</p>
</li>
</ul>
<p>问题在于两类数据的最下面都有一个组件用于进行更多数据的加载，加载完毕后插入对应的position。</p>
<p>这里实现的方式应该怎么做呢？方法有很多，比如：</p>
<ul>
<li><p>所有数据放在一个List中，保存加载更多的index，点击加载更多的index的时候触发请求返回后把推荐更多数据插入对应的index中并更新index，评论也是一样。。</p>
</li>
<li><p>推荐视频和评论保存在两个不同的List中，在Adapter中维护两份数据，重写<code>getItemCount()</code>等方法。</p>
</li>
<li><p>…</p>
</li>
</ul>
<p>但是这些方法在以后业务的扩展和灵活性等方面都不值得提倡。因为就算是以后的业务只是想把推荐视频和评论两大块互换位置（虽然这个业务场景可能性不大）都是一个不小的工作量。</p>
<p>原因在于，默认情况下一个<code>RecyclerView</code>只会有一个<code>Adapter</code>来进行数据的适配，这样的话，如果数据分成了几个块（推荐视频和评论），单个<code>Adapter</code>的控制能力就很有限了。</p>
<p>设想一下，如果一个<code>RecyclerView</code>可以有很多个<code>Adapter</code>来进行数据的适配的话，那问题是不是迎刃而解了？</p>
<p><code>RecyclerView</code>中有<code>RecommendAdapter</code>和<code>CommentAdapter</code>，<code>RecommendAdapter</code>中维护一个<code>List&lt;Recommend&gt;</code>数据集，<code>CommentAdapter</code>中维护了一个<code>List&lt;Comment&gt;</code>数据集，每个<code>Adapter</code>中可以设置<code>Header</code>和<code>Footer</code>，把加载更多的组件作为一个<code>Footer</code>加在<code>RecommendAdapter</code>和<code>CommentAdapter</code>中，然后响应点击事件，请求到数据之后<code>recommendAdapter.addList(List&lt;Recommend&gt;)</code>加入到推荐视频的数据集中，然后<code>recommendAdapter.notifyDataSetChanged()</code>，评论的数据加载也是如此。</p>
<p>于是根据这个思想，<strong><a href="https://github.com/wangjiegulu/SeizeRecyclerView" target="_blank" rel="noopener">SeizeRecyclerView</a></strong> 编写完成，下面以电影详情为例，界面与上面的视频详情一样，整个<code>RecyclreView</code>被分为两个部分：<strong>演员区域(Actor)</strong>和<strong>评论区域(Comment)</strong>。</p>
<p>使用方式如下：</p>
<p>引入 <strong><a href="https://github.com/wangjiegulu/SeizeRecyclerView" target="_blank" rel="noopener">SeizeRecyclerView</a> 库：<a href="https://github.com/wangjiegulu/SeizeRecyclerView" target="_blank" rel="noopener">https://github.com/wangjiegulu/SeizeRecyclerView</a></strong>，后续会上传到Maven中心库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">feedRv = (RecyclerView) findViewById(R.id.activity_main_rv);</span><br><span class="line"></span><br><span class="line"><span class="comment">// RecyclerView真正的Adapter</span></span><br><span class="line">adapter = <span class="keyword">new</span> FeedAdapter();</span><br><span class="line"><span class="comment">// 为真正的Adapter增加Header和Footer</span></span><br><span class="line">adapter.setHeader(headerView = inflaterHeaderOrFooterAndBindClick(R.layout.header_film));</span><br><span class="line">adapter.setFooter(footerView = inflaterHeaderOrFooterAndBindClick(R.layout.footer_film));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为真正的Adapter绑定各种seizeAdapter，这里的顺序决定了UI上显示的顺序</span></span><br><span class="line">adapter.setSeizeAdapters(</span><br><span class="line">        filmActorSeizeAdapter = <span class="keyword">new</span> FilmActorSeizeAdapter(),</span><br><span class="line">        filmCommentSeizeAdapter = <span class="keyword">new</span> FilmCommentSeizeAdapter()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置演员seize adapter的 header 和 footer</span></span><br><span class="line">filmActorSeizeAdapter.setHeader(actorHeaderView = inflaterHeaderOrFooterAndBindClick(R.layout.header_film_actor));</span><br><span class="line">filmActorSeizeAdapter.setFooter(actorFooterView = inflaterHeaderOrFooterAndBindClick(R.layout.footer_film_actor));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置评论seize adapter的 header 和 footer</span></span><br><span class="line">filmCommentSeizeAdapter.setHeader(commentHeaderView = inflaterHeaderOrFooterAndBindClick(R.layout.header_film_comment));</span><br><span class="line">filmCommentSeizeAdapter.setFooter(commentFooterView = inflaterHeaderOrFooterAndBindClick(R.layout.footer_film_comment));</span><br><span class="line"></span><br><span class="line">LinearLayoutManager layoutManager = <span class="keyword">new</span> LinearLayoutManager(<span class="keyword">this</span>);</span><br><span class="line">layoutManager.setOrientation(LinearLayoutManager.VERTICAL);</span><br><span class="line">feedRv.setLayoutManager(layoutManager);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为RecyclerView设置真正的adapter</span></span><br><span class="line">feedRv.setAdapter(adapter);</span><br></pre></td></tr></table></figure>
<p>以上是RecylerView的初始化，并为<code>Adapter</code>添加两个<code>SeizeAdapter</code>（<code>FilmActorSeizeAdapter</code>和<code>FilmCommentSeizeAdapter</code>）。</p>
<p>请求完数据之后直接使用<code>SeizeAdapter</code>进行数据的填充和<code>notifyDataSetChanged</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestActors</span><span class="params">(List&lt;ActorVM&gt; list)</span> </span>&#123;</span><br><span class="line">    filmActorSeizeAdapter.addList(list);</span><br><span class="line">    filmActorSeizeAdapter.notifyDataSetChanged();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestComment</span><span class="params">(List&lt;CommentVM&gt; list)</span> </span>&#123;</span><br><span class="line">    filmCommentSeizeAdapter.addList(list);</span><br><span class="line">    filmCommentSeizeAdapter.notifyDataSetChanged();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后续会增加 <a href="https://github.com/wangjiegulu/SeizeRecyclerView" target="_blank" rel="noopener">SeizeRecyclerView</a> 详细的使用说明。</p>
<p>最后效果如下：</p>
<p><img src="https://github.com/wangjiegulu/SeizeRecyclerView/raw/master/screenshot/basic.gif" alt=""> <img src="https://github.com/wangjiegulu/SeizeRecyclerView/raw/master/screenshot/multi_type.gif" alt=""></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ListView </tag>
            
            <tag> best practices </tag>
            
            <tag> RecyclerView </tag>
            
            <tag> SeizeRecyclerView </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Lottie简介（翻译）]]></title>
      <url>/2017/02/04/Lottie%E7%AE%80%E4%BB%8B%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="Lottie简介（翻译）"><a href="#Lottie简介（翻译）" class="headerlink" title="Lottie简介（翻译）"></a>Lottie简介（翻译）</h1><blockquote>
<p>原文：<a href="https://medium.com/airbnb-engineering/introducing-lottie-4ff4a0afac0e#.mfnxbtt06" target="_blank" rel="noopener">https://medium.com/airbnb-engineering/introducing-lottie-4ff4a0afac0e#.mfnxbtt06</a></p>
<p>新的向本地apps的构建动画的开源工具。</p>
</blockquote>
<p>作者：<a href="http://github.com/buba447" target="_blank" rel="noopener">Brandon Withrow</a>, <a href="https://twitter.com/gpeal8" target="_blank" rel="noopener">Gabridl Peal</a>, <a href="https://twitter.com/intelligibabble" target="_blank" rel="noopener">Leland Richardson</a> 和 <a href="https://twitter.com/therealsalih?lang=en" target="_blank" rel="noopener">Salih AbdulKarim</a></p>
<p>在以前，在Android，iOS和React Native app上面构建复杂的动画是困难和冗长的过程。你要么不得不为每个尺寸增加大量的图片文件，要么干脆编写数千行不可维护的代码。正因为如此，大多的apps并没有使用动画——尽管这是一个交流想法和创建引人注目的用户体验的强大的工具。一年前，我们就开始改变。</p>
<a id="more"></a>
<p>今天，我们很高兴来介绍我们的解决方案。<a href="http://airbnb.design/lottie/" target="_blank" rel="noopener">Lottie</a>是一个iOS，Android和React Native库，可以实时渲染After Effects动画，并且允许本地app像静态资源那样轻松地使用动画。Lottie使用名为<a href="https://github.com/bodymovin/bodymovin" target="_blank" rel="noopener">Bodymovin</a>的开源After Effects的扩展程序导出的JSON文件格式的动画数据。扩展程序与JavaScript player捆绑在一起，可以在web上渲染动画。自从2015年2月开始，Bodymovin的创建者，<a href="https://twitter.com/airnanan" target="_blank" rel="noopener">Hernan Torrisi</a>通过每月为插件添加和改进功能，打造了坚实的基础。我们的团队（<a href="http://github.com/buba447" target="_blank" rel="noopener">Brandon Withrow</a> 在 <a href="https://github.com/airbnb/lottie-ios" target="_blank" rel="noopener">iOS</a>, <a href="https://twitter.com/gpeal8" target="_blank" rel="noopener">Gabriel Peal</a> 在 <a href="https://github.com/airbnb/lottie-android" target="_blank" rel="noopener">Android</a>，<a href="https://twitter.com/intelligibabble" target="_blank" rel="noopener">Leland Richardson</a> 在 <a href="https://github.com/airbnb/lottie-react-native" target="_blank" rel="noopener">React Native</a>，和 <a href="http://www.salih.tv/" target="_blank" rel="noopener">我</a> 在体验设计上）在Torrisi的非凡的工作之上开始我们的旅程。</p>
<p><img src="https://github.com/airbnb/lottie-android/raw/master/gifs/Example1.gif" alt=""></p>
<h2 id="轻松地构建一个丰富的动画"><a href="#轻松地构建一个丰富的动画" class="headerlink" title="轻松地构建一个丰富的动画"></a>轻松地构建一个丰富的动画</h2><p>Lottie允许工程师构建一个丰富的动画，而没有艰苦地重写它们的开销。Nick Butcher’s的<a href="https://medium.com/google-developers/animation-jump-through-861f4f5b3de4#.xlw1n2u2d" target="_blank" rel="noopener">跳跃</a>动画,Bartek Lipinski的<a href="https://android.jlelse.eu/animatedvectordrawablecompat-3d9568727c53#.fmiujhcdj" target="_blank" rel="noopener">汉堡菜单</a>, 和Miroslaw Stanek 的<a href="http://frogermcs.github.io/twitters-like-animation-in-android-alternative/" target="_blank" rel="noopener">Twitter爱心</a>, 演示它们是多么困难和耗时，它可以用scratch重建动画。使用Lottie，挖掘参考框架，猜测持续时间，手动创建贝赛尔曲线，并重新制作只有一个GIF作为参考的动画将是过去了。现在工程师可以准确地实现设计者的意图，究竟是怎么做的。为了证明它，我们重创建了它们的动画，然后在我们的每个例子中提供了After Effects和JSON文件。</p>
<p>我们的目标是尽可能多地支持After Effects的特性，而不只是简单的图标动画。我们创建了一些其他例子来展示库的灵活性，丰富性和深入的功能集。在例子app中，有用于各种不同种类的动画的源文件，包括基本线条艺术，基于字符的动画，以及具有多个角度和切割的动态logo动画。</p>
<p><img src="https://github.com/airbnb/lottie-android/raw/master/gifs/Example2.gif" alt=""></p>
<p>我们已经开始在一些界面上使用我们自己的Lottie动画，包括应用内通知，全帧动画插图和在我们的审查流程中。我们计划以一种有趣而有用的方式大大增加我们对动画的使用。</p>
<p><img src="https://github.com/airbnb/lottie-android/raw/master/gifs/Example3.gif" alt=""></p>
<h2 id="灵活高效的解决方案"><a href="#灵活高效的解决方案" class="headerlink" title="灵活高效的解决方案"></a>灵活高效的解决方案</h2><p>Airbnb是一个全球的公司，它支持数百万的顾客和主人，所有在多个平台上播放的灵活动画格式对我们来说是非常重要的。有一些与Lottie类似的库，如Marcus Eckert的<a href="http://www.marcuseckert.com/squall/" target="_blank" rel="noopener">Squall</a>和Facebook的<a href="https://github.com/facebookincubator/Keyframes" target="_blank" rel="noopener">Keyframes</a>,但是我们的目标略有不同。Facebook选择了一小部分After Effects的特性进行了支持，因为它们主要集中在响应，但是我们想要尽可能多地支持。至于Squall，Airbnb的设计师组合Lottie来使用它，因为它有一个惊艳的After Effects预览app，这使得它成为我们工作流必要的一部分。然而，它只支持iOS，我们的工程师团队需要一个跨平台的解决方案。</p>
<p>Lottie还在其API中内置了几个功能，使它更多样化和高效。它支持通过网络加载JSON文件，这在A/B测试是非常有用。它还有一个额外的缓存机制，所以频繁使用的动画，比如一个愿望清单的爱心，可以每次加载一个缓存的副本。Lottie动画可以通过使用动画进度功能的手势驱动，并且动画速度可以通过简单改变值来控制。iOS甚至支持在运行时增加额外的本地UI到一个动画中，这可以用于复杂的动画过渡。</p>
<p>除了我们迄今为止的增加所有After Effects特性和API之外，我们还有许多未来的想法。它们包括映射视图到Lottie动画中，使用Lottie控制视图过渡，支持<a href="http://www.battleaxe.co/rubberhose/" target="_blank" rel="noopener">Battle Axe 的 RubberHose</a>，渐变，类型和图像的支持。最难的部分是下一个特性支持应该选择哪一个。</p>
<p><img src="https://cdn-images-1.medium.com/max/2000/1*bZbrDT3NGJDw8LoIy3L3mQ.png" alt=""></p>
<h2 id="构建社区"><a href="#构建社区" class="headerlink" title="构建社区"></a>构建社区</h2><p>作为开源发布一些东西，并不只是把它拿出来做为公共使用。它是一个人跟人之间连接和交流的桥梁。随着我们更接近通过GitHub向设计师和工程师发布Lottie，我们也想确保与动画人员进行连接。</p>
<p>我们受到了创建的<a href="http://9-squares.tumblr.com/" target="_blank" rel="noopener">9 Squares</a>，<a href="https://motioncorpse.tumblr.com/" target="_blank" rel="noopener">Motion Corpse</a>和<a href="https://animography.net/products/mobilo" target="_blank" rel="noopener">Animography</a>的启发。所有这三个都聚集了来自世界各地的人，在公共动画项目上合作，他们可能永远不会一起工作。这些项目花费了几个月的工作和很多的组织，各自团队的争论，但是它们无疑对整个动画社区提供了巨大的价值。Motion Corpse 和 Animography 公开分享了After Effects的源文件，它们提供了大量人们怎么工作的深刻的见解。</p>
<p>在他们的合作领导下，我们接触了所有这三个团队，为我们的示例app贡献了动画。我们包括了一个来自 Motion Corpse J.R Canest 创建的动画，来自9 Squares 项目的 Al Boardman 的square之一，和一个使用Animography的Mobilo动画字体的键盘动画，其中有二十多个艺术家的工作。我们希望这些动画社区与强大的工程社区的合并将产生一些特别的东西。</p>
<p><img src="https://github.com/airbnb/lottie-android/raw/master/gifs/Community%202_3.gif" alt=""></p>
<blockquote>
<p>从左到右：Motion Corpse 的 Jr.canest，来自 9 Squares 的 AI Boardman，Animography 的 Mobilo 字体动画</p>
</blockquote>
<p>我们想听到你怎么去使用Lottie——不论你是一个设计师，动画师，还是工程师。请随时直接通过 lottie@airbnb.com 带着你的想法，反馈，见解与我们联系。我们很高兴看到当他们开始以我们从未想象的方式使用Lottie时，世界各地的社区将会做些什么。</p>
<p>下载 <a href="https://github.com/bodymovin/bodymovin" target="_blank" rel="noopener">Bodymovin</a>，Lottie <a href="https://github.com/airbnb/lottie-ios" target="_blank" rel="noopener">iOS</a>，<a href="https://github.com/airbnb/lottie-android" target="_blank" rel="noopener">Android</a> 和 <a href="https://github.com/airbnb/lottie-react-native" target="_blank" rel="noopener">React Native</a></p>
<p>最初发布于 <a href="http://airbnb.design/lottie/" target="_blank" rel="noopener">airbnb.design/lottie/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> animation </tag>
            
            <tag> animator </tag>
            
            <tag> lottie </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[在Dagger 2中Activities和Subcomponents的多绑定（翻译）]]></title>
      <url>/2017/01/09/Android-%E5%9C%A8Dagger-2%E4%B8%ADActivities%E5%92%8CSubcomponents%E7%9A%84%E5%A4%9A%E7%BB%91%E5%AE%9A%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="在Dagger-2中Activities和Subcomponents的多绑定"><a href="#在Dagger-2中Activities和Subcomponents的多绑定" class="headerlink" title="在Dagger 2中Activities和Subcomponents的多绑定"></a>在Dagger 2中Activities和Subcomponents的多绑定</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/activities-multibinding-in-dagger-2" target="_blank" rel="noopener">http://frogermcs.github.io/activities-multibinding-in-dagger-2</a></p>
</blockquote>
<p>几个月前，在<a href="http://2016.mceconf.com/" target="_blank" rel="noopener">MCE^3</a>会议中，Gregory Kick在他的<a href="https://www.youtube.com/watch?v=iwjXqRlEevg" target="_blank" rel="noopener">演讲</a>中展示了一个提供Subcomponents（比如，为Activity）的新概念。新的方式给我们带来了一个创建不使用AppComponent对象引用（以前时Activities Subcomponents的工厂）的方式。为了让它成为现实，我们不得不等到了新的Dagger release版本：<a href="https://github.com/google/dagger/releases/tag/dagger-2.7" target="_blank" rel="noopener">version 2.7</a>。</p>
<a id="more"></a>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>在Dagger 2.7之前，创建Subcomponent（比如，<code>AppComponent</code>的subcomponent <code>MainActivityComponent</code>）我们必须要在父Component中声明它的工厂：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component</span>(</span><br><span class="line">    modules = &#123;</span><br><span class="line">        AppModule.class</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">    <span class="function">MainActivityComponent <span class="title">plus</span><span class="params">(MainActivityComponent.ModuleImpl <span class="keyword">module</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>多亏Dagger理解这个声明，<code>MainActivityComponent</code>能够访问从<code>AppComponent</code>的依赖。</p>
<p>有了这个，<code>MainActivity</code>中的注入看起来如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ActivityComponent <span class="title">onCreateComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ((MyApplication) getApplication()).getComponent().plus(<span class="keyword">new</span> MainActivityComponent.ModuleImpl(<span class="keyword">this</span>));</span><br><span class="line">    component.inject(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> component;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个代码的问题在于：</p>
<ul>
<li><p>Activity依赖于<code>AppComponent</code>（通过<code>((MyApplication) getApplication()).getComponent())</code>返回 - 我们是否想要去创建Subcomponent，我们需要去访问父Component的对象）。</p>
</li>
<li><p><code>AppComponent</code>必须要去声明所有Subcomponents（或者它们的builders），比如：<code>MainActivityComponent plus(MainActivityComponent.ModuleImpl module);</code>。</p>
</li>
</ul>
<h2 id="Modules-subcomponents"><a href="#Modules-subcomponents" class="headerlink" title="Modules.subcomponents"></a>Modules.subcomponents</h2><p>从Dagger 2.7开始，我们有了一个新的方法来声明subcomponents的父级。<code>@Module</code>注解有一个可选的<a href="http://google.github.io/dagger/api/2.7/dagger/Module.html#subcomponents--" target="_blank" rel="noopener">subcomponents</a>属性，它可以得到subcomponents类的列表，它们应该是安装此module组件的子component。</p>
<h3 id="Example："><a href="#Example：" class="headerlink" title="Example："></a>Example：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(</span><br><span class="line">        subcomponents = &#123;</span><br><span class="line">                MainActivityComponent.class,</span><br><span class="line">                SecondActivityComponent.class</span><br><span class="line">        &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityBindingModule</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ActivityBindingModule</code>在<code>AppComponent</code>中被安装。这表示<code>MainActivityComponent</code>和<code>SecondActivityComponent</code>两者都是<code>AppComponent</code>的Subcomponents。</p>
<p>Subcomponents的声明在这种方法中不需要明确地在<code>AppComponent</code>中进行声明（就像本章开头的代码）。</p>
<h2 id="Activities的多绑定"><a href="#Activities的多绑定" class="headerlink" title="Activities的多绑定"></a>Activities的多绑定</h2><p>让我们来看看我们怎么样使用<code>Modules.subcomponents</code>来构建Activities多绑定并且摆脱AppComponent对象传入Activity（这在<a href="https://www.youtube.com/watch?v=iwjXqRlEevg&amp;feature=youtu.be&amp;t=1693" target="_blank" rel="noopener">这个演讲</a>中也解释到）。我将只浏览代码中最重要的部分。整个实现已在Github中可用：<a href="https://github.com/frogermcs/Dagger2Recipes-ActivitiesMultibinding" target="_blank" rel="noopener">Dagger2Recipes-ActivitiesMultibinding</a>。</p>
<p>我们的app包含两个屏幕：<code>MainActivity</code>和<code>SecondActivity</code>。我们想要去给它们两者提供Subcomponents且并不传入<code>AppComponent</code>对象。</p>
<p>让我们从为所有Activity Components builders构建一个基本的接口来开始：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ActivityComponentBuilder</span>&lt;<span class="title">M</span> <span class="keyword">extends</span> <span class="title">ActivityModule</span>, <span class="title">C</span> <span class="keyword">extends</span> <span class="title">ActivityComponent</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">ActivityComponentBuilder&lt;M, C&gt; <span class="title">activityModule</span><span class="params">(M activityModule)</span></span>;</span><br><span class="line">    <span class="function">C <span class="title">build</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Subcomponents：<code>MainActivityComponent</code>的例子看起来如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ActivityScope</span></span><br><span class="line"><span class="meta">@Subcomponent</span>(</span><br><span class="line">        modules = MainActivityComponent.MainActivityModule.class</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MainActivityComponent</span> <span class="keyword">extends</span> <span class="title">ActivityComponent</span>&lt;<span class="title">MainActivity</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subcomponent</span>.Builder</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Builder</span> <span class="keyword">extends</span> <span class="title">ActivityComponentBuilder</span>&lt;<span class="title">MainActivityModule</span>, <span class="title">MainActivityComponent</span>&gt; </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Module</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MainActivityModule</span> <span class="keyword">extends</span> <span class="title">ActivityModule</span>&lt;<span class="title">MainActivity</span>&gt; </span>&#123;</span><br><span class="line">        MainActivityModule(MainActivity activity) &#123;</span><br><span class="line">            <span class="keyword">super</span>(activity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们可以使用Subcomponents builders的<code>Map</code>来得到每一个Activity类的意图builder。让我们如下使用<code>Multibinding</code>特性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span>(</span><br><span class="line">        subcomponents = &#123;</span><br><span class="line">                MainActivityComponent.class,</span><br><span class="line">                SecondActivityComponent.class</span><br><span class="line">        &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityBindingModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Binds</span></span><br><span class="line">    <span class="meta">@IntoMap</span></span><br><span class="line">    <span class="meta">@ActivityKey</span>(MainActivity.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ActivityComponentBuilder <span class="title">mainActivityComponentBuilder</span><span class="params">(MainActivityComponent.Builder impl)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Binds</span></span><br><span class="line">    <span class="meta">@IntoMap</span></span><br><span class="line">    <span class="meta">@ActivityKey</span>(SecondActivity.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ActivityComponentBuilder <span class="title">secondActivityComponentBuilder</span><span class="params">(SecondActivityComponent.Builder impl)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ActivityBindingModule</code>在<code>AppComponent</code>中被安装。就如它被解释的那样，多亏<code>MainActivityComponent</code>和<code>SecondActivityComponent</code>将会是<code>AppComponent</code>的Subcomponent。</p>
<p>现在我们可以注入<code>Subcomponents</code> builder的Map（比如，注入到<code>MyApplication</code> class）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> <span class="keyword">implements</span> <span class="title">HasActivitySubcomponentBuilders</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    Map&lt;Class&lt;? extends Activity&gt;, ActivityComponentBuilder&gt; activityComponentBuilders;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AppComponent appComponent;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HasActivitySubcomponentBuilders <span class="title">get</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ((HasActivitySubcomponentBuilders) context.getApplicationContext());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        appComponent = DaggerAppComponent.create();</span><br><span class="line">        appComponent.inject(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActivityComponentBuilder <span class="title">getActivityComponentBuilder</span><span class="params">(Class&lt;? extends Activity&gt; activityClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> activityComponentBuilders.get(activityClass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们创建了<code>HashActivitySubcomponentBuilders</code>接口作为额外的抽象（因为builders的<code>Map</code>不一定是注入到<code>Appliction</code>类的）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HasActivitySubcomponentBuilders</span> </span>&#123;</span><br><span class="line">    <span class="function">ActivityComponentBuilder <span class="title">getActivityComponentBuilder</span><span class="params">(Class&lt;? extends Activity&gt; activityClass)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后最后在Activity class中进行注入的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">injectMembers</span><span class="params">(HasActivitySubcomponentBuilders hasActivitySubcomponentBuilders)</span> </span>&#123;</span><br><span class="line">        ((MainActivityComponent.Builder) hasActivitySubcomponentBuilders.getActivityComponentBuilder(MainActivity.class))</span><br><span class="line">                .activityModule(<span class="keyword">new</span> MainActivityComponent.MainActivityModule(<span class="keyword">this</span>))</span><br><span class="line">                .build().injectMembers(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它非常类似于我们的第一个实现，但如上，最重要的事是我们不再传入<code>ActivityComponent</code>对象到我们的Activities中。</p>
<h2 id="用例example-——-instrumentation-tests-mocking"><a href="#用例example-——-instrumentation-tests-mocking" class="headerlink" title="用例example —— instrumentation tests mocking"></a>用例example —— instrumentation tests mocking</h2><p>除了解耦和解决循环依赖（Activity &lt;-&gt; Application），这不是一个大的问题，尤其是在较小的项目/团队中，让我们思考一个这个实现有帮助的真实用例 —— 在instrumentation testing中的mocking依赖。</p>
<p>目前在Android Instrumentation测试中mocking依赖最著名的方式之一是使用<a href="https://medium.com/@fabioCollini/android-testing-using-dagger-2-mockito-and-a-custom-junit-rule-c8487ed01b56#.eh5zfyou5" target="_blank" rel="noopener">DaggerMock</a>（Github <a href="https://github.com/fabioCollini/DaggerMock" target="_blank" rel="noopener">项目地址</a>）。虽然DaggerMock是一个强大的工具，但是非常难理解它面具之下是怎么工作的。其中有一些反射代码不容易被追踪。</p>
<p>在Activity中直接构建Subcomponent，而不需要访问AppComponent类给了我们一个方式来测试单独的Activity并从我们app的其它部分解耦。</p>
<p>听起来很酷，现在我们来看下代码。</p>
<p>在我们的instrumentation test中使用Applicaton类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationMock</span> <span class="keyword">extends</span> <span class="title">MyApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putActivityComponentBuilder</span><span class="params">(ActivityComponentBuilder builder, Class&lt;? extends Activity&gt; cls)</span> </span>&#123;</span><br><span class="line">        Map&lt;Class&lt;? extends Activity&gt;, ActivityComponentBuilder&gt; activityComponentBuilders = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="keyword">this</span>.activityComponentBuilders);</span><br><span class="line">        activityComponentBuilders.put(cls, builder);</span><br><span class="line">        <span class="keyword">this</span>.activityComponentBuilders = activityComponentBuilders;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>putActivityComponentBuilder()</code>方法给我们一个对给定Activity类替换ActivityComponentBuilder的实现的方法。</p>
<p>现在来看下我们Espresso Instrumentation Test例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(AndroidJUnit4.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivityUITest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> MockitoRule mockitoRule = MockitoJUnit.rule();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="keyword">public</span> ActivityTestRule&lt;MainActivity&gt; activityRule = <span class="keyword">new</span> ActivityTestRule&lt;&gt;(MainActivity.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    MainActivityComponent.Builder builder;</span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    Utils utilsMock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MainActivityComponent mainActivityComponent = <span class="keyword">new</span> MainActivityComponent() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">injectMembers</span><span class="params">(MainActivity instance)</span> </span>&#123;</span><br><span class="line">            instance.mainActivityPresenter = <span class="keyword">new</span> MainActivityPresenter(instance, utilsMock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        when(builder.build()).thenReturn(mainActivityComponent);</span><br><span class="line">        when(builder.activityModule(any(MainActivityComponent.MainActivityModule.class))).thenReturn(builder);</span><br><span class="line"></span><br><span class="line">        ApplicationMock app = (ApplicationMock) InstrumentationRegistry.getTargetContext().getApplicationContext();</span><br><span class="line">        app.putActivityComponentBuilder(builder, MainActivity.class);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>一步一步来：</p>
<ul>
<li><p>我们提供了<code>MainActivityComponent.Builder</code>的Mock和所有我们必须要mock的依赖（在本例中只是<code>Utils</code>）。我们mocked<code>Builder</code>返回一个<code>MainActivityComponent</code>的一个自定义实现，它用于注入<code>MainActivityPresenter</code>（其中使用了mocked <code>Utils</code>）。</p>
</li>
<li><p>然后我们的<code>MainActivityComponent.Builder</code>替换了在<code>MyApplication</code>（28行）中被注入的原始Builder：<code>app.putActivityComponentBuilder(builder, MainActivity.class);</code></p>
</li>
<li><p>最后测试 —— 我们mock<code>Util.getHardcodedText()</code>方法。注入过程发生在Activity被创建（36行）：<code>activityRule.launchActivity(new Intent());</code>接着在最后我们使用Espresso来检验结果。</p>
</li>
</ul>
<p>以上就是全部。如你所见，几乎一切都发生在<code>MainActivityUITest</code>类中，而且代码相当简单和可读。</p>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>如果你想自己去测试这个实现，源码与工作例子展示怎么去创建<strong>Activities Multibinding</strong>和在Instrumentation Tests中mock依赖见Github：<a href="https://github.com/frogermcs/Dagger2Recipes-ActivitiesMultibinding" target="_blank" rel="noopener">Dagger2Recipes-ActivitiesMultibinding</a></p>
<p>感谢阅读！</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> dependency injection </tag>
            
            <tag> dagger2 </tag>
            
            <tag> DI </tag>
            
            <tag> google </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[使用Dagger 2来构建UserScope（翻译）]]></title>
      <url>/2016/12/30/Android-%E4%BD%BF%E7%94%A8Dagger-2%E6%9D%A5%E6%9E%84%E5%BB%BAUserScope%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="使用Dagger-2来构建UserScope"><a href="#使用Dagger-2来构建UserScope" class="headerlink" title="使用Dagger 2来构建UserScope"></a>使用Dagger 2来构建UserScope</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/building-userscope-with-dagger2/" target="_blank" rel="noopener">http://frogermcs.github.io/building-userscope-with-dagger2/</a></p>
</blockquote>
<p>在Dagger 2中自定义scopes可以在不寻常存活时间（与Application和界面生命周期不同的）的依赖上给我带来更好的控制。但是在Android app中正确地实现它需要记住几个事情：scope不能存活比application进程更长的周期，进程可以被系统杀死并且在更多的对象实例的用户流中恢复过来。今天我们将介绍所有这些，并尝试实现可用于生产的UserScope。</p>
<p>在我的其中一篇博客中<a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-custom-scopes/" target="_blank" rel="noopener">写了</a>关于<strong>自定义scopes</strong>和<strong>Subcomponents</strong>。作为一个例子，我使用了<code>UserScope</code>，只要用户是登录状态就应该存活。一个scopes生命周期的例子：</p>
<p><img src="http://frogermcs.github.io/images/15/scopes-lifecycle.png" alt=""></p>
<p>虽然它看起来非常简单，它的实现在那篇文章中已经展示，但是它的代码是脱离与生产环境的。这就是为什么我想要又一次深入这个话题 - 但是会有更多实现的上下文细节。</p>
<h2 id="Example-app"><a href="#Example-app" class="headerlink" title="Example app"></a>Example app</h2><p>我们将构建3个界面的应用，它可以从<a href="https://developer.github.com/v3/" target="_blank" rel="noopener">Github API</a>获取用户详情（让我们假设这在生产环境app中作为一个认证的事件）。</p>
<p>App将会有3个scopes：</p>
<ul>
<li>(Application scope, <strong>@Singleton</strong>) - 只要application存活依赖就存活。</li>
<li><strong>@UserScope</strong> - 只要用户会话是激活状态依赖就存活（在单个应用程序中启动）。<strong>重要的是：</strong>这个scope存活时间不会超过application本身。每一个新的app实例都会创建一个新的@UserScope（甚至app不同的启动间用户会话没有关闭）。</li>
<li><strong>@ActivityScope</strong> - 只要Activity界面存活依赖就存活。</li>
</ul>
<h3 id="它怎么工作的呢？"><a href="#它怎么工作的呢？" class="headerlink" title="它怎么工作的呢？"></a>它怎么工作的呢？</h3><p>当app从Github API得到特定用户名的数据，新的界面会被打开（UserDetails）。在内部，<code>LoginActivityPresenter</code>访问<code>UserManager</code>来开启一个会话（从Github API获取数据）。当操作成功，用户保存到<code>UserDataStore</code>，并且<code>UserManager</code>创建<code>UserComponent</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UserManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Observable&lt;User&gt; <span class="title">startSessionForUser</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> githubApiService.getUser(username)</span><br><span class="line">            .map(User.UserResponseToUser())</span><br><span class="line">            .doOnNext(<span class="keyword">new</span> Action1&lt;User&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">                    userDataStore.createUser(user);</span><br><span class="line">                    startUserSession();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .subscribeOn(Schedulers.io())</span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">startUserSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user = userDataStore.getUser();</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Timber.i(<span class="string">"Session started, user: %s"</span>, user);</span><br><span class="line">        userComponent = userComponentBuilder.sessionModule(<span class="keyword">new</span> UserModule(user)).build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>UserManager</strong>是一个单例，所以它的存活时间与Applicaiton一致，而且它对生命周期与用户会话一样的<code>UserComponet</code>负责。当用户决定去关闭会话，component会被移除，这样所有<code>@UserScope</code>注解了的对象应该准备被GC回收。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UserManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeUserSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Timber.i(<span class="string">"Close session for user: %s"</span>, userDataStore.getUser());</span><br><span class="line">    userComponent.logoutManager().startLogoutProcess();</span><br><span class="line">    userDataStore.clearUser();</span><br><span class="line">    userComponent = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Components的层次结构"><a href="#Components的层次结构" class="headerlink" title="Components的层次结构"></a>Components的层次结构</h3><p>在我们的app中所有的subcomponents使用了一个<code>AppComponent</code>作为一个根component。显示用户相关内容的Subcomponents使用保持了带<code>@Userscope</code>注解的对象（一个用户会话一个实例）的<code>UserComponent</code>。</p>
<p><img src="http://frogermcs.github.io/images/28/scopes.png" alt=""></p>
<p><code>UserDetailsActivityComponent</code>组件层次结构示例如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AppComponent.java </span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component</span>(modules = &#123;</span><br><span class="line">        AppModule.class,</span><br><span class="line">        GithubApiModule.class</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">    UserComponent.<span class="function">Builder <span class="title">userComponentBuilder</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserComponent.java </span></span><br><span class="line"></span><br><span class="line"><span class="meta">@UserScope</span></span><br><span class="line"><span class="meta">@Subcomponent</span>(modules = UserModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subcomponent</span>.Builder</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">        UserComponent.<span class="function">Builder <span class="title">sessionModule</span><span class="params">(UserModule userModule)</span></span>;</span><br><span class="line">        <span class="function">UserComponent <span class="title">build</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">UserDetailsActivityComponent <span class="title">plus</span><span class="params">(UserDetailsActivityComponent.UserDetailsActivityModule <span class="keyword">module</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserDetailsActivityComponent.java </span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ActivityScope</span></span><br><span class="line"><span class="meta">@Subcomponent</span>(modules = UserDetailsActivityComponent.UserDetailsActivityModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailsActivityComponent</span> </span>&#123;</span><br><span class="line">    <span class="function">UserDetailsActivity <span class="title">inject</span><span class="params">(UserDetailsActivity activity)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于<code>UserComponent</code>，我们使用<a href="http://google.github.io/dagger/subcomponents.html#subcomponent-builders" target="_blank" rel="noopener">Subcomponent builder</a>模式来让我们的代码更加整洁，有可能注入这个Builder到<code>UserModule</code>（<code>UserComponent.Builder</code>用于创建组件<code>UserModule.startUserSession</code>方法如上所示）。</p>
<h3 id="在app的多次启动中恢复UserScope"><a href="#在app的多次启动中恢复UserScope" class="headerlink" title="在app的多次启动中恢复UserScope"></a>在app的多次启动中恢复UserScope</h3><p>就像我之前提到的UserScope的存活时间不能超过application进程。所以如果我们假设用户会话可以在app的多次启动之间保存，我们需要为我们的<code>UserScope</code>去处理状态恢复操作。有两种场景我们需要记住：</p>
<h4 id="用户从头开始启动程序"><a href="#用户从头开始启动程序" class="headerlink" title="用户从头开始启动程序"></a>用户从头开始启动程序</h4><p>这是最常见的情况，应该很简单地去处理。用户从头开始启动app（比如，通过点击app icon）。<code>Application</code>对象被创建，然后第一个<code>Activity</code>（<strong>LAUNCHER</strong>）被启动。我们需要提供简单的逻辑检查我们是否有保存的用户在我们的数据存储中。如果是则将用户传送到UserComponent自动创建的正确的界面（在我们案例中是<code>UserDetailsActivity</code>）。</p>
<h4 id="用户进程被系统kill"><a href="#用户进程被系统kill" class="headerlink" title="用户进程被系统kill"></a>用户进程被系统kill</h4><p>但是还有一种情况我们经常会忘记。Application进程可以被系统杀死（比如，因为内存不足）。这意味着所有application数据被销毁（application，activities，static fields）。不幸的是这不能被很好的处理 - 我们在Applicaiton生命周期中没有任何回调。令它更复杂的是，android保存了activity栈。也就是说，当用户决定启动之前被杀死于流中间的应用程序时，系统将试图带用户回到此界面。</p>
<p>对于我们而言我们需要准备在任何被使用的屏幕中去恢复<code>UserComponent</code>。</p>
<p>让我们考虑这个例子：</p>
<p>1. 用户在<code>UserDetailsActivity</code>界面最小化app。<br>2. 整个app被系统杀死（稍后我会展示如何模拟它）<br>3. 用户打开任务切换栏，点击我们的app界面。<br>4. 系统创建了一个新的<code>Application</code>实例。也就是说有一个新的<code>AppComponent</code>被创建。然后系统并不会打开<code>LoginActivity</code>（我们的启动activity），而是立即打开<code>UserDetailsActivity</code>。</p>
<p>对于我们而言，<code>UserComponent</code>被恢复回来（新的实例被创建）。然后这是我们的责任。例子的解决方案看起来如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseUserActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    UserManager userManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupActivityComponent</span><span class="params">(AppComponent appComponent)</span> </span>&#123;</span><br><span class="line">        appComponent.inject(<span class="keyword">this</span>);</span><br><span class="line">        setupUserComponent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupUserComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    isUserSessionStarted = userManager.isUserSessionStartedOrStartSessionIfPossible();</span><br><span class="line">    onUserComponentSetup(userManager.getUserComponent());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//This screen cannot work when user session is not started.</span></span><br><span class="line">    <span class="keyword">if</span> (!isUserSessionStarted) &#123;</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onUserComponentSetup</span><span class="params">(UserComponent userComponent)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每一个使用了UserComponent的Activity都继承了我们的<code>BaseUserActivity</code>类（<code>setupActivityComponent()</code>方法在<code>BaseActivity</code>的<code>onCreate()</code>方法中调用）。</p>
<p><code>UserManager</code>从Application创建的<code>AppComponent</code>中被注入。会话通过这种方式开启：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isUserSessionStartedOrStartSessionIfPossible</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userComponent != <span class="keyword">null</span> || startUserSession();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">startUserSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//This method was described earlier</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="如果用户不再存在怎么办？"><a href="#如果用户不再存在怎么办？" class="headerlink" title="如果用户不再存在怎么办？"></a>如果用户不再存在怎么办？</h4><p>这里有另外一种方式来处理 - 如果用户登出（比如，通过<code>SyncAdapter</code>），然后<code>UserComponent</code>不能被创建怎么办？这就是为什么在我们的<code>BaseUserActivity</code>中有这几行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupUserComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//This screen cannot work when user session is not started.</span></span><br><span class="line">    <span class="keyword">if</span> (!isUserSessionStarted) &#123;</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是这里有一个情况时当UserComponent不能被创建时我们必须要记住依赖注入将不会发生。这就是为什么我每次需要在<code>onCreate()</code>方法中检查来防止来自依赖注入的NullPointerExceptions。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UserDetailsActivity</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_user_details);</span><br><span class="line">    tvUser = (TextView) findViewById(R.id.tvUser);</span><br><span class="line">    tvUserUrl = (TextView) findViewById(R.id.tvUserUrl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//This check has to be called. Otherwise, when user is not logged in, presenter won't be injected and this line will cause NPE</span></span><br><span class="line">    <span class="keyword">if</span> (isUserSessionStarted()) &#123;</span><br><span class="line">        presenter.onCreate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="怎么去模拟应用进程被系统杀死"><a href="#怎么去模拟应用进程被系统杀死" class="headerlink" title="怎么去模拟应用进程被系统杀死"></a>怎么去模拟应用进程被系统杀死</h3><p>1. 打开你想测试的用户界面<br>2. 通过系统Home键最小化app。<br>3. 在Android Studio，Android Monitor 选中你的应用，然后点击Terminate<br>4. 现在在你的设备上打开任务切换栏，找到你的app（你应该仍然能在最后一个可见的界面上预览到）。<br>5. 你的app被启动，新的Application实例被创建，并且Activity被恢复。</p>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>例子中展示怎么样去创建和使用<code>UserComponent</code>的可用的源码已经在Github上：<a href="https://github.com/frogermcs/Dagger2Recipes-UserScope" target="_blank" rel="noopener">Dagger 2 recipes - UserScope</a>。</p>
<p>感谢阅读！</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> dependency injection </tag>
            
            <tag> dagger2 </tag>
            
            <tag> DI </tag>
            
            <tag> google </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[在Dagger 2中使用RxJava来进行异步注入（翻译）]]></title>
      <url>/2016/12/30/Android-%E5%9C%A8Dagger-2%E4%B8%AD%E4%BD%BF%E7%94%A8RxJava%E6%9D%A5%E8%BF%9B%E8%A1%8C%E5%BC%82%E6%AD%A5%E6%B3%A8%E5%85%A5%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="在Dagger-2中使用RxJava来进行异步注入"><a href="#在Dagger-2中使用RxJava来进行异步注入" class="headerlink" title="在Dagger 2中使用RxJava来进行异步注入"></a>在Dagger 2中使用RxJava来进行异步注入</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/async-injection-in-dagger-2-with-rxjava" target="_blank" rel="noopener">http://frogermcs.github.io/async-injection-in-dagger-2-with-rxjava</a></p>
</blockquote>
<p>几星期前我写了一篇关于在Dagger 2中使用<em>Producers</em>进行异步注入的<a href="https://medium.com/@froger_mcs/dependency-injection-with-dagger-2-producers-c424ddc60ba3" target="_blank" rel="noopener">文章</a>。在后台线程中执行对象的初始化又一个很好的优势 - 它负责实时（<a href="https://www.youtube.com/watch?v=CaMTIgxCSqU" target="_blank" rel="noopener">每秒60帧</a>可以保持界面流畅）绘制UI时不会在主线程中阻塞。</p>
<p>值得一提的是，缓慢的初始化过程并不是每个人都会觉得是个问题。但是如果你真的关心这个，所有外部库在构造以及在任何<code>init()</code>方法中进行磁盘/网络的操作会很常见。如果你不能确定这一点，我建议你尝试下<a href="https://github.com/frogermcs/AndroidDevMetrics" target="_blank" rel="noopener">AndroidDevMetrics</a> - 我的Android性能测量库。它会告诉你在app中需要花多少时间来显示特定的界面，还有（如果你使用了Dagger 2）在依赖图表中提供每个对象消耗了多少时间。</p>
<p>不幸的是Producers并不是为Android设计的，它有以下缺陷：</p>
<ul>
<li>依赖使用了Guava（会引起64k方法问题，增加build时间）</li>
<li>并不是非常快的（注入机制会阻塞主线程几毫秒到几十毫秒的世界，这取决于设备）</li>
<li>不能使用@Inject注解（代码会有一点混乱）</li>
</ul>
<p>虽然我们不能解决最后两个问题，但是第一个我们可以在Android Project中解决。</p>
<h2 id="使用RxJava进行异步注入"><a href="#使用RxJava进行异步注入" class="headerlink" title="使用RxJava进行异步注入"></a>使用RxJava进行异步注入</h2><p>幸运的是，有大量的Android开发者使用了RxJava（和<a href="https://github.com/ReactiveX/RxAndroid" target="_blank" rel="noopener">RxAndroid</a>）来在我们app中编写异步代码。让我们来尝试在Dagger 2中使用它来进行异步注入。</p>
<h3 id="异步-Singleton注入"><a href="#异步-Singleton注入" class="headerlink" title="异步@Singleton注入"></a>异步@Singleton注入</h3><p>这是我们繁重的对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="function">HeavyExternalLibrary <span class="title">provideHeavyExternalLibrary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HeavyExternalLibrary heavyExternalLibrary = <span class="keyword">new</span> HeavyExternalLibrary();</span><br><span class="line">    heavyExternalLibrary.init(); <span class="comment">//This method takes about 500ms</span></span><br><span class="line">    <span class="keyword">return</span> heavyExternalLibrary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在让我们来创建一个额外的<code>provide...()</code>方法，它返回一个<code>Observable&lt;HeavyExternalLibrary&gt;</code>对象，它会异步调用以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="function">Observable&lt;HeavyExternalLibrary&gt; <span class="title">provideHeavyExternalLibraryObservable</span><span class="params">(<span class="keyword">final</span> Lazy&lt;HeavyExternalLibrary&gt; heavyExternalLibraryLazy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> HeavyExternalLibrary&gt; subscriber)</span> </span>&#123;</span><br><span class="line">            subscriber.onNext(heavyExternalLibraryLazy.get());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让我们逐行来分析：</p>
<ul>
<li><code>@Singleton</code> - 记住这个很重要，<code>Observable</code>对象将会是一个单例，而不是<code>HeavyExternalLibrary</code>。Singleton也会阻止创建额外的Observable对象。</li>
<li><code>@Providers</code> - 因为这个方法是<code>@Module</code>注解了的类的一部分。你还记得<a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-the-api/" target="_blank" rel="noopener">Dagger 2 API</a>吗？</li>
<li><code>Lazy&lt;HeavyExternalLibrary&gt; heavyExternalLibraryLazy</code>对象阻止Dagger（否则，在调用<code>provideHeavyExternalLibraryObservable()</code>方法调用的瞬间对象就会被创建）内部对HeavyExternalLibrary对象的初始化。</li>
<li><code>Observable.create(...)</code>代码 - 它将在每次这个Observable被订阅时通过调用<code>heavyExternalLibraryLazy.get()</code>返回<code>heavyExternalLibrary</code>对象。</li>
<li><code>.subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread());</code> - 默认情况下RxJava代码会在Observable被创建的线程中执行。这就是为什么我们要把执行移动到后台线程（这里的<code>Schedulers.io()</code>），然后在主线程中（<code>AndroidSchedulers.mainThread()</code>）观察结果。</li>
</ul>
<p>我们的Observable像图表中其它对象一样被注入，但是<code>heavyExternalLibrary</code>对象本身将会延迟一点才可用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplashActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Inject</span></span><br><span class="line">	Observable&lt;HeavyExternalLibrary&gt; heavyExternalLibraryObservable;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//This will be injected asynchronously</span></span><br><span class="line">	HeavyExternalLibrary heavyExternalLibrary; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.onCreate();</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">		heavyExternalLibraryObservable.subscribe(<span class="keyword">new</span> SimpleObserver&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(HeavyExternalLibrary heavyExternalLibrary)</span> </span>&#123;</span><br><span class="line">	            <span class="comment">//Our dependency will be available from this moment</span></span><br><span class="line">	            SplashActivity.<span class="keyword">this</span>.heavyExternalLibrary = heavyExternalLibrary;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="异步新实例的注入"><a href="#异步新实例的注入" class="headerlink" title="异步新实例的注入"></a>异步新实例的注入</h3><p>上面的代码展示了怎么去注入单例的对象。那如果我们想异步注入新的实例呢？</p>
<p>确认我们的对象不再使用了@Singleton注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="function">HeavyExternalLibrary <span class="title">provideHeavyExternalLibrary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HeavyExternalLibrary heavyExternalLibrary = <span class="keyword">new</span> HeavyExternalLibrary();</span><br><span class="line">    heavyExternalLibrary.init(); <span class="comment">//This method takes about 500ms</span></span><br><span class="line">    <span class="keyword">return</span> heavyExternalLibrary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们<code>Observable&lt;HeavyExternalLibrary&gt;</code> provider方法也会有一点改变。我们不能使用<code>Lazy&lt;HeavyExternalLibrary&gt;</code>因为它只会在第一次调用<code>get()</code>方法的时候（详见<a href="http://google.github.io/dagger/api/latest/dagger/Lazy.html" target="_blank" rel="noopener">Lazy文档</a>）才会创建新的实例。</p>
<p>这里是更新后的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="function">Observable&lt;HeavyExternalLibrary&gt; <span class="title">provideHeavyExternalLibraryObservable</span><span class="params">(<span class="keyword">final</span> Provider&lt;HeavyExternalLibrary&gt; heavyExternalLibraryProvider)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> HeavyExternalLibrary&gt; subscriber)</span> </span>&#123;</span><br><span class="line">            subscriber.onNext(heavyExternalLibraryProvider.get());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的<code>Observable&lt;HeavyExternalLibrary&gt;</code>可以是一个单例，，但是每一次我们去调用它的subscribe()方法的时候，我们将会在onNext()方法中得到一个新的<code>HeavyExternalLibrary</code>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">heavyExternalLibraryObservable.subscribe(<span class="keyword">new</span> SimpleObserver&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(HeavyExternalLibrary heavyExternalLibrary)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//New instance of HeavyExternalLibrary</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="完全的异步注入"><a href="#完全的异步注入" class="headerlink" title="完全的异步注入"></a>完全的异步注入</h3><p>还有另一个方法是用RxJava在Dagger 2中进行异步注入。我们可以使用Observable简单封装整个注入过程。</p>
<p>我们注入的执行是这样的（代码摘自<a href="https://github.com/frogermcs/GithubClient/" target="_blank" rel="noopener">GithubClient</a>项目）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplashActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    SplashActivityPresenter presenter;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    AnalyticsManager analyticsManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//This method is called in super.onCreate() method</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupActivityComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> SplashActivityComponent splashActivityComponent = GithubClientApplication.get(SplashActivity.<span class="keyword">this</span>)</span><br><span class="line">                .getAppComponent()</span><br><span class="line">                .plus(<span class="keyword">new</span> SplashActivityModule(SplashActivity.<span class="keyword">this</span>));</span><br><span class="line">        splashActivityComponent.inject(SplashActivity.<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要让它变成异步我们只需要使用Observable封装<code>setupActivityComponent()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupActivityComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;Object&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Object&gt; subscriber)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> SplashActivityComponent splashActivityComponent = GithubClientApplication.get(SplashActivity.<span class="keyword">this</span>)</span><br><span class="line">                    .getAppComponent()</span><br><span class="line">                    .plus(<span class="keyword">new</span> SplashActivityModule(SplashActivity.<span class="keyword">this</span>));</span><br><span class="line">            splashActivityComponent.inject(SplashActivity.<span class="keyword">this</span>);</span><br><span class="line">            subscriber.onCompleted();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">            .subscribeOn(Schedulers.io())</span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">            .subscribe(<span class="keyword">new</span> SimpleObserver&lt;Object&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="comment">//Here is the moment when injection is done.</span></span><br><span class="line">                    analyticsManager.logScreenView(getClass().getName());</span><br><span class="line">                    presenter.callAnyMethod();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正如注释，所有<code>@Inject</code>注解了的对象将被未来某一时刻注入。在返回注入过程是异步的并且不会对主线程有很大的影响。</p>
<p>当然创建<code>Observable</code>对象和额外<code>subscribeOn()</code>线程并不是完全免费的 - 它将会花费一点时间。这类似于<strong>Producers</strong>代码所产生的影响。</p>
<p><img src="http://frogermcs.github.io/images/26/splash_metrics.png" alt=""></p>
<p>感谢阅读！</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> dependency injection </tag>
            
            <tag> dagger2 </tag>
            
            <tag> DI </tag>
            
            <tag> google </tag>
            
            <tag> RxJava </tag>
            
            <tag> RxAndroid </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[使用Dagger 2进行依赖注入 - Producers（翻译）]]></title>
      <url>/2016/12/29/Android-%E4%BD%BF%E7%94%A8Dagger-2%E8%BF%9B%E8%A1%8C%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5-Producers%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="使用Dagger-2进行依赖注入-Producers"><a href="#使用Dagger-2进行依赖注入-Producers" class="headerlink" title="使用Dagger 2进行依赖注入 - Producers"></a>使用Dagger 2进行依赖注入 - Producers</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-producers/" target="_blank" rel="noopener">http://frogermcs.github.io/dependency-injection-with-dagger-2-producers/</a></p>
</blockquote>
<p>本文是在Android中使用Dagger 2框架进行依赖注入的系列文章中的一部分。今天我们将探索下Dagger Producers - 使用Java实现异步依赖注入的Dagger2的一个扩展。</p>
<h2 id="初始化性能问题"><a href="#初始化性能问题" class="headerlink" title="初始化性能问题"></a>初始化性能问题</h2><p>我们都知道Dagger 2是一个优化得很好的依赖注入框架。但是即使有这些全部的微优化，仍然在依赖注入的时候存在可能的性能问题 - “笨重”的第三方库和/或我们那些主线程阻塞的代码。</p>
<p>依赖注入是在尽可能短的时间内在正确的地方传递所请求的依赖的过程 - 这些都是Dagger 2做得很好的。但是DI也会去创建各种依赖。如果我们需要花费几百毫秒创建它们，那么以纳秒级的时间去提供依赖还有什么意义呢？</p>
<p>当我们的app创建了一系列繁重的单例并立即由Dagger2提供服务之后也许可能没有这么重要。但是在我们创建它们的时候仍然需要一个时间成本 - 大多数情况下决定了app启动的时间。</p>
<p>这问题（已经给了提示怎么去调适它）已经在我之前的一篇博客中描述地很详细了：<a href="http://frogermcs.github.io/dagger-graph-creation-performance/" target="_blank" rel="noopener">Dagger 2 - graph creation performance</a>。</p>
<p>在很短的时间内，让我们想象这么一个场景 - 你的app有一个初始化的界面（SplashScreen），需要在app启动后立即做一些需要的事情：</p>
<ul>
<li>初始化所有tracking libs（Goole Analytics, Crashlytics）然后发送第一份数据给它们。</li>
<li>创建用于API和/或数据库通信的整个栈。</li>
<li>我们试图的交互逻辑（MVP中的Presenters，MVVM中的ViewModels等等）。</li>
</ul>
<p>即使我们的代码是优化地非常好的，但是仍然有可能有些额外的库需要几十或者几百毫秒的时间来初始化。在我们启动界面之前将展示必须初始化和交付的所有请求的依赖（和它们的依赖）。这意味着启动时间将会是它们每一个初始化时间的总和。</p>
<p>由 <a href="https://github.com/frogermcs/androiddevmetrics" target="_blank" rel="noopener">AndroidDevMetrics</a> 测量的示例堆栈可能如下所示：</p>
<p><img src="http://frogermcs.github.io/images/24/example_dependencies.png" alt=""></p>
<p>用户将会在600ms（＋额外的系统work）内看到SplashActivity - 所有初始化时间的总和。</p>
<h2 id="Producers-异步依赖注入"><a href="#Producers-异步依赖注入" class="headerlink" title="Producers - 异步依赖注入"></a>Producers - 异步依赖注入</h2><p>Dagger 2 有一个名为 <strong>Producers</strong> 的扩展，或多或少能为我们解决这些问题。</p>
<p>思路很简单 - 整个初始化流程可以在一个或多个后台线程中被执行，然后延后再交付给app的主线程。</p>
<h4 id="ProducerModule"><a href="#ProducerModule" class="headerlink" title="@ProducerModule"></a>@ProducerModule</h4><p>类似于<code>@Module</code>，这个被用来标记用于传递依赖的类。多亏于它，Dagger将会知道去哪里找到被请求的依赖。</p>
<h4 id="Produces"><a href="#Produces" class="headerlink" title="@Produces"></a>@Produces</h4><p>类似于<code>@Provide</code>，这个注解用来标记带有<code>@ProducerModule</code>注解的类中的返回依赖的方法。<code>@Produces</code>注解的方法可以返回<code>ListenableFuture&lt;T&gt;</code>或者自身的对象（也会在所给的后台线程中进行初始化）。</p>
<h4 id="ProductionComponent"><a href="#ProductionComponent" class="headerlink" title="@ProductionComponent"></a>@ProductionComponent</h4><p>类似于<code>@Component</code>，它负责依赖的传递。它是我们代码与<code>@ProducerModule</code>之间的桥梁。唯一跟<code>@Component</code>的不同之处是我们不能决定依赖的scope。这意味着提供给 <em>component</em> 的每一个 <em>Produces 方法</em> 在 <em>每个component 实例</em> 中最多只会被调用一次，不管它作为一个 <em>依赖</em> 用于多少次绑定。</p>
<p>也就是说，每一个服务于<code>@ProductionComponent</code>的对象都是一个单例（只要我们从这个特殊的component中获取）。</p>
<hr>
<p>Producers的文档已经足够详细了，所以这里没有必要去拷贝到这里。直接看：<a href="http://google.github.io/dagger/producers.html" target="_blank" rel="noopener">Dagger 2 Producers docs</a>。</p>
<h3 id="Producers的代价"><a href="#Producers的代价" class="headerlink" title="Producers的代价"></a>Producers的代价</h3><p>在我们开始实践前，有一些值得提醒的事情。Producers相比Dagger 2本身有一点更复杂。它看起来手机端app不是他们它们主要使用的目标，而且知道这些事情很重要：</p>
<ul>
<li>Producers使用了Guava库，并且建立在ListenableFuture类之上。这意味着你不得不处理15k的额外方法在你的app中。这可能导致你不得不使用<em>Proguard</em>来处理并且需要一个更长的编译时间。</li>
<li>就如你将看到的，创建<code>ListenableFutures</code>并不是没有成本的。所以如果你指望Producers会帮你从10ms优化到0ms那你可能就错了。但是如果规模更大（100ms –&gt; 10ms），你就能有所发现。</li>
<li>现在无法使用<code>@Inject</code>注解，所以你必须要手动处理ProductionComponents。它会使得你的标准整洁的代码变得混乱。</li>
</ul>
<p><a href="http://stackoverflow.com/questions/35617378/injects-after-produces" target="_blank" rel="noopener">这里</a>你可以针对<code>@Inject</code>注解找到好的间接的解决方案的尝试。</p>
<h2 id="Example-app"><a href="#Example-app" class="headerlink" title="Example app"></a>Example app</h2><p>如果你仍然希望使用Producers来处理，那就让我们更新 <a href="https://github.com/frogermcs/GithubClient/" target="_blank" rel="noopener">GithubClient</a> 这个app使得它在注入过程使用Producers。在实现之前和之后我们将会使用 <a href="https://github.com/frogermcs/androiddevmetrics" target="_blank" rel="noopener">AndroidDevMetrics</a> 来测量启动时间和对比结果。</p>
<p><a href="https://github.com/frogermcs/GithubClient/tree/1c14683691e0e7af17b26055a0fd041d4a7df424" target="_blank" rel="noopener">这里</a>是一个在使用producers更新之前的 GithubClient app的版本。并且它测量的平均启动时间如下：</p>
<p><img src="http://frogermcs.github.io/images/24/before_update.png" alt=""></p>
<p>我们的计划是处理UserManager让它的所有的依赖来自Producers。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>我们将给一个Dagger v2.1的尝试（但是当前2.0版本的Producers也是可用的）。</p>
<p>让我们在项目中加入一个Dagger新的版本：</p>
<p><strong><em>app/build.gradle：</em></strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.neenbedankt.android-apt'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.frogermcs.androiddevmetrics'</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    maven &#123;</span><br><span class="line">        url <span class="string">"https://oss.sonatype.org/content/repositories/snapshots"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Dagger 2</span></span><br><span class="line">    compile <span class="string">'com.google.dagger:dagger:2.1-SNAPSHOT'</span></span><br><span class="line">    compile <span class="string">'com.google.dagger:dagger-producers:2.1-SNAPSHOT'</span></span><br><span class="line">    apt <span class="string">'com.google.dagger:dagger-compiler:2.1-SNAPSHOT'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如你所见，Producers 作为一个新的依赖，在dagger 2库的下面。还有值得一说的是Dagger v2.1终于不需要<code>org.glassfish:javax.annotation:10.0-b28</code>的依赖了。</p>
<h3 id="Producer-Module"><a href="#Producer-Module" class="headerlink" title="Producer Module"></a>Producer Module</h3><p>现在，让我们移动代码从<code>GithubApiModule</code>到新创建的<code>GithubApiProducerModule</code>中。原来的代码可以在这里找到：<a href="https://github.com/frogermcs/GithubClient/blob/1c14683691e0e7af17b26055a0fd041d4a7df424/app/src/main/java/frogermcs/io/githubclient/data/api/GithubApiModule.java" target="_blank" rel="noopener">GithubApiModule</a></p>
<p><strong><em>GithubApiProducerModule.java</em></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ProducerModule</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GithubApiProducerModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Produces</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> OkHttpClient <span class="title">produceOkHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> OkHttpClient.Builder builder = <span class="keyword">new</span> OkHttpClient.Builder();</span><br><span class="line">        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">            HttpLoggingInterceptor logging = <span class="keyword">new</span> HttpLoggingInterceptor();</span><br><span class="line">            logging.setLevel(HttpLoggingInterceptor.Level.BODY);</span><br><span class="line">            builder.addInterceptor(logging);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        builder.connectTimeout(<span class="number">60</span> * <span class="number">1000</span>, TimeUnit.MILLISECONDS)</span><br><span class="line">                .readTimeout(<span class="number">60</span> * <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Produces</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Retrofit <span class="title">produceRestAdapter</span><span class="params">(Application application, OkHttpClient okHttpClient)</span> </span>&#123;</span><br><span class="line">        Retrofit.Builder builder = <span class="keyword">new</span> Retrofit.Builder();</span><br><span class="line">        builder.client(okHttpClient)</span><br><span class="line">                .baseUrl(application.getString(R.string.endpoint))</span><br><span class="line">                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</span><br><span class="line">                .addConverterFactory(GsonConverterFactory.create());</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Produces</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GithubApiService <span class="title">produceGithubApiService</span><span class="params">(Retrofit restAdapter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restAdapter.create(GithubApiService.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Produces</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserManager <span class="title">produceUserManager</span><span class="params">(GithubApiService githubApiService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserManager(githubApiService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Produces</span></span><br><span class="line">    <span class="keyword">public</span> UserModule.<span class="function">Factory <span class="title">produceUserModuleFactory</span><span class="params">(GithubApiService githubApiService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserModule.Factory(githubApiService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看起来很像？没错，我们只是修改了：</p>
<ul>
<li><code>@Module</code> 改为 <code>@ProducerModule</code></li>
<li><code>@Provides @Singleton</code> 改为 <code>@Produces</code>。<em>你还记得吗？在Producers中我们默认就有一个单例</em></li>
</ul>
<p><code>UserModule.Factory</code> 依赖只是因为app的逻辑原因而添加。</p>
<h2 id="Production-Component"><a href="#Production-Component" class="headerlink" title="Production Component"></a>Production Component</h2><p>现在让我们创建<code>@ProductionComponent</code>，它将会为<code>UserManager</code>实例提供服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ProductionComponent</span>(</span><br><span class="line">        dependencies = AppComponent.class,</span><br><span class="line">        modules = GithubApiProducerModule.class</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppProductionComponent</span> </span>&#123;</span><br><span class="line">    <span class="function">ListenableFuture&lt;UserManager&gt; <span class="title">userManager</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    ListenableFuture&lt;UserModule.Factory&gt; userModuleFactory();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又一次，非常类似原来的<a href="https://github.com/frogermcs/GithubClient/blob/master/app/src/main/java/frogermcs/io/githubclient/AppComponent.java" target="_blank" rel="noopener">Dagger’s @Component</a>。</p>
<p>ProductionComponent的构建也是与标准的Component非常相似：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AppProductionComponent appProductionComponent = DaggerAppProductionComponent.builder()</span><br><span class="line">    .executor(Executors.newSingleThreadExecutor())</span><br><span class="line">    .appComponent(appComponent)</span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure>
<p>额外附加的参数是<code>Executor</code>实例，它告诉ProductionComponent依赖应该在哪里（哪个线程）被创建。在我们的例子中我们使用了一个single-thread executor，但是当然增加并行级别并使用多线程执行不是一个问题。</p>
<h2 id="获取依赖"><a href="#获取依赖" class="headerlink" title="获取依赖"></a>获取依赖</h2><p>就像我说的，当前我们不能去使用<code>@Inject</code>注解。相反，我们必须直接询问ProductionComponent（你可以在<a href="https://github.com/frogermcs/GithubClient/blob/master/app/src/main/java/frogermcs/io/githubclient/ui/activity/presenter/SplashActivityPresenter.java" target="_blank" rel="noopener">SplashActivityPresenter</a>找到这些代码）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">appProductionComponent = splashActivity.getAppProductionComponent();</span><br><span class="line">Futures.addCallback(appProductionComponent.userManager(), <span class="keyword">new</span> FutureCallback&lt;UserManager&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(UserManager result)</span> </span>&#123;</span><br><span class="line">        SplashActivityPresenter.<span class="keyword">this</span>.userManager = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里重要的是，对象初始化是在你第一次调用<code>appProductionComponent.userManager()</code>的时候开始的。在这之后<code>UserManager</code>对象将会被缓存。这表示每一个绑定都拥有跟component实例相同的生命周期。</p>
<p>以上几乎就是所有了。当然你应该知道在<code>Future.onSuccess()</code>方法被调用之前userManager实例会时<code>null</code>。</p>
<h2 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h2><p>在最后让我们来看下现在注入的性能是怎么样的：</p>
<p><img src="http://frogermcs.github.io/images/24/after_update.png" alt=""></p>
<p>是的，没错 - 这时平均值大约是15ms。它小于同步注入（平均. 25ms）但是并不如你期望的那样少。这时因为Producers并不像Dagger本身那样轻量。</p>
<p>所以现在取决于你了 - 是否值得使用Guava, Proguard和代码复杂度来做<strong>这种</strong>优化。</p>
<p>请记住，如果你觉得Producers并不是最适合你的app的，你可以在你的app中尝试使用RxJava或者其他异步代码来包装你的注入。</p>
<p>感谢阅读！</p>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3><p>以上描述的完整代码可见Github <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">repository</a>。</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> dependency injection </tag>
            
            <tag> dagger2 </tag>
            
            <tag> DI </tag>
            
            <tag> google </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]Android端ORM框架——RapidORM(v2.1)]]></title>
      <url>/2016/11/01/Android-Android%E7%AB%AFORM%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94RapidORM-v2-1/</url>
      <content type="html"><![CDATA[<h1 id="Android-Android端ORM框架——RapidORM-v2-1"><a href="#Android-Android端ORM框架——RapidORM-v2-1" class="headerlink" title="[Android]Android端ORM框架——RapidORM(v2.1)"></a>[Android]Android端ORM框架——RapidORM(v2.1)</h1><p><strong><a href="https://github.com/wangjiegulu/RapidORM" target="_blank" rel="noopener">RapidORM</a>：Android端轻量高性能的ORM框架</strong></p>
<p><strong>GitHub:</strong> <a href="https://github.com/wangjiegulu/RapidORM" target="_blank" rel="noopener">https://github.com/wangjiegulu/RapidORM</a></p>
<h2 id="RapidORM-v2-1-feature"><a href="#RapidORM-v2-1-feature" class="headerlink" title="RapidORM v2.1 feature"></a>RapidORM v2.1 feature</h2><p>1. 在执行SQL和创建表时提升性能。</p>
<p>2. 提升bind参数时的性能</p>
<p>3. Index支持。</p>
<p>4. 上传至Maven中心库。</p>
<h2 id="关于-RapidORM"><a href="#关于-RapidORM" class="headerlink" title="关于 RapidORM"></a>关于 RapidORM</h2><ul>
<li><p>主键支持任何类型，支持联合主键。</p>
</li>
<li><p>非反射执行SQL。</p>
</li>
<li><p>高性能。</p>
</li>
<li><p>兼容 <code>android.database.sqlite.SQLiteDatabase</code>、 <code>net.sqlcipher.database.SQLiteDatabase</code>以及更多加密实现。</p>
</li>
<li><p>友好的面向对象接口调用。</p>
</li>
<li><p>Index支持。</p>
</li>
<li><p>联表查询未支持。</p>
</li>
</ul>
<p><code>v2.0</code> blog: <a href="http://www.cnblogs.com/tiantianbyconan/p/5626716.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5626716.html</a></p>
<p><code>v1.0</code> blog: <a href="http://www.cnblogs.com/tiantianbyconan/p/4748077.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4748077.html</a></p>
<h2 id="怎么使用"><a href="#怎么使用" class="headerlink" title="怎么使用"></a>怎么使用</h2><h3 id="1-build-gradle-添加依赖"><a href="#1-build-gradle-添加依赖" class="headerlink" title="1. build.gradle 添加依赖"></a>1. <code>build.gradle</code> 添加依赖</h3><h3 id="Gadle-获取最新版本"><a href="#Gadle-获取最新版本" class="headerlink" title="Gadle(获取最新版本)"></a>Gadle(<a href="http://search.maven.org/#search%7Cga%7C1%7CRapidORM" target="_blank" rel="noopener">获取最新版本</a>)</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">"com.github.wangjiegulu:rapidorm:x.x.x"</span></span><br><span class="line"></span><br><span class="line">compile <span class="string">"com.github.wangjiegulu:rapidorm-api:x.x.x"</span></span><br><span class="line"></span><br><span class="line">apt <span class="string">"com.github.wangjiegulu:rapidorm-compiler:x.x.x"</span></span><br></pre></td></tr></table></figure>
<h3 id="Maven-获取最新版本"><a href="#Maven-获取最新版本" class="headerlink" title="Maven(获取最新版本)"></a>Maven(<a href="http://search.maven.org/#search%7Cga%7C1%7CRapidORM" target="_blank" rel="noopener">获取最新版本</a>)</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.wangjiegulu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rapidorm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>x.x.x<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>具体使用方式见：</p>
<blockquote>
<p><code>v2.0</code> blog: <a href="http://www.cnblogs.com/tiantianbyconan/p/5626716.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5626716.html</a></p>
<p><code>v1.0</code> blog: <a href="http://www.cnblogs.com/tiantianbyconan/p/4748077.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4748077.html</a></p>
</blockquote>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> library </tag>
            
            <tag> sqlite </tag>
            
            <tag> database </tag>
            
            <tag> orm </tag>
            
            <tag> rapidorm </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]使用MVP解决技术债务（翻译）]]></title>
      <url>/2016/09/21/Android-%E4%BD%BF%E7%94%A8MVP%E8%A7%A3%E5%86%B3%E6%8A%80%E6%9C%AF%E5%80%BA%E5%8A%A1%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="使用MVP解决技术债务"><a href="#使用MVP解决技术债务" class="headerlink" title="使用MVP解决技术债务"></a>使用MVP解决技术债务</h1><blockquote>
<p>原文：<a href="https://medium.com/picnic-engineering/tackling-technical-debt-with-mvp-67e805ed5103#.couu0d5i0" target="_blank" rel="noopener">https://medium.com/picnic-engineering/tackling-technical-debt-with-mvp-67e805ed5103#.couu0d5i0</a></p>
</blockquote>
<p>免责申明：这篇博客并不是讲关于怎么使用MVP的方式（上帝知道关于这些已经太多了）去写Android代码。而仅仅是我的个人经验，关于怎么转换我们的表现层到MVP架构来帮助我们解决一些累积的技术债务，而且在这个过程中也会帮助我们的app从一个原型转变成一个更具维护性的产品。</p>
<p>任何从事Android工作足够久、项目足够大的开发者最有可能达到一个点，他们面对他们的代码库，觉得应该有更好的实现方案。我们在Picnic也是一样，在Android app开发开始后大约八个月，我们到达了的那一刻，就在我们向公众发布第一个版本的时候。</p>
<p>这一刻正好是在我们app推出的时候这也并不意外。直到那时，我们以一个非常快的速度在前进，不断敲打我们的键盘，从零开始构建一个完整的产品，尝试新的东西，结合用户反馈到我们的app中，在每天的基础上增加和丢弃特性。</p>
<p>为了跟上公司的速度我们砍掉了这里那里的边边角角。这样的工作对我们来说很好，这也是我们能够在这么短的时间内构建这个app的原因之一。但是正如预期那样，最后这些决定的影响开始以技术债务的形式显示出来。幸运的是这些技术债务是在数月之内建立的，在app的性能和稳定性上面并没有任何真正的影响。反而我们是在其它领域开始注意到它：</p>
<ul>
<li>新功能迭代时间的增加。</li>
<li>新入职的开发者遇到困难</li>
<li>它被证实难以实现自动化测试</li>
<li>整体功能的复杂性在增加</li>
</ul>
<p>我们已经有了一个很好的想法和一个易于理解的架构，用于网络层、错误处理和app内部模块通信。但是像大多数Android开发者，我们会对把太多的逻辑放进Activity和Fragment中会产生内疚。</p>
<p>旁注：这是Android开发者的共同的问题，而作为开发者需要在黑暗中摸索，因为Google对这个话题保持沉默。我们从它们那里得到的第一个（算是）官方回复是来自Android团队的一个开发者在 <a href="https://plus.google.com/+DianneHackborn/posts/FXCCYxepsDU" target="_blank" rel="noopener">Google+ post</a>，说明我们应该把核心的Android API作为一个‘系统框架’，意味着他们会带我们手把手地到达Android核心的组件（Activity, BroadcastReceiver, Service 和 ContentProvider）。之后我们做什么都是看我们自己了。而且就在最近，Google终于提供了一系列的例子用来解决关于怎么构建一个Android app的共同问题，它着重于MVP。尽管只是beta，但是它可以在这里查看：<a href="https://github.com/googlesamples/android-architecture" target="_blank" rel="noopener">Android Architecture Blueprints</a>。</p>
<p>无论如何，这其实是一件好事，因为这意味着我们可以自由地去实验任何我们喜欢的方式，而不是被强制在一个平台遵循一个特定的模式。</p>
<p>现在讲回我们的故事… 除非你处在Android开发世界的远古时期，你应该会注意到表现层架构是现在的热门。关于最好的方式是什么，每个人甚至连他妈妈似乎都有自己的观点。工作中标准的Android方式（类似MVC），到MVP，到通过data-binding的MVVM，所有的方式都沿用了 Uncle Bob 的 <em>clean architecture</em>。每一种方式围绕赞成或者反对的意见都有一些有趣的讨论，但是有一件事我们要明确知道，那就是我们应该避免喝Kool-Aid<em>（译者注：这里是比喻，表示非常愚昧地接受信奉某种观点或者思想）</em>和期望其中一种是银色子弹<em>（译者注：这里是比喻为具有极端有效性的解决方法）</em>然后永远解决所有问题。</p>
<p>当在考虑怎么去重构我们的表现层时，我们已经有近一年的代码库的积累，我们很清楚我们的缺陷在哪里，然后我们需要使用一个新的实现（以上主要表示一些能够解决我们的技术债务的点）来达到我们的目标。我们在虚拟的项目中试玩了一些，体验了各种方法的不同之处，然后最终决定使用MVP。从它的核心来说，MVP本身仅仅是一个概念，而Android框架，根据设计，并不强制任何模式，我们可以自由地选择实际的实现细节。</p>
<p>在Android团队中，首先我们是不过度工程的信徒，让代码随着时间的推移自然地发展，而不是过早地在试图为自己不可预知的未来做准备的抽象之上增加抽象。正因为这个原因，我们选择另一风味的MVP，使得可以最低限度地保持我们的抽象层次。在代码级别，这意味着有一个单独的接口来表示View。所有其它的组件都是具体的类。你可能会问自己，怎么会只有View使用接口？考虑到我们迫切的需要，这是真正受益于这样的接口的唯一的组件，因为我们实际上有不同的具体的Views来共享相同的接口。所以在我们的案例中，这里的一个接口将被允许我们去重用Presenters。一些MVP实现建议给所有组件（M，V和P）设置接口。尽管这样会工作得很完美，但是我们在较早的阶段并不提倡，因为添加之后的成本是代码可读性和维护性，尤其是当我们考虑到新入职对MVP陌生的初级开发者的时候，好处超过面向接口编程的方式。</p>
<p>相比其他，MVP实现是非常标准的。View（Activity，Fragment或者一个自定义View）负责创造和维护Presenter，而Presenter处理各种业务相关的逻辑（数据获取，存储，格式化等等），然后根据需要通过更新UI回调到View。在我们的案例中，数据层已经是相当模块化了，构造用于表示数据模型的POJOs，以及一个预先存在的控制层用于处理网络通信。</p>
<p>这是一个非常标准的MVP设置，也因为它很简单，我们可以在几周的时间内替换几乎我们的所有的UI代码。因为我们已经存在独立的数据层来处理所有与后端的API交互，所以真正需要重构的只是Views和Presenters的交互。</p>
<p>在重构的过程中，我们也学习了一些可能会派得上用场的东西：</p>
<ul>
<li><p><strong>生命周期：</strong>因为Presenter是View创建的，我们需要确保完全地理解View的生命周期，特别是因为它将最有可能去处理状态更新和异步数据。举个例子，每一个Presenter应该在View destroyed的情况下有一个取消异步任务的方式，或者应该在用户暂停或者恢复视图事件时重置到原始状态等等。最后但同样重要的是，当View已经被销毁，试图从Presenter去更新View元素，始终需要注意可怕的NPEs。</p>
</li>
<li><p><strong>保持Views尽可能地愚蠢：</strong>我们的Views应该不再包含任何业务相关的逻辑。它应该只包含Android框架inflate和设置View的这些最低限度的东西。任何用户交互应该派发到Presenter。根据经验，如果你的views有任何其它方法去更新UI元素或者响应用户触发的事件，那么你可能应该去检查它们的实现。</p>
</li>
<li><p><strong>保持Presenter尽可能地纯粹：</strong>这一点，我们的意思时你应该尽可能地避免有Android相关的代码在你的presenters中。为这些组件编写纯粹的单元测试，而不需要使用其它如Robolectric等测试框架，这明显地得到了简化。这明显说起来比做起来容易得多，因为你终归会在某些地方遇到这种情况，举个例子，你将需要有一个Context的引用用来比如数据加载、访问strings文件等等。</p>
</li>
</ul>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>那么，说了那么多，最终的结论是什么呢？总的来说，我很高兴使用了MVP。它一定程度上帮我们解决了我们快速开发所累积的技术债务，然后，我们准备了更多来针对第二阶段的开发。</p>
<p>一些值得一提的事情：</p>
<ul>
<li><p><strong>测试数：</strong>在重构之前，测试的数量用两只手都可以数得过来。这是一个巨大的任务来针对包含了所有逻辑如执行数据解析、格式化、网络请求、错误处理和管理自己的生命周期的Activity编写测试。仅思考如果在这些条件下编写测试就足以让我们去寻找其它的方式了。一旦转换我们的第一份代码到MVP，对此编写测试就变得碎片化了。通过一个清晰的合同明确什么View能够处理，我们可以把自己的代码与Android UI框架隔离开，然后仅仅测试实际调用的是否是正确的方法，并给出每个测试场景。现在实际的业务相关逻辑被放置在Presenters中，因为它们绝大多数都不需要有Android OS相关的认知（或者小部分相关的可以被mocked），我们也可以针对它们编写非常有效率的单元测试，因此，在过去几个月里，我们的测试用例从原来的10增加到900，而且还在增长中。</p>
</li>
<li><p><strong>可预见性：</strong>这个是有一点软度量，但是非常强大的一点。针对UI，我们选择并坚持一个通用的模式，我可以在代码库中获得可预见的好处。这意味着，无论是哪种开发者眼里的UI元素（Activity，Dialog，Fragment等等），如果理解其中一个怎么工作，那也就能理解所有怎么工作。打开一个就算不是你写的文件也不再会遇到让你觉得惊喜的东西了。明确规定职责，每一单个的UI组件都遵循相同的明确的模式。让新入职的新开发者从第一天起就是高效的，这是非常宝贵的。</p>
</li>
</ul>
<p>我们别忘记MVP并不只是用于表现层，但是作为前端开发人员，这里花费了我们太多的时间。所以努力去寻找一个解决方案来给我们带来更好的可预见性和在新的开发者加入我们的时候也能让我们快速迭代是值得的。经过全面的考虑，我们可以有把握地说MVP是可以帮助我们达到这个目标的一个重要的里程碑。</p>
<p>P.S. 如果你仍然渴望看到一些源代码，这里有一个我们MVP实现‘忘记密码’用例的剥离下来的版本，展示MVP组件与用户的交互，用户点击‘重置密码’按钮进入他们的邮件地址（为保持代码的简洁，Android模版代码已经移除）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BasePresenter.java (Base class for all our Presenters)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePresenter</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> WeakReference&lt;V&gt; mView;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindView</span><span class="params">(@NonNull V view)</span> </span>&#123;</span><br><span class="line">    mView = <span class="keyword">new</span> WeakReference&lt;&gt;(view);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbindView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mView = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> V <span class="title">getView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> mView.get();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isViewAttached</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mView != <span class="keyword">null</span> &amp;&amp; mView.get() != <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IForgotPasswordView.java (view interface)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IForgotPasswordView</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">showLoading</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">hideLoading</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setEmailText</span><span class="params">(String email)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">showEmailNotValidError</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">showPasswordRequestOk</span><span class="params">(String message)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">showPasswordRequestFail</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ForgotPasswordFragment.java (view implementation)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForgotPasswordFragment</span> <span class="keyword">implements</span> <span class="title">IForgotPasswordView</span>,</span></span><br><span class="line"><span class="class">        <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Triggered by the user clicking a button</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResetPasswordClick</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String email = mEmailEditText.getText().toString();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Forward all logic to the Presenter</span></span><br><span class="line">    mPresenter.requestPasswordChange(email);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ForgotPasswordPresenter.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForgotPasswordPresenter</span> <span class="keyword">extends</span> <span class="title">BasePresenter</span>&lt;<span class="title">IForgotPasswordView</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestPasswordChange</span><span class="params">(String email)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Utils.isEmailValid(email)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Make sure the view is still alive before trying to access it</span></span><br><span class="line">      <span class="keyword">if</span>(isViewAttached()) &#123;</span><br><span class="line">        getView().showEmailNotValidError();    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      requestPasswordChangeAsync(email);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">requestPasswordChangeAsync</span><span class="params">(String email)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update the view's UI elements</span></span><br><span class="line">    <span class="keyword">if</span>(isViewAttached()) &#123;</span><br><span class="line">      getView().hideKeyboard();</span><br><span class="line">      getView().showLoading();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Call our API (results are posted back on an EventBus)</span></span><br><span class="line">      api.forgotPassword(email);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Subscription to the event bus</span></span><br><span class="line">  <span class="meta">@Subscribe</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(<span class="keyword">final</span> Event event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isViewAttached()) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update the view's UI elements</span></span><br><span class="line">      getView().hideLoading();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">switch</span> (event.getType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> FORGOT_PASSWORD_OK:</span><br><span class="line">          getView().showPasswordRequestOk((String) event.getData());</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> FORGOT_PASSWORD_FAILED:</span><br><span class="line">          getView().showPasswordRequestFail();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> mvp </tag>
            
            <tag> framework </tag>
            
            <tag> technical debt </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]异步 layout inflation（翻译）]]></title>
      <url>/2016/09/01/Android-%E5%BC%82%E6%AD%A5-layout-inflation%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="异步-layout-inflation"><a href="#异步-layout-inflation" class="headerlink" title="异步 layout inflation"></a>异步 layout inflation</h1><blockquote>
<p>原文：<a href="&#109;&#x61;&#105;&#108;&#x74;&#111;&#x3a;&#104;&#116;&#116;&#112;&#115;&#x3a;&#47;&#47;&#109;&#x65;&#x64;&#x69;&#117;&#109;&#46;&#x63;&#x6f;&#109;&#x2f;&#64;&#108;&#x75;&#112;&#97;&#x6a;&#x7a;&#47;&#x61;&#115;&#x79;&#x6e;&#x63;&#104;&#x72;&#x6f;&#110;&#111;&#117;&#115;&#x2d;&#108;&#97;&#x79;&#111;&#x75;&#116;&#x2d;&#105;&#x6e;&#102;&#x6c;&#x61;&#116;&#x69;&#x6f;&#x6e;&#45;&#55;&#x63;&#98;&#x63;&#97;&#50;&#54;&#53;&#x33;&#98;&#x66;&#x23;&#46;&#113;&#50;&#50;&#118;&#112;&#x65;&#122;&#103;&#x34;">&#104;&#116;&#116;&#112;&#115;&#x3a;&#47;&#47;&#109;&#x65;&#x64;&#x69;&#117;&#109;&#46;&#x63;&#x6f;&#109;&#x2f;&#64;&#108;&#x75;&#112;&#97;&#x6a;&#x7a;&#47;&#x61;&#115;&#x79;&#x6e;&#x63;&#104;&#x72;&#x6f;&#110;&#111;&#117;&#115;&#x2d;&#108;&#97;&#x79;&#111;&#x75;&#116;&#x2d;&#105;&#x6e;&#102;&#x6c;&#x61;&#116;&#x69;&#x6f;&#x6e;&#45;&#55;&#x63;&#98;&#x63;&#97;&#50;&#54;&#53;&#x33;&#98;&#x66;&#x23;&#46;&#113;&#50;&#50;&#118;&#112;&#x65;&#122;&#103;&#x34;</a></p>
</blockquote>
<p>随着最近发布的<a href="https://developer.android.com/topic/libraries/support-library/revisions.html" target="_blank" rel="noopener">Android Support Library, revision 24</a>，Google开发者在v4包中增加了一个用来异步inflate layouts的帮助类。</p>
<h2 id="进入-AsyncLayoutInflater"><a href="#进入-AsyncLayoutInflater" class="headerlink" title="进入 AsyncLayoutInflater"></a>进入 AsyncLayoutInflater</h2><p>你会发现AsyncLayoutInflater可以使用在当你想要去懒加载你应用中部分UI或者用户行为的响应。这个帮助类将会允许你的UI线程在执行繁重的inflate时继续保持响应。</p>
<p>使用AsyncLayoutInflater你需要在你应用的<strong>UI线程</strong>创建一个它的实例。</p>
<p>假设下面部分代码是你Activity代码中的一部分（我将在这里使用Kotlin语法）：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> inflater = AsyncLayoutInflater(<span class="keyword">this</span>)</span><br></pre></td></tr></table></figure>
<p>然后现在可以通过这个实例inflate你的layout文件：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inflater.inflate(resId: <span class="built_in">Int</span>, parent: ViewGroup)</span><br></pre></td></tr></table></figure>
<p>如你所见，inflate函数接收3个参数。第一个是你layout资源，第二个是可选的view作为预期inflated层次结构的parent，然后第三个是一个<code>OnInflateFinishedListener</code>，是一个回调，一旦layout被inflate完毕它就会被回调（例子中被lambda函数代替）。</p>
<p>比较基本的LayoutInflater的inflate函数，一般使用一个boolean作为第三个参数，它表示是否inflate层次结构应该附属岛一个root参数上面。在我们的inflate函数的异步版本中并没有这样一个参数，大多数情况下你会使用这种方式调用：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">inflater.inflate(resId: <span class="built_in">Int</span>, parent: ViewGroup) </span><br><span class="line">    &#123; view, resid, parent -&gt; parent.addView(view) &#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用AsyncLayoutInflater的缺点"><a href="#使用AsyncLayoutInflater的缺点" class="headerlink" title="使用AsyncLayoutInflater的缺点"></a>使用AsyncLayoutInflater的缺点</h2><p>当然它有如下一些缺点：</p>
<ul>
<li><p>parent的 <code>generateLayoutParams()</code> 函数必须是线程安全的。</p>
</li>
<li><p>所有正在构建的views一定不能创建任何 <code>Handlers</code> 或者调用 <code>Looper.myLooper</code> 函数。</p>
</li>
<li><p>不支持设置<code>LayoutInflater.Factory</code>也不支持<code>LayoutInflater.Factory2</code></p>
</li>
<li><p>不支持包含Fragments的inflating layouts</p>
</li>
</ul>
<p>如果我们尝试异步的方式去inflate的layout不支持这种方式，那么inflation处理将会自动回退到主线程中。</p>
<h2 id="使用Kotlin-Android-Extensions-的-Kotlin的小例子"><a href="#使用Kotlin-Android-Extensions-的-Kotlin的小例子" class="headerlink" title="使用Kotlin Android Extensions 的 Kotlin的小例子"></a>使用Kotlin Android Extensions 的 Kotlin的小例子</h2><p>MainActivity</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">        loadFirst.setOnClickListener &#123; </span><br><span class="line">           loadAsync(R.layout.async) &#123; </span><br><span class="line">             second.text = <span class="string">"I am second TextView"</span> </span><br><span class="line">           &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> MainActivity.<span class="title">loadAsync</span><span class="params">(<span class="meta">@LayoutRes</span> res: <span class="type">Int</span>, </span></span></span><br><span class="line"><span class="function"><span class="params">                           action: <span class="type">View</span>.()</span></span> -&gt; <span class="built_in">Unit</span>) =</span><br><span class="line">    AsyncLayoutInflater(<span class="keyword">this</span>).inflate(res, frame) </span><br><span class="line">    &#123; view, resid, parent -&gt;</span><br><span class="line">        with(parent) &#123;</span><br><span class="line">            addView(view)</span><br><span class="line">            action(view)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/frame"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:padding</span>=<span class="string">"@dimen/activity_vertical_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">"com.cartoon.player.MainActivity"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/loadFirst"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"48dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginBottom</span>=<span class="string">"16dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"Load f async"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>async.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/first"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginBottom</span>=<span class="string">"16dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/second"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginBottom</span>=<span class="string">"16dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> layout </tag>
            
            <tag> inflation </tag>
            
            <tag> asynchronize </tag>
            
            <tag> async </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[HTTP协议详解]]></title>
      <url>/2016/08/29/HTTP%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<div id="editor-reader-full" class="editor-reader-full-shown"><br><div class="reader-full-topInfo-shown">来自:&nbsp;<a href="https://www.zybuluo.com/yangfch3/note/167490" target="_blank" rel="noopener">https://www.zybuluo.com/yangfch3/note/167490</a></div><br><div class="reader-full-topInfo-shown">&nbsp;</div><br><div id="reader-full-topInfo" class="reader-full-topInfo-shown">HTTP协议详解</div><br><div id="wmd-preview" class="wmd-preview wmd-preview-full-reader" data-medium-element="true"><br><br><code>http</code><br><br><em> </em> *<br><br><div class="md-section-divider">&nbsp;</div>

<h3 id="http？"><a href="#http？" class="headerlink" title="http？"></a><code>http</code>？</h3><ul>
<li>全称：超文本传输协议<code>(HyperText Transfer Protocol)</code></li>
<li>作用：设计之初是为了将超文本标记语言<code>(HTML)</code>文档从Web服务器传送到客户端的浏览器。现在<code>http</code>的作用已不局限于<code>HTML</code>的传输。</li>
<li>版本：<code>http/1.0</code>&nbsp;<code>http/1.1*</code>&nbsp;<code>http/2.0</code></li>
</ul>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="两篇佳文"><a href="#两篇佳文" class="headerlink" title="两篇佳文"></a>两篇佳文</h3><p><a href="https://www.zybuluo.com/yangfch3/note/113028" target="_blank" rel="noopener">输入网址之后发生了什么</a>&nbsp;<br><a href="http://rapheal.sinaapp.com/" target="_blank" rel="noopener">Web开发新人培训系列</a></p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="URL详解"><a href="#URL详解" class="headerlink" title="URL详解"></a>URL详解</h3><p>一个示例URL</p>
<pre><code>http://www.mywebsite.com/sj/test;id=8079?name=sviergn&amp;amp;x=true#stuff

Schema: http
host: www.mywebsite.com
path: /sj/test
URL params: id=8079
Query String: name=sviergn&amp;amp;x=true
Anchor: stuff
</code></pre><ul>
<li><code>scheme</code>：指定低层使用的协议(例如：<code>http</code>,&nbsp;<code>https</code>,&nbsp;<code>ftp</code>)</li>
<li><code>host</code>：<code>HTTP</code>服务器的<code>IP</code>地址或者域名</li>
<li><code>port#</code>：<code>HTTP</code>服务器的默认端口是<code>80</code>，这种情况下端口号可以省略。如果使用了别的端口，必须指明，例如<code>http://www.mywebsite.com:8080/</code></li>
<li><code>path</code>：访问资源的路径</li>
<li><code>url-params</code></li>
<li><code>query-string</code>：发送给<code>http</code>服务器的数据</li>
<li><code>anchor</code>：锚</li>
</ul>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="无状态的协议"><a href="#无状态的协议" class="headerlink" title="无状态的协议"></a>无状态的协议</h3><p><code>http</code>协议是无状态的：</p>
<blockquote>
<p>同一个客户端的这次请求和上次请求是没有对应关系，对http服务器来说，它并不知道这两个请求来自同一个客户端。</p>
</blockquote>
<p>解决方法：<code>Cookie</code>机制来维护状态</p>
<p>既然Http协议是无状态的，那么<code>Connection:keep-alive</code>&nbsp;又是怎样一回事？</p>
<blockquote>
<p>无状态是指协议对于事务处理没有记忆能力，服务器不知道客户端是什么状态。从另一方面讲，打开一个服务器上的网页和你之前打开这个服务器上的网页之间没有任何联系。</p>
</blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="http消息结构"><a href="#http消息结构" class="headerlink" title="http消息结构"></a><code>http</code>消息结构</h3><ol>
<li><code>Request</code>&nbsp;消息的结构：三部分</li>
</ol>
<blockquote>
<p>第一部分叫<code>Request line</code>（请求行）， 第二部分叫<code>http header</code>, 第三部分是<code>body</code></p>
<pre><code>*   请求行：包括`http`请求的种类，请求资源的路径，`http`协议版本
*   `http header`：`http`头部信息
*   `body`：发送给服务器的`query`信息&amp;nbsp;
</code></pre><p>当使用的是”<code>GET</code>“ 方法的时候，<code>body</code>是为空的（<code>GET</code>只能读取服务器上的信息，<code>post</code>能写入）&nbsp;</p>
<pre><code>    1.  `&lt;span class=&quot;pln&quot;&gt;GET &lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;pln&quot;&gt;hope&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;pln&quot;&gt; HTTP&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;1.1&lt;span class=&quot;pln&quot;&gt;   &lt;span class=&quot;com&quot;&gt;//---请求行&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
2.  `&lt;span class=&quot;typ&quot;&gt;Host&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; ce&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;sysu&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;edu&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;cn&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
3.  `&lt;span class=&quot;typ&quot;&gt;Accept&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;pun&quot;&gt;*&lt;span class=&quot;com&quot;&gt;/*&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
4.  `&lt;span class=&quot;com&quot;&gt;Accept-Encoding: gzip, deflate, sdch&lt;/span&gt;`
5.  `&lt;span class=&quot;com&quot;&gt;Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.6&lt;/span&gt;`
6.  `&lt;span class=&quot;com&quot;&gt;Cache-Control: max-age=0&lt;/span&gt;`
7.  `&lt;span class=&quot;com&quot;&gt;Cookie:.........&lt;/span&gt;`
8.  `&lt;span class=&quot;com&quot;&gt;Referer: http://ce.sysu.edu.cn/hope/&lt;/span&gt;`
9.  `&lt;span class=&quot;com&quot;&gt;User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.130 Safari/537.36&lt;/span&gt;`
</code></pre><p>10.11.  <code>&lt;span class=&quot;com&quot;&gt;---分割线---&lt;/span&gt;</code><br>12.13.  <code>&lt;span class=&quot;com&quot;&gt;POST /hope/ HTTP/1.1   //---请求行&lt;/span&gt;</code></p>
<pre><code>14.  `&lt;span class=&quot;com&quot;&gt;Host: ce.sysu.edu.cn&lt;/span&gt;`
15.  `&lt;span class=&quot;com&quot;&gt;Accept: */&lt;span class=&quot;pun&quot;&gt;*&lt;/span&gt;&lt;/span&gt;`
16.  `&lt;span class=&quot;typ&quot;&gt;Accept&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Encoding&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; gzip&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt; deflate&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt; sdch&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
17.  `&lt;span class=&quot;typ&quot;&gt;Accept&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Language&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; zh&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;pln&quot;&gt;CN&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt;zh&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt;q&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;lit&quot;&gt;0.8&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt;zh&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;pln&quot;&gt;TW&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt;q&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;lit&quot;&gt;0.6&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
18.  `&lt;span class=&quot;typ&quot;&gt;Cache&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Control&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; max&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;pln&quot;&gt;age&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;lit&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
19.  `&lt;span class=&quot;typ&quot;&gt;Cookie&lt;span class=&quot;pun&quot;&gt;:.........&lt;/span&gt;&lt;/span&gt;`
20.  `&lt;span class=&quot;typ&quot;&gt;Referer&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; http&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;com&quot;&gt;//ce.sysu.edu.cn/hope/&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
21.  `&lt;span class=&quot;typ&quot;&gt;User&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Agent&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Mozilla&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;5.0&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;pun&quot;&gt;(&lt;span class=&quot;typ&quot;&gt;Windows&lt;span class=&quot;pln&quot;&gt; NT &lt;span class=&quot;lit&quot;&gt;10.0&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt; WOW64&lt;span class=&quot;pun&quot;&gt;)&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;AppleWebKit&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;537.36&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;pun&quot;&gt;(&lt;span class=&quot;pln&quot;&gt;KHTML&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt; like &lt;span class=&quot;typ&quot;&gt;Gecko&lt;span class=&quot;pun&quot;&gt;)&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Chrome&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;44.0&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;lit&quot;&gt;2403.130&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Safari&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;537.36&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
</code></pre><p>22.23.  <code>&lt;span class=&quot;pun&quot;&gt;...&lt;span class=&quot;pln&quot;&gt;body&lt;span class=&quot;pun&quot;&gt;...&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;</code></p>
</blockquote>
<ol>
<li>Response消息的结构</li>
</ol>
<blockquote>
<p>也分为三部分，第一部分叫request line, 第二部分叫request header，第三部分是body</p>
<pre><code>*   `request line`：协议版本、状态码、`message`
*   `request header`：`request`头信息
*   `body`：返回的请求资源主体&amp;nbsp;

    1.  `&lt;span class=&quot;pln&quot;&gt;HTTP&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;1.1&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;200&lt;span class=&quot;pln&quot;&gt; OK&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    2.  `&lt;span class=&quot;typ&quot;&gt;Accept&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Ranges&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; bytes&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    3.  `&lt;span class=&quot;typ&quot;&gt;Content&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Encoding&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; gzip&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    4.  `&lt;span class=&quot;typ&quot;&gt;Content&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Length&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;4533&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    5.  `&lt;span class=&quot;typ&quot;&gt;Content&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Type&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; text&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;pln&quot;&gt;html&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    6.  `&lt;span class=&quot;typ&quot;&gt;Date&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Sun&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;06&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Sep&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;2015&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;07&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;lit&quot;&gt;56&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;lit&quot;&gt;07&lt;span class=&quot;pln&quot;&gt; GMT&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    7.  `&lt;span class=&quot;typ&quot;&gt;ETag&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;str&quot;&gt;&quot;2788e6e716e7d01:0&quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    8.  `&lt;span class=&quot;typ&quot;&gt;Last&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Modified&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Fri&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;04&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Sep&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;2015&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;13&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;lit&quot;&gt;37&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;lit&quot;&gt;55&lt;span class=&quot;pln&quot;&gt; GMT&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    9.  `&lt;span class=&quot;typ&quot;&gt;Server&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Microsoft&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;pln&quot;&gt;IIS&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;7.5&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    10.  `&lt;span class=&quot;typ&quot;&gt;Vary&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Accept&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Encoding&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    11.  `&lt;span class=&quot;pln&quot;&gt;X&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Powered&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;By&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; ASP&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;NET&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
</code></pre><p>12.13.  <code>&lt;span class=&quot;pun&quot;&gt;&amp;lt;!&lt;span class=&quot;pln&quot;&gt;DOCTYPE html&lt;span class=&quot;pun&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;</code></p>
<pre><code>14.  `&lt;span class=&quot;pun&quot;&gt;...&lt;/span&gt;`
15.  `&lt;span class=&quot;pun&quot;&gt;&amp;lt;&amp;gt;&lt;/span&gt;`
16.  `&lt;span class=&quot;pun&quot;&gt;...&lt;/span&gt;`
</code></pre></blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="get-nbsp-和-nbsp-post-nbsp-区别"><a href="#get-nbsp-和-nbsp-post-nbsp-区别" class="headerlink" title="get&nbsp;和&nbsp;post&nbsp;区别"></a><code>get</code>&nbsp;和&nbsp;<code>post</code>&nbsp;区别</h3><p><code>http</code>协议定义了很多与服务器交互的方法，最基本的有4种，分别是<code>GET</code>,<code>POST</code>,<code>PUT</code>,<code>DELETE</code>。 一个<code>URL</code>地址用于描述一个网络上的资源，而<code>HTTP</code>中的<code>GET</code>,&nbsp;<code>POST</code>,&nbsp;<code>PUT</code>,&nbsp;<code>DELETE</code>&nbsp;就对应着对这个资源的查，改，增，删4个操作。 我们最常见的就是<code>GET</code>和<code>POST</code>了。<code>GET</code>一般用于获取/查询资源信息，而POST一般用于更新资源信息.</p>
<ol>
<li><p><code>GET</code>&nbsp;提交的数据会放在<code>URL</code>之后，以<code>?</code>分割<code>URL</code>和传输数据，参数之间以<code>&amp;amp;</code>相连，如<code>EditPosts.aspx?name=test1&amp;amp;id=123456</code>。<code>POST</code>&nbsp;方法是把提交的数据放在<code>HTTP</code>包的<code>Body</code>中。</p>
</li>
<li><p><code>GET</code>&nbsp;提交的数据大小有限制（因为浏览器对<code>URL</code>的长度有限制），而<code>POST</code>方法提交的数据没有限制.</p>
</li>
<li><p><code>GET</code>&nbsp;方式需要使用<code>Request.QueryString</code>&nbsp;来取得变量的值，而<code>POST</code>方式通过<code>Request.Form</code>来获取变量的值。</p>
</li>
<li><p><code>GET</code>&nbsp;方式提交数据，会带来安全问题，比如一个登录页面，通过<code>GET</code>方式提交数据时，用户名和密码将出现在<code>URL</code>上，如果页面可以被缓存或者其他人可以访问这台机器，就可以从历史记录获得该用户的账号和密码.&nbsp;</p>
<p><a href="https://www.zybuluo.com/yangfch3/note/123476" target="_blank" rel="noopener">HTTP请求的Get与Post</a></p>
</li>
</ol>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h3><p><code>Response</code>&nbsp;消息中的第一行叫做状态行，由<code>HTTP</code>协议版本号，&nbsp;状态码，&nbsp;状态消息&nbsp;三部分组成。</p>
<p>状态码用来告诉<code>HTTP</code>客户端，<code>HTTP</code>服务器是否产生了预期的<code>Response</code>.</p>
<p><code>HTTP/1.1</code>中定义了 5 类状态码。</p>
<p>状态码由三位数字组成，第一个数字定义了响应的类别</p>
<ul>
<li><code>1XX</code>&nbsp;提示信息 - 表示请求已被成功接收，继续处理</li>
<li><code>2XX</code>&nbsp;成功 - 表示请求已被成功接收，理解，接受</li>
<li><code>3XX</code>&nbsp;重定向 - 要完成请求必须进行更进一步的处理</li>
<li><code>4XX</code>&nbsp;客户端错误 - 请求有语法错误或请求无法实现</li>
<li><p><code>5XX</code>&nbsp;服务器端错误 - 服务器未能实现合法的请求</p>
<ol>
<li><code>200 OK</code>&nbsp;<br>请求被成功地完成，所请求的资源发送回客户端</li>
<li><code>302 Found</code>&nbsp;<br>重定向，新的<code>URL</code>会在<code>response</code>中的<code>Location</code>中返回，浏览器将会使用新的<code>URL</code>发出新的<code>Request</code></li>
<li><code>304 Not Modified</code>&nbsp;<br>文档已经被缓存，直接从缓存调用</li>
<li><code>400 Bad Request</code>&nbsp;<br>客户端请求与语法错误，不能被服务器所理解&nbsp;<br><code>403 Forbidden</code>&nbsp;<br>服务器收到请求，但是拒绝提供服务&nbsp;<br><code>404 Not Found</code>&nbsp;<br>请求资源不存在</li>
<li><code>500 Internal Server Error</code>&nbsp;<br>服务器发生了不可预期的错误&nbsp;<br><code>503 Server Unavailable</code>&nbsp;<br>服务器当前不能处理客户端的请求，一段时间后可能恢复正常</li>
</ol>
</li>
</ul>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="http-reauest-header"><a href="#http-reauest-header" class="headerlink" title="http reauest header"></a>http reauest header</h3><p><code>http</code>&nbsp;请求头包括很多键值对，这些键值对有什么意义与作用？如何根据功能为他们分一下组呢？</p>
<ol>
<li><p><code>cache</code>&nbsp;头域</p>
<ul>
<li><code>If-Modified-Since</code>&nbsp;<br>用法：<code>If-Modified-Since: Thu, 09 Feb 2012 09:07:57 GMT</code></li>
</ul>
<p>把浏览器端缓存页面的最后修改时间发送到服务器去，服务器会把这个时间与服务器上实际文件的最后修改时间进行对比。如果时间一致，那么返回304，客户端就直接使用本地缓存文件。如果时间不一致，就会返回200和新的文件内容。客户端接到之后，会丢弃旧文件，把新文件缓存起来，并显示在浏览器中。&nbsp;</p>
<pre><code>*   `If-None-Match`&amp;nbsp;
</code></pre><p>用法：<code>If-None-Match: &quot;03f2b33c0bfcc1:0&quot;</code></p>
<p><code>If-None-Match</code>和<code>ETag</code>一起工作，工作原理是在<code>HTTP Response</code>中添加<code>ETag</code>信息。 当用户再次请求该资源时，将在<code>HTTP Request</code>&nbsp;中加入<code>If-None-Match</code>信息(<code>ETag</code>的值)。如果服务器验证资源的<code>ETag</code>没有改变（该资源没有更新），将返回一个<code>304</code>状态告诉客户端使用本地缓存文件。否则将返回<code>200</code>状态和新的资源和<code>Etag</code>. 使用这样的机制将提高网站的性能&nbsp;</p>
<pre><code>*   `Pragma`：`Pragma: no-cache`&amp;nbsp;
</code></pre><p><code>Pargma</code>只有一个用法， 例如：&nbsp;<code>Pragma: no-cache</code></p>
<p>作用： 防止页面被缓存， 在<code>HTTP/1.1</code>版本中，它和<code>Cache-Control:no-cache</code>作用一模一样&nbsp;</p>
<pre><code>*   `Cache-Control`&amp;nbsp;
</code></pre><p>用法：</p>
<pre><code>    *   `Cache-Control:Public`&amp;nbsp;可以被任何缓存所缓存（）
*   `Cache-Control:Private`&amp;nbsp;内容只缓存到私有缓存中
*   `Cache-Control:no-cache`&amp;nbsp;所有内容都不会被缓存
</code></pre><p>作用：用来指定<code>Response-Request</code>遵循的缓存机制</p>
</li>
<li><p><code>Client</code>&nbsp;头域</p>
<ul>
<li><code>Accept</code>&nbsp;<br>用法：<code>Accept: */*</code>，<code>Accept: text/html</code></li>
</ul>
<p>作用： 浏览器端可以接受的媒体类型；&nbsp;<br><code>Accept: */*</code>&nbsp;代表浏览器可以处理所有回发的类型，(一般浏览器发给服务器都是发这个）&nbsp;<br><code>Accept: text/html</code>&nbsp;代表浏览器可以接受服务器回发的类型为&nbsp;<code>text/html</code>&nbsp;；如果服务器无法返回<code>text/html</code>类型的数据，服务器应该返回一个<code>406</code>错误(<code>non acceptable</code>)&nbsp;</p>
<pre><code>*   `Accept-Encoding`&amp;nbsp;
</code></pre><p>用法：<code>Accept-Encoding: gzip, deflate</code></p>
<p>作用： 浏览器申明自己接收的文件编码方法，通常指定压缩方法，是否支持压缩，支持什么压缩方法（<code>gzip</code>，<code>deflate</code>），（注意：这不是指字符编码）&nbsp;</p>
<pre><code>*   `Accept-Language`&amp;nbsp;
</code></pre><p>用法：<code>Accept-Language: en-us</code></p>
<p>作用： 浏览器申明自己接收的语言。&nbsp;</p>
<pre><code>语言跟字符集的区别：中文是语言，中文有多种字符集，比如`big5`，`gb2312`，`gbk`等等；&amp;nbsp;

*   `User-Agent`&amp;nbsp;
</code></pre><p>用法：&nbsp;<code>User-Agent: Mozilla/4.0......</code></p>
<p>作用：告诉<code>HTTP</code>服务器， 客户端使用的操作系统和浏览器的名称和版本.&nbsp;</p>
<pre><code>*   `Accept-Charset`&amp;nbsp;
</code></pre><p>用法：<code>Accept-Charset：utf-8</code></p>
<p>作用：浏览器申明自己接收的字符集，这就是本文前面介绍的各种字符集和字符编码，如gb2312，utf-8（通常我们说Charset包括了相应的字符编码方案）&nbsp;</p>
</li>
<li><p><code>Cookie/Login</code>&nbsp;头域</p>
<ul>
<li><p><code>Cookie</code></p>
<pre><code>1.  `&lt;span class=&quot;typ&quot;&gt;Cookie&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; bdshare_firstime&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;lit&quot;&gt;1439081296143&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt; ASP&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;NET_SessionId&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;pln&quot;&gt;rcqayd4ufldcke0wkbm1vhxb&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt; pgv_pvi&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;lit&quot;&gt;7361416192&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt; pgv_si&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;pln&quot;&gt;s6686106624&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt; ce&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;sysu&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;edu&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;cn80&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;ASPXAUTH&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;lit&quot;&gt;9E099592DD5A414BEECD8CF43CFC71664&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
</code></pre></li>
</ul>
<p>作用：&nbsp;最重要的header, 将<code>cookie</code>的值发送给<code>HTTP</code>&nbsp;服务器</p>
</li>
<li><p><code>Entity</code>&nbsp;头域</p>
<ul>
<li><code>Content-Length</code>&nbsp;<br>用法：<code>Content-Length: 38</code></li>
</ul>
<p>作用：发送给HTTP服务器数据的长度。&nbsp;</p>
<pre><code>*   `Content-Type`&amp;nbsp;
</code></pre><p>用法：<code>Content-Type: application/x-www-form-urlencoded</code></p>
<p>不常出现，一般出现在<code>response</code>头部，用于指定数据文件类型&nbsp;</p>
</li>
<li><p><code>Miscellaneous</code>&nbsp;头域</p>
<ul>
<li><code>Referer</code>&nbsp;<br>用法：<code>Referer: http://ce.sysu.edu.cn/hope/</code></li>
</ul>
<p>作用：提供了<code>Request</code>的上下文信息的服务器，告诉服务器我是从哪个链接过来的，比如从我主页上链接到一个朋友那里，他的服务器就能够从<code>HTTP Referer</code>中统计出每天有多少用户点击我主页上的链接访问他的网站。&nbsp;</p>
</li>
<li><p><code>Transport</code>&nbsp;头域</p>
<ul>
<li><code>Connection</code>&nbsp;<br><code>Connection: keep-alive</code>： 当一个网页打开完成后，客户端和服务器之间用于传输HTTP数据的TCP连接不会关闭，如果客户端再次访问这个服务器上的网页，会继续使用这一条已经建立的连接</li>
</ul>
<p><code>Connection: close</code>： 代表一个<code>Request</code>完成后，客户端和服务器之间用于传输<code>HTTP</code>数据的<code>TCP</code>连接会关闭， 当客户端再次发送<code>Request</code>，需要重新建立<code>TCP</code>连接&nbsp;</p>
<pre><code>*   `Host`&amp;nbsp;
</code></pre><p>用法：<code>Host: ce.sysu.edu.cn</code></p>
<p>作用: 请求报头域主要用于指定被请求资源的<code>Internet</code>主机和端口号（默认80），它通常从<code>HTTP URL</code>中提取出来的</p>
<div class="md-section-divider">&nbsp;</div>

</li>
</ol>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="HTTP-Response-header"><a href="#HTTP-Response-header" class="headerlink" title="HTTP Response header"></a>HTTP Response header</h3><ol>
<li><p><code>Cache</code>&nbsp;头域</p>
<ul>
<li><code>Date</code>&nbsp;<br>用法：<code>Date: Sat, 11 Feb 2012 11:35:14 GMT</code></li>
</ul>
<p>作用: 生成消息的具体时间和日期&nbsp;</p>
<pre><code>*   `Expires`&amp;nbsp;
</code></pre><p>用法：<code>Expires: Tue, 08 Feb 2022 11:35:14 GMT</code>&nbsp;<br>作用: 浏览器会在指定过期时间内使用本地缓存&nbsp;</p>
<pre><code>*   `Vary`&amp;nbsp;
</code></pre><p>用法：Vary: Accept-Encoding&nbsp;</p>
</li>
<li><p><code>Cookie/Login</code>&nbsp;头域</p>
<ul>
<li><code>P3P</code>&nbsp;<br>用法：&nbsp;<br><code>P3P: CP=CURa ADMa DEVa PSAo PSDo OUR BUS UNI PUR INT DEM STA PRE COM NAV OTC NOI DSP COR</code></li>
</ul>
<p>作用: 用于跨域设置Cookie, 这样可以解决<code>iframe</code>跨域访问<code>cookie</code>的问题&nbsp;</p>
<pre><code>*   `Set-Cookie`&amp;nbsp;
</code></pre><p>用法：&nbsp;<br><code>Set-Cookie: sc=4c31523a; path=/; domain=.acookie.taobao.com</code></p>
<p>作用：非常重要的<code>header</code>, 用于把<code>cookie</code>&nbsp;发送到客户端浏览器， 每一个写入<code>cookie</code>都会生成一个<code>Set-Cookie</code>.</p>
</li>
<li><p><code>Entity</code>&nbsp;头域</p>
<ul>
<li><code>ETag</code>&nbsp;<br>用法：<code>ETag: &quot;03f2b33c0bfcc1:0&quot;</code></li>
</ul>
<p>作用: 和<code>request header</code>的<code>If-None-Match</code>&nbsp;配合使用&nbsp;</p>
<pre><code>*   `Last-Modified`&amp;nbsp;
</code></pre><p>用法：<code>Last-Modified: Wed, 21 Dec 2011 09:09:10 GMT</code></p>
<p>作用：用于指示资源的最后修改日期和时间。（实例请看上节的<code>If-Modified-Since</code>的实例）&nbsp;</p>
<pre><code>*   `Content-Type`&amp;nbsp;
</code></pre><p>用法：</p>
<pre><code>    *   Content-Type: text/html; charset=utf-8
*   Content-Type:text/html;charset=GB2312
*   Content-Type: image/jpeg
</code></pre><p>作用：WEB服务器告诉浏览器自己响应的对象的类型和字符集&nbsp;</p>
<pre><code>*   Content-Encoding&amp;nbsp;
</code></pre><p>用法：<code>Content-Encoding：gzip</code></p>
<p>作用：WEB服务器表明自己使用了什么压缩方法（<code>gzip</code>，<code>deflate</code>）压缩响应中的对象。&nbsp;</p>
<pre><code>*   `Content-Language`&amp;nbsp;
</code></pre><p>用法：&nbsp;<code>Content-Language:da</code></p>
<p>WEB服务器告诉浏览器自己响应的对象的语言</p>
</li>
<li><p><code>Miscellaneous</code>&nbsp;头域</p>
<ul>
<li><code>Server</code>&nbsp;<br>用法：<code>Server: Microsoft-IIS/7.5</code></li>
</ul>
<p>作用：指明HTTP服务器的软件信息&nbsp;</p>
<pre><code>*   `X-AspNet-Version`&amp;nbsp;
</code></pre><p>用法：<code>X-AspNet-Version: 4.0.30319</code></p>
<p>作用：如果网站是用<code>ASP.NET</code>开发的，这个<code>header</code>用来表示<code>ASP.NET</code>的版本&nbsp;</p>
<pre><code>*   X-Powered-By&amp;nbsp;
</code></pre><p>用法：<code>X-Powered-By: ASP.NET</code></p>
<p>作用：表示网站是用什么技术开发的&nbsp;</p>
</li>
<li><p><code>Transport</code>头域</p>
<ul>
<li><p><code>Connection</code>&nbsp;<br>用法与作用：&nbsp;</p>
<pre><code>*   `Connection: keep-alive`：当一个网页打开完成后，客户端和服务器之间用于传输HTTP数据的TCP连接不会关闭，如果客户端再次访问这个服务器上的网页，会继续使用这一条已经建立的连接
</code></pre><ul>
<li><code>Connection: close</code>：代表一个Request完成后，客户端和服务器之间用于传输HTTP数据的TCP连接会关闭， 当客户端再次发送Request，需要重新建立TCP连接</li>
</ul>
</li>
</ul>
</li>
<li><p>Location头域</p>
<ul>
<li>Location&nbsp;<br>用法：<code>Location：http://ce.sysu.edu.cn/hope/</code>&nbsp;<br>作用： 用于重定向一个新的位置， 包含新的<code>URL</code>地址</li></ul></li></ol></div><div class="remark-icons"><br><div class="remark-icon unselectable remark-icon-empty" data-anchor-id="1xa3"><span class="icon-stack"><span class="glyph-comment"><span class="remark-count">+</span></span></span></div>





<p></p></div><p></p>
<p></p></div><p></p>
<div class="in-page-preview-buttons in-page-preview-buttons-full-reader">&nbsp;</div><br><div id="reader-full-toolbar" class="reader-full-toolbar-shown">&nbsp;</div>

]]></content>
      
        
        <tags>
            
            <tag> http </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[网络基础]]></title>
      <url>/2016/08/29/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/</url>
      <content type="html"><![CDATA[<div id="editor-reader-full" class="editor-reader-full-shown"><br><div class="reader-full-topInfo-shown"><span style="font-size: 14px; font-family: verdana, Arial, Helvetica, sans-serif; line-height: 1.5;">来自：<a href="https://www.zybuluo.com/yangfch3/note/140188" target="_blank" rel="noopener">https://www.zybuluo.com/yangfch3/note/140188</a></span></div><br><div class="reader-full-topInfo-shown">&nbsp;</div><br><div id="reader-full-topInfo" class="reader-full-topInfo-shown"><code>&lt;span style=&quot;font-size: 2em; font-family: verdana, Arial, Helvetica, sans-serif; line-height: 1.5;&quot;&gt;网络基础&lt;/span&gt;</code></div><br><div id="wmd-preview" class="wmd-preview wmd-preview-full-reader" data-medium-element="true"><br><br><em> </em> *<br><br><div class="md-section-divider">&nbsp;</div>

<h2 id="一次完整的HTTP请求"><a href="#一次完整的HTTP请求" class="headerlink" title="一次完整的HTTP请求"></a>一次完整的HTTP请求</h2><ol>
<li>域名DNS解析，获取对方IP，运算判断是否同一子网&nbsp;<br>hosts –&gt; DNS缓存 –&gt; DNS递归</li>
<li>发起TCP的3次握手，建立TCP连接&nbsp;<br>构建连接请求报文，封装成数据包，路由、ARP到达（不在同一子网时路由+ARP，在同一子网时ARP）</li>
<li>发起http请求&nbsp;<br>构建 HTTP/TCP/IP数据包，路由、ARP到达（同上）</li>
<li>服务器响应http请求，返回数据包&nbsp;<br>构建 HTTP/TCP/IP数据包，路由、ARP到达（同上）</li>
<li>浏览器得到html代码</li>
<li>浏览器解析html代码并再次发起HTTP请求，请求html代码中的资源（如js、css、图片等</li>
<li>浏览器对页面进行渲染呈现给用户</li>
<li>发起TCP四次分手</li>
<li>断开连接</li>
</ol>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h2 id="从握手到分手"><a href="#从握手到分手" class="headerlink" title="从握手到分手"></a>从握手到分手</h2><hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h3><p>三次握手：建立连接前的&nbsp;<code>B/S</code>&nbsp;或&nbsp;<code>C/S</code>&nbsp;交流</p>
<blockquote>
<p>第一次握手：建立连接。客户端发送连接请求报文段，将<code>SYN</code>位置为<code>1</code>，<code>Sequence Number</code>为<code>&#39;xxx&#39;</code>；然后，客户端进入<code>SYN_SEND</code>状态，等待服务器的确认；</p>
<p>第二次握手：服务器收到<code>SYN</code>报文段。服务器收到客户端的<code>SYN</code>报文段，需要对这个<code>SYN</code>报文段进行确认，设置<code>Acknowledgment Number</code>为<code>xxx+1</code>(<code>Sequence Number</code>+1)；同时，自己自己还要发送<code>SYN</code>请求信息，将<code>SYN</code>位置为<code>1</code>，<code>Sequence Number</code>为<code>&#39;yyy&#39;</code>；服务器端将上述所有信息放到一个报文段（即SYN+ACK报文段）中，一并发送给客户端，此时服务器进入<code>SYN_RECV</code>状态；</p>
<p>第三次握手：客户端收到服务器的<code>SYN+ACK</code>报文段。然后将<code>Acknowledgment Number</code>设置为<code>yyy+1</code>(服务器<code>Sequence Number</code>+1)，向服务器发送<code>ACK</code>报文段，这个报文段发送完毕以后，客户端和服务器端都进入<code>ESTABLISHED</code>状态，完成<code>TCP</code>三次握手。连接建立成功。</p>
<p>完成三次握手，主机A与主机B开始传送数据。</p>
</blockquote>
<p>实例:</p>
<blockquote>
<p>IP 192.168.1.116.3337 &gt; 192.168.1.123.7788: S 3626544836:3626544836&nbsp;<br>IP 192.168.1.123.7788 &gt; 192.168.1.116.3337: S 1739326486:1739326486 ack 3626544837&nbsp;<br>IP 192.168.1.116.3337 &gt; 192.168.1.123.7788: ack 1739326487,ack 1</p>
<p>第一次握手：192.168.1.116发送位码<code>SYN</code>＝1,随机产生<code>Sequence number</code>=3626544836的数据包到192.168.1.123,192.168.1.123由<code>SYN</code>=1知道192.168.1.116要求建立联机;</p>
<p>第二次握手：192.168.1.123收到请求后要确认联机信息，向192.168.1.116发送<code>Acknowledgment Number</code>=3626544837,<code>SYN</code>=1,<code>ACK</code>=1,随机产生<code>Sequence Number</code>=1739326486的包;</p>
<p>第三次握手：192.168.1.116收到后检查<code>Acknowledgment Number</code>是否正确，即第一次发送的<code>Sequence Number+1</code>,以及位码<code>ACK</code>是否为1，若正确，192.168.1.116会再发送<code>Acknowledgment Number</code>=1739326487,<code>ACK</code>=1，192.168.1.123收到后确认<code>Sequence Number=Sequence Number+1</code>,<code>ACK</code>=1则连接建立成功。</p>
</blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="四次分手"><a href="#四次分手" class="headerlink" title="四次分手"></a>四次分手</h3><p>当客户端和服务器通过三次握手建立了TCP连接以后，当数据传送完毕，肯定是要断开TCP连接的啊。那对于TCP的断开连接，这里就有了神秘的&ldquo;四次分手&rdquo;。</p>
<blockquote>
<p>第一次分手：主机1（可以是客户端，也可以是服务器端），设置<code>Sequence Number</code>和<code>Acknowledgment Number</code>，向主机2发送一个<code>FIN</code>报文段；此时，主机1进入<code>FIN_WAIT_1</code>状态；这表示主机1没有数据要发送给主机2了；</p>
<p>第二次分手：主机2收到了主机1发送的<code>FIN</code>报文段，向主机1回一个<code>ACK</code>报文段，<code>Acknowledgment Number</code>为<code>Sequence Number</code>加1；主机1进入<code>FIN_WAIT_2</code>状态；主机2告诉主机1，我也没有数据要发送了，可以进行关闭连接了；</p>
<p>第三次分手：主机2向主机1发送<code>FIN</code>报文段，请求关闭连接，同时主机2进入<code>CLOSE_WAIT</code>状态；</p>
<p>第四次分手：主机1收到主机2发送的FIN报文段，向主机2发送<code>ACK</code>报文段，然后主机1进入<code>TIME_WAIT</code>状态；主机2收到主机1的<code>ACK</code>报文段以后，就关闭连接；此时，主机1等待<code>2MSL</code>后依然没有收到回复，则证明<code>Server</code>端已正常关闭，那好，主机1也可以关闭连接了。</p>
</blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="为什么要三次握手"><a href="#为什么要三次握手" class="headerlink" title="为什么要三次握手"></a>为什么要三次握手</h3><p>引自：谢希仁的《计算机网络》</p>
<blockquote>
<p>为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误。</p>
</blockquote>
<p>例子：</p>
<blockquote>
<p>&ldquo;已失效的连接请求报文段&rdquo;的产生在这样一种情况下：client发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达server。本来这是一个早已失效的报文段。但server收到此失效的连接请求报文段后，就误认为是client再次发出的一个新的连接请求。于是就向client发出确认报文段，同意建立连接。假设不采用&ldquo;三次握手&rdquo;，那么只要server发出确认，新的连接就建立了。由于现在client并没有发出建立连接的请求，因此不会理睬server的确认，也不会向server发送数据。但server却以为新的运输连接已经建立，并一直等待client发来数据。这样，server的很多资源就白白浪费掉了。采用&ldquo;三次握手&rdquo;的办法可以防止上述现象发生。例如刚才那种情况，client不会向server的确认发出确认。server由于收不到确认，就知道client并没有要求建立连接。&rdquo;</p>
</blockquote>
<p>所以，三次握手的目的是：防止服务器端一直等待而浪费资源</p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="为什么要四次分手"><a href="#为什么要四次分手" class="headerlink" title="为什么要四次分手"></a>为什么要四次分手</h3><p>那四次分手又是为何呢？<code>TCP</code>协议是一种面向连接的、可靠的、基于字节流的运输层通信协议。<code>TCP</code>是全双工模式，这就意味着，当主机1发出<code>FIN</code>报文段时，只是表示主机1已经没有数据要发送了，主机1告诉主机2，它的数据已经全部发送完毕了；但是，这个时候主机1还是可以接受来自主机2的数据；当主机2返回<code>ACK</code>报文段时，表示它已经知道主机1没有数据发送了，但是主机2还是可以发送数据到主机1的；当主机2也发送了<code>FIN</code>报文段时，这个时候就表示主机2也没有数据要发送了，就会告诉主机1，我也没有数据要发送了，之后彼此就会愉快的中断这次<code>TCP</code>连接。如果要正确的理解四次分手的原理，就需要了解四次分手过程中的状态变化。</p>
<blockquote>
<ul>
<li><p><code>FIN_WAIT_1</code>: 这个状态要好好解释一下，其实<code>FIN_WAIT_1</code>和<code>FIN_WAIT_2</code>状态的真正含义都是表示等待对方的<code>FIN</code>报文。而这两种状态的区别是：<code>FIN_WAIT_1</code>状态实际上是当<code>SOCKET</code>在<code>ESTABLISHED</code>状态时，它想主动关闭连接，向对方发送了<code>FIN</code>报文，此时该<code>SOCKET</code>即进入到<code>FIN_WAIT_1</code>状态。而当对方回应<code>ACK</code>报文后，则进入到<code>FIN_WAIT_2</code>状态，当然在实际的正常情况下，无论对方何种情况下，都应该马上回应<code>ACK</code>报文，所以<code>FIN_WAIT_1</code>状态一般是比较难见到的，而<code>FIN_WAIT_2</code>状态还有时常常可以用<code>netstat</code>看到。（主动方）&nbsp;</p>
</li>
<li><p><code>FIN_WAIT_2</code>：上面已经详细解释了这种状态，实际上<code>FIN_WAIT_2</code>状态下的<code>SOCKET</code>，表示半连接，也即有一方要求<code>close</code>连接，但另外还告诉对方，我暂时还有点数据需要传送给你(<code>ACK</code>信息)，稍后再关闭连接。（主动方）&nbsp;</p>
</li>
<li><p><code>CLOSE_WAIT</code>：这种状态的含义其实是表示在等待关闭。怎么理解呢？当对方<code>close</code>一个<code>SOCKET</code>后发送<code>FIN</code>报文给自己，你系统毫无疑问地会回应一个<code>ACK</code>报文给对方，此时则进入到<code>CLOSE_WAIT</code>状态。接下来呢，实际上你真正需要考虑的事情是察看你是否还有数据发送给对方，如果没有的话，那么你也就可以&nbsp;<code>close</code>这个<code>SOCKET</code>，发送<code>FIN</code>报文给对方，也即关闭连接。所以你在<code>CLOSE_WAIT</code>状态下，需要完成的事情是等待你去关闭连接。（被动方）&nbsp;</p>
</li>
<li><p><code>LAST_ACK</code>: 这个状态还是比较容易好理解的，它是被动关闭一方在发送<code>FIN</code>报文后，最后等待对方的<code>ACK</code>报文。当收到<code>ACK</code>报文后，也即可以进入到<code>CLOSED</code>可用状态了。（被动方）&nbsp;</p>
</li>
<li><p><code>TIME_WAIT</code>: 表示收到了对方的<code>FIN</code>报文，并发送出了<code>ACK</code>报文，就等<code>2MSL</code>后即可回到<code>CLOSED</code>可用状态了。如果<code>FINWAIT1</code>状态下，收到了对方同时带<code>FIN</code>标志和<code>ACK</code>标志的报文时，可以直接进入到<code>TIME_WAIT</code>状态，而无须经过<code>FIN_WAIT_2</code>状态。（主动方）&nbsp;</p>
</li>
<li><p><code>CLOSED</code>: 表示连接中断。</p>
</li>
</ul>
</blockquote>
<p><a href="http://www.jellythink.com/archives/705" target="_blank" rel="noopener">简析TCP的三次握手与四次分手</a></p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h2 id="互联网协议入门（一）"><a href="#互联网协议入门（一）" class="headerlink" title="互联网协议入门（一）"></a>互联网协议入门（一）</h2><div class="md-section-divider">&nbsp;</div>

<h3 id="七层模型与五层模型"><a href="#七层模型与五层模型" class="headerlink" title="七层模型与五层模型"></a>七层模型与五层模型</h3><hr>
<div class="md-section-divider">&nbsp;</div>

<h4 id="七层模型"><a href="#七层模型" class="headerlink" title="七层模型"></a>七层模型</h4><p>七层模型，经典却不实用&nbsp;<br><img src="http://7xjv7y.com1.z0.glb.clouddn.com/OSI_seven.jpg" alt=""></p>
<p>各层的数据封装情况&nbsp;<br><img src="http://jellythink.u.qiniudn.com/jellythinkTCP1.jpg" alt=""></p>
<p>各层的功能与遵从协议&nbsp;<br><img src="http://jellythink.u.qiniudn.com/jellythinkTCP2.gif" alt=""></p>
<p><code>TCP</code>工作在网络<code>OSI</code>的七层模型中的第四层&mdash;&mdash;<code>Transport</code>层，<code>IP</code>在第三层&mdash;&mdash;<code>Network</code>层，<code>ARP</code>在第二层&mdash;&mdash;<code>Data Link</code>层。</p>
<p>在第二层上的数据，我们把它叫<code>Frame</code>，在第三层上的数据叫<code>Packet</code>，第四层的数据叫<code>Segment</code>。</p>
<p>我们需要简单的知道，数据从应用层发下来，会在每一层都会加上头部信息，进行封装，然后再发送到数据接收端。这个基本的流程你需要知道，就是每个数据都会经过数据的封装和解封装的过程。</p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h4 id="五层模型"><a href="#五层模型" class="headerlink" title="五层模型"></a>五层模型</h4><p>把应用层、表示层和会话层合并到应用层，简化为五层模型，原因是为了更加地通俗易懂。&nbsp;<br><img src="http://image.beekka.com/blog/201205/bg2012052902.png" alt=""></p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h5 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h5><p>由于互联网是开放架构，数据来源五花八门，必须事先规定好格式，否则根本无法解读。</p>
<p>“应用层”的作用，就是处理并规定应用程序的数据格式。所以在应用层规定了一系列我们最常用，也很容易看得见的协议，我们的普通用户也许不知道底层的协议情况，但是一定知道这些应用层的协议</p>
<ul>
<li><code>HTTP/HTTPS</code></li>
<li><code>FTP</code></li>
<li><code>SMTP</code></li>
<li><code>DNS</code></li>
</ul>
<p>有不同协议规定&nbsp;电子邮件、网页、FTP 数据&nbsp;的格式，这些应用程序协议就构成了&ldquo;应用层&rdquo;。</p>
<p>这是最高的一层，直接面对用户。它的数据一般包含规范的应用层协议头&nbsp;<br><img src="http://static.zybuluo.com/yangfch3/wv1xh5qhgg969odokvs9t94h/2016-03-27_140636.jpg" alt="2016-03-27_140636.jpg-7kB"></p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h5 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h5><ul>
<li><p>端口：一台主机上运行多个程序，每个需要网络服务的程序都会有自己的主机端口，用于决定到底哪个程序使用那个端口来发送和接收数据包？（不可能每个程序都接收数据包，性能和安全上都划不来）</p>
</li>
<li><p>网卡的不同端口对应不同程序的数据传递</p>
<ol>
<li>1-1023端口是系统占用</li>
<li>1024-65535端口会被应用程序随机分配（在程序没有明确要求用哪个端口的情况下）</li>
</ol>
</li>
<li><p>主机+端口=socket（套接字）</p>
</li>
<li><p>传输层协议：在数据包中加入传输层协议头（TCP/UDP 端口信息)</p>
<ol>
<li>UDP协议&nbsp;<br>在&nbsp;应用层数据&nbsp;中加入&nbsp;端口信息&nbsp;最简单的实现方式，如何个简单法：它的格式几乎就是在数据前面，加上端口号，封装成为&nbsp;<code>UDP</code>&nbsp;数据包。</li>
</ol>
<p>UDP 数据包&nbsp;的总长度不超过&nbsp;<code>65535</code>&nbsp;字节</p>
<pre><code>    *   标头（Head）：定义了发出端口和接收端口，长度只有8字节
*   数据（Data）：来自应用层的具体的数据
</code></pre><blockquote>
<p>缺点：可靠性较差，一旦数据包发出，无法知道对方是否收到，没有确认机制</p>
</blockquote>
<pre><code>2.  TCP 协议&amp;nbsp;
</code></pre><p>近似认为，它就是&nbsp;有确认机制&nbsp;的&nbsp;<code>UDP</code>&nbsp;协议，每发出一个数据包都&nbsp;要求确认。如果有一个数据包遗失，就收不到确认，发出方就知道有必要重发这个数据包。</p>
<p><code>TCP</code>&nbsp;协议能够确保数据不会遗失。它的缺点是过程复杂、实现困难、消耗较多的资源。</p>
<p><code>TCP</code>&nbsp;数据包和&nbsp;<code>UDP</code>&nbsp;数据包一样，但&nbsp;<code>TCP</code>&nbsp;数据包没有长度限制，理论上&nbsp;可以无限长。</p>
</li>
</ul>
<blockquote>
<p>但是为了保证网络的效率，通常&nbsp;<code>TCP</code>&nbsp;数据包的长度不会超过&nbsp;网络层&nbsp;<code>IP</code>&nbsp;数据包&nbsp;的长度，以确保单个&nbsp;<code>TCP</code>数据包不必在下一级的封装中被分割。</p>
</blockquote>
<p>就放在TCP数据包的”数据”部分。因此，现在的以太网的数据包就变成下面这样：</p>
<blockquote>
<p>TCP 数据头&nbsp;&gt;&gt;&nbsp;应用层数据包&nbsp;<br><img src="http://image.beekka.com/blog/201205/bg2012052904.png" alt=""></p>
</blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h5 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h5><ul>
<li><p>传输层已经为我们的数据区分了不同的端口（应用程序）</p>
</li>
<li><p>网络层引进一套新的网络地址协议（<code>Internet Protocol</code>），能区分不同计算机是否属于同一子网</p>
</li>
<li><p>路由：实现不同&nbsp;<code>IP</code>&nbsp;的主机（或服务器）之间的数据包传输</p>
</li>
<li><p><code>IP</code>&nbsp;数据包标头：</p>
<ol>
<li>包含协议版本、长度、<code>IP</code>&nbsp;地址等信息</li>
<li>长度：20-60 字节</li>
</ol>
</li>
<li><p><code>IP</code>&nbsp;数据包整体长度最长不超过&nbsp;<code>65515</code>&nbsp;字节，如果数据包超过了&nbsp;<code>65515</code>&nbsp;字节将会被分割为多个&nbsp;<code>IP</code>&nbsp;数据包发送</p>
</li>
<li><p>数据形式：</p>
</li>
</ul>
<blockquote>
<p>IP 协议头&nbsp;&gt;&gt;&nbsp;TCP 协议头&nbsp;&gt;&gt;&nbsp;应用层数据&nbsp;<br><img src="http://image.beekka.com/blog/201205/bg2012052910.png" alt=""></p>
</blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h5 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h5><ul>
<li><p>遵循协议：<code>以太网协议</code></p>
</li>
<li><p>数据帧：<code>IP</code>&nbsp;数据包&nbsp;到达&nbsp;数据链路层&nbsp;后会进行分割，变为多个小型的数据包，又叫做&nbsp;数据帧</p>
</li>
<li><p>单个数据帧最长为&nbsp;1518&nbsp;字节，最短为&nbsp;64&nbsp;字节</p>
</li>
<li><p><code>数据帧</code>分为两部分：</p>
<ul>
<li>标头（Head）</li>
<li>数据（Data）</li>
</ul>
</li>
<li><p>定位准确地址的方案：<code>MAC</code>&nbsp;地址</p>
</li>
<li><p>数据帧&nbsp;标头：</p>
<ol>
<li>固定&nbsp;<code>18</code>&nbsp;字节</li>
<li>包含数据帧说明项：发送者（MAC地址），接受者（MAC地址），数据类型</li>
</ol>
</li>
<li><p>数据帧&nbsp;最短&nbsp;<code>46</code>&nbsp;字节，最长&nbsp;<code>1500</code>&nbsp;字节</p>
</li>
<li><p>MAC 地址：每块网卡独一无二；48 个二进制&nbsp;===&gt;&nbsp;12 个十六进制&nbsp;===&gt;&nbsp;6 个厂商编码 +6 位网卡流水号</p>
</li>
<li><p><code>ARP</code>（<code>Address Resolution Protocol</code>）：网卡的&nbsp;<code>MAC</code>&nbsp;地址寻址依靠&nbsp;<code>ARP</code>&nbsp;协议 &mdash;&mdash; 同一子网，即数据帧&nbsp;<code>广播</code>，全部网卡接收，比对数据帧标头，符合者接收，不符者丢弃</p>
</li>
<li><p>数据链路层数据格式&nbsp;</p>
</li>
</ul>
<blockquote>
<p><img src="http://image.beekka.com/blog/201205/bg2012052913.png" alt=""></p>
</blockquote>
<p>&nbsp;</p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h5 id="实体层"><a href="#实体层" class="headerlink" title="实体层"></a>实体层</h5><ul>
<li><p>把电脑连接起来的物理手段</p>
</li>
<li><p>在这个层面里，数据帧转换为 传输 0 和 1 的电信号</p>
</li>
</ul>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h5 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h5><ul>
<li><p>上面的讲述了数据从上到下，层层&nbsp;分割，层层&nbsp;包装&nbsp;的过程</p>
</li>
<li><p>解包的过程与上面的过程刚好相反</p>
</li>
<li><p>路由协议用于不同 IP 之间传递数据</p>
</li>
<li><p>ARP 协议用于同一局域网下不同网卡接收数据</p>
</li>
</ul>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h2 id="互联网协议入门（二）"><a href="#互联网协议入门（二）" class="headerlink" title="互联网协议入门（二）"></a>互联网协议入门（二）</h2><p>从用户的角度从上至下看互联网协议</p>
<div class="md-section-divider">&nbsp;</div>

<h3 id="上节小结"><a href="#上节小结" class="headerlink" title="上节小结"></a>上节小结</h3><p>网络通信就是交换数据包。电脑A向电脑B发送一个数据包，后者收到了，回复一个数据包，从而实现两台电脑之间的通信。数据包的结构，基本上是下面这样：</p>
<p><img src="http://image.beekka.com/blog/201205/bg2012052913.png" alt=""></p>
<p>发送这个包，需要知道两个地址：</p>
<blockquote>
<ul>
<li>对方的MAC地址</li>
<li>对方的IP地址</li>
</ul>
</blockquote>
<p>有了这两个地址，数据包才能准确送到接收者手中。但是，前面说过，MAC地址有局限性，如果两台电脑不在同一个子网络，就无法知道对方的MAC地址，必须通过网关（gateway）转发。</p>
<p><img src="http://image.beekka.com/blog/201206/bg2012061101.jpg" alt=""></p>
<p>上图中，1号电脑要向4号电脑发送一个数据包。它先判断4号电脑是否在同一个子网络，结果发现不是（判断方法见下面），于是就把这个数据包发到网关A。网关A通过路由协议，发现4号电脑位于子网络B，又把数据包发给网关B，网关B再转发到4号电脑。</p>
<p>1号电脑把数据包发到网关A，必须知道网关A的MAC地址。所以，数据包的目标地址，实际上分成两种情况：</p>
<table class="table table-striped-white table-bordered" data-anchor-id="qtxz"><br><thead><br><tr><th>场景</th><th>数据包地址</th></tr><br><br></thead><br><tbody><br><tr><br><td>同一个子网络</td><br><td>对方的MAC地址（通过ARP获得），对方的IP地址</td><br><br></tr><br><tr><br><td>非同一个子网络</td><br><td>网关的MAC地址，对方的IP地址</td><br><br></tr><br><br></tbody><br><br></table>

<p>发送数据包之前，电脑必须判断对方是否在同一个子网络，然后选择相应的MAC地址：对方的MAC地址还是网关的MAC地址</p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="用户上网设置"><a href="#用户上网设置" class="headerlink" title="用户上网设置"></a>用户上网设置</h3><p>分为静态IP地址上网和动态IP地址上网&nbsp;</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="动态IP地址"><a href="#动态IP地址" class="headerlink" title="动态IP地址"></a>动态IP地址</h4><p>所谓”动态IP地址”，指计算机开机后，会自动分配到一个IP地址，不用人为设定。它使用的协议叫做DHCP协议。</p>
<p>这个协议规定，每一个子网络中，有一台计算机负责管理本网络的所有IP地址，它叫做”DHCP服务器”。新的计算机加入网络，必须向”DHCP服务器”发送一个”DHCP请求”数据包，申请IP地址和相关的网络参数。</p>
<p>如果两台计算机在同一个子网络，必须知道对方的MAC地址和IP地址，才能发送数据包。但是，新加入的计算机不知道这两个地址，怎么发送数据包呢？&nbsp;</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="DHCP-协议"><a href="#DHCP-协议" class="headerlink" title="DHCP 协议"></a>DHCP 协议</h4><p>DHCP（Dynamic Host Configuration Protocol）是一个局域网的网络协议，使用&nbsp;<code>UDP</code>&nbsp;协议工作.</p>
<p>首先，它是一种应用层协议，建立在&nbsp;<code>UDP</code>&nbsp;协议之上，所以整个数据包是这样的：&nbsp;<br><img src="http://image.beekka.com/blog/201206/bg2012061102.png" alt=""></p>
<p>（1）最前面的&nbsp;以太网标头，设置发出方（本机）的&nbsp;<code>MAC</code>&nbsp;地址和接收方（<code>DHCP</code>&nbsp;服务器）的&nbsp;<code>MAC</code>&nbsp;地址。前者就是本机网卡的&nbsp;<code>MAC</code>&nbsp;地址，后者&nbsp;这时不知道，就填入一个广播地址：<code>FF-FF-FF-FF-FF-FF</code>。</p>
<p>（2）后面的&nbsp;IP 标头，设置发出方的 IP 地址和接收方的 IP 地址。这时，对于这两者，本机都不知道。于是，发出方的 IP 地址就设为&nbsp;<code>0.0.0.0</code>，接收方的 IP 地址设为&nbsp;<code>255.255.255.255</code>。</p>
<p>（3）最后的&nbsp;UDP 标头，设置发出方的端口和接收方的端口。这一部分是&nbsp;<code>DHCP</code>&nbsp;协议规定好的，发出方是&nbsp;<code>68</code>&nbsp;端口，接收方是&nbsp;<code>67</code>&nbsp;端口。</p>
<p>这个数据包构造完成后，就可以发出了。</p>
<p>以太网是广播发送，同一个子网络的每台计算机都收到了这个包。因为接收方的MAC地址是FF-FF-FF-FF-FF-FF，看不出是发给谁的，所以每台收到这个包的计算机，还必须分析这个包的 IP 地址，才能确定是不是发给自己的。当看到发出方 IP 地址是&nbsp;<code>0.0.0.0</code>，接收方是&nbsp;<code>255.255.255.255</code>，于是DHCP服务器知道 这个包是发给我的，而其他计算机就可以丢弃这个包。</p>
<p>接下来，DHCP 服务器读出这个包的数据内容，分配好 IP 地址，发送回去一个&nbsp;”DHCP响应”数据包。这个响应包的结构也是类似的，以太网标头的 MAC 地址是双方的网卡地址，IP 标头的 IP 地址是 DHCP 服务器的 IP 地址（发出方）和<code>255.255.255.255</code>（接收方），UDP 标头的端口是 67（发出方）和 68（接收方），分配给请求端的IP地址和本网络的具体参数则包含在Data部分。</p>
<p>新加入的计算机收到这个响应包，于是就知道了自己的IP地址、子网掩码、网关地址、DNS服务器等等参数。</p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="实例：访问页面"><a href="#实例：访问页面" class="headerlink" title="实例：访问页面"></a>实例：访问页面</h3><p>假定用户已经动态设置好了自己的网络参数：</p>
<blockquote>
<ul>
<li>本机的IP地址：192.168.1.100</li>
<li>子网掩码：255.255.255.0</li>
<li>网关的IP地址：192.168.1.1</li>
<li>DNS的IP地址：8.8.8.8</li>
</ul>
</blockquote>
<p>打开浏览器，访问 Google，在地址栏输入了网址：www.google.com。</p>
<p>这意味着，浏览器要向 Google 发送一个&nbsp;网页请求&nbsp;的数据包。</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="DNS协议"><a href="#DNS协议" class="headerlink" title="DNS协议"></a>DNS协议</h4><p>DNS 协议可以帮助我们，将这个网址转换成 IP 地址。已知 DNS 服务器为 8.8.8.8，于是我们向这个地址发送一个DNS数据包（53 端口）。</p>
<p><img src="http://image.beekka.com/blog/201206/bg2012061105.png" alt=""></p>
<p>然后，DNS 服务器做出响应，告诉我们 Google 的IP地址是 172.194.72.105。于是，我们知道了对方的 IP 地址。</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="子网掩码"><a href="#子网掩码" class="headerlink" title="子网掩码"></a>子网掩码</h4><p>接下来，我们要判断，这个IP地址是不是在同一个子网络，这就要用到子网掩码。</p>
<p>已知子网掩码是 255.255.255.0，本机用它对自己的IP地址 192.168.1.100，做一个二进制的AND运算（两个数位都为 1，结果为 1，否则为 0），计算结果为 192.168.1.0；然后对 Google 的 IP 地址 172.194.72.105 也做一个 AND 运算，计算结果为 172.194.72.0。这两个结果不相等，所以结论是，Google 与本机不在同一个子网络。</p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h4 id="应用层协议"><a href="#应用层协议" class="headerlink" title="应用层协议"></a>应用层协议</h4><p>浏览网页的浏览器用的是HTTP协议，它的整个数据包构造是这样的：&nbsp;<br><img src="http://image.beekka.com/blog/201206/bg2012061106.png" alt=""></p>
<p>HTTP部分的内容，类似于下面这样：</p>
<pre><code>GET / HTTP/1.1
Host: www.google.com
Connection: keep-alive
User-Agent: Mozilla/5.0 (Windows NT 6.1) ......
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Encoding: gzip,deflate,sdch
Accept-Language: zh-CN,zh;q=0.8
Accept-Charset: GBK,utf-8;q=0.7,*;q=0.3
Cookie: ... ...
</code></pre><p>我们假定这个部分的长度为 4960 字节，它会被嵌在TCP数据包之中。</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="TCP协议"><a href="#TCP协议" class="headerlink" title="TCP协议"></a>TCP协议</h4><p>TCP 数据包需要设置端口，接收方（Google）的&nbsp;HTTP端口默认是80，发送方（本机）的端口是一个&nbsp;随机生成的1024-65535之间的整数，假定为 51775。</p>
<p>TCP 数据包的标头长度为 20 字节，加上嵌入 HTTP 的数据包，总长度变为4980字节。</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="IP协议"><a href="#IP协议" class="headerlink" title="IP协议"></a>IP协议</h4><p>然后，TCP 数据包再嵌入 IP 数据包。IP 数据包需要设置双方的 IP 地址，这是已知的，发送方是 192.168.1.100（本机），接收方是 172.194.72.105（Google）。</p>
<p>IP 数据包的标头长度为 20 字节，加上嵌入的 TCP 数据包，总长度变为 5000 字节。</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="以太网协议"><a href="#以太网协议" class="headerlink" title="以太网协议"></a>以太网协议</h4><p>最后，IP 数据包嵌入以太网数据包。以太网数据包需要设置双方的 MAC 地址，发送方为本机的网卡 MAC 地址，接收方为网关 192.168.1.1 的 MAC 地址（通过 ARP 协议得到）。</p>
<p>以太网数据包的数据部分，最大长度为 1500 字节，而现在的IP数据包长度为 5000 字节。因此，IP 数据包必须分割成四个包。因为每个包都有自己的 IP 标头（20 字节），所以四个包的 IP数据包的长度分别为 1500、1500、1500、560。</p>
<p><img src="http://image.beekka.com/blog/201206/bg2012061107.png" alt=""></p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="服务器响应"><a href="#服务器响应" class="headerlink" title="服务器响应"></a>服务器响应</h4><p>经过多个网关的转发，Google 的服务器 172.194.72.105，收到了这四个以太网数据包。</p>
<p>根据 IP 标头的序号，Google 将四个包拼起来，取出完整的 TCP 数据包，然后读出里面的”HTTP请求”，接着做出”HTTP响应”，再用TCP协议发回来。</p>
<p>本机收到HTTP响应以后，就可以将网页显示出来，完成一次网络通信。</p>
<p><img src="http://image.beekka.com/blog/201206/bg2012061104.jpg" alt=""></p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h2 id="Web开发新人培训系列备忘"><a href="#Web开发新人培训系列备忘" class="headerlink" title="Web开发新人培训系列备忘"></a>Web开发新人培训系列备忘</h2><div class="md-section-divider">&nbsp;</div>

<h3 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h3><ul>
<li><p>进程a发送数据是通过socket发出去，socket需要绑定一个端口，用于区分计算机内的不同进程。进程a使用的socket绑定了2048端口，进程b使用的socket绑定了4096端口。</p>
</li>
<li><p>真正想要数据的进程才是最终应用层。</p>
</li>
<li><p>协议的目的就是让通信的双方知道当前这个数据包是怎么样一个组成格式，一般：包头就是双方约定好的一些信息，包体就是这次通信传输的数据。&nbsp;<br>协议 == 包头 + 包体。</p>
</li>
<li><p>HTTP协议</p>
</li>
</ul>
<blockquote>
<p>HTTP请求包的HTTP包头格式：</p>
<pre><code>*   GET / HTTP/1.1&amp;nbsp;
</code></pre><p>获取的路径以及HTTP版本</p>
<pre><code>*   Host: www.qq.com:8080&amp;nbsp;
</code></pre><p>服务器主机名字&amp;端口号</p>
<pre><code>*   Connection: keep-alive&amp;nbsp;
</code></pre><p>用于长连</p>
<pre><code>*   User-Agent: Chrome/35.0.1916.153&amp;nbsp;
</code></pre><p>浏览器基本信息</p>
<pre><code>*   Accept-Encoding: gzip,deflate,sdch&amp;nbsp;
</code></pre><p>告诉服务器支持的编码</p>
<pre><code>*   Accept-Language: zh-CN,zh;q=0.8,en;q=0.6,nl;q=0.4,zh-TW;q=0.2&amp;nbsp;
</code></pre><p>告诉服务器优先支持的语言</p>
<pre><code>*   Cookie: id=1;username=raphealguo;&amp;nbsp;
</code></pre><p>解决HTTP无状态重要的Cookie，里边是key=value对</p>
</blockquote>
<ul>
<li>服务器收到HTTP请求，经过&nbsp;CGI处理&nbsp;之后回复一个HTTP响应包</li>
</ul>
<blockquote>
<p>HTTP响应包包头常见格式</p>
<pre><code>*   HTTP/1.1 200 OK&amp;nbsp;
</code></pre><p>HTTP版本以及状态码</p>
<pre><code>*   Server: nginx/1.4.1&amp;nbsp;
</code></pre><p>服务器版本</p>
<pre><code>*   Date: Mon, 30 Jun 2014 09:44:10 GMT&amp;nbsp;
</code></pre><p>回包时间</p>
<pre><code>*   Content-Type: text/html; charset=UTF-8&amp;nbsp;
</code></pre><p>包里边的类型</p>
<pre><code>*   Content-Length: 14534&amp;nbsp;
</code></pre><p>包体的长度</p>
<pre><code>*   Connection: keep-alive&amp;nbsp;
</code></pre><p>用于长连</p>
<pre><code>*   Cache-Control: no-cache, must-revalidate&amp;nbsp;
</code></pre><p>用于缓存控制</p>
</blockquote>
<ul>
<li><p>HTTPS协议&nbsp;</p>
<ol>
<li>HTTPS=HTTP协议+SSL</li>
<li>HTTP传输是明文传输，易被劫持篡改</li>
<li>HTTPS采用非对称加密：两边的加密、解密不是完全一样的</li>
</ol>
<p>&nbsp;</p>
</li>
</ul>
<blockquote>
<p>非对称加密示例：</p>
<pre><code>Bob将衣服放到一个保险箱里边锁起来，他打了个电话告诉Alice保险箱开柜密码是1234，而黑客H不知道密码，所以他看不到保险箱里边的东西，Alice收到快递后用预先沟通好的密码就可以打开保险箱了。

    这里保护的手段就是Bob对物品进行加密，同时给了告诉Alice解密的方法！

    那如果现在要求Bob的密码只能通过快递传给Alice呢？如果Bob直接传密码给Alice，H如果嗅探到这个快递，那H也知道密码了，这就无法保护快递的安全性了。因此还需要有个方案，让Bob能够告诉Alice密码的同时，H又无法查看到Bob跟Alice通信的数据。

    非对称加密在这个时候就发挥作用了，来看看怎么回事：Bob拥有两把钥匙，一把叫做公钥，一把叫做私钥。公钥是公开让全社会都知道，没关系，Bob告诉所有人，你们要传递数据给我的时候请先用这个密钥去加密一下你们的数据，加密后的数据只能通过Bob私自藏着的私钥才能解密。

    回到刚刚例子，Bob先发给保险柜（Bob公钥）给Alice，接着Alice把自己的保险柜（Alice公钥）放到Bob的保险柜里边发还给Bob，接着Bob拿到Alice的回包后，用自己的私钥解开了外层保险柜，拿到了里边Alice保险柜。此时Alice跟Bob都有了各自的公钥，接着只要保证每次互相传递数据的时候，把数据放在对方的保险柜里边即可，这样无论如何，H都无法解开保险柜（因为只有各自的私钥才能解开各自的保险柜）。
</code></pre></blockquote>
<pre><code>4.  HTTPS隧道
</code></pre><blockquote>
<p>HTTPS通信会有如下的过程：</p>
<pre><code>    1.  客户端先跟服务器做一次SSL握手，也就是刚刚Bob跟Alice交换公钥的过程。
2.  此时客户端跟服务器都有了各自的公钥，这时他们中间相当于有了一条安全的HTTPS隧道。
3.  客户端要发送请求时，采用服务器给的公钥对请求包进行加密，然后发出去。
4.  服务器收到请求后，使用自己的私钥解开了这个请求包得到其内容。
5.  服务器响应的时候，采用客户端给的公钥进行加密，然后发还给客户端。
6.  客户端收到响应后，使用自己的私钥解开响应包得到其内容。
7.  结束的时候，双方关闭SSL隧道，丢掉上次交换的公钥。
</code></pre></blockquote>
<pre><code>5.  HTTPS也不安全的情况：&amp;nbsp;
</code></pre><blockquote>
<p>&nbsp;</p>
<pre><code>    1.  私钥被窃取；
2.  HTTPS是无法保证端内安全（HTTP就更不能了），电脑已经被病毒侵入，病毒可以监听到你开锁的时候，也可以知道你的私钥；
3.  HTTPS下的页面引用了HTTP下的资源，例如HTTPS下的页面引用了HTTP下的Javascript文件，此时如果这个Javascript文件被篡改了，那通过这个JS文件就可以在执行的时候获取到整个网页内容，在这种情况下，某些浏览器会阻止你去加载这些非HTTP资源，有些则会提示错误或者给出警告信息。
</code></pre><div class="md-section-divider">&nbsp;</div>

</blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="经典的Web应用网络模型"><a href="#经典的Web应用网络模型" class="headerlink" title="经典的Web应用网络模型"></a>经典的Web应用网络模型</h3><p>总体模型概览：&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/%E6%A6%82%E8%A7%88.png" alt=""></p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h4><ul>
<li><p>浏览器会先询问本地Hosts，如果没有映射则再询问DNS缓存，如果没有记录过这个域名映射的IP，那就向本地的DNS网关询问，如果网关也不知道，就继续往上一层的DNS服务器询问，直到拿到这个IP地址。</p>
</li>
<li><p>一般来说，一台服务器处理的请求是有限的，因此大型的应用都会有多台<code>proxy</code>机器，我们可以让DNS服务器在第一个请求返回IP1，第二个请求返回IP2&hellip;&hellip;这样用户的请求就会均匀的落在这些机器上，这个就是<code>DNS</code>负载均衡。<code>CDN</code>就是通过智能<code>DNS</code>算出离用户最近的<code>CDN</code>节点的<code>IP</code>地址，这样用户可以访问一台离他最近的机器，大大节约连接时间。&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/DNS%E8%B4%9F%E8%BD%BD.png" alt=""></p>
<div class="md-section-divider">&nbsp;</div>

</li>
</ul>
<h4 id="代理与反向代理"><a href="#代理与反向代理" class="headerlink" title="代理与反向代理"></a>代理与反向代理</h4><ul>
<li>一般来说，浏览器跟真正提供Web服务的机器是没有直接连接的，他们中间都会有代理跟反向代理。</li>
<li>代理可以是公司内部的代理服务器、各级<code>ISP</code>转发服务器、VPN代理服务器&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86.png" alt=""></li>
<li><p>代理服务器的作用：恶意请求/响应的拦截、缓存内部网络所需的公共资源、GFW与反GFW&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86.png" alt=""></p>
</li>
<li><p>反向代理就是以代理服务器来接收网络连接请求，我们上下文称Proxy机器指的就是反向代理机器，Proxy机器收到请求后会经过一定的分析最后把请求内容转发给内网对应的Web服务器，Web服务器的HTTP响应包会先到Proxy机器，然后再到用户机器。</p>
</li>
</ul>
<p>反向代理的好处是可以负载均衡，在它后边可以有多台工作的Web服务器，这样分层次之后，很多职责就明确很多了：Proxy机器负责负载均衡、拦截恶意请求、维持长连接，还可以屏蔽不工作的Web服务器；而Web服务器就只要关心自己处理的Web业务逻辑即可。</p>
<p>往往Proxy服务器跟用户机器保持长连接，这样可以节省用户每次跟服务器建立连接的消耗，而Proxy服务器跟Web服务器采用短连接的方式，这样可以有效节约Web服务器的资源。&nbsp;</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="Web-server"><a href="#Web-server" class="headerlink" title="Web server"></a>Web server</h4><ul>
<li>Web server的职责就是根据用户的请求，返回其所需要的响应内容。往往Web server只涉及业务测逻辑的判断以及数据的组装，而真正的数据位于后端的存储Server。</li>
</ul>
<p>对于一般应用来说，Web server返回的是动态产生的内容（每个用户都不一致的动态内容或者经常编辑变动的内容），如页面的HTML内容、JSON数据、XML数据等。而Javascript文件、CSS文件、图片这些静态资源（不根据用户而变动的资源）往往存放在CDN中。&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/Web-server.png" alt="">&nbsp;</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h4><ul>
<li><p>对于动态的内容，请求总是到Web server去动态计算获取内容，但是对于不随用户状态变化的内容我们把内容推送到CDN节点上。</p>
</li>
<li><p>静态资源的域名跟页面HTML的域名一般来说是不一样的，因为静态资源的请求需要解析到CDN节点去。我们假设主请求是：www.qq.com/index.html；CDN请求是cdn.qq.com/index.css。&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/CDN.png" alt=""></p>
</li>
<li><p>一般Web应用把静态内容推到CDN有两种模式，一种是在上线前主动将内容推送到CDN节点，一种是CDN发现本地没有该文件时，回源到Web server机器取内容，然后缓存在他本地。&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/CDN%E6%8E%A8%E9%80%81%E5%86%85%E5%AE%B9.png" alt=""></p>
<div class="md-section-divider">&nbsp;</div>

</li>
</ul>
<h4 id="上线"><a href="#上线" class="headerlink" title="上线"></a>上线</h4><ul>
<li><p>像JS文件、CSS文件这些资源对于所有用户来说都是一样的，我们把它们归类到静态资源。对于不同用户，它们看到的网页其实是不一致的（例如页面里边有他们各自的昵称，id等信息），这是通过CGI程序实时计算，为不同用户生成不同的HTML产生，我们把这样的HTML资源归类为动态资源。</p>
</li>
<li><p>由于动态资源是需要实时获取的，因此请求最后都需要落到我们的CGI程序上。而对于静态资源来说，所有请求都是一样的，不需要通过CGI去实时获取文件内容做响应。</p>
</li>
<li><p>一般我们需要多台Web服务器，在它们上层的proxy机器把用户的请求平摊在这些机器上。我们现实的网络结构大多数是这样的：&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2015/01/%E4%B8%8A%E7%BA%BF%E2%80%94%E2%80%94proxy%E8%B7%AF%E7%94%B1.png" alt=""></p>
</li>
<li><p>刚刚我们在只有一台服务器的情况下，我们只需要把文件传输到这台服务器就算此次上线完毕。同样道理在多台服务器的网络结构下，我们把文件依次上传到这些服务器上，对于所有服务器都传输完毕后才算此次上线完毕。&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2015/01/%E4%B8%8A%E7%BA%BF%E2%80%94%E2%80%94%E5%A4%9A%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%BA%BF.png" alt=""></p>
</li>
<li><p>在上线的过程中，有一些服务器是新资源，有一些服务器是旧资源。问题就来了：</p>
</li>
</ul>
<blockquote>
<p>服务器1已经部署上新的资源，而服务器2上还是旧资源。假设这样一个场景，用户第一个HTML请求到了服务器1，然后返回一个新的HTML，接着用户第二个JS请求又跑到服务器2。&nbsp;</p>
<pre><code>在用户侧的表现就是一个旧的JS文件作用在一个新的HTML上，这样可能就引发了异常。&amp;nbsp;
</code></pre><p><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2015/01/%E4%B8%8A%E7%BA%BF%E2%80%94%E2%80%94%E4%B8%8A%E7%BA%BF%E5%BC%82%E5%B8%B8.png" alt=""></p>
</blockquote>
<ul>
<li><p>没法做到资源的实时一致，多台服务器的网络结构下必然会存在某小段时间间隙存在资源不一致的现象。</p>
</li>
<li><p>解决方案：让同一个用户的多次请求永远都在同一台机器上，用户要么访问到的全部都是旧资源，要么全部都是新资源。（这样还能达到灰度测试的作用）</p>
</li>
<li><p>怎么让同一个用户的请求一直都落在同一台机器上?</p>
</li>
</ul>
<blockquote>
<p>通过proxy把同一个用户的请求转发到同一个Web服务器：</p>
<pre><code>1.  proxy反向代理机器收到用户请求
2.  proxy通过这个请求某些flagid标记得知当前这个请求是A用户的
3.  接着proxy定义一个hash算法getServer，通过计算svr = getServer(flag)得到最后这个请求要去到的Web服务器svr&amp;nbsp;

    只要保证getServer这个hash算法每次输出是唯一即可，这个很容易做到。问题：用户的请求带上的flagid是怎么带的？我们先不纠结这个怎么做，我们只要在用户登陆我们系统后，在cookies种上一个能标记出这个用户的id即可。
</code></pre><div class="md-section-divider">&nbsp;</div><br><div class="md-section-divider">&nbsp;</div>

</blockquote>
<p>&nbsp;</p>
<p></p></div><p></p>
<p></p></div><p></p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[Git Note]]></title>
      <url>/2016/08/24/Git-Note/</url>
      <content type="html"><![CDATA[<h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><blockquote>
<p>参考 <a href="http://chengshiwen.com/article/head-first-git/" target="_blank" rel="noopener">http://chengshiwen.com/article/head-first-git/</a></p>
</blockquote>
<h2 id="文件状态"><a href="#文件状态" class="headerlink" title="文件状态"></a>文件状态</h2><ul>
<li><p><strong>Git目录</strong>: （git directory），亦即Git仓库，一般对应项目根目录下的.git目录。该目录非常重要，每次克隆镜像仓库的时候，实际拷贝的就是这个目录里面的数据。</p>
</li>
<li><p><strong>工作目录</strong>:（working directory）是项目某个版本的签出（The working directory is a single checkout of one version of the project） ，也就是本地项目目录，其包含该版本的所有文件（不包括Git目录）。这些文件都是从Git目录中取出的，我们可以在工作目录中修改它们(modify)、删除它们(remove)或添加新文件(add)——这些称之为改动（Changes）。</p>
</li>
<li><p><strong>暂存区域</strong>:（staging area）是工作目录和Git目录之间的临时中转区，存储着工作目录中部分改动文件的快照，该快照将在下次提交时被永久地保存到Git目录中。暂存区域也叫索引（index），实际是Git目录下的index文件（<code>.git/index</code>），其存放了与当前暂存内容相关的信息，包括暂存的文件名、文件内容的SHA-1哈希值和文件访问权限，使用<code>git ls-files --stage</code>命令可查看其内容。</p>
</li>
</ul>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><h3 id="查看配置信息"><a href="#查看配置信息" class="headerlink" title="查看配置信息"></a>查看配置信息</h3><p><code>git config --list</code></p>
<p><code>git config [--system/--global/--local] user.name</code></p>
<h3 id="初始化新仓库"><a href="#初始化新仓库" class="headerlink" title="初始化新仓库"></a>初始化新仓库</h3><p><code>git init</code></p>
<h3 id="从现有仓库克隆"><a href="#从现有仓库克隆" class="headerlink" title="从现有仓库克隆"></a>从现有仓库克隆</h3><p>从现有的项目仓库（如远程服务器上自己的项目，或者其它某个开源项目）克隆到本地，Git接收的是项目历史的所有数据（包括每一个文件的每一个版本）。</p>
<p><code>git clone &lt;repo&gt; [&lt;dir&gt;]</code></p>
<p>克隆时可以在上面的命令末尾指定新的名字，来定义要新建的项目目录名称（仅目录名称不同），例如：</p>
<p><code>git clone git@github.com:jquery/jquery.git myjquery</code></p>
<p>Git支持<code>git://</code>，<code>http(s)://</code>，<code>ssh://</code>等多种数据传输协议。</p>
<h2 id="Git的基本工作流程"><a href="#Git的基本工作流程" class="headerlink" title="Git的基本工作流程"></a>Git的基本工作流程</h2><ul>
<li><p>改动文件：在工作目录中修改、删除或添加某些文件</p>
</li>
<li><p>暂存文件：对改动后的文件进行快照，保存至暂存区域</p>
</li>
<li><p>提交快照：将保存在暂存区域的文件快照永久转储到Git目录中</p>
</li>
</ul>
<h3 id="查看工作目录下当前文件的状态"><a href="#查看工作目录下当前文件的状态" class="headerlink" title="查看工作目录下当前文件的状态"></a>查看工作目录下当前文件的状态</h3><p><code>git status</code></p>
<h3 id="暂存文件"><a href="#暂存文件" class="headerlink" title="暂存文件"></a>暂存文件</h3><p>其作用是把目标文件快照放入暂存区域（add file into staged area）。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>新文件</th>
<th>被修改文件</th>
<th>被删除文件</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>git add</code></td>
<td>Y</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td><code>git add -u</code></td>
<td>N</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td><code>git add -A</code></td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
</tbody>
</table>
<h4 id="取消已修改或已暂存文件"><a href="#取消已修改或已暂存文件" class="headerlink" title="取消已修改或已暂存文件"></a>取消已修改或已暂存文件</h4><p><code>git checkout [&lt;commit&gt;] [--] &lt;file&gt;...</code></p>
<ul>
<li><p>省略commit: 暂存区域 覆盖工作目录 的文件</p>
</li>
<li><p>指定commit: 指定commit 覆盖暂存区域和工作目录</p>
</li>
</ul>
<p>两者不会改变HEAD指针，其中–用于分隔指定文件，防止该文件与分支重名造成分支误操作。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -- grep.py   # 放弃grep.py文件未暂存的改动</span><br><span class="line">$ git checkout .            # 放弃所有未暂存的改动</span><br><span class="line">$ git checkout HEAD *.txt   # 放弃本次所有txt文件作的改动（包括工作目录和暂存区域）</span><br><span class="line">$ git checkout HEAD .       # 放弃所有已暂存改动和未暂存改动，即完全重置到最近的提交状态</span><br></pre></td></tr></table></figure>
<h4 id="文件重置为最近提交时的状态"><a href="#文件重置为最近提交时的状态" class="headerlink" title="文件重置为最近提交时的状态"></a>文件重置为最近提交时的状态</h4><p><code>git reset HEAD &lt;file&gt;</code></p>
<h4 id="从暂存区域移除文件"><a href="#从暂存区域移除文件" class="headerlink" title="从暂存区域移除文件"></a>从暂存区域移除文件</h4><p><code>git rm --cached &lt;file&gt;</code></p>
<h3 id="差异比较"><a href="#差异比较" class="headerlink" title="差异比较"></a>差异比较</h3><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>git diff</code></td>
<td>工作目录 / 暂存区域快照</td>
</tr>
<tr>
<td><code>git diff [--] &lt;path&gt;...</code></td>
<td>工作目录 / 暂存区域快照(指定文件或目录)</td>
</tr>
<tr>
<td><code>git diff --cached</code></td>
<td>暂存区域快照 / 上次提交</td>
</tr>
<tr>
<td><code>git diff --cached [--] &lt;path&gt;...</code></td>
<td>暂存区域快照 / 上次提交(指定文件或目录)</td>
</tr>
<tr>
<td><code>git diff HEAD</code></td>
<td>工作目录 / 上次提交</td>
</tr>
<tr>
<td><code>git diff &lt;commit&gt;</code></td>
<td>工作目录 / commit</td>
</tr>
<tr>
<td><code>git diff &lt;commit&gt; [--] &lt;path&gt;...</code></td>
<td>工作目录 / commit(指定文件或目录)</td>
</tr>
<tr>
<td><code>git diff --cached HEAD</code></td>
<td>暂存区域快照 / 上次提交</td>
</tr>
<tr>
<td><code>git diff --cached &lt;commit&gt;</code></td>
<td>暂存区域快照 / commit</td>
</tr>
<tr>
<td><code>git diff --cached &lt;commit&gt; [--] &lt;path&gt;...</code></td>
<td>暂存区域快照 / commit(指定文件或目录)</td>
</tr>
<tr>
<td><code>git diff &lt;commit1&gt; &lt;commit2&gt;</code></td>
<td>commit1 / commit2</td>
</tr>
<tr>
<td><code>git diff --check</code></td>
<td>列出所有的尾随空白符</td>
</tr>
</tbody>
</table>
<h3 id="提交快照"><a href="#提交快照" class="headerlink" title="提交快照"></a>提交快照</h3><p>把暂存区域内的文件快照提交至Git目录中:<br><code>git commit -m &quot;Fix Bug #182: Fix benchmarks for speed&quot;</code></p>
<p>把所有已经跟踪过的文件暂存起来一并提交:<br><code>git commit -a -m &quot;added new benchmarks&quot;</code></p>
<p>以新作者提交:<code>git commit --author wjhook&lt;wjhook@gmail.com&gt;</code></p>
<p>将指定文件和已暂存文件一并提交:<code>git commit -i &lt;file&gt;...</code></p>
<p>只提交指定文件:<code>git commit -o &lt;file&gt;...</code></p>
<p>修改最后一次提交:</p>
<ul>
<li>重新编辑提交说明: <code>git commit --amend -m &lt;message&gt;</code></li>
<li>重新编辑提交作者: <code>git commit --amend --author wjhook&lt;wjhook@gmail.com&gt;</code></li>
</ul>
<h3 id="Git的基本工作扩展"><a href="#Git的基本工作扩展" class="headerlink" title="Git的基本工作扩展"></a>Git的基本工作扩展</h3><h4 id="查看提交历史"><a href="#查看提交历史" class="headerlink" title="查看提交历史"></a>查看提交历史</h4><p><code>git log --pretty=format:&quot;%h [%an]&lt;%ae&gt;(%ad) message -&gt; %s&quot; --after=&quot;2016-08-12 15:26:00&quot; --before=&quot;2016-08-25&quot; --graph --author= wangjie -p -- *android/alibaba/member*FragmentMemberSignIn.java  -3</code></p>
<p>按照”hash [作者]&lt;邮箱&gt;(时间) message -&gt; 提交说明”的格式查看提交时间在2016-08-12 15:26:00 ~ 2016-08-25 之间的、作者为wangjie的关于<code>*android/alibaba/member*FragmentMemberSignIn.java</code>文件的log并显示提交差异。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%H	：提交对象（commit）的完整哈希字串</span><br><span class="line">%h	：提交对象的简短哈希字串</span><br><span class="line">%an：作者（author）的名字</span><br><span class="line">%ae：作者的电子邮件地址</span><br><span class="line">%ad：作者修订日期（可以用 -date= 选项定制格式）</span><br><span class="line">%ar：作者修订日期，按多久以前的方式显示</span><br><span class="line">%s：提交说明</span><br></pre></td></tr></table></figure>
<p><code>git log --diff-filter=[A/D] --summary</code>：<br>列出版本库中曾添加/删除过文件的提交</p>
<p><code>git log --diff-filter=[A/D] --summary | grep create</code>：<br>列出所有添加/删除过的历史文件</p>
<p><code>git log branch1..branch2</code>：属于branch2，不属于branch1的提交</p>
<h5 id="暂存栈"><a href="#暂存栈" class="headerlink" title="暂存栈"></a>暂存栈</h5><blockquote>
<p><stash> -&gt; stash@{0/1/2/3…}</stash></p>
</blockquote>
<p><code>git stash [save &lt;message&gt;]</code>: 当前工作保存到暂存栈中</p>
<p><code>git stash pop [&lt;stash&gt;]</code>: 恢复暂存栈中引用为<stash>的工作，并从暂存栈中删除</stash></p>
<p><code>git stash apply [&lt;stash&gt;]</code>: 恢复暂存栈中引用为<stash>的工作，暂存栈中不删除</stash></p>
<p><code>git stash drop [&lt;stash&gt;]</code>: 删除暂存栈中引用为<stash>的工作</stash></p>
<p><code>git stash list</code>: 列出暂存栈中的所有工作</p>
<p><code>git stash show [&lt;stash&gt;]</code>: 显示暂存栈中引用为<stash>的工作的改动记录</stash></p>
<p><code>git stash clear</code>: 清除暂存栈中所有保留的工作</p>
<p><code>git stash branch &lt;branchname&gt; [&lt;stash&gt;]</code>: 基于指定工作创建新分支，完全恢复该工作被保存前的状态（新建一个最新提交为<stash>创建时所在的提交、名为<branchname>的分支，同时切换到该分支，恢复暂存栈中引用为<stash>的工作，并将其从暂存栈中删除）</stash></branchname></stash></p>
<h5 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h5><p><code>rm &lt;file&gt;...</code>：从工作目录中删除指定文件，但不从暂存区域移除</p>
<p><code>git rm &lt;file&gt;...</code>：从工作目录中删除指定文件，同时将其从暂存区域移除</p>
<p><code>git rm --cached &lt;file&gt;...</code>：仅仅将文件从暂存区域中移除（其状态变为未跟踪），不对该文件进行其它操作</p>
<p><code>git rm -f &lt;file&gt;...</code>：强制删除</p>
<p><code>git rm -r &lt;file&gt;...</code>：递归删除（用于删除目录）</p>
<h5 id="移动或重命名文件"><a href="#移动或重命名文件" class="headerlink" title="移动或重命名文件"></a>移动或重命名文件</h5><p><code>git mv &lt;file_from&gt; &lt;file_to&gt;</code></p>
<p>其等价于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mv &lt;file_from&gt; &lt;file_to&gt;</span><br><span class="line">$ git rm &lt;file_from&gt;</span><br><span class="line">$ git add &lt;file_to</span><br></pre></td></tr></table></figure>
<h5 id="清除未跟踪文件"><a href="#清除未跟踪文件" class="headerlink" title="清除未跟踪文件"></a>清除未跟踪文件</h5><p><code>git clean -n</code>: 显示将要清除的文件和目录</p>
<p><code>git clean -f</code>：强制清除文件（不包括目录）</p>
<p><code>git clean -df</code>：强制清除所有文件和目录</p>
<p>若要同时再移除被忽略的文件或目录，加上-x参数；若只移除被忽略的文件或目录，加上-X参数。</p>
<h5 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h5><p><code>git merge -m &lt;msg&gt; &lt;commit&gt;</code>：如果产生新的合并提交，则附加msg说明</p>
<p><code>git merge --no-commit &lt;commit&gt;</code>：合并成功后不会自动产生新的提交，用户可以在下次提交前对这次的合并结果进行修改和调整</p>
<p><code>git merge --abort</code>：遇到合并冲突时，此命令将终止合并，并恢复未合并之前的状态</p>
<h5 id="分支挑捡"><a href="#分支挑捡" class="headerlink" title="分支挑捡"></a>分支挑捡</h5><p>如果不需要合并某个分支的全部提交,而只需要该分支的某个或某些提交,使用git cherry-pick命令，它会将指定的commit重新应用到当前分支，命令格式为：</p>
<p><code>$ git cherry-pick &lt;commit&gt;...</code></p>
<h3 id="远程交互"><a href="#远程交互" class="headerlink" title="远程交互"></a>远程交互</h3><h5 id="查看远程仓库"><a href="#查看远程仓库" class="headerlink" title="查看远程仓库"></a>查看远程仓库</h5><p><code>git remote</code></p>
<p>加上<code>-v</code>选项，显示对应的克隆地址：<code>git remote -v</code></p>
<h5 id="添加远程仓库"><a href="#添加远程仓库" class="headerlink" title="添加远程仓库"></a>添加远程仓库</h5><p><code>git remote add &lt;shortname&gt; &lt;url&gt;</code></p>
<p><code>git remote add upstream https://github.com/xgenvn/InputHelper.git</code></p>
<p>拉取所有xgenvn有的，但本地仓库没有的信息</p>
<p><code>git fetch upstream</code></p>
<p><code>git remote rename &lt;old&gt; &lt;new&gt;</code>：重命名远程仓库</p>
<p><code>git remote rm &lt;name&gt;</code>：删除名为name的远程仓库</p>
<p><code>git remote [-v] show &lt;name&gt;</code>：查看远程仓库信息</p>
<p><code>git remote prune &lt;name&gt;</code>：删除不存在对应远程分支的本地分支</p>
<h5 id="推送提交到远程仓库"><a href="#推送提交到远程仓库" class="headerlink" title="推送提交到远程仓库"></a>推送提交到远程仓库</h5><p><code>git push &lt;remote&gt; &lt;branch&gt;</code></p>
<p><code>git push &lt;remote&gt; &lt;lbranch&gt;:[&lt;rbranch&gt;]</code>：将本地lbranch分支推送到remote远程仓库的rbranch分支。若rbranch缺省则默认为lbranch，等同于git push <remote> <lbranch></lbranch></remote></p>
<p><code>git push &lt;remote&gt; :&lt;branch&gt;</code>：将空推送到remote远程仓库的branch分支，即删除remote远程仓库的branch分支</p>
<p><code>git push &lt;remote&gt; --delete &lt;branch&gt;</code>：删除remote远程仓库的branch分支</p>
<p><code>git push &lt;remote&gt; -f &lt;lbranch&gt;:[&lt;rbranch&gt;]</code>：将本地lbranch分支强制推送到remote远程仓库的rbranch分支</p>
<h5 id="从远程仓库拉取最新改动"><a href="#从远程仓库拉取最新改动" class="headerlink" title="从远程仓库拉取最新改动"></a>从远程仓库拉取最新改动</h5><p>基本命令为<code>git fetch</code>，其作用是到远程仓库中拉取所有本地仓库中还没有的最新改动，但不会自动将这些改动合并到当前工作分支</p>
<p><code>git fetch [&lt;remote&gt;]</code>：到remote远程仓库拉取所有本地仓库中还没有的最新改动，不指定remote则默认为origin</p>
<p><code>git fetch &lt;remote&gt; &lt;branch&gt;</code>：将remote远程仓库的branch分支拉取到本地，同时用FETCH_HEAD指针指向它</p>
<p><code>git fetch --all</code>：拉取所有远程仓库</p>
<p><code>git fetch -p</code>：删除不存在对应远程分支的本地分支</p>
<h5 id="从远程仓库拉取最新改动并合并"><a href="#从远程仓库拉取最新改动并合并" class="headerlink" title="从远程仓库拉取最新改动并合并"></a>从远程仓库拉取最新改动并合并</h5><p>基本命令为<code>git pull</code>，其作用是从远程仓库自动拉取最新改动到本地（Fetch），然后将远程分支自动合并到本地仓库中的当前分支(Merge)</p>
<p><code>git pull &lt;remote&gt; &lt;branch&gt;</code></p>
<p>其将remote远程仓库的branch分支拉取到本地，然后将其合并到本地当前分支。</p>
<p><code>git pull &lt;remote&gt; &lt;rbranch&gt;:&lt;lbranch&gt;</code>：将remote远程仓库的rbranch分支拉取到本地，然后将其合并到本地lbranch分支</p>
<h5 id="重置"><a href="#重置" class="headerlink" title="重置"></a>重置</h5><p>基本命令为git reset，其作用是将当前分支指针（HEAD指针）重置为指定状态</p>
<p><code>git reset [&lt;commit&gt;] [--] &lt;paths&gt;...</code></p>
<p>将暂存区域中指定路径的文件重置为指定commit（不指定则默认为HEAD）时的状态，但不会改变工作目录及当前分支，其相当于git add <paths>的反向操作。该命令执行后，自从commit以来指定文件的所有改动都显示在Changes not staged for commit中，而这些改动的反向改动会显示在Changes to be committed中。</paths></p>
<p><code>git reset (--soft|--mixed|--hard) [&lt;commit&gt;]</code></p>
]]></content>
      
        
        <tags>
            
            <tag> tips </tag>
            
            <tag> git </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]使用自定义JUnit Rules、annotations和Resources进行单元测试（翻译）]]></title>
      <url>/2016/08/22/Android-%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89JUnit-Rules%E3%80%81annotations%E5%92%8CResources%E8%BF%9B%E8%A1%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="使用自定义JUnit-Rules、annotations和Resources进行单元测试"><a href="#使用自定义JUnit-Rules、annotations和Resources进行单元测试" class="headerlink" title="使用自定义JUnit Rules、annotations和Resources进行单元测试"></a>使用自定义JUnit Rules、annotations和Resources进行单元测试</h1><blockquote>
<p>原文：<a href="http://www.thedroidsonroids.com/blog/android/unit-tests-rules-annotations-resources" target="_blank" rel="noopener">http://www.thedroidsonroids.com/blog/android/unit-tests-rules-annotations-resources</a></p>
</blockquote>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Unit Test并不只有断言和测试方法组成。它有一些可以用来提高质量和测试代码可读性的技术。在本文中我们将探索：</p>
<ul>
<li>annotations</li>
<li>JUnit rules</li>
<li>java resources</li>
</ul>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>很多或者大多数Android apps作为一个API Client，因此需要数据格式之间的转换（通常是JSON）和POJO（数据模型类）。我们不需要在自己的代码中实现一个转换引擎而是可以使用如 <a href="https://github.com/google/gson" target="_blank" rel="noopener">GSON</a> 或 <a href="https://github.com/square/moshi" target="_blank" rel="noopener">moshi</a> 等三方库来完成。</p>
<p>众所周知的库通常都是有很高的单元测试的覆盖率的，所以如下测试它们是没有意义的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGson</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="comment">//given</span></span><br><span class="line"> Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"> <span class="comment">//when</span></span><br><span class="line"> String result = gson.fromJson(<span class="string">"\"test\""</span>, String.class);</span><br><span class="line"> <span class="comment">//then</span></span><br><span class="line"> assertThat(result).isEqualTo(<span class="string">"test"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 1. 无用的GSON单元测试.</em></p>
<p>另一方面测试解析（JSON到POJO）和生成（POJO到JSON）逻辑相关的模型类可能是有用的。如下的POJO：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Contributor</span> </span>&#123;</span><br><span class="line"> <span class="keyword">public</span> String login;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">boolean</span> siteAdmin;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">long</span> id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 2. 简单POJO.</em></p>
<p>和相应的JSON：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"login"</span>: <span class="string">"koral--"</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">3340954</span>,</span><br><span class="line">    <span class="attr">"site_admin"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 3. 简单JSON.</em></p>
<p>如果属性映射都正确的话，我们希望去测试它。注意属性<code>siteAdmin</code>使用了不同的命名风格 － Java中的驼峰命名和JSON中的蛇底命名。</p>
<h2 id="简单方案"><a href="#简单方案" class="headerlink" title="简单方案"></a>简单方案</h2><p>最简单的一种unit test看起来如下：</p>
<p><span id="listing4"></span></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testParseHardcodedContributors</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> <span class="comment">//given</span></span><br><span class="line"> String json = <span class="string">"[\n"</span> +</span><br><span class="line"> <span class="string">"  &#123;\n"</span> +</span><br><span class="line"> <span class="string">"    \"login\": \"koral--\",\n"</span> +</span><br><span class="line"> <span class="string">"    \"id\": 3340954,\n"</span> +</span><br><span class="line"> <span class="string">"    \"site_admin\": true\n"</span> +</span><br><span class="line"> <span class="string">"  &#125;,\n"</span> +</span><br><span class="line"> <span class="string">"  &#123;\n"</span> +</span><br><span class="line"> <span class="string">"    \"login\": \"Wavesonics\",\n"</span> +</span><br><span class="line"> <span class="string">"    \"id\": 406473,\n"</span> +</span><br><span class="line"> <span class="string">"    \"site_admin\": false\n"</span> +</span><br><span class="line"> <span class="string">"  &#125;\n"</span> +</span><br><span class="line"> <span class="string">"]\n"</span>;</span><br><span class="line"></span><br><span class="line"> GsonBuilder gsonBuilder = <span class="keyword">new</span> GsonBuilder();</span><br><span class="line"> gsonBuilder.setFieldNamingPolicy(FieldNamingPolicy.LOWER_CASE_WITH_UNDERSCORES);</span><br><span class="line"> Gson gson = gsonBuilder.create();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//when</span></span><br><span class="line"> Contributor[] contributors;</span><br><span class="line"> <span class="keyword">try</span> (Reader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> StringReader(json))) &#123;</span><br><span class="line"> contributors = gson.fromJson(reader, Contributor[].class);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 4. 使用硬编码JSON的单元测试.</em></p>
<p>这种方法有几个弊端。最值得注意的就是比较差的JSON可读性，有大量的转义字符和没有语法高亮。此外有一点模版代码，如果有更多的JSON需要测试的话将会产生重复代码。让我们思考怎样可以用更加简便的方法来编写，提高可读性和消除代码重复率。</p>
<h2 id="改进"><a href="#改进" class="headerlink" title="改进"></a>改进</h2><p>首先<code>Gson</code>对象可以在测试方法外部实例化，比如使用一些像 [Dagger] (<a href="http://google.github.io/dagger" target="_blank" rel="noopener">http://google.github.io/dagger</a>) 的DI（依赖注入）机制或者使用一个简单的常量。DI已经超出了本文的范围所以我们在例子代码中使用后者。在代码提取后看起来如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Constants</span> </span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Gson GSON;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">static</span> &#123;</span><br><span class="line"> <span class="keyword">final</span> GsonBuilder gsonBuilder = <span class="keyword">new</span> GsonBuilder();</span><br><span class="line"> gsonBuilder.setFieldNamingPolicy(FieldNamingPolicy.LOWER_CASE_WITH_UNDERSCORES);</span><br><span class="line"> GSON = gsonBuilder.create();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 5. 把GSON实例作为一个全局变量.</em></p>
<p>接着，文本形式的JSON可以被置于一个resource file中。这会给我们带来语法的高亮和缩进（漂亮的打印），默认情况下Android Studio和Intellij IDEA内置了这些功能特性。不需要引号的转义，所以可读性也不再是问题。再者，文件中的行数和列数和GSON中的一致，所以将会更加容易地像这样debug异常：<code>MalformedJsonException: Unterminated array at line 4 column 5 path $[2]</code>。如果JSON被放置在一个单独的文件，行数是会被确切地匹配到的，跟上述硬编码JSON的例子矛盾的地方是，需要通过java源文件中的偏移进行调整。下面是这个示例中被使用的文件：</p>
<p><span id="listing6"><span></span></span></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"login"</span>: <span class="string">"koral--"</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">3340954</span>,</span><br><span class="line">    <span class="attr">"site_admin"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"login"</span>: <span class="string">"Wavesonics"</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">406473</span>,</span><br><span class="line">    <span class="attr">"site_admin"</span>: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><em>Listing 6. 包含JSON的Java resource文件.</em></p>
<p>最后，代码执行转换可以从测试方法中提取，所以广义说它会更容易在不同的测试用例上使用。它可以使用下章将会讨论的Java和JUnit特性来实现。</p>
<h2 id="Goodies"><a href="#Goodies" class="headerlink" title="Goodies"></a>Goodies</h2><h3 id="Java-resources"><a href="#Java-resources" class="headerlink" title="Java resources"></a>Java resources</h3><p>Java resources是程序需要的数据文件，它被放置在源代码外面。注意我们讨论的是 <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/lang/resources.html" target="_blank" rel="noopener">Java resources</a>，默认被放置在<code>src/&lt;source set&gt;/resources</code>，并不是 <a href="https://developer.android.com/guide/topics/resources/providing-resources.html" target="_blank" rel="noopener">Android App Resources</a>(drawables, layouts等)。这本例子中并没有Android特别的特性。所以一切都是可以像 <a href="http://robolectric.org/" target="_blank" rel="noopener">Robolectric</a> 那样脱离frameworks可单元测试的。</p>
<p>如果<a href="#listing6">listing 6</a>的JSON文件被保存于<code>src/test/resources/pl/droidsonroids/modeltesting/api/contributors.json</code>，它可以通过调用<code>TestClass.getResourceAsStream(&quot;contributors.json&quot;)</code>来被单元测试代码访问。相关的类需要被放置在对应的package中，在这个例子中是<code>pl.droidsonroids.modeltesting.api</code>。详情见<a href="https://developer.android.com/reference/java/lang/Class.html#getResourceAsStream(java.lang.String" target="_blank" rel="noopener"><strong><code>#getResourceAsStream()</code> javadoc</strong></a>)</p>
<h3 id="注解Annotation"><a href="#注解Annotation" class="headerlink" title="注解Annotation"></a>注解Annotation</h3><p><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/annotations.html" target="_blank" rel="noopener">Annotation</a>是关联到源代码元素的元数据（eg. 方法或者类）。有众所周知的一些如<a href="https://developer.android.com/reference/java/lang/Override.html" target="_blank" rel="noopener">@Override</a>或<a href="https://developer.android.com/reference/java/lang/Deprecated.html" target="_blank" rel="noopener">@Deprecated</a>的内置注解。也可以自定义并使用它们把特定的resources绑定到测试方法中。</p>
<p>注解来起来与interface很类似：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> JsonFileResource &#123;</span><br><span class="line">	<span class="function">String <span class="title">fileName</span><span class="params">()</span></span>;</span><br><span class="line">	Class&lt;?&gt; clazz();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 7. 简单注解.</em></p>
<p>注意<code>interface</code>关键字前面的<code>@</code>符号。我们自定义的注解被2个元注解来注解。我们设置<a href="https://developer.android.com/reference/java/lang/annotation/Retention.html" target="_blank" rel="noopener">Retention</a>为<a href="https://developer.android.com/reference/java/lang/annotation/RetentionPolicy.html#RUNTIME" target="_blank" rel="noopener">RUNTIME</a>，因为注解需要在单元测试执行时（运行时）为可读，所以默认的retention（<a href="https://developer.android.com/reference/java/lang/annotation/RetentionPolicy.html#CLASS" target="_blank" rel="noopener">CLASS</a>）的并不满足。我们也需要设置<a href="https://developer.android.com/reference/java/lang/annotation/Target.html" target="_blank" rel="noopener">Target</a>为<a href="https://developer.android.com/reference/java/lang/annotation/ElementType.html#METHOD" target="_blank" rel="noopener">METHOD</a>因为我们只需要为方法进行注解（绑定特定的resource）。错位的注解会引发编译错误。没有指定一个target，注解会可以被用于任何地方。</p>
<h3 id="JUnit-Rules"><a href="#JUnit-Rules" class="headerlink" title="JUnit Rules"></a>JUnit Rules</h3><p>简单来说，<a href="https://github.com/junit-team/junit4/wiki/Rules" target="_blank" rel="noopener">rule</a>是在测试（方法）运行时触发的一个hook。我们将使用rule在测试方法执行之前增加一些额外的行为。即我们将从resources中解析JSON并提供给测试方法内部相应的POJO。我们的目标时像下面这样支持单元测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Rule</span> <span class="keyword">public</span> JsonParsingRule jsonParsingRule = <span class="keyword">new</span> JsonParsingRule(Constants.GSON);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@JsonFileResource</span>(fileName = <span class="string">"contributors.json"</span>, clazz = Contributor[].class)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetContributors</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> Contributor[] contributors = jsonParsingRule.getValue();</span><br><span class="line"> assertThat(contributors).hasSize(<span class="number">2</span>);</span><br><span class="line"> assertThat(contributors[<span class="number">0</span>].login).isEqualTo(<span class="string">"koral--"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 8. 使用自定义rule的简单测试方法.</em></p>
<p>如你所见，模版代码与<a href="#listing4">listing 4</a>相比明显地减少。只有必要的部分是类型明确的：</p>
<ul>
<li><p>GSON实例用来解析JSONs - <code>jsonParsingRule = new JsonParsingRule(Constants.GSON)</code></p>
</li>
<li><p>被放置JSON字符串的resource - <code>@JsonFileResource(fileName = &quot;contributors.json&quot;</code></p>
</li>
<li><p>POJO类 - <code>, clazz = Contributor[].class</code></p>
</li>
<li><p>POJO实例的接收 - <code>contributors = jsonParsingRule.getValue()</code></p>
</li>
</ul>
<p>注意对于测试类只需要一个<code>JsonParsingRule</code>实例。对于每个测试方法Rule会被独立计算并且在特定方法中<code>jsonParsingRule.getValue()</code>的结果不会影响到上一次测试。<strong>clazz</strong>并不是一个错字而是故意的，因为<code>class</code>是Java语言关键字并不能用做一个标识符。还有一个重要的是被<a href="http://junit.org/junit4/javadoc/latest/org/junit/Rule.html" target="_blank" rel="noopener">@Rule</a>注解的属性必须是public和非static的。</p>
<h4 id="Rule实现"><a href="#Rule实现" class="headerlink" title="Rule实现"></a>Rule实现</h4><p>看下rule实现的草案：</p>
<p><span id="listing9"></span></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonParsingRule</span> <span class="keyword">implements</span> <span class="title">TestRule</span> </span>&#123;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> Gson mGson;</span><br><span class="line"> <span class="keyword">private</span> Object mValue;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">JsonParsingRule</span><span class="params">(Gson gson)</span> </span>&#123;</span><br><span class="line"> mGson = gson;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"> <span class="function"><span class="keyword">public</span>  T <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> (T) mValue;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Statement <span class="title">apply</span><span class="params">(<span class="keyword">final</span> Statement base, <span class="keyword">final</span> Description description)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> Statement() &#123;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evaluate</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"> <span class="comment">//TODO set mValue according to annotation</span></span><br><span class="line"> base.evaluate();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 9. Rule骨架.</em></p>
<p>我们的rule实现了<a href="http://junit.org/junit4/javadoc/latest/org/junit/rules/TestRule.html" target="_blank" rel="noopener">TestRule</a>，因此可以使用被使用<code>@Rule</code>注解。我们使用了一个范型的getter，所以它的返回值可以被直接分配给特定类型的变量而不需要在测试方法中转型。在<code>apply()</code>方法中我们可以创建一个原始<a href="http://junit.org/junit4/javadoc/latest/org/junit/runners/model/Statement.html" target="_blank" rel="noopener">Statement</a>（测试方法）的包装。调用<code>base.evaluate()</code>被放置在最后（在注解处理之后），因此在测试方法执行过程中rule的效果是可见的。</p>
<p>现在更接近地观看statement包装的关键部分（<a href="#listing9">listing 9</a>中<code>TODO</code>的实现）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">JsonFileResource jsonFileResource = description.getAnnotation(JsonFileResource.class);</span><br><span class="line"><span class="keyword">if</span> (jsonFileResource != <span class="keyword">null</span>) &#123;</span><br><span class="line"> Class&lt;?&gt; clazz = jsonFileResource.clazz();</span><br><span class="line"> String resourceName = jsonFileResource.fileName();</span><br><span class="line"> Class&lt;?&gt; testClass = description.getTestClass();</span><br><span class="line"> InputStream in = testClass.getResourceAsStream(resourceName);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">assert</span> in != <span class="keyword">null</span> : <span class="string">"Failed to load resource: "</span> + resourceName + <span class="string">" from "</span> + testClass;</span><br><span class="line"> <span class="keyword">try</span> (Reader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in))) &#123;</span><br><span class="line"> mValue = mGson.fromJson(reader, clazz);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 10. Statement的实现.</em></p>
<p><code>description</code>参数在这里是必不可少的，它可以让我们访问测试方法包括注解在内的元数据。Rule适用于所有测试方法，包括没有注解的，这种情况下<a href="http://junit.org/junit4/javadoc/latest/org/junit/runner/Description.html#getAnnotation(java.lang.Class" target="_blank" rel="noopener">getAnnotation()</a>)会返回<code>null</code>，并且我们可以有条件地跳过定制的其余部分。所以测试方法没有<code>@JsonFileResource</code>注解的测试方法（比如，一些不涉及JSON的测试）可以放在使用了<code>JsonParsingRule</code>的测试类中。第8行是下面代码的一个<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/language/assert.html#intro" target="_blank" rel="noopener">简写等效</a>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line"> <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Failed to load resource: "</span> + resourceName + <span class="string">" from "</span> + testClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 11. 断言语句判定.</em></p>
<p>最后我们传入使用被<a href="https://developer.android.com/reference/java/io/Reader.html" target="_blank" rel="noopener">Reader</a>包装的resource到GSON引擎。<a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html" target="_blank" rel="noopener">Try-with-resources</a>语句在这里被使用，所以Reader将会在读取甚至发生异常之后自动关闭。这里需要在<code>finally</code>块中明确类型。</p>
<p>注意try-with-resources从Android API 19（Kitkat）才可用。如果测试代码位于Android gradle module中，并且你的<code>minSdkVersion</code>低于19，那么你可能需要在<code>evaluate()</code>方法上增加<code>@TargetApi(Build.VERSION_CODES.KITKAT)</code>注解来避免<a href="http://tools.android.com/tips/lint-checks" target="_blank" rel="noopener">lint</a>错误。单元测试会在开发机器（Mac，PC等）上被执行而不是Android设备或者模拟器，所以这里只有<code>compileSdkVersion</code>才是关键。</p>
<p>这样的单元测试（不需要使用Android特定的API）也可以被放在java module中（<code>build.gradle</code>中<code>apply plugin: &#39;java&#39;</code>）。理论上这事最好的idea，但是在Android Studio/Intellij IDEA中有一个<a href="http://tools.android.com/knownissues#TOC-JUnit-tests-missing-resources-in-classpath-when-run-from-Studio" target="_blank" rel="noopener">问题</a>需要预防，那就是从IDE开箱即用地执行单元测试的配置工作。</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> unit test </tag>
            
            <tag> annotations </tag>
            
            <tag> JUnit </tag>
            
            <tag> Junit Rules </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]Android端ORM框架——RapidORM(v2.0)]]></title>
      <url>/2016/06/29/Android-Android%E7%AB%AFORM%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94RapidORM-v2-0/</url>
      <content type="html"><![CDATA[<h1 id="Android-Android端ORM框架——RapidORM-v2-0"><a href="#Android-Android端ORM框架——RapidORM-v2-0" class="headerlink" title="[Android]Android端ORM框架——RapidORM(v2.0)"></a>[Android]Android端ORM框架——RapidORM(<code>v2.0</code>)</h1><p><strong><a href="https://github.com/wangjiegulu/RapidORM" target="_blank" rel="noopener">RapidORM</a>：Android端轻量高性能的ORM框架</strong></p>
<p><strong>GitHub:</strong> <a href="https://github.com/wangjiegulu/RapidORM" target="_blank" rel="noopener">https://github.com/wangjiegulu/RapidORM</a></p>
<h2 id="1-RapidORM-v1-0"><a href="#1-RapidORM-v1-0" class="headerlink" title="1. RapidORM v1.0"></a>1. RapidORM <code>v1.0</code></h2><blockquote>
<p><code>v1.0</code>博客文档：<a href="http://www.cnblogs.com/tiantianbyconan/p/4748077.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4748077.html</a></p>
</blockquote>
<p><code>v1.0</code>版本支持使用反射和非反射（模版生成）两种方式实现执行SQL。</p>
<h3 id="1-1-v1-0缺点："><a href="#1-1-v1-0缺点：" class="headerlink" title="1.1. v1.0缺点："></a>1.1. <code>v1.0</code>缺点：</h3><p>1. 其中默认为反射实现，对性能有一定的影响。</p>
<p>2. 而如果要采用非反射实现，则需要使用RapidORM提供的模版工具类手动生成相关的帮助类，当数据表需要修改时，必须要手动手动生成帮助类，有潜在的风险。</p>
<p>3. 非反射时生成的文件是通过<code>getter/setter</code>方法调用的，但是<code>getter/setter</code>方法名可能会不一致，导致需要手动调整<code>setter/getter</code>方法名称。</p>
<h2 id="2-RapidORM-v2-0"><a href="#2-RapidORM-v2-0" class="headerlink" title="2. RapidORM v2.0"></a>2. RapidORM <code>v2.0</code></h2><p>相比较于<code>v1.0</code>版本，<code>v2.0</code>版本则更加侧重于非反射操作，所有默认都是非反射的。</p>
<p>通过在编译时期根据<code>@Table</code>、<code>@Column</code>等注解自动生成辅助类<code>Xxx_RORM.java</code>文件，<strong>RapidORM</strong>库会使用这些生成的辅助类来进行数据表的初始化、执行SQL等操作，如果数据表有结构有改动，则会自动重新生成或者<code>rebuild</code>来手动生成。</p>
<h3 id="2-1-v2-0-使用指南"><a href="#2-1-v2-0-使用指南" class="headerlink" title="2.1 v2.0 使用指南"></a>2.1 <code>v2.0</code> 使用指南</h3><blockquote>
<p>与<code>v1.0</code>相同部分省略。</p>
</blockquote>
<h4 id="2-1-1-同样，创建持久类Person"><a href="#2-1-1-同样，创建持久类Person" class="headerlink" title="2.1.1 同样，创建持久类Person"></a>2.1.1 同样，创建持久类<code>Person</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author: wangjie</span></span><br><span class="line"><span class="comment"> * Email: tiantian.china.2@gmail.com</span></span><br><span class="line"><span class="comment"> * Date: 6/25/15.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(primaryKey = <span class="keyword">true</span>)</span><br><span class="line">    Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(primaryKey = <span class="keyword">true</span>, name = <span class="string">"type_id"</span>)</span><br><span class="line">    Integer typeId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    Long birth;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    Boolean student;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"is_succeed"</span>)</span><br><span class="line">    <span class="keyword">boolean</span> isSucceed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter/setter</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，v2.0版本不支持变量为<code>private</code>类型，这是为了避免使用<code>getter/setter</code>方法来进行数据绑定。如果变量为<code>private</code>类型，则编译会报错，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error:Execution failed <span class="keyword">for</span> task <span class="string">':example:compileDebugJavaWithJavac'</span>.</span><br><span class="line">&gt; java.lang.RuntimeException: id in com.wangjie.rapidorm.example.database.model.Person can not be <span class="keyword">private</span>!</span><br></pre></td></tr></table></figure>
<h4 id="2-1-2-Rebuild-Project"><a href="#2-1-2-Rebuild-Project" class="headerlink" title="2.1.2 Rebuild Project"></a>2.1.2 Rebuild Project</h4><blockquote>
<p>Android Studio -&gt; Build -&gt; Rebuild Project</p>
</blockquote>
<p>Build成功后，在主项目<code>build/generated/source/apt/</code>目录下会生成<code>Person_RORM</code>类, 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GENERATED CODE BY RapidORM. DO NOT MODIFY! "2016-06-29 14:08:504", Source table: "com.wangjie.rapidorm.example.database.model.Person"</span></span><br><span class="line"><span class="keyword">package</span> com.wangjie.rapidorm.example.database.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.database.Cursor;</span><br><span class="line"><span class="keyword">import</span> com.wangjie.rapidorm.core.config.ColumnConfig;</span><br><span class="line"><span class="keyword">import</span> com.wangjie.rapidorm.core.config.TableConfig;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person_RORM</span> <span class="keyword">extends</span> <span class="title">TableConfig</span>&lt;<span class="title">Person</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "id", field name: &#123;<span class="doctag">@link</span> Person#id&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ID = <span class="string">"id"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "type_id", field name: &#123;<span class="doctag">@link</span> Person#typeId&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_ID = <span class="string">"type_id"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "name", field name: &#123;<span class="doctag">@link</span> Person#name&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"name"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "age", field name: &#123;<span class="doctag">@link</span> Person#age&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AGE = <span class="string">"age"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "address", field name: &#123;<span class="doctag">@link</span> Person#address&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ADDRESS = <span class="string">"address"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "birth", field name: &#123;<span class="doctag">@link</span> Person#birth&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BIRTH = <span class="string">"birth"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "student", field name: &#123;<span class="doctag">@link</span> Person#student&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String STUDENT = <span class="string">"student"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "is_succeed", field name: &#123;<span class="doctag">@link</span> Person#isSucceed&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String IS_SUCCEED = <span class="string">"is_succeed"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Person_RORM</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(Person.class);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseAllConfigs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    tableName = <span class="string">"Person"</span>;</span><br><span class="line">    ColumnConfig idColumnConfig = buildColumnConfig(<span class="string">"id"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">true</span><span class="comment">/*primaryKey*/</span>, <span class="string">"INTEGER"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(idColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"id"</span><span class="comment">/*field name*/</span>, idColumnConfig);</span><br><span class="line">    pkColumnConfigs.add(idColumnConfig);</span><br><span class="line">    ColumnConfig typeIdColumnConfig = buildColumnConfig(<span class="string">"type_id"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">true</span><span class="comment">/*primaryKey*/</span>, <span class="string">"INTEGER"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(typeIdColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"typeId"</span><span class="comment">/*field name*/</span>, typeIdColumnConfig);</span><br><span class="line">    pkColumnConfigs.add(typeIdColumnConfig);</span><br><span class="line">    ColumnConfig nameColumnConfig = buildColumnConfig(<span class="string">"name"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">false</span><span class="comment">/*primaryKey*/</span>, <span class="string">"TEXT"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(nameColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"name"</span><span class="comment">/*field name*/</span>, nameColumnConfig);</span><br><span class="line">    noPkColumnConfigs.add(nameColumnConfig);</span><br><span class="line">    ColumnConfig ageColumnConfig = buildColumnConfig(<span class="string">"age"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">false</span><span class="comment">/*primaryKey*/</span>, <span class="string">"INTEGER"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(ageColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"age"</span><span class="comment">/*field name*/</span>, ageColumnConfig);</span><br><span class="line">    noPkColumnConfigs.add(ageColumnConfig);</span><br><span class="line">    ColumnConfig addressColumnConfig = buildColumnConfig(<span class="string">"address"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">false</span><span class="comment">/*primaryKey*/</span>, <span class="string">"TEXT"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(addressColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"address"</span><span class="comment">/*field name*/</span>, addressColumnConfig);</span><br><span class="line">    noPkColumnConfigs.add(addressColumnConfig);</span><br><span class="line">    ColumnConfig birthColumnConfig = buildColumnConfig(<span class="string">"birth"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">false</span><span class="comment">/*primaryKey*/</span>, <span class="string">"LONG"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(birthColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"birth"</span><span class="comment">/*field name*/</span>, birthColumnConfig);</span><br><span class="line">    noPkColumnConfigs.add(birthColumnConfig);</span><br><span class="line">    ColumnConfig studentColumnConfig = buildColumnConfig(<span class="string">"student"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">false</span><span class="comment">/*primaryKey*/</span>, <span class="string">"INTEGER"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(studentColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"student"</span><span class="comment">/*field name*/</span>, studentColumnConfig);</span><br><span class="line">    noPkColumnConfigs.add(studentColumnConfig);</span><br><span class="line">    ColumnConfig isSucceedColumnConfig = buildColumnConfig(<span class="string">"is_succeed"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">false</span><span class="comment">/*primaryKey*/</span>, <span class="string">"INTEGER"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(isSucceedColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"isSucceed"</span><span class="comment">/*field name*/</span>, isSucceedColumnConfig);</span><br><span class="line">    noPkColumnConfigs.add(isSucceedColumnConfig);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindInsertArgs</span><span class="params">(Person model, List&lt;Object&gt; insertArgs)</span> </span>&#123;</span><br><span class="line">    Integer id = model.id;</span><br><span class="line">    insertArgs.add(<span class="keyword">null</span> == id ? <span class="keyword">null</span> : id );</span><br><span class="line">    Integer typeId = model.typeId;</span><br><span class="line">    insertArgs.add(<span class="keyword">null</span> == typeId ? <span class="keyword">null</span> : typeId );</span><br><span class="line">    String name = model.name;</span><br><span class="line">    insertArgs.add(<span class="keyword">null</span> == name ? <span class="keyword">null</span> : name );</span><br><span class="line">    <span class="keyword">int</span> age = model.age;</span><br><span class="line">    insertArgs.add(age);</span><br><span class="line">    String address = model.address;</span><br><span class="line">    insertArgs.add(<span class="keyword">null</span> == address ? <span class="keyword">null</span> : address );</span><br><span class="line">    Long birth = model.birth;</span><br><span class="line">    insertArgs.add(<span class="keyword">null</span> == birth ? <span class="keyword">null</span> : birth );</span><br><span class="line">    Boolean student = model.student;</span><br><span class="line">    insertArgs.add(<span class="keyword">null</span> == student ? <span class="keyword">null</span> : student  ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">boolean</span> isSucceed = model.isSucceed;</span><br><span class="line">    insertArgs.add(isSucceed ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindUpdateArgs</span><span class="params">(Person model, List&lt;Object&gt; updateArgs)</span> </span>&#123;</span><br><span class="line">    String name = model.name;</span><br><span class="line">    updateArgs.add(<span class="keyword">null</span> == name ? <span class="keyword">null</span> : name);</span><br><span class="line">    <span class="keyword">int</span> age = model.age;</span><br><span class="line">    updateArgs.add(age);</span><br><span class="line">    String address = model.address;</span><br><span class="line">    updateArgs.add(<span class="keyword">null</span> == address ? <span class="keyword">null</span> : address);</span><br><span class="line">    Long birth = model.birth;</span><br><span class="line">    updateArgs.add(<span class="keyword">null</span> == birth ? <span class="keyword">null</span> : birth);</span><br><span class="line">    Boolean student = model.student;</span><br><span class="line">    updateArgs.add(<span class="keyword">null</span> == student ? <span class="keyword">null</span> : student ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">boolean</span> isSucceed = model.isSucceed;</span><br><span class="line">    updateArgs.add(isSucceed ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindPkArgs</span><span class="params">(Person model, List&lt;Object&gt; pkArgs)</span> </span>&#123;</span><br><span class="line">    Integer id = model.id;</span><br><span class="line">    pkArgs.add(<span class="keyword">null</span> == id ? <span class="keyword">null</span> : id);</span><br><span class="line">    Integer typeId = model.typeId;</span><br><span class="line">    pkArgs.add(<span class="keyword">null</span> == typeId ? <span class="keyword">null</span> : typeId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Person <span class="title">parseFromCursor</span><span class="params">(Cursor cursor)</span> </span>&#123;</span><br><span class="line">    Person model = <span class="keyword">new</span> Person();</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"id"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.id = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getInt(index));</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"type_id"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.typeId = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getInt(index));</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"name"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.name = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getString(index));</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"age"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.age = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getInt(index));</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"address"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.address = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getString(index));</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"birth"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.birth = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getLong(index));</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"student"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.student = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getInt(index) == <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"is_succeed"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.isSucceed = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getInt(index) == <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> model;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-3-注册持久类"><a href="#2-1-3-注册持久类" class="headerlink" title="2.1.3 注册持久类"></a>2.1.3 注册持久类</h4><p>与<code>v1.0</code>一样，新建类DatabaseFactory，继承RapidORMConnection（可参考<a href="http://www.cnblogs.com/tiantianbyconan/p/4748077.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4748077.html</a>）。</p>
<p>需要注意的是需要实现的并不是原来的<code>registerAllTableClass()</code>方法，而是<code>registerTableConfigMapper(HashMap&lt;Class, TableConfig&gt; tableConfigMapper)</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerTableConfigMapper</span><span class="params">(HashMap&lt;Class, TableConfig&gt; tableConfigMapper)</span> </span>&#123;</span><br><span class="line">    tableConfigMapper.put(Person.class, <span class="keyword">new</span> Person_RORM());</span><br><span class="line">    <span class="comment">// register all table config here...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>注意：注册<code>Person</code>时，需要连带生成的<code>Person_RORM</code>同时注册。</p>
<h4 id="2-1-4-构建Builder"><a href="#2-1-4-构建Builder" class="headerlink" title="2.1.4 构建Builder"></a>2.1.4 构建Builder</h4><p>构建Builder时与<code>v1.0</code>的方式一致，但是可以直接使用<code>Person_RORM</code>中的static变量来作为column name：</p>
<p><strong>PersonDaoImpl</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Person&gt; <span class="title">findPersonsByWhere</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> queryBuilder()</span><br><span class="line">            .addSelectColumn(Person_RORM.ID, Person_RORM.TYPE_ID, Person_RORM.NAME,</span><br><span class="line">                    Person_RORM.AGE, Person_RORM.BIRTH, Person_RORM.ADDRESS)</span><br><span class="line">            .setWhere(</span><br><span class="line">            	Where.and(</span><br><span class="line">	                Where.like(Person_RORM.NAME, <span class="string">"%wangjie%"</span>),</span><br><span class="line">	                Where.lt(Person_RORM.ID, <span class="number">200</span>),</span><br><span class="line">	                Where.or(</span><br><span class="line">	                        Where.between(Person_RORM.AGE, <span class="number">19</span>, <span class="number">39</span>),</span><br><span class="line">	                        Where.isNull(Person_RORM.ADDRESS)</span><br><span class="line">	                ),</span><br><span class="line">	                Where.eq(Person_RORM.TYPE_ID, <span class="number">1</span>)</span><br><span class="line">        		)</span><br><span class="line">            )</span><br><span class="line">            .addOrder(Person_RORM.ID, <span class="keyword">false</span>)</span><br><span class="line">            .addOrder(Person_RORM.NAME, <span class="keyword">true</span>)</span><br><span class="line">            .setLimit(<span class="number">10</span>)</span><br><span class="line">            .query(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-5-兼容SqlCipher"><a href="#2-1-5-兼容SqlCipher" class="headerlink" title="2.1.5 兼容SqlCipher"></a>2.1.5 兼容SqlCipher</h4><p>与<code>v1.0</code>一致.</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> library </tag>
            
            <tag> sqlite </tag>
            
            <tag> database </tag>
            
            <tag> orm </tag>
            
            <tag> rapidorm </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]Google 开源的 Android 排版库：FlexboxLayout]]></title>
      <url>/2016/05/31/Android-Google-%E5%BC%80%E6%BA%90%E7%9A%84-Android-%E6%8E%92%E7%89%88%E5%BA%93%EF%BC%9AFlexboxLayout/</url>
      <content type="html"><![CDATA[<p>最近Google开源了一个项目叫「FlexboxLayout」。</p>
<h2 id="1-什么是-Flexbox"><a href="#1-什么是-Flexbox" class="headerlink" title="1.什么是 Flexbox"></a>1.什么是 Flexbox</h2><p>简单来说 Flexbox 是属于web前端领域CSS的一种布局方案，是2009年W3C提出了一种新的布局方案，可以简便、完整、响应式地实现各种页面布局，并且 React Native 也是使用的 Flex 布局。</p>
<p>你可以简单的理解为 Flexbox 是CSS领域类似 Linearlayout 的一种布局，但是要比 Linearlayout 要强大的多。</p>
<h2 id="2-什么是-FlexboxLayout？"><a href="#2-什么是-FlexboxLayout？" class="headerlink" title="2.什么是 FlexboxLayout？"></a>2.什么是 FlexboxLayout？</h2><p>刚才说了 Flexbox 是CSS领域的比较强大的一个布局，我们在 Android 开发中使用 Linearlayout + RelativeLayout 基本可以实现大部分复杂的布局，但是Google就想了，有没有类似 Flexbox 的一个布局呢？这使用起来一个布局就可以搞定各种复杂的情况了，于是 FlexboxLayout 就应运而生了。</p>
<p>所以 FlexboxLayout 是针对 Android 平台的，实现类似 Flexbox 布局方案的一个开源项目，开源地址：<a href="https://github.com/google/flexbox-layout" target="_blank" rel="noopener">https://github.com/google/flexbox-layout</a></p>
<h2 id="3-使用方式"><a href="#3-使用方式" class="headerlink" title="3.使用方式"></a>3.使用方式</h2><p>使用方式很简单，只需要添加以下依赖：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">'com.google.android:flexbox:0.1.2'</span></span><br></pre></td></tr></table></figure>
<p>xml中这样使用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.google.android.flexbox.FlexboxLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:flexWrap</span>=<span class="string">"wrap"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:alignItems</span>=<span class="string">"stretch"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:alignContent</span>=<span class="string">"stretch"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/textview1"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"120dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"80dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_flexBasisPercent</span>=<span class="string">"50%"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/textview2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"80dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"80dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_alignSelf</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/textview3"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"160dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"80dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_alignSelf</span>=<span class="string">"flex_end"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">com.google.android.flexbox.FlexboxLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>或者代码中这样使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FlexboxLayout flexboxLayout = (FlexboxLayout) findViewById(R.id.flexbox_layout);</span><br><span class="line">flexboxLayout.setFlexDirection(FlexboxLayout.FLEX_DIRECTION_COLUMN);</span><br><span class="line"></span><br><span class="line">View view = flexboxLayout.getChildAt(<span class="number">0</span>);</span><br><span class="line">FlexboxLayout.LayoutParams lp = (FlexboxLayout.LayoutParams) view.getLayoutParams();</span><br><span class="line">lp.order = -<span class="number">1</span>;</span><br><span class="line">lp.flexGrow = <span class="number">2</span>;</span><br><span class="line">view.setLayoutParams(lp);</span><br></pre></td></tr></table></figure>
<p>使用起来是不是很像Linearlayout的用法，只不过有很多属性你们比较陌生，这些属性都是Flexbox布局本身具备的，别着急，下面跟你们介绍下FlexboxLayout的一些具体属性的用法与意义。</p>
<h2 id="4-支持的属性"><a href="#4-支持的属性" class="headerlink" title="4.支持的属性"></a>4.支持的属性</h2><h3 id="flexDirection"><a href="#flexDirection" class="headerlink" title="flexDirection"></a>flexDirection</h3><p>flexDirection 属性决定主轴的方向（即项目的排列方向）。类似 LinearLayout 的 vertical 和 horizontal。</p>
<p>有四个值可以选择：</p>
<ul>
<li>row（默认值）：主轴为水平方向，起点在左端。</li>
<li>row-reverse：主轴为水平方向，起点在右端。</li>
<li>column：主轴为垂直方向，起点在上沿。</li>
<li>column-reverse：主轴为垂直方向，起点在下沿。</li>
</ul>
<h3 id="flexWrap"><a href="#flexWrap" class="headerlink" title="flexWrap"></a>flexWrap</h3><p>默认情况下 Flex 跟 LinearLayout 一样，都是不带换行排列的，但是flexWrap属性可以支持换行排列。有三个值：</p>
<p><img src="http://static.oschina.net/uploads/space/2016/0516/075805_YI0O_2652078.png" alt=""></p>
<ul>
<li>nowrap ：不换行</li>
<li>wrap：按正常方向换行</li>
<li>wrap-reverse：按反方向换行</li>
</ul>
<h3 id="justifyContent"><a href="#justifyContent" class="headerlink" title="justifyContent"></a>justifyContent</h3><p>justifyContent属性定义了项目在主轴上的对齐方式。</p>
<ul>
<li>flex-start（默认值）：左对齐</li>
<li>flex-end：右对齐</li>
<li>center： 居中</li>
<li>space-between：两端对齐，项目之间的间隔都相等。</li>
<li>space-around：每个项目两侧的间隔相等。所以，项目之间的间隔比项目与边框的间隔大一倍。</li>
</ul>
<h3 id="alignItems"><a href="#alignItems" class="headerlink" title="alignItems"></a>alignItems</h3><p>alignItems属性定义项目在副轴轴上如何对齐。</p>
<ul>
<li>flex-start：交叉轴的起点对齐。</li>
<li>flex-end：交叉轴的终点对齐。</li>
<li>center：交叉轴的中点对齐。</li>
<li>baseline: 项目的第一行文字的基线对齐。</li>
<li>stretch（默认值）：如果项目未设置高度或设为auto，将占满整个容器的高度。</li>
</ul>
<p><img src="http://static.oschina.net/uploads/space/2016/0516/075958_K7iO_2652078.png" alt=""></p>
<h3 id="alignContent"><a href="#alignContent" class="headerlink" title="alignContent"></a>alignContent</h3><p>alignContent属性定义了多根轴线的对齐方式。如果项目只有一根轴线，该属性不起作用。</p>
<ul>
<li>flex-start：与交叉轴的起点对齐。</li>
<li>flex-end：与交叉轴的终点对齐。</li>
<li>center：与交叉轴的中点对齐。</li>
<li>space-between：与交叉轴两端对齐，轴线之间的间隔平均分布。</li>
<li>space-around：每根轴线两侧的间隔都相等。所以，轴线之间的间隔比轴线与边框的间隔大一倍。</li>
<li>stretch（默认值）：轴线占满整个交叉轴。</li>
</ul>
<h2 id="5-子元素属性"><a href="#5-子元素属性" class="headerlink" title="5.子元素属性"></a>5.子元素属性</h2><p>除以上之外，FlexboxLayout还支持如下子元素属性：</p>
<h3 id="layout-order"><a href="#layout-order" class="headerlink" title="layout_order"></a>layout_order</h3><p>默认情况下子元素的排列方式按照文档流的顺序依次排序，而order属性可以控制排列的顺序，负值在前，正值灾后，按照从小到大的顺序依次排列。我们说之所以 FlexboxLayout 相对LinearLayout强就是因为一些属性比较给力，order就是其中之一。</p>
<p><img src="http://static.oschina.net/uploads/space/2016/0516/080144_woPx_2652078.png" alt=""></p>
<h3 id="layout-flexGrow"><a href="#layout-flexGrow" class="headerlink" title="layout_flexGrow"></a>layout_flexGrow</h3><p>layout_flexGrow 属性定义项目的放大比例，默认为0，即如果存在剩余空间，也不放大。一张图看懂。跟 LinearLayout 中的weight属性一样。</p>
<p><img src="http://static.oschina.net/uploads/space/2016/0516/080148_QD0P_2652078.png" alt=""></p>
<p>如果所有项目的 layout_flexGrow  属性都为1，则它们将等分剩余空间（如果有的话）。如果一个项目的 layout_flexGrow  属性为2，其他项目都为1，则前者占据的剩余空间将比其他项多一倍。</p>
<h3 id="layout-flexShrink"><a href="#layout-flexShrink" class="headerlink" title="layout_flexShrink"></a>layout_flexShrink</h3><p>layout_flexShrink  属性定义了项目的缩小比例，默认为1，即如果空间不足，该项目将缩小。</p>
<p>如果所有项目的 layout_flexShrink  属性都为1，当空间不足时，都将等比例缩小。如果一个项目的flex-shrink属性为0，其他项目都为1，则空间不足时，前者不缩小。</p>
<p>负值对该属性无效。</p>
<h3 id="layout-alignSelf"><a href="#layout-alignSelf" class="headerlink" title="layout_alignSelf"></a>layout_alignSelf</h3><p>layout_alignSelf  属性允许单个子元素有与其他子元素不一样的对齐方式，可覆盖 alignItems 属性。默认值为auto，表示继承父元素的 alignItems 属性，如果没有父元素，则等同于stretch。</p>
<ul>
<li>auto (default)</li>
<li>flex_start</li>
<li>flex_end</li>
<li>center</li>
<li>baseline</li>
<li>stretch</li>
</ul>
<blockquote>
<p>该属性可能取6个值，除了auto，其他都与align-items属性完全一致。</p>
</blockquote>
<h3 id="layout-flexBasisPercent"><a href="#layout-flexBasisPercent" class="headerlink" title="layout_flexBasisPercent"></a>layout_flexBasisPercent</h3><p>layout_flexBasisPercent 属性定义了在分配多余空间之前，子元素占据的main size主轴空间，浏览器根据这个属性，计算主轴是否有多余空间。它的默认值为auto，即子元素的本来大小。</p>
<h2 id="6-不同之处"><a href="#6-不同之处" class="headerlink" title="6.不同之处"></a>6.不同之处</h2><p>跟传统的CSS中的Flexbox布局有些不同的是：</p>
<p>1. 没有 flex-flow 属性</p>
<p>2. 没有 flex 属性</p>
<p>3. layout_flexBasisPercent 属性即为CSS中 flexbox 中的 flexBasis 属性</p>
<p>4. 不支持 min-width 和 min-height 两个属性</p>
<p>以上就是 FlexboxLayout 的一些基本介绍与基本用法，值得提醒大家的是，本身这个项目也是一个很好的自定义View的学习资料，值得大家学习借鉴！</p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p>本文的很多 Flexbox 方面的知识大量参考了我司同事的这篇文章，想要更多的了解 Flexbox 相关的知识建议阅读这里：</p>
<p><a href="http://w4lle.github.io/2016/05/08/Flexbox/" target="_blank" rel="noopener">http://w4lle.github.io/2016/05/08/Flexbox/</a></p>
<blockquote>
<p>出处：微信公众平台 <a href="http://mp.weixin.qq.com/s?__biz=MzA4NTQwNDcyMA==&amp;mid=2650661681&amp;idx=1&amp;sn=b151aba0c5fb702492f6bbd82211988d#rd" target="_blank" rel="noopener">AndroidDeveloper</a></p>
<p>相关链接<br>FlexboxLayout 的详细介绍：<a href="http://www.oschina.net/p/flexboxlayout" target="_blank" rel="noopener">请点这里</a></p>
<p>FlexboxLayout 的下载地址：<a href="http://www.oschina.net/action/project/go?id=42172&amp;p=download" target="_blank" rel="noopener">请点这里</a></p>
</blockquote>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> FlexboxLayout </tag>
            
            <tag> google </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android MVP&依赖注入&单元测试]]></title>
      <url>/2016/04/22/Android-Android-MVP-%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/</url>
      <content type="html"><![CDATA[<h1 id="Android-MVP-amp-依赖注入-amp-单元测试"><a href="#Android-MVP-amp-依赖注入-amp-单元测试" class="headerlink" title="Android MVP&amp;依赖注入&amp;单元测试"></a>Android MVP&amp;依赖注入&amp;单元测试</h1><blockquote>
<p><strong>注意</strong>：为了区分<code>MVP</code>中的<code>View</code>与<code>Android</code>中控件的<code>View</code>，以下<code>MVP</code>中的<code>View</code>使用<code>Viewer</code>来表示。</p>
</blockquote>
<p>这里暂时先只讨论 <code>Viewer</code> 和 <code>Presenter</code>，<code>Model</code>暂时不去涉及。</p>
<h2 id="1-1-MVP-基础框架"><a href="#1-1-MVP-基础框架" class="headerlink" title="1.1 MVP 基础框架"></a>1.1 MVP 基础框架</h2><h3 id="1-1-1-前提"><a href="#1-1-1-前提" class="headerlink" title="1.1.1 前提"></a>1.1.1 前提</h3><p>首先需要解决以下问题：</p>
<blockquote>
<p><code>MVP</code>中把Layout布局和<code>Activity</code>等组件作为<code>Viewer</code>层，增加了<code>Presenter</code>，<code>Presenter</code>层与<code>Model</code>层进行业务的交互，完成后再与<code>Viewer</code>层交互,进行回调来刷新UI。这样一来，业务逻辑的工作都交给了<code>Presenter</code>中进行，使得<code>Viewer</code>层与<code>Model</code>层的耦合度降低，<code>Viewer</code>中的工作也进行了简化。但是在实际项目中，随着逻辑的复杂度越来越大，<code>Viewer</code>（如<code>Activity</code>）臃肿的缺点仍然体现出来了，因为<code>Activity</code>中还是充满了大量与<code>Viewer</code>层无关的代码，比如各种事件的处理派发，就如<code>MVC</code>中的那样<code>Viewer</code>层和<code>Controller</code>代码耦合在一起无法自拔。</p>
</blockquote>
<p>转自我之前的博客（<strong><a href="http://www.cnblogs.com/tiantianbyconan/p/5036289.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5036289.html</a></strong>）中第二阶段所引发的问题。</p>
<p>解决的方法之一在上述文章中也有提到 —— 加入<code>Controller</code>层来分担<code>Viewer</code>的职责。</p>
<h3 id="1-1-2-Contract"><a href="#1-1-2-Contract" class="headerlink" title="1.1.2 Contract"></a>1.1.2 Contract</h3><p>根据以上的解决方案，首先考虑到<code>Viewer</code>直接交互的对象可能是<code>Presenter</code>（原来的方式），也有可能是<code>Controller</code>。</p>
<ul>
<li><p>如果直接交互的对象是<code>Presenter</code>，由于<code>Presenter</code>中可能会进行很多同步、异步操作来调用<code>Model</code>层的代码，并且会回调到UI来进行UI的更新，所以，我们需要在<code>Viewer</code>层对象销毁时能够停止<code>Presenter</code>中执行的任务，或者执行完成后拦截UI的相关回调。因此，<code>Presenter</code>中应该绑定<code>Viewer</code>对象的生命周期（至少<code>Viewer</code>销毁的生命周期是需要关心的）</p>
</li>
<li><p>如果直接交互的对象是<code>Controller</code>，由于<code>Controller</code>中会承担<code>Viewer</code>中的事件回调并派发的职责（比如，ListView item 的点击回调和点击之后对相应的逻辑进行派发、或者<code>Viewer</code>生命周期方法回调后的处理），所以<code>Controller</code>层也是需要绑定<code>Viewer</code>对象的生命周期的。</p>
</li>
</ul>
<p>这里，使用<code>Viewer</code>生命周期回调进行抽象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnViewerDestroyListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onViewerDestroy</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnViewerLifecycleListener</span> <span class="keyword">extends</span> <span class="title">OnViewerDestroyListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onViewerResume</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onViewerPause</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>OnViewerDestroyListener</code>接口提供给需要关心<code>Viewer</code>层销毁时期的组件，如上，应该是<code>Presenter</code>所需要关心的。</p>
<p><code>OnViewerLifecycleListener</code>接口提供给需要关心<code>Viewer</code>层生命周期回调的组件，可以根据项目需求增加更多的生命周期的方法，这里我们只关心<code>Viewer</code>的<code>resume</code>和<code>pause</code>。</p>
<h3 id="1-1-3-Viewer层"><a href="#1-1-3-Viewer层" class="headerlink" title="1.1.3 Viewer层"></a>1.1.3 Viewer层</h3><h4 id="1-1-3-1-Viewer-抽象"><a href="#1-1-3-1-Viewer-抽象" class="headerlink" title="1.1.3.1 Viewer 抽象"></a>1.1.3.1 Viewer 抽象</h4><p><code>Viewer</code>层，也就是表现层，当然有相关常用的UI操作，比如显示一个<code>toast</code>、显示/取消一个加载进度条等等。除此之外，由于<code>Viewer</code>层可能会直接与<code>Presenter</code>或者<code>Controller</code>层交互，所以应该还提供对这两者的绑定操作，所以如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Viewer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Viewer <span class="title">bind</span><span class="params">(OnViewerLifecycleListener onViewerLifecycleListener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Viewer <span class="title">bind</span><span class="params">(OnViewerDestroyListener onViewerDestroyListener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Context <span class="title">context</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showToast</span><span class="params">(String message)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showToast</span><span class="params">(<span class="keyword">int</span> resStringId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showLoadingDialog</span><span class="params">(String message)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showLoadingDialog</span><span class="params">(<span class="keyword">int</span> resStringId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cancelLoadingDialog</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上代码，两个<code>bind()</code>方法就是用于跟<code>Presenter</code>/<code>Controller</code>的绑定。</p>
<h4 id="1-1-3-2-Viewer-委托实现"><a href="#1-1-3-2-Viewer-委托实现" class="headerlink" title="1.1.3.2 Viewer 委托实现"></a>1.1.3.2 Viewer 委托实现</h4><p>又因为，在Android中<code>Viewer</code>层对象可能是<code>Activity</code>、<code>Fragment</code>、<code>View</code>（包括<code>ViewGroup</code>），甚至还有自己实现的组件，当然实现的方式一般不外乎上面这几种。所以我们需要使用统一的<code>Activity</code>、<code>Fragment</code>、<code>View</code>，每个都需要实现<code>Viewer</code>接口。为了复用相关代码，这里提供默认的委托实现<code>ViewerDelegate</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewerDelegate</span> <span class="keyword">implements</span> <span class="title">Viewer</span>, <span class="title">OnViewerLifecycleListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewerDelegate</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;OnViewerDestroyListener&gt; mOnViewerDestroyListeners;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;OnViewerLifecycleListener&gt; mOnViewerLifecycleListeners;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Toast toast;</span><br><span class="line">    <span class="keyword">private</span> ProgressDialog loadingDialog;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Viewer <span class="title">bind</span><span class="params">(OnViewerLifecycleListener onViewerLifecycleListener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == mOnViewerLifecycleListeners) &#123;</span><br><span class="line">            mOnViewerLifecycleListeners = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            mOnViewerLifecycleListeners.add(onViewerLifecycleListener);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mOnViewerLifecycleListeners.contains(onViewerLifecycleListener)) &#123;</span><br><span class="line">                mOnViewerLifecycleListeners.add(onViewerLifecycleListener);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Viewer <span class="title">bind</span><span class="params">(OnViewerDestroyListener onViewerDestroyListener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == mOnViewerDestroyListeners) &#123;</span><br><span class="line">            mOnViewerDestroyListeners = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            mOnViewerDestroyListeners.add(onViewerDestroyListener);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mOnViewerDestroyListeners.contains(onViewerDestroyListener)) &#123;</span><br><span class="line">                mOnViewerDestroyListeners.add(onViewerDestroyListener);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">context</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showToast</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!checkViewer()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == toast) &#123;</span><br><span class="line">            toast = Toast.makeText(mContext, <span class="string">""</span>, Toast.LENGTH_SHORT);</span><br><span class="line">            toast.setGravity(Gravity.CENTER, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        toast.setText(message);</span><br><span class="line">        toast.show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showToast</span><span class="params">(<span class="keyword">int</span> resStringId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!checkViewer()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        showToast(mContext.getString(resStringId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showLoadingDialog</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!checkViewer()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == loadingDialog) &#123;</span><br><span class="line">            loadingDialog = <span class="keyword">new</span> ProgressDialog(mContext);</span><br><span class="line">            loadingDialog.setCanceledOnTouchOutside(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        loadingDialog.setMessage(message);</span><br><span class="line">        loadingDialog.show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showLoadingDialog</span><span class="params">(<span class="keyword">int</span> resStringId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!checkViewer()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        showLoadingDialog(mContext.getString(resStringId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelLoadingDialog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!checkViewer()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != loadingDialog) &#123;</span><br><span class="line">            loadingDialog.cancel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkViewer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span> != mContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != mOnViewerLifecycleListeners) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OnViewerLifecycleListener oll : mOnViewerLifecycleListeners) &#123;</span><br><span class="line">                oll.onViewerResume();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != mOnViewerLifecycleListeners) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OnViewerLifecycleListener oll : mOnViewerLifecycleListeners) &#123;</span><br><span class="line">                oll.onViewerPause();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != mOnViewerLifecycleListeners) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OnViewerLifecycleListener oll : mOnViewerLifecycleListeners) &#123;</span><br><span class="line">                oll.onViewerDestroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != mOnViewerDestroyListeners) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OnViewerDestroyListener odl : mOnViewerDestroyListeners) &#123;</span><br><span class="line">                odl.onViewerDestroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mContext = <span class="keyword">null</span>;</span><br><span class="line">        mOnViewerDestroyListeners = <span class="keyword">null</span>;</span><br><span class="line">        mOnViewerLifecycleListeners = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上代码：</p>
<ul>
<li><p>它提供了默认基本的<code>toast</code>、和显示/隐藏加载进度条的方法。</p>
</li>
<li><p>它实现了两个重载<code>bind()</code>方法，并把需要回调的<code>OnViewerLifecycleListener</code>和<code>OnViewerDestroyListener</code>对应保存在<code>mOnViewerDestroyListeners</code>和<code>mOnViewerLifecycleListeners</code>中。</p>
</li>
<li><p>它实现了<code>OnViewerLifecycleListener</code>接口，在回调方法中回调到每个<code>mOnViewerDestroyListeners</code>和<code>mOnViewerLifecycleListeners</code>。</p>
</li>
</ul>
<p><code>mOnViewerDestroyListeners</code>：Viewer destroy 时的回调，一般情况下只会有Presenter一个对象，但是由于一个Viewer是可以有多个Presenter的,所以可能会维护一个Presenter列表，还有可能是其他需要关心 Viewer destroy 的组件</p>
<p><code>mOnViewerLifecycleListeners</code>：Viewer 简单的生命周期监听对象，一般情况下只有一个Controller一个对象，但是一个Viewer并不限制只有一个Controller对象,所以可能会维护一个Controller列表，还有可能是其他关心 Viewer 简单生命周期的组件</p>
<h4 id="1-1-3-3-真实-Viewer-实现"><a href="#1-1-3-3-真实-Viewer-实现" class="headerlink" title="1.1.3.3 真实 Viewer 实现"></a>1.1.3.3 真实 Viewer 实现</h4><p>然后在真实的<code>Viewer</code>中（这里以<code>Activity</code>为例，其他<code>Fragment</code>/<code>View</code>等也是一样），首先，应该实现<code>Viewer</code>接口，并且应该维护一个委托对象<code>mViewerDelegate</code>，在实现的<code>Viewer</code>方法中使用<code>mViewerDelegate</code>的具体实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">Viewer</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ViewerDelegate mViewerDelegate;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    	<span class="comment">// ...</span></span><br><span class="line">    	mViewerDelegate = <span class="keyword">new</span> ViewerDelegate(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.onViewerResume();</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.onViewerPause();</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.onViewerDestroy();</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Viewer <span class="title">bind</span><span class="params">(OnViewerDestroyListener onViewerDestroyListener)</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.bind(onViewerDestroyListener);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Viewer <span class="title">bind</span><span class="params">(OnViewerLifecycleListener onViewerLifecycleListener)</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.bind(onViewerLifecycleListener);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">context</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mViewerDelegate.context();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showToast</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.showToast(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showToast</span><span class="params">(<span class="keyword">int</span> resStringId)</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.showToast(resStringId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showLoadingDialog</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.showLoadingDialog(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showLoadingDialog</span><span class="params">(<span class="keyword">int</span> resStringId)</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.showLoadingDialog(resStringId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelLoadingDialog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.cancelLoadingDialog();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，<code>BaseActivity</code>构建完成。</p>
<p><strong>在具体真实的<code>Viewer</code>实现中，包含的方法应该都是类似<code>onXxxYyyZzz()</code>的回调方法，并且这些回调方法应该只进行UI操作，比如<code>onLoadMessage(List&lt;Message&gt; message)</code>方法在加载完<code>Message</code>数据后回调该方法来进行UI的更新。</strong></p>
<p>在项目中使用时，应该使用依赖注入来把<code>Controller</code>对象注入到<code>Viewer</code>中（这个后面会提到）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RInject</span></span><br><span class="line">IBuyingRequestPostSucceedController controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    BuyingRequestPostSucceedView_Rapier</span><br><span class="line">            .create()</span><br><span class="line">            .inject(<span class="keyword">module</span>, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    controller.bind(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>RInject</code>通过<code>BuyingRequestPostSucceedView_Rapier</code>扩展类来进行注入<code>Controller</code>对象，然后调用<code>Controller</code>的<code>bind</code>方法进行生命周期的绑定。</p>
<h3 id="1-1-4-Controller-层"><a href="#1-1-4-Controller-层" class="headerlink" title="1.1.4 Controller 层"></a>1.1.4 Controller 层</h3><h4 id="1-1-4-1-Controller-抽象"><a href="#1-1-4-1-Controller-抽象" class="headerlink" title="1.1.4.1 Controller 抽象"></a>1.1.4.1 Controller 抽象</h4><p>前面讲过，<code>Controller</code>是需要关心<code>Viewer</code>生命周期的，所以需要实现<code>OnViewerLifecycleListener</code>接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Controller</span> <span class="keyword">extends</span> <span class="title">OnViewerLifecycleListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bind</span><span class="params">(Viewer bindViewer)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又提供一个<code>bind()</code>方法来进行对自身进行绑定到对应的<code>Viewer</code>上面。</p>
<h4 id="1-1-4-2-Controller-实现"><a href="#1-1-4-2-Controller-实现" class="headerlink" title="1.1.4.2 Controller 实现"></a>1.1.4.2 Controller 实现</h4><p>调用<code>Viewer</code>层的<code>bind()</code>方法来进行绑定，对生命周期进行空实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseController</span> <span class="keyword">implements</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Viewer bindViewer)</span> </span>&#123;</span><br><span class="line">        bindViewer.bind(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// empty</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// empty</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// empty</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该<code>bind()</code>方法除了用于绑定<code>Viewer</code>之外，还可以让子类重写用于做为Controller的初始化方法,但是注意重写的时候必须要调用<code>super.bind()</code>。</p>
<p><strong>具体<code>Controller</code>实现中，应该只包含类似<code>onXxxYyyZzz()</code>的回调方法，并且这些回调方法应该都是各种事件回调，比如<code>onClick()</code>用于View点击事件的回调，<code>onItemClick()</code>表示AdapterView item点击事件的回调。</strong></p>
<h3 id="1-1-5-Presenter-层"><a href="#1-1-5-Presenter-层" class="headerlink" title="1.1.5 Presenter 层"></a>1.1.5 Presenter 层</h3><h4 id="1-1-5-1-Presenter-抽象"><a href="#1-1-5-1-Presenter-抽象" class="headerlink" title="1.1.5.1 Presenter 抽象"></a>1.1.5.1 Presenter 抽象</h4><blockquote>
<p><code>Presenter</code>层，作为沟通 <code>View</code> 和 <code>Model</code> 的桥梁，它从 <code>Model</code> 层检索数据后，返回给 <code>View</code> 层，它也可以决定与 <code>View</code> 层的交互操作。</p>
</blockquote>
<p>前面讲到过，<code>View</code>也是与<code>Presenter</code>直接交互的，Presenter中可能会进行很多同步、异步操作来调用Model层的代码，并且会回调到UI来进行UI的更新，所以，我们需要在Viewer层对象销毁时能够停止Presenter中执行的任务，或者执行完成后拦截UI的相关回调。</p>
<p>因此：</p>
<ul>
<li><code>Presenter</code> 中应该也有<code>bind()</code>方法来进行与<code>Viewer</code>层的生命周期的绑定</li>
<li><code>Presenter</code> 中应该提供一个方法<code>closeAllTask()</code>来终止或拦截掉UI相关的异步任务。</li>
</ul>
<p>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Presenter</span> <span class="keyword">extends</span> <span class="title">OnViewerDestroyListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bind</span><span class="params">(Viewer bindViewer)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">closeAllTask</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-1-5-2-Presenter-RxJava-抽象"><a href="#1-1-5-2-Presenter-RxJava-抽象" class="headerlink" title="1.1.5.2 Presenter RxJava 抽象"></a>1.1.5.2 Presenter RxJava 抽象</h4><p>因为项目技术需求，需要实现对<code>RxJava</code>的支持，因此，这里对<code>Presenter</code>进行相关的扩展，提供两个方法以便于<code>Presenter</code>对任务的扩展。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RxPresenter</span> <span class="keyword">extends</span> <span class="title">Presenter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">goSubscription</span><span class="params">(Subscription subscription)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeSubscription</span><span class="params">(Subscription subscription)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>goSubscription()</code>方法主要用处是，订阅时缓存该订阅对象到<code>Presenter</code>中，便于管理（怎么管理，下面会讲到）。</p>
<p><code>removeSubscription()</code>方法可以从<code>Presenter</code>中管理的订阅缓存中移除掉该订阅。</p>
<h4 id="1-1-5-3-Presenter-RxJava-实现"><a href="#1-1-5-3-Presenter-RxJava-实现" class="headerlink" title="1.1.5.3 Presenter RxJava 实现"></a>1.1.5.3 Presenter RxJava 实现</h4><p>在Presenter RxJava 实现（<code>RxBasePresenter</code>）中，我们使用<code>WeakHashMap</code>来构建一个弱引用的<code>Set</code>，用它来缓存所有订阅。在调用<code>goSubscription()</code>方法中，把对应的<code>Subscription</code>加入到<code>Set</code>中，在<code>removeSubscription()</code>方法中，把对应的<code>Subscription</code>从<code>Set</code>中移除掉。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxBasePresenter</span> <span class="keyword">implements</span> <span class="title">RxPresenter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = RxBasePresenter.class.getSimpleName();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Subscription&gt; subscriptions = Collections.newSetFromMap(<span class="keyword">new</span> WeakHashMap&lt;Subscription, Boolean&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeAllTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (subscriptions) &#123;</span><br><span class="line">            Iterator iter = <span class="keyword">this</span>.subscriptions.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                Subscription subscription = (Subscription) iter.next();</span><br><span class="line">                XLog.i(TAG, <span class="string">"closeAllTask[subscriptions]: "</span> + subscription);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != subscription &amp;&amp; !subscription.isUnsubscribed()) &#123;</span><br><span class="line">                    subscription.unsubscribe();</span><br><span class="line">                &#125;</span><br><span class="line">                iter.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">goSubscription</span><span class="params">(Subscription subscription)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (subscriptions) &#123;</span><br><span class="line">            <span class="keyword">this</span>.subscriptions.add(subscription);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeSubscription</span><span class="params">(Subscription subscription)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (subscriptions) &#123;</span><br><span class="line">            XLog.i(TAG, <span class="string">"removeSubscription: "</span> + subscription);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != subscription &amp;&amp; !subscription.isUnsubscribed()) &#123;</span><br><span class="line">                subscription.unsubscribe();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.subscriptions.remove(subscription);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Viewer bindViewer)</span> </span>&#123;</span><br><span class="line">        bindViewer.bind(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        closeAllTask();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上代码，在<code>onViewerDestroy()</code>回调时（因为跟<code>Viewer</code>生命周期进行了绑定），会调用<code>closeAllTask</code>把所有缓存中的<code>Subscription</code>取消订阅。</p>
<blockquote>
<p><strong>注意</strong>：因为缓存中使用了弱引用，所以上面的<code>removeSubscription</code>不需要再去手动调用，在订阅completed后，gc自然会回收掉没有强引用指向的<code>Subscription</code>对象。</p>
</blockquote>
<h4 id="1-1-5-4-Presenter-具体实现"><a href="#1-1-5-4-Presenter-具体实现" class="headerlink" title="1.1.5.4 Presenter 具体实现"></a>1.1.5.4 Presenter 具体实现</h4><p>在<code>Presenter</code>具体的实现中，同样依赖注入各种来自<code>Model</code>层的<code>Interactor/Api</code>（网络、数据库、文件等等），然后订阅这些对象返回的<code>Observable</code>，然后进行订阅，并调用<code>goSubscription()</code>缓存<code>Subscription</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuyingRequestPostSucceedPresenter</span> <span class="keyword">extends</span> <span class="title">RxBasePresenter</span> <span class="keyword">implements</span> <span class="title">IBuyingRequestPostSucceedPresenter</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> IBuyingRequestPostSucceedView viewer;</span><br><span class="line">	<span class="meta">@RInject</span></span><br><span class="line">    ApiSearcher apiSearcher;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BuyingRequestPostSucceedPresenter</span><span class="params">(IBuyingRequestPostSucceedView viewer, BuyingRequestPostSucceedPresenterModule <span class="keyword">module</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.viewer = viewer;</span><br><span class="line">        <span class="comment">// inject</span></span><br><span class="line">        BuyingRequestPostSucceedPresenter_Rapier</span><br><span class="line">                .create()</span><br><span class="line">                .inject(<span class="keyword">module</span>, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadSomeThing</span><span class="params">(<span class="keyword">final</span> String foo, <span class="keyword">final</span> String bar)</span> </span>&#123;</span><br><span class="line">        goSubscription(</span><br><span class="line">                apiSearcher.searcherSomeThing(foo, bar)</span><br><span class="line">                        .compose(TransformerBridge.&lt;OceanServerResponse&lt;SomeThing&gt;&gt;subscribeOnNet())</span><br><span class="line">                        .map(<span class="keyword">new</span> Func1&lt;OceanServerResponse&lt;SomeThing&gt;, SomeThing&gt;() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> SomeThing <span class="title">call</span><span class="params">(OceanServerResponse&lt;SomeThing&gt; response)</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">return</span> response.getBody();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;)</span><br><span class="line">                        .compose(TransformerBridge.&lt;SomeThing&gt;observableOnMain())</span><br><span class="line">                        .subscribe(<span class="keyword">new</span> Subscriber&lt;SomeThing&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                                XLog.e(TAG, <span class="string">""</span>, e);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(SomeThing someThing)</span> </span>&#123;</span><br><span class="line">                                XLog.d(TAG, <span class="string">"XLog onNext..."</span>);</span><br><span class="line">                                viewer.onLoadSomeThing(someThing);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;)</span><br><span class="line">        );</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ... </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-6-Model-层"><a href="#1-1-6-Model-层" class="headerlink" title="1.1.6 Model 层"></a>1.1.6 Model 层</h3><p>暂不讨论。</p>
<h2 id="1-2-针对-MVP-进行依赖注入"><a href="#1-2-针对-MVP-进行依赖注入" class="headerlink" title="1.2 针对 MVP 进行依赖注入"></a>1.2 针对 MVP 进行依赖注入</h2><p>上面提到，<code>Viewer</code>、<code>Controller</code>和<code>Presenter</code>中都使用了<code>RInject</code>注解来进行依赖的注入。</p>
<p>这里并没有使用其他第三方实现的<code>DI</code>框架，比如<code>Dagger/Dagger2</code>等，而是自己实现的<a href="https://github.com/wangjiegulu/Rapier" target="_blank" rel="noopener">Rapier</a>，它的原理与<code>Dagger2</code>类似，会在编译时期生成一些扩展扩展类来简化代码，比如前面的<code>BuyingRequestPostSucceedView_Rapier</code>、<code>BuyingRequestPostSucceedPresenter_Rapier</code>、<code>BuyingRequestPostSucceedController_Rapier</code>等。它也支持<code>Named</code>、<code>Lazy</code>等功能，但是它比<code>Dagger2</code>更加轻量，<code>Module</code>的使用方式更加简单，更加倾向于对<code>Module</code>的复用，更强的可控性，但是由于这次的重构主要是基于在兼容旧版本的情况下使用，暂时没有加上<code>Scope</code>的支持。</p>
<p>之后再针对这个<code>Rapier</code>库进行详细讨论。</p>
<h2 id="1-3-针对-MVP-进行单元测试"><a href="#1-3-针对-MVP-进行单元测试" class="headerlink" title="1.3 针对 MVP 进行单元测试"></a>1.3 针对 MVP 进行单元测试</h2><p>这里主要还是讨论针对<code>Viewer</code>和<code>Presenter</code>的单元测试。</p>
<h3 id="1-3-1-针对-Viewer-进行单元测试"><a href="#1-3-1-针对-Viewer-进行单元测试" class="headerlink" title="1.3.1 针对 Viewer 进行单元测试"></a>1.3.1 针对 Viewer 进行单元测试</h3><p>针对<code>Viewer</code>进行单元测试，这里不涉及任何业务相关的逻辑，而且，<code>Viewer</code>层的测试都是UI相关，必须要Android环境，所以需要在手机或者模拟器安装一个<code>test</code> apk，然后进行测试。</p>
<p>为了不被<code>Viewer</code>中的<code>Controller</code>和<code>Presenter</code>的逻辑所干扰，我们必须要mock掉<code>Viewer</code>中的<code>Controller</code>和<code>Presenter</code>对象，又因为<code>Controller</code>对象是通过依赖注入的方式提供的，也就是来自<code>Rapier</code>中的<code>Module</code>，所以，我们只需要mock掉<code>Viewer</code>对应的<code>module</code>。</p>
<h3 id="1-3-1-1-如果-Viewer-是-View"><a href="#1-3-1-1-如果-Viewer-是-View" class="headerlink" title="1.3.1.1 如果 Viewer 是 View"></a>1.3.1.1 如果 Viewer 是 View</h3><p>如果<code>Viewer</code>层是由<code>View</code>实现的，比如继承<code>FrameLayout</code>。这个时候，测试时，就必须要放在一个<code>Activity</code>中测试（<code>Fragment</code>也一样，也必须依赖于<code>Activity</code>），所以我们应该有一个专门用于测试<code>View/Fragment</code>的<code>Activity</code> —— <code>TestContainerActivity</code>，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestContainerActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>记得在<code>AndroidManifest.xml</code>中注册。</p>
<p>前面说过，我们需要mock掉<code>Module</code>。</p>
<p>如果<code>Viewer</code>是<code>View</code>，mock掉<code>Module</code>就非常容易了，只要在<code>View</code>中提供一个传入mock的<code>Module</code>的构造方法即可，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BuyingRequestPostSucceedView</span><span class="params">(Context context, BuyingRequestPostSucceedModule <span class="keyword">module</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>(context);</span><br><span class="line">	<span class="comment">// inject</span></span><br><span class="line">	BuyingRequestPostSucceedView_Rapier</span><br><span class="line">	        .create()</span><br><span class="line">	        .inject(<span class="keyword">module</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上代码，这里为测试专门提供了一个构造方法来进行对<code>Module</code>的mock，之后的测试如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">BuyingRequestPostSucceedView requestPostSucceedView;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Rule</span></span><br><span class="line"><span class="keyword">public</span> ActivityTestRule&lt;TestContainerActivity&gt; mActivityTestRule = <span class="keyword">new</span> ActivityTestRule&lt;TestContainerActivity&gt;(TestContainerActivity.class) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterActivityLaunched</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.afterActivityLaunched();</span><br><span class="line">            <span class="keyword">final</span> TestContainerActivity activity = getActivity();</span><br><span class="line">            logger(<span class="string">"afterActivityLaunched"</span>);</span><br><span class="line">            activity.runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    BuyingRequestPostSucceedModule <span class="keyword">module</span> = mock(BuyingRequestPostSucceedModule.class);</span><br><span class="line">                    when(<span class="keyword">module</span>.pickController()).thenReturn(mock(IBuyingRequestPostSucceedController.class));</span><br><span class="line">                    requestPostSucceedView = <span class="keyword">new</span> BuyingRequestPostSucceedView(activity, <span class="keyword">module</span>);</span><br><span class="line">                    activity.setContentView(requestPostSucceedView);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOnLoadSomeThings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> SomeThings products = mock(SomeThings.class);</span><br><span class="line">        ArrayList&lt;SomeThing&gt; list = mock(ArrayList.class);</span><br><span class="line"></span><br><span class="line">        SomeThing product = mock(SomeThing.class);</span><br><span class="line"></span><br><span class="line">        when(list.get(anyInt())).thenReturn(product);</span><br><span class="line">        products.productList = list;</span><br><span class="line"></span><br><span class="line">        TestContainerActivity activity = mActivityTestRule.getActivity();</span><br><span class="line"></span><br><span class="line">        when(list.size()).thenReturn(<span class="number">1</span>);</span><br><span class="line">        when(list.isEmpty()).thenReturn(<span class="keyword">false</span>);</span><br><span class="line">        activity.runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                requestPostSucceedView.onLoadSomeThing(products);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        onView(withId(R.id.id_tips_you_may_also_like_tv)).check(matches(isDisplayed()));</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如上代码，在<code>TestContainerActivity</code>启动后，构造一个mock了<code>Module</code>的待测试<code>View</code>，并增加到<code>Activity</code>的content view中。</p>
<h3 id="1-3-1-2-如果-Viewer-是-Activity"><a href="#1-3-1-2-如果-Viewer-是-Activity" class="headerlink" title="1.3.1.2 如果 Viewer 是 Activity"></a>1.3.1.2 如果 Viewer 是 Activity</h3><p>如果<code>Viewer</code>是<code>Activity</code>，由于它本来就是Activity，所以它不需要借助<code>TestContainerActivity</code>来测试；mock <code>module</code>时就不能使用构造方法的方式了，因为我们是不能直接对<code>Activity</code>进行实例化的，那应该怎么办呢？</p>
<p>一般情况下，我们会在调用<code>onCreate</code>方法的时候去进行对依赖的注入，也就是调用<code>XxxYyyZzz_Rapier</code>扩展类，而且，如果这个<code>Activity</code>需要在一启动就去进行一些数据请求，我们要拦截掉这个请求，因为这个请求返回的数据可能会对我们的UI测试造成干扰，所以我们需要在<code>onCreate</code>在被调用之前把<code>module</code> mock掉。</p>
<p>首先看test support 中的 <code>ActivityTestRule</code>这个类，它提供了以下几个方法：</p>
<ul>
<li><p><code>getActivityIntent()</code>：这个方法只能在Intent中增加携带的参数，我们要mock的是整个<code>Module</code>，无法序列化，所以也无法通过这个传入。</p>
</li>
<li><p><code>beforeActivityLaunched()</code>：这个方法回调时，<code>Activity</code>实例还没有生成，所以无法拿到<code>Activity</code>实例，并进行<code>Module</code>的替换。</p>
</li>
<li><p><code>afterActivityFinished()</code>：这个方法就更不可能了-.-</p>
</li>
<li><p><code>afterActivityLaunched()</code>：这个方法看它的源码（无关代码已省略）：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">launchActivity</span><span class="params">(@Nullable Intent startIntent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        beforeActivityLaunched();</span><br><span class="line">        <span class="comment">// The following cast is correct because the activity we're creating is of the same type as</span></span><br><span class="line">        <span class="comment">// the one passed in</span></span><br><span class="line">        mActivity = mActivityClass.cast(mInstrumentation.startActivitySync(startIntent));</span><br><span class="line"></span><br><span class="line">        mInstrumentation.waitForIdleSync();</span><br><span class="line"></span><br><span class="line">        afterActivityLaunched();</span><br><span class="line">        <span class="keyword">return</span> mActivity;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如上代码，<code>afterActivityLaunched()</code>方法是在真正启动<code>Activity</code>（<code>mInstrumentation.startActivitySync(startIntent)</code>）后调用的。但是显然这个方法是同步的，之后再进入源码，来查看启动的流程，整个流程有些复杂我就不赘述了，可以查看我以前写的分析启动流程的博客（<strong><a href="http://www.cnblogs.com/tiantianbyconan/p/5017056.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5017056.html</a></strong>），最后会调用<code>mInstrumentation.callActivityOnCreate(...)</code>。</p>
<p>但是因为测试时，启动<code>Activity</code>的过程也是同步的，所以显然这个方法是在<code>onCreate()</code>被调用后才会被回调的，所以，这个方法也不行。</p>
<p>既然貌似已经找到了mock的正确位置，那就继续分析下去：</p>
<p>这里的<code>mInstrumentation</code>是哪个<code>Instrumentation</code>实例呢？</p>
<p>我们回到<code>ActivityTestRule</code>中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityTestRule</span><span class="params">(Class&lt;T&gt; activityClass, <span class="keyword">boolean</span> initialTouchMode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> launchActivity)</span> </span>&#123;</span><br><span class="line">        mActivityClass = activityClass;</span><br><span class="line">        mInitialTouchMode = initialTouchMode;</span><br><span class="line">        mLaunchActivity = launchActivity;</span><br><span class="line">        mInstrumentation = InstrumentationRegistry.getInstrumentation();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>继续进入<code>InstrumentationRegistry.getInstrumentation()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Instrumentation <span class="title">getInstrumentation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Instrumentation instance = sInstrumentationRef.get();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No instrumentation registered! "</span></span><br><span class="line">                    + <span class="string">"Must run under a registering instrumentation."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续查找<code>sInstrumentationRef</code>是在哪里<code>set</code>进去的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerInstance</span><span class="params">(Instrumentation instrumentation, Bundle arguments)</span> </span>&#123;</span><br><span class="line">        sInstrumentationRef.set(instrumentation);</span><br><span class="line">        sArguments.set(<span class="keyword">new</span> Bundle(arguments));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续查找调用，终于在<code>MonitoringInstrumentation</code>中找到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arguments)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    InstrumentationRegistry.registerInstance(<span class="keyword">this</span>, arguments);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，测试使用的<code>MonitoringInstrumentation</code>，然后进入<code>MonitoringInstrumentation</code>的<code>callActivityOnCreate()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle bundle)</span> </span>&#123;</span><br><span class="line">        mLifecycleMonitor.signalLifecycleChange(Stage.PRE_ON_CREATE, activity);</span><br><span class="line">        <span class="keyword">super</span>.callActivityOnCreate(activity, bundle);</span><br><span class="line">        mLifecycleMonitor.signalLifecycleChange(Stage.CREATED, activity);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>既然我们需要在<code>Activity</code>真正执行<code>onCreate()</code>方法时拦截掉，那如上代码，只要关心<code>signalLifecycleChange()</code>方法，发现了<code>ActivityLifecycleCallback</code>的回调：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">signalLifecycleChange</span><span class="params">(Stage stage, Activity activity)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	Iterator&lt;WeakReference&lt;ActivityLifecycleCallback&gt;&gt; refIter = mCallbacks.iterator();</span><br><span class="line">    <span class="keyword">while</span> (refIter.hasNext()) &#123;</span><br><span class="line">        ActivityLifecycleCallback callback = refIter.next().get();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == callback) &#123;</span><br><span class="line">            refIter.remove();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        		<span class="comment">// ...</span></span><br><span class="line">        		callback.onActivityLifecycleChanged(activity, stage);</span><br><span class="line">        		<span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，问题解决了，我们只要添加一个<code>Activity</code>生命周期回调就搞定了，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ActivityLifecycleMonitorRegistry.getInstance().addLifecycleCallback(<span class="keyword">new</span> ActivityLifecycleCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityLifecycleChanged</span><span class="params">(Activity activity, Stage stage)</span> </span>&#123;</span><br><span class="line">        logger(<span class="string">"onActivityLifecycleChanged, activity"</span> + activity + <span class="string">", stage: "</span> + stage);</span><br><span class="line">        <span class="keyword">if</span>(activity <span class="keyword">instanceof</span> SomethingActivity &amp;&amp; Stage.PRE_ON_CREATE == stage)&#123;</span><br><span class="line">            logger(<span class="string">"onActivityLifecycleChanged, got it!!!"</span>);</span><br><span class="line">            ((SomethingActivity)activity).setModule(mock(SomethingModule.class));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>至此，<code>Activity</code>的 mock <code>module</code>成功了。</p>
<h3 id="1-3-2-针对-Presenter-进行单元测试"><a href="#1-3-2-针对-Presenter-进行单元测试" class="headerlink" title="1.3.2 针对 Presenter 进行单元测试"></a>1.3.2 针对 Presenter 进行单元测试</h3><h4 id="1-3-2-1-测试与-Android-SDK-分离"><a href="#1-3-2-1-测试与-Android-SDK-分离" class="headerlink" title="1.3.2.1 测试与 Android SDK 分离"></a>1.3.2.1 测试与 Android SDK 分离</h4><p><code>Presenter</code> 的单元测试与 <code>Viewer</code> 不一样，在<code>Presenter</code>中不应该有<code>Android SDK</code>相关存在，所有的<code>Inteactor/Api</code>等都是与<code>Android</code>解耦的。显然更加不能有<code>TextView</code>等存在。正是因为这个，使得它可以基于PC上的JVM来进行单元测试，也就是说，<code>Presenter</code>测试不需要Android环境，省去了安装到手机或者模拟器的步骤。</p>
<p>怎么去避免<code>Anroid</code>相关的SDK在<code>Presenter</code>中存在？</p>
<p>的确有极个别的SDK很难避免，比如<code>Log</code>。</p>
<h5 id="1-3-2-1-1-使用-XLog-与-Log-分离"><a href="#1-3-2-1-1-使用-XLog-与-Log-分离" class="headerlink" title="1.3.2.1.1 使用 XLog 与 Log 分离"></a>1.3.2.1.1 使用 XLog 与 Log 分离</h5><p>所以，我们需要一个<code>XLog</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XLog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IXLog delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> DEBUG = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDebug</span><span class="params">(<span class="keyword">boolean</span> debug)</span> </span>&#123;</span><br><span class="line">        XLog.DEBUG = debug;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDelegate</span><span class="params">(IXLog delegate)</span> </span>&#123;</span><br><span class="line">        XLog.delegate = delegate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">v</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG &amp;&amp; <span class="keyword">null</span> != delegate) &#123;</span><br><span class="line">            delegate.v(tag, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">v</span><span class="params">(String tag, String msg, Throwable tr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG &amp;&amp; <span class="keyword">null</span> != delegate) &#123;</span><br><span class="line">            delegate.v(tag, msg, tr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">d</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG &amp;&amp; <span class="keyword">null</span> != delegate) &#123;</span><br><span class="line">            delegate.d(tag, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>在Android环境中使用的策略：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XLog.setDelegate(<span class="keyword">new</span> XLogDef());</span><br></pre></td></tr></table></figure>
<p>其中<code>XLogDef</code>类中的实现为原生Androd SDK的Log实现。</p>
<p>在测试环境中使用的策略：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logDelegateSpy = Mockito.spy(<span class="keyword">new</span> XLogJavaTest());</span><br><span class="line">XLog.setDelegate(logDelegateSpy);</span><br></pre></td></tr></table></figure>
<p>其中<code>XLogJavaTest</code>使用的是纯Java的<code>System.out.println()</code></p>
<h4 id="1-3-2-2-异步操作同步化"><a href="#1-3-2-2-异步操作同步化" class="headerlink" title="1.3.2.2 异步操作同步化"></a>1.3.2.2 异步操作同步化</h4><p>因为<code>Presenter</code>中会有很多的异步任务存在，但是在细粒度的单元测试中，没有异步任务存在的必要性，相应反而增加了测试复杂度。所以，我们应该把所有异步任务切换成同步操作。</p>
<p>调度的切换使用的是<code>RxJava</code>，所以所有切换到主线程也是使用了<code>Android SDK</code>。这里也要采用策略进行处理。</p>
<p>首先定义了几种不同的<code>ScheduleType</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAIN = <span class="number">0x3783</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NET = <span class="number">0x8739</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DB = <span class="number">0x1385</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Schedule</code>选择器中根据<code>ScheduleType</code>进行对应类型的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SchedulerSelector schedulerSelector = SchedulerSelector.get();</span><br><span class="line"></span><br><span class="line">schedulerSelector.putScheduler(SchedulerType.MAIN, <span class="keyword">new</span> SchedulerSelector.SchedulerCreation&lt;Scheduler&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> AndroidSchedulers.mainThread();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">schedulerSelector.putScheduler(SchedulerType.NET, <span class="keyword">new</span> SchedulerSelector.SchedulerCreation&lt;Scheduler&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Schedulers.from(THREAD_POOL_EXECUTOR_NETWORK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">schedulerSelector.putScheduler(SchedulerType.DB, <span class="keyword">new</span> SchedulerSelector.SchedulerCreation&lt;Scheduler&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Schedulers.from(THREAD_POOL_EXECUTOR_DATABASE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>当测试时，对调度选择器中的不同类型的实现进行如下替换：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SchedulerSelector.get().putScheduler(SchedulerType.NET, <span class="keyword">new</span> SchedulerSelector.SchedulerCreation&lt;Scheduler&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Schedulers.immediate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">SchedulerSelector.get().putScheduler(SchedulerType.MAIN, <span class="keyword">new</span> SchedulerSelector.SchedulerCreation&lt;Scheduler&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Schedulers.immediate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>把所有调度都改成当前线程执行即可。</p>
<p>最后<code>Presenter</code>测试几个范例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mock</span></span><br><span class="line">    AccountContract.IAccountViewer viewer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    UserInteractor userInteractor;</span><br><span class="line"></span><br><span class="line">    AccountPresenter presenter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>);</span><br><span class="line">        presenter = <span class="keyword">new</span> AccountPresenter(viewer);</span><br><span class="line">        presenter.userInteractor = userInteractor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestEditUserInfo</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// case 1, succeed</span></span><br><span class="line">        reset(viewer);</span><br><span class="line">        resetLog();</span><br><span class="line"></span><br><span class="line">        when(userInteractor.requestEditUserInfo(any(User.class))).thenReturn(Observable.just(anyBoolean()));</span><br><span class="line">        presenter.requestEditUserInfo(<span class="keyword">new</span> User());</span><br><span class="line"></span><br><span class="line">        verifyOnce(viewer).onRequestEditUserInfo();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// case 2, null</span></span><br><span class="line">        reset(viewer);</span><br><span class="line">        resetLog();</span><br><span class="line">        when(userInteractor.requestEditUserInfo(any(User.class))).thenReturn(Observable.just(<span class="keyword">null</span>));</span><br><span class="line">        presenter.requestEditUserInfo(<span class="keyword">new</span> User());</span><br><span class="line"></span><br><span class="line">        verifyOnce(viewer).onRequestEditUserInfo();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// case 3, error</span></span><br><span class="line">        assertFailedAndError(() -&gt; userInteractor.requestEditUserInfo(any(User.class)), () -&gt; presenter.requestEditUserInfo(<span class="keyword">new</span> User()));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SBuyingRequestPostSucceedViewPresenterTest</span> <span class="keyword">extends</span> <span class="title">BaseJavaTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">public</span> IBuyingRequestPostSucceedView viewer;</span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">public</span> BuyingRequestPostSucceedPresenterModule <span class="keyword">module</span>;</span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">public</span> ApiSearcher apiSearcher;</span><br><span class="line">    <span class="keyword">public</span> IBuyingRequestPostSucceedPresenter presenter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        when(<span class="keyword">module</span>.pickApiSearcher()).thenReturn(apiSearcher);</span><br><span class="line">        presenter = <span class="keyword">new</span> BuyingRequestPostSucceedPresenter(viewer, <span class="keyword">module</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLoadSomethingSuccess</span><span class="params">()</span> <span class="keyword">throws</span> TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">// Mock success observable</span></span><br><span class="line">        when(apiSearcher.searcherSomething(anyString(), anyString(), anyString()))</span><br><span class="line">                .thenReturn(Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;OceanServerResponse&lt;Something&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> OceanServerResponse&lt;Something&gt;&gt; subscriber)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            OceanServerResponse&lt;Something&gt; oceanServerResponse = mock(OceanServerResponse.class);</span><br><span class="line">                            when(oceanServerResponse.getBody(any(Class.class))).thenReturn(mock(Something.class));</span><br><span class="line">                            subscriber.onNext(oceanServerResponse);</span><br><span class="line">                            subscriber.onCompleted();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">                            subscriber.onError(throwable);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;I</span><br><span class="line">                &#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ExecuteStuff executeStuff = <span class="keyword">new</span> ExecuteStuff();</span><br><span class="line">        Answer succeedAnswer = <span class="keyword">new</span> Answer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">answer</span><span class="params">(InvocationOnMock invocationOnMock)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                loggerMockAnswer(invocationOnMock);</span><br><span class="line">                executeStuff.setSucceed(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        doAnswer(succeedAnswer).when(viewer).onLoadSomething(Matchers.any(Something.class));</span><br><span class="line"></span><br><span class="line">        presenter.loadSomething(<span class="string">"whatever"</span>, <span class="string">"whatever"</span>);</span><br><span class="line"></span><br><span class="line">        logger(<span class="string">"loadSomething result: "</span> + executeStuff.isSucceed());</span><br><span class="line">        Assert.assertTrue(<span class="string">"testLoadSomethingSuccess result true"</span>, executeStuff.isSucceed());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLoadSomethingFailed</span><span class="params">()</span> <span class="keyword">throws</span> TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">// Mock error observable</span></span><br><span class="line">        when(apiSearcher.searcherRFQInterestedProductsSuggestion(anyString(), anyString(), anyString()))</span><br><span class="line">                .thenReturn(Observable.&lt;OceanServerResponse&lt;Something&gt;&gt;error(<span class="keyword">new</span> RuntimeException(<span class="string">"mock error observable"</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ExecuteStuff executeStuff = <span class="keyword">new</span> ExecuteStuff();</span><br><span class="line">        Answer failedAnswer = <span class="keyword">new</span> Answer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">answer</span><span class="params">(InvocationOnMock invocationOnMock)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                loggerMockAnswer(invocationOnMock);</span><br><span class="line">                executeStuff.setSucceed(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        doAnswerWhenLogError(failedAnswer);</span><br><span class="line"></span><br><span class="line">        presenter.loadSomething(<span class="string">"whatever"</span>, <span class="string">"whatever"</span>);</span><br><span class="line"></span><br><span class="line">        logger(<span class="string">"testLoadSomethingFailed result: "</span> + executeStuff.isSucceed());</span><br><span class="line">        Assert.assertFalse(<span class="string">"testLoadSomethingFailed result false"</span>, executeStuff.isSucceed());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> mvp </tag>
            
            <tag> dependency injection </tag>
            
            <tag> unit test </tag>
            
            <tag> framework </tag>
            
            <tag> mvc </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]一个干净的架构（翻译）]]></title>
      <url>/2016/03/14/Android-%E4%B8%80%E4%B8%AA%E5%B9%B2%E5%87%80%E7%9A%84%E6%9E%B6%E6%9E%84%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="一个干净的架构"><a href="#一个干净的架构" class="headerlink" title="一个干净的架构"></a>一个干净的架构</h1><blockquote>
<p>原文：<a href="https://blog.8thlight.com/uncle-bob/2012/08/13/the-clean-architecture.html" target="_blank" rel="noopener">https://blog.8thlight.com/uncle-bob/2012/08/13/the-clean-architecture.html</a></p>
</blockquote>
<p><img src="https://blog.8thlight.com/assets/posts/2012-08-13-the-clean-architecture/CleanArchitecture-81565aba46f035911a5018e77a0f2d4e.jpg" alt=""></p>
<p>在过去几年中我们能看到的一系列关于系统架构的思想。它们包括：</p>
<ul>
<li><p><a href="http://alistair.cockburn.us/Hexagonal+architecture" target="_blank" rel="noopener">Hexagonal Architecture</a>（也称为<code>Ports and Adapters</code>），作者是 Alistair Cockburn，并被 Steve Freeman 和 Nat Pryce 在他们很棒的 <a href="http://www.amazon.com/Growing-Object-Oriented-Software-Guided-Tests/dp/0321503627" target="_blank" rel="noopener">Growing Object Oriented Software</a> 这本书中采用。</p>
</li>
<li><p><a href="http://jeffreypalermo.com/blog/the-onion-architecture-part-1/" target="_blank" rel="noopener">Onion Architecture</a>，作者是 Jeffrey Palermo。</p>
</li>
<li><p><a href="http://blog.8thlight.com/uncle-bob/2011/09/30/Screaming-Architecture.html" target="_blank" rel="noopener">Screaming Architecture</a>，来自我去年写的一篇博客。</p>
</li>
<li><p><a href="http://www.amazon.com/Lean-Architecture-Agile-Software-Development/dp/0470684208/" target="_blank" rel="noopener">DCI</a>，来自 James Coplien 和 Trygve Reenskaug。</p>
</li>
<li><p><a href="http://www.amazon.com/Object-Oriented-Software-Engineering-Approach/dp/0201544350" target="_blank" rel="noopener">BCE</a>，来自 Ivar Jacobson 的一本书 <em>Object Oriented Software Engineering: A Use-Case Driven Approach</em></p>
</li>
</ul>
<p>尽管这些书在细节上有些不同之处，但是它们是非常相似的。从分离的观点上来讲它们都有着同样的目标。它们都是通过软件分层来实现分离的。每一个都至少有一层是用于业务规则，另外一层用于接口。</p>
<p>这些架构生产系统：</p>
<p>1. <strong>框架独立性</strong>。架构并不依赖于已经存在的某些库的有负载的特性。这允许你作为工具去使用框架，而不是把你的系统强塞到限制和约束中。</p>
<p>2. <strong>可测试性</strong>。业务规则可以脱离UI、数据库、web服务器和其它外部元素去进行测试。</p>
<p>3. <strong>UI的独立性</strong>。UI可以在不修改系统其它地方的情况下很容易地被改变。比如，一个Web UI可以使用console UI替换，而不改变任何业务规则。</p>
<p>4. <strong>数据库独立</strong>。你可以使用Mongo、BitTable、CouchDB或者其它来置换Oracle或SQL Server。你的业务规则不会被数据库束缚。</p>
<p>5. <strong>外部代理的独立性</strong>。事实上，你的业务规则根本不知道外面的世界。</p>
<p>这篇文章顶部的图表就是尝试所有这些结构到单个可操作的思想中去。</p>
<h2 id="依赖准则"><a href="#依赖准则" class="headerlink" title="依赖准则"></a>依赖准则</h2><p>同心圆表示不同软件的区域。一般情况下，走得越远，软件水平也会变得越高。外面的圆是机制，而内部的圆是政策。</p>
<p>使得这个架构可行的最重要的规则是 <em>依赖准则</em> 。这个准则指 <em>代码的依赖</em> 只能 <em>向内</em> 。没有一个内部圆可以知道外部圆的任何东西。尤其是在内部圆声明的东西名字不能被内部圆中的代码提到。这里包括方法、类、变量、或者其它软件实体的名字。</p>
<p>同样的原因，外部圆中用到的数据格式不能被内部圆使用，尤其是这些格式是被外部圆中的框架生成的。我们不希望任何在外部圆中的东西影响到内部圆。</p>
<h3 id="Entities"><a href="#Entities" class="headerlink" title="Entities"></a><em>Entities</em></h3><p>实体封装了 <em>企业级</em> 业务规则。一个实体可以是一个有方法的对象，或者有一系列的数据结构和函数。只要这个实体可以被很多不同企业中的应用使用就没关系。</p>
<p>如果你没有一个企业，并且只是编写单个的应用程序，那么这些实体就是应用程序中的业务对象。它封装了大部分一般的和高级别的规则。它们最不可能在外部改变的时候被改变。比如，由于安全你不希望这些对象被导航页面改变而影响。没有特别的可操作的改变可以影响实体层。</p>
<h2 id="用例"><a href="#用例" class="headerlink" title="用例"></a>用例</h2><p>软件在这一层包含应用程序指定的业务规则。它封装和实现了这个系统的所有用例。这些用例转化数据流到实体和从实体转化到数据流，然后这些实体直接使用它们企业范围的业务规则来达到用例的目的。</p>
<p>我们不期望改变这一层来影响到实体。我们也不希望这一层被外部的改变，比如数据库、UI、任何常见的框架等影响。在这一层在这的观点上是被孤立的。</p>
<p>然而，我们要做的是希望应用程序操作的改变会影响到软件的用例，所以应该是在这一层。如果用例的细节改变了，那么这一层的某些代码当然也会受到影响。</p>
<h2 id="接口适配器"><a href="#接口适配器" class="headerlink" title="接口适配器"></a>接口适配器</h2><p>在软件的这一层是一系列的适配器，通过最方便的用例和实体转换数据格式，最方便的外部代理格式有数据库或者Web等。在这一层，举个例子，将会完整包含 GUI 的 MVC 架构。Presenters、Views、 Controllers 都属于这里。Models有可能仅仅是数据结构，它们从 contrllers 被传入到用例中，然后从用例到 presenters 和 views。</p>
<p>同样的，在这一层，数据会被转换，从最方便的方式如实体和用例，转换到使用的用于持久框架的最方便的方式，即数据库。<br>这个圆中没有代码可以向内知道任何关于数据库的东西。如果数据库是一个 SQL database，那么所有 SQL 应该在这一层被限制，特别是在这一层需要进行数据库操作的部分。</p>
<p>在这一层也有必要从一些外部形式去转换数据，比如一个外部服务，转化为内部用例和实体使用的形式。</p>
<h2 id="框架和驱动"><a href="#框架和驱动" class="headerlink" title="框架和驱动"></a>框架和驱动</h2><p>最外层通常是框架和工具，通常是数据库、Web 框架等的组合。通常你不需要在这一层编写太多的代码，除了一些用于向内圈进行通信的固定代码。</p>
<p>这一层是所有细节走向的地方。Web是一个细节。数据库是一个细节。我们把这些东西放置在外部，这样它们就难以造成伤害。</p>
<h2 id="只有四个圆？"><a href="#只有四个圆？" class="headerlink" title="只有四个圆？"></a>只有四个圆？</h2><p>不，这些圆只是简图。你可能会需要多于这四个圆。这里并没有一个规则来让你必须要使用这四个圆。然而，<em>依赖规则</em> 总是适用的。代码依赖总是指向内部。当你向内移动时，抽象级别增加。最外层的圆是最低级别的具体细节。当你向内移动，就会变得更加抽象和更高级别策略的封装。最内部的圆是最通用的。</p>
<h2 id="跨越边界"><a href="#跨越边界" class="headerlink" title="跨越边界"></a>跨越边界</h2><p>右下方的图是一个我们怎么去跨越圆的边界的例子。它展示了 Controllers 和 Presenters 通过下一层使用用例进行通信。注意控制流。它在controller中开始，通过用例，然后再Presenter中执行。也要注意代码的依赖。它们每一个都是向内指向用例。</p>
<p>我们通常使用 <a href="http://en.wikipedia.org/wiki/Dependency_inversion_principle" target="_blank" rel="noopener">依赖反转准则</a> 来解决这个明显的矛盾。在像Java的语言中，举个例子，我们使用了interfaces和继承关系，这样代码依赖关系控制权被反转，达到跨越边界的目的。</p>
<p>举个例子，考虑到用例需要调用Presenter。然而，这些调用必须不能是直接的，因为它会违反<em>依赖准则</em>：内部圆不能提到外部圆中的任何名字。所以我们这种情况我们会调用在内部圆中的接口（就像这里展示的 Use Case Output Port)），然后在外部圆中的Presenter去实现它。</p>
<p>同样的技术在架构的所有跨越边界的地方被使用到。我们利用动态代理的优势去创建代码依赖来达到控制反转，所以我们可以确保无论什么方向的 <em>依赖准则</em> 控制流都能有效。</p>
<h2 id="什么数据跨越边界。"><a href="#什么数据跨越边界。" class="headerlink" title="什么数据跨越边界。"></a>什么数据跨越边界。</h2><p>典型的跨越边界的数据就是简单的数据结构。如果你喜欢你可以使用基本结构或者简单的数据传输对象。或者是方法调用时的简单的参数数据。或者你可以把它放进一个HashMap，或者构建它到一个对象中。重要的是分离的、简单的数据结构跨越过边界。我们不希望去欺骗并传递 <em>Entities</em> 或者数据库的行。我们不希望数据结构有任何的违反 <em>依赖准则</em> 的依赖。</p>
<p>举个例子，很多数据库框架通过一个查询返回一个方便的数据形式的响应。我们可能称它为一个RowStructure。我们不希望这个行结构向内跨越边界。这将违反 <em>依赖准则</em> 因为这将强制一个内部圆去知道外部圆的一些东西。</p>
<p>所以当我们跨越边界传递数据时，它对于内圆来说总是以最方便的形式的。</p>
<p>遵守这些简单的规则并不难，前进的道路上会解决很多头疼的事情。通过分离软件到不同层次，并遵守 <em>依赖准则</em> ，你将会创建一个本质上可测试的系统，这意味这所有的好处。当任何系统外置的部分变得过时，就像数据库，或者web框架，你可以在最小的改动下替换这些外置元素。</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> framework </tag>
            
            <tag> best practices </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Dagger2Metrics - 测量DI图表初始化的性能（翻译）]]></title>
      <url>/2016/02/16/Android-Dagger2Metrics-%E6%B5%8B%E9%87%8FDI%E5%9B%BE%E8%A1%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E6%80%A7%E8%83%BD%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="Dagger2Metrics-测量DI图表初始化的性能"><a href="#Dagger2Metrics-测量DI图表初始化的性能" class="headerlink" title="Dagger2Metrics - 测量DI图表初始化的性能"></a>Dagger2Metrics - 测量DI图表初始化的性能</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/dagger2metrics-measure-performance-of-graph-initialization/" target="_blank" rel="noopener">http://frogermcs.github.io/dagger2metrics-measure-performance-of-graph-initialization/</a></p>
</blockquote>
<p>几个月前我们通过 <a href="http://frogermcs.github.io/dagger-graph-creation-performance/" target="_blank" rel="noopener">Dagger 2 - graph creation performance</a> 经历了一些可能会遇到的问题。多亏 <a href="http://tools.android.com/tips/traceview" target="_blank" rel="noopener">TraceView</a> 这个工具我们可以很确切地看到初始化所有需要的依赖需要多少时间。但是这并不简单 - 我们必须要在我们代码中找出需要开始和停止测量的地方，然后在Android Studio中dump和分析它们。为了让它变得更简单，我们准备了一个简单的库，它可以帮助我们捕捉潜在的性能问题。</p>
<h2 id="Dagger2Metrics"><a href="#Dagger2Metrics" class="headerlink" title="Dagger2Metrics"></a>Dagger2Metrics</h2><h3 id="Dagger-2-初始化过程的性能测量库"><a href="#Dagger-2-初始化过程的性能测量库" class="headerlink" title="Dagger 2 初始化过程的性能测量库"></a>Dagger 2 初始化过程的性能测量库</h3><p><em>下面的描述内容是从 Dagger2Metrics Github <a href="https://github.com/frogermcs/dagger2metrics" target="_blank" rel="noopener">项目网站</a>拷贝过来的。</em></p>
<p>如果你在Android应用中使用Dagger 2来进行依赖注入，你可能知道它最大的一处优化就是Google（原来是Square）的优秀工程师通过使用非反射代码实现。</p>
<p>即使有了所有的这些优化以及完全的非动态代码生成，但是仍然有潜在的性能问题隐藏在我们的代码中和所有通过Dagger 2注入的第三方代码中。</p>
<p>性能的问题通常是慢慢地变慢的，所以在每天的开发中是很难意识到我们的app（或者Activity、或者其他View）启动50ms或者更长。又一次变成150ms，又一次变成100ms…</p>
<p>使用Dagger2Metrics，你将可以看到初始化所有需要的依赖需要多少时间（以及这些依赖之间的依赖关系）。</p>
<p><img src="https://raw.githubusercontent.com/frogermcs/dagger2metrics/master/art/dagger2metrics.png" alt=""></p>
<h3 id="准备开始"><a href="#准备开始" class="headerlink" title="准备开始"></a>准备开始</h3><p>在你的<code>build.gradle</code>中：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">  repositories &#123;</span><br><span class="line">    jcenter()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dependencies &#123;</span><br><span class="line">    classpath <span class="string">'com.frogermcs.dagger2metrics:dagger2metrics-plugin:0.2'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.frogermcs.dagger2metrics'</span></span><br></pre></td></tr></table></figure>
<p>在你的<code>Application</code>类中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">super</span>.onCreate();</span><br><span class="line">     <span class="comment">//Use it only in debug builds</span></span><br><span class="line">     <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">         Dagger2Metrics.enableCapturing(<span class="keyword">this</span>);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这样就完成了。在你的app中，你将会看到notification，它可以打开所有已完成的初始化的一个简单的概述。</p>
<p><img src="https://raw.githubusercontent.com/frogermcs/dagger2metrics/master/art/dagger2metrics-notification.png" alt=""></p>
<h3 id="它是怎么工作的？"><a href="#它是怎么工作的？" class="headerlink" title="它是怎么工作的？"></a>它是怎么工作的？</h3><p>Dagger2Metrics会捕捉所有的初始化，通过 - 所有带有 <code>@Module</code> -&gt; <code>@Provides</code> 注解的方法和<code>@Inject</code>注解的构造方法。</p>
<p>总之，你会看到大多数顶级注入依赖地依赖关系树。每一个依赖显示了提供这些对象到Dagger 2对象图表需要多少时间（构建本身所用时间以及所有的依赖）。</p>
<p><img src="https://raw.githubusercontent.com/frogermcs/dagger2metrics/master/art/dagger2metrics.png" alt=""></p>
<h3 id="为什么我看不到所有（子）依赖？"><a href="#为什么我看不到所有（子）依赖？" class="headerlink" title="为什么我看不到所有（子）依赖？"></a>为什么我看不到所有（子）依赖？</h3><p>测量树不会显示那些已经提供给Dagger图表的依赖，所以只有从头开始构建的才会显示出来。主要是因为可读性以及另外一个简单的理由就是 - 我们不想在大多数没有错误的情况下去测量Dagger 2的性能。我们应该确保我们的代码尽可能快地提供依赖。</p>
<h3 id="自定义"><a href="#自定义" class="headerlink" title="自定义"></a>自定义</h3><p>Dagger2Metrics 有3种默认级别的警告：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Dagger2Metrics.WARNING_1_LIMIT_MILLIS // 30ms</span><br><span class="line">Dagger2Metrics.WARNING_2_LIMIT_MILLIS // 50ms</span><br><span class="line">Dagger2Metrics.WARNING_3_LIMIT_MILLIS // 100ms</span><br></pre></td></tr></table></figure>
<p>你可以根据你的需要对它们进行调整。</p>
<h3 id="例子app"><a href="#例子app" class="headerlink" title="例子app"></a>例子app</h3><p>你可以查看 <a href="https://github.com/frogermcs/githubclient" target="_blank" rel="noopener">GithubClient</a> 项目 - 一个展示怎么使用Dagger 2的Android app的例子。最近的版本在debug build中使用了Dagger2Metrics。</p>
<h3 id="更多关于Dagger-2"><a href="#更多关于Dagger-2" class="headerlink" title="更多关于Dagger 2"></a>更多关于Dagger 2</h3><p>如果你刚开始接触Dagger 2，下面的资源列表可以帮助你：</p>
<p><a href="https://github.com/frogermcs/githubclient" target="_blank" rel="noopener">GithubClient</a> - 基于Dagger 2依赖注入框架的Github API 客户端实现的例子。</p>
<p>Blog posts：</p>
<ul>
<li><a href="http://frogermcs.github.io/dagger-1-to-2-migration/" target="_blank" rel="noopener">Dagger 1 to 2 migration process</a></li>
<li><a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-introdution-to-di/" target="_blank" rel="noopener">Introdution to Dependency Injection</a></li>
<li><a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-the-api/" target="_blank" rel="noopener">Dagger 2 API</a></li>
<li><a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-custom-scopes/" target="_blank" rel="noopener">Dagger 2 - custom scopes</a></li>
<li><a href="http://frogermcs.github.io/dagger-graph-creation-performance/" target="_blank" rel="noopener">Dagger 2 - graph creation performance</a></li>
</ul>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3><p>以上描述的完整代码可见Github <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">repository</a>。</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> dependency injection </tag>
            
            <tag> dagger2 </tag>
            
            <tag> memory </tag>
            
            <tag> DI </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[使用Dagger 2依赖注入 - 图表创建的性能（翻译）]]></title>
      <url>/2016/01/04/Android-%E4%BD%BF%E7%94%A8Dagger-2%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5-%E5%9B%BE%E8%A1%A8%E5%88%9B%E5%BB%BA%E7%9A%84%E6%80%A7%E8%83%BD%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="使用Dagger-2依赖注入-图表创建的性能"><a href="#使用Dagger-2依赖注入-图表创建的性能" class="headerlink" title="使用Dagger 2依赖注入 - 图表创建的性能"></a>使用Dagger 2依赖注入 - 图表创建的性能</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/dagger-graph-creation-performance/" target="_blank" rel="noopener">http://frogermcs.github.io/dagger-graph-creation-performance/</a></p>
</blockquote>
<p><a href="https://twitter.com/search?q=%23perfmatters" target="_blank" rel="noopener">#PerfMatters</a> - 最近非常流行标签，尤其在Android世界中。不管怎样，apps只需要正常工作就可以的时代已经过去了。现在所有的一切都应该是令人愉悦的，流畅并且快速。举个例子，Instagram <a href="http://instagram-engineering.tumblr.com/post/97740520316/betterandroid" target="_blank" rel="noopener">花费了半年的时间</a> 只是让app更加快速，更加美观，和更好的屏幕适配性。</p>
<p>这就是为什么今天我想去分享给你一些小的建议，它会在你app启动时间上有很大的影响（尤其是当app使用了一些额外库的时候）。</p>
<h2 id="对象图表的创建"><a href="#对象图表的创建" class="headerlink" title="对象图表的创建"></a>对象图表的创建</h2><p>大多情况下，在app开发过程中，它的启动时间或多或少会增加。有时随着一天天地开发它是很难被注意到的，但是当你把第一个版本和你能找到的最近的版本比较时区别就会相对比较大了。</p>
<p>原因很可能就在于dagger对象图表的创建过程。</p>
<p>Dagger 2？你可能会问，确切地说 - 就算你移除了那些基于反射的实现方案，并且你的代码是在编译时期生成的，但是别忘了对象的创建仍然发生是在运行时。</p>
<p>对象（还有它的依赖）会在第一次被注入时创建。Jake Wharton 在Dagger 2演示中的一些幻灯片很清楚地展示了这一点：</p>
<p>以下表示在我们的 <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">GithubClient</a> 例子app中它是怎样的：</p>
<p>1. App第一次（被kill之后）被启动。Application对象并没有<code>@Inject</code>属性，所以只有<code>AppComponent</code>对象被创建。<br>2. App创建了<code>SplashActivity</code> - 它有两个<code>@Inject</code>属性：<code>AnalyticsManager</code>和<code>SplashActivityPresenter</code>。<br>3. <code>AnalyticsManager</code>依赖已被创建的<code>Application</code>对象。所以只有<code>AnalyticsManager</code>构造方法被调用。<br>4. <code>SplashSctivityPresenter</code>依赖：<code>SplashActivity</code>，<code>Validator</code>和<code>UserManager</code>。<code>SplashActivity</code>已被提供，<code>Validator</code>和<code>UserManager</code>应该被创建。<br>5. <code>UserManager</code>依赖需要被创建的<code>GithubApiService</code>。之后<code>UserManager</code>被创建。<br>6. 现在我们拥有了所有依赖，<code>SplashActivityPresenter</code>被创建。</p>
<p><img src="http://frogermcs.github.io/images/18/graph.png" alt=""></p>
<p>有点混乱，但是就结果来说，在<code>SplashActivity</code>被创建之前（我们假设对象注入的操作只会在<code>onCreate()</code>方法中执行）我们必须要等待以下构造方法（可选配置）：</p>
<ul>
<li><code>GithubApiService</code>（它也使用了一些依赖，如<code>OkHttpClient</code>，一个<code>RestAdapter</code>）</li>
<li><code>UserManager</code></li>
<li><code>Validator</code></li>
<li><code>SplashActivityPresenter</code></li>
<li><code>AnalyticsManager</code></li>
</ul>
<p>一个接一个地被创建。</p>
<p>嘿，别担心，更复杂地图表也几乎被立即创建。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>现在让我们想象下，我们有两个外部的库需要在app启动时被初始化（比如，Crashlytics, Mixpanel, Google Analytics, Parse等等）。想象下我们的<code>HeavyExternalLibrary</code>看起来如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeavyExternalLibrary</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> initialized = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HeavyExternalLibrary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        initialized = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!initialized) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Call init() before you use this library"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单说 - 构造方法是空的，并且调用几乎不花费任何东西。但是有一个<code>init()</code>方法，它耗时500ms并且在我们使用这个库之前必须要被调用。确保在我们module的某处的某一时刻调用了<code>init()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AppModule</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="function">HeavyExternalLibrary <span class="title">provideHeavyExternalLibrary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HeavyExternalLibrary heavyExternalLibrary = <span class="keyword">new</span> HeavyExternalLibrary();</span><br><span class="line">    heavyExternalLibrary.init();</span><br><span class="line">    <span class="keyword">return</span> heavyExternalLibrary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们的<code>HeavyExternalLibrary</code>成为了<code>SplashActivityPresenter</code>的一部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="meta">@ActivityScope</span></span><br><span class="line">SplashActivityPresenter</span><br><span class="line">provideSplashActivityPresenter(Validator validator, UserManager userManager, HeavyExternalLibrary heavyExternalLibrary) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SplashActivityPresenter(splashActivity, validator, userManager, heavyExternalLibrary);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后会发生什么？我们app启动时间需要500ms还多，只是因为<code>HeavyExternalLibrary</code>的初始化，这过程会在SplashActivityPresenter依赖图表创建中执行。</p>
<h2 id="测量"><a href="#测量" class="headerlink" title="测量"></a>测量</h2><p>Android SDK（Android Studio本身）给我们提供了一个随着应用执行的时间的可视化的工具 - <a href="http://tools.android.com/tips/traceview" target="_blank" rel="noopener">Traceview</a>。多亏这个我们可以看见每个方法花了多少时间，并且找出注入过程中的瓶颈。</p>
<p>顺便说一下，如果你以前没有见过它，可以在<a href="http://blog.udinic.com/2015/09/15/speed-up-your-app/" target="_blank" rel="noopener">Udi Cohen的博客</a>看下这篇Android性能优化相关的文章。</p>
<p>Traceview可以直接从Android Studio（Android Monitor tab -&gt; CPU -&gt; Start/Stop Method Tracing）启动，它有时并不是那么精确的，尤其是当我们尝试在app启动时点击<code>Start</code>。</p>
<p>对于我们而言，幸运的是当我们知道确切的需要被测量的代码位置时，有一个可以使用的方法。<a href="http://developer.android.com/reference/android/os/Debug.html#startMethodTracing(java.lang.String)" target="_blank" rel="noopener">Debug.startMethodTracing()</a>可以用来指定我们代码中需要被启动测量的位置。<code>Debug.stopMethodTracing()</code>停止追踪并且创建一个新的文件。</p>
<p>为了实践，我们测量了SplashActivity的注入过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupActivityComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Debug.startMethodTracing(<span class="string">"SplashTrace"</span>);</span><br><span class="line">    GithubClientApplication.get(<span class="keyword">this</span>)</span><br><span class="line">            .getAppComponent()</span><br><span class="line">            .plus(<span class="keyword">new</span> SplashActivityModule(<span class="keyword">this</span>))</span><br><span class="line">            .inject(<span class="keyword">this</span>);</span><br><span class="line">    Debug.stopMethodTracing();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>setupActivityComponent()</code>是在<code>onCreate()</code>中调用的。</p>
<p>文档结果被保存在<code>/sdcard/SplashTrace.trace</code>中。</p>
<p>在你的terminal中把它pull出来：</p>
<p><code>$ adb pull /sdcard/SplashTrace.trace</code></p>
<p>现在阅读这个文件所要做的全部事情只是把它拖拽到Android Studio：</p>
<p><img src="http://frogermcs.github.io/images/18/trace.png" alt=""></p>
<p>你应该会看到类似以下的东西：</p>
<p><img src="http://frogermcs.github.io/images/18/traceview.png" alt=""></p>
<p>当然，我们这个例子中的结果是非常清晰的：<code>AppModule_ProvideHeavyExternalLibraryFactory.get()</code>（HeavyExternalLibrary被创建的地方）花费了500ms。</p>
<p>真正好玩的地方是，缩放trace尾部的那一小块地方：</p>
<p><img src="http://frogermcs.github.io/images/18/traceview2.png" alt=""></p>
<p>看到不同之处了吗？比如构建类：<code>AnalyticsManager</code>花了小于1ms。</p>
<p>如果你想看到它，这里有这个例子中的<a href="https://github.com/frogermcs/frogermcs.github.io/raw/master/files/18/SplashTrace.trace" target="_blank" rel="noopener">SplashTrace.trace</a>文件。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>不幸的是，对于这类性能问题，有时并没有明确的回答。这里有两种方式会给我们很大的帮助。</p>
<h3 id="懒加载（临时的解决方案）"><a href="#懒加载（临时的解决方案）" class="headerlink" title="懒加载（临时的解决方案）"></a>懒加载（临时的解决方案）</h3><p>首先，我们要思考是否你需要所有的注入依赖。也许其中一部分可以延迟一定时间后再加载？当然这并不解决真正的问题（UI线程将会在第一次调用Lazy&lt;&gt;.get()方法的时候阻塞）。但是在某些情况下对启动耗时有帮助（尤其是很少地方会使用到的一些对象）。查看<a href="http://google.github.io/dagger/api/2.0/dagger/Lazy.html" target="_blank" rel="noopener">Lazy&lt;&gt;</a>接口文档获取更多的信息和例子代码。</p>
<p>简单说，每一个你使用<code>@Inject SomeClass someClass</code>的地方都可以替换成<code>@Inject Lazy&lt;SomeClass&gt; someClassLazy</code>（构造方法注入也是）。然后获取某个类的实例时必须要调用<code>someClassLazy.get()</code>。</p>
<h3 id="异步对象创建"><a href="#异步对象创建" class="headerlink" title="异步对象创建"></a>异步对象创建</h3><p>第二种选择（它仍然只是更多的想法而不是最终的解决方案）是在后台线程中的某处进行对象的初始化，缓存所有方法的调用并在初始化之后再回调它们。</p>
<p>这种方案的缺点是它必须要单独地准备我们要包含的所有类。并且它只有在方法调用可以被执行的将来（就像任何的analytics - 在一些事件被发生之后才可以），这些对象才可能正常工作。</p>
<p>以下就是我们的<code>HeavyExternalLibrary</code>使用这种解决方案后的样子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeavyLibraryWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HeavyExternalLibrary heavyExternalLibrary;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isInitialized = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    ConnectableObservable&lt;HeavyExternalLibrary&gt; initObservable;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HeavyLibraryWrapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        initObservable = Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> HeavyExternalLibrary&gt; subscriber)</span> </span>&#123;</span><br><span class="line">                HeavyLibraryWrapper.<span class="keyword">this</span>.heavyExternalLibrary = <span class="keyword">new</span> HeavyExternalLibrary();</span><br><span class="line">                HeavyLibraryWrapper.<span class="keyword">this</span>.heavyExternalLibrary.init();</span><br><span class="line">                subscriber.onNext(heavyExternalLibrary);</span><br><span class="line">                subscriber.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()).publish();</span><br><span class="line"></span><br><span class="line">        initObservable.subscribe(<span class="keyword">new</span> SimpleObserver&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(HeavyExternalLibrary heavyExternalLibrary)</span> </span>&#123;</span><br><span class="line">                isInitialized = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        initObservable.connect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isInitialized) &#123;</span><br><span class="line">            HeavyExternalLibrary.callMethod();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            initObservable.subscribe(<span class="keyword">new</span> SimpleObserver&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(HeavyExternalLibrary heavyExternalLibrary)</span> </span>&#123;</span><br><span class="line">                    heavyExternalLibrary.callMethod();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当<code>HeavyLibraryWrapper</code>构造方法被调用，库的初始化会在后台线程（这里的<code>Schedulers.io()</code>）中执行。在此期间，当用户调用<code>callMethod()</code>，它会增加一个新的subscription到我们的初始化过程中。当它完成时（onNext()方法返回一个已初始化的HeavyExternalLibrary对象）被缓存的回调会被传送到这个对象。</p>
<p>目前为止，这个想法还是非常简单并且仍然是在开发之中。这里可能会引起内存泄漏（比如，我们不得不在callMethod()方法中传入一些参数），但一般还是适用于简单的情况下的。</p>
<h3 id="还有其它方案？"><a href="#还有其它方案？" class="headerlink" title="还有其它方案？"></a>还有其它方案？</h3><p>性能优化的过程是非常孤独的。但是如果你想要分享你的ideas，请在这里分享吧。</p>
<p>感谢你的阅读！</p>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3><p>以上描述的完整代码可见Github <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">repository</a>。</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> dependency injection </tag>
            
            <tag> dagger2 </tag>
            
            <tag> DI </tag>
            
            <tag> google </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[使用Dagger 2依赖注入 - 自定义Scope（翻译）]]></title>
      <url>/2016/01/02/Android-%E4%BD%BF%E7%94%A8Dagger-2%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5-%E8%87%AA%E5%AE%9A%E4%B9%89Scope%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="使用Dagger-2依赖注入-自定义Scope"><a href="#使用Dagger-2依赖注入-自定义Scope" class="headerlink" title="使用Dagger 2依赖注入 - 自定义Scope"></a>使用Dagger 2依赖注入 - 自定义Scope</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-custom-scopes/" target="_blank" rel="noopener">http://frogermcs.github.io/dependency-injection-with-dagger-2-custom-scopes/</a></p>
</blockquote>
<p>这章是展示使用Dagger 2在Android端实现依赖注入的系列中的一部分。今天我会花点时间在自定义Scope（作用域）上面 - 它是很实用，但是对于刚接触依赖注入的人会有一点困难。</p>
<h2 id="Scope-它给我们带来了什么？"><a href="#Scope-它给我们带来了什么？" class="headerlink" title="Scope - 它给我们带来了什么？"></a>Scope - 它给我们带来了什么？</h2><p>几乎所有的项目都会用到单例 - 比如API clients，database helpers，analytics managers等。因为我们不需要去关心实例化（由于依赖注入），我们不应该在我们的代码中考虑关于怎么得到这些对象。取而代之的是<code>@Inject</code>注解应该提供给我们适合的实例。</p>
<p>在Dagger 2中，Scope机制可以使得在scope存在时保持类的单例。在实践中，这意味着被限定范围为<code>@ApplicationScope</code>的实例与Applicaiton对象的生命周期一致。<code>@ActivityScope</code>保证引用与Activity的生命周期一致（举个例子我们可以在这个Activity中持有的所有fragment之间分享一个任何类的单例）。</p>
<p>简单来说 - scope给我们带来了“局部单例”，生命周期取决于scope自己。</p>
<p>但是需要弄清楚的是 - Dagger 2默认并不提供<code>@ActivityScope</code> 或者/并且 <code>@ApplicationScope</code> 这些注解。这些只是最常用的自定义Scope。只有<code>@Singleton</code> scope是默认提供的（由Java自己提供）。</p>
<h2 id="Scope-实践案例"><a href="#Scope-实践案例" class="headerlink" title="Scope - 实践案例"></a>Scope - 实践案例</h2><p>为了更好地去理解Dagger 2中的scope，我们直接进入实践案例。我们将要去实现比Application/Activity scope更加复杂一点的scope。为此我们将使用 <a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-the-api/" target="_blank" rel="noopener">上一文章</a> 中的 <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">GithubClient</a> 例子。我们的app应需要三种scope：</p>
<ul>
<li><strong>@Sigleton</strong> - application scope</li>
<li><strong>@UserScope</strong> - 用于与被选中的用户联系起来的类实例的scope（在真实的app中可以是当前登录的用户）。</li>
<li><strong>@ActivityScope</strong> - 生命周期与Activity（在我们例子中的呈现者）一致的实例的scope</li>
</ul>
<p>讲解的<code>@UserScope</code>是今天方案与以前文章之间的主要的不同之处。从用户体验的角度来说它没有带给我们任何东西，但是从架构的观点来说它帮助我们在不传入任何意图参数的情况下提供了User实例。使用方法参数获取用户数据的类（在我们的例子中是<code>RepositoriesManager</code>）中我们可以通过构造参数（它将通过依赖图表提供）的方式来获取User实例并在需要的时候被初始化，而不是在app启动的时候创建它。这意味着<code>RepositoriesManager</code>可以在我们从Github API获取到用户信息（在<code>RepositoriesListActivity</code>呈现之前）之后被创建。</p>
<p>这里有个我们app中scopes和components呈现的简单图表。</p>
<p><img src="http://frogermcs.github.io/images/15/dagger-scopes.png" alt=""></p>
<p>单例（Application scope）是最长的scope（在实践中是与application一样长）。UserScope作为Application scope的一个子集scope，它可以访问它的对象（我们可以从父scope中得到对象）。ActivityScope（生命周期与Activity一致）也是如此 - 它可以从UserScope和ApplicationScope中得到对象。</p>
<h2 id="Scope生命周期的例子"><a href="#Scope生命周期的例子" class="headerlink" title="Scope生命周期的例子"></a>Scope生命周期的例子</h2><p>这里有一个我们app中scope生命周期的案例：</p>
<p><img src="http://frogermcs.github.io/images/15/scopes-lifecycle.png" alt=""></p>
<p>单例的生命周期是从app启动后的所有的时期，当我们从Github API（在真实app中是用户登录之后）得到了<code>User</code>实例时UserScope被创建了，然后当我们回退到SplashActivity（在真实app中是用户退出之后）时被销毁。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>在Dagger 2中，Scope的实现归结于对Components的一个正确的设置。一般情况下我们有两种方式 - 使用<code>Subcomponent</code>注解或者使用Components依赖。它们两者最大的区别就是对象图表的共享。Subcomponents可以访问它们parent的所有对象图表，而Component依赖只能访问通过Component接口暴露的对象。</p>
<p>我选择第一种使用 <code>@Subcomponent</code> 注解，如果你之前使用过Dagger 1，它几乎与从<code>ObjectGraph</code>创建一个subgraphs（子图表）是一样的。此外，对于创建一个subgraphs的方法我们会使用类似的命名法则（但这不是强制性的）。</p>
<p>我们从<code>AppComponent</code>的实现开始：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component</span>(</span><br><span class="line">        modules = &#123;</span><br><span class="line">                AppModule.class,</span><br><span class="line">                GithubApiModule.class</span><br><span class="line">        &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">UserComponent <span class="title">plus</span><span class="params">(UserModule userModule)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">SplashActivityComponent <span class="title">plus</span><span class="params">(SplashActivityModule splashActivityModule)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它将会是其它subcomponents的根Components：<code>UserComponent</code>和Activities Components。正如你注意到的那样（尤其如果你在前面的文章中看过的<a href="https://github.com/frogermcs/GithubClient/blob/1bf53a2a36c8a85435e877847b987395e482ab4a/app/src/main/java/frogermcs/io/githubclient/AppComponent.java" target="_blank" rel="noopener">AppComponent 实现</a>）所有的返回依赖图表对象的公开方法全部消失了。因为我们有subcomponents了，我们不需要去公开去暴露依赖了 - 无论如何subgraphs都可以访问它们全部了。</p>
<p>作为替代，我们新增了两个方法：</p>
<ul>
<li><code>UserComponent plus(UserModule userModule);</code></li>
<li><code>SplashActivityComponent plus(SplashActivityModule splashActivityModule);</code></li>
</ul>
<p>这表示，我们可以从<code>AppComponent</code>创建两个子Components（subcomponents）：<code>UserComponent</code>和<code>SplashActivityComponent</code>。因为它们都是AppComponent的subcomponents，所以它们两者都可以访问<code>AppModule</code>和<code>GithubApiModule</code>创建的实例。</p>
<p><em>这些方法的命名法则是：返回类型是subcomponent类，方法名字随意，参数是这个subcomponent需要的modules。</em></p>
<p>如你所见，<code>UserComponent</code>需要另一个module（它通过<code>plus()</code>方法的参数传入）。这样，我们通过增加一个新的用于生成对象的module，继承<code>AppComponent</code>图表。<code>UserComponent</code>类看起来这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UserScope</span></span><br><span class="line"><span class="meta">@Subcomponent</span>(</span><br><span class="line">        modules = &#123;</span><br><span class="line">                UserModule.class</span><br><span class="line">        &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line">    <span class="function">RepositoriesListActivityComponent <span class="title">plus</span><span class="params">(RepositoriesListActivityModule repositoriesListActivityModule)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">RepositoryDetailsActivityComponent <span class="title">plus</span><span class="params">(RepositoryDetailsActivityModule repositoryDetailsActivityModule)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然<code>@UserScope</code>注解是我们自己创建的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scope</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> UserScope &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以从<code>UserComponent</code>创建另外两个subcomponents：<code>RepositoriesListActivityComponent</code>和<code>RepositoryDetailsActivityComponent</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UserScope</span></span><br><span class="line"><span class="meta">@Subcomponent</span>(</span><br><span class="line">        modules = &#123;</span><br><span class="line">                UserModule.class</span><br><span class="line">        &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line">    <span class="function">RepositoriesListActivityComponent <span class="title">plus</span><span class="params">(RepositoriesListActivityModule repositoriesListActivityModule)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">RepositoryDetailsActivityComponent <span class="title">plus</span><span class="params">(RepositoryDetailsActivityModule repositoryDetailsActivityModule)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并且更重要的是所有scope的东西都发生在这里。所有<code>UserComponent</code>中从<code>AppComponent</code>继承过来的仍然shi是单例的（是 Applicaton scope）。但是<code>UserModule</code>（<code>UserComponent</code>的那部分）创建的对象将会是“局部单例”，它的生命周期跟<code>UserComponent</code>实例是一样的。</p>
<p>所以，每次一创建另一个<code>UserComponent</code>实例将会调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UserComponent appComponent = appComponent.plus(<span class="keyword">new</span> UserModule(user))</span><br></pre></td></tr></table></figure>
<p>从<code>UserModule</code>中获取的对象将是不同的实例。</p>
<p>但是这里很重要的一点是 - 我们要负责<code>UserComponent</code>的生命周期。所以我们应该关心它的初始化和释放。在我们的例子中，我为它增加了两个额外的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GithubClientApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AppComponent appComponent;</span><br><span class="line">    <span class="keyword">private</span> UserComponent userComponent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserComponent <span class="title">createUserComponent</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userComponent = appComponent.plus(<span class="keyword">new</span> UserModule(user));</span><br><span class="line">        <span class="keyword">return</span> userComponent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">releaseUserComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        userComponent = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>createUserComponent()</code>方法会在我们从Github API（在<code>SplashActivity</code>中）获取到<code>User</code>对象时调用。<code>releaseUserComponent()</code>方法会在我们从<code>RepositoriesListActivity</code>（这个时候我们不再需要user scope了）中返回时调用。</p>
<h2 id="Dagger-2中的Scope-内部实现"><a href="#Dagger-2中的Scope-内部实现" class="headerlink" title="Dagger 2中的Scope - 内部实现"></a>Dagger 2中的Scope - 内部实现</h2><p>查看它的内部的工作原理是很不错的。通常在这种情况下可以确定，在Dagger 2的scope机制下并不存在什么魔法。</p>
<p>我们从<code>UserModule.provideRepositoriesManager()</code>方法开始研究。它提供了<code>RepositoriesManager</code>实例，它应该使用<code>@UserScope</code>Scope。我们来检验这个方法哪里被调用（第8行）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Generated</span>(<span class="string">"dagger.internal.codegen.ComponentProcessor"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule_ProvideRepositoriesManagerFactory</span> <span class="keyword">implements</span> <span class="title">Factory</span>&lt;<span class="title">RepositoriesManager</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RepositoriesManager <span class="title">get</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    RepositoriesManager provided = <span class="keyword">module</span>.provideRepositoriesManager(userProvider.get(), githubApiServiceProvider.get());</span><br><span class="line">    <span class="keyword">if</span> (provided == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Cannot return null from a non-@Nullable @Provides method"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> provided;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Factory&lt;RepositoriesManager&gt; <span class="title">create</span><span class="params">(UserModule <span class="keyword">module</span>, Provider&lt;User&gt; userProvider, Provider&lt;GithubApiService&gt; githubApiServiceProvider)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UserModule_ProvideRepositoriesManagerFactory(<span class="keyword">module</span>, userProvider, githubApiServiceProvider);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>UserModule_ProvideRepositoriesManagerFactory</code>仅仅是一个工厂模式的现实，它从<code>UserModule</code>中获取到<code>RepositoriesManager</code>实例。我们应该往更深层次挖掘。</p>
<p><code>UserModule_ProvideRepositoriesManagerFactory</code>在<code>UserComponentImpl</code>中被使用 - 我们component的实现（line 15）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UserComponentImpl</span> <span class="keyword">implements</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">UserComponentImpl</span><span class="params">(UserModule userModule)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (userModule == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.userModule = userModule;</span><br><span class="line">      initialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.provideUserProvider = ScopedProvider.create(UserModule_ProvideUserFactory.create(userModule));</span><br><span class="line">      <span class="keyword">this</span>.provideRepositoriesManagerProvider = ScopedProvider.create(UserModule_ProvideRepositoriesManagerFactory.create(userModule, provideUserProvider, DaggerAppComponent.<span class="keyword">this</span>.provideGithubApiServiceProvider));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>provideRepositoriesManagerProvider</code>对象在我们每次请求它时负责提供<code>RepositoriesManager</code>实例。如我们所见，provider是通过<code>ScopedProvider</code>实现的。来看下它的部分代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ScopedProvider</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Provider</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">ScopedProvider</span><span class="params">(Factory&lt;T&gt; factory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> factory != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.factory = factory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) <span class="comment">// cast only happens when result comes from the factory</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// double-check idiom from EJ2: Item 71</span></span><br><span class="line">    Object result = instance;</span><br><span class="line">    <span class="keyword">if</span> (result == UNINITIALIZED) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        result = instance;</span><br><span class="line">        <span class="keyword">if</span> (result == UNINITIALIZED) &#123;</span><br><span class="line">          instance = result = factory.get();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (T) result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再简单不过了吧？第一次调用<code>ScopedProvider</code>从factory（我们的例子中是<code>UserModule_ProvideRepositoriesManagerFactory</code>）中获取实例并像单例模式一样存储起来。我们的scoped provider只是<code>UserComponentImpl</code>中的一个属性，所以简单说就是<code>ScopedProvider</code>返回一个与依赖于Component的单例。</p>
<p>在这里你可以查看 <a href="https://github.com/google/dagger/blob/master/core/src/main/java/dagger/internal/ScopedProvider.java" target="_blank" rel="noopener">ScopedProvider</a> 的所有的实现。</p>
<p>就是这样。我们弄清楚了Dagger 2中Scope底层是怎么工作的。现在我们知道，它们没有以任何方式于Scope注解连接。自定义注解只是给了我们一个简单的方式来进行编译时代码校验和标记一个类是单例/非单例。所有的scope相关东西都是与Component的生命周期相关联。</p>
<p>以上就是今天的全部内容。我希望从现在开始scopes会变得更加容易使用。感谢阅读！</p>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3><p>以上描述的完整代码可见Github <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">repository</a>。</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> dependency injection </tag>
            
            <tag> dagger2 </tag>
            
            <tag> DI </tag>
            
            <tag> google </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[使用Dagger 2依赖注入 - API（翻译）]]></title>
      <url>/2015/12/31/Android-%E4%BD%BF%E7%94%A8Dagger-2%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5-API%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h1 id="使用Dagger-2依赖注入-API"><a href="#使用Dagger-2依赖注入-API" class="headerlink" title="使用Dagger 2依赖注入 - API"></a>使用Dagger 2依赖注入 - API</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-the-api/" target="_blank" rel="noopener">http://frogermcs.github.io/dependency-injection-with-dagger-2-the-api/</a></p>
</blockquote>
<p>这章是展示使用Dagger 2在Android端实现依赖注入的系列中的一部分。今天我会探索Dagger 2的基础并且学习这个依赖注入框架的所有的API。</p>
<h2 id="Dagger-2"><a href="#Dagger-2" class="headerlink" title="Dagger 2"></a>Dagger 2</h2><p>在我上一章中我提到了DI框架给我们带来了什么 - 它让只写一小部分代码就可以使一切联系在一起成为可能。Dagger 2就是DI框架的一个例子，它可以为我们生成很多模版代码。但是为什么它比其它的要更好呢？目前为止它是唯一一个可以生成完整模仿用户手写的可追踪的代码的DI框架。这意味着让依赖图表构建过程不再充满魔幻。Dagger 2相比其它是不具有动态性的（使用时完全不使用反射）但是生成的代码的简洁性和性能都是与手写的代码同水准的。</p>
<h3 id="Dagger-2-基础"><a href="#Dagger-2-基础" class="headerlink" title="Dagger 2 基础"></a>Dagger 2 基础</h3><p>下面是Dagger 2的API：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Component &#123;</span><br><span class="line">    Class&lt;?&gt;[] modules() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;?&gt;[] dependencies() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Subcomponent &#123;</span><br><span class="line">    Class&lt;?&gt;[] modules() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Module &#123;</span><br><span class="line">    Class&lt;?&gt;[] includes() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Provides &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MapKey &#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">unwrapValue</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Lazy</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还有在Dagger 2中用到的定义在 <a href="https://jcp.org/en/jsr/detail?id=330" target="_blank" rel="noopener">JSR-330</a> （Java中依赖注入的标准）中的其它元素：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Inject &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Scope &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Qualifier &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让我们来学习它们。</p>
<h4 id="Inject-注解"><a href="#Inject-注解" class="headerlink" title="@Inject 注解"></a>@Inject 注解</h4><p>DI中第一个并且是最重要的就是<code>@Inject</code>注解。JSR-330标准中的一部分，标记那些应该被依赖注入框架提供的依赖。在Dagger 2中有3种不同的方式来提供依赖：</p>
<h5 id="构造器注入："><a href="#构造器注入：" class="headerlink" title="构造器注入："></a>构造器注入：</h5><p><code>@Inject</code>使用在类的构造器上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivityPresenter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoginActivity loginActivity;</span><br><span class="line">    <span class="keyword">private</span> UserDataStore userDataStore;</span><br><span class="line">    <span class="keyword">private</span> UserManager userManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginActivityPresenter</span><span class="params">(LoginActivity loginActivity,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  UserDataStore userDataStore,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  UserManager userManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loginActivity = loginActivity;</span><br><span class="line">        <span class="keyword">this</span>.userDataStore = userDataStore;</span><br><span class="line">        <span class="keyword">this</span>.userManager = userManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有的参数都是通过依赖图表中获取。<code>@Inject</code>注解被使用在构造器中也会标记这个类为依赖图表的一部分。这意味着它也可以在我们需要的时候被注入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    LoginActivityPresenter presenter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个例子中的局限性是我们不能给这个类中的多个构造器作<code>@Inject</code>注解。</p>
<h5 id="属性注入"><a href="#属性注入" class="headerlink" title="属性注入"></a>属性注入</h5><p>另一种选择是给指定的属性作<code>@Inject</code>注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplashActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    LoginActivityPresenter presenter;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    AnalyticsManager analyticsManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(bundle);</span><br><span class="line">        getAppComponent().inject(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是在这个例子中，注入过程必须要在我们类的某处“手动”调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplashActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(bundle);</span><br><span class="line">        getAppComponent().inject(<span class="keyword">this</span>);    <span class="comment">//Requested depenencies are injected in this moment</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个调用之前，我们的依赖是null值。</p>
<p>属性注入的局限性是我们不能使用<code>private</code>。为什么？简单说，生成的代码会直接地调用它们来设置属性，就像这里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//This class is generated automatically by Dagger 2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SplashActivity_MembersInjector</span> <span class="keyword">implements</span> <span class="title">MembersInjector</span>&lt;<span class="title">SplashActivity</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">injectMembers</span><span class="params">(SplashActivity splashActivity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (splashActivity == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Cannot inject members into a null reference"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        supertypeInjector.injectMembers(splashActivity);</span><br><span class="line">        splashActivity.presenter = presenterProvider.get();</span><br><span class="line">        splashActivity.analyticsManager = analyticsManagerProvider.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="方法注入"><a href="#方法注入" class="headerlink" title="方法注入"></a>方法注入</h5><p>最后一种方法使用<code>@Inject</code>注解提供依赖的方式是在这个类的<code>public</code>方法中作注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivityPresenter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoginActivity loginActivity;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginActivityPresenter</span><span class="params">(LoginActivity loginActivity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loginActivity = loginActivity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enableWatches</span><span class="params">(Watches watches)</span> </span>&#123;</span><br><span class="line">        watches.register(<span class="keyword">this</span>);    <span class="comment">//Watches instance required fully constructed LoginActivityPresenter</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法的所有参数都是通过依赖图表提供的。但是为什么我们需要方法注入呢？在某些情况下会用到，如当我们希望传入类的当前实例（<code>this</code>引用）到被注入的依赖中。方法注入会在构造器调用后马上被调用，所以这表示我们可以传入完全被构造的<code>this</code>。</p>
<h4 id="Module-注解"><a href="#Module-注解" class="headerlink" title="@Module 注解"></a>@Module 注解</h4><p><code>@Module</code>是Dagger 2 API的一部分。这个注解用于标记提供依赖的类 - 多亏它Dagger才会知道某些地方需要的对象被构建。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GithubApiModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="function">OkHttpClient <span class="title">provideOkHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OkHttpClient okHttpClient = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">        okHttpClient.setConnectTimeout(<span class="number">60</span> * <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        okHttpClient.setReadTimeout(<span class="number">60</span> * <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">return</span> okHttpClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="function">RestAdapter <span class="title">provideRestAdapter</span><span class="params">(Application application, OkHttpClient okHttpClient)</span> </span>&#123;</span><br><span class="line">        RestAdapter.Builder builder = <span class="keyword">new</span> RestAdapter.Builder();</span><br><span class="line">        builder.setClient(<span class="keyword">new</span> OkClient(okHttpClient))</span><br><span class="line">               .setEndpoint(application.getString(R.string.endpoint));</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">view rawGithubApiModule.java hosted with ❤ by GitHub</span><br></pre></td></tr></table></figure>
<h4 id="Provides-注解"><a href="#Provides-注解" class="headerlink" title="@Provides 注解"></a>@Provides 注解</h4><p>这个注解用在<code>@Module</code>类中。<code>@Provides</code>会标记Module中那些返回依赖的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GithubApiModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span>   <span class="comment">//This annotation means that method below provides dependency</span></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="function">RestAdapter <span class="title">provideRestAdapter</span><span class="params">(Application application, OkHttpClient okHttpClient)</span> </span>&#123;</span><br><span class="line">        RestAdapter.Builder builder = <span class="keyword">new</span> RestAdapter.Builder();</span><br><span class="line">        builder.setClient(<span class="keyword">new</span> OkClient(okHttpClient))</span><br><span class="line">               .setEndpoint(application.getString(R.string.endpoint));</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Component-注解"><a href="#Component-注解" class="headerlink" title="@Component 注解"></a>@Component 注解</h4><p>这个注解用在把一切联系在一起的接口上面。在这里我们可以定义从哪些module（或者哪些Components）中获取依赖。这里也可以用来定义哪些图表依赖应该公开可见（可以被注入）和哪里我们的component可以注入对象。<code>@Component</code>通常是<code>@Module</code>和<code>@Inject</code>之间的桥梁。</p>
<p>这里有个使用了两个module的<code>@Component</code>例子代码，可以注入依赖到<code>GithubClientApplication</code>，并且标记了三个依赖公开可见：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component</span>(</span><br><span class="line">    modules = &#123;</span><br><span class="line">        AppModule.class,</span><br><span class="line">        GithubApiModule.class</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(GithubClientApplication githubClientApplication)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Application <span class="title">getApplication</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">AnalyticsManager <span class="title">getAnalyticsManager</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">UserManager <span class="title">getUserManager</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@Component</code>也可以依赖其它的component，并且定义了生命周期（我会在以后的文章中讲解Scope）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ActivityScope</span></span><br><span class="line"><span class="meta">@Component</span>(      </span><br><span class="line">    modules = SplashActivityModule.class,</span><br><span class="line">    dependencies = AppComponent.class</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SplashActivityComponent</span> </span>&#123;</span><br><span class="line">    <span class="function">SplashActivity <span class="title">inject</span><span class="params">(SplashActivity splashActivity)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">SplashActivityPresenter <span class="title">presenter</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Scope-注解"><a href="#Scope-注解" class="headerlink" title="@Scope 注解"></a>@Scope 注解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scope</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ActivityScope &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JSR-330标准的又一部分。在Dagger 2中，<code>@Scope</code>被用于标记自定义的scope注解。简单说它们可以类似单例地标记依赖。被作注解的依赖会变成单例，但是这会与component的生命周期（不是整个应用）关联。但是正如我刚才所说 - 我会在下一篇文章中深入scope。现在值得一提的是所有自定义scope做的是同样的事情（从代码角度）- 它们为对象保持单例。但是他们也会被在图表认证处理中使用，这对尽可能地捕捉图表结构问题是有帮助的。</p>
<hr>
<p>接下来是一些不太重要，不会经常用到的东西：</p>
<h4 id="MapKey"><a href="#MapKey" class="headerlink" title="MapKey"></a>MapKey</h4><p>这个注解用在定义一些依赖集合（目前为止，Maps和Sets）。让例子代码自己来解释吧：</p>
<p>定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapKey</span>(unwrapValue = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@interface</span> TestKey &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>提供依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span>(type = Type.MAP)</span><br><span class="line"><span class="meta">@TestKey</span>(<span class="string">"foo"</span>)</span><br><span class="line"><span class="function">String <span class="title">provideFooKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"foo value"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Provides</span>(type = Type.MAP)</span><br><span class="line"><span class="meta">@TestKey</span>(<span class="string">"bar"</span>)</span><br><span class="line"><span class="function">String <span class="title">provideBarKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bar value"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Inject</span></span><br><span class="line">Map&lt;String, String&gt; map;</span><br><span class="line"></span><br><span class="line">map.toString() <span class="comment">// =&gt; „&#123;foo=foo value, bar=bar value&#125;”</span></span><br></pre></td></tr></table></figure>
<p><code>@MapKey</code>注解目前只提供两种类型 - String和Enum。</p>
<h4 id="Qualifier"><a href="#Qualifier" class="headerlink" title="@Qualifier"></a>@Qualifier</h4><p><code>@Qualifier</code>注解帮助我们去为相同接口的依赖创建“tags”。想象下你需要提供两个<code>RestAdapter</code>对象 - 一个用于Github API，另一个用于Fackbook API。<code>Qualifier</code>会帮助你区分对应的一个：</p>
<p>命名依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@GithubRestAdapter</span>  <span class="comment">//Qualifier</span></span><br><span class="line"><span class="function">RestAdapter <span class="title">provideRestAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestAdapter.Builder()</span><br><span class="line">        .setEndpoint(<span class="string">"https://api.github.com"</span>)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@FacebookRestAdapter</span>  <span class="comment">//Qualifier</span></span><br><span class="line"><span class="function">RestAdapter <span class="title">provideRestAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestAdapter.Builder()</span><br><span class="line">        .setEndpoint(<span class="string">"https://api.facebook.com"</span>)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注入依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Inject</span></span><br><span class="line"><span class="meta">@GithubRestAdapter</span></span><br><span class="line">RestAdapter githubRestAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Inject</span></span><br><span class="line"><span class="meta">@FacebookRestAdapter</span></span><br><span class="line">RestAdapter facebookRestAdapter;</span><br></pre></td></tr></table></figure>
<p>以上就是全部了。我们刚刚已经了解了所有Dagger 2 API中重要的元素了。</p>
<h3 id="App-example"><a href="#App-example" class="headerlink" title="App example"></a>App example</h3><p>现在是时候让我们在实践中检验我们的知识了。我们会基于Dagger 2来实现一个简单的Github客户端app。</p>
<h4 id="想法"><a href="#想法" class="headerlink" title="想法"></a>想法</h4><p>我们的Github客户端有三个Activity和非常简单的使用case。它的全部流程：</p>
<p>1. 输入Github用户名<br>2. 如果用户存在则显示它所有公开的库。<br>3. 当用户按下list的item后显示库的详情。</p>
<p>这里就是我们的app看起来的样子：</p>
<p><img src="http://frogermcs.github.io/images/14/app_flow.png" alt=""></p>
<p>在内部，从DI角度我们的app结构看起来如下：</p>
<p><img src="http://frogermcs.github.io/images/14/local_components.png" alt=""></p>
<p>简单说 - 每一个Activity都有它自己的依赖图表。每个图表（_Component类）有两个对象 - <code>_Prresenter</code>和<code>_Activity</code>。每个component也会从全局的component（<code>AppComponent</code>，包含了<code>Application</code>, <code>UserManager</code>, <code>RepositoriesManager</code>等）中获取依赖。</p>
<p><img src="http://frogermcs.github.io/images/14/app_component.png" alt=""></p>
<p>讲讲<code>AppComponent</code> - 看上面最近的图表。它包含了两个modules：<code>AppModule</code>和<code>GithubApiModule</code>。</p>
<p><code>GithubApiModule</code>提供了一些依赖，比如<code>OkHttpClient</code>或<code>RestAdapter</code>，他们只会在这个module的其它依赖使用。在Dagger 2中我们可以控制哪些对象对外部的component可见。在我们例子中我们不希望暴露这些被使用了的对象。所以我们只是暴露了<code>UserManager</code>和<code>RepositoriesManager</code>，因为这有这些对象才会被我们的Activity用到。所有都通过public、返回非void类型并无参数的方法被定义。</p>
<p>文档中的例子：</p>
<p><strong>提供依赖的方法</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SomeType <span class="title">getSomeType</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">Set&lt;SomeType&gt; <span class="title">getSomeTypes</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">@PortNumber</span> <span class="function"><span class="keyword">int</span> <span class="title">getPortNumber</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>此外，我们必须要定义哪里我们希望要去注入依赖（通过成员注入）。在我们例子中<code>AppComponent</code>没有任何地方可以去注入，因为它只是作为我们Components的依赖。所以它们每一个都被定义了 一个<code>inject(_Activity activity)</code>方法。这里我们也有一些简单的规则 - 注入通过一个单个参数的方法被定义（定义一个实例，它代表我们需要往这个实例中注入依赖），它可以有任意的名字，但是必须要返回类型是void或者返回被传入的参数类型。</p>
<p>文档中的例子：</p>
<p><strong>成员注入的方法</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SomeType <span class="title">getSomeType</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">Provider&lt;SomeType&gt; <span class="title">getSomeTypeProvider</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">Lazy&lt;SomeType&gt; <span class="title">getLazySomeType</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>我不想深入太多的代码。clone <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">GithubClient</a> 代码并导入到最新的Android Studio。这里给出一些开始的提示：</p>
<h4 id="Dagger-2-安装"><a href="#Dagger-2-安装" class="headerlink" title="Dagger 2 安装"></a>Dagger 2 安装</h4><p>只需要获得<code>/app/build.gradle</code>文件。我们需要增加Dagger 2依赖和使用 <a href="https://bitbucket.org/hvisser/android-apt" target="_blank" rel="noopener">android-apt</a> 插件来对生成的代码和Android Studio IDE之间进行绑定。</p>
<h5 id="AppComponent"><a href="#AppComponent" class="headerlink" title="AppComponent"></a>AppComponent</h5><p>从<code>GithubClientApplication</code>类开始探索。在这里<code>AppComponent</code>会被创建和存储。这意味着所有单例的对象的生命周期都会与Applicaiton一致（所以每时每刻都是如此）。</p>
<p><code>AppComponent</code>的实现由Dagger 2（对象可以通过builder模式被创建）生成的代码提供。在这里我们也可以放入所有的Component的依赖（module和其他components）。</p>
<h5 id="限定的component"><a href="#限定的component" class="headerlink" title="限定的component"></a>限定的component</h5><p>可以通过<code>SplashActivity</code>来探索Activities Components是怎么创建的。它重写了<code>setupActivityComponent(AppComponent)</code>，在这里它创建它自己的Component（<code>SplashActivityComponent</code>），然后注入所有被做<code>@Inject</code>注解的依赖（这个例子中的<code>SplashActivityPresenter</code>和<code>AnalyticsManager</code>）。</p>
<p>在这里我们也会提供AppComponent实例（因为<code>SplashActivityComponent</code>是依赖它的）以及<code>SplashActivityModule</code>（它提供了Presenter和Activity实例）。</p>
<p>剩下的就靠你自己了。认真的说 - 尝试弄清楚一切是怎么合适地联系在一起的。下一章节我们尝试深入Dagger 2的那些紧密的元素（在底层它们是怎么工作的）。</p>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3><p>以上描述的完整代码可见Github <a href="https://github.com/frogermcs/GithubClient/tree/1bf53a2a36c8a85435e877847b987395e482ab4a" target="_blank" rel="noopener">repository</a>。</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> dependency injection </tag>
            
            <tag> dagger2 </tag>
            
            <tag> DI </tag>
            
            <tag> google </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[使用Dagger 2依赖注入 - DI介绍（翻译）]]></title>
      <url>/2015/12/31/Android-%E4%BD%BF%E7%94%A8Dagger-2%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5-DI%E4%BB%8B%E7%BB%8D%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h2 id="使用Dagger-2依赖注入-DI介绍"><a href="#使用Dagger-2依赖注入-DI介绍" class="headerlink" title="使用Dagger 2依赖注入 - DI介绍"></a>使用Dagger 2依赖注入 - DI介绍</h2><blockquote>
<p>原文：<a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-introdution-to-di/" target="_blank" rel="noopener">http://frogermcs.github.io/dependency-injection-with-dagger-2-introdution-to-di/</a></p>
</blockquote>
<p>不久之前，在克拉科夫的 <a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-introdution-to-di/" target="_blank" rel="noopener">Tech Space</a> 的 Google I/O 扩展中，我 <a href="https://speakerdeck.com/frogermcs/dependency-injection-with-dagger-2" target="_blank" rel="noopener">展示</a> 了一些关于使用Dagger 2来进行依赖注入。在准备期间我认识到有太多相关的东西需要去讲，无法用一打幻灯片就能覆盖到全部。但是它可以作为一个很好的进入点来开展更多这一系列主题－Android端的依赖注入。</p>
<p>在这一章中我会去通过之前所展示的来进行一个总结。可能并不是按部就班的 - 我认为现在是时候打破过去，使用一些原本我们不会使用或者不应该使用的方法来解决问题了。<strong>Jake Wharton</strong> <a href="https://www.parleys.com/tutorial/5471cdd1e4b065ebcfa1d557/" target="_blank" rel="noopener">讲述</a> 了相关历史（Guice, Dagger 1），<strong>Gregory Kick</strong> <a href="https://www.youtube.com/watch?v=oK_XtfXPkqw" target="_blank" rel="noopener">也是</a>（几乎有一半是关于Spring, Guice, Dagger 1）。我也会花几分钟的时间讲述以前的解决方式。但是此刻是时候开始了。</p>
<h3 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h3><p>依赖注入的全部就是构建对象并在我们需要时把它们传入。我不会深入到它的学说（查看维基百科对<a href="http://en.wikipedia.org/wiki/Dependency_injection" target="_blank" rel="noopener">DI的定义</a>）。想象一个简单的类：<code>UserManager</code>，它依赖<code>UserStore</code>和<code>ApiService</code>。如果没有使用依赖注入，这个类会看起来像这样：</p>
<p><img src="http://frogermcs.github.io/images/13/user_manager_no_di.png" alt=""></p>
<p><code>UserStore</code> 和 <code>ApiService</code> 两者都是在<code>UserManager</code>类中构造和提供的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApiService apiService;</span><br><span class="line">    <span class="keyword">private</span> UserStore userStore;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//No-args constructor. Dependencies are created inside.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.apiService = <span class="keyword">new</span> ApiSerivce();</span><br><span class="line">        <span class="keyword">this</span>.userStore = <span class="keyword">new</span> UserStore();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerUser</span><span class="params">()</span> </span>&#123;<span class="comment">/*  */</span>&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserManager userManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(b);</span><br><span class="line">        <span class="keyword">this</span>.userManager = <span class="keyword">new</span> UserManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRegisterClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        userManager.registerUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么这些代码会给我们制造一些问题呢？让我们想象一下，你希望去改变<code>UserStore</code>的实现，用<code>SharedPreferences</code>来作为它的存储机制。它需要至少一个<code>Context</code>对象来创建一个实例，所以我们需要把它通过构造器传入到<code>UserStore</code>。它意味着<code>UserManager</code>类中也需要被修改来使用新的<code>UserStore</code>构造器。现在想象下有很多类使用了<code>UserStore</code> - 它们全部都需要被修改。</p>
<p>现在再来看下我们使用了依赖注入的<code>UserManager</code>类：</p>
<p><img src="http://frogermcs.github.io/images/13/user_manager_di.png" alt=""></p>
<p>它的依赖是在类的外面创建和提供的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApiService apiService;</span><br><span class="line">    <span class="keyword">private</span> UserStore userStore;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Dependencies are passed as arguments</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserManager</span><span class="params">(ApiService apiService, UserStore userStore)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.apiService = apiService;</span><br><span class="line">        <span class="keyword">this</span>.userStore = userStore;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerUser</span><span class="params">()</span> </span>&#123;<span class="comment">/*  */</span>&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserManager userManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(b);</span><br><span class="line">        ApiService api = ApiService.getInstance();</span><br><span class="line">        UserStore store = UserStore.getInstance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.userManager = <span class="keyword">new</span> UserManager(api, store);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRegisterClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        userManager.registerUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在在相似的情况下 - 我们改变它其中一个依赖的实现方式 - 我们不需要修改<code>UserManager</code>源代码。所有它的依赖都是从外面提供的，所以我们唯一一个需要修改的地方就是我们构造的<code>UserStore</code>对象。</p>
<p>所以使用依赖注入的优势是什么呢？</p>
<h4 id="构造-使用-的分离"><a href="#构造-使用-的分离" class="headerlink" title="构造/使用 的分离"></a>构造/使用 的分离</h4><p>当我们构造类的实例 - 通常这些对象会在其它的地方被使用到，多亏这个方法让我们的代码更加模块化 - 所有的依赖都可以被很简单地替换掉（只要他们实现了相同的接口），并且不会与我们应用的逻辑产生冲突。想要改变<code>DatabaseUserStore</code>为<code>SharedPrefsUserStore</code> ？好的，只需要关心公开的API（与<code>DatabaseUserStore</code>相同的）或者实现相同的接口。</p>
<h4 id="单元测试（Unit-testing）"><a href="#单元测试（Unit-testing）" class="headerlink" title="单元测试（Unit testing）"></a>单元测试（Unit testing）</h4><p>真正的单元测试假设一个类是可以完全被隔离进行测试的 - 不需要了解它的相关依赖。在实践中，基于我们的<code>UserManager</code>类，这里有一个我们应该编写的单元测试的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserManagerTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    UserManager userManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    ApiService apiServiceMock;</span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    UserStore userStoreMock;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>);</span><br><span class="line">        userManager = <span class="keyword">new</span> UserManager(apiServiceMock, userStoreMock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Test our userManager here - all its dependencies are satisfied</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它可能只能使用DI - 多亏<code>UserManager</code>是完全独立于<code>UserStore</code>和<code>ApiService</code>实现的。我们可以提供这些类的mock（简单地说 - mocks是一些拥有相同公开API的类，它在方法中不做任何事情并且/或者返回我们期望的值），然后在一个与所依赖的真实实现分离出来的环境下进行对<code>UserManager</code>的测试。</p>
<h4 id="独立-并行开发"><a href="#独立-并行开发" class="headerlink" title="独立/并行开发"></a>独立/并行开发</h4><p>多亏模块化的代码（<code>UserStore</code>可以从<code>UserManager</code>中独立出来进行实现），它也可以非常方便在程序员间进行代码的分离。只需要<code>UserStore</code>相关的接口被每个人知道（尤其是在<code>UserManager</code>中使用到的<code>UserStore</code>中的公开方法）即可。剩下的（实现，逻辑）可以通过单元测试来测试。</p>
<h3 id="依赖注入框架"><a href="#依赖注入框架" class="headerlink" title="依赖注入框架"></a>依赖注入框架</h3><p>依赖注入除了这些优点之外还有一些缺点。其中一个缺点是会产生很大的模版代码。想象一个简单的<code>LoginActivity</code>类，它在MVP（model-view-presenter）模式中被实现。这个类看起来就像这样：</p>
<p><img src="http://frogermcs.github.io/images/13/login_activity_diagram.png" alt=""></p>
<p>唯一有问题的部分代码就是<code>LoginActivityPresenter</code>的初始化，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    LoginActivityPresenter presenter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        OkHttpClient okHttpClient = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">        RestAdapter.Builder builder = <span class="keyword">new</span> RestAdapter.Builder();</span><br><span class="line">        builder.setClient(<span class="keyword">new</span> OkClient(okHttpClient));</span><br><span class="line">        RestAdapter restAdapter = builder.build();</span><br><span class="line">        ApiService apiService = restAdapter.create(ApiService.class);</span><br><span class="line">        UserManager userManager = UserManager.getInstance(apiService);</span><br><span class="line"></span><br><span class="line">        UserDataStore userDataStore = UserDataStore.getInstance(</span><br><span class="line">                getSharedPreferences(<span class="string">"prefs"</span>, MODE_PRIVATE)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Presenter is initialized here</span></span><br><span class="line">        presenter = <span class="keyword">new</span> LoginActivityPresenter(<span class="keyword">this</span>, userManager, userDataStore);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它看起来不太友好，不是吗？</p>
<p>这就是DI框架需要解决的问题。相同功能的代码看起来就像这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    LoginActivityPresenter presenter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Satisfy all dependencies requested by @Inject annotation</span></span><br><span class="line">        getDependenciesGraph().inject(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单多了，对吧？当然DI框架没有地方可以获取到对象 - 他们仍然需要在我们代码的某个地方进行初始化和配置。但是对象构建从使用中分离出来了（实质上这是DI模式的准则）。DI框架关心怎么样去把它们联系在一起（怎么在对象被需要时分配给它们）。</p>
<h3 id="未完待续"><a href="#未完待续" class="headerlink" title="未完待续"></a>未完待续</h3><p>我上面所有描述的东西都是使用Dagger 2的简单的背景 - 用于Android和Java开发的依赖注入框架。在下一章我将尝试讲解所有Dagger 2的API。如果你等不急可以尝试我的<a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">Github client example</a>，它建立在Dagger 2之上并且会用在我的展示中。一个小提示 - <code>@Module</code>和<code>@Component</code>就是构建/提供对象的地方。<code>@Inject</code>是我们对象使用到的地方。</p>
<p>More detailed description - soon.</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.youtube.com/watch?v=oK_XtfXPkqw" target="_blank" rel="noopener">DAGGER 2 - A New Type of dependency injection</a> by Gregory Kick</li>
<li><a href="https://www.parleys.com/tutorial/the-future-dependency-injection-dagger-2" target="_blank" rel="noopener">The Future of Dependency Injection with Dagger 2</a> by Jake Wharton</li>
<li><a href="http://frogermcs.github.io/dagger-1-to-2-migration/" target="_blank" rel="noopener">Dagger 1 to 2 migration process</a></li>
</ul>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> dependency injection </tag>
            
            <tag> dagger2 </tag>
            
            <tag> DI </tag>
            
            <tag> google </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]官网《monkeyrunner》中文翻译]]></title>
      <url>/2015/12/16/Android-%E5%AE%98%E7%BD%91%E3%80%8Amonkeyrunner%E3%80%8B%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91/</url>
      <content type="html"><![CDATA[<p>翻译自 Android Developer 官网：<a href="http://developer.android.com/tools/help/monkeyrunner_concepts.html" target="_blank" rel="noopener">http://developer.android.com/tools/help/monkeyrunner_concepts.html</a></p>
<h1 id="monkeyrunner"><a href="#monkeyrunner" class="headerlink" title="monkeyrunner"></a>monkeyrunner</h1><p>monkeyrunner工具提供了一套API，在不通过Android代码的情况下编写程序来控制一个Android设备或者模拟器。使用monkeyrunner，你可以编写一个<code>Python</code>程序来安装一个Android应用程序或者测试包，运行它，给它发送按键，使用它的interface来创建一个截图，并保存在工作站上。monkeytunner工具主要是被设计用来在功能/框架级别测试应用程序和设备，并运行单元测试套件，但是你也可以使用它来达到其它的目的。</p>
<p>Monkeyrunner工具与也被称为<code>monkey</code>的<a href="http://developer.android.com/tools/help/monkey.html" target="_blank" rel="noopener">UI/Application Exerciser Monkey</a>没有任何关系。<code>Monkey</code>工具是直接在<code>adb</code> shell中运行，通过在设备或者模拟器中产生伪随机流的用户和系统事件的方式。比较之下，monkeyrunner工具在一个工作站中通过API发送指定的命令和事件来控制设备和模拟器。</p>
<p>monkeyrunner工具提供了以下这些在Android测试中独一无二的特性：</p>
<ul>
<li><p>多设备控制：monkeyrunner可以应用在一个或者多个测试套件跨越多个设备和模拟器。你可以在物理层面上一次性attach所有的设备或者启动所有的模拟器（或者两者都有），按照程序依次连接上每一个，然后运行一个或者多个测试。</p>
</li>
<li><p>功能性测试：monkeyrunner可以运行从头至尾全自动化地测试Android应用程序。由你提供输入的按键或者触摸事件，并且查看结果截图。</p>
</li>
<li><p>回归测试：monkeyrunner可以通过运行一个应用程序并且把它输出的结果截图与已知正确的截图比较的方式测试应用程序的稳定性。</p>
</li>
<li><p>可扩展的自动化：因为monkeyrunner是一套API工具包，你可以基于<code>Python</code>模块和程序的开发一个完整的系统来控制Android设备。除了使用monkeyrunner自己的API，你可以使用标准的Python <code>os</code>和<code>subprocess</code>模块来调用 <a href="http://developer.android.com/tools/help/adb.html" target="_blank" rel="noopener">Android Debug Bridge</a> 等Android工具。你也可以为monkeyrunner API增加自己的类。这个我们会在 <a href="http://developer.android.com/tools/help/monkeyrunner_concepts.html#Plugins" target="_blank" rel="noopener">Extending monkeyrunner with plugins</a> 栏中讨论到更多的细节。</p>
</li>
</ul>
<p>monkeyrunner工具使用了<a href="http://www.jython.org/" target="_blank" rel="noopener">Jython</a>，一个使用Java编程语言的Python实现。Jython允许monkeyrunner API很容易地与Android framework交互。使用Jython，你可以使用Python语法去访问API常量、类和方法。</p>
<h2 id="一个简单的monkeyrunner程序"><a href="#一个简单的monkeyrunner程序" class="headerlink" title="一个简单的monkeyrunner程序"></a>一个简单的monkeyrunner程序</h2><p>这里有一个简单的monkeyrunner程序，它可以连接到一个设备，创建一个 <a href="http://developer.android.com/tools/help/MonkeyDevice.html" target="_blank" rel="noopener"><code>MonkeyDevice</code></a> 对象。程序中使用 <code>MonkeyDevice</code> 对象安装一个Android应用程序，运行它其中的一个Activity，并且发送一个按键的事件给这个Activity。然后程序把结果截图，创建了一个 <a href="http://developer.android.com/tools/help/MonkeyImage.html" target="_blank" rel="noopener"><code>MonkeyImage</code></a> 对象。通过这个对象，程序把截图输出到一个<code>.png</code>文件中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Import 程序所有使用到的monkeyrunner模块</span></span><br><span class="line"><span class="keyword">from</span> com.android.monkeyrunner <span class="keyword">import</span> MonkeyRunner, MonkeyDevice</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接当前的设备，返回一个MonkeyDevice对象</span></span><br><span class="line">device = MonkeyRunner.waitForConnection()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Android应用。注意这个方法返回一个boolean，所以你需要检查是否安装成功</span></span><br><span class="line">device.installPackage(<span class="string">'myproject/bin/MyApplication.apk'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把安装文件的内部包名设置到一个变量中</span></span><br><span class="line">package = <span class="string">'com.example.android.myapplication'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把Activity的完整类名设置到一个变量中</span></span><br><span class="line">activity = <span class="string">'com.example.android.myapplication.MainActivity'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置要启动的component名字</span></span><br><span class="line">runComponent = package + <span class="string">'/'</span> + activity</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行该component</span></span><br><span class="line">device.startActivity(component=runComponent)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按下菜单按钮</span></span><br><span class="line">device.press(<span class="string">'KEYCODE_MENU'</span>, MonkeyDevice.DOWN_AND_UP)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 截图</span></span><br><span class="line">result = device.takeSnapshot()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把截图写入到一个文件中</span></span><br><span class="line">result.writeToFile(<span class="string">'myproject/shot1.png'</span>,<span class="string">'png'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="The-monkeyrunner-API"><a href="#The-monkeyrunner-API" class="headerlink" title="The monkeyrunner API"></a>The monkeyrunner API</h2><p>monkeyrunner的API处于<code>com.android.monkeyrunner</code>中，包括三个模块：</p>
<ul>
<li><p><a href="http://developer.android.com/tools/help/MonkeyRunner.html" target="_blank" rel="noopener"><code>MonkeyRunner</code></a>：一个包含monkeyrunner程序实用方法的类。这个类提供了一个方法用来把monkeyrunner连接到一个设备或者模拟器。它也提供了方法为monkeyrunner程序创建UI，还有显示内置的help界面。</p>
</li>
<li><p><a href="http://developer.android.com/tools/help/MonkeyDevice.html" target="_blank" rel="noopener"><code>MonkeyDevice</code></a>：代表一个设备或者模拟器。这个类提供了一些方法用于安装和卸载应用、启动一个Activity、发送键盘活着触摸事件到一个应用。你也可以使用这个类来运行一个测试应用。</p>
</li>
<li><p><a href="http://developer.android.com/tools/help/MonkeyImage.html" target="_blank" rel="noopener"><code>MonkeyImage</code></a>：代表一个屏幕截图图片。这个类提供了一些方法用于截图、把bitmap图片转换成各种格式，对比两个MonkeyImage对象、还有把图片写入到文件中。</p>
</li>
</ul>
<p>在一个Python程序中，你可以像一个Python模块一样访问每一个类。monkeyrunner工具不会自动帮你import这些模块。import模块的方式是使用Python的<code>from</code>语句：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> com.android.monkeyrunner <span class="keyword">import</span> &lt;module&gt;</span><br></pre></td></tr></table></figure>
<p><code>&lt;module&gt;</code>就是你希望import的类名。你可以使用同一个的<code>from</code>语句通过逗号分隔的方式import多个模块。</p>
<h2 id="运行monkeyrunner"><a href="#运行monkeyrunner" class="headerlink" title="运行monkeyrunner"></a>运行monkeyrunner</h2><p>你可以从一个文件中运行monkeyrunner程序，也可以在交互会话模式中输入monkeyrunner语句来运行。两者都需要通过调用<code>monkeyrunner</code>命令进行，你可以在SDK目录下的<code>tools/</code>子目录下可以找到这些命令。如果你提供了一个文件名作为草书，monkeyrunner命令会把这个文件中的内容作为Python程序来运行，否则，它就是以交互会话的方式运行。</p>
<p>monkeyrunner命令的语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">monkeyrunner -plugin &lt;plugin_jar&gt; &lt;program_filename&gt; &lt;program_options&gt;</span><br></pre></td></tr></table></figure>
<p>表1解释了flags和参数。</p>
<p><strong>Table 1</strong>. <code>monkeyrunner</code> flags和参数。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-plugin &lt;plugin_jar&gt;</code></td>
<td>（可选）指定一个<code>.jar</code>文件作为monkeyrunner的插件。更多monkeyrunner插件学习，见<a href="http://developer.android.com/tools/help/monkeyrunner_concepts.html#Plugins" target="_blank" rel="noopener">使用插件扩展monkeyrunner</a>。要指定多个文件，那就多次使用这个参数。</td>
</tr>
<tr>
<td><code>&lt;program_filename&gt;</code></td>
<td>如果你提供了这个参数，<code>monkeyrunner</code>命令就会把这个文件中的内容作为Python程序运行。如果该参数没有被提供，则它就是以交互会话的方式运行。</td>
</tr>
<tr>
<td><code>&lt;program_options&gt;</code></td>
<td>（可选）<program_file>中该程序的flags和参数。</program_file></td>
</tr>
</tbody>
</table>
<h2 id="monkeyrunner内置的Help"><a href="#monkeyrunner内置的Help" class="headerlink" title="monkeyrunner内置的Help"></a>monkeyrunner内置的Help</h2><p>你可以通过以下命令生成monkeyrunner的API reference：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">monkeyrunner help.py &lt;format&gt; &lt;outfile&gt;</span><br></pre></td></tr></table></figure>
<p>参数是：</p>
<ul>
<li><p><code>&lt;format&gt;</code>：<code>text</code>表示纯文本输出，或者<code>html</code>表示HTML输出。</p>
</li>
<li><p><code>&lt;outfile&gt;</code>：输出文件的路径。</p>
</li>
</ul>
<h2 id="使用插件扩展monkeyrunner"><a href="#使用插件扩展monkeyrunner" class="headerlink" title="使用插件扩展monkeyrunner"></a>使用插件扩展monkeyrunner</h2><p>你可以使用Java编程语言编写你的类并构建到一个或者多个<code>.jar</code>中来扩展monkeyrunner的API。你可以使用这个特性通过使用你自己的类或者继承已有的类来扩展monkeyrunner API。你也可以使用这个特性来初始化monkeyrunner环境。</p>
<p>要提供一个插件给monkeyrunner，就要调用在<code>monkeyrunner</code>命令的时候加上<a href="http://developer.android.com/tools/help/monkeyrunner_concepts.html#table1" target="_blank" rel="noopener">表1</a>中所描述的<code>-plugin &lt;plugin_jar&gt;</code>参数。</p>
<p>在你的插件代码中，你可以import和继承monkeyrunner在<code>com.android.monkeyrunner</code>中的主要类<code>MonkeyDevice</code>、<code>MonkeyImage</code>、和<code>MonkeyRunner</code>（见<a href="http://developer.android.com/tools/help/monkeyrunner_concepts.html#APIClasses" target="_blank" rel="noopener">The monkeyrunner API</a>）。</p>
<p>注意插件不能让你去访问Android SDK。你不能import像<code>com.android.app</code>类似的包。因为monkeyrunner是在framework APIs之外与设备或者模拟器交互的。</p>
<h3 id="插件启动类"><a href="#插件启动类" class="headerlink" title="插件启动类"></a>插件启动类</h3><p><code>.jar</code>插件文件可以指定一个类会在脚本运行之前被初始化。要指定这个类，就要在<code>.jar</code>文件的manifest中增加一个<code>MonkeyRunnerStartupRunner</code>属性。它的值应该就是启动时要运行的类的名字。这面这个片段展示了你怎么在<code>ant</code> build脚本中去设置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jar</span> <span class="attr">jarfile</span>=<span class="string">"myplugin"</span> <span class="attr">basedir</span>=<span class="string">"$&#123;build.dir&#125;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"MonkeyRunnerStartupRunner"</span> <span class="attr">value</span>=<span class="string">"com.myapp.myplugin"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jar</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>要去访问monkeyrunner的运行时环境，启动类可以实现<code>com.google.common.base.Predicate&lt;PythonInterpreter&gt;</code>接口。举个例子，这个类在默认的命名空间中设置了一些变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.android.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Predicate;</span><br><span class="line"><span class="keyword">import</span> org.python.util.PythonInterpreter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> <span class="keyword">implements</span> <span class="title">Predicate</span>&lt;<span class="title">PythonInterpreter</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(PythonInterpreter anInterpreter)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 一个例子使用来在monkeyrunner环境的命名空间中初始化一些变量。</span></span><br><span class="line"><span class="comment">        * 在执行期间，monkeyrunner程序可以使用“newtest”和“use_emulator”这些变量</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        anInterpreter.set(<span class="string">"newtest"</span>, <span class="string">"enabled"</span>);</span><br><span class="line">        anInterpreter.set(<span class="string">"use_emulator"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> testing </tag>
            
            <tag> monkey </tag>
            
            <tag> MonkeyRunner </tag>
            
            <tag> autemate </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]官网《UI/Application Exerciser Monkey》中文翻译]]></title>
      <url>/2015/12/15/Android-%E5%AE%98%E7%BD%91%E3%80%8AUI-Application-Exerciser-Monkey%E3%80%8B%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91/</url>
      <content type="html"><![CDATA[<p>翻译自 Android Developer 官网：<a href="http://developer.android.com/tools/help/monkey.html" target="_blank" rel="noopener">http://developer.android.com/tools/help/monkey.html</a></p>
<h1 id="UI-Application-Exerciser-Monkey"><a href="#UI-Application-Exerciser-Monkey" class="headerlink" title="UI/Application Exerciser Monkey"></a>UI/Application Exerciser Monkey</h1><p>Monkey是一个程序，它会运行在你的<a href="http://developer.android.com/tools/help/emulator.html" target="_blank" rel="noopener">模拟器</a>或者设备上并且会产生伪随机的用户事件流，比如点击、触摸或手势，以及大量的系统级的事件。你可以使用Monkey来对你开发的应用程序以随机和重复的方式来进行压力测试。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Monkey是一个命令行工具，你可以在模拟器或者设备上运行它。它发送伪随机的用户事件流到系统，它可以作为你开发的应用程序的压力测试。</p>
<p>Monkey包含很多的选项，但是总结成四种主要的种类：</p>
<ul>
<li><p>基础配置选项，比如设置试图尝试的事件数量。</p>
</li>
<li><p>操作限制，比如限制在单个包中测试。</p>
</li>
<li><p>事件类型和频率。</p>
</li>
<li><p>debugging选项。</p>
</li>
</ul>
<p>当Monkey运行时，它会产生事件并把它们发送到系统。它也需要在测试下观察系统并寻找需要它特别处理的三种情况：</p>
<ul>
<li><p>如果你限制Monkey运行在一个或者多个指定的包下，它会观察导航到其他包的事件，并且拦截它们。</p>
</li>
<li><p>如果你的应用程序崩溃或者接收到了任何形式的未处理的异常，Monkey会停止并且报告错误。</p>
</li>
<li><p>如果你的应用程序产生了applicaiton not responding（ANR）错误，Monkey会停止并且报告错误。</p>
</li>
</ul>
<p>根据你所选择的详细程度，你还可以看到Monkey的进度报告和正在生成的事件。</p>
<h2 id="Monkey的基本使用"><a href="#Monkey的基本使用" class="headerlink" title="Monkey的基本使用"></a>Monkey的基本使用</h2><p>你可以使用你开发机器上的命令行或者选择一个脚本来启动Monkey。因为Monkey运行在模拟器/设备环境，你必须通过这个环境的shell来启动它。你可以在每句命令前加上<code>adb shell</code>，或者进入shell并直接使用Monkey命令。</p>
<p>基本的语法是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell monkey [options] &lt;event-count&gt;</span><br></pre></td></tr></table></figure>
<p>不使用任何选项指定，Monkey会以一种安静的模式启动，然后发送事件到任何（所有）你目标设备上安装的包中。这里有一个更加典型的命令行，它会启动你的应用程序，然后发送500个伪随机的事件给它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell monkey -p your.package.name -v 500</span><br></pre></td></tr></table></figure>
<h2 id="命令选项参考"><a href="#命令选项参考" class="headerlink" title="命令选项参考"></a>命令选项参考</h2><table>
<thead>
<tr>
<th>分类</th>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>普通</td>
<td><code>--help</code></td>
<td>打印出一个简单的使用指南</td>
</tr>
<tr>
<td></td>
<td><code>-v</code></td>
<td>命令行中的每一个-v都会增加详细程度。Level 0（默认）会在启动通知、测试完成、最后结果时提供少量的信息。Level 1提供更多测试运行时的细节，比如每个发送到你activities的事件。Level 2提供更详细的设置信息，比如测试时activitues选择的或者未选择的。</td>
</tr>
<tr>
<td>事件</td>
<td><code>-s &lt;seed&gt;</code></td>
<td>伪随机数字生成器种子。如果你使用相同的seed值重新运行Monkey，它会产生相同序列的事件</td>
</tr>
<tr>
<td></td>
<td><code>--throttle &lt;milliseconds&gt;</code></td>
<td>在事件之间插入一个固定的延迟。你可以使用这个选项来让Monkey减速。如果没有指定，事件就没有任何延迟，事件会尽可能快地生成。</td>
</tr>
<tr>
<td></td>
<td><code>--pct-touch &lt;percent&gt;</code></td>
<td>调整触摸事件的百分比。（触摸事件是一个在屏幕单个位置的down-up事件。）</td>
</tr>
<tr>
<td></td>
<td><code>--pct-motion &lt;percent&gt;</code></td>
<td>调整移动事件的百分比。（移动事件组成：屏幕上的一个down事件，一系列的伪随机移动事件，和一个up事件。）</td>
</tr>
<tr>
<td></td>
<td><code>--pct-trackball &lt;percent&gt;</code></td>
<td>调整轨迹球事件的百分比。（轨迹球事件组成：一个或者多个随机移动，有时跟随一个点击事件。）</td>
</tr>
<tr>
<td></td>
<td><code>--pct-nav &lt;percent&gt;</code></td>
<td>调整“basic”导航事件的百分比。（导航事件组成：up/down/left/right，作为一个方向输入设备输入。）</td>
</tr>
<tr>
<td></td>
<td><code>--pct-majornav &lt;percent&gt;</code></td>
<td>调整“major”导航事件的百分比。（这些导航事件比较典型的是由你的UI引发的行为，比如5-way pad中间按钮、返回键或者菜单键。）</td>
</tr>
<tr>
<td></td>
<td><code>--pct-syskeys &lt;percent&gt;</code></td>
<td>调整“system”按键事件的百分比。（这些按键一般都是被系统保留的，比如Home、返回、拨打电话、挂电话、音量控制。）</td>
</tr>
<tr>
<td></td>
<td><code>--pct-appswitch &lt;percent&gt;</code></td>
<td>调整Activity启动的百分比。在一个随机的间隔，Monkey会调用startActivity()方法，最大限度地覆盖到你包里的所有Activity。</td>
</tr>
<tr>
<td></td>
<td><code>--pct-anyevent &lt;percent&gt;</code></td>
<td>调整其它事件类型的百分比。它会包含所有类型的事件，比如按键，其它很少使用的设备按钮等等。</td>
</tr>
<tr>
<td>限制</td>
<td><code>-p &lt;allowed-package-name&gt;</code></td>
<td>如果你使用这个方式指定了一个或者多个包，Monkey将会只允许系统访问这些包中的Activities，如果你的应用程序需要访问其它包（比如，选择一个联系人），你也同样需要指定这些包。如果你不指定任何包，Monkey会允许系统启动所有包中的activities。要指定多个包，就多次使用<code>-p</code>—— 每一个包使用一个<code>-p</code>。</td>
</tr>
<tr>
<td></td>
<td><code>-c &lt;main-category&gt;</code></td>
<td>如果使用这个方式指定了一个或者多个<code>categories</code>，Monkey会只允许系统访问指定<code>categories</code>列表中任意一个<code>category</code>的Activities。如果你没有指定任何<code>categories</code>，Monkey会查询<code>Intent.CATEGORY_LAUNCHER</code>或者<code>Intent.CATEGORY_MONKEY</code>。要指定多个<code>category</code>，就多次使用<code>-c</code>—— 每一个<code>category</code>使用一个<code>-c</code>。</td>
</tr>
<tr>
<td>调试</td>
<td><code>--dbg-no-events</code></td>
<td>当这个被指定时，Monkey会执行初始化启动一个测试activity，但是不会再进一步产生任何事件了。最好的方式是结合<code>-v</code>，一个或者多个包限制和非零的间隔来保持Monkey运行30秒或者更高。这样它就提供了一个可以监视应用程序调用包之间的转换过程的环境。</td>
</tr>
<tr>
<td></td>
<td><code>--hprof</code></td>
<td>如果设置，这个选择会在Monkey事件序列之前和之后都会生成分析报告。这个会生成一个大文件（~5Mb）在<code>/data/misc</code>目录下，所以需要小心使用。更多追踪文件信息见<a href="http://developer.android.com/tools/debugging/debugging-tracing.html" target="_blank" rel="noopener">Traceview</a>。</td>
</tr>
<tr>
<td></td>
<td><code>--ignore-crashes</code></td>
<td>通常情况下，Monkey会在应用程序崩溃或者遭遇到未处理的异常时停止运行。如果你设置了设个选项，Monkey将会继续发送事件到系统，直到完成所有。</td>
</tr>
<tr>
<td></td>
<td><code>--ignore-timeouts</code></td>
<td>通常情况下，Monkey会在应用程序崩溃或者遭遇到类型为超时的异常如”Application Not Responding”对话框时停止运行。如果你指定了这个选项，Monkey将会继续发送事件到系统，直到完成所有。</td>
</tr>
<tr>
<td></td>
<td><code>--ignore-security-exceptions</code></td>
<td>通常情况下，Monkey会在应用程序崩溃或者遭遇到类型为权限错误的异常时停止运行，如试图去启动一个需要确定权限的Activity时。如果你指定了这个选项，Monkey将会继续发送事件到系统，直到完成所有。</td>
</tr>
<tr>
<td></td>
<td><code>--kill-process-after-error</code></td>
<td>通常情况下，当Monkey由于一个错误而停止运行，出错的应用程序还会继续运行，如果你指定了这个选项，它会发一个信号来停止这个发生错误的进程。注意，在正常（成功）完成时，启动了的进程不会被关闭，设备只是在事件完成后简单地保持最后的状态。</td>
</tr>
<tr>
<td></td>
<td><code>--monitor-native-crashes</code></td>
<td>观察和报告Android系统native代码引发的崩溃。如果<code>If --kill-process-after-error</code>被设置了，则整个系统就会被停止。</td>
</tr>
<tr>
<td></td>
<td><code>--wait-dbg</code></td>
<td>停止Monkey的执行，直到有调试器跟它连接到。</td>
</tr>
</tbody>
</table>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> testing </tag>
            
            <tag> monkey </tag>
            
            <tag> adb </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]官网《Testing Support Library》中文翻译]]></title>
      <url>/2015/12/15/Android-%E5%AE%98%E7%BD%91%E3%80%8ATesting-Support-Library%E3%80%8B%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91/</url>
      <content type="html"><![CDATA[<p>翻译自 Android Developer 官网：<a href="http://developer.android.com/tools/testing-support-library/index.html" target="_blank" rel="noopener">http://developer.android.com/tools/testing-support-library/index.html</a></p>
<h1 id="Testing-Support-Library"><a href="#Testing-Support-Library" class="headerlink" title="Testing Support Library"></a>Testing Support Library</h1><p><code>Android Testing Support Library</code>为Android app的测试提供了一个广泛的框架。 这个库提供了一系列的API可以让你快速build和run你app的代码，它包括了<code>JUnit 4</code>和功能性的用户界面（UI）测试。你可以通过<a href="http://developer.android.com/tools/studio/index.html" target="_blank" rel="noopener">Android Studio IDE</a>或者命令行的方式运行你使用这些API创建的测试。</p>
<p><code>Android Testing Support Library</code>已经可以通过<code>Android SDK Manager</code>下载使用了。详情可见<a href="http://developer.android.com/tools/testing-support-library/index.html#setup" target="_blank" rel="noopener">Testing Support Library Setup</a></p>
<p>这页中会提供一些关于<code>Android Testing Support Library</code>中所提供的工具的信息，怎样在你的测试环境中使用它们，还有库发布的相关信息。</p>
<h2 id="Testing-Support-Library的特性"><a href="#Testing-Support-Library的特性" class="headerlink" title="Testing Support Library的特性"></a>Testing Support Library的特性</h2><p><code>Android Testing Support Library</code>提供包括了以下自动化测试工具：</p>
<ul>
<li><p><a href="http://developer.android.com/reference/android/support/test/runner/AndroidJUnitRunner.html" target="_blank" rel="noopener">AndroidJUnitRunner</a>：兼容Android的JUnit 4。</p>
</li>
<li><p><a href="http://developer.android.com/tools/testing-support-library/index.html#Espresso" target="_blank" rel="noopener">Espresso</a>：UI测试框架，适用于app内的功能性UI测试。</p>
</li>
<li><p><a href="http://developer.android.com/tools/testing-support-library/index.html#UIAutomator" target="_blank" rel="noopener">UI Automator</a>：UI测试框架，适用于系统和安装app间跨app的功能性UI测试。</p>
</li>
</ul>
<h3 id="AndroidJUnitRunner"><a href="#AndroidJUnitRunner" class="headerlink" title="AndroidJUnitRunner"></a>AndroidJUnitRunner</h3><p><a href="http://developer.android.com/reference/android/support/test/runner/AndroidJUnitRunner.html" target="_blank" rel="noopener">AndroidJUnitRunner</a> 类是一个 <a href="http://junit.org/" target="_blank" rel="noopener">JUnit</a> 测试runner，它可以让你在Android设备上运行<code>JUnit 3</code>或者<code>JUnit 4-style</code>的测试类，包括使用了 <a href="http://developer.android.com/tools/testing-support-library/index.html#Espresso" target="_blank" rel="noopener">Espresso</a> 和 <a href="http://developer.android.com/tools/testing-support-library/index.html#UIAutomator" target="_blank" rel="noopener">UI Automator</a> 测试框架的。<code>test runner</code>处理的事情有 加载你的测试package和需要在设备上测试的app，运行你的测试，还有报告测试结果。这个类会替换掉只支持<code>JUnit 3</code>测试的<a href="http://developer.android.com/reference/android/test/InstrumentationTestRunner.html" target="_blank" rel="noopener">InstrumentationTestRunner</a>类。</p>
<p>这个<code>test runner</code>的关键特性包括：</p>
<ul>
<li><p><a href="http://developer.android.com/tools/testing-support-library/index.html#ajur-junit" target="_blank" rel="noopener">JUnit的支持</a></p>
</li>
<li><p><a href="http://developer.android.com/tools/testing-support-library/index.html#ajur-instrumentation" target="_blank" rel="noopener">访问instrumentation信息</a></p>
</li>
<li><p><a href="http://developer.android.com/tools/testing-support-library/index.html#ajur-filtering" target="_blank" rel="noopener">测试过滤</a></p>
</li>
<li><p><a href="http://developer.android.com/tools/testing-support-library/index.html#ajur-sharding" target="_blank" rel="noopener">测试拆分</a></p>
</li>
</ul>
<p>需要 Android2.2(API level 8) 或者更高。</p>
<h4 id="JUnit的支持"><a href="#JUnit的支持" class="headerlink" title="JUnit的支持"></a>JUnit的支持</h4><p><code>Rest runner</code>兼容<code>JUnit 3</code>和<code>JUnit 4</code>（最高到<code>JUnit 4.10</code>）的测试。不管怎样，你应该避免在一个package中混合使用JUnit 3和 JUnit 4的代码，因为这样做可能会引发一些预料之外的问题。如果你创建了一个JUnit 4的测试类在设备或者模拟器上运行时，你的测试类必须要加上<code>@RunWith(AndroidJUnit4.class)</code>注解作为前缀。</p>
<p>下面的代码片段展示了你应该怎么去编写一个JUnit 4测试来验证<code>CalculatorActivity</code>类中的<code>add</code>操作是正确执行的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.support.test.runner.AndroidJUnit4;</span><br><span class="line"><span class="keyword">import</span> android.support.test.runner.AndroidJUnitRunner;</span><br><span class="line"><span class="keyword">import</span> android.test.ActivityInstrumentationTestCase2;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(AndroidJUnit4.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalculatorInstrumentationTest</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">ActivityInstrumentationTestCase2</span>&lt;<span class="title">CalculatorActivity</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setUp();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当你使用`AndroidJUnitRunner`运行测试时，</span></span><br><span class="line">        <span class="comment">// 注入Instrumentation实例是必要的。</span></span><br><span class="line">        injectInstrumentation(InstrumentationRegistry.getInstrumentation());</span><br><span class="line">        mActivity = getActivity();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">typeOperandsAndPerformAddOperation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 调用CalculatorActivity add()方法并传入一些操作数据，</span></span><br><span class="line">        <span class="comment">// 然后检查返回值是否是期望值</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.tearDown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="访问instrumentation信息"><a href="#访问instrumentation信息" class="headerlink" title="访问instrumentation信息"></a>访问instrumentation信息</h4><p>你可以使用 <a href="http://developer.android.com/reference/android/support/test/InstrumentationRegistry.html" target="_blank" rel="noopener"><code>InstrumentationRegistry</code></a> 类来访问你测试的app的相关信息。这个类包含一个 <a href="http://developer.android.com/reference/android/app/Instrumentation.html" target="_blank" rel="noopener"><code>Instrumentation</code></a> 对象，目标app的 <a href="http://developer.android.com/reference/android/content/Context.html" target="_blank" rel="noopener"><code>Context</code></a> 对象，还有你通过命令行传入到该测试的参数。这个数据在你使用UI Automator框架编写测试或者编写一些依赖 <a href="http://developer.android.com/reference/android/app/Instrumentation.html" target="_blank" rel="noopener"><code>Instrumentation</code></a> 或者 <a href="http://developer.android.com/reference/android/content/Context.html" target="_blank" rel="noopener"><code>Context</code></a> 对象的测试的时候是很有用的。</p>
<h4 id="测试过滤"><a href="#测试过滤" class="headerlink" title="测试过滤"></a>测试过滤</h4><p>在你的 JUnit 4 测试中， 你可以使用注解来配置你的测试的运行。这会最大限度地减少你测试中需要的模版代码和有条件的代码。除了 JUnit 4 支持的标准注解，<code>test runner</code>也支持一些针对Android的特殊的注解，包括：</p>
<ul>
<li><p><a href="http://developer.android.com/reference/android/support/test/filters/RequiresDevice.html" target="_blank" rel="noopener"><code>@RequiresDevice</code></a>：指明这个测试只能运行的物理设备上面，而不是模拟器上面。</p>
</li>
<li><p><a href="http://developer.android.com/reference/android/support/test/filters/SdkSuppress.html" target="_blank" rel="noopener"><code>@SdkSupress</code></a>：限制这个测试运行在低于给定的Android API level。举个例子，限制测试运行在API level低于18的环境下，使用注解 <code>@SDKSupress(minSdkVersion=18)</code>。</p>
</li>
<li><p><a href="http://developer.android.com/reference/android/test/suitebuilder/annotation/SmallTest.html" target="_blank" rel="noopener"><code>@SmallTest</code></a>，<a href="http://developer.android.com/reference/android/test/suitebuilder/annotation/MediumTest.html" target="_blank" rel="noopener"><code>@MediumTest</code></a>，和<a href="http://developer.android.com/reference/android/test/suitebuilder/annotation/LargeTest.html" target="_blank" rel="noopener"><code>@LargeTest</code></a>：对测试需要的时间运行来分类，因此，可以决定是否可以经常运行该测试。</p>
</li>
</ul>
<h4 id="测试拆分"><a href="#测试拆分" class="headerlink" title="测试拆分"></a>测试拆分</h4><p><code>Test runner</code> 支持把一个测试套件分割成多个碎片，所以你可以很简单地运行属于通过碎片分组的所有测试，并且它们使用同一个 <a href="http://developer.android.com/reference/android/app/Instrumentation.html" target="_blank" rel="noopener"><code>Instrumentation</code></a> 实例。每一个碎片都有一个索引编号（index number）作为它的唯一识别。当运行测试时，使用 <code>-e numShards</code> 选项来指定要创建的碎片的数量和 <code>-e shardIndex</code> 选项来指定哪些碎片运行。</p>
<p>举个例子，把一个测试套件分割成10个碎片，并且只运行被分组的测试中的第二个碎片，使用以下的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am instrument -w -e numShards 10 -e shardIndex 2</span><br></pre></td></tr></table></figure>
<p>这个 <code>test runner</code> 的更多相关学习，见 <a href="http://developer.android.com/reference/android/support/test/package-summary.html" target="_blank" rel="noopener">API reference</a>。</p>
<h3 id="Espresso"><a href="#Espresso" class="headerlink" title="Espresso"></a>Espresso</h3><p>Espresso 测试框架提供了一系列的API用于构建UI测试来测试app内用户流操作。这些API让你可以编写简洁可靠的自动化UI测试。<strong>Espresso非常适合用来编写白盒测试</strong>，其中测试代码的编写是利用了被测试app中程序代码实现细节。</p>
<p>Espresso测试框架的关键特性包括：</p>
<ul>
<li><p>提供了灵活的API用于匹配目标app中<code>view</code>和<code>adapter</code>。更多的信息，见 <a href="http://developer.android.com/tools/testing-support-library/index.html#espresso-matching" target="_blank" rel="noopener">View 匹配</a></p>
</li>
<li><p>大而全的 <code>行为 api</code>（action APIs） 用于自动化UI交互。更多的信息，见 <a href="http://developer.android.com/tools/testing-support-library/index.html#espresso-actions" target="_blank" rel="noopener">行为 APIs</a></p>
</li>
<li><p>UI线程同步来提高测试可靠性。更多信息，见 <a href="http://developer.android.com/tools/testing-support-library/index.html#espresso-thread-sync" target="_blank" rel="noopener">UI 线程同步</a></p>
</li>
</ul>
<p>需要 Android2.2(API level 8) 或者更高。</p>
<h4 id="View-匹配"><a href="#View-匹配" class="headerlink" title="View 匹配"></a>View 匹配</h4><p><a href="http://developer.android.com/reference/android/support/test/espresso/Espresso.html#onView" target="_blank" rel="noopener"><code>Espresso.onView()</code></a> 方法可以让你访问目标app中的一个UI组件并与它交互。这个方法接收一个 <a href="http://hamcrest.org/JavaHamcrest/javadoc/1.3/org/hamcrest/Matcher.html" target="_blank" rel="noopener"><code>Matcher</code></a> 作为参数，然后根据我们给定的条件在view的层次结构中搜索出对应相符的<a href="http://developer.android.com/reference/android/view/View.html" target="_blank" rel="noopener"><code>View</code></a>实例。你可以使用如下的条件来优化你的搜索结果：</p>
<ul>
<li>View的类名</li>
<li>View内容的描述（<code>content description</code>）</li>
<li>View的<code>R.id</code></li>
<li>View显示的文本</li>
</ul>
<p>举个例子，寻找一个ID为<code>my_button</code>的目标button，你可以如以下一样指定一个matcher：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onView(withId(R.id.my_button));</span><br></pre></td></tr></table></figure>
<p>如果搜索是成功的，<a href="http://developer.android.com/reference/android/support/test/espresso/Espresso.html#onView" target="_blank" rel="noopener"><code>onView()</code></a> 方法会返回一个可以让你执行用户行为和测试目标中对view断言的引用。</p>
<h4 id="Adapter-匹配"><a href="#Adapter-匹配" class="headerlink" title="Adapter 匹配"></a>Adapter 匹配</h4><p>在一个 <a href="http://developer.android.com/reference/android/widget/AdapterView.html" target="_blank" rel="noopener"><code>AdapterView</code></a> 的布局中，布局是在运行时根据children动态填充的。如果目标view是在 <a href="http://developer.android.com/reference/android/widget/AdapterView.html" target="_blank" rel="noopener"><code>AdapterView</code></a> 子类（比如<a href="http://developer.android.com/reference/android/widget/ListView.html" target="_blank" rel="noopener"><code>ListView</code></a> 或者 <a href="http://developer.android.com/reference/android/widget/GridView.html" target="_blank" rel="noopener"><code>GridView</code></a>）的布局中的，<a href="http://developer.android.com/reference/android/support/test/espresso/Espresso.html#onView" target="_blank" rel="noopener"><code>onView()</code></a> 方法可能就不起作用了，因为当前加载的view层次结构可能只是layout的一个子集。</p>
<p>替代方案是使用 <a href="http://developer.android.com/reference/android/support/test/espresso/Espresso.html#onData)" target="_blank" rel="noopener"><code>Espresso.onData()</code></a> 方法去访问一个目标view元素。<a href="http://developer.android.com/reference/android/support/test/espresso/Espresso.html#onData)" target="_blank" rel="noopener"><code>Espresso.onData()</code></a> 方法返回一个可以让你执行用户行为和测试目标 <a href="http://developer.android.com/reference/android/widget/AdapterView.html" target="_blank" rel="noopener"><code>AdapterView</code></a> 中对元素断言的引用。</p>
<h4 id="行为-APIs"><a href="#行为-APIs" class="headerlink" title="行为 APIs"></a>行为 APIs</h4><p>典型的，你可以通过对app的用户界面执行一些用户交互来测试app。在你的测试中使用 <a href="http://developer.android.com/reference/android/support/test/espresso/action/ViewActions.html" target="_blank" rel="noopener"><code>ViewActions</code></a> API 可以让你很容易地自动化这些行为。你可以通过以下方式执行这些UI交互：</p>
<ul>
<li><p>View的点击</p>
</li>
<li><p>滑动</p>
</li>
<li><p>按键和按钮的按下</p>
</li>
<li><p>输入文本</p>
</li>
<li><p>打开一个链接</p>
</li>
</ul>
<p>举个例子，模拟输入一个字符串数据并按下按钮来提交这个值，你可以像这样编写一个自动化测试脚本。 <a href="http://developer.android.com/reference/android/support/test/espresso/ViewInteraction.html#perform(android.support.test.espresso.ViewAction..." target="_blank" rel="noopener"><code>ViewInteraction.preform()</code></a>) 和 <a href="http://developer.android.com/reference/android/support/test/espresso/DataInteraction.html#perform(android.support.test.espresso.ViewAction..." target="_blank" rel="noopener"><code>DataInteraction.perform()</code></a>) 方法接收一个或者多个<a href="http://developer.android.com/reference/android/support/test/espresso/ViewAction.html" target="_blank" rel="noopener"><code>ViewAction</code></a> 参数并且按照提供的顺序执行这些<code>actions</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在一个EditText中输入文本信息，然后关闭软键盘</span></span><br><span class="line">onView(withId(R.id.editTextUserInput))</span><br><span class="line">    .perform(typeText(STRING_TO_BE_TYPED), closeSoftKeyboard());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 按下按钮来提交改变的文本</span></span><br><span class="line">onView(withId(R.id.changeTextBt)).perform(click());</span><br></pre></td></tr></table></figure>
<h4 id="UI线程同步"><a href="#UI线程同步" class="headerlink" title="UI线程同步"></a>UI线程同步</h4><p>在Android设备上测试可能由于时间的关系会随机性地失败。这个测试问题称为test flakiness（测试片状）。在Espresso之前，变通的办法是在测试中插入足够长的睡眠或者一段时间后超时，或者增加在操作失败之后保持重试的代码。Espresso测试框架会在<a href="http://developer.android.com/reference/android/app/Instrumentation.html" target="_blank" rel="noopener"><code>Instrumentation</code></a>和UI线程之间保持同步；这样就可以去掉之前因为时间问题使用的变通的方法，并且确保你测试的行为和断言运行更加可靠。</p>
<p>更多Espresso的相关学习，见 <a href="http://developer.android.com/reference/android/support/test/package-summary.html" target="_blank" rel="noopener">API reference</a> 和 <a href="http://developer.android.com/training/testing/ui-testing/espresso-testing.html" target="_blank" rel="noopener">针对单个App的UI测试</a> 练习。</p>
<h3 id="UI-Automator"><a href="#UI-Automator" class="headerlink" title="UI Automator"></a>UI Automator</h3><p>UI Automator测试框架提供了一系列的API来构建在用户app和系统app之间的UI测试。UI Automator APIs  允许你在测试设备中执行例如打开设置菜单或者launcher等操作。<strong>UI Automator 测试框架非常适合用来写黑盒测试</strong>，其中测试代码的编写不需要依赖于目标app的内部实现细节。</p>
<p>UI Automator测试框架的关键特性包括：</p>
<ul>
<li><p>检查layout层次结构的Viewer。更多信息，见 <a href="http://developer.android.com/tools/testing-support-library/index.html#uia-viewer" target="_blank" rel="noopener"><code>UI Automator Viewer</code></a>。</p>
</li>
<li><p>一个用于在目标设备上获取状态信息和执行操作的API。更多信息，见 <a href="http://developer.android.com/tools/testing-support-library/index.html#uia-device-state" target="_blank" rel="noopener"><code>访问设备状态</code></a></p>
</li>
<li><p>跨app的UI测试APIs。更多信息，见 <a href="http://developer.android.com/tools/testing-support-library/index.html#uia-apis" target="_blank" rel="noopener"><code>UI automator APIS</code></a></p>
</li>
</ul>
<p>需要 Android4.3(API level 18) 或者更高。</p>
<h4 id="UI-Automator-Viewer"><a href="#UI-Automator-Viewer" class="headerlink" title="UI Automator Viewer"></a>UI Automator Viewer</h4><p><code>uiautomatorviewer</code> 工具提供了一个方便的GUI来扫描和分析当前在Android设备上显示的UI组件。你可以使用这些工具来检查layout层次结构和查看在设备前台可见的组件的属性。这个信息可以让你使用UI Automator创建更加细粒度的测试，比如创建一个匹配指定的可见性属性的UI选择器。</p>
<p><code>uiautomatorviewer</code> 工具在 <code>&lt;android-sdk&gt;/tools/</code> 目录下。</p>
<h4 id="访问设备状态"><a href="#访问设备状态" class="headerlink" title="访问设备状态"></a>访问设备状态</h4><p>UI Automator测试框架提供了一个 <a href="http://developer.android.com/reference/android/support/test/uiautomator/UiDevice.html" target="_blank" rel="noopener"><code>UIDevice</code></a> 类在目标app运行的设备上访问和执行操作。你可以调用它的方法来访问如当前的设备定向活着显示尺寸等设备属性。 <a href="http://developer.android.com/reference/android/support/test/uiautomator/UiDevice.html" target="_blank" rel="noopener"><code>UIDevice</code></a> 类也可以让你执行一些如下的行为：</p>
<ul>
<li><p>旋转设备</p>
</li>
<li><p>按下 <code>D-pad</code> 键</p>
</li>
<li><p>按下返回键、Home键、菜单键</p>
</li>
<li><p>打开通知栏</p>
</li>
<li><p>当前的窗口截图</p>
</li>
</ul>
<p>举个例子，模拟按下Home按钮，调用 <code>UiDevice.pressHome()</code> 方法。</p>
<h4 id="UI-Automator-APIs"><a href="#UI-Automator-APIs" class="headerlink" title="UI Automator APIs"></a>UI Automator APIs</h4><p>UI Automator APIs 允许你在不需要知道目标app实现细节的情况下去编写强大的测试。你可以使用这些APIs来捕获和操作跨越多个app的UI组件：</p>
<ul>
<li><p><a href="http://developer.android.com/reference/android/support/test/uiautomator/UiCollection.html" target="_blank" rel="noopener"><code>UiCollection</code></a>：枚举容器中的UI元素来计数，或者通过子元素的可见text或<code>content-description</code>属性来作为一个目标。</p>
</li>
<li><p><a href="http://developer.android.com/reference/android/support/test/uiautomator/UiObject.html" target="_blank" rel="noopener"><code>UiObject</code></a>：代表在设备上一个可见的UI元素。</p>
</li>
<li><p><a href="http://developer.android.com/reference/android/support/test/uiautomator/UiScrollable.html" target="_blank" rel="noopener"><code>UiScrollable</code></a>：对可滚动的UI容器中搜索UI元素提供支持。</p>
</li>
<li><p><a href="http://developer.android.com/reference/android/support/test/uiautomator/UiSelector.html" target="_blank" rel="noopener"><code>UiSelector</code></a>：代表一个设备上对一个或者多个目标UI元素的查询。</p>
</li>
<li><p><a href="http://developer.android.com/reference/android/support/test/uiautomator/Configurator.html" target="_blank" rel="noopener"><code>Configurator</code></a>：允许你设置UI Automator测试的关键参数。</p>
</li>
</ul>
<p>举个例子，下面的代码展示了怎么样去编写一个测试脚本来获取默认的app launcher：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化 UiDevice 实例</span></span><br><span class="line">mDevice = UiDevice.getInstance(getInstrumentation());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 HOME 按钮上执行一个短暂的按压</span></span><br><span class="line">mDevice().pressHome();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过匹配启动按钮的content-description来搜索一个UI组件</span></span><br><span class="line"><span class="comment">// 得到默认的launcher</span></span><br><span class="line">UiObject allAppsButton = mDevice</span><br><span class="line">        .findObject(<span class="keyword">new</span> UiSelector().description(<span class="string">"Apps"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在得到的launcher 按钮上面执行一个点击</span></span><br><span class="line">allAppsButton.clickAndWaitForNewWindow();</span><br></pre></td></tr></table></figure>
<p>更多UI Automator相关学习，见 <a href="http://developer.android.com/reference/android/support/test/package-summary.html" target="_blank" rel="noopener">API reference</a> 和 <a href="http://developer.android.com/training/testing/ui-testing/uiautomator-testing.html" target="_blank" rel="noopener">多App的UI测试</a> 练习。</p>
<h2 id="Testing-Support-Library-Setup"><a href="#Testing-Support-Library-Setup" class="headerlink" title="Testing Support Library Setup"></a>Testing Support Library Setup</h2><p>Android Testing Support Library package已经包含在最新版本的作为补充库、可在SDK Manager中下载的Android Support Repository中。</p>
<p>通过SDK Manager下载Android Support Repository：</p>
<p>1. 启动 <a href="http://developer.android.com/tools/help/sdk-manager.html" target="_blank" rel="noopener">Android SDK Manager</a>。</p>
<p>2. 在SDK Manager窗口，滚动到Packages列表的最底部，找到<code>Extras</code>目录，如果需要，把它展开显示它的内容。</p>
<p>3. 找到 <strong>Android Support Repository</strong> 项。</p>
<p>4. 点击 <strong>Install packages…</strong> 按钮。</p>
<p>下载完之后，工具把Support Repository文件安装在存在的Android SDK目录。库文件会被放置在你SDK目录的子目录中：<code>&lt;sdk&gt;/extras/android/m2respository</code> 目录。</p>
<p>Android Testing Support Library 类被放置在<code>android.support.test</code>包下面。</p>
<p>为了在你的Gradle项目中使用Android Testing Support Library，在你的<code>build.gradle</code>文件中增加如下依赖：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">  androidTestCompile <span class="string">'com.android.support.test:runner:0.4'</span></span><br><span class="line">  <span class="comment">// Set this dependency to use JUnit 4 rules</span></span><br><span class="line">  androidTestCompile <span class="string">'com.android.support.test:rules:0.4'</span></span><br><span class="line">  <span class="comment">// Set this dependency to build and run Espresso tests</span></span><br><span class="line">  androidTestCompile <span class="string">'com.android.support.test.espresso:espresso-core:2.2.1'</span></span><br><span class="line">  <span class="comment">// Set this dependency to build and run UI Automator tests</span></span><br><span class="line">  androidTestCompile <span class="string">'com.android.support.test.uiautomator:uiautomator-v18:2.1.2'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了在你的Gradle项目中默认使用<a href="http://developer.android.com/reference/android/support/test/runner/AndroidJUnitRunner.html" target="_blank" rel="noopener">AndroidJUnitRunner</a>作为默认的instrumentation runner，在你的<code>build.gradle</code>文件中指定这个依赖：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        testInstrumentationRunner <span class="string">"android.support.test.runner.AndroidJUnitRunner"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>强烈推荐你与Android Studio IDE一起使用Android Testing Support Library。Android Studio提供了支持测试开发的功能，比如：</p>
<ul>
<li><p>灵活并基于Gradle构建系统，支持对你测试代码的依赖管理。</p>
</li>
<li><p>单元和instrumented测试代码与你的app的源代码放置在单个项目结构中。</p>
</li>
<li><p>支持从命令行或者GUI来部署和运行你的测试在虚拟或者物理设备中。</p>
</li>
</ul>
<p>更多Android Studio相关和下载，见 <a href="http://developer.android.com/sdk/index.html" target="_blank" rel="noopener">下载Android Studio和SDK Tools</a>。</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 翻译 </tag>
            
            <tag> testing </tag>
            
            <tag> google </tag>
            
            <tag> support </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]对MVC和MVP的总结]]></title>
      <url>/2015/12/10/Android-%E5%AF%B9MVC%E5%92%8CMVP%E7%9A%84%E6%80%BB%E7%BB%93/</url>
      <content type="html"><![CDATA[<p>经历过的客户端的架构分为这么几个阶段：</p>
<h3 id="第一阶段"><a href="#第一阶段" class="headerlink" title="第一阶段"></a>第一阶段</h3><p>使用传统的MVC，其中的View，对应的是各种Layout布局文件，但是这些布局文件中并不像Web端那样强大，能做的事情非常有限；Controller对应的是Activity，而Activity中却又具有操作UI的功能，我们在实际的项目中也会有很多UI操作在这一层，也做了很多View中应该做的事情，当然Controller中也包含Controller应该做的事情，比如各种事件的派发回调，而且在一层中我们会根据事件再去调用Model层操作数据，所以这种MVC的方式在实际项目中，Activity所在的Controller是非常重的，各层次之间的耦合情况也比较严重，不方便单元测试。</p>
<h3 id="第二阶段"><a href="#第二阶段" class="headerlink" title="第二阶段"></a>第二阶段</h3><p>使用MVC的进化版——MVP，MVP中把Layout布局和Activity作为View层，增加了Presenter，Presenter层与Model层进行业务的交互，完成后再与View层交互（也就是Activity）进行回调来刷新UI。这样一来，所有业务逻辑的工作都交给了Presenter中进行，使得View层与Model层的耦合度降低，Activity中的工作也进行了简化。但是在实际项目中，随着逻辑的复杂度越来越大，Activity臃肿的缺点仍然体现出来了，因为Activity中还是充满了大量与View层无关的代码，比如各种事件的处理派发，就如MVC中的那样View层和Controller代码耦合在一起无法自拔。</p>
<h3 id="第三阶段"><a href="#第三阶段" class="headerlink" title="第三阶段"></a>第三阶段</h3><p>也是现在正在使用的架构，针对第二阶段进行优化，为了把View再次简化，想到两种方式：</p>
<p>1. 通过使用一个Presenter代理的方式，在PresenterProxy中处理各种事件机制，View中维护一个PresenterProxy对象当然Presenter中同样实现了真实对象Presnter所实现的接口，这样，我们同样在View中通过代理对象调用真实对象的代码，结构图如下：<br><img src="https://raw.githubusercontent.com/wangjiegulu/wangjiegulu.github.com/master/images/mvp/MVP_PresenterProxy.jpg" alt=""></p>
<p>2. 为MVP增加一层专门用于处理各种的事件派发Controller层，Controller的作用仅仅是处理事件并根据事件通过维护的Presenter对象派发到对应的业务中，也就是说View层只有一个Controller的对象，View层不会主动去调用Presenter层，但是Controller层和Presenter都可能会回调到View层来刷新UI，所以层次结构就变成了如下：<br><img src="https://raw.githubusercontent.com/wangjiegulu/wangjiegulu.github.com/master/images/mvp/MVP_Controller.jpg" alt=""></p>
<p>现在使用的是第2种方式，使用Controller来进行对Activity中事件代码的分离，下面使用登录的例子来讲解，其中代码使用的并不是Java，而是Kotlin。</p>
<p>在演示之前，先来看下实现MVP的几个基础的接口和类（<a href="https://github.com/wangjiegulu/AndroidKotlinBucket/blob/master/library/src/main/kotlin/com/wangjie/androidkotlinbucket/library/AKBMVPExt.kt" target="_blank" rel="noopener">点这里查看AKBMVPExt.kt</a>）：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MVP的View层，UI相关，Activity需要实现该interface</span></span><br><span class="line"><span class="comment"> * 它会包含一个Presenter的引用，当有事件发生（比如按钮点击后），会调用Presenter层的方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KViewer</span> </span>&#123;</span><br><span class="line">    <span class="comment">//    val onClickListener: ((view: View) -&gt; Unit)?</span></span><br><span class="line">    <span class="keyword">val</span> context: Context?;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">toast</span><span class="params">(message: <span class="type">String</span>, duration: <span class="type">Int</span> = Toast.LENGTH_SHORT)</span></span> &#123;</span><br><span class="line">        context?.lets &#123; Toast.makeText(<span class="keyword">this</span>, message, duration).show() &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">dialog</span><span class="params">(title: <span class="type">String</span>? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               message: <span class="type">String</span>?,</span></span></span><br><span class="line"><span class="function"><span class="params">               okText: <span class="type">String</span>? = <span class="string">"OK"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               cancelText: <span class="type">String</span>? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               positiveClickListener: ((<span class="type">DialogInterface</span>, <span class="built_in">Int</span>)</span></span> -&gt; <span class="built_in">Unit</span>)? = <span class="literal">null</span>,</span><br><span class="line">               negativeClickListener: ((DialogInterface, <span class="built_in">Int</span>) -&gt; <span class="built_in">Unit</span>)? = <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        context?.lets &#123;</span><br><span class="line">            AlertDialog.Builder(<span class="keyword">this</span>)</span><br><span class="line">                    .setTitle(title)</span><br><span class="line">                    .setMessage(message)</span><br><span class="line">                    .setPositiveButton(okText, positiveClickListener)</span><br><span class="line">                    .setNegativeButton(cancelText, negativeClickListener)</span><br><span class="line">                    .show()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">showLoading</span><span class="params">(message: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        Log.w(KViewer::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>.<span class="title">simpleName</span>, <span class="type">"loadingDialog should impl by subclass")</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">cancelLoading</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.w(KViewer::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>.<span class="title">simpleName</span>, <span class="type">"cancelLoadingDialog should impl by subclass")</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : View&gt;</span> <span class="title">findView</span><span class="params">(resId: <span class="type">Int</span>)</span></span>: T;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有<code>View</code>层的Activity、Fragment或者View都要实现<code>KViewer</code>接口，该接口中有一个属性和一个函数需要被子类的Activity实现：</p>
<ul>
<li><p><code>context</code>属性：该属性需要被子类override，该属性用于一些接口公用的UI相关操作的方法，如<code>toast</code>、<code>dialog</code>、<code>cancelDialog</code>等。</p>
</li>
<li><p><code>fun &lt;T : View&gt; findView(resId: Int): T</code>函数：该函数需要被子类Activity、Fragment或者View实现，这个方法用于从当前View层中根据id获取到对应的View，该方法在Activity、Fragment或者View中并不一致。</p>
</li>
</ul>
<p>当然所有的重写都可以在BaseActivity、BaseFragment、BaseFrameLayout等中重写，之后使用它们的子类即可。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MVP的Presenter层，作为沟通View和Model的桥梁，它从Model层检索数据后，返回给View层，它也可以决定与View层的交互操作。</span></span><br><span class="line"><span class="comment"> * 它包含一个View层的引用和一个Model层的引用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">KPresenter</span>&lt;<span class="type">V : KViewer</span>&gt;</span>(<span class="keyword">var</span> viewer: V) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">closeAll</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.w(KViewer::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>.<span class="title">simpleName</span>, <span class="type">"closeAll in KPresenter should impl by subclass")</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>KPresenter</code>类是作为所有Presenter层的实现的基类的，它只有一个<code>closeAll</code>函数需要被重写，当Activity在被destory时，需要调用close函数停止到子线程的任务。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Controller，用于派发View中的事件，它在根据不同的事件调用Presenter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">KController</span>&lt;<span class="type">KV : KViewer, KP : KPresenter&lt;*</span>&gt;&gt;</span>(<span class="keyword">val</span> viewer: KV, presenterCreate: () -&gt; KP) &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">val</span> presenter: KP <span class="keyword">by</span> lazy &#123; presenterCreate() &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewCache: SparseArray&lt;View&gt; = SparseArray();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">bindEvents</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : View&gt;</span> <span class="title">getView</span><span class="params">(resId: <span class="type">Int</span>)</span></span>: T &#123;</span><br><span class="line">        <span class="keyword">val</span> view: View? = viewCache.<span class="keyword">get</span>(resId)</span><br><span class="line">        <span class="keyword">return</span> view <span class="keyword">as</span> T? ?: viewer.findView&lt;T&gt;(resId).apply &#123;</span><br><span class="line">            viewCache.put(resId, <span class="keyword">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">closeAll</span><span class="params">()</span></span> = presenter.closeAll()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样<code>KController</code>是所有<code>Controller</code>类的基类，需要子类实现<code>bindEvents()</code>函数，在这个函数中，可以绑定各种View的事件。还提供了<code>getView()</code>方法来从Viewer中获取到对应的控件，并且会缓存找到的控件。</p>
<h4 id="一、创建BaseActivity并实现KViewer"><a href="#一、创建BaseActivity并实现KViewer" class="headerlink" title="一、创建BaseActivity并实现KViewer"></a>一、创建<code>BaseActivity</code>并实现<code>KViewer</code></h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> : <span class="type">AppCompatActivity</span></span>(), KViewer &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : View&gt;</span> <span class="title">findView</span><span class="params">(resId: <span class="type">Int</span>)</span></span>: T = findViewById(resId) <span class="keyword">as</span> T</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> context: Context = <span class="keyword">this</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">val</span> controller: KController&lt;*, *&gt;? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> loadingDialog: ProgressDialog <span class="keyword">by</span> lazy &#123; ProgressDialog(<span class="keyword">this</span>) &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        <span class="comment">// 强制竖屏</span></span><br><span class="line">        requestedOrientation = ActivityInfo.SCREEN_ORIENTATION_PORTRAIT</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">showLoading</span><span class="params">(message: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        loadingDialog.setMessage(message)</span><br><span class="line">        loadingDialog.show()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">cancelLoading</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (loadingDialog.isShowing) &#123;</span><br><span class="line">            loadingDialog.cancel()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">        controller?.closeAll()</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我重写了<code>KViewer</code>中的<code>findView()</code>函数，函数实现是通过<code>Activity::findViewById()</code>的方式。</p>
<p>又实现了<code>controller</code>属性，设置为null，这个<code>controller</code>还需要子类再来重写。</p>
<p>然后重写了<code>showLoading</code>和<code>cancelLoading</code>，在<code>onDestory</code>中通过<code>controller</code>调用<code>presenter</code>中的<code>closeAll</code>函数。</p>
<h4 id="二、实现LoginActivity"><a href="#二、实现LoginActivity" class="headerlink" title="二、实现LoginActivity"></a>二、实现<code>LoginActivity</code></h4><p>新建<code>LoginViewer</code>接口，继承<code>KViewer</code>，并定义各种逻辑回调：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">LoginViewer</span> : <span class="type">KViewer &#123;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onLogin</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>里面所有的函数应该都是名字<code>onXXX</code>的函数，都是需要去操作UI的，这里定义的是一个<code>onLogin()</code>函数，表示登录成功后，我们现在是如果登录成功后，则跳转到主界面<code>MainActivity</code>。</p>
<p>然后创建<code>LoginActivity</code>，实现我们的<code>LoginViewer</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> : <span class="type">BaseActivity</span></span>(), LoginViewer &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> controller: LoginController <span class="keyword">by</span> lazy &#123; LoginController(<span class="keyword">this</span>) &#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_login)</span><br><span class="line"></span><br><span class="line">        controller.bindEvents()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLogin</span><span class="params">()</span></span> &#123;</span><br><span class="line">        toActivity&lt;MainActivity&gt; &#123; &#125;</span><br><span class="line">        finish()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们首先重写父类中的<code>controller</code>属性，通过<code>lazy</code>懒初始化<code>LoginController</code>，然后在<code>onCreate</code>中调用<code>controller</code>的<code>bindEvents()</code>，这样，我们在<code>controller</code>中的<code>bindEvents()</code>函数中就可以对各种View进行事件的绑定，甚至包括自定义的Dialog、PopupWindow等组件的回调。</p>
<p>然后实现<code>onLogin</code>函数，在这个函数中进行界面的跳转。</p>
<h4 id="三、实现LoginController"><a href="#三、实现LoginController" class="headerlink" title="三、实现LoginController"></a>三、实现LoginController</h4><p>创建<code>LoginController</code>，继承<code>KController</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginController</span></span>(viewer: LoginViewer) : KController&lt;LoginViewer, LoginPresenter&gt;(viewer, &#123; LoginPresenter(viewer) &#125;),</span><br><span class="line">        View.OnClickListener &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">bindEvents</span><span class="params">()</span></span> &#123;</span><br><span class="line">        getView&lt;Button&gt;(R.id.activity_login_submit_btn).setOnClickListener(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(v: <span class="type">View</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (v?.id) &#123;</span><br><span class="line">            R.id.activity_login_submit_btn -&gt; presenter.login(getView&lt;EditText&gt;(R.id.activity_login_username_et).text.toString(), getView&lt;EditText&gt;(R.id.activity_login_password_et).text.toString())</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现<code>KController</code>中的<code>bindEvents</code>函数，在<code>bindEvents</code>中我们通过<code>KController</code>中<code>getView()</code>函数获取到Id为<code>R.id.activity_login_submit_btn</code>的按钮，然后设置<code>OnClickListener</code>，在onClick回调方法中，<code>Controller</code>会根据事件派发到<code>Presenter</code>来进行真正的登录操作。</p>
<h4 id="四、实现Presenter"><a href="#四、实现Presenter" class="headerlink" title="四、实现Presenter"></a>四、实现Presenter</h4><p>创建<code>Presenter</code>，继承<code>KPresenter</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginPresenter</span></span>(viewer: LoginViewer) : KPresenter&lt;LoginViewer&gt;(viewer) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">login</span><span class="params">(username: <span class="type">String</span>, password: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        viewer.showLoading(_resString(R.string.xr_hint_logging_in))</span><br><span class="line"></span><br><span class="line">        HttpsUrl(HttpWebApi.System.LOGIN).rxRequest &#123;</span><br><span class="line">            it.posts(</span><br><span class="line">                    <span class="string">"username"</span> to username,</span><br><span class="line">                    <span class="string">"password"</span> to password</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">                .map &#123;</span><br><span class="line">                    _gson._fromJson&lt;LoginHttpResponse&gt;(it.body().string()) </span><br><span class="line">                &#125;</span><br><span class="line">                .observeOnMain()</span><br><span class="line">                .doOnNextOrError &#123; viewer.cancelLoading() &#125;</span><br><span class="line">                .subscribe (&#123;</span><br><span class="line">                    <span class="keyword">if</span> (it.success) &#123;</span><br><span class="line">                        viewer.onLogin()</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        showHint(it.msg)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;) &#123;</span><br><span class="line">                    Log.e(<span class="string">"Login"</span>, <span class="string">""</span>, it)</span><br><span class="line">                    viewer.toast(_resString(R.string.xr_error_default))</span><br><span class="line">                &#125;</span><br><span class="line">                .bindPresenter(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写<code>login()</code>函数，然后执行登录请求，登录成功后，通过<code>viewer</code>回调到<code>View</code>层的<code>onLogin()</code>函数。</p>
<p>如此一来，<code>View</code>层中只负责UI部分的工作，UI所产生的各种事件绑定、派发等职责放在<code>Controller</code>中，<code>Presenter</code>和<code>Model</code>还是与之前一样的职责。</p>
<p>关于<code>Presenter</code>的测试，只需mock一个<code>LoginViewer</code>实现类即可。</p>
<h3 id="第四阶段："><a href="#第四阶段：" class="headerlink" title="第四阶段："></a>第四阶段：</h3><p>MVVM，把<code>Presenter</code>改成<code>ViewModel</code>，它与<code>View</code>之间的交互可以使用<code>Data Binding</code>的方式双向进行，也就是说<code>View</code>和<code>ViewModel</code>任意一方的改变都会体现在另一方中，Google IO上提供的框架暂时还不成熟，只支持单向，所以暂时还没有在正式的项目中使用。</p>
<p>实质上MV*的思想都是一样的，解耦隔离视图（View）和模型（Model），在实际的应用中不需要给<code>MVC</code>、<code>MVP</code>和<code>MVVM</code>一个明确的界限，甚至可以把几者融合在一起。</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> mvp </tag>
            
            <tag> framework </tag>
            
            <tag> mvc </tag>
            
            <tag> best practices </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]从Launcher开始启动App流程源码分析]]></title>
      <url>/2015/12/03/Android-%E4%BB%8ELauncher%E5%BC%80%E5%A7%8B%E5%90%AF%E5%8A%A8App%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<h2 id="从Launcher开始启动App流程源码分析"><a href="#从Launcher开始启动App流程源码分析" class="headerlink" title="从Launcher开始启动App流程源码分析"></a>从Launcher开始启动App流程源码分析</h2><p><code>com.android.launcher.Launcher</code>就是我们的Launcher页面了，可以看到Launcher其实也是一个<code>Activity</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Launcher</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span>, <span class="title">OnLongClickListener</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然是<code>Activity</code>，那当然也会有<code>onCreate</code>、<code>onResume</code>等生命周期了，按照逻辑，应该会去加载所有App，以网格的布局显示在页面上，果然，在<code>onResume</code>看到了这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume();</span><br><span class="line">    <span class="keyword">if</span> (mRestoring) &#123;</span><br><span class="line">        startLoaders();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看方法名就可以猜到这个方法就是用来加载所有App信息的，进入这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startLoaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">boolean</span> loadApplications = sModel.loadApplications(<span class="keyword">true</span>, <span class="keyword">this</span>, mLocaleChanged);</span><br><span class="line">	sModel.loadUserItems(!mLocaleChanged, <span class="keyword">this</span>, mLocaleChanged, loadApplications);</span><br><span class="line">	mRestoring = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用<code>sModel</code>（<code>LauncherModel</code>类型）的<code>loadUserItems</code>方法去加载数据了，<code>sModel</code>明显属于<code>Model</code>层，进入<code>loadUserItems</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadUserItems</span><span class="params">(<span class="keyword">boolean</span> isLaunching, Launcher launcher, <span class="keyword">boolean</span> localeChanged,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> loadApplications)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">		mDesktopItemsLoaded = <span class="keyword">false</span>;</span><br><span class="line">        mDesktopItemsLoader = <span class="keyword">new</span> DesktopItemsLoader(launcher, localeChanged, loadApplications,</span><br><span class="line">                isLaunching);</span><br><span class="line">        mDesktopLoaderThread = <span class="keyword">new</span> Thread(mDesktopItemsLoader, <span class="string">"Desktop Items Loader"</span>);</span><br><span class="line">        mDesktopLoaderThread.start();</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后使用<code>DesktopItemsLoader</code>在<code>mDesktopLoaderThread</code>线程中加载，：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">DesktopItemsLoader</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">final</span> Cursor c = contentResolver.query(LauncherSettings.Favorites.CONTENT_URI, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> idIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites._ID);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> intentIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.INTENT);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> titleIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.TITLE);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> iconTypeIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.ICON_TYPE);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> iconIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.ICON);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> iconPackageIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.ICON_PACKAGE);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> iconResourceIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.ICON_RESOURCE);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> containerIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.CONTAINER);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> itemTypeIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.ITEM_TYPE);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> appWidgetIdIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.APPWIDGET_ID);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> screenIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.SCREEN);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> cellXIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.CELLX);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> cellYIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.CELLY);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> spanXIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.SPANX);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> spanYIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.SPANY);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> uriIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.URI);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> displayModeIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.DISPLAY_MODE);</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="comment">// 通过launcher回调返回数据</span></span><br><span class="line">		launcher.onDesktopItemsLoaded(uiDesktopItems, uiDesktopWidgets);</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们回到<code>Launcher</code>的<code>onDesktopItemsLoaded</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onDesktopItemsLoaded</span><span class="params">(ArrayList&lt;ItemInfo&gt; shortcuts, ArrayList&lt;LauncherAppWidgetInfo&gt; appWidgets)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	bindDesktopItems(shortcuts, appWidgets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续进入<code>bindDesktopItems</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindDesktopItems</span><span class="params">(ArrayList&lt;ItemInfo&gt; shortcuts, ArrayList&lt;LauncherAppWidgetInfo&gt; appWidgets)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	mBinder = <span class="keyword">new</span> DesktopBinder(<span class="keyword">this</span>, shortcuts, appWidgets, drawerAdapter);</span><br><span class="line">    mBinder.startBindingItems();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入<code>startBindingItems</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startBindingItems</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	obtainMessage(MESSAGE_BIND_ITEMS, <span class="number">0</span>, mShortcuts.size()).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用了<code>Handler</code>发送消息，进入<code>Handler</code>的<code>handleMessage</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">case</span> MESSAGE_BIND_ITEMS: &#123;</span><br><span class="line">			launcher.bindItems(<span class="keyword">this</span>, mShortcuts, msg.arg1, msg.arg2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接收到消息之后调用<code>bindItems</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindItems</span><span class="params">(Launcher.DesktopBinder binder, ArrayList&lt;ItemInfo&gt; shortcuts, <span class="keyword">int</span> start, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPLICATION:</span><br><span class="line">	<span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_SHORTCUT:</span><br><span class="line">		<span class="keyword">final</span> View shortcut = createShortcut((ApplicationInfo) item);</span><br><span class="line">		workspace.addInScreen(shortcut, item.screen, item.cellX, item.cellY, <span class="number">1</span>, <span class="number">1</span>, !desktopLocked);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们只考虑app或者app快捷方式的情况，文件夹和widgets暂时不考虑。app或者app快捷方式实质上都是进入了这个逻辑中，调用<code>createShortcut</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重载方法，最终都会调用这个方法</span></span><br><span class="line"><span class="function">View <span class="title">createShortcut</span><span class="params">(<span class="keyword">int</span> layoutResId, ViewGroup parent, ApplicationInfo info)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	TextView favorite = (TextView) mInflater.inflate(layoutResId, parent, <span class="keyword">false</span>);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	favorite.setCompoundDrawablesWithIntrinsicBounds(<span class="keyword">null</span>, info.icon, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">	favorite.setText(info.title);</span><br><span class="line">	favorite.setTag(info);</span><br><span class="line">	favorite.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先inflater出item的布局，然后设置<code>text</code>和<code>OnClickListener</code>，还有tag，这个tag是<code>ApplicationInfo</code>，里面包含了各种App信息，是从App的<code>AndroidManifest.xml</code>的<code>&lt;application&gt;</code>标签中解析出来的。既然设置了点击事件，显然，点击后应该会打开对应的App才对。所以继续看<code>onClick</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">    Object tag = v.getTag();</span><br><span class="line">    <span class="keyword">if</span> (tag <span class="keyword">instanceof</span> ApplicationInfo) &#123;</span><br><span class="line">        <span class="comment">// Open shortcut</span></span><br><span class="line">        <span class="keyword">final</span> Intent intent = ((ApplicationInfo) tag).intent;</span><br><span class="line">        startActivitySafely(intent);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag <span class="keyword">instanceof</span> FolderInfo) &#123;</span><br><span class="line">        handleFolderClick((FolderInfo) tag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击App就会通过<code>startActivitySafely</code>方法使用刚才设置的tag，也就是<code>ApplicationInfo</code>中的intent进行跳转：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startActivitySafely</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">	intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	startActivity(intent);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们来看看打开某个app的时候整个流程是怎么走的。接着上面的的<code>startActivity()</code>方法走：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">		startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，不管你是调用了<code>startActivity</code>还是<code>startActivityForResult</code>方法，<code>startActivityForResult</code>方法，并且如果是调用的<code>startActivity</code>，则默认<code>requestCode</code>就是-1，所以如果你想调用<code>startActivityForResult</code>的时候，注意不能把<code>requestCode</code>设置为-1，否则它的效果就跟<code>startActivity</code>一样了，不会再回调<code>onActivityResult</code>！，再看看<code>startActivityForResult</code>的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">	Instrumentation.ActivityResult ar = mInstrumentation.execStartActivity(</span><br><span class="line">            <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">            intent, requestCode, options);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，Activity内部是使用<code>mInstrumentation</code>（<code>Instrumentation</code>类型）执行<code>execStartActivity</code>方法来实现<code>Activity</code>跳转的，执行完毕后会返回一个<code>Instrumentation.ActivityResult</code>。</p>
<p>然后查看<code>Instrumentation::execStartActivity</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	// ...</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span></span></span><br><span class="line"><span class="function">        .<span class="title">startActivity</span><span class="params">(whoThread, who.getBasePackageName()</span>, intent,</span></span><br><span class="line"><span class="function">                intent.<span class="title">resolveTypeIfNeeded</span><span class="params">(who.getContentResolver()</span>),</span></span><br><span class="line"><span class="function">                token, target !</span>= <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过<code>ActivityManagerNative.getDefault()</code>获得一个<code>IActivityManager</code>的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> gDefault.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 通过Binder IPC获取ActivityManager（IBinder）</span></span><br><span class="line">        IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        IActivityManager am = asInterface(b);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> am;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    IActivityManager in =</span><br><span class="line">        (IActivityManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">    <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先通过Binder IPC的方式从服务端获取一个<code>Activity Manager</code>，然后通过<code>ActivityManagernative</code>封装成一个代理<code>ActivityManagerProxy</code>对象，然后调用<code>startActivity</code>也是使用了Binder IPC进行与服务器端的通信，（整个Android系统的通信机制使用了大量的Binder IPC，这个以后再专门讨论这个吧），接着，我们进入到了<code>com.android.server.am.ActivityManagerService</code>的<code>startActivity</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo, resultWho, requestCode, startFlags, profilerInfo, options, UserHandle.getCallingUserId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来的调用链：</p>
<p>-&gt; <code>startActivityAsUser</code><br>-&gt; <code>startActivityMayWait</code><br>-&gt; <code>startActivityLocked</code><br>-&gt; <code>startActivityUncheckedLocked</code><br>-&gt; <code>targetStack.startActivityLocked(r, newTask, doResume, keepCurTransition, options)</code><br>-&gt; <code>mStackSupervisor.resumeTopActivitiesLocked(this, r, options)</code><br>-&gt; <code>resumeTopActivityInnerLocked(prev, options);</code><br>-&gt; <code>mStackSupervisor.startSpecificActivityLocked(next, true, true)</code></p>
<p><code>startSpecificActivityLocked</code>方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">    ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">            r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>, <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先从<code>mService</code>找出对应需要启动Activity的进程（通过进程名字和uid，进程名字可以在<code>AndroidManifest.xml</code>中配置）如果可以获取到，说明这个Activity所属的进程已经存在了，也就是说app已经在运行了，那就会调用<code>realStartActivityLocked</code>，否则，如果该Activity所在的App是第一次启动，则会调用<code>mService.startProcessLocked</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(<span class="comment">/*...*/</span>)</span></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	startProcessLocked(app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName, ApplicationInfo info, <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags, String hostingType, ComponentName hostingName, <span class="keyword">boolean</span> allowWhileBooting, <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid, <span class="keyword">boolean</span> keepIfLarge, String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	app = getProcessRecordLocked(processName, info.uid, keepIfLarge);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">		app = newProcessRecordLocked(info, processName, isolated, isolatedUid);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, String hostingType, String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// entryPoint表示一个类，它用来作为新创建的进程的主入口，会调用这个类的静态main方法，这个参数在startProcessLocked方法中会被检查重置，如果是null的话，就默认是android.app.ActivityThread。</span></span><br><span class="line">	<span class="keyword">if</span> (entryPoint == <span class="keyword">null</span>) entryPoint = <span class="string">"android.app.ActivityThread"</span>;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	Process.ProcessStartResult startResult = Process.start(entryPoint,</span><br><span class="line">            app.processName, uid, uid, gids, debugFlags, mountExternal,</span><br><span class="line">            app.info.targetSdkVersion, app.info.seinfo, requiredAbi, </span><br><span class="line">            instructionSet, app.info.dataDir, entryPointArgs);</span><br><span class="line">	<span class="comment">// ...	</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这3个重载方法做的事情就是，先根据进程名字调用<code>getProcessRecordLocked()</code>获取<code>ProcessRecord</code>，如果<code>ProcessRecord</code>不存在，则调用<code>newProcessRecordLocked()</code>方法建立一个<code>ProcessRecord</code>，并且新的<code>ProcessRecord</code>绑定了<code>ApplicationInfo</code>，<code>uid</code>等信息，但后进入第三个重载方法，执行新建、启动进程。</p>
<p>再看<code>Process::start</code>的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ProcessStartResult <span class="title">start</span><span class="params">(<span class="comment">/*...*/</span>)</span></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids,</span><br><span class="line">              debugFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class="line">              abi, instructionSet, appDataDir, zygoteArgs);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就是通过<code>Zygote</code>进程<code>fork</code>一个新的进程作为app的进程。这里要需要讲的一个参数是<code>processClass</code>，这个参数表示一个类，它用来作为新创建的进程的主入口，会调用这个类的静态<code>main</code>方法，这个参数在<code>startProcessLocked</code>方法中会被检查重置，如果是null的话，就默认是<code>android.app.ActivityThread</code>。</p>
<p>现在App的进程也创建成功了，就会进入<code>android.app.ActivityThread</code>的静态的<code>main</code>中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// 初始化主线程Looper</span></span><br><span class="line">	Looper.prepareMainLooper();</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>);	</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// 启动消息循环</span></span><br><span class="line">	Looper.loop()</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后创建了一个<code>ActivityThread</code>，说明每当一个新的app进程被创建，都会对应一个新的<code>ActivityThread</code>实例，然后调用它的<code>attach</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (!system) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">final</span> IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		mgr.attachApplication(mAppThread);</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再次通过Binder IPC调用<code>ActivityManagerProxy</code>的<code>attachApplication</code>，传入的<code>ApplicationThread</code>（Binder）参数用于在服务端进行回调通信。最后进入<code>ActivityManagerService::attachApplication</code>，再调用<code>attachApplicationLocked(thread, callingPid)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread, <span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	app = mPidsSelfLocked.get(pid);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	app.makeActive(thread, mProcessStats);</span><br><span class="line">    app.curAdj = app.setAdj= -<span class="number">100</span>;</span><br><span class="line">    app.curSchedGroup = app.setSchedGroup = Process.THREAD_GROUP_DEFAULT;</span><br><span class="line">    app.forcingToForeground = <span class="keyword">null</span>;</span><br><span class="line">    updateProcessForegroundLocked(app, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    app.hasShownUi = <span class="keyword">false</span>;</span><br><span class="line">    app.debugging = <span class="keyword">false</span>;</span><br><span class="line">    app.cached = <span class="keyword">false</span>;</span><br><span class="line">    app.killedByAm = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	thread.bindApplication(processName, appInfo, providers, app.instrumentationClass, profilerInfo, app.instrumentationArguments, app.instrumentationWatcher, app.instrumentationUiAutomationConnection, testMode, enableOpenGlTrace, enableTrackAllocation, isRestrictedBackupMode || !normalMode, app.persistent, <span class="keyword">new</span> Configuration(mConfiguration), app.compat, getCommonServicesLocked(app.isolated), mCoreSettingsObserver.getCoreSettingsLocked());</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (normalMode) &#123;</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">	        <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</span><br><span class="line">	            didSomething = <span class="keyword">true</span>;</span><br><span class="line">	        &#125;</span><br><span class="line">	    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">	        Slog.wtf(TAG, <span class="string">"Exception thrown launching activities in "</span> + app, e);</span><br><span class="line">	        badApp = <span class="keyword">true</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，通过pid获取刚刚创建的进程，然后对app进行一些初始化工作，然后调用<code>bindApplication</code>远程调用客户端<code>ActivityThread::bindApplication</code>，再通过<code>Handler</code>调用到<code>ActivityThread::handleBindApplication</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindApplication</span><span class="params">(AppBindData data)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">final</span> ContextImpl appContext = ContextImpl.createAppContext(<span class="keyword">this</span>, data.info);</span><br><span class="line">	<span class="keyword">if</span> (data.instrumentationName != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		mInstrumentationPackageName = ii.packageName;</span><br><span class="line">        mInstrumentationAppDir = ii.sourceDir;</span><br><span class="line">        mInstrumentationSplitAppDirs = ii.splitSourceDirs;</span><br><span class="line">        mInstrumentationLibDir = ii.nativeLibraryDir;</span><br><span class="line">        mInstrumentedAppDir = data.info.getAppDir();</span><br><span class="line">        mInstrumentedSplitAppDirs = data.info.getSplitAppDirs();</span><br><span class="line">        mInstrumentedLibDir = data.info.getLibDir();</span><br><span class="line"></span><br><span class="line">        ApplicationInfo instrApp = <span class="keyword">new</span> ApplicationInfo();</span><br><span class="line">        instrApp.packageName = ii.packageName;</span><br><span class="line">        instrApp.sourceDir = ii.sourceDir;</span><br><span class="line">        instrApp.publicSourceDir = ii.publicSourceDir;</span><br><span class="line">        instrApp.splitSourceDirs = ii.splitSourceDirs;</span><br><span class="line">        instrApp.splitPublicSourceDirs = ii.splitPublicSourceDirs;</span><br><span class="line">        instrApp.dataDir = ii.dataDir;</span><br><span class="line">        instrApp.nativeLibraryDir = ii.nativeLibraryDir;</span><br><span class="line">        LoadedApk pi = getPackageInfo(instrApp, data.compatInfo,</span><br><span class="line">                appContext.getClassLoader(), <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        ContextImpl instrContext = ContextImpl.createAppContext(<span class="keyword">this</span>, pi);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">java.lang.ClassLoader cl = instrContext.getClassLoader();</span><br><span class="line">        mInstrumentation = (Instrumentation) cl.loadClass(data.instrumentationName.getClassName()).newInstance();</span><br><span class="line">        mInstrumentation.init(<span class="keyword">this</span>, instrContext, appContext, <span class="keyword">new</span> ComponentName(ii.packageName, ii.name), data.instrumentationWatcher, data.instrumentationUiAutomationConnection);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	Application app = data.info.makeApplication(data.restrictedBackupMode, <span class="keyword">null</span>);</span><br><span class="line">    mInitialApplication = app;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，创建一个当前App的<code>Context</code>，然后如果<code>data.instrumentationName != null</code>，则初始化<code>Instrumentation</code>相关的变量，并创建<code>Instrumentation</code>的<code>ApplicationInfo</code>等对象来创建<code>Instrumentation</code>的<code>Context</code>，然后创建<code>Instrumentation</code>对象，并调用它的<code>init</code>方法进行初始化。如果<code>data.instrumentationName == null</code>，则new一个<code>Instrumentation</code>（在一个进程中只会有一个<code>Instrumentation</code>实例）然后创建<code>Application</code>对象，并调用它的<code>onCreate</code>方法，这样<code>Application</code>就会被回调了。</p>
<p>然后我们回到<code>ActivityManagerService::attachApplicationLocked</code>方法，远程执行完<code>thread.bindApplication</code>方法之后，接下来会调用<code>mStackSupervisor.attachApplicationLocked(app)</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	ActivityRecord hr = stack.topRunningActivityLocked(<span class="keyword">null</span>);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	realStartActivityLocked(hr, app, <span class="keyword">true</span>, <span class="keyword">true</span>)</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先通过<code>topRunningActivityLocked</code>从堆栈顶端获取要启动的Activity，然后<code>realStartActivityLocked(hr, app, true, true)</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">            ProcessRecord app, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken, System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration), <span class="keyword">new</span> Configuration(stack.mOverrideConfig), r.compat, r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results, newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续通过Binder IPC远程调用<code>scheduleLaunchActivity</code>方法，然后进入<code>ActivityThread</code>的<code>scheduleLaunchActivity</code>方法中，然后通过<code>Handler</code>进入<code>handleLaunchActivity</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">	handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward, !r.activity.mFinished &amp;&amp; !r.startsNotResumed);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先调用<code>performLaunchActivity</code>方法返回一个<code>Activity</code>，然后调用<code>handleResumeActivity</code>方法让该<code>Activity</code>进入<code>onResume</code>状态。所以很显然在<code>performLaunchActivity</code>中肯定是生成了<code>Activity</code>实例，并调用了<code>onCreate</code>方法了，来看下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">	<span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">	            Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">    activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token, r.ident, app, r.intent, r.activityInfo, title, r.parent, r.embeddedID, r.lastNonConfigurationInstances, config, r.referrer, r.voiceInteractor);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">     mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state, r.persistentState);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	mInstrumentation.callActivityOnPostCreate(activity, r.state, r.persistentState);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，初始化<code>LoadedApk</code>，然后通过<code>Instrumentation</code>来创建一个<code>Activity</code>实例，通过<code>createBaseContextForActivity</code>方法创建一个<code>Activity Context</code>，调用<code>activity</code>的<code>attach</code>方法，然后依次触发该<code>Activity</code>的<code>onCreate</code>、<code>onRestoreInstanceState</code>、<code>onPostCreate</code>等生命周期方法。</p>
<p><code>createBaseContextForActivity</code>方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Context <span class="title">createBaseContextForActivity</span><span class="params">(ActivityClientRecord r, <span class="keyword">final</span> Activity activity)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	ContextImpl appContext = ContextImpl.createActivityContext(<span class="keyword">this</span>, r.packageInfo, displayId, r.overrideConfig);</span><br><span class="line">    appContext.setOuterContext(activity);</span><br><span class="line">    Context baseContext = appContext;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>ContextImpl::createActivityContext</code>创建的<code>Context</code>对象，可以发现，不论是<code>System Context/App Context/Activity Context</code>，这些<code>Context</code>都是通过<code>ContextImpl</code>生成的，具体这里再挖个坑先。</p>
<p>再继续进入<code>Activity::attach</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">            Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration config, String referrer, IVoiceInteractor voiceInteractor)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	mMainThread = aThread;</span><br><span class="line">    mInstrumentation = instr;</span><br><span class="line">    mToken = token;</span><br><span class="line">    mIdent = ident;</span><br><span class="line">    mApplication = application;</span><br><span class="line">    mIntent = intent;</span><br><span class="line">    mReferrer = referrer;</span><br><span class="line">    mComponent = intent.getComponent();</span><br><span class="line">    mActivityInfo = info;</span><br><span class="line">    mTitle = title;</span><br><span class="line">    mParent = parent;</span><br><span class="line">    mEmbeddedID = id;</span><br><span class="line">    mLastNonConfigurationInstances = lastNonConfigurationInstances;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面对<code>Activity</code>与<code>ActivityThread</code>、<code>Instrumentation</code>等进行了绑定，所以说每个<code>Activity</code>都含有一个<code>ActivityThread</code>引用和一个<code>Instrumentation</code>引用，而<code>ActivityThread</code>实例和<code>Instrumentation</code>实例在一个进程中都只有一个实例，因为<code>ActivityThread</code>是在进程被创建成功后，进入<code>ActivityThread</code>的<code>static main()</code>时才会被创建，而<code>Instrumentation</code>则是在<code>ActivityThread</code>被创建后进行<code>attach</code>的之后被创建。</p>
<h3 id="启动应用流程所有方法链调用总结："><a href="#启动应用流程所有方法链调用总结：" class="headerlink" title="启动应用流程所有方法链调用总结："></a>启动应用流程所有方法链调用总结：</h3><ul>
<li><p><code>Activity::startActivity</code></p>
</li>
<li><p><code>Activity::startActivityForResult</code></p>
</li>
<li><p><code>Instrumentation::execStartActivity</code>：<br>携带参数：<br>1. <code>who</code>：from的Context<br>2. <code>contextThread</code>：from的<code>ActivityThread</code>的<code>ApplicationThread</code>，<code>ApplicationThread</code>中可以通过Binder IPC提供给服务端回调<code>Activity</code>生命周期等操作（from的主线程）。<br>3. <code>mToken</code>：<code>Binder</code>类型，用来标识from的Activity，可能为null。<br>4. <code>target</code>：from的Activity（所以是用来接收跳转结果的），如果不是从Activity跳转则为null。<br>5. <code>intent</code>：跳转Intent。<br>6. <code>requestCode</code>：如果是<code>startActivity</code>，则为-1。<br>7. <code>options</code>：额外Bundle数据。</p>
</li>
<li><p><code>ActivityManagerProxy::startActivity()</code>：<br>携带参数：<br>1. <code>caller</code>：上面的<code>contextThread</code>，from主线程。<br>2. <code>callingPackage</code>：from的Context包名。<br>3. <code>intent</code>：跳转Intent。<br>4. <code>resolvedType</code>：跳转Intent的MIME类型。<br>5. <code>resultTo</code>：上面的<code>token</code>，<code>Binder</code>类型，用来标识from的Activity。<br>6. <code>resultWho</code>：from的Activity的mEmbeddedID（唯一标示字符串）<br>7. <code>requestCode</code>：如果是<code>startActivity</code>，则为-1。<br>8. <code>startFlags</code>：默认传入为0。<br>9. <code>profilerInfo</code>：默认传入为null。<br>10. <code>options</code>：额外Bundle数据。</p>
</li>
<li><p><code>ActivityManagerService::startActivity()</code>（通过Binder IPC调用）：<br>携带参数跟上面一样。</p>
</li>
<li><p><code>ActivityManagerService::startActivityAsUser</code><br>携带参数包括<code>ActivityManagerService::startActivity()</code>所有的参数，最再加一个：<br>1. <code>userId</code>：userId，根据给当前进程分配的Linux UID（这个UID可以用来让上层系统服务进行身份识别和权限检查）得到一个userId（如果不是多用户，则直接返回0）。</p>
</li>
<li><p><code>ActivityStackSupervisor::startActivityMayWait()</code><br>参数：<br>1. <code>caller</code>：上面的<code>caller/contextThread</code>，from主线程。<br>2. <code>callingUid</code>：调用用户uid。<br>3. <code>callingPackage</code>：from的Context包名。<br>4. <code>intent</code>：跳转Intent。<br>5. <code>resolvedType</code>：跳转Intent的MIME类型。<br>6. <code>voiceSession</code>：传null。<br>7. <code>voiceInteractor</code>：传null。<br>8. <code>resultTo</code>：上面的<code>resultTo/token</code>，<code>Binder</code>类型，用来标识from的Activity。<br>9. <code>resultWho</code>：from的Activity的mEmbeddedID（唯一标示字符串）<br>10. <code>requestCode</code>：如果是<code>startActivity</code>，则为-1。<br>11. <code>startFlags</code>：传null。<br>12. <code>profilerInfo</code>：传null。<br>13. <code>outResult</code>：传null。<br>14. <code>config</code>：传null。<br>15. <code>options</code>：额外数据。<br>16. <code>ignoreTargetSecurity</code>：false。<br>17. <code>userId</code>：上面的<code>userId</code>，根据给当前进程分配的Linux UID（这个UID可以用来让上层系统服务进行身份识别和权限检查）得到一个userId（如果不是多用户，则直接返回0）。<br>18. <code>iContainer</code>：传null。<br>19. <code>inTask</code>：null。</p>
</li>
<li><p><code>ActivityStackSupervisor::startActivityLocked()</code>：<br>参数：<br>1. <code>caller</code>：上面的<code>caller/contextThread</code>，from主线程。<br>2. <code>intent</code>：跳转Intent。<br>3. <code>resolvedType</code>：跳转Intent的MIME类型。<br>4. <code>aInfo</code>：<code>ActivityInfo</code>类型，解析from的Activity的Intent信息。<br>5. <code>voiceSession</code>：传null。<br>6. <code>voiceInteractor</code>：传null。<br>7. <code>resultTo</code>：上面的<code>resultTo/token</code>，<code>Binder</code>类型，用来标识from的Activity。<br>8. <code>resultWho</code>：from的Activity的mEmbeddedID（唯一标示字符串）<br>9. <code>requestCode</code>：如果是<code>startActivity</code>，则为-1。<br>10. <code>callingPackage</code>：from的Context包名。<br>11. <code>startFlags</code>：传null。<br>12. <code>options</code>：额外数据。<br>13. <code>ignoreTargetSecurity</code>：false。<br>14. <code>componentSpecified</code>：是否显示指定了<code>component</code>。<br>15. <code>outActivity</code>：传null。<br>16. <code>container</code>：上面的<code>iContainer</code>，转型成了<code>ActivityContainer</code>，还是null。<br>17. <code>inTask</code>：null。<br>在这个方法中，通过<code>ProcessRecord callerApp = mService.getRecordForAppLocked(caller);</code>获取到之前创建的<code>ProcessRecord</code>，然后从<code>Activity</code>栈中根据<code>resultTo/token</code>获取到对应from Activity的<code>ActivityRecord</code>（sourceRecord），然后<strong>创建将要跳转的Activity的ActivityRecord对象</strong>（<code>Token</code>也是在这个时候生成的）。</p>
</li>
<li><p><code>ActivityStackSupervisor::startActivityUncheckedLocked()</code>：<br>参数：<br>1. <code>r</code>：<code>ActivityRecord</code>类型，就是<code>ActivityStackSupervisor::startActivityLocked()</code>中创建的将要跳转的Activity的ActivityRecord对象。<br>2. <code>sourceRecord</code>：就是<code>ActivityStackSupervisor::startActivityLocked()</code>方法获取的from Activity的<code>sourceRecord</code>。<br>3. <code>voiceSession</code>：传null。<br>4. <code>voiceInteractor</code>：传null。<br>5. <code>startFlags</code>：传null。<br>6. <code>doResume</code>：传true。<br>7. <code>options</code>：额外数据。<br>8. <code>inTask</code>：null。<br>这个方法中有大量的代码来处理<code>task/stack</code>等方面的逻辑，以后再仔细深入这个方法。</p>
</li>
<li><p><code>ActivityStrack::startActivityLocked()</code>：<br>方法调用者：<code>ActivityStack</code>类型，<br><code>targetStack</code>：在<code>ActivityStackSupervisor::startActivityUncheckedLocked()</code>中确定的需要添加到的<code>ActivityStack</code>。<br>参数：<br>1. <code>r</code>：<code>ActivityRecord</code>类型，就是<code>ActivityStackSupervisor::startActivityLocked()</code>中创建的跳转的Activity的ActivityRecord对象。<br>2. <code>newTask</code>：是否<code>Intent</code>是否设置了<code>Intent.FLAG_ACTIVITY_NEW_TASK</code>。<br>3. <code>doResume</code>：传true。<br>4. <code>keepCurTransition</code>：这个具体后面再研究，跟<code>Intent</code>的flag有关。<br>5. <code>options</code>：额外数据。<br>同样，这个方法中有大量的代码来处理<code>task/stack</code>等方面的逻辑，以后再仔细深入这个方法<strong>（执行完这个方法后，<code>ActivityRecord</code>就会被真正加入到<code>ActivityStack</code>中）</strong>。</p>
</li>
<li><p><code>ActivityStackSupervisor::resumeTopActivitiesLocked()</code>：<br>参数：<br>1. <code>targetStack</code>：在<code>ActivityStackSupervisor::startActivityUncheckedLocked()</code>中确定的需要添加到的<code>ActivityStack</code>。<br>2. <code>target</code>：<code>ActivityRecord</code>类型，就是<code>ActivityStackSupervisor::startActivityLocked()</code>中创建的跳转的Activity的ActivityRecord对象。<br>3. <code>targetOptions</code>：额外数据。</p>
</li>
<li><p><code>ActivityStack::resumeTopActivityLocked()</code>：<br>参数：<br>1. <code>prev</code>：<code>ActivityRecord</code>类型，就是<code>ActivityStackSupervisor::startActivityLocked()</code>中创建的跳转的Activity的ActivityRecord对象。<br>2. <code>options</code>：额外数据。</p>
</li>
<li><p><code>ActivityStack::resumeTopActivityInnerLocked()</code>：<br>参数：<br>1. <code>prev</code>：<code>ActivityRecord</code>类型，就是<code>ActivityStackSupervisor::startActivityLocked()</code>中创建的跳转的Activity的ActivityRecord对象。<br>2. <code>options</code>：额外数据。</p>
</li>
<li><p><code>ActivityStackSupervisor::startSpecificActivityLocked()</code>：<br>参数：<br>1. <code>r</code>：最顶部没有处于finishing的Activity，就是刚刚在<code>startActivityLocked</code>中加入的将要跳转的<code>ActivityRecord</code>，通过<code>topRunningActivityLocked(null)</code>查找<br>2. <code>andResume</code>：传true<br>3. <code>checkConfig</code>：传true</p>
</li>
<li><p><code>ActivityManagerService::startProcessLocked()</code>：<br>参数：<br>1. <code>processName</code>：创建进程的名称，就是<code>ActivityStack::startSpecificActivityLocked()</code>中的<code>r.processName</code><br>2. <code>info</code>：<code>ApplicationInfo</code>，也是<code>r.info.applicaitonInfo</code>，具体可以查看<code>ActivityStackSupervisor::startActivityLocked()</code>中创建<code>ActivityRecord</code>的代码。<br>3. <code>knownToBeDead</code>：传true。<br>4. <code>intentFlags</code>：传0。<br>5. <code>hostingType</code>：传字符串“activity”。<br>6. <code>hostingName</code>：<code>ComponentName</code>类型，<code>intent</code>中的<code>Componentname</code><br>7. <code>allowWhileBooting</code>：传false。<br>8. <code>isolated</code>：传false<br>9. <code>keepIfLarge</code>传true</p>
</li>
<li><p><code>ActivityManagerService::startProcessLocked()</code>（重载方法）：<br>参数包含上面所有，多了以下几个：<br>1. <code>isolatedUid</code>：传0<br>2. <code>abiOverride</code>：传null<br>3. <code>entryPoint</code>：传null<br>4. <code>entryPointArgs</code>传null<br>5. <code>crashHandler</code>传null<br>注意：在这个方法中，会创建新进程的<code>ProcessRecord</code>对象，并绑定<code>ApplicationInfo</code>等信息，这样，启动进程后进行<code>bindApplicaiton</code>的时候就可以根据进程PID获取到所有的<code>ApplicationInfo</code>信息了。</p>
</li>
<li><p><code>ActivityManagerService::startProcessLocked()</code>（重载方法）：<br>参数：<br>1. <code>app</code>：<code>ProcessRecord</code>类型，创建的进程。<br>2. <code>hostingType</code>：传字符串“activity”。<br>3. <code>hostingNameStr</code>：通过<code>hostingName</code>生成的字符串（包名 + “/“ + 类的简单类名）<br>4. <code>abiOverride</code>：传null<br>5. <code>entryPoint</code>：传null<br>6. <code>entryPointArgs</code>传null</p>
</li>
<li><p><code>Process.start()</code><br>参数（省略部分参数）：<br>1. <code>processClass</code>：上面的<code>entryPoint</code>，但是并不是null了，而是<code>android.app.ActivityThread</code>，因为在<code>ActivityManagerService::startProcessLocked()</code>中被设置默认值了，它表示一个类，用来作为新创建的进程的主入口，会调用这个类的静态main方法。所以启动完这个进程就会进入<code>ActivityThread</code>的<code>static main()</code>方法。<br>2. <code>zygoteArgs</code>：fork zygote进程时的参数。</p>
</li>
<li><p><code>ActivityThread::main()</code></p>
</li>
<li><p><code>ActivityThread::attach()</code></p>
</li>
<li><p><code>ActivityManagerProxy::attachApplication()</code>：<br>参数：<br>1. <code>mAppThread</code>：<code>ApplicationThread()</code>类型，Binder，用来提供给AMS调用。</p>
</li>
<li><p><code>ActivityManagerService::attachApplication()</code>：<br>参数：<br>1. <code>mAppThread</code>：<code>ApplicationThread()</code>类型，Binder，用来提供给AMS调用。</p>
</li>
<li><p><code>ActivityManagerService::attachApplicationLocked()</code>：<br>参数：<br>1. <code>thread</code>：<code>ApplicationThread()</code>类型，Binder，用来提供给AMS调用。上面的<code>mAppThread</code>。<br>2. <code>pid</code>：当前调用的进程PID。</p>
</li>
<li><p><code>IApplicationThread::bindApplication()</code>：<br>方法调用调用者：上面的<code>thread/mAppThread</code>，Binder，用来提供给AMS调用。<br>参数（省略部分参数）：<br>1. <code>packageName</code>：用的进程名字<code>processName</code><br>2. <code>info</code>：<code>ApplicationInfo</code>类型，从<code>ProcessRecord</code>中的<code>instrumentationInfo或者info</code>，这个<code>ApplicationInfo</code>是在建立<code>ProcessRecord</code>时就保存了。</p>
</li>
<li><p><code>ActivityThread::bindApplication()</code>：<br>参数：同上</p>
</li>
<li><p><code>ActivityThread::handleBindApplication()</code>：<br>通过Handler调用。<br>参数：<br>1. <code>data</code>：<code>AppBindData</code>类型，里面包含的类型<code>processName</code>，<code>providers</code>，<code>instrumentationName</code>，<code>instrumentationArgs</code>，<code>instrumentationWatcher</code>，<code>instrumentationUiAutomationConnection</code>，<code>config</code>等数据。</p>
</li>
<li><p><code>ActivityManagerService</code>中的<code>ActivityThread::bindApplication()</code>执行完毕之后</p>
</li>
<li><p><code>ActivityStackSupervisor::attachApplicationLocked()</code>：<br>参数：<br>1. <code>app</code>：新建的进程绑定的<code>ProcessRecord</code>。</p>
</li>
<li><p><code>ActivityStackSupervisor::realStartActivityLocked()</code>：<br>参数：<br>1. <code>r</code>：<code>ActivityRecord</code>类型，topRunningActivityLocked从堆栈顶端获取要启动的Activity。<br>2. <code>app</code>：新建的进程绑定的<code>ProcessRecord</code>。<br>3. <code>andResume</code>：传入true<br>4. <code>checkConfig</code>：传入true</p>
</li>
<li><p><code>IApplicationThread::scheduleLaunchActivity()</code>：<br>参数（部分）：<br>1. <code>intent</code>：将要启动的<code>ActivityRecord</code>中的<code>intent</code>。<br>2. <code>token</code>：将要启动的<code>ActivityRecord</code>中的<code>token</code>。<br>3. <code>info</code>：将要启动的<code>ActivityRecord</code>中的<code>ApplicationInfo</code>。</p>
</li>
<li><p><code>ActivityThread::scheduleLaunchActivity()</code>：<br>Binder IPC调用，参数与<code>IApplicationThread::scheduleLaunchActivity()</code>相同。</p>
</li>
<li><p><code>ActivityThread::handleLaunchActivity()</code>：<br>该方法通过Handler调用，参数同上。<br>1. <code>r</code>：<code>ActivityClientRecord</code>类型，在<code>ActivityThread::scheduleLaunchActivity()</code>中封装，包括的数据有<code>token</code>, <code>ident</code>, <code>intent</code>, <code>activityInfo</code>等等，但是<code>LoadedApk</code>是这时根据包名从<code>ActivityThread</code>中弱引用缓存中获取的的。<br>2. <code>customIntent</code>：null</p>
</li>
<li><p><code>ActivityThread::performLaunchActivity()</code>：<br>参数与<code>ActivityThread::handleLaunchActivity()</code>相同。</p>
</li>
<li><p><code>Activity::attach()</code>：<br>参数（部分）：<br>1. <code>context</code>：<code>ActivityThread::performLaunchActivity()</code>中创建的<code>Activity Context</code>。<br>2. <code>aThread</code>：<code>ActivityThread</code>类型，主线程，一个进程都共用一个。<br>3. <code>token</code>：构建<code>ActivityRecord</code>时生成的<code>token</code>。<br>4. <code>application</code>：<code>Application</code>第一次的时候创建一遍。<br>5. <code>intent</code>：将要启动的ActivityRecord中的intent。<br>6. <code>info</code>：<code>ActivityInfo</code>类型，将要启动的ActivityRecord中的<code>ActivityInfo</code>。</p>
</li>
<li><p><code>Instrumentation::callActivityOnCreate()</code>：<br>参数（部分）：<br>1. <code>activity</code>：<code>ActivityThread::performLaunchActivity()</code>中创建的<code>Activity</code>。</p>
</li>
<li><p><code>Activity::performCreate()</code></p>
</li>
<li><p><code>Activity::onCreate()</code></p>
</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> launcher </tag>
            
            <tag> source code </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]Android系统启动流程源码分析]]></title>
      <url>/2015/12/02/Android-Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<h3 id="Android系统启动流程源码分析"><a href="#Android系统启动流程源码分析" class="headerlink" title="Android系统启动流程源码分析"></a>Android系统启动流程源码分析</h3><p>首先我们知道，<code>Android</code>是基于<code>Linux</code>的，当<code>Linux</code>内核加载完成时就会自动启动一个<code>init</code>的进程。<br>又因为我们每当我们启动一个App时，就会生成一个新的<code>dalvik</code>实例，并处于一个新的进程（当然一个App也可能是多进程的）。<br>当我们打开第一个App的时候，就会通过<code>init</code>进程fork出一个<code>zygote</code>进程。之后打开新的App的时候都会<code>fork</code>之前的<code>zygote</code>进程。</p>
<p>当<code>fork</code>一个<code>zygote</code>进程时，会进入<code>com.android.internal.os.ZygoteInit</code>的<code>main</code>方法进行初始化操作：</p>
<ul>
<li><p>预加载资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">preloadClasses();</span><br><span class="line">preloadResources();</span><br><span class="line">preloadOpenGL();</span><br><span class="line">preloadSharedLibraries();</span><br><span class="line">preloadTextResources();</span><br><span class="line"><span class="comment">// Ask the WebViewFactory to do any initialization that must run in the zygote process,</span></span><br><span class="line"><span class="comment">// for memory sharing purposes.</span></span><br><span class="line">WebViewFactory.prepareWebViewInZygote();</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>从第一个<code>zygote</code>进程<code>fork</code>出<code>SystemServer</code>进程，这个进程提供各种<code>ManagerService</code>。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">startSystemServer(abiList, socketName);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">(String abiList, String socketName)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> MethodAndArgsCaller, RuntimeException </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> pid;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	String args[] = &#123;</span><br><span class="line">            <span class="string">"--setuid=1000"</span>,</span><br><span class="line">            <span class="string">"--setgid=1000"</span>,</span><br><span class="line">            <span class="string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007"</span>,</span><br><span class="line">            <span class="string">"--capabilities="</span> + capabilities + <span class="string">","</span> + capabilities,</span><br><span class="line">            <span class="string">"--nice-name=system_server"</span>,</span><br><span class="line">            <span class="string">"--runtime-args"</span>,</span><br><span class="line">            <span class="string">"com.android.server.SystemServer"</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">    <span class="comment">/* Request to fork the system server process */</span></span><br><span class="line">    pid = Zygote.forkSystemServer(</span><br><span class="line">            parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">            parsedArgs.gids,</span><br><span class="line">            parsedArgs.debugFlags,</span><br><span class="line">            <span class="keyword">null</span>,</span><br><span class="line">            parsedArgs.permittedCapabilities,</span><br><span class="line">            parsedArgs.effectiveCapabilities);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Fork完<code>SystemServer</code>进程之后，继续接下来在<code>handleSystemServerProcess</code>方法中传入参数到<code>SystemServer</code>：</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>注意，这里传入的参数是fork<code>SystemServer</code>进程后剩下的参数（<code>parsedArgs.remainingArgs</code>），其实只剩下了<code>com.android.server.SystemServer</code>这个参数了。</p>
<p>接下来继续调用<code>applicationInit</code> ，传入参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">applicationInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> Arguments args;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	args = <span class="keyword">new</span> Arguments(argv);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析成<code>Arguments</code>后，得到了一个<code>startClass</code>对象，这个<code>startClass</code>其实就是刚刚的那个<code>com.android.server.SystemServer</code>。</p>
<p>接下来，继续调用 <code>invokeStaticMain</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeStaticMain</span><span class="params">(String className, String[] argv, ClassLoader classLoader)</span> <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">	Class&lt;?&gt; cl;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	cl = Class.forName(className, <span class="keyword">true</span>, classLoader);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	m = cl.getMethod(<span class="string">"main"</span>, <span class="keyword">new</span> Class[] &#123; String[].class &#125;);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> ZygoteInit.MethodAndArgsCaller(m, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是调用通过反射得到<code>com.android.server.SystemServer</code>（也就是上面的<code>startClass</code>）的<code>main(argv[])</code>方法，然后手动抛一个携带了这个<code>main(argv[])</code>方法的<code>MethodAndArgsCaller</code>异常，但是这个异常是在<code>ZygoteInit.main()</code>方法中被catch，然后去调用它的<code>run()</code>方法，当然这个<code>run()</code>方法中会再去通过反射调用携带的<code>main()</code>方法（这个绕法真是有点坑爹－－。）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodAndArgsCaller</span> <span class="keyword">extends</span> <span class="title">Exception</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	    mMethod.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[] &#123; mArgs &#125;);</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>绕了这么一大圈，终于通过<code>MethodAndArgsCaller</code>调用<code>SystemServer</code>的<code>main()</code>方法了，代码很简单，直接<code>new</code>了之后<code>run</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> SystemServer().run();</span><br></pre></td></tr></table></figure>
<p>接着，我们看<code>SystemServer</code>的<code>run</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... (省略初始化当前的language、locale、country、指纹、用户等信息的初始化准备工作)</span></span><br><span class="line"><span class="comment">// 设置当前进程设置优先级为THREAD_PRIORITY_FOREGROUND（-2）</span></span><br><span class="line">android.os.Process.setThreadPriority(</span><br><span class="line">    android.os.Process.THREAD_PRIORITY_FOREGROUND);</span><br><span class="line">android.os.Process.setCanSelfBackground(<span class="keyword">false</span>);</span><br><span class="line"><span class="comment">// 初始化主线程Looper</span></span><br><span class="line">Looper.prepareMainLooper();</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 启动消息循环</span></span><br><span class="line">Looper.loop()</span><br></pre></td></tr></table></figure>
<p>然后调用<code>createSystemContext()</code>方法创建初始化<code>system context</code>，这个待会再展开。</p>
<p>创建<code>SystemServiceManager</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);</span><br><span class="line">LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br></pre></td></tr></table></figure></p>
<p>使用<code>SystemServiceManager</code>去通过以下方法创建启动各个<code>Service</code>：<br>1. startBootstrapServices()：</p>
<ul>
<li><code>com.android.server.pm.Installer</code>：提供安装、卸载App等服务</li>
<li><code>com.android.server.am.ActivityServiceManager</code>：提供Activity等组件的管理的服务，这个比较复杂暂且再挖个坑。</li>
<li><code>com.android.server.power.PowerManagerService</code>：电源管理的服务。</li>
<li><code>com.android.server.lights.LightsService</code>：LED管理和背光显示的服务。</li>
<li><code>com.android.server.display.DisplayManagerService</code>：提供显示的生命周期管理，根据物理显示设备当前的情况决定显示配置，在状态改变时发送通知给系统和应用等服务。</li>
<li><code>com.android.server.pm.PackageManagerService</code>：管理所有的<code>.apk</code>。</li>
<li><code>com.android.server.pm.UserManagerService</code>：提供用户相关服务。</li>
<li>通过<code>startSensorService()</code>本地方法启动Sensor服务。</li>
</ul>
<p>2. startCoreServices();</p>
<ul>
<li><code>com.android.server.BatteryService</code>：电量服务，需要<code>LightService</code>。</li>
<li><code>com.android.server.usage.UsageStatsService</code>：提供收集统计应用程序数据使用状态的服务。</li>
<li><code>com.android.server.webkit.WebViewUpdateService</code>：私有的服务（@hide），用于<code>WebView</code>的更新。</li>
</ul>
<p>3. startOtherServices();</p>
<ul>
<li><code>com.android.server.accounts.AccountManagerService</code>：提供所有账号、密码、认证管理等等的服务。</li>
<li><code>com.android.server.content.ContentService</code>：用户数据同步的服务。</li>
<li><code>com.android.server.VibratorService</code>：震动服务。</li>
<li><code>IAlarmManager</code>：提醒服务。</li>
<li><code>android.os.storage.IMountService</code>：存储管理服务。</li>
<li><code>com.android.server.NetworkManagementService</code>：系统网络连接管理服务。</li>
<li><code>com.android.server.net.NetworkStatsService</code>：收集统计详细的网络数据服务。</li>
<li><code>com.android.server.net.NetworkPolicyManagerService</code>：提供低网络策略规则管理服务。</li>
<li><code>com.android.server.ConnectivityService</code>：提供数据连接服务。</li>
<li><code>com.android.server.NetworkScoreService</code>：<code>android.net.NetworkScoreManager</code>的备份服务。</li>
<li><code>com.android.server.NsdService</code>：网络发现服务（Network Service Discovery Service）。</li>
<li><code>com.android.server.wm.WindowManagerService</code>：窗口管理服务。</li>
<li><code>com.android.server.usb.UsbService</code>：USB服务。</li>
<li><code>com.android.server.SerialService</code>：串口服务。</li>
<li><code>com.android.server.NetworkTimeUpdateService</code>：网络时间同步服务。</li>
<li><code>com.android.server.CommonTimeManagementService</code>：管理本地常见的时间配置的服务，当网络配置变化时会重新配置本地服务。</li>
<li><code>com.android.server.input.InputManagerService</code>：事件传递分发服务。</li>
<li><code>com.android.server.TelephonyRegistry</code>：提供电话注册管理的服务。</li>
<li><code>com.android.server.ConsumerIrService</code>：远程控制服务。</li>
<li><code>com.android.server.audio.AudioService</code>：音量、铃声、声道等管理服务。</li>
<li><code>com.android.server.MmsServiceBroker</code>：<code>MmsService</code>的代理，因为<code>MmsService</code>运行在电话进程中，可能随时crash，它会通过一个<code>connection</code>与<code>MmsService</code>建立一个桥梁，<code>MmsService</code>实现了公开的<code>SMS/MMS</code>的API。</li>
<li><code>TelecomLoaderService</code></li>
<li><code>CameraService</code></li>
<li><code>AlarmManagerService</code></li>
<li><code>BluetoothService</code></li>
<li>还有其它很多很多Service，这方法竟然有近1000行……</li>
</ul>
<p>在<code>startOtherServices()</code>方法的最后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mActivityManagerService.systemReady(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 下面仍然是各种Service的启动...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用这个方法用来告诉<code>ActivityManagerService</code>，此时可以运行第三方的代码了（注意：这里的Home界面、Launcher等内置的App也算是第三方的App）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (mSystemReady) &#123;</span><br><span class="line">		<span class="comment">// 回调到SystemServer，继续启动各种Service</span></span><br><span class="line">		<span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">		    goingCallback.run();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	ResolveInfo ri = mContext.getPackageManager().resolveActivity(<span class="keyword">new</span> Intent(Intent.ACTION_FACTORY_TEST), STOCK_PM_FLAGS);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	ActivityInfo ai = ri.activityInfo;</span><br><span class="line">	ApplicationInfo app = ai.applicationInfo;</span><br><span class="line">	<span class="comment">// ...从PackageManager中获取要打开的HomeActivity</span></span><br><span class="line">	mTopComponent = <span class="keyword">new</span> ComponentName(app.packageName, ai.name);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// 启动第一个Home界面</span></span><br><span class="line">	startHomeActivityLocked(mCurrentUserId, <span class="string">"systemReady"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// 广播通知启动完成</span></span><br><span class="line">	broadcastIntentLocked(<span class="comment">/*...*/</span>, mCurrentUserId);</span><br><span class="line">	broadcastIntentLocked(<span class="comment">/*...*/</span>, UserHandle.USER_ALL);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动Home界面的<code>startHomeActivityLocked</code>方法，调用<code>mStackSupervisor</code>启动<code>HomeActivity</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startHomeActivityLocked</span><span class="params">(<span class="keyword">int</span> userId, String reason)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	Intent intent = getHomeIntent();</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	intent.setFlags(intent.getFlags() | Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">	mStackSupervisor.startHomeActivity(intent, aInfo, reason);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Intent <span class="title">getHomeIntent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Intent intent = <span class="keyword">new</span> Intent(mTopAction, mTopData != <span class="keyword">null</span> ? Uri.parse(mTopData) : <span class="keyword">null</span>);</span><br><span class="line">	<span class="comment">// 设置前面获取到的mTopComponent</span></span><br><span class="line">	intent.setComponent(mTopComponent);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	intent.addCategory(Intent.CATEGORY_HOME);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此为止，<code>SystemServer</code> start完毕，并且启动了Home界面。</p>
<p>然后我们再回过头去看看在我们前面创建系统级的<code>Context</code>（<code>createSystemContext</code>）的时候做了什么：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ActivityThread activityThread = ActivityThread.systemMain();</span><br><span class="line">mSystemContext = activityThread.getSystemContext();</span><br><span class="line">mSystemContext.setTheme(android.R.style.Theme_DeviceDefault_Light_DarkActionBar);</span><br></pre></td></tr></table></figure></p>
<p>首先调用了<code>ActivityThread</code>的静态方法<code>systemMain()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ActivityThread <span class="title">systemMain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> thread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建一个<code>ActivityThread</code>，然后调用它的<code>attach()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">thread.attach(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!system) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">        ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, getSystemContext().mPackageInfo);</span><br><span class="line">        mInitialApplication = context.mPackageInfo.makeApplication(<span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">        mInitialApplication.onCreate();</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数<code>system</code>表示，是否是系统级的线程，现在我们是启动整个Android系统，显然当前传入的参数为<code>true</code>。所以进入else，首先，创建一个<code>Instrumentation</code>，<code>Instrumentation</code>是什么？暂时先挖个坑。接着通过<code>System Context</code>创建一个<code>ContextImpl</code>，然后使用它的<code>LoadedApk::makeApplication</code>方法来创建整个应用的<code>Application</code>对象，然后调用<code>Application</code>的<code>onCreate</code>方法。</p>
<p>然后看下<code>LoadedApk::makeApplication</code>方法的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 只有第一次调用makeApplication才会往下执行</span></span><br><span class="line">	<span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">return</span> mApplication;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化系统的Application，所以appClass是"android.app.Application"</span></span><br><span class="line">	String appClass = mApplicationInfo.className;</span><br><span class="line">    <span class="keyword">if</span> (forceDefaultAppClass || (appClass == <span class="keyword">null</span>)) &#123;</span><br><span class="line">        appClass = <span class="string">"android.app.Application"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>);</span><br><span class="line">    app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">            cl, appClass, appContext);</span><br><span class="line">    appContext.setOuterContext(app);</span><br><span class="line">	<span class="comment">// ...	</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建<code>appContext</code>，然后通过<code>Instrumentation</code>生成<code>Application</code>对象，并给<code>appContext</code>设置外部引用。</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> launcher </tag>
            
            <tag> source code </tag>
            
            <tag> system </tag>
            
            <tag> linux </tag>
            
            <tag> process </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android小技巧]]></title>
      <url>/2015/11/26/Android%E5%B0%8F%E6%8A%80%E5%B7%A7/</url>
      <content type="html"><![CDATA[<p>Activity.startActivities()) 常用于在应用程序中间启动其他的Activity.<br>TextUtils.isEmpty()) 简单的工具类,用于检测是否为空<br>Html.fromHtml()) 用于生成一个Html,参数可以是一个字符串.个人认为它不是很快,所以我不怎么经常去用.（我说不经常用它是为了重点突出这句话：请多手动构建 Spannable 来替换 Html.fromHtml），但是它对渲染从 web 上获取的文字还是很不错的。<br>TextView.setError() 在验证用户输入的时候很棒<br>Build.VERSION_CODES 这个标明了当前的版本号,在处理兼容性问题的时候经常会用到.点进去可以看到各个版本的不同特性<br>Log.getStackTraceString()) 方便的日志类工具,方法Log.v()、Log.d()、Log.i()、Log.w()和Log.e()都是将信息打印到LogCat中，有时候需要将出错的信息插入到数据库或一个自定义的日志文件中，那么这种情况就需要将出错的信息以字符串的形式返回来，也就是使用static String getStackTraceString(Throwable tr)方法的时候.<br>LayoutInflater.from() 顾名思义,用于Inflate一个layout,参数是layout的id.这个经常写Adapter的人会用的比较多.<br>ViewConfiguration.getScaledTouchSlop() 使用 ViewConfiguration 中提供的值以保证所有触摸的交互都是统一的。这个方法获取的值表示:用户的手滑动这个距离后,才判定为正在进行滑动.当然这个值也可以自己来决定.但是为了一致性,还是使用标准的值较好.<br>PhoneNumberUtils.convertKeypadLettersToDigits 顾名思义.将字母转换为数字,类似于T9输入法,<br>Context.getCacheDir() 获取缓存数据文件夹的路径,很简单但是知道的人不多,这个路径通常在SD卡上(这里的SD卡指的是广义上的SD卡,包括外部存储和内部存储)Adnroid/data/您的应用程序包名/cache/ 下面.测试的时候,可以去这里面看是否缓存成功.缓存在这里的好处是:不用自己再去手动创建文件夹,不用担心用户把自己创建的文件夹删掉,在应用程序卸载的时候,这里会被清空,使用第三方的清理工具的时候,这里也会被清空.<br>ArgbEvaluator 用于处理颜色的渐变。就像 Chris Banes 说的一样，这个类会进行很多自动装箱的操作，所以最好还是去掉它的逻辑自己去实现它。这个没用过,不明其所以然,回头再补充.<br>ContextThemeWrapper 方便在运行的时候修改主题.<br>Space space是Android 4.0中新增的一个控件，它实际上可以用来分隔不同的控件，其中形成一个空白的区域.这是一个轻量级的视图组件，它可以跳过Draw，对于需要占位符的任何场景来说都是很棒的。<br>ValueAnimator.reverse() 这个方法可以很顺利地取消正在运行的动画.我超喜欢.</p>
<p>DateUtils.formatDateTime() 用来进行区域格式化工作,输出格式化和本地化的时间或者日期.<br>AlarmManager.setInexactRepeating) 通过闹铃分组的方式省电,即使你只调用了一个闹钟,这也是一个好的选择,（可以确保在使用完毕时自动调用 AlarmManager.cancel ()。原文说的比较抽象,这里详细说一下:setInexactRepeating指的是设置非准确闹钟,使用方法:alarmManager.setInexactRepeating(AlarmManager.RTC, startTime,intervalL, pendingIntent),非准确闹钟只能保证大致的时间间隔，但是不一定准确，可能出现设置间隔为30分钟，但是实际上一次间隔20分钟，另一次间隔40分钟。它的最大的好处是可以合并闹钟事件，比如间隔设置每30分钟一次，不唤醒休眠，在休眠8小时后已经积累了16个闹钟事件，而在手机被唤醒的时候，非准时闹钟可以把16个事件合并为一个, 所以这么看来,非准时闹钟一般来说比较节约能源.<br>Formatter.formatFileSize()) 一个区域化的文件大小格式化工具。通俗来说就是把大小转换为MB,G,KB之类的字符串.<br>ActionBar.hide())/.show()) 顾名思义,隐藏和显示ActionBar,可以优雅地在全屏和带Actionbar之间转换.<br>Linkify.addLinks()) 在Text上添加链接.很实用.<br>StaticLayout 在自定义 View 中渲染文字的时候很实用。<br>Activity.onBackPressed()) 很方便的管理back键的方法,有时候需要自己控制返回键的事件的时候,可以重写一下.比如加入 “点两下back键退出” 功能.<br>GestureDetector 用来监听和相应对应的手势事件,比如点击,长按,慢滑动,快滑动,用起来很简单,比你自己实现要方便许多.<br>DrawFilter 可以让你在不调用onDrew方法的情况下,操作canvas,比了个如,你可以在创建自定义 View 的时候设置一个 DrawFilter，给父 View 里面的所有 View 设置反别名。<br>ActivityManager.getMemoryClass()) 告诉你你的机器还有多少内存,在计算缓存大小的时候会比较有用.<br>ViewStub 它是一个初始化不做任何事情的 View，但是之后可以载入一个布局文件。在慢加载 View 中很适合做占位符。唯一的缺点就是不支持标签，所以如果你不太小心的话，可能会在视图结构中加入不需要的嵌套。<br>SystemClock.sleep()) 这个方法在保证一定时间的 sleep 时很方便，通常我用来进行 debug 和模拟网络延时。<br>DisplayMetrics.density 这个方法你可以获取设备像素密度,大部分时候最好让系统来自动进行缩放资源之类的操作,但是有时候控制的效果会更好一些.(尤其是在自定义View的时候).<br>Pair.create()) 方便构建类和构造器的方法。</p>
<p>UrlQuerySanitizer——使用这个工具可以方便对 URL 进行检查。<br>Fragment.setArguments——因为在构建 Fragment 的时候不能加参数，所以这是个很好的东西，可以在创建 Fragment 之前设置参数（即使在 configuration 改变的时候仍然会导致销毁/重建）。<br>DialogFragment.setShowsDialog ()—— 这是一个很巧妙的方式，DialogFragment 可以作为正常的 Fragment 显示！这里可以让 Fragment 承担双重任务。我通常在创建 Fragment 的时候把 onCreateView ()和 onCreateDialog ()都加上，就可以创建一个具有双重目的的 Fragment。<br>FragmentManager.enableDebugLogging ()——在需要观察 Fragment 状态的时候会有帮助。<br>LocalBroadcastManager——这个会比全局的 broadcast 更加安全，简单，快速。像 otto 这样的 Event buses 机制对你的应用场景更加有用。<br>PhoneNumberUtils.formatNumber ()——顾名思义，这是对数字进行格式化操作的时候用的。<br>Region.op()——我发现在对比两个渲染之前的区域的时候很实用，如果你有两条路径，那么怎么知道它们是不是会重叠呢？使用这个方法就可以做到。<br>Application.registerActivityLifecycleCallbacks——虽然缺少官方文档解释，不过我想它就是注册 Activity 的生命周期的一些回调方法（顾名思义），就是一个方便的工具。<br>versionNameSuffix——这个 gradle 设置可以让你在基于不同构建类型的 manifest 中修改版本名这个属性，例如，如果需要在在 debug 版本中以”-SNAPSHOT”结尾，那么就可以轻松的看出当前是 debug 版还是 release 版。<br>CursorJoiner——如果你是只使用一个数据库的话，使用 SQL 中的 join 就可以了，但是如果收到的数据是来自两个独立的 ContentProvider，那么 CursorJoiner 就很实用了。<br>Genymotion——一个非常快的 Android 模拟器，本人一直在用。<br>-nodpi——在没有特别定义的情况下，很多修饰符(-mdpi,-hdpi,-xdpi等等)都会默认自动缩放 assets/dimensions，有时候我们需要保持显示一致，这种情况下就可以使用 -nodpi。<br>BroadcastRecevier.setDebugUnregister ()——又一个方便的调试工具。<br>Activity.recreate ()——强制让 Activity 重建。<br>PackageManager.checkSignatures ()——如果同时安装了两个 app 的话，可以用这个方法检查。如果不进行签名检查的话，其他人可以轻易通过使用一样的包名来模仿你的 app。</p>
<p>Activity.isChangingConfigurations ()——如果在 Activity 中 configuration 会经常改变的话，使用这个方法就可以不用手动做保存状态的工作了。<br>SearchRecentSuggestionsProvider——可以创建最近提示效果的 provider，是一个简单快速的方法。<br>ViewTreeObserver——这是一个很棒的工具。可以进入到 VIew 里面，并监控 View 结构的各种状态，通常我都用来做 View 的测量操作（自定义视图中经常用到）。<br>org.gradle.daemon=true——这句话可以帮助减少 Gradle 构建的时间，仅在命令行编译的时候用到，因为 Android Studio 已经这样使用了。<br>DatabaseUtils——一个包含各种数据库操作的使用工具。<br>android:weightSum (LinearLayout)——如果想使用 layout weights，但是却不想填充整个 LinearLayout 的话，就可以用 weightSum 来定义总的 weight 大小。<br>android:duplicateParentState (View)——此方法可以使得子 View 可以复制父 View 的状态。比如如果一个 ViewGroup 是可点击的，那么可以用这个方法在它被点击的时候让它的子 View 都改变状态。<br>android:clipChildren (ViewGroup)——如果此属性设置为不可用，那么 ViewGroup 的子 View 在绘制的时候会超出它的范围，在做动画的时候需要用到。<br>android:fillViewport (ScrollView)——在这片文章中有详细介绍文章链接，可以解决在 ScrollView 中当内容不足的时候填不满屏幕的问题。<br>android:tileMode (BitmapDrawable)——可以指定图片使用重复填充的模式。<br>android:enterFadeDuration/android:exitFadeDuration (Drawables)——此属性在 Drawable 具有多种状态的时候，可以定义它展示前的淡入淡出效果。<br>android:scaleType (ImageView)——定义在 ImageView 中怎么缩放/剪裁图片，一般用的比较多的是“centerCrop”和“centerInside”。<br>Merge——此标签可以在另一个布局文件中包含别的布局文件，而不用再新建一个 ViewGroup，对于自定义 ViewGroup 的时候也需要用到；可以通过载入一个带有标签的布局文件来自动定义它的子部件。<br>AtomicFile——通过使用备份文件进行文件的原子化操作。这个知识点之前我也写过，不过最好还是有出一个官方的版本比较好。</p>
<p>ViewDragHelper ——视图拖动是一个比较复杂的问题。这个类可以帮助解决不少问题。如果你需要一个例子，DrawerLayout就是利用它实现扫滑。Flavient Laurent 还写了一些关于这方面的优秀文章。<br>PopupWindow——Android到处都在使用PopupWindow ，甚至你都没有意识到（标题导航条ActionBar，自动补全AutoComplete，编辑框错误提醒Edittext Errors）。这个类是创建浮层内容的主要方法。<br>Actionbar.getThemrContext()——导航栏的主题化是很复杂的（不同于Activity其他部分的主题化）。你可以得到一个上下文（Context），用这个上下文创建的自定义组件可以得到正确的主题。<br>ThumbnailUtils——帮助创建缩略图。通常我都是用现有的图片加载库（比如，Picasso 或者 Volley），不过这个ThumbnaiUtils可以创建视频缩略图。译者注：该API从V8才开始支持。<br>Context.getExternalFilesDir()———— 申请了SD卡写权限后，你可以在SD的任何地方写数据，把你的数据写在设计好的合适位置会更加有礼貌。这样数据可以及时被清理，也会有更好的用户体验。此外，Android 4.0 Kitkat中在这个文件夹下写数据是不需要权限的，每个用户有自己的独立的数据存储路径。译者注：该API从V8才开始支持。<br>SparseArray——Map的高效优化版本。推荐了解姐妹类SparseBooleanArray、SparseIntArray和SparseLongArray。<br>PackageManager.setComponentEnabledSetting()——可以用来启动或者禁用程序清单中的组件。对于关闭不需要的功能组件是非常赞的，比如关掉一个当前不用的广播接收器。<br>SQLiteDatabase.yieldIfContendedSafely()——让你暂时停止一个数据库事务， 这样你可以就不会占用太多的系统资源。<br>Environment.getExternalStoragePublicDirectory()——还是那句话，用户期望在SD卡上得到统一的用户体验。用这个方法可以获得在用户设备上放置指定类型文件（音乐、图片等）的正确目录。<br>View.generateViewId()——每次我都想要推荐动态生成控件的ID。需要注意的是，不要和已经存在的控件ID或者其他已经生成的控件ID重复。<br>ActivityManager.clearApplicationUserData()—— 一键清理你的app产生的用户数据，可能是做用户退出登录功能，有史以来最简单的方式了。<br>Context.createConfigurationContext() ——自定义你的配置环境信息。我通常会遇到这样的问题：强制让一部分显示在某个特定的环境下（倒不是我一直这样瞎整，说来话长，你很难理解）。用这个实现起来可以稍微简单一点。<br>ActivityOptions ——方便的定义两个Activity切换的动画。 使用ActivityOptionsCompat 可以很好解决旧版本的兼容问题。<br>AdapterViewFlipper.fyiWillBeAdvancedByHostKThx()——仅仅因为很好玩，没有其他原因。在整个安卓开源项目中（AOSP the Android ——pen Source Project Android开放源代码项目）中还有其他很有意思的东西（比如<br>GRAVITY_DEATH_STAR_I）。不过，都不像这个这样，这个确实有用<br>ViewParent.requestDisallowInterceptTouchEvent() ——Android系统触摸事件机制大多时候能够默认处理，不过有时候你需要使用这个方法来剥夺父级控件的控制权（顺便说一下，如果你想对Android触摸机制了解更多，这个演讲会令你惊叹不已。）</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> tips </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]Activity启动过程]]></title>
      <url>/2015/11/10/Android-Activity%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/</url>
      <content type="html"><![CDATA[<h3 id="Android系统启动加载流程："><a href="#Android系统启动加载流程：" class="headerlink" title="Android系统启动加载流程："></a>Android系统启动加载流程：</h3><p><a href="http://i11.tietuku.com/0582844414810f38.png" target="_blank" rel="noopener">参考图</a></p>
<ul>
<li>Linux内核加载完毕 </li>
<li>启动<code>init</code>进程 </li>
<li><code>init</code>进程fork出<code>zygote</code>进程</li>
<li><code>zygote</code>进程在<code>ZygoteInit.main()</code>中进行初始化的时候fork出<code>SystemServer</code>进程</li>
<li><code>SystemServer</code>进程开启的时候初始化<code>ActivityThread</code>和<code>ActivityManagerService</code>（其它还有<code>PowerManagerService</code>，<code>DisplayManagerService</code>，<code>PackageManagerService</code>）</li>
<li>启动<code>Launcher</code>，<code>Launcher</code>本质上也是一个App，继承自<code>Activity</code></li>
</ul>
<h3 id="App与AMS通过Binder进行IPC通信"><a href="#App与AMS通过Binder进行IPC通信" class="headerlink" title="App与AMS通过Binder进行IPC通信"></a>App与AMS通过Binder进行IPC通信</h3><h4 id="启动一个Activity"><a href="#启动一个Activity" class="headerlink" title="启动一个Activity"></a>启动一个Activity</h4><blockquote>
<p>客户端：ActivityManagerProxy –&gt; Binder驱动 –&gt; ActivityManagerService：服务器</p>
</blockquote>
<ul>
<li><strong>ActivityThread</strong><br>老板，虽然说家里的事自己说了算，但是需要听从AMS的指挥</li>
<li><strong>Instrumentation</strong><br>老板娘，负责家里的大事小事，但是一般不抛头露面，听一家之主ActivityThread的安排，每个Activity都有一个<code>Instrumentation</code>引用，整个进程只有一个<code>Instrumentation</code>实例</li>
<li><strong>ActivityManagerProxy</strong><br>ActivityManagerNative.getDefault().startActivity获取<code>ActivityManagerProxy</code>对象通过Binder IPC与AMS通信</li>
<li><strong>AMS</strong><br>真正启动一个Ativity（<code>ActivityStackSupervisor</code>, <code>ActivityStack</code>）</li>
</ul>
<h4 id="Resume一个Activity"><a href="#Resume一个Activity" class="headerlink" title="Resume一个Activity"></a>Resume一个Activity</h4><blockquote>
<p>客户端：ApplicationThread &lt;– Binder驱动 &lt;– ApplicationThreadProxy：服务器</p>
</blockquote>
<ul>
<li><strong>AMS</strong></li>
<li><strong>ApplicationThreadProxy</strong><br><code>ApplicationThreadProxy</code>对象通过Binder IPC与客户端通信。</li>
<li><strong>ApplicationThread</strong></li>
<li><strong>Handler</strong></li>
<li><strong>ActivityThread</strong></li>
<li><strong>Activity</strong><br>调用onResume方法</li>
</ul>
<h3 id="AMS-SystemServer进程-与zygote通过Socket进行IPC通信"><a href="#AMS-SystemServer进程-与zygote通过Socket进行IPC通信" class="headerlink" title="AMS(SystemServer进程)与zygote通过Socket进行IPC通信"></a>AMS(SystemServer进程)与zygote通过Socket进行IPC通信</h3><p>参考：<a href="http://blog.csdn.net/zhaokaiqiang1992/article/details/49428287" target="_blank" rel="noopener">http://blog.csdn.net/zhaokaiqiang1992/article/details/49428287</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> activity </tag>
            
            <tag> launcher </tag>
            
            <tag> source code </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[《Kotli­n for ­androi­d Deve­lopers­》中文翻译]]></title>
      <url>/2015/11/05/%E3%80%8AKotli%C2%ADn-for-%C2%ADandroi%C2%ADd-Deve%C2%ADlopers%C2%AD%E3%80%8B%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91/</url>
      <content type="html"><![CDATA[<p>之前一直在关注Kotlin和Android相关的开发，写过两篇关于Kotlin的文章，不了解Kotlin的可以看下：</p>
<ul>
<li>[Android]使用Kotlin+Anko开发Android（一）：<a href="http://www.cnblogs.com/tiantianbyconan/p/4800656.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4800656.html</a></li>
<li>[Android]使用Kotlin开发Android（二）：<a href="http://www.cnblogs.com/tiantianbyconan/p/4829007.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4829007.html</a></li>
</ul>
<p>后来在<a href="https://kotlinlang.org/docs/reference/" target="_blank" rel="noopener">Kotlin官网</a>上面看到了这本书《Kotlin for android developers》：<br><img src="https://s3.amazonaws.com/titlepages.leanpub.com/kotlin-for-android-developers/large?1445802287]" alt=""></p>
<p>这本书发布在<a href="https://leanpub.com/kotlin-for-android-developers" target="_blank" rel="noopener">leanpub</a>，前两周作者完成本书后，我就购买看了一遍，里面通过一个天气预报的App例子讲解了基本上Kotlin所有的语法和特性，解决了几个困扰我很久的问题。</p>
<p>后来打算把它翻译成中文版贡献给大家，已经翻译完成：</p>
<p><strong>Gitbook在线阅读或下载</strong>：<a href="https://www.gitbook.com/book/wangjiegulu/kotlin-for-android-developers-zh/details" target="_blank" rel="noopener">https://www.gitbook.com/book/wangjiegulu/kotlin-for-android-developers-zh/details</a><br><strong>Github地址</strong>：<a href="https://github.com/wangjiegulu/kotlin-for-android-developers-zh" target="_blank" rel="noopener">https://github.com/wangjiegulu/kotlin-for-android-developers-zh</a></p>
<p>本人水平有限，大家遇到错别字、病句、翻译错误等问题<a href="https://github.com/wangjiegulu/kotlin-for-android-developers-zh/issues" target="_blank" rel="noopener">可以在Github上提issues</a>。不过请说明错误原因。</p>
<p>希望大家支持购买原版：<a href="https://leanpub.com/kotlin-for-android-developers" target="_blank" rel="noopener">https://leanpub.com/kotlin-for-android-developers</a></p>
<h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><ul>
<li><a href="README.md">Introduction</a></li>
<li><a href="xie_zai_qian_mian.md">写在前面</a></li>
<li><a href="guan_yu_ben_shu.md">关于本书</a></li>
<li><a href="zhe_ben_shu_shi_he_ni_ma_ff1f.md">这本书适合你吗？</a></li>
<li><a href="guan_yu_zuo_zhe.md">关于作者</a></li>
<li><a href="jie_shao.md">介绍</a><ul>
<li><a href="shi_yao_shi_kotlin.md">什么是Kotlin？</a></li>
<li><a href="wo_men_tong_guo_kotlin_de_dao_shi_yao.md">我们通过Kotlin得到什么</a></li>
</ul>
</li>
<li><a href="zhun_bei_gong_zuo.md">准备工作</a><ul>
<li><a href="android_studio.md">Android Studio</a></li>
<li><a href="an_zhuang_kotlin_cha_jian.md">安装Kotlin插件</a></li>
</ul>
</li>
<li><a href="chuang_jian_yi_ge_xin_de_xiang_mu.md">创建一个新的项目</a><ul>
<li><a href="zai_android_studio_zhong_chuang_jian_yi_ge_xiang_mu.md">在Android Studio中创建一个项目</a></li>
<li><a href="pei_zhi_gradle.md">配置Gradle</a></li>
<li><a href="ba_mainactivity_zhuan_huan_cheng_kotlin_dai_ma.md">把MainActivity转换成Kotlin代码</a></li>
<li><a href="ce_shi_shi_fou_yi_qie_jiu_xu.md">测试是否一切就绪</a></li>
</ul>
</li>
<li><a href="lei_he_han_shu.md">类和函数</a><ul>
<li><a href="zen_yao_ding_yi_yi_ge_lei.md">怎么定义一个类</a></li>
<li><a href="lei_ji_cheng.md">类继承</a></li>
<li><a href="han_shu.md">函数</a></li>
<li><a href="gou_zao_fang_fa_he_han_shu_can_shu.md">构造方法和函数参数</a></li>
</ul>
</li>
<li><a href="bian_xie_ni_de_di_yi_ge_lei.md">编写你的第一个类</a><ul>
<li><a href="chuang_jian_yi_ge_layout.md">创建一个layout</a></li>
<li><a href="the_recycler_adapter.md">The Recycler Adapter</a></li>
</ul>
</li>
<li><a href="bian_liang_he_shu_xing.md">变量和属性</a><ul>
<li><a href="ji_ben_lei_xing.md">基本类型</a></li>
<li><a href="bian_liang.md">变量</a></li>
<li><a href="shu_xing.md">属性</a></li>
</ul>
</li>
<li>Anko和扩展的函数<ul>
<li><a href="ankoshi_shi_yao_ff1f.md">Anko是什么？</a></li>
<li><a href="kai_shi_shi_yong_anko.md">开始使用Anko</a></li>
<li><a href="kuo_zhan_han_shu.md">扩展函数</a></li>
</ul>
</li>
<li>从API中获取数据<ul>
<li><a href="zhi_xing_yi_ge_qing_qiu.md">执行一个请求</a></li>
<li><a href="zai_zhu_xian_cheng_yi_wai_zhi_xing_qing_qiu.md">在主线程以外执行请求</a></li>
</ul>
</li>
<li><a href="shu_ju_lei.md">数据类</a><ul>
<li><a href="e_wai_de_han_shu.md">额外的函数</a></li>
<li><a href="fu_zhi_yi_ge_shu_ju_lei.md">复制一个数据类</a></li>
<li><a href="ying_she_dui_xiang_dao_bian_liang_zhong.md">映射对象到变量中</a></li>
<li><a href="zhuan_huan_json_dao_shu_ju_lei.md">转换json到数据类</a></li>
<li><a href="gou_jiandomain_ceng.md">构建domain层</a></li>
<li><a href="zaiui_zhong_hui_zhi_shu_ju.md">在UI中绘制数据</a></li>
</ul>
</li>
<li><a href="cao_zuo_fu_zhong_zai.md">操作符重载</a><ul>
<li><a href="cao_zuo_fu_biao.md">操作符表</a></li>
<li><a href="li_zi.md">例子</a></li>
<li><a href="kuo_zhan_han_shu_zhong_de_cao_zuo_fu.md">扩展函数中的操作符</a></li>
</ul>
</li>
<li><a href="shi_forecast_list_ke_dian_ji.md">使Forecast list可点击</a></li>
<li><a href="lambdas.md">Lambdas</a><ul>
<li><a href="jian_hua_setonclicklistener.md">简化setOnClickListener()</a></li>
<li><a href="forecastlistadapterde_click_listener.md">ForecastListAdapter的click listener</a></li>
<li><a href="kuo_zhan_yu_yan.md">扩展语言</a></li>
</ul>
</li>
<li><a href="ke_jian_xing_xiu_shi_fu.md">可见性修饰符</a><ul>
<li><a href="xiu_shi_fu.md">修饰符</a></li>
<li><a href="gou_zao_qi.md">构造器</a></li>
<li><a href="zhong_gou_dai_ma.md">重构代码</a></li>
</ul>
</li>
<li><a href="kotlin_android_extensions.md">Kotlin Android Extensions</a><ul>
<li><a href="zen_yaoqu_shi_yong_kotlinandroid_extensions.md">怎么去使用Kotlin Android Extensions</a></li>
<li><a href="zhong_gou_wo_men_de_dai_ma.md">重构我们的代码</a></li>
</ul>
</li>
<li><a href="applicationdan_li_hua_he_shu_xing_de_delegated.md">Application单例化和属性的Delegated</a><ul>
<li><a href="applicatondan_li_hua.md">Applicaton单例化</a></li>
<li><a href="wei_tuo_shu_xing.md">委托属性</a></li>
<li><a href="biao_zhun_wei_tuo.md">标准委托</a></li>
<li><a href="zen_yao_qu_chuang_jian_yi_ge_zi_ding_yi_de_wei_tuo.md">怎么去创建一个自定义的委托</a></li>
<li><a href="zhong_xin_shixian_application_dan_li_hua.md">重新实现Application单例化</a></li>
</ul>
</li>
<li><a href="chuang_jian_yi_ge_sqliteopenhelper.md">创建一个SQLiteOpenHelper</a><ul>
<li><a href="managedsqliteopenhelper.md">ManagedSqliteOpenHelper</a></li>
<li><a href="ding_yi_biao.md">定义表</a></li>
<li><a href="shi_xian_sqliteopenhelper.md">实现SqliteOpenHelper</a></li>
<li><a href="yi_lai_zhu_ru.md">依赖注入</a></li>
</ul>
</li>
<li><a href="ji_he_he_han_shu_cao_zuo_fu.md">集合和函数操作符</a><ul>
<li><a href="zong_shu_cao_zuo_fu.md">总数操作符</a></li>
<li><a href="guo_lv_cao_zuo_fu.md">过滤操作符</a></li>
<li><a href="ying_she_cao_zuo_fu.md">映射操作符</a></li>
<li><a href="yuan_su_cao_zuo_fu.md">元素操作符</a></li>
<li><a href="sheng_chan_cao_zuo_fu.md">生产操作符</a></li>
<li><a href="shun_xu_cao_zuo_fu.md">顺序操作符</a></li>
</ul>
</li>
<li><a href="cong_shu_ju_ku_zhong_bao_cun_huo_cha_xun_shu_ju.md">从数据库中保存或查询数据</a><ul>
<li><a href="chuang_jian_shu_ju_ku_model_lei.md">创建数据库model类</a></li>
<li><a href="xie_ru_he_cha_xun_shu_ju_ku.md">写入和查询数据库</a></li>
</ul>
</li>
<li><a href="kotlinzhong_de_null_an_quan.md">Kotlin中的null安全</a><ul>
<li><a href="ke_null_lei_xing_zen_yao_gong_zuo.md">可null类型怎么工作</a></li>
<li><a href="ke_null_xing_he_java_ku.md">可null性和Java库</a></li>
</ul>
</li>
<li><a href="chuang_jian_ye_wu_luo_ji_lai_fang_wen_shu_ju.md">创建业务逻辑来访问数据</a></li>
<li><a href="flow_controlhe_ranges.md">Flow control和ranges</a><ul>
<li><a href="ifbiao_da_shi.md">If表达式</a></li>
<li><a href="whenbiao_da_shi.md">When表达式</a></li>
<li><a href="forxun_huan.md">For循环</a></li>
<li><a href="whilehe_do__while_xun_huan.md">While和do/while循环</a></li>
<li><a href="ranges.md">Ranges</a></li>
</ul>
</li>
<li><a href="chuang_jian_yi_ge_xiang_qing_jie_mian.md">创建一个详情界面</a><ul>
<li><a href="zhun_bei_qing_qiu.md">准备请求</a></li>
<li><a href="ti_gong_yige_xin_de_activity.md">提供一个新的activity</a></li>
<li><a href="qi_dong_yige_activity__reified_han_shu.md">启动一个activity：reified函数</a></li>
</ul>
</li>
<li>接口和委托<ul>
<li><a href="jie_kou.md">接口</a></li>
<li><a href="wei_tuo.md">委托</a></li>
<li><a href="zai_wo_men_de_app_zhong_shi_xian_yi_ge_li_zi.md">在我们的App中实现一个例子</a></li>
</ul>
</li>
<li><a href="fan_xing.md">范型</a><ul>
<li><a href="ji_chu.md">基础</a></li>
<li><a href="bian_ti.md">变体</a></li>
<li><a href="fan_xing_li_zi.md">范型例子</a></li>
</ul>
</li>
<li><a href="she_zhi_jie_mian.md">设置界面</a><ul>
<li><a href="chuang_jian_yi_ge_she_zhi_activity.md">创建一个设置activity</a></li>
<li><a href="fang_wen_shared_preferences.md">访问Shared Preferences</a></li>
<li><a href="fan_xing_preference_wei_tuo.md">范型preference委托</a></li>
</ul>
</li>
<li><a href="ce_shi_ni_de_app.md">测试你的App</a><ul>
<li><a href="unit_testing.md">Unit testing</a></li>
<li><a href="instrumentation_tests.md">Instrumentation tests</a></li>
</ul>
</li>
<li><a href="qi_ta_de_gai_nian.md">其它的概念</a><ul>
<li><a href="nei_bu_lei.md">内部类</a></li>
<li><a href="mei_ju.md">枚举</a></li>
<li><a href="mi_feng_lei.md">密封（Sealed）类</a></li>
<li><a href="yi_chang_ff08_exceptions.md">异常（Exceptions）</a></li>
</ul>
</li>
<li><a href="jie_wei.md">结尾</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> kotlin </tag>
            
            <tag> 翻译 </tag>
            
            <tag> Kotli­n for android Developers </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]使用Kotlin开发Android（二）]]></title>
      <url>/2015/09/22/Android-%E4%BD%BF%E7%94%A8Kotlin%E5%BC%80%E5%8F%91Android%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>[TOC]</p>
<h2 id="使用Kotlin＋OkHttp＋RxJava进行网络请求"><a href="#使用Kotlin＋OkHttp＋RxJava进行网络请求" class="headerlink" title="使用Kotlin＋OkHttp＋RxJava进行网络请求"></a>使用Kotlin＋OkHttp＋RxJava进行网络请求</h2><p>代码：<a href="https://github.com/wangjiegulu/KotlinAndroidSample" target="_blank" rel="noopener">https://github.com/wangjiegulu/KotlinAndroidSample</a></p>
<h3 id="1-需要"><a href="#1-需要" class="headerlink" title="1. 需要"></a>1. 需要</h3><ul>
<li>对<a href="http://kotlinlang.org/" target="_blank" rel="noopener">Kotlin</a>语法有基本的掌握</li>
<li>对<a href="https://github.com/square/okhttp" target="_blank" rel="noopener">OkHttp</a>有基本的了解</li>
<li>对<a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="noopener">RxJava</a> / <a href="https://github.com/ReactiveX/RxAndroid" target="_blank" rel="noopener">RxAndroid</a>有基本的了解</li>
</ul>
<h3 id="2-Kotlin搭建环境"><a href="#2-Kotlin搭建环境" class="headerlink" title="2. Kotlin搭建环境"></a>2. Kotlin搭建环境</h3><p>见之前的文章：<a href="http://www.cnblogs.com/tiantianbyconan/p/4800656.html" target="_blank" rel="noopener">[Android]使用Kotlin+Anko开发Android（一）</a></p>
<h3 id="3-Gradle添加相关依赖包："><a href="#3-Gradle添加相关依赖包：" class="headerlink" title="3. Gradle添加相关依赖包："></a>3. Gradle添加相关依赖包：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">compile &quot;org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version&quot;</span><br><span class="line">compile &quot;org.jetbrains.kotlin:kotlin-reflect:$kotlin_version&quot;</span><br><span class="line">compile &apos;com.squareup.okhttp:okhttp:2.4.0&apos;</span><br><span class="line">compile &apos;io.reactivex:rxjava:1.0.12&apos;</span><br><span class="line">compile &apos;io.reactivex:rxandroid:0.24.0&apos;</span><br></pre></td></tr></table></figure>
<h3 id="4-请求"><a href="#4-请求" class="headerlink" title="4. 请求"></a>4. 请求</h3><p>一般的写法如下：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Observable.defer(&#123; -&gt;</span><br><span class="line">                Observable.just(OkHttpClient().newCall(</span><br><span class="line">                        Request.Builder()</span><br><span class="line">                                .url(<span class="string">"https://github.com/wangjiegulu"</span>)</span><br><span class="line">                                .<span class="keyword">get</span>()</span><br><span class="line">                                .build()</span><br><span class="line">                ).execute())</span><br><span class="line">            &#125;).subscribeOn(Schedulers.newThread())</span><br><span class="line">                    .map(&#123;r -&gt; r.body().string()&#125;)</span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">            .subscribe(&#123; result -&gt; Log.d(TAG, <span class="string">"request result: <span class="variable">$result</span>"</span>); resultTv.setText(<span class="string">"Http request succeed, see log"</span>) &#125;, &#123;throwable -&gt; Log.e(TAG, <span class="string">""</span>, throwable)&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="5-使用Kotlin语法糖进行简化"><a href="#5-使用Kotlin语法糖进行简化" class="headerlink" title="5. 使用Kotlin语法糖进行简化"></a>5. 使用Kotlin语法糖进行简化</h3><h4 id="1-在String类中扩展http请求方法"><a href="#1-在String类中扩展http请求方法" class="headerlink" title="1) 在String类中扩展http请求方法"></a>1) 在String类中扩展http请求方法</h4><p>我们希望在url（String）中增加一个方法，直接调用后构建一个http请求：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> String.<span class="title">request</span><span class="params">()</span></span>: Request.Builder = Request.Builder().url(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure></p>
<p>如上代码，在String类中定义了一个request()方法，返回一个OkHttp的Request.Builder对象，并设置url为当前的String对象，即当前的url。</p>
<h4 id="2-在Request-Builder类中扩展执行http请求方法"><a href="#2-在Request-Builder类中扩展执行http请求方法" class="headerlink" title="2) 在Request.Builder类中扩展执行http请求方法"></a>2) 在Request.Builder类中扩展执行http请求方法</h4><p>调用String方法的request()方法之后，获得了一个构建的Request.Builder对象，然后希望通过这个对象调用某个方法来执行http请求，于是继续扩展：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Request.Builder.<span class="title">rxExecute</span><span class="params">()</span></span>: Observable&lt;Response&gt; = Observable.defer(&#123; Observable.just(OkHttpClient().newCall(<span class="keyword">this</span>.build()).execute()) &#125;).subscribeOn(Schedulers.newThread());</span><br></pre></td></tr></table></figure></p>
<p>我们在Request.Builder类中定义了一个rxExecute()方法，这个方法中，会通过RxJava构建一个Obserable对象，Obserable对象中排出给观察者的数据就是http执行完毕后的结果Response。并且指定了执行http请求所在的线程。</p>
<h4 id="3-优化后的调用方式"><a href="#3-优化后的调用方式" class="headerlink" title="3) 优化后的调用方式"></a>3) 优化后的调用方式</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"https://github.com/wangjiegulu"</span>.request().<span class="keyword">get</span>().rxExecute()</span><br><span class="line">                    .map(&#123; r -&gt; r.body().string() &#125;)</span><br><span class="line">                    .observeOnMain()</span><br><span class="line">                    .subscribeSafeNext &#123; result -&gt; Log.d(TAG, <span class="string">"request result: <span class="variable">$result</span>"</span>); resultTv.setText(<span class="string">"Http request succeed, see log"</span>) &#125;</span><br></pre></td></tr></table></figure>
<p>如上：通过url构建Request.Builder，然后通过RequestBuilder构建一个Obserable，然后订阅获得排出的请求结果。</p>
<p>为了方便调用，又在Obserable中扩展了几个方法：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Observable<span class="type">&lt;T&gt;</span>.<span class="title">observeOnMain</span><span class="params">()</span></span>: Observable&lt;T&gt; = <span class="keyword">this</span>.observeOn(AndroidSchedulers.mainThread())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Observable<span class="type">&lt;T&gt;</span>.<span class="title">subscribeSafeNext</span><span class="params">(onNext: (<span class="type">T</span>)</span></span> -&gt; <span class="built_in">Unit</span>): Subscription = <span class="keyword">this</span>.subscribe(onNext, &#123; t -&gt; Log.e(TAG, <span class="string">""</span>, t) &#125;, &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Observable<span class="type">&lt;T&gt;</span>.<span class="title">subscribeSafeCompleted</span><span class="params">(onCompleted: ()</span></span> -&gt; <span class="built_in">Unit</span>): Subscription = <span class="keyword">this</span>.subscribe(&#123;&#125;, &#123; t -&gt; Log.e(TAG, <span class="string">""</span>, t) &#125;, onCompleted);</span><br></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> anko </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Kotlin语法（其他）]]></title>
      <url>/2015/09/13/Kotlin%E8%AF%AD%E6%B3%95%EF%BC%88%E5%85%B6%E4%BB%96%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>#三、其他<br>[TOC]</p>
<p>##1. 多重声明<br>有时候可以通过给对象插入多个成员函数做区别是很方便的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val (name, age) = person</span><br></pre></td></tr></table></figure></p>
<p>多重声明一次创建了多个变量。我们声明了俩个新变量：name age 并且可以独立使用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">println(name)</span><br><span class="line">println(age)</span><br></pre></td></tr></table></figure></p>
<p>也可以在 for 循环中用:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for ((a, b) in collection) &#123; ... &#125;</span><br></pre></td></tr></table></figure></p>
<p>map:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for ((key, value) in map) &#123; ... &#125;</span><br></pre></td></tr></table></figure></p>
<p>##2. Ranges<br>函数操作符是<code>:</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (i in 1..10)&#123; ... &#125;</span><br><span class="line">if (x !in 1.0..3.0) println(x)</span><br><span class="line">if (str in &quot;island&quot;..&quot;isle&quot;) println(str)</span><br><span class="line">for (i in 4 downTo 1) print(i) // prints &apos;4321&apos;</span><br><span class="line">for (i in 1..4 step 2) print(i) // prints &quot;13&quot;</span><br><span class="line">for (i in 4 downTo 1 step 2) print(i) // prints &quot;42&quot;</span><br><span class="line">for (i in 1.0..2.0 step 0.3) print(&quot;$i &quot;) // prints &quot;1.0 1.3 1.6 1.9 &quot;</span><br><span class="line">for (i in (1..4).reversed()) print(i) // prints &quot;4321&quot;</span><br><span class="line">for (i in (1..4).reversed() step 2) print(i) // prints &quot;42&quot;</span><br></pre></td></tr></table></figure></p>
<p>##3. 类型检查和转换<br>is !is 表达式: 类似Java的instanceof</p>
<p>“不安全”的转换符，如下的x不能为空，否则抛异常:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val x: String = y as String</span><br></pre></td></tr></table></figure></p>
<p>“安全”转换符，如下不管 as? 右边的是不是一个非空 String 结果都会转换为可空的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val x: String ?= y as? String</span><br></pre></td></tr></table></figure></p>
<p>##4. This 表达式<br>如果 this 没有应用者，则指向的是最内层的闭合范围。为了在其它范围中返回 this ，需要使用标签:<code>this@lable</code></p>
<p>##5. 等式<br>在 kotlin 中有两种相等：</p>
<ul>
<li><p>参照相等: <code>===</code>，参照相等是通过 === 操作符判断的(不等是!== ) a===b 只有 a b 指向同一个对象是判别才成立。另外，你可以使用内联函数<code>identityEquals()</code> 判断参照相等。</p>
</li>
<li><p>结构相等: <code>==</code>，结构相等是通过 == 判断的。像<code>a == b</code>将会翻译成：<code>a?.equals(b) ?: b === null</code>，如果 a 不是 null 则调用 equals(Any?) 函数，否则检查 b 是否参照等于 null。</p>
</li>
</ul>
<p>##6. 运算符重载<br><a href="http://kotlinlang.org/docs/reference/operator-overloading.html" target="_blank" rel="noopener">http://kotlinlang.org/docs/reference/operator-overloading.html</a></p>
<p>##7. 空安全<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var a: String =&quot;abc&quot;</span><br><span class="line">a = null // 编译错误</span><br><span class="line">val l = a.length() // 因为a不能为null，所以不会报错</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var b: String? = &quot;abc&quot;</span><br><span class="line">b = null</span><br><span class="line">val l = b.length() // 错误：b为空</span><br><span class="line">val l = if (b != null) b.length() else -1 // 不会报错</span><br><span class="line">b?.length() // 安全调用不会报错</span><br></pre></td></tr></table></figure>
<p>安全调用在链式调用是是很有用的。比如，如果 Bob 是一个雇员可能分配部门(也可能不分配)，如果我们想获取 Bob 的部门名作为名字的前缀，就可以这样做：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bob?.department?.head?.name //</span><br></pre></td></tr></table></figure></p>
<p><strong>Elvis 操作符:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val l: Int = if (b != null) b.length() else -1</span><br></pre></td></tr></table></figure></p>
<p>也可以使用　Elvis 操作符<code>?:</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val l = b.length()?: -1</span><br></pre></td></tr></table></figure></p>
<p>如果 ?: 左边表达式不为空则返回，否则返回右边的表达式。注意右边的表带式只有在左边表达式为空是才会执行。</p>
<p><strong>!!操作符:</strong><br>第三个选择是 NPE-lovers。我们可以用 b!! ，这会返回一个非空的 b 或者抛出一个 b 为空的 NPE:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val l = b !!.length()</span><br></pre></td></tr></table></figure></p>
<p><strong>安全转换:</strong><br>普通的转换可能产生 ClassCastException 异常。另一个选择就是使用安全转换，如果不成功就返回空：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val aInt: Int? = a as? Int</span><br></pre></td></tr></table></figure></p>
<p>##8.异常<br>所有的异常类都是 Exception 的子类。使用方式与Java类似。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">  // some code</span><br><span class="line">&#125;</span><br><span class="line">catch (e: SomeException) &#123;</span><br><span class="line">  // handler</span><br><span class="line">&#125;</span><br><span class="line">finally &#123;</span><br><span class="line">  // optional finally block</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##9.注解<br>注解是一种将元数据附加到代码中的方法。声明注解需要在类前面使用 annotation 关键字：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">annotation class fancy</span><br></pre></td></tr></table></figure></p>
<p>用法：在多数情形中 @ 标识是可选的。只有在注解表达式或本地声明中才必须<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@fancy class Foo &#123;</span><br><span class="line">    @fancy fun baz(@fancy foo: Int): Int &#123;</span><br><span class="line">        return (@fancy 1)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 可省略@</span><br><span class="line">fancy class Foo &#123;</span><br><span class="line">    fancy fun baz(fancy foo: Int): Int &#123;</span><br><span class="line">        @fancy fun bar() &#123; ... &#125;</span><br><span class="line">        return (@fancy 1)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果要给构造函数注解，就需要在构造函数声明时添加 constructor 关键字，并且需要在前面添加注解：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class Foo @inject constructor (dependency: MyDependency)</span><br></pre></td></tr></table></figure></p>
<p>注解可以有带参数的构造函数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">annotation class special(val why: String)</span><br><span class="line">special(&quot;example&quot;) class Foo &#123;&#125;</span><br></pre></td></tr></table></figure></p>
<p>注解也可以用在 Lambda 中。这将会应用到 lambda 生成的 invoke() 方法:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">annotation class Suspendable</span><br><span class="line">val f = @Suspendable &#123; Fiber.sleep(10) &#125;</span><br></pre></td></tr></table></figure></p>
<p>java 注解在 kotlin 中是完全兼容的。<br>如果java 中的 value 参数有数组类型，则在 kotlin 中变成 vararg 参数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// Java</span><br><span class="line">public @interface AnnWithArrayValue &#123;</span><br><span class="line">    String[] value();</span><br><span class="line">&#125;</span><br><span class="line">// Kotlin</span><br><span class="line">AnnWithArrayValue(&quot;abc&quot;, &quot;foo&quot;, &quot;bar&quot;) class C</span><br></pre></td></tr></table></figure></p>
<p>注解实例的值在 kotlin 代码中是暴露属性。</p>
<p>##10.反射<br>得到运行时的类引用:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val c = MyClass::class</span><br></pre></td></tr></table></figure></p>
<p>引用是一种 KClass类型的值。你可以使用<code>KClass.properties</code> 和<code>KClass.extensionProperties</code>获取类和父类的所有属性引用的列表。</p>
<p><strong>函数引用</strong><br>使用<code>::</code>操作符:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fun isOdd(x: Int) =x % 2 !=0</span><br><span class="line">val numbers = listOf(1, 2, 3)</span><br><span class="line">println(numbers.filter( ::isOdd) ) //prints [1, 3]</span><br></pre></td></tr></table></figure></p>
<p>这里<code>::isOdd</code>是是一个函数类型的值<code>(Int) -&gt; Boolean</code> </p>
<p>下面是返回一个由两个传递进去的函数的组合。现在你可以把它用在可调用的引用上了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fun compose&lt;A, B, C&gt;(f: (B) -&gt; C, g: (A) -&gt; B): (A) -&gt; C &#123;</span><br><span class="line">    return &#123;x -&gt; f(g(x))&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fun length(s: String) = s.size</span><br><span class="line">val oddLength = compose(::isOdd, ::length)</span><br><span class="line">val strings = listOf(&quot;a&quot;, &quot;ab&quot;, &quot;abc&quot;)</span><br><span class="line">println(strings.filter(oddLength)) // Prints &quot;[a, abc]&quot;</span><br></pre></td></tr></table></figure></p>
<p><strong>属性引用</strong><br>访问顶级类的属性，我们也可以使用<code>::</code>操作符：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var x = 1</span><br><span class="line">fun main(args: Array&lt;String&gt;) &#123;</span><br><span class="line">    println(::x.get())</span><br><span class="line">    ::x.set(2)</span><br><span class="line">    println(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>::x</code>表达式评估为<code>KProperty&lt;Int&gt;</code>类型的属性，它允许我们使用<code>get()</code>读它的值或者使用名字取回它的属性。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class A(val p: Int)</span><br><span class="line"></span><br><span class="line">fun main(args: Array&lt;String&gt;) &#123;</span><br><span class="line">    val prop = A::p</span><br><span class="line">    println(prop.get(A(1))) // prints &quot;1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于扩展属性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">val String.lastChar: Char</span><br><span class="line">  get() = this[size - 1]</span><br><span class="line"></span><br><span class="line">fun main(args: Array&lt;String&gt;) &#123;</span><br><span class="line">  println(String::lastChar.get(&quot;abc&quot;)) // prints &quot;c&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>与 java 反射调用</strong><br>想找到一个备用字段或者 java getter 方法:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import kotlin.reflect.jvm.*</span><br><span class="line"></span><br><span class="line">class A(val p: Int)</span><br><span class="line"></span><br><span class="line">fun main(args: Array&lt;String&gt;) &#123;</span><br><span class="line">    println(A::p.javaGetter) // prints &quot;public final int A.getP()&quot;</span><br><span class="line">    println(A::p.javaField)  // prints &quot;private final int A.p&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>构造函数引用</strong><br>只需要使用<code>::</code>操作符并加上类名。下面的函数是一个没有参数并且返回类型是<code>Foo</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">calss Foo</span><br><span class="line">fun function(factory : () -&gt; Foo) &#123;</span><br><span class="line">    val x: Foo = factory()</span><br><span class="line">&#125;</span><br><span class="line">function(:: Foo)</span><br></pre></td></tr></table></figure></p>
<p>##11. 动态类型<br>为了方便使用，<code>dynamic</code>应而生：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val dyn: dynamic = ...</span><br></pre></td></tr></table></figure></p>
<p><code>dynamic</code>类型关闭了 kotlin 的类型检查：</p>
<blockquote>
<p>这样的类型可以分配任意变量或者在任意的地方作为参数传递 任何值都可以分配为dynamic 类型，或者作为参数传递给任何接受 dynamic 类型参数的函数 这样的类型不做 null 检查</p>
</blockquote>
<p><code>dynamic</code>最奇特的特性就是可以在<code>dynamic</code>变量上调用任何属性或任何方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dyn.whatever(1, &quot;foo&quot;, dyn) // &apos;whatever&apos; is not defined anywhere</span><br><span class="line">dyn.whatever(*array(1, 2, 3))</span><br></pre></td></tr></table></figure></p>
<p>动态调用可以返回<code>dynamic</code>作为结果，因此我们可以轻松实现链式调用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dyn.foo().bar.bat()</span><br></pre></td></tr></table></figure></p>
<p>当给动态调用传递一个 lambda 表达式时，所有的参数默认都是<code>dynamic</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dyn.foo &#123;</span><br><span class="line">  x -&gt; x.bar() // x is dynamic</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>参考：</strong><br>1. <a href="http://kotlinlang.org/docs/reference/basic-syntax.html" target="_blank" rel="noopener">http://kotlinlang.org/docs/reference/basic-syntax.html</a><br>2. <a href="http://huanglizhuo.gitbooks.io/kotlin-in-chinese" target="_blank" rel="noopener">http://huanglizhuo.gitbooks.io/kotlin-in-chinese</a></p>
]]></content>
      
        
        <tags>
            
            <tag> kotlin </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Kotlin语法（函数和lambda表达式）]]></title>
      <url>/2015/09/11/Kotlin%E8%AF%AD%E6%B3%95%EF%BC%88%E5%87%BD%E6%95%B0%E5%92%8Clambda%E8%A1%A8%E8%BE%BE%E5%BC%8F%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>#三、函数和lambda表达式</p>
<p>##1. 函数声明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fun double(x: Int): Int &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>函数参数是用 Pascal 符号定义的　name:type。参数之间用逗号隔开，每个参数必须指明类型。函数参数可以有默认参数。这样相比其他语言可以减少重载。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fun read(b: Array&lt;Byte&gt;, off: Int = 0, len: Int = b.size() ) &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##2. 命名参数<br>在调用函数时可以参数可以命名。这对于有很多参数或只有一个的函数来说很方便。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fun reformat(str: String, normalizeCase: Boolean = true,upperCaseFirstLetter: Boolean = true,</span><br><span class="line">             divideByCamelHumps: Boolean = false,</span><br><span class="line">             wordSeparator: Char = &apos; &apos;) &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">reformat(str,</span><br><span class="line">    normalizeCase = true,</span><br><span class="line">    uppercaseFirstLetter = true,</span><br><span class="line">    divideByCamelHumps = false,</span><br><span class="line">    wordSeparator = &apos;_&apos;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure></p>
<p>##3. 变长参数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fun asList&lt;T&gt;(vararg ts: T): List&lt;T&gt; &#123;</span><br><span class="line">    val result = ArrayList&lt;T&gt;()</span><br><span class="line">    for (t in ts)</span><br><span class="line">        result.add(t)</span><br><span class="line">    return result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>传递一个 array 的内容给函数，我们就可以使用 * 前缀操作符：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val a = array(1, 2, 3)</span><br><span class="line">val list = asList(-1, 0, *a, 4)</span><br></pre></td></tr></table></figure></p>
<p>Kotlin 中可以在文件个根级声明函数，这就意味者你不用创建一个类来持有函数。除了顶级函数，Kotlin 函数可以声明为局部的，作为成员函数或扩展函数。<br>Kotlin 支持局部函数，比如在另一个函数使用另一函数。局部函数可以访问外部函数的局部变量(比如闭包)。局部函数甚至可以返回到外部函数</p>
<p>##4. 高阶函数<br>高阶函数就是可以接受函数作为参数并返回一个函数的函数。比如 lock() 就是一个很好的例子，它接收一个 lock 对象和一个函数，运行函数并释放 lock;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fun lock&lt;T&gt;(lock: Lock, body: () -&gt; T ) : T &#123;</span><br><span class="line">    lock.lock()</span><br><span class="line">    try &#123;</span><br><span class="line">        return body()</span><br><span class="line">    &#125;</span><br><span class="line">    finally &#123;</span><br><span class="line">        lock.unlock()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其实最方便的办法是传递一个字面函数(通常是 lambda 表达式)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val result = lock(lock, &#123; sharedResource.operation() &#125;)</span><br></pre></td></tr></table></figure></p>
<p>在 kotlin 中有一个约定，如果最后一个参数是函数，可以省略括号：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lock (lock) &#123;</span><br><span class="line">    sharedResource.operation()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##5. 字面函数</p>
<ul>
<li>字面函数被包在大括号里</li>
<li>参数在 -&gt; 前面声明(参数类型可以省略)</li>
<li>函数体在 -&gt; 之后</li>
</ul>
<p>字面函数或函数表达式就是一个 “匿名函数”，也就是没有声明的函数，但立即作为表达式传递下去。</p>
<p>##6. 函数类型<br>如：(T, T) -&gt; Boolean<br>注意如果一个函数接受另一个函数做为最后一个参数，该函数文本参数可以在括号内的参数列表外的传递。</p>
<p>##7. 函数文本语法<br>函数文本的完全写法是下面这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val sum = &#123;x: Int,y: Int -&gt; x + y&#125;</span><br></pre></td></tr></table></figure></p>
<p>函数文本总是在大括号里包裹着，在完全语法中参数声明是在括号内，类型注解是可选的，函数体是在　-&gt; 之后，像下面这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val sum: (Int, Int) -&gt; Int = &#123;x, y -&gt; x+y &#125;</span><br></pre></td></tr></table></figure></p>
<p>##8. 函数表达式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun(x: Int, y: Int ): Int = x + y</span><br></pre></td></tr></table></figure></p>
<p>##9. 内联函数<br>在高阶函数前增加inline注解可以指定函数內联。inline 标记即影响函数本身也影响传递进来的 lambda 函数：所有的这些都将被关联到调用点。<br>内联可能会引起生成代码增长，所以可以使用noinline来指定某些函数不进行內联。</p>
<p>注意有些内联函数可以调用传递进来的 lambda 函数，但不是在函数体，而是在另一个执行的上下文中，比如局部对象或者一个嵌套函数。在这样的情形中，非局部的控制流也不允许在lambda 函数中。为了表明，lambda 参数需要有 InlineOptions.ONLY_LOCAL_RETURN 注解</p>
<p><strong>参考：</strong><br>1. <a href="http://kotlinlang.org/docs/reference/basic-syntax.html" target="_blank" rel="noopener">http://kotlinlang.org/docs/reference/basic-syntax.html</a><br>2. <a href="http://huanglizhuo.gitbooks.io/kotlin-in-chinese" target="_blank" rel="noopener">http://huanglizhuo.gitbooks.io/kotlin-in-chinese</a></p>
]]></content>
      
        
        <tags>
            
            <tag> kotlin </tag>
            
            <tag> lambda </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Kotlin语法（类和对象）]]></title>
      <url>/2015/09/11/Kotlin%E8%AF%AD%E6%B3%95%EF%BC%88%E7%B1%BB%E5%92%8C%E5%AF%B9%E8%B1%A1%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>#二、类和对象：</p>
<p>##1. 类定义：<br>类的声明包含类名，类头(指定类型参数，主构造函数等等)，以及类主体，用大括号包裹。类头和类体是可选的；如果没有类体可以省略大括号。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class Invoice&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##2. 构造函数:<br>在 Kotlin 中类可以有一个主构造函数以及多个二级构造函数。主构造函数是类头的一部分：跟在类名后面(可以有可选的参数)。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class Person(val firstName: String, val lastName: String, var age: Int)&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>初始化代码可以放在以 init 做前缀的初始化块内：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Customer(name: String)&#123;</span><br><span class="line">    init &#123;</span><br><span class="line">        logger,info(&quot;Customer initialized with value $&#123;name&#125;&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果构造函数有注解或可见性声明，则 constructor 关键字是不可少的，并且注解应该在前：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class Customer public inject constructor (name: String) &#123;...&#125;</span><br></pre></td></tr></table></figure></p>
<p>##3. 二级构造函数:<br>前缀是 constructor：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Person &#123;</span><br><span class="line">    constructor(parent: Person) &#123;</span><br><span class="line">        parent.children.add(this)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果类有主构造函数，每个二级构造函数都要，或直接或间接通过另一个二级构造函数代理主构造函数。在同一个类中代理另一个构造函数使用 this 关键字：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Person(val name: String) &#123;</span><br><span class="line">    constructor (name: String, paret: Person) : this(name) &#123;</span><br><span class="line">        parent.children.add(this)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>没有声明构造函数，则有一个默认的无参构造函数。</p>
<p>##4. 创建类的实例:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val invoice = Invoice()</span><br><span class="line">val customer = Customer(&quot;Joe Smith&quot;)</span><br></pre></td></tr></table></figure></p>
<p>##5. 继承<br>所有类的基类：Any，类似Java中的Object</p>
<p>所有非抽象类默认都是不可继承的（java中的final），如果要被子类继承，需要使用<code>open</code>关键字（与java中的final功能相反），继承用<code>:</code>操作符。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">open class Base(p: Ont)</span><br><span class="line">class Derived(p: Int) : Base(p)</span><br></pre></td></tr></table></figure></p>
<p>方法如果要被重写，则也需要是<code>open</code>的，不想被重写就加<code>final</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">open class AnotherDerived() : Base() &#123;</span><br><span class="line">    final override fun v() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法重写规则：如果有多个相同的方法（继承或者实现自其他类，如A、B类），则必须要重写该方法，使用super范型去选择性地调用父类的实现。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">open class A &#123;</span><br><span class="line">    open fun f () &#123; print(&quot;A&quot;) &#125;</span><br><span class="line">    fun a() &#123; print(&quot;a&quot;) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface B &#123;</span><br><span class="line">    fun f() &#123; print(&quot;B&quot;) &#125; //接口的成员变量默认是 open 的</span><br><span class="line">    fun b() &#123; print(&quot;b&quot;) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class C() : A() , B&#123;</span><br><span class="line">    override fun f() &#123;</span><br><span class="line">        super&lt;A&gt;.f()//调用 A.f()</span><br><span class="line">        super&lt;B&gt;.f()//调用 B.f()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##6. 抽象类<br><code>abstract</code>关键字，抽象类和函数默认是<code>open</code>的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">open class Base &#123;</span><br><span class="line">    open fun f() &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abstract class Derived : Base() &#123;</span><br><span class="line">    override abstract fun f()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##7. 伴随对象<br>使用伴随对象可以直接使用类名来访问（用法类似Java中的static，但是不一样）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class MyClass &#123;</span><br><span class="line">    companion object &#123;</span><br><span class="line">        var BASE_URL: String = &quot;BASE_URL&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">println(&quot;BASE_URL: &quot; + MyClass.BASE_URL)</span><br></pre></td></tr></table></figure></p>
<p>与java的static不同，运行时它们仍然是真正对象的成员实例，比如可以实现接口：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">inerface Factory&lt;T&gt; &#123;</span><br><span class="line">    fun create(): T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyClass &#123;</span><br><span class="line">    companion object : Factory&lt;MyClass&gt; &#123;</span><br><span class="line">        override fun create(): MyClass = MyClass()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##8. Getter 和 Setter 函数<br>一般定义变量的时候有默认的getter/setter方法；如果使用$访问，则可以避开getter/setter方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var stringRepresentation: String</span><br><span class="line">    get() = this.toString()</span><br><span class="line">    set (value) &#123;</span><br><span class="line">        setDataFormString(value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>改变一个访问者的可见性或者注解它，可以不用改变默认的实现:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var settVisibilite: String = &quot;abc&quot;//非空类型必须初始化</span><br><span class="line">    private set // setter 是私有的并且有默认的实现</span><br><span class="line">var setterVithAnnotation: Any?</span><br><span class="line">    @Inject set // 用 Inject 注解 setter</span><br></pre></td></tr></table></figure></p>
<p>##9. 接口<br>可以包含抽象方法，以及方法的默认实现。可以有属性但必须是抽象的。一个类或对象可以实现一个或多个接口。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">interface MyInterface &#123;</span><br><span class="line">    fun bar()</span><br><span class="line">    fun foo() &#123;</span><br><span class="line">        //函数体是可选的</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接口属性不能赋值，需要被子类override：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">interface MyInterface &#123;</span><br><span class="line">    val property: Int //抽象属性</span><br><span class="line">    fun foo() &#123;</span><br><span class="line">        println(property)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Child : MyInterface &#123;</span><br><span class="line">    override val property: Int = 29</span><br><span class="line">&#125;</span><br><span class="line">输出：29</span><br></pre></td></tr></table></figure></p>
<p>##10. 可见性修饰词</p>
<ul>
<li>private: 只在该类(以及它的成员)中可见</li>
<li>protected: 和 private 一样但在子类中也可见</li>
<li>internal: 在本模块的所有可以访问该类的均可以访问该类的所有 internal 成员</li>
<li>public: 任何地方可见</li>
</ul>
<p>##11. 数据类<br>使用<code>data</code>关键词修饰类，则会自动添加<code>equals()/hashCode</code>, <code>toString</code>, <code>[compontN()functions]对应按声明顺序出现的所有属性</code>, <code>copy()</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data class User(val name: String, val age: Int)</span><br></pre></td></tr></table></figure></p>
<p>组件函数允许数据类在多重声明中使用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val jane = User(&quot;jane&quot;, 35)</span><br><span class="line">val (name, age) = jane</span><br><span class="line">println(&quot;$name, $age years of age&quot;)</span><br></pre></td></tr></table></figure></p>
<p>##12. 内部类<br>类可以标记为 inner 这样就可以访问外部类的成员。内部类拥有外部类的一个对象引用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Outer &#123;</span><br><span class="line">    private val bar: Int = 1</span><br><span class="line">    inner class Inner &#123;</span><br><span class="line">        fun foo() = bar</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">val demo = Outer().Inner().foo()</span><br></pre></td></tr></table></figure></p>
<p>##13. 对象表达式<br>类似Java的匿名内部类，可以继承/实现多个：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var zhangsan = object : Person(), MyInterface&#123;</span><br><span class="line">        override val property: Int = 512</span><br><span class="line"></span><br><span class="line">        override fun toString(): String &#123;</span><br><span class="line">            return &quot;toString() modified&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">println(zhangsan.toString())</span><br></pre></td></tr></table></figure></p>
<p>一个没有父类的对象，我们可以这样写：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val adHoc = object &#123;</span><br><span class="line">    var x: Int = 0</span><br><span class="line">    var y: Int = 0</span><br><span class="line">&#125;</span><br><span class="line">print(adHoc.x + adHoc.y)</span><br></pre></td></tr></table></figure></p>
<p>##14. 代理<br>类代理：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">interface Base &#123;</span><br><span class="line">    fun print()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class BaseImpl(val x: Int) : Base &#123;</span><br><span class="line">    override fun print() &#123; printz(x) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Derived(b: Base) : Base by b</span><br><span class="line"></span><br><span class="line">fun main() &#123;</span><br><span class="line">    val b = BaseImpl(10)</span><br><span class="line">    Derived(b).print()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>属性代理：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class Example &#123;</span><br><span class="line">    var p: String by Delegate()</span><br><span class="line">&#125;</span><br><span class="line">class Delegate &#123;</span><br><span class="line">    fun get(thisRef: Any?, prop: PropertyMetadata): String &#123;</span><br><span class="line">        return &quot;$thisRef, thank you for delegating &apos;$&#123;prop.name&#125;&apos; to me !&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fun set(thisRef: Any?, prop: PropertyMatada, value: String) &#123;</span><br><span class="line">        println(&quot;$value has been assigned to &apos;$&#123;prop.name&#125; in $thisRef.&apos;&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">val e = Example()</span><br><span class="line">pintln(e.p)</span><br><span class="line"></span><br><span class="line">输出：Example@33a17727, thank you for delegating ‘p’ to me!</span><br></pre></td></tr></table></figure></p>
<p><a href="http://huanglizhuo.gitbooks.io/kotlin-in-chinese/content/ClassesAndObjects/DelegationProperties.html" target="_blank" rel="noopener">标准代理</a></p>
<p><strong>参考：</strong><br>1. <a href="http://kotlinlang.org/docs/reference/basic-syntax.html" target="_blank" rel="noopener">http://kotlinlang.org/docs/reference/basic-syntax.html</a><br>2. <a href="http://huanglizhuo.gitbooks.io/kotlin-in-chinese" target="_blank" rel="noopener">http://huanglizhuo.gitbooks.io/kotlin-in-chinese</a></p>
]]></content>
      
        
        <tags>
            
            <tag> kotlin </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Kotlin语法（基础）]]></title>
      <url>/2015/09/11/Kotlin%E8%AF%AD%E6%B3%95%EF%BC%88%E5%9F%BA%E7%A1%80%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>#一、基础语法：</p>
<p>##1. 定义包名：<br>包名应该在源文件的最开头，包名不必和文件夹路径一致：源文件可以放在任意位置。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">package my.demo</span><br></pre></td></tr></table></figure></p>
<p>##2. 定义函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fun sum(a: Int , b: Int) : Int&#123;</span><br><span class="line">　　return a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>表达式函数体自动推断型的返回值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun sum(a: Int, b Int) = a + b</span><br></pre></td></tr></table></figure></p>
<p>要想函数在模块外面可见就必须有一个确定的返回值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public fun sum(a: Int, b: Int): Int = a + b</span><br></pre></td></tr></table></figure></p>
<p>Unit相当于Java中的void，可省略</p>
<p>##3. 定义变量：</p>
<ul>
<li><code>var a: Int = 1</code>，普通变量</li>
<li><code>val a: Int = 1</code>，只读变量，相当于Java中的final</li>
<li><code>var a = 1</code>，可推导出Int类型</li>
</ul>
<p>##4. 字符串模板<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fun main(args: Array&lt;String&gt;) &#123;</span><br><span class="line">    if (args.size() == 0) return</span><br><span class="line">    print(&quot;First argument: $&#123;args[0]&#125;&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>换行：\n</p>
<p>三个引号包(“””)裹的,不包含分割符并且可以包含其它字符：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val text = &quot;&quot;&quot;</span><br><span class="line">    for (c in &quot;foo&quot;)</span><br><span class="line">        print(c)</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure></p>
<p>###5. if语句<br>除了类似Java的用法，还可以当作表达式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun max(a: Int,  b: Int) = if (a &gt; b) a else b</span><br></pre></td></tr></table></figure></p>
<p>可直接返回if结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fun foo(param: Int)&#123;</span><br><span class="line">    val result = if (param == 1) &#123;</span><br><span class="line">        &quot;one&quot;</span><br><span class="line">    &#125; else if (param == 2) &#123;</span><br><span class="line">        &quot;two&quot;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &quot;three&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>###6. 可空变量以及空值检查<br>声明可空变量：<code>var a:Int? = null</code><br>函数返回可空：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fun parseInt(str : String): Int?&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用时自动检查null：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val files = File(&quot;Test&quot;).listFiles()</span><br><span class="line">println(files?.size)</span><br></pre></td></tr></table></figure></p>
<p>调用时自动检查null（可设置如果为null时的默认值）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val files = File(&quot;test&quot;).listFiles()</span><br><span class="line">println(files?.size ?: &quot;empty&quot;)</span><br></pre></td></tr></table></figure></p>
<p>如果为空执行某操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val data = ...</span><br><span class="line">val email = data[&quot;email&quot;] ?: throw</span><br><span class="line">IllegalStateException(&quot;Email is missing!&quot;)</span><br></pre></td></tr></table></figure></p>
<p>如果不为空执行某操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val date = ...</span><br><span class="line">data?.let&#123;</span><br><span class="line">    ...//如果不为空执行该语句块</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>###7. 使用值检查<br><code>is</code>：相当于Java中的instanceof, 是否是某个类型的实例。如果对一个不可变的局部变量属性检查是否是某种特定类型，就没有必要明确转换</p>
<p>###8. 循环<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for (arg in args)&#123;</span><br><span class="line">    print(arg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>While</code>等循环与Java一样</p>
<p>###9. When表达式<br>相当于Java中的switch case，但是更强大。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fun cases(obj: Any) &#123;</span><br><span class="line">    when (obj) &#123;</span><br><span class="line">    1    -&gt; print(&quot;one&quot;)</span><br><span class="line">    &quot;hello&quot;    -&gt; print(&quot;Greeting&quot;)</span><br><span class="line">    is Long    -&gt; print(&quot;Long&quot;)</span><br><span class="line">    ! is Long    -&gt; print(&quot;Not a string&quot;)</span><br><span class="line">    else    -&gt; print(&quot;Ubknow&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可直接返回when的判断结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fun transform(color: String): Int &#123;</span><br><span class="line">    return when(color) &#123;</span><br><span class="line">        &quot;Red&quot; -&gt; 0</span><br><span class="line">        &quot;Green&quot; -&gt; 1</span><br><span class="line">        &quot;Blue&quot; -&gt; 2</span><br><span class="line">        else -&gt; throw IllegalArgumentException(&quot;Invalid color param value&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>###10. ranges &amp; in<br>检查 in 操作符检查数值是否在某个范围内（同样适用于集合）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (x in 1..100)&#123;</span><br><span class="line">    print(&quot;$&#123;x&#125; in 1~100&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (x !in 1..100)&#123;</span><br><span class="line">    print(&quot;$&#123;x&#125; not in 1~100&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 in 操作符检查集合中是否包含某个对象：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if (text in names) //将会调用nemes.contains(text)方法</span><br><span class="line">    print(&quot;Yes)</span><br></pre></td></tr></table></figure></p>
<p>遍历 map：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for ((k, v) in map) &#123;</span><br><span class="line">    print(&quot;$k -&gt; $v&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>###11. 函数默认值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun foo(a: Int = 0, b: String = &quot;&quot;) &#123;...&#125;</span><br></pre></td></tr></table></figure></p>
<p>###12. 过滤 list<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val positives = list.filter &#123; x -&gt; x &gt;0 &#125;</span><br></pre></td></tr></table></figure></p>
<p>或者更短：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val positives = list.filter &#123; it &gt; 0 &#125;</span><br></pre></td></tr></table></figure></p>
<p>###13. 只读 list/map<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val list = listOf(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)</span><br></pre></td></tr></table></figure></p>
<p>或者：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val map = maoOf(&quot;a&quot; to 1, &quot;b&quot; to 2, &quot;c&quot; to 3)</span><br></pre></td></tr></table></figure></p>
<p>获取map中的值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">println(map[&quot;key&quot;])</span><br><span class="line">map[&quot;key&quot;] = value</span><br></pre></td></tr></table></figure></p>
<p>###14. 扩展函数(给现有类增添新函数)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fun String.spcaceToCamelCase() &#123; ... &#125;</span><br><span class="line">&quot;Convert this to camelcase&quot;.spcaceToCamelCase()</span><br></pre></td></tr></table></figure></p>
<h3 id="15-创建单例模式"><a href="#15-创建单例模式" class="headerlink" title="15. 创建单例模式"></a>15. 创建单例模式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">object Resource &#123;</span><br><span class="line">    val name = &quot;Name&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="16-try-catch"><a href="#16-try-catch" class="headerlink" title="16. try-catch"></a>16. try-catch</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    count()</span><br><span class="line">&#125;catch (e: ArithmeticException) &#123;</span><br><span class="line">    throw IllegaStateException(e)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可直接返回try-catch结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fun test() &#123;</span><br><span class="line">    val result = try &#123;</span><br><span class="line">        count()</span><br><span class="line">    &#125;catch (e: ArithmeticException) &#123;</span><br><span class="line">        throw IllegaStateException(e)</span><br><span class="line">    &#125;</span><br><span class="line">    //处理 result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="17-返回与跳转"><a href="#17-返回与跳转" class="headerlink" title="17. 返回与跳转"></a>17. 返回与跳转</h3><p>return break 结束最近的闭合循环 continue 跳到最近的闭合循环的下一次循环。</p>
<p>使用标签快速跳转：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">loop@ for(i in 1..5)&#123;</span><br><span class="line">        println(&quot;-i: $i&quot;)</span><br><span class="line">        for(j in 11..17)&#123;</span><br><span class="line">            if(14 == j)&#123;</span><br><span class="line">                break@loop</span><br><span class="line">            &#125;</span><br><span class="line">            println(&quot;-&gt; j: $j&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-i: 1</span><br><span class="line">-&gt; j: 11</span><br><span class="line">-&gt; j: 12</span><br><span class="line">-&gt; j: 13</span><br></pre></td></tr></table></figure></p>
<p>break 是跳转标签后面的表达式，continue 是跳转到循环的下一次迭代。<br><br>return 允许我们返回到外层函数。最重要的例子就是从字面函数中返回。</p>
<p><strong>参考：</strong><br>1. <a href="http://kotlinlang.org/docs/reference/basic-syntax.html" target="_blank" rel="noopener">http://kotlinlang.org/docs/reference/basic-syntax.html</a><br>2. <a href="http://huanglizhuo.gitbooks.io/kotlin-in-chinese" target="_blank" rel="noopener">http://huanglizhuo.gitbooks.io/kotlin-in-chinese</a></p>
]]></content>
      
        
        <tags>
            
            <tag> kotlin </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]使用Kotlin+Anko开发Android（一）]]></title>
      <url>/2015/09/11/Android-%E4%BD%BF%E7%94%A8Kotlin-Anko%E5%BC%80%E5%8F%91Android%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>Kotlin是由JetBrains开发并且开源的静态类型JVM语言。比Java语言语法简洁，支持很多Java中不支持的语法特性，如高阶函数、內联函数、null安全、灵活扩展、操作符重载等等。而且它还完全兼容Java，与Scala类似，但是Scala的宗旨是&ldquo;尽可能自己实现，不得已才使用Java&rdquo;，而Kotlin却相反：&ldquo;尽可能复用Java的实现，不得已才自己实现&rdquo;。所以相比之下Kotlin更简洁轻量，非常适合移动端的开发。另外JetBrains针对Android开发提供了一个由Kotlin实现的&ldquo;anko&rdquo;开源库，可以让你使用DSL的方式直接用代码编写UI，让你从繁琐的xml中解脱出来，而且避免了xml解析过程所带来的性能问题。</p>
<p>&nbsp;</p>
<p>这篇先讲怎么去使用idea（Android Studio用户也一样）搭建Kotlin的Android开发环境。</p>
<p>&nbsp;</p>
<p><span style="font-size: 15px;"><strong>一、下载以下相关idea插件：</strong></span></p>
<p>1. Kotlin</p>
<p>2. Kotlin Extensions For Android</p>
<p>3. Anko DSL Preview</p>
<p>其中Anko DSL Preview插件用于预览使用DSL编写的UI代码，就像以前使用xml编写UI文件时可以动态在&ldquo;Preview&rdquo;窗口预览效果一样。</p>
<p>&nbsp;</p>
<p><span style="font-size: 15px;"><strong>二、新建Android项目</strong></span></p>
<p>在src/main目录下，新建kotlin目录（用于放置kotlin代码），配置Gradle如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">buildscript {<br></span><span style="color: #008080;"> 2</span>     ext.kotlin_version = ‘0.12.1230’<br><span style="color: #008080;"> 3</span> <span style="color: #000000;">    repositories {<br></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">        mavenCentral()<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    dependencies {<br></span><span style="color: #008080;"> 7</span>         classpath ‘com.android.tools.build:gradle:1.1.1’<br><span style="color: #008080;"> 8</span>         classpath “org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version”<br><span style="color: #008080;"> 9</span>         classpath “org.jetbrains.kotlin:kotlin-android-extensions:$kotlin_version”<br><span style="color: #008080;">10</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">12</span> apply plugin: ‘com.android.application’<br><span style="color: #008080;">13</span> apply plugin: ‘kotlin-android’<br><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> <span style="color: #000000;">repositories {<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">    mavenCentral()<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> <span style="color: #000000;">android {<br></span><span style="color: #008080;">20</span>     compileSdkVersion 22<br><span style="color: #008080;">21</span>     buildToolsVersion “22.0.1”<br><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> <span style="color: #000000;">    defaultConfig {<br></span><span style="color: #008080;">24</span>         applicationId “com.wangjie.androidwithkotlin”<br><span style="color: #008080;">25</span>         minSdkVersion 9<br><span style="color: #008080;">26</span>         targetSdkVersion 22<br><span style="color: #008080;">27</span>         versionCode 1<br><span style="color: #008080;">28</span>         versionName “1.0”<br><span style="color: #008080;">29</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span> <span style="color: #000000;">    sourceSets {<br></span><span style="color: #008080;">32</span>         main.java.srcDirs += ‘src/main/kotlin’<br><span style="color: #008080;">33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">34</span><br><span style="color: #008080;">35</span> <span style="color: #000000;">    buildTypes {<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">        release {<br></span><span style="color: #008080;">37</span>             minifyEnabled <span style="color: #0000ff;">false</span><br><span style="color: #008080;">38</span>             proguardFiles getDefaultProguardFile(‘proguard-android.txt’), ‘proguard-rules.pro’<br><span style="color: #008080;">39</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">41</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">42</span><br><span style="color: #008080;">43</span> <span style="color: #000000;">dependencies {<br></span><span style="color: #008080;">44</span>     compile fileTree(dir: ‘libs’, include: [‘*.jar’<span style="color: #000000;">])<br></span><span style="color: #008080;">45</span>     compile ‘com.android.support:appcompat-v7:22.2.0’<br><span style="color: #008080;">46</span>     compile “org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version”<br><span style="color: #008080;">47</span>     compile “org.jetbrains.kotlin:kotlin-reflect:$kotlin_version”<br><span style="color: #008080;">48</span>     compile ‘org.jetbrains.anko:anko:0.6.3-15’<br><span style="color: #008080;">49</span> }</pre><br></div>

<p>然后sync &amp; build。</p>
<p>&nbsp;</p>
<p><span style="font-size: 15px;"><strong>三、配置Kotlin</strong></span></p>
<p>调用&ldquo;Configuring Kotlin in the project&rdquo;这个Action</p>
<p><img src="http://kotlinlang.org/assets/images/tutorials//kotlin-android/configure-kotlin-in-project.png" alt=""></p>
<p><img src="http://kotlinlang.org/assets/images/tutorials//kotlin-android/configure-kotlin-in-project-details.png" alt=""></p>
<p>&nbsp;</p>
<p><span style="font-size: 15px;"><strong>四、把Java代码一键转成kotlin代码</strong></span></p>
<p>打开要转换的Java文件，调用&ldquo;Convert Java File to Kotlin File&rdquo;这个Action即可。</p>
<p><img src="http://kotlinlang.org/assets/images/tutorials//kotlin-android/convert-java-to-kotlin.png" alt=""></p>
<p>转换之前的Java代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> ActionBarActivity {<br><br>    @Override<br>    </span><span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br>        </span><span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onCreateOptionsMenu(Menu menu) {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Inflate the menu; this adds items to the action bar if it is present.</span><br><span style="color: #000000;">        getMenuInflater().inflate(R.menu.menu_main, menu);<br>        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onOptionsItemSelected(MenuItem item) {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Handle action bar item clicks here. The action bar will<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> automatically handle clicks on the Home/Up button, so long<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> as you specify a parent activity in AndroidManifest.xml.</span><br>        <span style="color: #0000ff;">int</span> id =<span style="color: #000000;"> item.getItemId();<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">noinspection SimplifiableIfStatement</span><br>        <span style="color: #0000ff;">if</span> (id ==<span style="color: #000000;"> R.id.action_settings) {<br>            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>        }<br><br>        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">super</span><span style="color: #000000;">.onOptionsItemSelected(item);<br>    }<br>}</span></pre><br></div>

<p>转换之后的Kotlin代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> MainActivity : ActionBarActivity() {<br><br>    override fun onCreate(savedInstanceState: Bundle</span>?<span style="color: #000000;">) {<br>        </span><span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState)<br>        setContentView(R.layout.activity_main)<br>    }<br><br>    override fun onCreateOptionsMenu(menu: Menu</span>?<span style="color: #000000;">): Boolean {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Inflate the menu; this adds items to the action bar if it is present.</span><br><span style="color: #000000;">        getMenuInflater().inflate(R.menu.menu_main, menu)<br>        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;"><br>    }<br><br>    override fun onOptionsItemSelected(item: MenuItem</span>?<span style="color: #000000;">): Boolean {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Handle action bar item clicks here. The action bar will<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> automatically handle clicks on the Home/Up button, so long<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> as you specify a parent activity in AndroidManifest.xml.</span><br>        val id = item!!<span style="color: #000000;">.getItemId()<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">noinspection SimplifiableIfStatement</span><br>        <span style="color: #0000ff;">if</span> (id ==<span style="color: #000000;"> R.id.action_settings) {<br>            </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;"><br>        }<br><br>        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">super</span><span style="color: #000000;">.onOptionsItemSelected(item)<br>    }<br>}</span></pre><br></div>

<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> kotlin </tag>
            
            <tag> anko </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Kotlin：Android世界的Swift]]></title>
      <url>/2015/09/09/Kotlin%EF%BC%9AAndroid%E4%B8%96%E7%95%8C%E7%9A%84Swift/</url>
      <content type="html"><![CDATA[<p>转自：<a href="http://www.infoq.com/cn/news/2015/06/Android-JVM-JetBrains-Kotlin" target="_blank" rel="noopener">http://www.infoq.com/cn/news/2015/06/Android-JVM-JetBrains-Kotlin</a></p>
<p><a href="http://kotlinlang.org/" target="_blank" rel="noopener">Kotlin</a>是一门与Swift类似的静态类型JVM语言，由<a href="https://www.jetbrains.com/" target="_blank" rel="noopener">JetBrains</a>设计开发并<a href="https://github.com/jetbrains/kotlin" target="_blank" rel="noopener">开源</a>。与Java相比，Kotlin的语法更简洁、更具表达性，而且提供了更多的特性，比如，高阶函数、操作符重载、字符串模板。它与Java高度可互操作，可以同时用在一个项目中。</p>
<p><a href="http://kotlinlang.org/docs/reference/faq.html" target="_blank" rel="noopener">按照JetBrains的说法</a>，根据他们多年的Java平台开发经验，他们认为Java编程语言有一定的局限性和问题，而且由于需要向后兼容，它们不可能或很难得到解决。因此，他们创建了Kotlin项目，主要目标是：</p>
<ul>
<li>创建一种兼容Java的语言</li>
<li>编译速度至少同Java一样快</li>
<li>比Java更安全</li>
<li>比Java更简洁</li>
<li>比最成熟的竞争者Scala还简单</li>
</ul>
<p><a href="http://tutsplus.com/authors/ashraff-hathibelagal" target="_blank" rel="noopener">Ashraff Hathibelagal</a>是一名喜欢研究新框架和SDK的独立开发者。近日，他<a href="http://code.tutsplus.com/tutorials/an-introduction-to-kotlin--cms-24051" target="_blank" rel="noopener">撰文</a>介绍了Kotlin的一些语法。按照他的说法，一个合格的Java程序员可以在很短的时间内学会使用Kotlin。</p>
<p><strong>类与构造函数</strong></p>
<p>Kotlin创建类的方式与Java类似，比如下面的代码创建了一个有三个属性的<code>Person</code>类：</p>
<pre><code>class Person{
    var name: String = &quot;&quot;
    var age: Int = 0
    var college: String? = null
}
`&lt;/pre&gt;

可以看到，Kotlin的变量声明方式略有些不同。在Kotline中，声明变量必须使用关键字`var`，而如果要创建一个只读/只赋值一次的变量，则需要使用`val`代替它。另外，为了实现&amp;ldquo;空安全（null safety）&amp;rdquo;，Kotlin对可以为空的变量和不可以为空的变量作了区分。在上述代码中，变量`name`和`age`不可为空，而`？`表明变量`college`可以为空。定义完类之后，创建实例就非常简单了：

&lt;pre&gt;`var jake = Person()
`&lt;/pre&gt;

注意，Kotlin没有关键字`new`。实例创建完成后，就可以像在Java中一样为变量赋值了：

&lt;pre&gt;`jake.name = &quot;Jake Hill&quot;
jake.age = 24
jake.college = &quot;Stephen&apos;s College&quot;
`&lt;/pre&gt;

变量可以采用上述方式赋值，也可以通过构造函数赋值，但后者是一种更好的编码实践。在Kotlin中，创建这样的一个构造函数非常简单：

&lt;pre&gt;`class Person(var name: String, var age: Int, var college: String?) {
}
`&lt;/pre&gt;

而实际上，由于构造函数中没有其它操作，所以花括号也可以省略，代码变得相当简洁：

&lt;pre&gt;`class Person(var name: String, var age: Int, var college: String?)

var jake = Person(&quot;Jake Hill&quot;, 24, &quot;Stephen&apos;s College&quot;)
`&lt;/pre&gt;

上述代码中的构造函数是类头的一部分，称为主构造函数。在Kotlin中，还可以使用`constructor`关键字创建辅助构造函数，例如，下面的代码增加了一个辅助构造函数初始化变量`email`：

&lt;pre&gt;`class Person(var name: String, var age: Int, var college: String?) {

    var email: String = &quot;&quot;

    constructor(name:String, age:Int, college: String?, email: String) : this(name, age, college) {
        this.email = email
    }
}
`&lt;/pre&gt;

Kotlin允许创建派生类，但要遵循如下规则：
</code></pre><ul>
<li>必须使用<code>：</code>代替Java中的<code>extends</code>关键字</li>
<li>基类头必须有<code>open</code>注解</li>
<li><p>基类必须有一个带参数的构造函数，派生类要在它自己的头中初始化那些参数</p>
<p>比如下面的代码创建了一个名为<code>Empoyee</code>的派生类：</p>
<pre>`open class Person(var name: String, var age: Int, var college: String?) {
    ...
}

class Employee(name: String, age: Int, college: String?, var company: String) : Person(name, age, college) {
}
`</pre>

<p><strong>函数与扩展</strong></p>
<p>有派生就有重载。与类的派生一样，允许重载的方法要有<code>open</code>注解，而在派生类中重载时要使用<code>override</code>注解。例如，下面是在<code>Employee</code>类中重载<code>Person</code>类的<code>isEligibleToVote</code>方法的代码：</p>
<pre>`override fun isEligibleToVote(): Boolean {
    return true
}
`</pre>

<p>除了改变类的已有行为，Kotlin还允许开发者在不修改类的原始定义的情况下实现对类的扩展，如下面的代码为<code>Person</code>类增加了一个名为<code>isTeenager</code>的扩展：</p>
<pre>`fun Person.isTeenager(): Boolean {
    return age in 13..19
}
`</pre>

<p>在需要扩展来自其它项目的类时，这个特性特别有用。</p>
<p>上面提到的函数都与Java中的函数类似，但Kotlin还支持其它类型的函数。如果一个函数返回单个表达式的值，那么可以使用<code>=</code>来定义函数。下面是一个创建单表达式函数的例子：</p>
<pre>`fun isOctogenarian(): Boolean = age in 80 .. 89
`</pre>

<p>Kotlin还支持高阶函数和Lambda表达式。例如，lambda表达式<code>{x,y-&amp;gt;x+y}</code>可以像下面这样给一个变量赋值：</p>
<pre>`val sumLambda: (Int, Int) -&gt; Int = {x,y -&gt; x+y}
`</pre>

<p>而下面的高阶函数将上述表达式作为一个参数，并将表达式的计算结果翻倍：</p>
<pre>`fun doubleTheResult(x:Int, y:Int, f:(Int, Int)-&gt;Int): Int {
    return f(x,y) * 2
}
`</pre>

<p>该函数可以使用下面的其中一种方式调用：</p>
<pre>`val result1 = doubleTheResult(3, 4, sumLambda)
`</pre>

<p>或</p>
<pre>`val result2 = doubleTheResult(3, 4, {x,y -&gt; x+y})
`</pre>

<p><strong>范围表达式</strong></p>
<p>在Kotlin中，范围表达式用的比较多。范围创建只需要<code>..</code>操作符，例如：</p>
<pre>`val r1 = 1..5
//该范围包含数值1,2,3,4,5
`</pre>

<p>如果创建一个降序范围，则需要使用<code>downTo</code>函数，例如：</p>
<pre>`val r2 = 5 downTo 1
//该范围包含数值5,4,3,2,1
`</pre>

<p>如果步长不是1，则需要使用<code>step</code>函数，例如：</p>
<pre>`val r3 = 5 downTo 1 step 2
//该范围包含数值5,3,1
`</pre>

<p><strong>条件结构</strong></p>
<p>在Kotlin中，if是一个表达式，根据条件是否满足返回不同的值，例如，下面的代码将<code>isEligibleToVote</code>设置为&ldquo;Yes&rdquo;</p>
<pre>`var age = 20
val isEligibleToVote = if(age &gt; 18) "Yes" else "No"
`</pre>

<p><code>when</code>表达式相当于Java的<code>switch</code>，但功能更强大，例如，下面的代码将<code>typeOfPerson</code>设置为&ldquo;Teenager&rdquo;：</p>
<pre>`val age = 17

val typeOfPerson = when(age){
    0 -&gt; "New born"
    in 1..12 -&gt; "Child"
    in 13..19 -&gt; "Teenager"
    else -&gt; "Adult"
}
`</pre>

<p><strong>循环结构</strong></p>
<p>Kotlin使用<code>for..in</code>遍历数组、集合及其它提供了迭代器的数据结构，语法同Java几乎完全相同，只是用<code>in</code>操作符取代了<code>:</code>操作符，例如，下面的代码将遍历一个<code>String</code>对象数组：</p>
<pre>`val names = arrayOf("Jake", "Jill", "Ashley", "Bill")

for (name in names) {
    println(name)
}
`</pre>

<p><code>while</code>和<code>do..while</code>循环的语法与Java完全相同。</p>
<p><strong>字符串模板</strong></p>
<p>Kotlin允许在字符串中嵌入变量和表达式，例如：</p>
<p><pre>`val name = “Bob”<br>println(“My name is ${name}”) //打印”My name is Bob”</pre></p>
<p>val a = 10<br>val b = 20<br>println(“The sum is ${a+b}”) //打印”The sum is 30”</p>
</li>
</ul>
<p>此外，Kotlin与Java高度可互操作。Kotlin可以用一种自然的方式调用现有的Java代码，而Java也很容易调用Kotlin代码。同时，Kotlin也可以与JavaScript互操作。</p>
<p>上面介绍的只是Kotlin的一些基本语法和特性，更多细节请查阅<a href="http://kotlinlang.org/docs/reference/" target="_blank" rel="noopener">官方文档</a>。事实上，到目前为止，Kotlin还仍然只是一个预览版本，接下来的几个月中还会有多项重大改进及新增特性。尽管如此，<a href="https://github.com/search?q=Kotlin&amp;ref=cmdform" target="_blank" rel="noopener">GitHub上已有400多个与Kotlin项目相关的库</a>。</p>
<p>在另外一篇<a href="http://code.tutsplus.com/tutorials/how-to-use-kotlin-in-your-android-projects--cms-24052" target="_blank" rel="noopener">文章</a>中，Hathibelagal写道，&ldquo;如果你正在为Android开发寻找一种替代编程语言，那么应该试下Kotlin。它很容易在Android项目中替代Java或者同Java一起使用。&rdquo;想要了解如何在Android Studio中使用Kotlin开发Android项目的读者，可以读下这篇文章。</p>
]]></content>
      
        
        <tags>
            
            <tag> kotlin </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]Android端ORM框架——RapidORM(v1.0)]]></title>
      <url>/2015/08/21/Android-Android%E7%AB%AFORM%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94RapidORM-v1-0/</url>
      <content type="html"><![CDATA[<p>Android上主流的ORM框架有很多，常用的有ORMLite、GreenDao等。</p>
<p>ORMLite：</p>
<p>－优点：API很友好，使用比较方便简单稳定，相关功能比较完整。</p>
<p>－缺点：内部使用反射实现，性能并不是很好。</p>
<p>GreenDao：</p>
<p>－优点：性能很不错，</p>
<p>－缺点：API却不太友好，而且不支持复合主键，主键必须要有并且必须是long或者Long。持久类可以用它提供的模版生成，但是一旦使用了它的模版，持久类、DAO就不能随意去修改，扩展性不是很好。如果不使用它的模版，代码写起来就很繁琐。</p>
<p>&nbsp;</p>
<p>所以结合了两者重新写了一个ORM：<strong><a href="https://github.com/wangjiegulu/RapidORM" target="_blank" rel="noopener">RapidORM</a></strong>（<a href="https://github.com/wangjiegulu/RapidORM" target="_blank" rel="noopener"><strong>https://github.com/wangjiegulu/RapidORM</strong></a>）</p>
<p>特点：</p>
<p>1. 支持使用反射和非反射（模版生成）两种方式实现执行SQL。</p>
<p>2. 支持复合主键</p>
<p>3. 支持任何主键类型</p>
<p>4. 兼容android原生的&nbsp;<span style="color: #000000; background-color: #e1e1e1;">android.database.sqlite.SQLiteDatabase</span>&nbsp;和SqlCipher的 <span style="background-color: #e1e1e1;">net.sqlcipher.database.SQLiteDatabase</span>。<span style="background-color: #e1e1e1;"><br></span></p>
<p>缺点：</p>
<p>1. 不支持链表查询。</p>
<p>&nbsp;</p>
<p><span style="font-size: 18px;"><strong>快速指南：</strong></span></p>
<p><strong><span style="font-size: 14px;">一、新建持久类Person：</span></strong></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">  Date: 6/25/15.<br></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 6</span> @Table(propertyClazz = PersonProperty.<span style="color: #0000ff;">class</span><span style="color: #000000;">)<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Person <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Serializable{<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>     @Column(primaryKey = <span style="color: #0000ff;">true</span><span style="color: #000000;">)<br></span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Integer id;<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span>     @Column(primaryKey = <span style="color: #0000ff;">true</span><span style="color: #000000;">)<br></span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Integer typeId;<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> <span style="color: #000000;">    @Column<br></span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String name;<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span> <span style="color: #000000;">    @Column<br></span><span style="color: #008080;">19</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Integer age;<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> <span style="color: #000000;">    @Column<br></span><span style="color: #008080;">22</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String address;<br></span><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span> <span style="color: #000000;">    @Column<br></span><span style="color: #008080;">25</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Long birth;<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span> <span style="color: #000000;">    @Column<br></span><span style="color: #008080;">28</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Boolean student;<br></span><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> getter/setter…</span><br><span style="color: #008080;">31</span><br><span style="color: #008080;">32</span> }</pre><br></div>

<p>&nbsp;</p>
<p><span style="line-height: 1.5;">1. Table注解用于标记这个类需要映射到数据表，RapidORM会创建这个表。</span></p>
<p>－name属性：表示对应表的名称，默认为类的simpleName。</p>
<p>－propertyClazz属性：表示如果不使用反射执行sql时，需要的ModelProperty类的Class，RapidORM会自动在这个ModelProperty中去绑定需要执行SQL的数据。不填写则表示使用默认的反射的方式执行SQL。具体后面会讲到。</p>
<p>2. Column注解用语标记这个字段映射到的数据表的列（如果）。</p>
<p>－name属性：表示对应列的名称。默认为字段的名称。</p>
<p>－primaryKey属性：表示改列是否是主键，默认是false。（可以在多个字段都适用这个属性，表示为复合主键）。</p>
<p>－autoincrement属性：表示主键是否是自增长，只有该字段是主键并且只有一个主键并且是Integer或int类型才会生效。</p>
<p>－defaultValue属性：表示该列默认值。</p>
<p>－notNull属性：表示该列不能为空。</p>
<p>－unique属性：表示该列唯一约束。</p>
<p>－uniqueCombo属性：暂未实现。</p>
<p>－index属性：暂未实现。</p>
<p>&nbsp;</p>
<p><strong><span style="font-size: 14px;">二、注册持久类，并指定SQLiteOpenHelper：</span></strong></p>
<p>新建类DatabaseFactory，继承RapidORMConnection：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">  Date: 6/25/15.<br></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> DatabaseFactory <span style="color: #0000ff;">extends</span> RapidORMConnection&lt;RapidORMDefaultSQLiteOpenHelperDelegate&gt;<span style="color: #000000;"> {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> VERSION = 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> DatabaseFactory instance;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> DatabaseFactory getInstance() {<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> instance) {<br></span><span style="color: #008080;">13</span>             instance = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DatabaseFactory();<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">15</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> instance;<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> DatabaseFactory() {<br></span><span style="color: #008080;">19</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">();<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">23</span>     <span style="color: #0000ff;">protected</span><span style="color: #000000;"> RapidORMDefaultSQLiteOpenHelperDelegate getRapidORMDatabaseOpenHelper(@NonNull String databaseName) {<br></span><span style="color: #008080;">24</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> RapidORMDefaultSQLiteOpenHelperDelegate(<span style="color: #0000ff;">new</span><span style="color: #000000;"> MyDatabaseOpenHelper(MyApplication.getInstance(), databaseName, VERSION));<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">28</span>     <span style="color: #0000ff;">protected</span> List&lt;Class&lt;?&gt;&gt;<span style="color: #000000;"> registerAllTableClass() {<br></span><span style="color: #008080;">29</span>         List&lt;Class&lt;?&gt;&gt; allTableClass = <span style="color: #0000ff;">new</span> ArrayList&lt;&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">30</span>         allTableClass.add(Person.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;">31</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> all table class</span><br><span style="color: #008080;">32</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> allTableClass;<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">34</span> }</pre><br></div>

<p>DatabaseFactory推荐使用单例，实现RapidORMConnection的getRapidORMDatabaseOpenHelper()方法，该方法需要返回一个RapidORMDatabaseOpenHelperDelegate或者它的子类对象，RapidORMDatabaseOpenHelperDelegate是SQLiteOpenHelper的委托，因为需要兼容android原生的&nbsp;<span style="background-color: #e1e1e1;">android.database.sqlite.SQLiteDatabase</span>&nbsp;和SqlCipher的&nbsp;<span style="background-color: #e1e1e1;">net.sqlcipher.database.SQLiteDatabase</span> 两种方式。</p>
<p>如果使用&nbsp;<span style="background-color: #e1e1e1;">android.database.sqlite.SQLiteDatabase</span>&nbsp;，则可以使用RapidORMDefaultSQLiteOpenHelperDelegate，然后构造方法中传入真正的<span style="background-color: #e1e1e1;">android.database.sqlite.SQLiteDatabase</span>&nbsp;（也就是这里的MyDatabaseOpenHelper）即可，使用SqlCipher的方式后面再讲。</p>
<p>还需要实现registerAllTableClass()方法，这里返回一个所有需要映射表的持久类Class集合。</p>
<p>&nbsp;</p>
<p><strong><span style="font-size: 14px;">三、在需要的地方进行初始化RapidORM（比如在登录完成之后）：</span></strong></p>
<div class="cnblogs_code"><br><pre>DatabaseFactory.getInstance().resetDatabase(“hello_rapid_orm.db”);</pre><br></div>

<p>如上，调用resetDatabase()方法即可初始化数据库。</p>
<p>&nbsp;</p>
<p><strong>四、编写Dao：</strong></p>
<p>新建PersonDaoImpl继承BaseDaoImpl&lt;Person&gt;（这里简略了PersonDao接口）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">  Date: 6/26/15.<br></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> PersonDaoImpl <span style="color: #0000ff;">extends</span> BaseDaoImpl&lt;Person&gt;<span style="color: #000000;"> {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> PersonDaoImpl() {<br></span><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">super</span>(Person.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> }</pre><br></div>

<p>BaseDaoImpl中默认实现了下面的基本方法（T为范型，指具体的持久类）：</p>
<p>－void insert(T model) throws Exception;　　//&nbsp;插入一条数据。</p>
<p>－void update(T model) throws Exception;　　//&nbsp;更新一条数据。</p>
<p>－void delete(T model) throws Exception;　　// 删除一条数据。</p>
<p>－void deleteAll() throws Exception;　　　　　　// 删除表中所有的数据</p>
<p>－void insertOrReplace(T model) throws Exception;　　　　// 删除或者替换（暂不支持）</p>
<p>－List&lt;T&gt; queryAll() throws Exception;　　　　　　// 查询表中所有数据</p>
<p>－List&lt;T&gt; rawQuery(String sql, String[] selectionArgs) throws Exception;　　　　　　// 使用原生sql查询表中所有的数据</p>
<p>－void rawExecute(String sql, Object[] bindArgs) throws Exception;　　　　　　　　// 使用原生sql执行一条sql语句</p>
<p>－void insertInTx(T… models) throws Exception;　　　　　　　　　　// 插入多条数据（在一个事务中）</p>
<p>－void insertInTx(Iterable&lt;T&gt; models) throws Exception;　　　　　　// 同上</p>
<p>－void updateInTx(T… models) throws Exception;　　　　　　　　　　// 更新多条数据（在一个事务中）</p>
<p>－void updateInTx(Iterable&lt;T&gt; models) throws Exception;　　　　　　// 同上</p>
<p>－void deleteInTx(T… models) throws Exception;　　　　　　　　　　　　// 删除多条数据（在一个事务中）</p>
<p>－void deleteInTx(Iterable&lt;T&gt; models) throws Exception;　　　　　　　　// 同上</p>
<p>－void executeInTx(RapidORMSQLiteDatabaseDelegate db, RapidOrmFunc1 func1) throws Exception;&nbsp;// 执行一个方法（可多个sql），在一个事务中</p>
<p>－void executeInTx(RapidOrmFunc1 func1) throws Exception;　　　　// 同上</p>
<p>&nbsp;</p>
<p><span style="font-size: 15px;"><strong>面向对象的方式使用Where和Builder来构建sql语句：</strong></span></p>
<p><strong>1. Where：</strong></p>
<p>Where表示一系列的条件语句，含义与SQL中的where关键字一致。</p>
<p>支持的where操作：</p>
<p>－eq(String column, Object value)　　　　//&nbsp;相等条件判断</p>
<p>－ne(String column, Object value)　　　　// 不相等条件判断</p>
<p>－gt(String column, Object value)　　　　 // 大于条件判断</p>
<p>－lt(String column, Object value)　　　　　// 小于条件判断</p>
<p>－ge(String column, Object value)　　　　 //&nbsp;大于等于条件</p>
<p>－le(String column, Object value)　　　　　// 小于等于条件</p>
<p>－in(String column, Object… values)　　　 // 包含条件</p>
<p>－ni(String column, Object… values)　　　 // 不包含条件</p>
<p>－isNull(String column)　　　　　　　　　　//&nbsp;null条件判断</p>
<p>－notNull(String column)　　　　　　　　　// 不为null条件判断</p>
<p>－between(String column, Object value1, Object value2)　　//&nbsp;BETWEEN … AND …” condition</p>
<p>－like(String column, Object value)　　　　　　// 模糊匹配条件</p>
<p>－Where raw(String rawWhere, Object… values)　　// 原生sql条件</p>
<p>－and(Where… wheres)　　　　　　　　　　// 多个Where与</p>
<p>－or(Where… wheres)　　　　　　　　　　// 多个Where或</p>
<p>&nbsp;</p>
<p>Where举例：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #000000;">    Where.and(<br></span><span style="color: #008080;">2</span>                 Where.like(PersonProperty.name.column, “%wangjie%”<span style="color: #000000;">),<br></span><span style="color: #008080;">3</span>                 Where.lt(PersonProperty.id.column, 200<span style="color: #000000;">),<br></span><span style="color: #008080;">4</span> <span style="color: #000000;">                Where.or(<br></span><span style="color: #008080;">5</span>                         Where.between(PersonProperty.age.column, 19, 39<span style="color: #000000;">),<br></span><span style="color: #008080;">6</span> <span style="color: #000000;">                        Where.isNull(PersonProperty.address.column)<br></span><span style="color: #008080;">7</span> <span style="color: #000000;">                ),<br></span><span style="color: #008080;">8</span>                 Where.eq(PersonProperty.typeId.column, 1<span style="color: #000000;">)<br></span><span style="color: #008080;">9</span>         )</pre><br></div>

<p>如上，</p>
<p>Line2条件：name模糊匹配wangjie</p>
<p>Line3条件：id小于200</p>
<p>Line5条件：age在19到39之间</p>
<p>Line6条件：address不是null</p>
<p>Line8条件：typeId等于1</p>
<p>Line4条件：Line5条件和Line6条件是or关系；</p>
<p>Line1条件：Line2、Line3、Line4、Line8条件是and关系。</p>
<p>&nbsp;</p>
<p><strong>2. QueryBuilder：</strong></p>
<p>QueryBuilder用于构建查询语句。</p>
<p>－setWhere(Where where)　　　　// 设置Where条件；</p>
<p>－setLimit(Integer limit)　　　　　　// 设置limit</p>
<p>－addSelectColumn(String… selectColumn)　　　　// 设置查询的数据列名（可以调用多遍来设置多个，默认是查询所有数据）</p>
<p>－addOrder(String column, boolean isAsc)　　　　　// 设置查询结果的排序（可以调用多遍来设置多个）</p>
<p>&nbsp;</p>
<p>QueryBuilder举例：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span>     <span style="color: #0000ff;">public</span> List&lt;Person&gt; findPersonsByWhere() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {<br></span><span style="color: #008080;"> 2</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> queryBuilder()<br></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">                .addSelectColumn(PersonProperty.id.column, PersonProperty.typeId.column, PersonProperty.name.column,<br></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">                        PersonProperty.age.column, PersonProperty.birth.column, PersonProperty.address.column)<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">                .setWhere(Where.and(<br></span><span style="color: #008080;"> 6</span>                         Where.like(PersonProperty.name.column, “%wangjie%”<span style="color: #000000;">),<br></span><span style="color: #008080;"> 7</span>                         Where.lt(PersonProperty.id.column, 200<span style="color: #000000;">),<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">                        Where.or(<br></span><span style="color: #008080;"> 9</span>                                 Where.between(PersonProperty.age.column, 19, 39<span style="color: #000000;">),<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">                                Where.isNull(PersonProperty.address.column)<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">                        ),<br></span><span style="color: #008080;">12</span>                         Where.eq(PersonProperty.typeId.column, 1<span style="color: #000000;">)<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">                ))<br></span><span style="color: #008080;">14</span>                 .addOrder(PersonProperty.id.column, <span style="color: #0000ff;">false</span><span style="color: #000000;">)<br></span><span style="color: #008080;">15</span>                 .addOrder(PersonProperty.name.column, <span style="color: #0000ff;">true</span><span style="color: #000000;">)<br></span><span style="color: #008080;">16</span>                 .setLimit(10<span style="color: #000000;">)<br></span><span style="color: #008080;">17</span>                 .query(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">18</span>     }</pre><br></div>

<p>如上，通过queryBuilder()方法构建一个QueryBuilder，并设置查询的列名、Where、排序、limit等参数，最后调用query()执行查询。</p>
<p>&nbsp;</p>
<p><strong>3. UpdateBuilder：</strong></p>
<p>UpdateBuilder用于构建更新语句。</p>
<p>－setWhere(Where where)　　　　// 设置Where条件；</p>
<p>－addUpdateColumn(String column, Object value)　　　　// 添加需要更新的字段；</p>
<p>&nbsp;</p>
<p>UpdateBuilder举例：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> updatePerson() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {<br></span><span style="color: #008080;"> 2</span>         <span style="color: #0000ff;">long</span> now =<span style="color: #000000;"> System.currentTimeMillis();<br></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">        updateBuilder()<br></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">                .setWhere(Where.and(<br></span><span style="color: #008080;"> 5</span>                         Where.like(PersonProperty.name.column, “%wangjie%”<span style="color: #000000;">),<br></span><span style="color: #008080;"> 6</span>                         Where.lt(PersonProperty.id.column, 200<span style="color: #000000;">),<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">                        Where.or(<br></span><span style="color: #008080;"> 8</span>                                 Where.between(PersonProperty.age.column, 19, 39<span style="color: #000000;">),<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">                                Where.isNull(PersonProperty.address.column)<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">                        ),<br></span><span style="color: #008080;">11</span>                         Where.eq(PersonProperty.typeId.column, 1<span style="color: #000000;">)<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">                ))<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">                .addUpdateColumn(PersonProperty.birth.column, now)<br></span><span style="color: #008080;">14</span>                 .addUpdateColumn(PersonProperty.address.column, “address_” + now).update(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">15</span>     }</pre><br></div>

<p>如上，通过updateBuilder()方法构建一个UpdateBuilder，并设置要更新的字段，最后调用update()执行查询。</p>
<p>&nbsp;</p>
<p><strong>4. DeleteBuilder：&nbsp;</strong></p>
<p>DeleteBuilder用于构建删除语句。</p>
<p>－setWhere(Where where)　　　　// 设置Where条件；</p>
<p>&nbsp;</p>
<p>DeleteBuilder举例：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> deletePerson() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">        deleteBuilder()<br></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">                .setWhere(Where.and(<br></span><span style="color: #008080;"> 4</span>                         Where.like(PersonProperty.name.column, “%wangjie%”<span style="color: #000000;">),<br></span><span style="color: #008080;"> 5</span>                         Where.lt(PersonProperty.id.column, 200<span style="color: #000000;">),<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">                        Where.or(<br></span><span style="color: #008080;"> 7</span>                                 Where.between(PersonProperty.age.column, 19, 39<span style="color: #000000;">),<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">                                Where.isNull(PersonProperty.address.column)<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">                        ),<br></span><span style="color: #008080;">10</span>                         Where.eq(PersonProperty.typeId.column, 1<span style="color: #000000;">)<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">                ))<br></span><span style="color: #008080;">12</span>                 .delete(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">13</span>     }</pre><br></div>

<p>如上，通过deleteBuilder()方法构建一个DeleteBuilder，并设置Where条件，最后调用delete()执行查询。</p>
<p>&nbsp;</p>
<p><span style="font-size: 15px;"><strong>使用模版生成ModelProperty：</strong></span></p>
<p>如果你打算使用非反射的方式执行sql，则可以使用ModelPropertyGenerator模版来生成</p>
<p>1. 新建一个类，在main方法中执行：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  Author: wangjie<br> <em> Email: tiantian.china.2@gmail.com
 </em> Date: 7/2/15.<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> MyGenerator {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {<br><br>        Class tableClazz </span>= Person.<span style="color: #0000ff;">class</span><span style="color: #000000;">;<br>        </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> ModelPropertyGenerator().generate(tableClazz,<br>                </span>“example/src/main/java”<span style="color: #000000;">,<br>                tableClazz.getPackage().getName() </span>+ “.config”<span style="color: #000000;">);<br><br>    }<br><br>}</span></pre><br></div>

<p>如上，generate()方法参数如下：</p>
<p>generate(Class tableClazz, String outerDir, String packageName)</p>
<p>参数一：要生成的Property持久类的Class</p>
<p>参数二：生成的ModelProperty类文件存放目录</p>
<p>参数三：生成的ModelProperty类文件的包名</p>
<p>执行完毕后，就会在com.wangjie.rapidorm.example.database.model.config包下生成如下的ModelProperty：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">//</span><span style="color: #008000;"> THIS CODE IS GENERATED BY RapidORM, DO NOT EDIT.</span><br><span style="color: #008080;">  2</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">  3</span> <span style="color: #008000;"> Property of Person<br></span><span style="color: #008080;">  4</span> <span style="color: #008000;">*/</span><br><span style="color: #008080;">  5</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> PersonProperty <span style="color: #0000ff;">implements</span> IModelProperty&lt;Person&gt;<span style="color: #000000;"> {<br></span><span style="color: #008080;">  6</span><br><span style="color: #008080;">  7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> ModelFieldMapper id = <span style="color: #0000ff;">new</span> ModelFieldMapper(0, “id”, “id”<span style="color: #000000;">);<br></span><span style="color: #008080;">  8</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> ModelFieldMapper typeId = <span style="color: #0000ff;">new</span> ModelFieldMapper(1, “typeId”, “typeId”<span style="color: #000000;">);<br></span><span style="color: #008080;">  9</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> ModelFieldMapper name = <span style="color: #0000ff;">new</span> ModelFieldMapper(2, “name”, “name”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 10</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> ModelFieldMapper age = <span style="color: #0000ff;">new</span> ModelFieldMapper(3, “age”, “age”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 11</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> ModelFieldMapper address = <span style="color: #0000ff;">new</span> ModelFieldMapper(4, “address”, “address”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 12</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> ModelFieldMapper birth = <span style="color: #0000ff;">new</span> ModelFieldMapper(5, “birth”, “birth”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 13</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> ModelFieldMapper student = <span style="color: #0000ff;">new</span> ModelFieldMapper(6, “student”, “student”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 14</span><br><span style="color: #008080;"> 15</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> PersonProperty() {<br></span><span style="color: #008080;"> 16</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 17</span><br><span style="color: #008080;"> 18</span><br><span style="color: #008080;"> 19</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> bindInsertArgs(Person model, List&lt;Object&gt;<span style="color: #000000;"> insertArgs) {<br></span><span style="color: #008080;"> 21</span>         Integer id =<span style="color: #000000;"> model.getId();<br></span><span style="color: #008080;"> 22</span>         insertArgs.add(<span style="color: #0000ff;">null</span> == id ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : id);<br></span><span style="color: #008080;"> 23</span><br><span style="color: #008080;"> 24</span>         Integer typeId =<span style="color: #000000;"> model.getTypeId();<br></span><span style="color: #008080;"> 25</span>         insertArgs.add(<span style="color: #0000ff;">null</span> == typeId ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : typeId);<br></span><span style="color: #008080;"> 26</span><br><span style="color: #008080;"> 27</span>         String name =<span style="color: #000000;"> model.getName();<br></span><span style="color: #008080;"> 28</span>         insertArgs.add(<span style="color: #0000ff;">null</span> == name ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : name);<br></span><span style="color: #008080;"> 29</span><br><span style="color: #008080;"> 30</span>         Integer age =<span style="color: #000000;"> model.getAge();<br></span><span style="color: #008080;"> 31</span>         insertArgs.add(<span style="color: #0000ff;">null</span> == age ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : age);<br></span><span style="color: #008080;"> 32</span><br><span style="color: #008080;"> 33</span>         String address =<span style="color: #000000;"> model.getAddress();<br></span><span style="color: #008080;"> 34</span>         insertArgs.add(<span style="color: #0000ff;">null</span> == address ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : address);<br></span><span style="color: #008080;"> 35</span><br><span style="color: #008080;"> 36</span>         Long birth =<span style="color: #000000;"> model.getBirth();<br></span><span style="color: #008080;"> 37</span>         insertArgs.add(<span style="color: #0000ff;">null</span> == birth ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : birth);<br></span><span style="color: #008080;"> 38</span><br><span style="color: #008080;"> 39</span>         Boolean student =<span style="color: #000000;"> model.isStudent();<br></span><span style="color: #008080;"> 40</span>         insertArgs.add(<span style="color: #0000ff;">null</span> == student ? <span style="color: #0000ff;">null</span> : student ? 1 : 0<span style="color: #000000;">);<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 43</span><br><span style="color: #008080;"> 44</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 45</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> bindUpdateArgs(Person model, List&lt;Object&gt;<span style="color: #000000;"> updateArgs) {<br></span><span style="color: #008080;"> 46</span>         String name =<span style="color: #000000;"> model.getName();<br></span><span style="color: #008080;"> 47</span>         updateArgs.add(<span style="color: #0000ff;">null</span> == name ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : name);<br></span><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span>         Integer age =<span style="color: #000000;"> model.getAge();<br></span><span style="color: #008080;"> 50</span>         updateArgs.add(<span style="color: #0000ff;">null</span> == age ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : age);<br></span><span style="color: #008080;"> 51</span><br><span style="color: #008080;"> 52</span>         String address =<span style="color: #000000;"> model.getAddress();<br></span><span style="color: #008080;"> 53</span>         updateArgs.add(<span style="color: #0000ff;">null</span> == address ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : address);<br></span><span style="color: #008080;"> 54</span><br><span style="color: #008080;"> 55</span>         Long birth =<span style="color: #000000;"> model.getBirth();<br></span><span style="color: #008080;"> 56</span>         updateArgs.add(<span style="color: #0000ff;">null</span> == birth ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : birth);<br></span><span style="color: #008080;"> 57</span><br><span style="color: #008080;"> 58</span>         Boolean student =<span style="color: #000000;"> model.isStudent();<br></span><span style="color: #008080;"> 59</span>         updateArgs.add(<span style="color: #0000ff;">null</span> == student ? <span style="color: #0000ff;">null</span> : student ? 1 : 0<span style="color: #000000;">);<br></span><span style="color: #008080;"> 60</span><br><span style="color: #008080;"> 61</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 62</span><br><span style="color: #008080;"> 63</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 64</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> bindPkArgs(Person model, List&lt;Object&gt;<span style="color: #000000;"> pkArgs) {<br></span><span style="color: #008080;"> 65</span>         Integer id =<span style="color: #000000;"> model.getId();<br></span><span style="color: #008080;"> 66</span>         pkArgs.add(<span style="color: #0000ff;">null</span> == id ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : id);<br></span><span style="color: #008080;"> 67</span><br><span style="color: #008080;"> 68</span>         Integer typeId =<span style="color: #000000;"> model.getTypeId();<br></span><span style="color: #008080;"> 69</span>         pkArgs.add(<span style="color: #0000ff;">null</span> == typeId ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : typeId);<br></span><span style="color: #008080;"> 70</span><br><span style="color: #008080;"> 71</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 72</span><br><span style="color: #008080;"> 73</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 74</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Person parseFromCursor(Cursor cursor) {<br></span><span style="color: #008080;"> 75</span>         Person model = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Person();<br></span><span style="color: #008080;"> 76</span>         <span style="color: #0000ff;">int</span><span style="color: #000000;"> index;<br></span><span style="color: #008080;"> 77</span>         index = cursor.getColumnIndex(“id”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 78</span>         <span style="color: #0000ff;">if</span>(-1 !=<span style="color: #000000;"> index){<br></span><span style="color: #008080;"> 79</span>             model.setId(cursor.isNull(index) ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : (cursor.getInt(index)));<br></span><span style="color: #008080;"> 80</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 81</span><br><span style="color: #008080;"> 82</span>         index = cursor.getColumnIndex(“typeId”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 83</span>         <span style="color: #0000ff;">if</span>(-1 !=<span style="color: #000000;"> index){<br></span><span style="color: #008080;"> 84</span>             model.setTypeId(cursor.isNull(index) ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : (cursor.getInt(index)));<br></span><span style="color: #008080;"> 85</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 86</span><br><span style="color: #008080;"> 87</span>         index = cursor.getColumnIndex(“name”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 88</span>         <span style="color: #0000ff;">if</span>(-1 !=<span style="color: #000000;"> index){<br></span><span style="color: #008080;"> 89</span>             model.setName(cursor.isNull(index) ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : (cursor.getString(index)));<br></span><span style="color: #008080;"> 90</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 91</span><br><span style="color: #008080;"> 92</span>         index = cursor.getColumnIndex(“age”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 93</span>         <span style="color: #0000ff;">if</span>(-1 !=<span style="color: #000000;"> index){<br></span><span style="color: #008080;"> 94</span>             model.setAge(cursor.isNull(index) ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : (cursor.getInt(index)));<br></span><span style="color: #008080;"> 95</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 96</span><br><span style="color: #008080;"> 97</span>         index = cursor.getColumnIndex(“address”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 98</span>         <span style="color: #0000ff;">if</span>(-1 !=<span style="color: #000000;"> index){<br></span><span style="color: #008080;"> 99</span>             model.setAddress(cursor.isNull(index) ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : (cursor.getString(index)));<br></span><span style="color: #008080;">100</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">101</span><br><span style="color: #008080;">102</span>         index = cursor.getColumnIndex(“birth”<span style="color: #000000;">);<br></span><span style="color: #008080;">103</span>         <span style="color: #0000ff;">if</span>(-1 !=<span style="color: #000000;"> index){<br></span><span style="color: #008080;">104</span>             model.setBirth(cursor.isNull(index) ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : (cursor.getLong(index)));<br></span><span style="color: #008080;">105</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">106</span><br><span style="color: #008080;">107</span>         index = cursor.getColumnIndex(“student”<span style="color: #000000;">);<br></span><span style="color: #008080;">108</span>         <span style="color: #0000ff;">if</span>(-1 !=<span style="color: #000000;"> index){<br></span><span style="color: #008080;">109</span>             model.setStudent(cursor.isNull(index) ? <span style="color: #0000ff;">null</span> : (cursor.getInt(index) == 1<span style="color: #000000;">));<br></span><span style="color: #008080;">110</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">111</span><br><span style="color: #008080;">112</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> model;<br></span><span style="color: #008080;">113</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">114</span><br><span style="color: #008080;">115</span> }</pre><br></div>

<p>注意：此Property类一旦生成，则不能修改；如果该持久类相关的注解属性改变，则需要重新生成这个Property类。</p>
<p>2. 在相应的持久类的@Table注解中设置propertyClazz：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> @Table(propertyClazz = PersonProperty.<span style="color: #0000ff;">class</span><span style="color: #000000;">)<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Person <span style="color: #0000ff;">implements</span> Serializable{</pre><br></div>

<p>&nbsp;</p>
<p><span style="font-size: 16px;"><strong>如何兼容SqlCipher</strong></span></p>
<p>1. 新建MySQLCipherOpenHelper，继承net.sqlcipher.database.SQLiteOpenHelper：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.rapidorm.core.dao.DatabaseProcessor;<br></span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.rapidorm.core.delegate.database.RapidORMSQLiteDatabaseDelegate;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> net.sqlcipher.database.SQLiteDatabase;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> net.sqlcipher.database.SQLiteDatabaseHook;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> net.sqlcipher.database.SQLiteOpenHelper;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 9</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;">10</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">11</span> <span style="color: #008000;">  Date: 8/17/15.<br></span><span style="color: #008080;">12</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MySQLCipherOpenHelper <span style="color: #0000ff;">extends</span><span style="color: #000000;"> SQLiteOpenHelper {<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> RapidORMSQLiteDatabaseDelegate rapidORMSQLiteDatabaseDelegate;<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span> MySQLCipherOpenHelper(Context context, String name, <span style="color: #0000ff;">int</span><span style="color: #000000;"> version) {<br></span><span style="color: #008080;">18</span>         <span style="color: #0000ff;">super</span>(context, name, <span style="color: #0000ff;">null</span><span style="color: #000000;">, version);<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span> MySQLCipherOpenHelper(Context context, String name, SQLiteDatabase.CursorFactory factory, <span style="color: #0000ff;">int</span><span style="color: #000000;"> version) {<br></span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, name, factory, version);<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span>     <span style="color: #0000ff;">public</span> MySQLCipherOpenHelper(Context context, String name, SQLiteDatabase.CursorFactory factory, <span style="color: #0000ff;">int</span><span style="color: #000000;"> version, SQLiteDatabaseHook hook) {<br></span><span style="color: #008080;">26</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, name, factory, version, hook);<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">30</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(SQLiteDatabase db) {<br></span><span style="color: #008080;">31</span> <span style="color: #008000;">//</span><span style="color: #008000;">        super.onCreate(db);</span><br><span style="color: #008080;">32</span>         rapidORMSQLiteDatabaseDelegate = <span style="color: #0000ff;">new</span><span style="color: #000000;"> MySQLCipherDatabaseDelegate(db);<br></span><span style="color: #008080;">33</span>         DatabaseProcessor databaseProcessor =<span style="color: #000000;"> DatabaseProcessor.getInstance();<br></span><span style="color: #008080;">34</span>         <span style="color: #0000ff;">for</span> (Class&lt;?&gt;<span style="color: #000000;"> tableClazz : databaseProcessor.getAllTableClass()) {<br></span><span style="color: #008080;">35</span>             databaseProcessor.createTable(rapidORMSQLiteDatabaseDelegate, tableClazz, <span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">37</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">38</span><br><span style="color: #008080;">39</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">40</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onUpgrade(SQLiteDatabase db, <span style="color: #0000ff;">int</span> oldVersion, <span style="color: #0000ff;">int</span><span style="color: #000000;"> newVersion) {<br></span><span style="color: #008080;">41</span> <span style="color: #008000;">//</span><span style="color: #008000;">        super.onUpgrade(db, oldVersion, newVersion);</span><br><span style="color: #008080;">42</span>         rapidORMSQLiteDatabaseDelegate = <span style="color: #0000ff;">new</span><span style="color: #000000;"> MySQLCipherDatabaseDelegate(db);<br></span><span style="color: #008080;">43</span>         DatabaseProcessor databaseProcessor =<span style="color: #000000;"> DatabaseProcessor.getInstance();<br></span><span style="color: #008080;">44</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> todo: dev only!!!!!</span><br><span style="color: #008080;">45</span> <span style="color: #000000;">        databaseProcessor.dropAllTable(rapidORMSQLiteDatabaseDelegate);<br></span><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">48</span> }</pre><br></div>

<p>&nbsp;</p>
<p>2. 新建MySQLCipherDatabaseDelegate继承RapidORMSQLiteDatabaseDelegate，并实现以下的方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.Cursor;<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.SQLException;<br></span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.rapidorm.core.delegate.database.RapidORMSQLiteDatabaseDelegate;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> net.sqlcipher.database.SQLiteDatabase;<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 7</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;"> 8</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 9</span> <span style="color: #008000;">  Date: 8/17/15.<br></span><span style="color: #008080;">10</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MySQLCipherDatabaseDelegate <span style="color: #0000ff;">extends</span> RapidORMSQLiteDatabaseDelegate&lt;SQLiteDatabase&gt;<span style="color: #000000;"> {<br></span><span style="color: #008080;">12</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> MySQLCipherDatabaseDelegate(SQLiteDatabase db) {<br></span><span style="color: #008080;">13</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(db);<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> execSQL(String sql) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> SQLException {<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">        db.execSQL(sql);<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">22</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isDbLockedByCurrentThread() {<br></span><span style="color: #008080;">23</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> db.isDbLockedByCurrentThread();<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">25</span><br><span style="color: #008080;">26</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">27</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> execSQL(String sql, Object[] bindArgs) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">        db.execSQL(sql, bindArgs);<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">32</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Cursor rawQuery(String sql, String[] selectionArgs) {<br></span><span style="color: #008080;">33</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> db.rawQuery(sql, selectionArgs);<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">35</span><br><span style="color: #008080;">36</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">37</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> beginTransaction() {<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">        db.beginTransaction();<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">42</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setTransactionSuccessful() {<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">        db.setTransactionSuccessful();<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">45</span><br><span style="color: #008080;">46</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">47</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> endTransaction() {<br></span><span style="color: #008080;">48</span> <span style="color: #000000;">        db.endTransaction();<br></span><span style="color: #008080;">49</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">50</span><br><span style="color: #008080;">51</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">52</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> close() {<br></span><span style="color: #008080;">53</span> <span style="color: #000000;">        db.close();<br></span><span style="color: #008080;">54</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">55</span> }</pre><br></div>

<p>注意这里的import，这里的SQLiteDatabase需要导入&nbsp;<span style="background-color: #d8d8d8;">net.sqlcipher.database.SQLiteDatabase</span>&nbsp;。</p>
<p>&nbsp;</p>
<p>3. 新建MySQLCipherOpenHelperDelegate继承RapidORMDatabaseOpenHelperDelegate，实现如下方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.rapidorm.core.delegate.openhelper.RapidORMDatabaseOpenHelperDelegate;<br></span><span style="color: #008080;"> 2</span> <span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 5</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;"> 6</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 7</span> <span style="color: #008000;">  Date: 6/18/15.<br></span><span style="color: #008080;"> 8</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MySQLCipherOpenHelperDelegate <span style="color: #0000ff;">extends</span> RapidORMDatabaseOpenHelperDelegate&lt;MySQLCipherOpenHelper, MySQLCipherOpenHelperDelegate&gt;<span style="color: #000000;"> {<br></span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> MySQLCipherOpenHelperDelegate(MySQLCipherOpenHelper sqLiteOpenHelper) {<br></span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(sqLiteOpenHelper);<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String SECRET_KEY = “1234567890abcdef”<span style="color: #000000;">;<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> MySQLCipherOpenHelperDelegate getReadableDatabase() {<br></span><span style="color: #008080;">18</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> MySQLCipherDatabaseDelegate(openHelper.getReadableDatabase(SECRET_KEY));<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">22</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> MySQLCipherOpenHelperDelegate getWritableDatabase() {<br></span><span style="color: #008080;">23</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> MySQLCipherDatabaseDelegate(openHelper.getWritableDatabase(SECRET_KEY));<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">25</span><br><span style="color: #008080;">26</span> }</pre><br></div>

<p>&nbsp;</p>
<p>4. 在DatabaseFactory中使用SqlCipher版本：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">  Date: 6/25/15.<br></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> DatabaseFactory <span style="color: #0000ff;">extends</span> RapidORMConnection&lt;MySQLCipherOpenHelperDelegate&gt;<span style="color: #000000;"> {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> VERSION = 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> DatabaseFactory instance;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> DatabaseFactory getInstance() {<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> instance) {<br></span><span style="color: #008080;">13</span>             instance = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DatabaseFactory();<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">15</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> instance;<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> DatabaseFactory() {<br></span><span style="color: #008080;">19</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">();<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">23</span>     <span style="color: #0000ff;">protected</span><span style="color: #000000;"> MySQLCipherOpenHelperDelegate getRapidORMDatabaseOpenHelper(@NonNull String databaseName) {<br></span><span style="color: #008080;">24</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> MySQLCipherOpenHelperDelegate(<span style="color: #0000ff;">new</span><span style="color: #000000;"> MySQLCipherOpenHelper(applicationContext, databaseName, VERSION));<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">28</span>     <span style="color: #0000ff;">protected</span> List&lt;Class&lt;?&gt;&gt;<span style="color: #000000;"> registerAllTableClass() {<br></span><span style="color: #008080;">29</span>         List&lt;Class&lt;?&gt;&gt; allTableClass = <span style="color: #0000ff;">new</span> ArrayList&lt;&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">30</span>         allTableClass.add(Person.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;">31</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> register all table class here…</span><br><span style="color: #008080;">32</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> allTableClass;<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">34</span> }</pre><br></div>

<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> library </tag>
            
            <tag> sqlite </tag>
            
            <tag> database </tag>
            
            <tag> orm </tag>
            
            <tag> rapidorm </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]基于RxJava、RxAndroid的EventBus实现]]></title>
      <url>/2015/06/15/Android-%E5%9F%BA%E4%BA%8ERxJava%E3%80%81RxAndroid%E7%9A%84EventBus%E5%AE%9E%E7%8E%B0/</url>
      <content type="html"><![CDATA[<p><strong><span style="line-height: 1.5;">Github：<a href="https://github.com/wangjiegulu/RxAndroidEventsSample" target="_blank" rel="noopener">https://github.com/wangjiegulu/RxAndroidEventsSample</a></span></strong></p>
<p>EventBus的作用是发布/订阅事件总线，因为项目中用到RxJava、RxAndroid，所以完全可以使用RxJava、RxAndroid来实现EventBus。</p>
<p>&nbsp;</p>
<p>1. 编写RxBus，用于存储所有事件Subjects。</p>
<p>事件是传递的最小单位，可以把任何类作为一个事件。</p>
<p>RxBus代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">  Date: 6/11/15.<br></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> RxBus {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = RxBus.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> RxBus instance;<br></span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">boolean</span> DEBUG = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">synchronized</span><span style="color: #000000;"> RxBus get() {<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> instance) {<br></span><span style="color: #008080;">13</span>             instance = <span style="color: #0000ff;">new</span><span style="color: #000000;"> RxBus();<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">15</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> instance;<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> RxBus() {<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>     <span style="color: #0000ff;">private</span> ConcurrentHashMap&lt;Object, List&lt;Subject&gt;&gt; subjectMapper = <span style="color: #0000ff;">new</span> ConcurrentHashMap&lt;&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span>     @SuppressWarnings(“unchecked”<span style="color: #000000;">)<br></span><span style="color: #008080;">24</span>     <span style="color: #0000ff;">public</span> &lt;T&gt; Observable&lt;T&gt; register(@NonNull Object tag, @NonNull Class&lt;T&gt;<span style="color: #000000;"> clazz) {<br></span><span style="color: #008080;">25</span>         List&lt;Subject&gt; subjectList =<span style="color: #000000;"> subjectMapper.get(tag);<br></span><span style="color: #008080;">26</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> subjectList) {<br></span><span style="color: #008080;">27</span>             subjectList = <span style="color: #0000ff;">new</span> ArrayList&lt;&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">            subjectMapper.put(tag, subjectList);<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span>         Subject&lt;T, T&gt;<span style="color: #000000;"> subject;<br></span><span style="color: #008080;">32</span>         subjectList.add(subject =<span style="color: #000000;"> PublishSubject.create());<br></span><span style="color: #008080;">33</span>         <span style="color: #0000ff;">if</span> (DEBUG) Log.d(TAG, “[register]subjectMapper: “ +<span style="color: #000000;"> subjectMapper);<br></span><span style="color: #008080;">34</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> subject;<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">36</span><br><span style="color: #008080;">37</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> unregister(@NonNull Object tag, @NonNull Observable observable) {<br></span><span style="color: #008080;">38</span>         List&lt;Subject&gt; subjects =<span style="color: #000000;"> subjectMapper.get(tag);<br></span><span style="color: #008080;">39</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> subjects) {<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">            subjects.remove((Subject) observable);<br></span><span style="color: #008080;">41</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (ABTextUtil.isEmpty(subjects)) {<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">                subjectMapper.remove(tag);<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">45</span><br><span style="color: #008080;">46</span>         <span style="color: #0000ff;">if</span> (DEBUG) Log.d(TAG, “[unregister]subjectMapper: “ +<span style="color: #000000;"> subjectMapper);<br></span><span style="color: #008080;">47</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">48</span><br><span style="color: #008080;">49</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> post(@NonNull Object content) {<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">        post(content.getClass().getName(), content);<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">52</span><br><span style="color: #008080;">53</span>     @SuppressWarnings(“unchecked”<span style="color: #000000;">)<br></span><span style="color: #008080;">54</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> post(@NonNull Object tag, @NonNull Object content) {<br></span><span style="color: #008080;">55</span>         List&lt;Subject&gt; subjectList =<span style="color: #000000;"> subjectMapper.get(tag);<br></span><span style="color: #008080;">56</span><br><span style="color: #008080;">57</span>         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">ABTextUtil.isEmpty(subjectList)) {<br></span><span style="color: #008080;">58</span>             <span style="color: #0000ff;">for</span><span style="color: #000000;"> (Subject subject : subjectList) {<br></span><span style="color: #008080;">59</span> <span style="color: #000000;">                subject.onNext(content);<br></span><span style="color: #008080;">60</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">61</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">62</span>         <span style="color: #0000ff;">if</span> (DEBUG) Log.d(TAG, “[send]subjectMapper: “ +<span style="color: #000000;"> subjectMapper);<br></span><span style="color: #008080;">63</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">64</span> }</pre><br></div>

<p>如上述代码，RxBus只提供了register、unregister、post三个方法。</p>
<p>这里又加入了一个tag的概念，也可以理解为channel，注册Subject、反注册Subject和post事件的时候都需要这个tag，只有tag一致才能正常接收到事件。</p>
<p>比如有一个事件类HelloEvent，这个事件的作用是接收到后toast一个提示&ldquo;hello&rdquo;，如果两个Activity都注册了这个HelloEvent事件，但是没有tag去限制，一旦post了一个helloEvent事件后，两个Activity都会收到这个事件，导致两个Activity都会toast。如果使用tag，post这个HelloEvent的时候可以设置这个tag，只有register时也使用了这个tag才会接收到这个event。</p>
<p>2. 在Present（如Activity的onCreate）中注册一个Observer（以下以发送一个String类型的事件为例）</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> Observable&lt;String&gt; addOb =<span style="color: #000000;"> RxBus.get()<br></span><span style="color: #008080;">2</span>                 .register(“addFeedTag”, String.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;">3</span><br><span style="color: #008080;">4</span> <span style="color: #000000;">addOb.observeOn(AndroidSchedulers.mainThread())<br></span><span style="color: #008080;">5</span>                 .subscribe(s -&gt;<span style="color: #000000;"> {<br></span><span style="color: #008080;">6</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> todo: Accept event and process here</span><br><span style="color: #008080;">7</span>                 });</pre><br></div>

<p>如上，注册了一个String类型的事件，事件的tag是&ldquo;addFeedTag&rdquo;，用来增加一个Feed。使用RxAndroid在Action1中处理接收到的这个事件。</p>
<p>3. 在任何地方发送一个事件：</p>
<div class="cnblogs_code"><br><pre>RxBus.get().post(“addFeedTag”, “hello RxBus!”);</pre><br></div>

<p>这里发送了一个tag为&ldquo;addFeedTag&rdquo;的String类型的事件。</p>
<p>4. 反注册Observer：</p>
<div class="cnblogs_code"><br><pre>RxBus.get().unregister(“addFeedTag”, addOb);</pre><br></div>

<p>注意：这里的Tag都为&ldquo;addFeedTag&rdquo;。</p>
<p>&nbsp;</p>
<p><strong>下面使用注解的方式更简单方便地使用RxBus（嗯－。－这里才是重点）。</strong></p>
<p>首先来看下使用注解后的代码：</p>
<p>1. 注册Observer</p>
<p>这一步可以省略掉。</p>
<p>2. 发送一个事件（这里我们换一个事件：FeedItemClickEvent，我们定义这个事件是用来处理当Feed被点击后的事件）</p>
<div class="cnblogs_code"><br><pre>RxBus.get().post(<span style="color: #0000ff;">new</span> FeedItemClickEvent().setPosition(position).setFeed(feed));</pre><br></div>

<p>3. 接收事件，然后处理</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #000000;">@Accept<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPostAccept(Object tag, FeedItemClickEvent event) {<br></span><span style="color: #008080;">3</span> 　　Logger.d(TAG, “onPostAccept event: “ +<span style="color: #000000;"> event);<br></span><span style="color: #008080;">4</span> 　　Feed feed =<span style="color: #000000;"> event.getFeed();<br></span><span style="color: #008080;">5</span> 　　<span style="color: #008000;">//</span><span style="color: #008000;"> 跳转到feed详情页面…</span><br><span style="color: #008080;">6</span> }</pre><br></div>

<p>如上，这里只需要编写一个方法，加上Accept注解，然后在方法中进行事件处理即可。</p>
<p>注意：方法名可以任意</p>
<p>方法参数一：必须为Object类型的tag；</p>
<p>方法参数二，如果这个方法只接收一种事件，则写明具体的事件类型，如上；如果这个方法接收多种事件，则类型需要为Object。</p>
<p>4. 反注册Observer</p>
<p>这一步也可以省略掉。</p>
<p>&nbsp;</p>
<p>接收多种事件：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">@Accept(<br></span><span style="color: #008080;"> 2</span>             acceptScheduler =<span style="color: #000000;"> AcceptScheduler.NEW_THREAD,<br></span><span style="color: #008080;"> 3</span>             value =<span style="color: #000000;"> {<br></span><span style="color: #008080;"> 4</span>                     @AcceptType(tag = ActionEvent.CLOSE, clazz = String.<span style="color: #0000ff;">class</span><span style="color: #000000;">),<br></span><span style="color: #008080;"> 5</span>                     @AcceptType(tag = ActionEvent.BACK, clazz = String.<span style="color: #0000ff;">class</span><span style="color: #000000;">),<br></span><span style="color: #008080;"> 6</span>                     @AcceptType(tag = ActionEvent.EDIT, clazz = String.<span style="color: #0000ff;">class</span><span style="color: #000000;">),<br></span><span style="color: #008080;"> 7</span>                     @AcceptType(tag = ActionEvent.REFRESH, clazz = String.<span style="color: #0000ff;">class</span><span style="color: #000000;">)<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    )<br></span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPostAccept(Object tag, Object actionEvent) {<br></span><span style="color: #008080;">11</span>         Logger.d(TAG, “[ActionEvent]onPostAccept action event name: “ +<span style="color: #000000;"> actionEvent);<br></span><span style="color: #008080;">12</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> todo: Accept event and process here (in new thread)</span><br><span style="color: #008080;">13</span>     }</pre><br></div>

<p>这里@Accept注解中设置了acceptScheduler为AcceptScheduler.NEW_THREAD，指明方法运行在子线程中.</p>
<p>value中指明了接收的事件类型，这里表示这个方法接收4种类型的事件：CLOSE, BACK, EDIT, REFRESH.</p>
<p>&nbsp;</p>
<p><strong>注解解释：</strong></p>
<p><strong>@Accept注解</strong></p>
<p>acceptScheduler: 指定被注解的方法运行的Scheduler。</p>
<p>value[]: AcceptType注解数组，用于指定接收事件的tag和class。</p>
<p>&nbsp;</p>
<p><strong>@AcceptType注解：</strong></p>
<p>tag: 接收事件的tag<br>clazz: 接收事件的类型</p>
<p>&nbsp;</p>
<p><strong>AcceptScheduler：</strong></p>
<p>详情见：rx.schedulers.Schedulers和rx.android.schedulers.AndroidSchedulers</p>
<p>如果设置的是AcceptScheduler.EXECUTOR或AcceptScheduler.HANDLER，则需要在Application中配置Executor和Handler：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">  Date: 6/15/15.<br></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MyApplication <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Application {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span> Executor acceptExecutor =<span style="color: #000000;"> Executors.newCachedThreadPool();<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">private</span> Handler handler = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Handler(Looper.getMainLooper());<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate() {<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate();<br></span><span style="color: #008080;">13</span>         RxBus.DEBUG = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>         DefaultAcceptConfiguration.getInstance().registerAcceptConfiguration(<span style="color: #0000ff;">new</span><span style="color: #000000;"> DefaultAcceptConfiguration.OnDefaultAcceptConfiguration() {<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">17</span>             <span style="color: #0000ff;">public</span><span style="color: #000000;"> Executor applyAcceptExecutor() {<br></span><span style="color: #008080;">18</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> acceptExecutor;<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">22</span>             <span style="color: #0000ff;">public</span><span style="color: #000000;"> Handler applyAcceptHandler() {<br></span><span style="color: #008080;">23</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> handler;<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">27</span> }</pre><br></div>

<p>因为需要对Accept和AcceptType注解的解析，所以项目的BaseActivity需要使用<strong><a href="https://github.com/wangjiegulu/androidInject/blob/master/src/com/wangjie/androidinject/annotation/present/AIAppCompatActivity.java" target="_blank" rel="noopener">AIAppCompatActivity</a></strong>，然后实现parserMethodAnnotations()方法，使用<strong><a href="https://github.com/wangjiegulu/RxAndroidEventsSample/blob/master/sample/src/main/java/com/wangjie/rxandroideventssample/rxbus/RxBusAnnotationManager.java" target="_blank" rel="noopener">RxBusAnnotationManager</a></strong>对注解进行解析。</p>
<p>&nbsp;</p>
<p>参考：<a href="http://nerds.weddingpartyapp.com/tech/2014/12/24/implementing-an-event-bus-with-rxjava-rxbus/" target="_blank" rel="noopener">http://nerds.weddingpartyapp.com/tech/2014/12/24/implementing-an-event-bus-with-rxjava-rxbus/</a></p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> RxJava </tag>
            
            <tag> RxAndroid </tag>
            
            <tag> EventBus </tag>
            
            <tag> RxBus </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Learn RxJava]]></title>
      <url>/2015/05/11/Learn-RxJava/</url>
      <content type="html"><![CDATA[<p>Learn&nbsp;RxJava</p>
<p>　　<a href="http://reactivex.io/documentation/operators.html" target="_blank" rel="noopener">http://reactivex.io/documentation/operators.html</a></p>
<p><span style="line-height: 1.5;">　　</span><a href="https://github.com/ReactiveX/RxJava/wiki/The-RxJava-Android-Module" target="_blank" rel="noopener">https://github.com/ReactiveX/RxJava/wiki/The-RxJava-Android-Module</a></p>
<p>　　<a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="noopener">https://github.com/ReactiveX/RxJava</a></p>
<p>&nbsp;</p>
<ul>
<li><a href="http://open.blogs.nytimes.com/2014/08/18/getting-groovy-with-reactive-android/?_php=true&amp;_type=blogs&amp;_php=true&amp;_type=blogs&amp;_r=1&amp;" target="_blank" rel="noopener">How the New York Times is building its Android app with Groovy/RxJava</a>&nbsp;by Mohit Pandey</li>
<li><a href="http://mttkay.github.io/blog/2013/08/25/functional-reactive-programming-on-android-with-rxjava/" target="_blank" rel="noopener">Functional Reactive Programming on Android With RxJava</a>&nbsp;and&nbsp;<a href="https://speakerdeck.com/mttkay/conquering-concurrency-bringing-the-reactive-extensions-to-the-android-platform" target="_blank" rel="noopener">Conquering concurrency - bringing the Reactive Extensions to the Android platform</a>&nbsp;by Matthias K&auml;ppler</li>
<li><a href="https://github.com/kaushikgopal/Android-RxJava" target="_blank" rel="noopener">Learning RxJava for Android by example</a>&nbsp;by Kaushik Gopal</li>
<li><a href="http://blog.futurice.com/top-7-tips-for-rxjava-on-android" target="_blank" rel="noopener">Top 7 Tips for RxJava on Android</a>&nbsp;and&nbsp;<a href="http://www.slideshare.net/TimoTuominen1/rxjava-architectures-on-android-8-android-livecode-32531688" target="_blank" rel="noopener">Rx Architectures in Android</a>&nbsp;by Timo Tuominen</li>
<li><a href="http://slid.es/yaroslavheriatovych/frponandroid" target="_blank" rel="noopener">FRP on Android</a>&nbsp;by Yaroslav Heriatovych</li>
<li><a href="http://blog.futurice.com/tech-pick-of-the-week-rx-for-net-and-rxjava-for-android" target="_blank" rel="noopener">Rx for .NET and RxJava for Android</a>&nbsp;by Olli Salonen</li>
<li><a href="http://blog.futurice.com/android-development-has-its-own-swift" target="_blank" rel="noopener">RxJava in Xtend for Android</a>&nbsp;by Andre Medeiros</li>
<li><a href="http://mnmlst-dvlpr.blogspot.de/2014/07/rxjava-and-xtend.html" target="_blank" rel="noopener">RxJava and Xtend</a>&nbsp;by Stefan Oehme</li>
<li>Grokking RxJava,&nbsp;<a href="http://blog.danlew.net/2014/09/15/grokking-rxjava-part-1/" target="_blank" rel="noopener">Part 1: The Basics</a>,&nbsp;<a href="http://blog.danlew.net/2014/09/22/grokking-rxjava-part-2/" target="_blank" rel="noopener">Part 2: Operator, Operator</a>,&nbsp;<a href="http://blog.danlew.net/2014/09/30/grokking-rxjava-part-3/" target="_blank" rel="noopener">Part 3: Reactive with Benefits</a>,&nbsp;<a href="http://blog.danlew.net/2014/10/08/grokking-rxjava-part-4/" target="_blank" rel="noopener">Part 4: Reactive Android</a>&nbsp;- published in Sep/Oct 2014 by Daniel Lew</li>
<li><a href="http://blog.dreamtobe.cn/2289.html" target="_blank" rel="noopener">http://blog.dreamtobe.cn/2289.html</a>（中文）</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> rxjava </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]RapidFloatingActionButton框架正式出炉]]></title>
      <url>/2015/05/03/Android-RapidFloatingActionButton%E6%A1%86%E6%9E%B6%E6%AD%A3%E5%BC%8F%E5%87%BA%E7%82%89/</url>
      <content type="html"><![CDATA[<h1 id="RapidFloatingActionButton"><a href="#RapidFloatingActionButton" class="headerlink" title="RapidFloatingActionButton"></a>RapidFloatingActionButton</h1><p>Google推出了MaterialDesign的设计语言，其中FloatingActionButton就是一部分，但是Google却没有提供一个官方的FloatingActionButton控件，网上找了几个试用了下，但是始终没有找到合适的，所以，自己动手丰衣足食了。</p>
<p><a href="http://www.cnblogs.com/RapidFloatingActionButton" target="_blank" rel="noopener">RapidFloatingActionButton</a>（以下简称RFAB）是Floating Action Button的快速实现。</p>
<p><strong><span style="color: #ff0000;">Github地址：<a href="https://github.com/wangjiegulu/RapidFloatingActionButton" target="_blank" rel="noopener"><span style="color: #ff0000;">https://github.com/wangjiegulu/RapidFloatingActionButton</span></a></span></strong></p>
<p><a href="https://raw.githubusercontent.com/wangjiegulu/RapidFloatingActionButton/master/screenshot/rfab_label_list.gif" target="_blank" rel="noopener"><img src="https://raw.githubusercontent.com/wangjiegulu/RapidFloatingActionButton/master/screenshot/rfab_label_list.gif" alt=""></a>&nbsp;<a href="https://raw.githubusercontent.com/wangjiegulu/RapidFloatingActionButton/master/screenshot/rfabg.gif" target="_blank" rel="noopener"><img src="https://raw.githubusercontent.com/wangjiegulu/RapidFloatingActionButton/master/screenshot/rfabg.gif" alt=""></a>&nbsp;</p>
<p><a href="https://raw.githubusercontent.com/wangjiegulu/RapidFloatingActionButton/master/screenshot/rfab_01.png" target="_blank" rel="noopener"><img src="https://raw.githubusercontent.com/wangjiegulu/RapidFloatingActionButton/master/screenshot/rfab_01.png" alt=""></a>&nbsp;<a href="https://raw.githubusercontent.com/wangjiegulu/RapidFloatingActionButton/master/screenshot/rfab_03.png" target="_blank" rel="noopener"><img src="https://raw.githubusercontent.com/wangjiegulu/RapidFloatingActionButton/master/screenshot/rfab_03.png" alt=""></a></p>
<h1 id="使用方式："><a href="#使用方式：" class="headerlink" title="使用方式："></a><a href="https://github.com/wangjiegulu/RapidFloatingActionButton#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F" target="_blank" rel="noopener"></a>使用方式：</h1><p>依赖：<br><strong><a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">AndroidBucket</a>(<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket</a>)</strong>：基础工具包<br><strong><a href="https://github.com/wangjiegulu/androidInject" target="_blank" rel="noopener">AndroidInject</a>(<a href="https://github.com/wangjiegulu/androidInject" target="_blank" rel="noopener">https://github.com/wangjiegulu/androidInject</a>)</strong>：注解框架</p>
<p><strong><a href="https://github.com/JakeWharton/NineOldAndroids" target="_blank" rel="noopener">NineOldAndroids</a>(<a href="https://github.com/JakeWharton/NineOldAndroids" target="_blank" rel="noopener">https://github.com/JakeWharton/NineOldAndroids</a>)</strong>：兼容低版本的动画框架</p>
<h2 id="activity-main-xml："><a href="#activity-main-xml：" class="headerlink" title="activity_main.xml："></a><a href="https://github.com/wangjiegulu/RapidFloatingActionButton#activity_mainxml" target="_blank" rel="noopener"></a>activity_main.xml：</h2><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> &lt;<span style="color: #000000;">com.wangjie.rapidfloatingactionbutton.RapidFloatingActionLayout<br></span><span style="color: #008080;"> 2</span>       xmlns:rfal=”<a href="http://schemas.android.com/apk/res-auto" target="_blank" rel="noopener">http://schemas.android.com/apk/res-auto</a>“<br><span style="color: #008080;"> 3</span>       android:id=”@+id/activity_main_rfal”<br><span style="color: #008080;"> 4</span>       android:layout_width=”match_parent”<br><span style="color: #008080;"> 5</span>       android:layout_height=”match_parent”<br><span style="color: #008080;"> 6</span>       rfal:rfal_frame_color=”#ffffff”<br><span style="color: #008080;"> 7</span>       rfal:rfal_frame_alpha=”0.7”<br><span style="color: #008080;"> 8</span>       &gt;<br><span style="color: #008080;"> 9</span>   &lt;<span style="color: #000000;">com.wangjie.rapidfloatingactionbutton.RapidFloatingActionButton<br></span><span style="color: #008080;">10</span>           xmlns:rfab=”<a href="http://schemas.android.com/apk/res-auto" target="_blank" rel="noopener">http://schemas.android.com/apk/res-auto</a>“<br><span style="color: #008080;">11</span>           android:id=”@+id/activity_main_rfab”<br><span style="color: #008080;">12</span>           android:layout_width=”wrap_content”<br><span style="color: #008080;">13</span>           android:layout_height=”wrap_content”<br><span style="color: #008080;">14</span>           android:layout_alignParentRight=”true”<br><span style="color: #008080;">15</span>           android:layout_alignParentBottom=”true”<br><span style="color: #008080;">16</span>           android:layout_marginRight=”15dp”<br><span style="color: #008080;">17</span>           android:layout_marginBottom=”15dp”<br><span style="color: #008080;">18</span>           android:padding=”8dp”<br><span style="color: #008080;">19</span>           rfab:rfab_size=”normal”<br><span style="color: #008080;">20</span>           rfab:rfab_drawable=”@drawable/rfab__drawable_rfab_default”<br><span style="color: #008080;">21</span>           rfab:rfab_color_normal=”#37474f”<br><span style="color: #008080;">22</span>           rfab:rfab_color_pressed=”#263238”<br><span style="color: #008080;">23</span>           rfab:rfab_shadow_radius=”7dp”<br><span style="color: #008080;">24</span>           rfab:rfab_shadow_color=”#999999”<br><span style="color: #008080;">25</span>           rfab:rfab_shadow_dx=”0dp”<br><span style="color: #008080;">26</span>           rfab:rfab_shadow_dy=”5dp”<br><span style="color: #008080;">27</span>           /&gt;<br><span style="color: #008080;">28</span> &lt;/com.wangjie.rapidfloatingactionbutton.RapidFloatingActionLayout&gt;</pre><br></div>

<p>在需要增加RFAB最外层使用<code>&amp;lt;com.wangjie.rapidfloatingactionbutton.RapidFloatingActionLayout&amp;gt;</code>，按钮使用<code>&amp;lt;com.wangjie.rapidfloatingactionbutton.RapidFloatingActionButton&amp;gt;</code></p>
<h3 id="属性解释"><a href="#属性解释" class="headerlink" title="属性解释"></a><a href="https://github.com/wangjiegulu/RapidFloatingActionButton#%E5%B1%9E%E6%80%A7%E8%A7%A3%E9%87%8A" target="_blank" rel="noopener"></a>属性解释</h3><h4 id="RapidFloatingActionLayout"><a href="#RapidFloatingActionLayout" class="headerlink" title="RapidFloatingActionLayout:"></a><a href="https://github.com/wangjiegulu/RapidFloatingActionButton#rapidfloatingactionlayout" target="_blank" rel="noopener"></a>RapidFloatingActionLayout:</h4><div class="cnblogs_code"><br><pre><span style="color: #000000;">  rfal_frame_color: 展开RFAB时候最外覆盖层的颜色，默认是纯白色<br>  rfal_frame_alpha: 展开RFAB时候最外覆盖层的透明度(0 ~ 1)，默认是0.7</span></pre><br></div>

<h4 id="RapidFloatingActionButton-1"><a href="#RapidFloatingActionButton-1" class="headerlink" title="RapidFloatingActionButton:"></a><a href="https://github.com/wangjiegulu/RapidFloatingActionButton#rapidfloatingactionbutton-1" target="_blank" rel="noopener"></a>RapidFloatingActionButton:</h4><div class="cnblogs_code"><br><pre><span style="color: #000000;">　rfab_size: RFAB的尺寸大小，只支持两种尺寸（Material Design规范）：<br>          normal: 直径56dp<br>          mini: 直径40dp<br>  rfab_drawable: RFAB中间的图标，默认是一个”+”图标<br>  rfab_color_normal: RFAB背景的普通状态下的颜色。默认是白色<br>  rfab_color_pressed: RFAB背景的触摸按下状态的颜色。默认颜色是”#dddddd”<br>  rfab_shadow_radius: RFAB的阴影半径。默认是0，表示没有阴影<br>  rfab_shadow_color: RFAB的阴影颜色。默认是透明，另外如果rfab_shadow_radius为0，则该属性无效<br>  rfab_shadow_dx: RFAB的阴影X轴偏移量。默认是0<br>  rfab_shadow_dy: RFAB的阴影Y轴偏移量。默认是0</span></pre><br></div>

<h2 id="MainActivity："><a href="#MainActivity：" class="headerlink" title="MainActivity："></a><a href="https://github.com/wangjiegulu/RapidFloatingActionButton#mainactivity" target="_blank" rel="noopener"></a>MainActivity：</h2><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">@AILayout(R.layout.activity_main)<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span> AIActionBarActivity <span style="color: #0000ff;">implements</span><span style="color: #000000;"> RapidFloatingActionContentLabelList.OnRapidFloatingActionContentListener {<br></span><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span> <span style="color: #000000;">    @AIView(R.id.activity_main_rfal)<br></span><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> RapidFloatingActionLayout rfaLayout;<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    @AIView(R.id.activity_main_rfab)<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> RapidFloatingActionButton rfaBtn;<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> RapidFloatingActionButtonHelper rfabHelper;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span>         RapidFloatingActionContentLabelList rfaContent = <span style="color: #0000ff;">new</span><span style="color: #000000;"> RapidFloatingActionContentLabelList(context);<br></span><span style="color: #008080;">15</span>         rfaContent.setOnRapidFloatingActionContentListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">16</span>         List&lt;RFACLabelItem&gt; items = <span style="color: #0000ff;">new</span> ArrayList&lt;&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">17</span>         items.add(<span style="color: #0000ff;">new</span> RFACLabelItem&lt;Integer&gt;<span style="color: #000000;">()<br></span><span style="color: #008080;">18</span>                         .setLabel(“Github: wangjiegulu”<span style="color: #000000;">)<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">                        .setResId(R.drawable.ic_launcher)<br></span><span style="color: #008080;">20</span>                         .setIconNormalColor(0xffd84315<span style="color: #000000;">)<br></span><span style="color: #008080;">21</span>                         .setIconPressedColor(0xffbf360c<span style="color: #000000;">)<br></span><span style="color: #008080;">22</span>                         .setWrapper(0<span style="color: #000000;">)<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">        );<br></span><span style="color: #008080;">24</span>         items.add(<span style="color: #0000ff;">new</span> RFACLabelItem&lt;Integer&gt;<span style="color: #000000;">()<br></span><span style="color: #008080;">25</span>                         .setLabel(“tiantian.china.2@gmail.com”<span style="color: #000000;">)<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">                        .setResId(R.drawable.ic_launcher)<br></span><span style="color: #008080;">27</span>                         .setIconNormalColor(0xff4e342e<span style="color: #000000;">)<br></span><span style="color: #008080;">28</span>                         .setIconPressedColor(0xff3e2723<span style="color: #000000;">)<br></span><span style="color: #008080;">29</span>                         .setWrapper(1<span style="color: #000000;">)<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">        );<br></span><span style="color: #008080;">31</span>         items.add(<span style="color: #0000ff;">new</span> RFACLabelItem&lt;Integer&gt;<span style="color: #000000;">()<br></span><span style="color: #008080;">32</span>                         .setLabel(“WangJie”<span style="color: #000000;">)<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">                        .setResId(R.drawable.ic_launcher)<br></span><span style="color: #008080;">34</span>                         .setIconNormalColor(0xff056f00<span style="color: #000000;">)<br></span><span style="color: #008080;">35</span>                         .setIconPressedColor(0xff0d5302<span style="color: #000000;">)<br></span><span style="color: #008080;">36</span>                         .setWrapper(2<span style="color: #000000;">)<br></span><span style="color: #008080;">37</span> <span style="color: #000000;">        );<br></span><span style="color: #008080;">38</span>         items.add(<span style="color: #0000ff;">new</span> RFACLabelItem&lt;Integer&gt;<span style="color: #000000;">()<br></span><span style="color: #008080;">39</span>                         .setLabel(“Compose”<span style="color: #000000;">)<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">                        .setResId(R.drawable.ic_launcher)<br></span><span style="color: #008080;">41</span>                         .setIconNormalColor(0xff283593<span style="color: #000000;">)<br></span><span style="color: #008080;">42</span>                         .setIconPressedColor(0xff1a237e<span style="color: #000000;">)<br></span><span style="color: #008080;">43</span>                         .setWrapper(3<span style="color: #000000;">)<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">        );<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">        rfaContent<br></span><span style="color: #008080;">46</span> <span style="color: #000000;">                .setItems(items)<br></span><span style="color: #008080;">47</span>                 .setIconShadowRadius(ABTextUtil.dip2px(context, 5<span style="color: #000000;">))<br></span><span style="color: #008080;">48</span>                 .setIconShadowColor(0xff999999<span style="color: #000000;">)<br></span><span style="color: #008080;">49</span>                 .setIconShadowDy(ABTextUtil.dip2px(context, 5<span style="color: #000000;">))<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">        ;<br></span><span style="color: #008080;">51</span><br><span style="color: #008080;">52</span>         rfabHelper = <span style="color: #0000ff;">new</span><span style="color: #000000;"> RapidFloatingActionButtonHelper(<br></span><span style="color: #008080;">53</span> <span style="color: #000000;">                context,<br></span><span style="color: #008080;">54</span> <span style="color: #000000;">                rfaLayout,<br></span><span style="color: #008080;">55</span> <span style="color: #000000;">                rfaBtn,<br></span><span style="color: #008080;">56</span> <span style="color: #000000;">                rfaContent<br></span><span style="color: #008080;">57</span> <span style="color: #000000;">        ).build();<br></span><span style="color: #008080;">58</span><br><span style="color: #008080;">59</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">60</span><br><span style="color: #008080;">61</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">62</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onRFACItemLabelClick(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position, RFACLabelItem item) {<br></span><span style="color: #008080;">63</span>         Toast.makeText(getContext(), “clicked label: “ +<span style="color: #000000;"> position, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">64</span> <span style="color: #000000;">        rfabHelper.toggleContent();<br></span><span style="color: #008080;">65</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">66</span><br><span style="color: #008080;">67</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">68</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onRFACItemIconClick(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position, RFACLabelItem item) {<br></span><span style="color: #008080;">69</span>         Toast.makeText(getContext(), “clicked icon: “ +<span style="color: #000000;"> position, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">70</span> <span style="color: #000000;">        rfabHelper.toggleContent();<br></span><span style="color: #008080;">71</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">72</span> }</pre><br></div>

<p>除了xml中设置的<code>RapidFloatingActionLayout</code>和<code>RapidFloatingActionButton</code>之外，还需要<code>RapidFloatingActionContent</code>的实现类来填充和指定RFAB的内容和形式。<br>这里提供了一个快速的<code>RapidFloatingActionContent</code>的实现解决方案:<code>RapidFloatingActionContentLabelList</code>。你可以加入多个item（RFACLabelItem，当然，不建议加太多的item，导致超过一个屏幕），然后设置每个item的颜色、图标、阴影、label的背景图片、字体大小颜色甚至动画。<br>它的效果可参考<a href="https://github.com/wangjiegulu/RapidFloatingActionButton/tree/master/screenshot" target="_blank" rel="noopener">最上面的效果图片</a>或者<a href="https://play.google.com/store/apps/details?id=com.google.android.apps.inbox" target="_blank" rel="noopener">Google的Inbox</a>的效果。<br>除此之外，你还需要使用<code>RapidFloatingActionButtonHelper</code>来把以上所有零散的组件组合起来。</p>
<h1 id="关于扩展："><a href="#关于扩展：" class="headerlink" title="关于扩展："></a><a href="https://github.com/wangjiegulu/RapidFloatingActionButton#%E5%85%B3%E4%BA%8E%E6%89%A9%E5%B1%95" target="_blank" rel="noopener"></a>关于扩展：</h1><p>如果你不喜欢默认提供的<code>RapidFloatingActionContentLabelList</code>，理论上你可以扩展自己的内容样式。方法是继承<code>com.wangjie.rapidfloatingactionbutton.RapidFloatingActionContent</code>，然后初始化内容布局和样式，并调用父类的<code>setRootView(xxx);</code>方法即可。如果你需要增加动画，可以重写如下方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onExpandAnimator(AnimatorSet animatorSet);<br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCollapseAnimator(AnimatorSet animatorSet);</pre><br></div>

<p>把需要的Animator增加到animatorSet中即可<br><code>另外，作者也会不定期增加更多的RapidFloatingActionContent的扩展</code></p>
<h1 id="License"><a href="#License" class="headerlink" title="License"></a><a href="https://github.com/wangjiegulu/RapidFloatingActionButton#license" target="_blank" rel="noopener"></a>License</h1><div class="cnblogs_code"><br><pre><span style="color: #000000;">Copyright 2015 Wang Jie<br><br>Licensed under the Apache License, Version 2.0 (the “License”);<br>you may not use this file except in compliance with the License.<br>You may obtain a copy of the License at<br><br>   <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="noopener">http://www.apache.org/licenses/LICENSE-2.0</a><br><br>Unless required by applicable law or agreed to in writing, software<br>distributed under the License is distributed on an “AS IS” BASIS,<br>WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<br>See the License for the specific language governing permissions and<br>limitations under the License.</span></pre><br></div>

<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> FloatingActionButton </tag>
            
            <tag> FAB </tag>
            
            <tag> view </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]Activity跳转传递任意类型的数据、Activity为SingleTask时代替StartActivityForResult的解决方案]]></title>
      <url>/2015/04/03/Android-Activity%E8%B7%B3%E8%BD%AC%E4%BC%A0%E9%80%92%E4%BB%BB%E6%84%8F%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%95%B0%E6%8D%AE%E3%80%81Activity%E4%B8%BASingleTask%E6%97%B6%E4%BB%A3%E6%9B%BFStartActivityForResult%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</url>
      <content type="html"><![CDATA[<p><span style="color: #ff0000;"><strong>以下内容为原创，欢迎转载，转载请注明</strong></span></p>
<p><span style="color: #ff0000;"><strong>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/4389674.html" title="view: [Android]Activity跳转传递任意类型的数据、Activity为SingleTask时代替StartActivity的解决方案" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4389674.html</a><a href="http://www.cnblogs.com/tiantianbyconan/p/4388175.html%20" target="_blank" rel="noopener"><span style="color: #ff0000;"><br></span></a></strong></span></p>
<p>&nbsp;</p>
<p>需求：在ActivityA跳转到ActivityB，然后在ActivityB操作完返回数据给ActivityA。</p>
<p>这个很普遍的需求，一般情况是使用startActivityForResult的方式去完成。</p>
<p>但是当ActivityB为SingleTask时，这个方式就无效了。你会发现当你执行startActivityForResult后，onActivityResult方法马上就会被回调。至于为什么会出现这种情况，参考这位老兄的文章就可以理解<a href="http://blog.csdn.net/sodino/article/details/22101881" target="_blank" rel="noopener">http://blog.csdn.net/sodino/article/details/22101881</a>。</p>
<p>解决这种情况的方法，第一种是把ActivityA也设置为SingleTask，然后在ActivityB中startActivity(context, ActivityA.class)，然后ActivityA在onNewIntent(Intent intent)方法中去获取传递数据，这样的方式不仅破坏了ActivityA的lauchMode，而且还需要ActivityB中启动指定的ActivityA。</p>
<p>所以，如果能把ActivityA的当前对象（实现某个接口）传到ActivityB中，然后ActivityB中通过接口直接回调那就解决问题了。</p>
<p>但是问题是怎么把当前对象传过去，使用Intent显然不行。</p>
<p>思路是维护一个StoragePool，里面可以暂存需要传递的数据。相当于一个暂存区，ActivityA跳转前，把数据放入这个暂存区，获得一个唯一标识，然后把这个唯一标识使用Intent的方式传递给ActivityB，然后ActivityB拿到这个唯一标识后去暂存区去取数据就好了。</p>
<p>暂存区StoragePool代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;"> <em> Author: wangjie<br></em></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">  Email: tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;"> <em> Date: 3/30/15.<br></em></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> StoragePool {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 8</span> <span style="color: #008000;">     <em> key   – 标识是哪一个intent的（UUID）<br></em></span><span style="color: #008080;"> 9</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">10</span> <span style="color: #008000;">     <em>         |- key – 存储的对象标识（StorageKey，使用UUID唯一）<br></em></span><span style="color: #008080;">11</span> <span style="color: #008000;">      value –|<br></span><span style="color: #008080;">12</span> <span style="color: #008000;">     <em>         |- value – 存储的内容<br></em></span><span style="color: #008080;">13</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">14</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> ConcurrentHashMap&lt;String, HashMap&lt;StorageKey, WeakReference&lt;Object&gt;&gt;&gt; storageMapper = <span style="color: #0000ff;">new</span> ConcurrentHashMap&lt;&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> StoragePool() {<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> storage(String tagUUID, StorageKey key, Object content) {<br></span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> == key || <span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> content) {<br></span><span style="color: #008080;">21</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">23</span>         HashMap&lt;StorageKey, WeakReference&lt;Object&gt;&gt; extraMapper =<span style="color: #000000;"> storageMapper.get(tagUUID);<br></span><span style="color: #008080;">24</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> extraMapper) {<br></span><span style="color: #008080;">25</span>             extraMapper = <span style="color: #0000ff;">new</span> HashMap&lt;&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">            storageMapper.put(tagUUID, extraMapper);<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">28</span>         extraMapper.put(key, <span style="color: #0000ff;">new</span> WeakReference&lt;&gt;<span style="color: #000000;">(content));<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> Object remove(String tagUUID, StorageKey key) {<br></span><span style="color: #008080;">32</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> key) {<br></span><span style="color: #008080;">33</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">35</span>         HashMap&lt;StorageKey, WeakReference&lt;Object&gt;&gt; extraMapper =<span style="color: #000000;"> storageMapper.get(tagUUID);<br></span><span style="color: #008080;">36</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> extraMapper) {<br></span><span style="color: #008080;">37</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">39</span><br><span style="color: #008080;">40</span>         WeakReference&lt;Object&gt; ref =<span style="color: #000000;"> extraMapper.remove(key);<br></span><span style="color: #008080;">41</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (ABTextUtil.isEmpty(extraMapper)) {<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">            storageMapper.remove(tagUUID);<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">44</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span> == ref ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : ref.get();<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> HashMap&lt;StorageKey, WeakReference&lt;Object&gt;&gt;<span style="color: #000000;"> remove(String tagUUID) {<br></span><span style="color: #008080;">48</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> tagUUID) {<br></span><span style="color: #008080;">49</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">51</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> storageMapper.remove(tagUUID);<br></span><span style="color: #008080;">52</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">53</span><br><span style="color: #008080;">54</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> clear() {<br></span><span style="color: #008080;">55</span> <span style="color: #000000;">        storageMapper.clear();<br></span><span style="color: #008080;">56</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">57</span><br><span style="color: #008080;">58</span> }</pre><br></div>

<p>如上代码，StoragePool维护了一个HashMap，key是一个UUID，代表唯一的一个Intent跳转，ActivityA跳转时会把这个UUID传递到ActivityB，ActivityB就是通过这个UUID来获取这次跳转需要传递的数据的。value也是一个HashMap，里面存储了某次跳转传递的所有数据。key是StorageKey，实质上也是一个UUID，value是任意的数据。</p>
<p>跳转前的存储数据和真正的StartActivity都需要使用StorageIntentCenter来进行操作，代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">  Date: 3/31/15.<br></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> StorageIntentCenter {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String STORAGE_INTENT_CENTER_KEY_UUID = StorageIntentCenter.<span style="color: #0000ff;">class</span>.getSimpleName() + “_UUID”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = StorageIntentCenter.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Intent intent;<br></span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String uuid;<br></span><span style="color: #008080;">12</span>     <span style="color: #0000ff;">private</span> HashMap&lt;StorageKey, Object&gt;<span style="color: #000000;"> extras;<br></span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isUsed;<br></span><span style="color: #008080;">14</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> StorageIntentCenter() {<br></span><span style="color: #008080;">15</span>         intent = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Intent();<br></span><span style="color: #008080;">16</span>         uuid =<span style="color: #000000;"> java.util.UUID.randomUUID().toString();<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">        intent.putExtra(STORAGE_INTENT_CENTER_KEY_UUID, uuid);<br></span><span style="color: #008080;">18</span>         isUsed = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> StorageIntentCenter putExtra(String intentKey, Object content){<br></span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> content) {<br></span><span style="color: #008080;">23</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">25</span>         StorageKey storageKey = <span style="color: #0000ff;">new</span><span style="color: #000000;"> StorageKey(content.getClass());<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">        intent.putExtra(intentKey, storageKey);<br></span><span style="color: #008080;">27</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> extras){<br></span><span style="color: #008080;">28</span>             extras = <span style="color: #0000ff;">new</span> HashMap&lt;&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">        extras.put(storageKey, content);<br></span><span style="color: #008080;">31</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> startActivity(Context packageContext, Class&lt;?&gt;<span style="color: #000000;"> cls){<br></span><span style="color: #008080;">35</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(isUsed){<br></span><span style="color: #008080;">36</span>             Logger.e(TAG, <span style="color: #0000ff;">this</span> + “ can not be reuse!”<span style="color: #000000;">);<br></span><span style="color: #008080;">37</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">        intent.setClass(packageContext, cls);<br></span><span style="color: #008080;">40</span>         <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">ABTextUtil.isEmpty(extras)){<br></span><span style="color: #008080;">41</span>             Set&lt;Map.Entry&lt;StorageKey, Object&gt;&gt; entrySet =<span style="color: #000000;"> extras.entrySet();<br></span><span style="color: #008080;">42</span>             <span style="color: #0000ff;">for</span>(Map.Entry&lt;StorageKey, Object&gt;<span style="color: #000000;"> entry : entrySet){<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">                StoragePool.storage(uuid, entry.getKey(), entry.getValue());<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">46</span>         isUsed = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">47</span> <span style="color: #000000;">        packageContext.startActivity(intent);<br></span><span style="color: #008080;">48</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">49</span><br><span style="color: #008080;">50</span><br><span style="color: #008080;">51</span> }</pre><br></div>

<p>每个StorageIntentCenter都维护了一个真正跳转的Intent，一个此次跳转的uuid和所有需要传递的数据。</p>
<p>&nbsp;</p>
<p>使用方式（以从MainActivity跳转到OtherActivity为例）：</p>
<p>MainActivity中：</p>
<div class="cnblogs_code"><br><pre><span style="color: #000000;">@AILayout(R.layout.main)<br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span> BaseActivity <span style="color: #0000ff;">implements</span><span style="color: #000000;"> ICommunicate {<br><br>    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = MainActivity.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br><br>    @Override<br>    @AIClick({R.id.ac_test_a_btn})<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClickCallbackSample(View view) {<br>        </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (view.getId()) {<br>            </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.ac_test_a_btn:<br>                </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> StorageIntentCenter()<br>                        .putExtra(</span>“iCommunicate”, <span style="color: #0000ff;">this</span><span style="color: #000000;">)<br>                        .putExtra(</span>“testString”, “hello world”<span style="color: #000000;">)<br>                        .putExtra(</span>“testFloat”, 3.2f<span style="color: #000000;">)<br>                        .startActivity(context, OtherActivity.</span><span style="color: #0000ff;">class</span><span style="color: #000000;">);<br><br>                </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br>        }<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> hello(String content) {<br>        Logger.d(TAG, </span>“hello received: “ +<span style="color: #000000;"> content);<br>    }<br><br>}</span></pre><br></div>

<p>&nbsp;</p>
<p>OtherActivity继承了BaseActivity。</p>
<p>BaseActivity：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">  Date: 4/2/15.<br></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> BaseActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> AIActivity {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String storageIntentCenterUUID;<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #000000;">        initExtraFromStorage();<br></span><span style="color: #008080;">14</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> remove extra from StoragePool</span><br><span style="color: #008080;">15</span> <span style="color: #000000;">        StoragePool.remove(storageIntentCenterUUID);<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> initExtraFromStorage() {<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">final</span> &lt;T&gt; T getExtraFromStorage(String key, Class&lt;T&gt;<span style="color: #000000;"> contentType) {<br></span><span style="color: #008080;">22</span>         StorageKey storageKey =<span style="color: #000000;"> (StorageKey) getIntent().getSerializableExtra(key);<br></span><span style="color: #008080;">23</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> storageIntentCenterUUID) {<br></span><span style="color: #008080;">24</span>             storageIntentCenterUUID =<span style="color: #000000;"> getIntent().getStringExtra(StorageIntentCenter.STORAGE_INTENT_CENTER_KEY_UUID);<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">26</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> (T) StoragePool.remove(storageIntentCenterUUID, storageKey);<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> }</pre><br></div>

<p>Line15：为了防止跳转到OtherActivity后，如果没有去暂存区把数据取出来从而导致暂存区有无用的数据（甚至内存泄漏，暂存区使用软引用也是为了防止这种情况的发生），所以这里提供一个initExtraFromStorage方法让子类重写，子类可以在这个方法中去把数据取出来。然后在initExtraFromStorage方法执行完毕后，再及时把暂存区的数据删除。</p>
<p>Line21～27:这里提供了从暂存区提取数据的方法供子类调用。</p>
<p>&nbsp;</p>
<p>OtherActivity：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  Author: wangjie<br> <em> Email: tiantian.china.2@gmail.com
 </em> Date: 4/2/15.<br> </span><span style="color: #008000;">*/</span><span style="color: #000000;"><br>@AILayout(R.layout.other)<br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> OtherActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> BaseActivity{<br>    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = OtherActivity.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br><br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> ICommunicate iCommunicate;<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> String testString;<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Float testFloat;<br><br>    @Override<br>    </span><span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br>        </span><span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> initExtraFromStorage() {<br>        iCommunicate </span>= getExtraFromStorage(“iCommunicate”, ICommunicate.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br>        testString </span>= getExtraFromStorage(“testString”, String.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br>        testFloat </span>= getExtraFromStorage(“testFloat”, Float.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br>    }<br><br>    @Override<br>    @AIClick({R.id.other_btn})<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClickCallbackSample(View view) {<br>        </span><span style="color: #0000ff;">switch</span><span style="color: #000000;">(view.getId()){<br>            </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.other_btn:<br>                </span><span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> iCommunicate){<br>                    </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;<br>                }<br>                Logger.d(TAG, </span>“iCommunicate: “ +<span style="color: #000000;"> iCommunicate);<br>                iCommunicate.hello(</span>“content from ACTestBActivity!”<span style="color: #000000;">);<br><br>                Logger.d(TAG, </span>“testString: “ +<span style="color: #000000;"> testString);<br>                Logger.d(TAG, </span>“testFloat: “ +<span style="color: #000000;"> testFloat);<br>                finish();<br><br>                </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br>        }<br>    }<br>}</span></pre><br></div>

<p>如上代码OtherActivity中获取了从MainActivity中传递过来的MainActivity实例，在点击事件发生后通过MainActivity实例进行直接回调。</p>
<p>日志打印如下：</p>
<div class="cnblogs_code"><br><pre>04-03 12:09:52.184  25529-25529/com.wangjie.androidstorageintent D/<span style="color: #000000;">OtherActivity﹕ iCommunicate: com.wangjie.androidstorageintent.sample.MainActivity@42879ff8<br></span>04-03 12:09:52.184  25529-25529/com.wangjie.androidstorageintent D/MainActivity﹕ hello received: content from ACTestBActivity!<br>04-03 12:09:52.184  25529-25529/com.wangjie.androidstorageintent D/<span style="color: #000000;">OtherActivity﹕ testString: hello world<br></span>04-03 12:09:52.184  25529-25529/com.wangjie.androidstorageintent D/OtherActivity﹕ testFloat: 3.2</pre><br></div>

<p>MainActivity被回调，并获取了数据&ldquo;content from ACTestBActivity!&rdquo;字符串。</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong>注：</strong></span></p>
<p><span style="color: #ff0000;"><strong>1. 以上使用的代码已托管到github：<a href="https://github.com/wangjiegulu/AndroidStorageIntent" target="_blank" rel="noopener"><span style="color: #ff0000;">https://github.com/wangjiegulu/AndroidStorageIntent</span></a></strong></span></p>
<p><span style="color: #ff0000;"><strong>2. 上面的注解实现使用AndroidInject：<a href="https://github.com/wangjiegulu/androidInject" target="_blank" rel="noopener"><span style="color: #ff0000;">https://github.com/wangjiegulu/androidInject</span></a></strong></span></p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> activity </tag>
            
            <tag> launch mode </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]使用Gradle提交自己开源Android库到Maven中心库]]></title>
      <url>/2015/04/02/Android-%E4%BD%BF%E7%94%A8Gradle%E6%8F%90%E4%BA%A4%E8%87%AA%E5%B7%B1%E5%BC%80%E6%BA%90Android%E5%BA%93%E5%88%B0Maven%E4%B8%AD%E5%BF%83%E5%BA%93/</url>
      <content type="html"><![CDATA[<p>此文针对开源爱好者。</p>
<p>如果你想让别人使用你的Android开源库，第一种方法是，提供你的Github地址，让别人clone一份，然后让别人import到他的项目中。另一种更简单的方式就是直接让别人在他的Gradle中添加你的库依赖，如下：</p>
<div class="cnblogs_code"><br><pre>compile ‘com.github.wangjiegulu:AndroidBucket:1.0.1’</pre><br></div>

<p>如果想使用第二种方式，你需要将你的项目提交到公共的中心库。</p>
<p>这里介绍使用sonatype来把你的开源库（snapshot或release）提交到Maven的中心库。<strong>
</strong></p>
<p>1. 首先，在<a href="https://issues.sonatype.org" target="_blank" rel="noopener">https://issues.sonatype.org</a>中注册账号。</p>
<p>2. 然后在<a href="https://issues.sonatype.org/secure/CreateIssue.jspa?issuetype=21&amp;pid=10134" target="_blank" rel="noopener">https://issues.sonatype.org/secure/CreateIssue.jspa?issuetype=21&amp;pid=10134</a>中新建一个&ldquo;Project ticket&rdquo;。</p>
<p>－Summary：填写项目名称<span class="aui-icon icon-required"><br></span></p>
<p>－Description：填写描述</p>
<p>－Group Id：域名反转，如果没有域名，就直接使用github反转（如github.com/wangjiegulu –&gt; com.github.wangjiegulu），具体看<a href="http://central.sonatype.org/pages/choosing-your-coordinates.html" target="_blank" rel="noopener">http://central.sonatype.org/pages/choosing-your-coordinates.html</a><span class="aui-icon icon-required"><br></span></p>
<p>－Project URL：项目的url，可以是项目的github地址。如<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket</a></p>
<p>－SCM url：版本控制的uri，如<a href="https://github.com/wangjiegulu/AndroidBucket.git" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket.git</a></p>
<p>3. 创建完毕后就等待状态变为&ldquo;resolved&rdquo;，然后你就可以使用Gradle上传项目了。</p>
<p>4. 上传前需要进行GPG签名，所以先去下载GPG（<a href="https://www.gnupg.org/download/index.html" target="_blank" rel="noopener">https://www.gnupg.org/download/index.html</a>），然后打开</p>
<p><img src="http://images.cnitblog.com/blog2015/378300/201504/021841366545243.png" alt=""></p>
<p>新建一个Keychain，完成后右键&ldquo;Send Public Key to Key Server&rdquo;，这样就能把你的public key发送到服务端。</p>
<p>5. 然后我们再打包项目的aar文件，intellij idea和android studio使用gradle构建后，会在build中自动生成该文件，直接把他拷出来即可。</p>
<p>6. 然后新建build.gradle来进行我们的上传操作，大概内容如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">//</span><span style="color: #008000;"> <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></span><span style="color: #000000;"><br>apply plugin: </span>‘maven’<span style="color: #000000;"><br>apply plugin: </span>‘signing’ <span style="color: #008000;">//</span><span style="color: #008000;">使用signing plugin做数字签名<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;">定义GroupID和Version，ArtefactID会自动使用Project名</span><br>group = ‘com.github.wangjiegulu’<span style="color: #000000;"><br>version </span>= ‘1.0.1’<br><span style="color: #000000;"><br>repositories {<br>    mavenCentral();<br>}<br><br>artifacts {<br>    archives file(</span>‘AndroidBucket.aar’<span style="color: #000000;">)<br>}<br>signing {<br>    sign configurations.archives<br>}</span><br><span style="color: #000000;"><br>uploadArchives {<br>    repositories {<br>        mavenDeployer {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">为Pom文件做数字签名</span><br>            beforeDeployment { MavenDeployment deployment -&gt;<span style="color: #000000;"> signing.signPom(deployment) }<br><br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">指定项目部署到的中央库地址，UserName和Password就是Part 1中注册的账号。</span><br>            repository(url: “<a href="https://oss.sonatype.org/service/local/staging/deploy/maven2/" target="_blank" rel="noopener">https://oss.sonatype.org/service/local/staging/deploy/maven2/</a>“<span style="color: #000000;">) {<br>                authentication(userName: ossrhUsername, password: ossrhPassword)<br>            }<br>            snapshotRepository(url: </span>“<a href="https://oss.sonatype.org/content/repositories/snapshots/" target="_blank" rel="noopener">https://oss.sonatype.org/content/repositories/snapshots/</a>“<span style="color: #000000;">) {<br>                authentication(userName: ossrhUsername, password: ossrhPassword)<br>            }<br><br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">构造项目的Pom文件，参见Part 2中Pom文件的规范，不要遗漏必填项</span><br><span style="color: #000000;">            pom.project {<br>                name project.name<br>                packaging </span>‘aar’<span style="color: #000000;"><br>                description </span>‘Android开发常用整理’<span style="color: #000000;"><br>                url </span>‘<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket</a>‘<span style="color: #000000;"><br><br>                scm {<br>                    url </span>‘scm:git@github.com:wangjiegulu/AndroidBucket.git’<span style="color: #000000;"><br>                    connection </span>‘scm:git@github.com:wangjiegulu/AndroidBucket.git’<span style="color: #000000;"><br>                    developerConnection </span>‘git@github.com:wangjiegulu/AndroidBucket.git’<span style="color: #000000;"><br>                }<br><br>                licenses {<br>                    license {<br>                        name </span>‘The Apache Software License, Version 2.0’<span style="color: #000000;"><br>                        url </span>‘<a href="http://www.apache.org/licenses/LICENSE-2.0.txt" target="_blank" rel="noopener">http://www.apache.org/licenses/LICENSE-2.0.txt</a>‘<span style="color: #000000;"><br>                        distribution </span>‘wangjie’<span style="color: #000000;"><br>                    }<br>                }<br><br>                developers {<br>                    developer {<br>                        id </span>‘wangjie’<span style="color: #000000;"><br>                        name </span>‘Wagn Jie’<span style="color: #000000;"><br>                        email </span>‘tiantian.china.2@gmail.com’<span style="color: #000000;"><br>                    }<br>                }<br>            }<br>        }<br>    }<br>}</span></pre><br></div>

<p>archives file(‘AndroidBucket.aar’) 表示指定上传的aar文件。</p>
<div class="cnblogs_code"><br><pre><span style="color: #000000;">signing {<br>    sign configurations.archives<br>}</span></pre><br></div>

<p>表示对内容进行gpg签名，既然需要签名，那需要在gradle.properites中配置key的信息，还有上传的账号密码：</p>
<div class="cnblogs_code"><br><pre>signing.keyId=<span style="color: #000000;">XXXXXXXXX<br>signing.password</span>=XXXXXXXXX<span style="color: #000000;"><br>signing.secretKeyRingFile</span>=/Users/wangjie/.gnupg/secring.gpg</pre><br><br>&nbsp; ossrhUsername=oss.sonatype.org或者issues.sonatype.org的账号（同一个）<br>&nbsp; ossrhPassword=oss.sonatype.org或者issues.sonatype.org的密码（同一个）<br><br></div>

<p>所有配置完毕后执行gradle&nbsp;uploadArchives进行上传操作。</p>
<p>7. 登录<a href="https://oss.sonatype.org" target="_blank" rel="noopener">https://oss.sonatype.org</a>，点击左边的&ldquo;Staging Repositories&rdquo;，然后刚刚上传的项目名称为com.github.wangjiegulu去掉点-数字</p>
<p>选中后点击&ldquo;Close&rdquo;，如果成功，则再点击&ldquo;Release&rdquo;按钮发布。</p>
<p>然后再等待2小时，就可以在Maven中心库中搜索到了。</p>
<p>&nbsp;</p>
<p>注意：以后如果需要再上传其它项目的时候，直接从第4步开始即可，因为你的groupId已经申请过了，以后新的artifacts可以直接部署到这个groupId中。</p>
<p>&nbsp;</p>
<p>参考：<a href="http://central.sonatype.org/pages/ossrh-guide.html" target="_blank" rel="noopener">http://central.sonatype.org/pages/ossrh-guide.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> gradle </tag>
            
            <tag> maven </tag>
            
            <tag> open source </tag>
            
            <tag> uploadArchive </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[100个高质量Java开发者博客]]></title>
      <url>/2015/02/28/100%E4%B8%AA%E9%AB%98%E8%B4%A8%E9%87%8FJava%E5%BC%80%E5%8F%91%E8%80%85%E5%8D%9A%E5%AE%A2/</url>
      <content type="html"><![CDATA[<p>ImportNew注：原文中还没有100个。作者希望大家一起来推荐高质量的Java开发博客，然后不段补充到这个列表。欢迎你也参与推荐优质的Java开发博客。（声明一下：我们的数学不是体育老师教的！:) ）</p>
<p>本文的主要目的是收集全球范围内100个高质量Java开发者博客。其中会有一些博客并不是由纯粹的Java开发者撰写的，但是Java开发者们能够从中发现一些有用的或者有趣的东西。阅读这些博客将会非常有趣，有时会给你带来一些新鲜的想法。</p>
<p>Google的排名算法中，大型网站的排位会比较高。这对一些小型的高质量博客来说并不公平。有些站点的流量非常大，但是质量并不高。我对高质量的定义是：</p>
<ol>
<li>文章具有可读性并且是原创的。</li>
<li>文章作者对技术本身有着浓厚的兴趣。</li>
<li>文章在个人理解的基础上提出一些创造性的想法。</li>
<li>博客中没有太多的广告。</li>
<li>博客的更新频率比较高。</li>
</ol>
<p>因此，很多Google排名靠前的博客并没有出现在下面的列表里。如果你知道一些值得推荐的博客，请留言告诉我。由于这个列表正在快速增长，请只推荐高质量的博客站点。</p>
<div id="text-13"><br><div class="textwidget"><br><table style="height: 1033px; width: 763px;"><br><tbody><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">&nbsp;</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><strong>名称(站点名或人名)</strong></span></td><br><td valign="top" width="101"><span style="font-size: 14px;"><strong>国家</strong></span></td><br><td valign="top" width="261"><span style="font-size: 14px;"><strong>备注</strong></span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">1</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.adam-bien.com/roller/abien/" target="_blank" rel="noopener">Adam&nbsp;Bien</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">德国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE相关</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">2</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://antoniogoncalves.org/" target="_blank" rel="noopener">Antonio&nbsp;Goncalves</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">法国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE相关（《Java&nbsp;EE&nbsp;5》和《Java&nbsp;EE&nbsp;7》的作者）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">3</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://henrikwarne.com/" target="_blank" rel="noopener">Henrik&nbsp;Warne</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">瑞典</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">编程过程中的一些思考</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">4</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://keaplogik.blogspot.com/" target="_blank" rel="noopener">Billy&nbsp;Yarosh</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java日常开发中的实用代码示例</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">5</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.vogella.com/" target="_blank" rel="noopener">Lars&nbsp;Vogel</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">德国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java、Android&nbsp;和<span class="wp_keywordlink"><a href="http://res.importnew.com/eclipse" title="Eclipse ImportNew主页" target="_blank" rel="noopener">Eclipse</a></span></span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">6</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://javax0.wordpress.com/" target="_blank" rel="noopener">Peter&nbsp;Verhas</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">匈牙利</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">纯粹的Java</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">7</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://martinfowler.com/" target="_blank" rel="noopener">Martin&nbsp;Fowler</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">面向对象设计专家和咨询师</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">8</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://techblog.bozho.net/" target="_blank" rel="noopener">Bozhidar&nbsp;Bozhanov</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">保加利亚</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE相关</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">9</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://insightfullogic.com/blog/" target="_blank" rel="noopener">Richard&nbsp;Warburton</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">英国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;8&nbsp;Lambdas</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">10</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://invariantproperties.com/" target="_blank" rel="noopener">Bear&nbsp;Giles</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE相关</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">11</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.mikiobraun.de/" target="_blank" rel="noopener">Marginally&nbsp;Interesting</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">德国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">机器学习</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">12</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://pragmaticintegrator.wordpress.com/" target="_blank" rel="noopener">Pascal&nbsp;Alma</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE相关</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">13</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.drorhelper.com/" target="_blank" rel="noopener">Dror&nbsp;Helper</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">代码测试和代码质量</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">14</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://juristr.com/" target="_blank" rel="noopener">Juri&nbsp;Strumpflohner</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">意大利</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">JavaScript</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">15</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="https://blogs.oracle.com/reza/" target="_blank" rel="noopener">Reza&nbsp;Rahman</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE/Glassfish</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">16</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.bigfastblog.com/" target="_blank" rel="noopener">Phil&nbsp;Whelan</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">加拿大</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Web技术</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">17</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://brettporter.wordpress.com/" target="_blank" rel="noopener">Brett&nbsp;Porter</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">澳大利亚</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Apache&nbsp;Maven&nbsp;2的作者</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">18</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.benmccann.com/blog/" target="_blank" rel="noopener">Ben&nbsp;McCann</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">一些实用的操作指南（Connectifier的联合创始人）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">19</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.javaposse.com/" target="_blank" rel="noopener">Java&nbsp;Posse</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java相关的一些有用的链接</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">20</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.markhneedham.com/blog/" target="_blank" rel="noopener">Mark&nbsp;Needham</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">英国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">数据处理</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">21</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.takipiblog.com/" target="_blank" rel="noopener">Iris&nbsp;Shoor</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">以色列</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">调试技术、性能等</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">22</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.pengyifan.com/" target="_blank" rel="noopener">Yifan&nbsp;Peng</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java开发、算法与数据结构等（一个本科毕业生的博客）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">23</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://plumbr.eu/blog" target="_blank" rel="noopener">Nikita&nbsp;Salnikov&nbsp;Tarnovski</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">爱沙尼亚</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">内存泄露</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">24</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://marxsoftware.blogspot.com/" target="_blank" rel="noopener">Dustin&nbsp;Marx</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">一些通用的开发技术以及Java、&nbsp;JavaFX、Groovy等相关技术</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">25</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.thesoftwarecraft.com/" target="_blank" rel="noopener">Bart&nbsp;Bakker</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">荷兰</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">敏捷开发</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">26</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://gunnarpeipman.com/" target="_blank" rel="noopener">Gunnar&nbsp;Peipman</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">非Java（C#、.Net相关）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">27</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://jobtipsforgeeks.com/" target="_blank" rel="noopener">Dave&nbsp;Fecak</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">程序员需要知道的工作技巧</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">28</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.jooq.org/" target="_blank" rel="noopener">JOOQ</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">瑞士</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">SQL</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">29</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.petrikainulainen.net/" target="_blank" rel="noopener">Petri&nbsp;Kainulainen</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">芬兰</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Web技术</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">30</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.informatech.cr/" target="_blank" rel="noopener">Informatech&nbsp;CR</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">哥斯达黎加</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java、Web、Mobile开发</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">31</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.arungupta.me/" target="_blank" rel="noopener">Arun&nbsp;Gupta</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">32</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://mechanical-sympathy.blogspot.com/" target="_blank" rel="noopener">Mechanical&nbsp;Sympathy</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">英国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">性能（锁、垃圾回收、编译优化等）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">33</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://matteo.vaccari.name/blog/" target="_blank" rel="noopener">Extreme&nbsp;Enthusiasm</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">意大利</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">敏捷开发</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">34</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://steveblank.com/" target="_blank" rel="noopener">Steve&nbsp;Blank</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">The&nbsp;Startup&nbsp;Owner&rsquo;s&nbsp;Manual（创业者指南）的作者</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">35</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://olivergierke.de/" target="_blank" rel="noopener">Oliver&nbsp;Gierke</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">德国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">SpringSource（现为VMware旗下部门，提供Java企业应用开发平台）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">36</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.frankel.ch/" target="_blank" rel="noopener">Nicolas&nbsp;Fr&auml;nkel</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">瑞士</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">37</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.bdoughan.com/" target="_blank" rel="noopener">Blaise&nbsp;Doughan</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">XML和JSON相关</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">38</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://vladmihalcea.wordpress.com/" target="_blank" rel="noopener">Vlad&nbsp;Mihalcea</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">罗马尼亚</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">软件集成</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">39</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://lckymn.com/about-kevin" target="_blank" rel="noopener">Kevin&nbsp;Lee</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">澳大利亚</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Web技术</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">40</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://java-performance.info/" target="_blank" rel="noopener">Mikhail&nbsp;Vorontsov</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">澳大利亚</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">性能（语言本身的性能研究）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">41</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://jenkov.com/" target="_blank" rel="noopener">Jakob&nbsp;Jenkov</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">丹麦</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java基础</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">42</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.programcreek.com/" target="_blank" rel="noopener">Program&nbsp;Creek</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">深入理解Java</span></td><br></tr><br></tbody><br></table><br><br>&nbsp;<br><br><span style="line-height: 1.5;">原文链接：&nbsp;</span><a href="http://www.programcreek.com/2012/11/top-100-java-developers-blogs/" target="_blank" rel="noopener">programcreek</a><span style="line-height: 1.5;">&nbsp;翻译：&nbsp;</span><a href="http://www.importnew.com/" target="_blank" rel="noopener">ImportNew.com&nbsp;</a><span style="line-height: 1.5;">-&nbsp;</span><a href="http://www.importnew.com/author/xiaqianlin" target="_blank" rel="noopener">夏千林</a><br><br></div><br></div>

<p>译文链接：&nbsp;<a href="http://www.importnew.com/7469.html" target="_blank" rel="noopener">http://www.importnew.com/7469.html</a><br>[&nbsp;<strong>转载请保留原文出处、译者和译文链接。</strong>]</p>
]]></content>
      
        
        <tags>
            
            <tag> blog </tag>
            
            <tag> java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]实现类似微信的延迟加载的Fragment——LazyFragment]]></title>
      <url>/2015/02/27/Android-%E5%AE%9E%E7%8E%B0%E7%B1%BB%E4%BC%BC%E5%BE%AE%E4%BF%A1%E7%9A%84%E5%BB%B6%E8%BF%9F%E5%8A%A0%E8%BD%BD%E7%9A%84Fragment%E2%80%94%E2%80%94LazyFragment/</url>
      <content type="html"><![CDATA[<p>参考微信，使用ViewPager来显示不同的tab，每个tab是一个Fragment，</p>
<p>假设有3个tab，对应的fragment是FragmentA、FragmentB、FragmentC</p>
<p>需要实现的效果是进入后，默认先只加载FragmentA，具体滑动到了哪个Fragment，再去加载该Fragment的数据。</p>
<p>可以参考如下BaseLazyFragment代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">  2</span> <span style="color: #008000;"> <em> Author: wangjie<br></em></span><span style="color: #008080;">  3</span> <span style="color: #008000;">  Email: tiantian.china.2@gmail.com<br></span><span style="color: #008080;">  4</span> <span style="color: #008000;"> <em> Date: 1/23/15.<br></em></span><span style="color: #008080;">  5</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">  6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> BaseLazyFragment <span style="color: #0000ff;">extends</span><span style="color: #000000;"> BaseFragment {<br></span><span style="color: #008080;">  7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = BaseLazyFragment.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;">  8</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isPrepared;<br></span><span style="color: #008080;">  9</span><br><span style="color: #008080;"> 10</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 11</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onActivityCreated(Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 12</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onActivityCreated(savedInstanceState);<br></span><span style="color: #008080;"> 13</span> <span style="color: #000000;">        initPrepare();<br></span><span style="color: #008080;"> 14</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 15</span><br><span style="color: #008080;"> 16</span><br><span style="color: #008080;"> 17</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 18</span> <span style="color: #008000;">     <em> 第一次onResume中的调用onUserVisible避免操作与onFirstUserVisible操作重复<br></em></span><span style="color: #008080;"> 19</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isFirstResume = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 21</span><br><span style="color: #008080;"> 22</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 23</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onResume() {<br></span><span style="color: #008080;"> 24</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onResume();<br></span><span style="color: #008080;"> 25</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFirstResume) {<br></span><span style="color: #008080;"> 26</span>             isFirstResume = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 27</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 28</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (getUserVisibleHint()) {<br></span><span style="color: #008080;"> 30</span> <span style="color: #000000;">            onUserVisible();<br></span><span style="color: #008080;"> 31</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 32</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 33</span><br><span style="color: #008080;"> 34</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 35</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPause() {<br></span><span style="color: #008080;"> 36</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPause();<br></span><span style="color: #008080;"> 37</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (getUserVisibleHint()) {<br></span><span style="color: #008080;"> 38</span> <span style="color: #000000;">            onUserInvisible();<br></span><span style="color: #008080;"> 39</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 40</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isFirstVisible = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 43</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isFirstInvisible = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 44</span><br><span style="color: #008080;"> 45</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 46</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setUserVisibleHint(<span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isVisibleToUser) {<br></span><span style="color: #008080;"> 47</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.setUserVisibleHint(isVisibleToUser);<br></span><span style="color: #008080;"> 48</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isVisibleToUser) {<br></span><span style="color: #008080;"> 49</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFirstVisible) {<br></span><span style="color: #008080;"> 50</span>                 isFirstVisible = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 51</span> <span style="color: #000000;">                initPrepare();<br></span><span style="color: #008080;"> 52</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 53</span> <span style="color: #000000;">                onUserVisible();<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 55</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 56</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFirstInvisible) {<br></span><span style="color: #008080;"> 57</span>                 isFirstInvisible = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 58</span> <span style="color: #000000;">                onFirstUserInvisible();<br></span><span style="color: #008080;"> 59</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 60</span> <span style="color: #000000;">                onUserInvisible();<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 62</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 63</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 64</span><br><span style="color: #008080;"> 65</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> initPrepare() {<br></span><span style="color: #008080;"> 66</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isPrepared) {<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">            onFirstUserVisible();<br></span><span style="color: #008080;"> 68</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 69</span>             isPrepared = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 70</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 71</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 72</span><br><span style="color: #008080;"> 73</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 74</span> <span style="color: #008000;">     <em> 第一次fragment可见（进行初始化工作）<br></em></span><span style="color: #008080;"> 75</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 76</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onFirstUserVisible() {<br></span><span style="color: #008080;"> 77</span><br><span style="color: #008080;"> 78</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 81</span> <span style="color: #008000;">     <em> fragment可见（切换回来或者onResume）<br></em></span><span style="color: #008080;"> 82</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 83</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onUserVisible() {<br></span><span style="color: #008080;"> 84</span><br><span style="color: #008080;"> 85</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 86</span><br><span style="color: #008080;"> 87</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 88</span> <span style="color: #008000;">     <em> 第一次fragment不可见（不建议在此处理事件）<br></em></span><span style="color: #008080;"> 89</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 90</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onFirstUserInvisible() {<br></span><span style="color: #008080;"> 91</span><br><span style="color: #008080;"> 92</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 93</span><br><span style="color: #008080;"> 94</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 95</span> <span style="color: #008000;">     <em> fragment不可见（切换掉或者onPause）<br></em></span><span style="color: #008080;"> 96</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 97</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onUserInvisible() {<br></span><span style="color: #008080;"> 98</span><br><span style="color: #008080;"> 99</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">100</span><br><span style="color: #008080;">101</span> }</pre><br></div>

<p>如上代码，使用setUserVisibleHint方法作为回调的依据，</p>
<p>暴露出来让子类使用的新的生命周期方法为：</p>
<ul>
<li>onFirstUserVisible();</li>
</ul>
<p>第一次fragment可见（进行初始化工作）</p>
<ul>
<li>onUserVisible();&nbsp;</li>
</ul>
<p>fragment可见（切换回来或者onResume）</p>
<ul>
<li>onFirstUserInvisible();</li>
</ul>
<p>第一次fragment不可见（不建议在此处理事件）</p>
<ul>
<li>onUserInvisible();</li>
</ul>
<p>fragment不可见（切换掉或者onPause）</p>
<p>&nbsp;</p>
<p>具体的效果是：</p>
<p>1. 首先加载ViewPager，回调FragmentA（第一个默认呈现的Fragment）的onFirstUserVisible()，可以在这里进行FragmentA的初始化工作，其他Fragment保持不变。</p>
<p>2. 用户从FragmentA滑动到FragmentB，回调FragmentA的onUserInvisible()、FragmentB的onFirstUserVisible()（因为第一次切换到FragmentB，可以在这里进行初始化工作）。</p>
<p>3. 用户从FragmentB滑动到FragmentC，回调FragmentB的onUserInvisible()、FragmentC的onFirstUserVisible()（因为第一次切换到FragmentC，可以在这里进行初始化工作）。</p>
<p>4. 用户从FragmentC滑动到FragmentB，回调FragmentC的onUserInvisible()、FragmentB的onUserVisible()（因为FragmentB之前已经被加载过）。</p>
<p>5. 因为到此为止，suoyou的Fragment都已经被加载过了，所以以后这3个Fragment互相任意切换，只会回调原来Fragment的onUserInvisible()和切换后的Fragment的onUserVisible()。</p>
<p>6. 用户处于FragmentB，关闭手机屏幕，回调FragmentB的onUserInvisible()。</p>
<p>7.&nbsp;用户处于FragmentB，手机屏幕处关闭状态，然后开启手机屏幕解锁，只回调FragmentB的onUserVisible()。</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> LazyFragment </tag>
            
            <tag> lazy </tag>
            
            <tag> Fragment </tag>
            
            <tag> wechat </tag>
            
            <tag> 微信 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[android多分辨率多屏幕密度下UI适配方案]]></title>
      <url>/2015/02/02/android%E5%A4%9A%E5%88%86%E8%BE%A8%E7%8E%87%E5%A4%9A%E5%B1%8F%E5%B9%95%E5%AF%86%E5%BA%A6%E4%B8%8BUI%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88/</url>
      <content type="html"><![CDATA[<p><strong>文章转载自<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2013/0627/1393.html" target="_blank" rel="noopener">http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2013/0627/1393.html</a></strong></p>
<p><strong>摘要</strong>&nbsp;前言 Android 设计之初就考虑到了 UI 在多平台的适配，它本身提供了一套完善的适配机制，随着版本的发展适配也越来越精确， UI 适配主要受平台两个因素的影响：屏幕尺寸（屏幕的像素宽度及像素高度）和屏幕密度，针对不同的应用场景采用的适配方案也不一样，</p>
<div class="first"><br><br># 前言<br><br>Android设计之初就考虑到了UI在多平台的适配，它本身提供了一套完善的适配机制，随着版本的发展适配也越来越精确，UI适配主要受平台两个因素的影响：屏幕尺寸（屏幕的像素宽度及像素高度）和屏幕密度，针对不同的应用场景采用的适配方案也不一样，此文档仅针对Android4.0及以下版本<br><br>&nbsp;<br><br><strong>相关概念</strong><br><br><strong>分辨率：</strong>整个屏幕的像素数目，为了表示方便一般用屏幕的像素宽度（水平像素数目）乘以像素高度表示，形如1280x720，反之分辨率为1280x720的屏幕，像素宽度不一定为1280<br><br><strong>屏幕密度：</strong>表示单位面积内的像素个数，通常用dpi为单位，即每英寸多少个像素点<br><br><strong>px**</strong>：<strong>长度单位，以具体像素为单位

</strong>dp<strong>**：</strong>长度单位，与具体屏幕密度无关，显示的时候根据具体平台屏幕密度的不同最终转换为相应的像素长度，具体转换规则是: 1dp =&nbsp;（目标屏幕密度/标准密度）<em>px,标准密度为160dpi，例如，1dp长度在密度为160dpi的平台表示一个像素的长度，而在240dpi的平台则表示1.5个像素的长度<br><br><strong>屏幕尺寸：</strong>屏幕的大小，通常用屏幕对角线的长度表示<br><br># Android界面适配机制<br><br>UI界面在不同平台的适配受屏幕尺寸和屏幕密度影响，Android适配机制就是在资源后面添加对这两种因素的限定，通过不同的限定区分不同的平台资源，Android在使用资源的时候会优先选择满足本平台限定的资源，再找最接近条件的，再找默认（即不加限定），通过选择适合当前平台的资源来完成不同平台的适配。<br><br>&nbsp;<br><br>屏幕尺寸分为：small,normal,large,xlarge分别表示小，中，大，超大屏<br><br>屏幕密度分为：ldpi,mdpi,hdpi,xhdpi，它们的标准值分别是：120dpi，160dpi，240dpi，320dpi<br><br>以上划分均表示的是一个范围：<br><br><img src="http://www.jcodecraeer.com/uploads/20130627/13722624421110.jpg" alt="" title="image001.jpg"><br><br>在资源目录后面加上上面的限定就能为资源指定特定的适用平台，如下所示<br><br><img src="http://www.jcodecraeer.com/uploads/20130627/13722624942474.jpg" alt="" title="image002.jpg"><br><br>表示大屏，中密度布局会选择上面那个main.xml，超大屏，中密度会选择下面那个main.xml<br><br>&nbsp;<br><br>在实际开发过程中屏幕尺寸不够直观，android将其转换为分辨率表示，根据屏幕具体分辨率可选择相应的限定符<br><br><img src="http://www.jcodecraeer.com/uploads/20130627/13722625497179.jpg" alt="" title="image003.jpg"><br><br>小结：通过加上上述限定可以实现一个apk适配几种主流的屏幕尺寸和屏幕密度，这种限定方式比较适用于对外发布应用，不知道终端具体参数的情况，但是不能做到精确适配，对于屏幕尺寸和密度相差不大的两种平台不能很好的区分。<br><br>&nbsp;<br><br>为了解决上述问题，自Android3.2开始，引入了精确适配，理论上可以适配任意像素宽度，高度，屏幕密度的平台，需用以下方式添加限定符<br><br><img src="http://www.jcodecraeer.com/uploads/20130627/13722625806649.jpg" alt="" title="image004.jpg"><br><br>其中w1280dp表示屏幕宽度为1280dp，h752dp表示屏幕高度为752dp，160dpi表示屏幕密度，其中屏幕宽，高必须以dp为单位，在知道屏幕像素宽高度的情况下可以通过公式：1dp =&nbsp;（目标屏幕密度/标准密度）</em>px&nbsp;转换成dp单位。<br><br>例如：某平台屏幕宽，高分别为1920px，720px，屏幕密度为240dpi<br><br>适配该平台的限定为：<br><br><img src="http://www.jcodecraeer.com/uploads/20130627/13722626152563.jpg" alt="" title="image005.jpg"><br><br>或者<br><br><img src="http://www.jcodecraeer.com/uploads/20130627/13722626311624.jpg" alt="" title="image006.jpg"><br><br>根据公式1dp=（240/160）px=1.5px,宽度，高度转为dp单位分别是1280dp和480dp.<br><br>&nbsp;<br><br><strong>Android自适应不同分辨率或不同屏幕大小的layout布局(横屏|竖屏</strong>)<br><br>一：不同的layout<br><br>Android手机屏幕大小不一，有480x320, 640x360, 800x480.怎样才能让App自动适应不同的屏幕呢？<br>其实很简单，只需要在res目录下创建不同的layout文件夹，比如layout-640x360,layout-800x480,所有的layout文件在编译之后都会写入R.java里，而系统会根据屏幕的大小自己选择合适的layout进行使用。<br><br>二：hdpi、mdpi、ldpi<br><br>在之前的版本中，只有一个drawable，而2.1版本中有drawable-mdpi、drawable-ldpi、drawable-hdpi三个，这三个主要是为了支持多分辨率。<br><br>drawable- hdpi、drawable- mdpi、drawable-ldpi的区别：<br><br>(1)drawable-hdpi里面存放高分辨率的图片,如WVGA (480x800),FWVGA (480x854)<br><br>(2)drawable-mdpi里面存放中等分辨率的图片,如HVGA (320x480)<br><br>(3)drawable-ldpi里面存放低分辨率的图片,如QVGA (240x320)<br><br>　　系统会根据机器的分辨率来分别到这几个文件夹里面去找对应的图片。<br><br>更正：应该是对应不同density 的图片<br><br>　　在开发程序时为了兼容不同平台不同屏幕，建议各自文件夹根据需求均存放不同版本图片。<br><br>[i]备注：三者的解析度不一样，就像你把电脑的分辨率调低，图片会变大一样，反之分辨率高，图片缩小。 [/i]&nbsp;<br>屏幕方向：<br><br>横屏竖屏自动切换：<br><br>可以在res目录下建立layout-port-800x600和layout-land两个目录，里面分别放置竖屏和横屏两种布局文件，这样在手机屏幕方向变化的时候系统会自动调用相应的布局文件，避免一种布局文件无法满足两种屏幕显示的问题。<br><br>不同分辨率横屏竖屏自动切换：<br><br>以800x600为例<br>可以在res目录下建立layout-port-800x600和layout-land-800x600两个目录<br><br>不切换：<br><br>以下步骤是网上流传的，不过我自己之前是通过图形化界面实现这个配置，算是殊途同归，有空我会把图片贴上来。<br><br>还要说明一点：每个activity都有这个属性screenOrientation，每个activity都需要设置，可以设置为竖屏（portrait），也可以设置为无重力感应（nosensor）。<br><br>要让程序界面保持一个方向，不随手机方向转动而变化的处理办法：<br><br>在AndroidManifest.xml里面配置一下就可以了。加入这一行android:screenOrientation=”landscape”。<br>例如（landscape是横向，portrait是纵向）：<br><br>Java代码:<br><br>&lt;?xml version=”1.0” encoding=”utf-8”?&gt;<br>&lt;manifestxmlns:android=”<a href="http://schemas.android.com/apk/res/android&quot;&amp;nbsp" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android&quot;&amp;nbsp</a>;<br>package=”com.ray.linkit”&nbsp;<br>android:versionCode=”1”&nbsp;<br>android:versionName=”1.0”&gt;&nbsp;<br>&lt;application android:icon=”@drawable/icon”android:label=”@string/app_name”&gt;&nbsp;<br>&lt;activity android:name=”.Main”&nbsp;<br>android:label=”@string/app_name”&nbsp;<br>android:screenOrientation=”portrait”&gt;&nbsp;<br>&lt;intent-filter&gt;&nbsp;<br>&lt;action android:name=”android.intent.action.MAIN” /&gt;&nbsp;<br>&lt;category android:name=”android.intent.category.LAUNCHER” /&gt;&nbsp;<br>&lt;/intent-filter&gt;&nbsp;<br>&lt;/activity&gt;&nbsp;<br>&lt;activity android:name=”.GamePlay”&nbsp;<br>android:screenOrientation=”portrait”&gt;&lt;/activity&gt;&nbsp;<br>&lt;activity android:name=”.OptionView”&nbsp;<br>android:screenOrientation=”portrait”&gt;&lt;/activity&gt;&nbsp;<br>&lt;/application&gt;&nbsp;<br>&lt;uses-sdk android:minSdkVersion=”3” /&gt;&nbsp;<br>&lt;/manifest&gt;<br><br>另外，android中每次屏幕的切换动会重启Activity，所以应该在Activity销毁前保存当前活动的状态，在Activity再次Create的时候载入配置，那样，进行中的游戏就不会自动重启了！<br><br>有的程序适合从竖屏切换到横屏，或者反过来，这个时候怎么办呢？可以在配置Activity的地方进行如下的配置android:screenOrientation=”portrait”。这样就可以保证是竖屏总是竖屏了，或者landscape横向。<br><br>而有的程序是适合横竖屏切换的。如何处理呢？首先要在配置Activity的时候进行如下的配置：android:configChanges=”keyboardHidden|orientation”，另外需要重写Activity的 onConfigurationChanged方法。实现方式如下，不需要做太多的内容：<br><br>@Override&nbsp;<br>public void onConfigurationChanged(Configuration newConfig) {&nbsp;<br>super.onConfigurationChanged(newConfig);&nbsp;<br>if (this.getResources().getConfiguration().orientation ==Configuration.ORIENTATION_LANDSCAPE) {&nbsp;<br>// land do nothing is ok&nbsp;<br>} else if (this.getResources().getConfiguration().orientation ==Configuration.ORIENTATION_PORTRAIT) {&nbsp;<br>// port do nothing is ok&nbsp;<br>}&nbsp;<br>}<br><br>写一个支持多分辨的程序，基于1.6开发的，建立了三个资源文件夹drawable-hdpi drawable-mdpidrawable-ldpi，里面分别存放72<em>72 48</em>48 36<em>36的icon图标文件。当我在G1（1.5的系统）上测试时，图标应该自适应为48</em>48才对啊，但实际显示的是36<em>36。怎么才能让其自适应 48</em>48的icon图标呢<br><br>解决办法 drawable-hdpi drawable-mdpi drawable-ldpi改成drawable-480X320 drawable-800X480的多分辨支持的文件夹<br><br>对于Android游戏开发我们不得不像iPhone那样思考兼容 Android平板电脑，对于苹果要考虑iPad、iPhone 3GS和iPhone 4等屏幕之间的兼容性，对于几乎所有的分辨率总结了大约超过20中粉笔阿女郎的大小和对应关系，对于开发Android游戏而言可以考虑到未来的3.0以及很多平板电脑的需要。<br><br>常规的我们可能只考虑QVGA，HVGA，WVGA，FWVGA和DVGA，但是抛去了手机不谈，可能平板使用类似WSVGA的1024&times;576以及WXGA的1280&times;768等等。<br>QVGA = 320 <em> 240;<br>WQVGA = 320 </em> 480;<br>WQVGA2 = 400 <em> 240;<br>WQVGA3 = 432 </em> 240;<br>HVGA = 480 <em> 320;<br>VGA = 640 </em> 480;<br>WVGA = 800 <em> 480;<br>WVGA2 = 768 </em> 480;<br>FWVGA = 854 <em> 480;<br>DVGA = 960 </em> 640;<br>PAL = 576 <em> 520;<br>NTSC = 486 </em> 440;<br>SVGA = 800 <em> 600;<br>WSVGA […]<br><br>这是一个比较有代表性的Android软件资源包，drawable里面存放的是应用的图标文件，layout存放的是布局，简单说就是这些图标如何摆放。为什么Android上需要这么多资源包文件和布局文件是我们接下来需要讨论的问题。<br><br>Android设备屏幕的尺寸是各式各样的，如小米是4英寸的，Xoom平板是10英寸；分辨率也千奇百怪，800&times;480，960&times;540等；Android版本的碎片化问题更是萦绕于心，不过在设计应用时可以分为两大块：3.0之前的版本和3.0之后的版本。这种情况会带来什么问题我们用三个假设来说明一下。<br><br>1. 假设你的手上有两个4英寸的设备，设备A的分辨率是800&times;480，设备B的分辨率是1600&times;960。你在设备A上设计了一个64&times;64像素的图标，感觉它大小正合适，但放到设备B上的时候，这个图标看上去就只有之前一半大小了。<br><br>2. 假设你手上的两个设备，设备A是4英寸，设备B是10英寸。在设备A上方放了一个tab控件，有三个页签。放到设备B上看时tab控件的三个页签被拉得很长，本来放6个页签的空间只放了三个页签。<br><br>3. 假设你手上的两个设备，设备A装的是Android2.3，设备B装的是Android4.0，而设备B没有menu建，风格也不一样。你发现两个设备上用同一套风格的皮肤并不合适。<br><br>Google提供了一套体系去解决这些问题。我们再回到上面的那张图，drawable文件夹有ldpi、mdpi、hdpi、xhdpi四种。dpi指像素/英寸，而ldpi指120，mdpi指160，hdpi指240，xhdpi指320。小米手机是4英寸、854&times;480的分辨率，那么小米手机的dpi就是854的平方加480的平方和开2次方后除以4，结果大约是245。如果应用安装在小米手机上，那么系统会调用图中drawable-hdpi里面的资源。这样，你只要做4套资源分别放在drawable-ldpi、drawable-mdpi、drawable-hdpi以及drawable-xdpi下（图标可以按照3：4：6：8的比例制作图片资源），那么就可以解决上面假设1当中提到的问题。<br><br>对于相同dpi、但尺寸不一样的设备，可以通过layout文件控制各种资源的布局。Google将设备分为small（2～3英寸）、normal（4英寸左右）、large（5～7英寸）、xlarge（7英寸以上）。在上面的假设2种，我们可以在layout-normal里配置3个页签的tab栏，在layout-xlarge里配置6个页签的tab栏。如果应用在所有设备上布局都一样，那么就不用考虑针对不同尺寸的layout。从图中那些layout</em>文件夹可以看出，该应用在hdpi及xhdpi上支持横竖屏，而且横竖屏的布局不一致，但没有考虑不同尺寸的设备使用不同布局的情况。<br><br>Android3.0之前的风格与Android3.0（包含3.0）之后的风格区别很大，图中那个应用就使用了两种风格的资源及布局。Android2.3的小米会使用drawable-hdpi及layout-hdpi当中的文件，而Android4.0的小米就会使用drawable-hdpi-v11及layout-hdpi-v11里面的文件。<br><br>今天就到此为止了，有空的时候再说说9-Patch的使用。这篇文章也就只能起到抛砖引玉的作用，在实际设计应用的时候还需要多去参考其他文档资料，特别是Android开发的官方文档。<br><br></div>

]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ui </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]使用RecyclerView替代ListView（三）]]></title>
      <url>/2015/02/02/Android-%E4%BD%BF%E7%94%A8RecyclerView%E6%9B%BF%E4%BB%A3ListView%EF%BC%88%E4%B8%89%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>&nbsp;</p>
<p>这次来使用RecyclerView实现PinnedListView的效果，效果很常见：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201502/021602294536998.gif" alt=""></p>
<p>开发的代码建立在上一篇（<strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener">[Android]使用RecyclerView替代ListView（二）</a>：<a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4242541.html</a></strong>）基础之上。</p>
<p>修改布局如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><br><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">              android:orientation</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">              android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;"> 6</span> <span style="color: #ff0000;">              android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">android.support.v7.widget.Toolbar<br></span><span style="color: #008080;"> 9</span>             <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_pinned_toolbar”</span><br><span style="color: #008080;">10</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">11</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">12</span> <span style="color: #ff0000;">            android:background</span><span style="color: #0000ff;">=”?attr/colorPrimary”</span><br><span style="color: #008080;">13</span>             <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">14</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">android.support.v4.widget.SwipeRefreshLayout<br></span><span style="color: #008080;">15</span>             <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_pinned_srl”</span><br><span style="color: #008080;">16</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">17</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">18</span>             <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">com.wangjie.androidbucket.support.recyclerview.pinnedlayout.PinnedRecyclerViewLayout<br></span><span style="color: #008080;">21</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_pinned_layout”</span><br><span style="color: #008080;">22</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"> android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">23</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">android.support.v7.widget.RecyclerView<br></span><span style="color: #008080;">24</span>                     <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_pinned_rv”</span><br><span style="color: #008080;">25</span> <span style="color: #ff0000;">                    android:scrollbars</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;">26</span> <span style="color: #ff0000;">                    android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">27</span> <span style="color: #ff0000;">                    android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">28</span> <span style="color: #ff0000;">                    android:background</span><span style="color: #0000ff;">=”#bbccaa”</span><br><span style="color: #008080;">29</span>                     <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">30</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Button<br></span><span style="color: #008080;">31</span>                     <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_pinned_add_btn”</span><br><span style="color: #008080;">32</span> <span style="color: #ff0000;">                    android:layout_width</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"> android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">33</span> <span style="color: #ff0000;">                    android:layout_centerVertical</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;">34</span> <span style="color: #ff0000;">                    android:background</span><span style="color: #0000ff;">=”#abcabc”</span><br><span style="color: #008080;">35</span> <span style="color: #ff0000;">                    android:text</span><span style="color: #0000ff;">=”add”</span><br><span style="color: #008080;">36</span>                     <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">37</span><br><span style="color: #008080;">38</span>         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">com.wangjie.androidbucket.support.recyclerview.pinnedlayout.PinnedRecyclerViewLayout</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">39</span><br><span style="color: #008080;">40</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">android.support.v4.widget.SwipeRefreshLayout</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">41</span><br><span style="color: #008080;">42</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>可以看到RecyclerView是被一个<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/pinnedlayout/PinnedRecyclerViewLayout.java" target="_blank" rel="noopener">PinnedRecyclerViewLayout</a>（<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/pinnedlayout/PinnedRecyclerViewLayout.java" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/pinnedlayout/PinnedRecyclerViewLayout.java</a>）</strong>包含在里面的。这个在项目<strong><a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">AndroidBucket</a>（<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket</a>）</strong>中。先看看代码中怎么使用吧，具体实现待会说。</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> pinnedLayout.initRecyclerPinned(recyclerView, layoutManager, LayoutInflater.from(context).inflate(R.layout.recycler_view_item_float, <span style="color: #0000ff;">null</span><span style="color: #000000;">));<br></span><span style="color: #008080;">2</span> pinnedLayout.setOnRecyclerViewPinnedViewListener(<span style="color: #0000ff;">this</span>);</pre><br></div>

<p>如上，使用方式很简单：</p>
<p>Line1：初始化绑定PinnedRecyclerViewLayout和RecyclerView，并设置需要被顶上去的pinnedView</p>
<p>Line2：设置OnRecyclerViewPinnedViewListener，作用是在顶部被顶上去替换掉的时候，会回调重新渲染数据，传入的OnRecyclerViewPinnedViewListener是this，显然，此Activity实现了这个接口，实现代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 渲染pinnedView数据</span><br><span style="color: #008080;"> 2</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onPinnedViewRender(PinnedRecyclerViewLayout pinnedRecyclerViewLayout, View pinnedView, <span style="color: #0000ff;">int</span><span style="color: #000000;"> position) {<br></span><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (pinnedRecyclerViewLayout.getId()) {<br></span><span style="color: #008080;"> 5</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.recycler_view_pinned_layout:<br></span><span style="color: #008080;"> 6</span>                 TextView nameTv =<span style="color: #000000;"> (TextView) pinnedView.findViewById(R.id.recycler_view_item_float_name_tv);<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">                nameTv.setText(personList.get(position).getName());<br></span><span style="color: #008080;"> 8</span>                 TextView ageTv =<span style="color: #000000;"> (TextView) pinnedView.findViewById(R.id.recycler_view_item_float_age_tv);<br></span><span style="color: #008080;"> 9</span>                 ageTv.setText(personList.get(position).getAge() + “岁”<span style="color: #000000;">);<br></span><span style="color: #008080;">10</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">12</span>     }</pre><br></div>

<p>然后，我们来看看<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/pinnedlayout/PinnedRecyclerViewLayout.java" target="_blank" rel="noopener">PinnedRecyclerViewLayout</a></strong>是怎么实现的。</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">  2</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;">  3</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">  4</span> <span style="color: #008000;">  Date: 2/2/15.<br></span><span style="color: #008080;">  5</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;">  6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> PinnedRecyclerViewLayout <span style="color: #0000ff;">extends</span><span style="color: #000000;"> RelativeLayout {<br></span><span style="color: #008080;">  7</span><br><span style="color: #008080;">  8</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = PinnedRecyclerViewLayout.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;">  9</span><br><span style="color: #008080;"> 10</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> OnRecyclerViewPinnedViewListener {<br></span><span style="color: #008080;"> 11</span>         <span style="color: #0000ff;">void</span> onPinnedViewRender(PinnedRecyclerViewLayout pinnedRecyclerViewLayout, View pinnedView, <span style="color: #0000ff;">int</span><span style="color: #000000;"> position);<br></span><span style="color: #008080;"> 12</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 13</span><br><span style="color: #008080;"> 14</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> OnRecyclerViewPinnedViewListener onRecyclerViewPinnedViewListener;<br></span><span style="color: #008080;"> 15</span><br><span style="color: #008080;"> 16</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnRecyclerViewPinnedViewListener(OnRecyclerViewPinnedViewListener onRecyclerViewPinnedViewListener) {<br></span><span style="color: #008080;"> 17</span>         <span style="color: #0000ff;">this</span>.onRecyclerViewPinnedViewListener =<span style="color: #000000;"> onRecyclerViewPinnedViewListener;<br></span><span style="color: #008080;"> 18</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 19</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> PinnedRecyclerViewLayout(Context context) {<br></span><span style="color: #008080;"> 21</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;"> 22</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 23</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 24</span><br><span style="color: #008080;"> 25</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> PinnedRecyclerViewLayout(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;"> 26</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;"> 27</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 28</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 29</span><br><span style="color: #008080;"> 30</span>     <span style="color: #0000ff;">public</span> PinnedRecyclerViewLayout(Context context, AttributeSet attrs, <span style="color: #0000ff;">int</span><span style="color: #000000;"> defStyleAttr) {<br></span><span style="color: #008080;"> 31</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs, defStyleAttr);<br></span><span style="color: #008080;"> 32</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 34</span><br><span style="color: #008080;"> 35</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> init(Context context) {<br></span><span style="color: #008080;"> 36</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 37</span><br><span style="color: #008080;"> 38</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> View pinnedView;<br></span><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> ABaseLinearLayoutManager layoutManager;<br></span><span style="color: #008080;"> 40</span><br><span style="color: #008080;"> 41</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> initRecyclerPinned(RecyclerView recyclerView, ABaseLinearLayoutManager layoutManager, View pinnedView) {<br></span><span style="color: #008080;"> 42</span>         <span style="color: #0000ff;">this</span>.pinnedView =<span style="color: #000000;"> pinnedView;<br></span><span style="color: #008080;"> 43</span>         <span style="color: #0000ff;">this</span>.layoutManager =<span style="color: #000000;"> layoutManager;<br></span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">this</span>.addView(<span style="color: #0000ff;">this</span><span style="color: #000000;">.pinnedView);<br></span><span style="color: #008080;"> 45</span>         RelativeLayout.LayoutParams lp = <span style="color: #0000ff;">new</span><span style="color: #000000;"> RelativeLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT);<br></span><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">this</span><span style="color: #000000;">.pinnedView.setLayoutParams(lp);<br></span><span style="color: #008080;"> 47</span>         layoutManager.getRecyclerViewScrollManager().addScrollListener(recyclerView, <span style="color: #0000ff;">new</span><span style="color: #000000;"> OnRecyclerViewScrollListener() {<br></span><span style="color: #008080;"> 48</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 49</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onScrollStateChanged(RecyclerView recyclerView, <span style="color: #0000ff;">int</span><span style="color: #000000;"> newState) {<br></span><span style="color: #008080;"> 50</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 51</span><br><span style="color: #008080;"> 52</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 53</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onScrolled(RecyclerView recyclerView, <span style="color: #0000ff;">int</span> dx, <span style="color: #0000ff;">int</span><span style="color: #000000;"> dy) {<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">                refreshPinnedView();<br></span><span style="color: #008080;"> 55</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;"> 57</span> <span style="color: #000000;">        pinnedView.setVisibility(GONE);<br></span><span style="color: #008080;"> 58</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 59</span><br><span style="color: #008080;"> 60</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 保存上次的position</span><br><span style="color: #008080;"> 61</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> lastPosition =<span style="color: #000000;"> RecyclerView.NO_POSITION;<br></span><span style="color: #008080;"> 62</span><br><span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> refreshPinnedView() {<br></span><span style="color: #008080;"> 64</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> == pinnedView || <span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> layoutManager) {<br></span><span style="color: #008080;"> 65</span>             Logger.e(TAG, “Please init pinnedView and layoutManager with initRecyclerPinned method first!”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 66</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 68</span>         <span style="color: #0000ff;">if</span> (VISIBLE !=<span style="color: #000000;"> pinnedView.getVisibility()) {<br></span><span style="color: #008080;"> 69</span> <span style="color: #000000;">            pinnedView.setVisibility(VISIBLE);<br></span><span style="color: #008080;"> 70</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 71</span>         <span style="color: #0000ff;">int</span> curPosition =<span style="color: #000000;"> layoutManager.findFirstVisibleItemPosition();<br></span><span style="color: #008080;"> 72</span>         <span style="color: #0000ff;">if</span> (RecyclerView.NO_POSITION ==<span style="color: #000000;"> curPosition) {<br></span><span style="color: #008080;"> 73</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 74</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 75</span>         View curItemView =<span style="color: #000000;"> layoutManager.findViewByPosition(curPosition);<br></span><span style="color: #008080;"> 76</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> curItemView) {<br></span><span style="color: #008080;"> 77</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 78</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 79</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 如果当前的curPosition和上次的lastPosition不一样，则说明需要重新刷新数据，避免curPosition一样的情况下重复刷新相同数据</span><br><span style="color: #008080;"> 80</span>         <span style="color: #0000ff;">if</span> (curPosition !=<span style="color: #000000;"> lastPosition) {<br></span><span style="color: #008080;"> 81</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> onRecyclerViewPinnedViewListener) {<br></span><span style="color: #008080;"> 82</span>                 onRecyclerViewPinnedViewListener.onPinnedViewRender(<span style="color: #0000ff;">this</span><span style="color: #000000;">, pinnedView, curPosition);<br></span><span style="color: #008080;"> 83</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 84</span>             lastPosition =<span style="color: #000000;"> curPosition;<br></span><span style="color: #008080;"> 85</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 86</span><br><span style="color: #008080;"> 87</span>         <span style="color: #0000ff;">int</span><span style="color: #000000;"> displayTop;<br></span><span style="color: #008080;"> 88</span>         <span style="color: #0000ff;">int</span> itemHeight =<span style="color: #000000;"> curItemView.getHeight();<br></span><span style="color: #008080;"> 89</span>         <span style="color: #0000ff;">int</span> curTop =<span style="color: #000000;"> curItemView.getTop();<br></span><span style="color: #008080;"> 90</span>         <span style="color: #0000ff;">int</span> floatHeight =<span style="color: #000000;"> pinnedView.getHeight();<br></span><span style="color: #008080;"> 91</span>         <span style="color: #0000ff;">if</span> (curTop &lt; floatHeight -<span style="color: #000000;"> itemHeight) {<br></span><span style="color: #008080;"> 92</span>             displayTop = itemHeight + curTop -<span style="color: #000000;"> floatHeight;<br></span><span style="color: #008080;"> 93</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 94</span>             displayTop = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 95</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 96</span>         RelativeLayout.LayoutParams lp =<span style="color: #000000;"> (LayoutParams) pinnedView.getLayoutParams();<br></span><span style="color: #008080;"> 97</span>         lp.topMargin =<span style="color: #000000;"> displayTop;<br></span><span style="color: #008080;"> 98</span> <span style="color: #000000;">        pinnedView.setLayoutParams(lp);<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">        pinnedView.invalidate();<br></span><span style="color: #008080;">100</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">101</span><br><span style="color: #008080;">102</span><br><span style="color: #008080;">103</span> }</pre><br></div>

<p>&nbsp;</p>
<p>这个<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/pinnedlayout/PinnedRecyclerViewLayout.java" target="_blank" rel="noopener">PinnedRecyclerViewLayout</a>&nbsp;</strong>是继承RelativeLayout的，因为我们需要在里面添加一个被顶上去的pinnedView，需要覆盖在RecyclerView上面。</p>
<p>Line44：把传进来的pinnedView增加到<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/pinnedlayout/PinnedRecyclerViewLayout.java" target="_blank" rel="noopener">PinnedRecyclerViewLayout</a>&nbsp;</strong>里面</p>
<p>Line47～56：在ABaseLinearLayoutManager中增加一个滚动的监听器，因为我们需要在滚动的时候动态的改变pinnedView的位置，这样才能模拟顶上去的效果。并滚动时调用refreshPinnedView来刷新pinnedView的位置。</p>
<p>Line57：因为在调用initRecyclerPinned方法时，RecyclerView可能还没有数据源，所以不需要显示这个pinnedView，等到真正滚动的时候再显示就可以了。</p>
<p>refreshPinnedView()方法的作用是在滚动的同时用来刷新pinnedView的位置和显示的数据：</p>
<p>Line71～78：通过layoutManager获取当前第一个显示的数据position，然后根据position获取当前第一个显示的View。</p>
<p>Line79~85：如果当前的curPosition和上次的lastPosition不一样，则说明需要重新刷新数据，避免curPosition一样的情况下重复刷新相同数据。</p>
<p>Line87～95：根据当前第一个显示的View，根据它的top、它的高度和pinnedView的高度计算出pinnedView需要往上移动的距离（画个几何图一目了然了）。</p>
<p>Line96～99：刷新pinnedView的位置</p>
<p>&nbsp;</p>
<p><strong>示例代码：</strong></p>
<p><strong><a href="https://github.com/wangjiegulu/RecyclerViewSample" target="_blank" rel="noopener">https://github.com/wangjiegulu/RecyclerViewSample</a></strong></p>
<p>&nbsp;</p>
<p><span style="font-size: 16px; color: #ff0000;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4232560.html" target="_blank" rel="noopener"><span style="color: #ff0000;">[Android]使用RecyclerView替代ListView（一）</span></a></strong>：</span></p>
<p><span style="font-size: 16px;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4232560.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4232560.html</a></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><span style="font-size: 16px;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener"><span style="color: #ff0000;">[Android]使用RecyclerView替代ListView（二）</span></a></strong>：</span>&nbsp;</span></p>
<p><strong><span style="font-size: 16px;"><span style="color: #ff0000;"><a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4242541.html</a></span></span></strong></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ListView </tag>
            
            <tag> best practices </tag>
            
            <tag> RecyclerView </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]使用RecyclerView替代ListView（二）]]></title>
      <url>/2015/01/22/Android-%E4%BD%BF%E7%94%A8RecyclerView%E6%9B%BF%E4%BB%A3ListView%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>以前写过一篇&ldquo;<a href="http://www.cnblogs.com/tiantianbyconan/p/3992843.html" target="_blank" rel="noopener">[Android]使用AdapterTypeRender对不同类型的item数据到UI的渲染</a>（<a href="http://www.cnblogs.com/tiantianbyconan/p/3992843.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/3992843.html</a>）&rdquo;，用于在有很多不同类型不同布局的item的时候怎么去较好的进行view的绑定和数据的渲染，但是这个是针对ListView写的。这次我针对RecyclerView也重新实现了一遍。</p>
<p>接下来演示下怎么去渲染不同类型的item，并且使它支持下拉刷新，滚动到底部显示加载进度条显示。</p>
<p>以下所有的封装都在<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener"><strong>AndroidBucket</strong></a>项目中：<strong><a href="https://github.com/wangjiegulu/AndroidBucket/tree/master/src/com/wangjie/androidbucket/support/recyclerview" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/tree/master/src/com/wangjie/androidbucket/support/recyclerview</a>
</strong></p>
<p><img src="http://images.cnitblog.com/blog/378300/201501/221902087508177.png" alt="">&nbsp;<img src="http://images.cnitblog.com/blog/378300/201501/221902461722079.png" alt=""></p>
<p>使用的方式如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">final</span> View footerView = LayoutInflater.from(context).inflate(R.layout.recycler_view_item_type_footer, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 2</span> <span style="color: #008000;">//</span><span style="color: #008000;">        不知道为什么在xml设置的&ldquo;android:layout_width=”match_parent”&rdquo;无效了，需要在这里重新设置</span><br><span style="color: #008080;"> 3</span>         LinearLayout.LayoutParams lp = <span style="color: #0000ff;">new</span><span style="color: #000000;"> LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT);<br></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">        footerView.setLayoutParams(lp);<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span>         recyclerView.setHasFixedSize(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">final</span> ABaseLinearLayoutManager layoutManager = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ABaseLinearLayoutManager(context);<br></span><span style="color: #008080;"> 9</span>         layoutManager.setOnRecyclerViewScrollLocationListener(recyclerView, <span style="color: #0000ff;">new</span><span style="color: #000000;"> OnRecyclerViewScrollLocationListener() {<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">11</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onTopWhenScrollIdle(RecyclerView recyclerView) {<br></span><span style="color: #008080;">12</span>                 Logger.d(TAG, “onTopWhenScrollIdle…”<span style="color: #000000;">);<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">16</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onBottomWhenScrollIdle(RecyclerView recyclerView) {<br></span><span style="color: #008080;">17</span>                 Logger.d(TAG, “onBottomWhenScrollIdle…”<span style="color: #000000;">);<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">                footerView.setVisibility(View.VISIBLE);<br></span><span style="color: #008080;">19</span>                 ThreadPool.go(<span style="color: #0000ff;">new</span> Runtask&lt;Object, Object&gt;<span style="color: #000000;">() {<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">                    @Override<br></span><span style="color: #008080;">21</span>                     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Object runInBackground() {<br></span><span style="color: #008080;">22</span>                         ABThreadUtil.sleep(3000<span style="color: #000000;">);<br></span><span style="color: #008080;">23</span>                         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">25</span><br><span style="color: #008080;">26</span> <span style="color: #000000;">                    @Override<br></span><span style="color: #008080;">27</span>                     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onResult(Object result) {<br></span><span style="color: #008080;">28</span>                         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onResult(result);<br></span><span style="color: #008080;">29</span>                         refreshLayout.setRefreshing(<span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">                        footerView.setVisibility(View.GONE);<br></span><span style="color: #008080;">31</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">                });<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">        layoutManager.setOrientation(LinearLayoutManager.VERTICAL);<br></span><span style="color: #008080;">36</span>         layoutManager.getRecyclerViewScrollManager().addScrollListener(recyclerView, <span style="color: #0000ff;">new</span><span style="color: #000000;"> OnRecyclerViewScrollListener() {<br></span><span style="color: #008080;">37</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">38</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onScrollStateChanged(RecyclerView recyclerView, <span style="color: #0000ff;">int</span><span style="color: #000000;"> newState) {<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">42</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onScrolled(RecyclerView recyclerView, <span style="color: #0000ff;">int</span> dx, <span style="color: #0000ff;">int</span><span style="color: #000000;"> dy) {<br></span><span style="color: #008080;">43</span>                 refreshLayout.setEnabled(layoutManager.findFirstCompletelyVisibleItemPosition() == 0<span style="color: #000000;">);<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">46</span> <span style="color: #000000;">        recyclerView.setLayoutManager(layoutManager);<br></span><span style="color: #008080;">47</span><br><span style="color: #008080;">48</span> <span style="color: #000000;">        initData();<br></span><span style="color: #008080;">49</span><br><span style="color: #008080;">50</span>         adapter = <span style="color: #0000ff;">new</span> PersonTypeAdapter(context, personList, <span style="color: #0000ff;">null</span><span style="color: #000000;">, footerView);<br></span><span style="color: #008080;">51</span>         adapter.setOnRecyclerViewListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">52</span> <span style="color: #000000;">        recyclerView.setAdapter(adapter);<br></span><span style="color: #008080;">53</span><br><span style="color: #008080;">54</span> <span style="color: #000000;">        refreshLayout.setColorSchemeColors(Color.BLUE, Color.RED, Color.YELLOW, Color.GREEN);<br></span><span style="color: #008080;">55</span>         refreshLayout.setOnRefreshListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> SwipeRefreshLayout.OnRefreshListener() {<br></span><span style="color: #008080;">56</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">57</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onRefresh() {<br></span><span style="color: #008080;">58</span>                 ThreadPool.go(<span style="color: #0000ff;">new</span> Runtask&lt;Object, Object&gt;<span style="color: #000000;">() {<br></span><span style="color: #008080;">59</span> <span style="color: #000000;">                    @Override<br></span><span style="color: #008080;">60</span>                     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Object runInBackground() {<br></span><span style="color: #008080;">61</span>                         ABThreadUtil.sleep(3000<span style="color: #000000;">);<br></span><span style="color: #008080;">62</span>                         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">63</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">64</span><br><span style="color: #008080;">65</span> <span style="color: #000000;">                    @Override<br></span><span style="color: #008080;">66</span>                     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onResult(Object result) {<br></span><span style="color: #008080;">67</span>                         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onResult(result);<br></span><span style="color: #008080;">68</span>                         refreshLayout.setRefreshing(<span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">                        footerView.setVisibility(View.GONE);<br></span><span style="color: #008080;">70</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">71</span> <span style="color: #000000;">                });<br></span><span style="color: #008080;">72</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">73</span>         });</pre><br></div>

<p>&nbsp;</p>
<p><span style="line-height: 1.5;">如上述代码：</span></p>
<p>Line1：从布局文件中inflate出一个View实例，这个View实例，下面会被用于作为下载提示的footer。</p>
<p>Line8：生成一个<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/layoutmanager/ABaseLinearLayoutManager.java" target="_blank" rel="noopener">ABaseLinearLayoutManager</a></strong>实例，显然这个类是继承LinearLayoutManager之后扩展的，详见：<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/layoutmanager/ABaseLinearLayoutManager.java" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/layoutmanager/ABaseLinearLayoutManager.java</a>，这个类对滑动的监听进行了扩展，可以监听滑动到顶部或者底部的事件</p>
<p>Line9～34：设置滑动到顶部或底部的监听器，然后一旦滑动到底部则加载更多数据。</p>
<p>Line36～45：也是设置滑动监听器，滑动过程中如果不是处在第一个item，如果是，则就可以下拉使用SwipeRefreshLayout进行刷新，如果不是则，仅用SwipeRefreshLayout。之所以需要做这个处理，是因为Google事件处理的一个bug－－。</p>
<p>Line50：使用了一个PersonTypeAdapter，这个类继承了<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraViewAdapter.java" target="_blank" rel="noopener">ABRecyclerViewTypeExtraViewAdapter</a>，</strong>这个类继承RecyclerView.Adapter实现了对不同type渲染数据的封装。</p>
<p>&nbsp;</p>
<p>接下来重点分析下ABRecyclerViewTypeExtraViewAdapter这个类（这个类在平常使用时不需要关注）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">  2</span> <span style="color: #008000;"> <em> Author: wangjie<br></em></span><span style="color: #008080;">  3</span> <span style="color: #008000;">  Email: tiantian.china.2@gmail.com<br></span><span style="color: #008080;">  4</span> <span style="color: #008000;"> <em> Date: 1/22/15.<br></em></span><span style="color: #008080;">  5</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">  6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">class</span> ABRecyclerViewTypeExtraViewAdapter <span style="color: #0000ff;">extends</span> RecyclerView.Adapter&lt;ABRecyclerViewTypeExtraHolder&gt;<span style="color: #000000;"> {<br></span><span style="color: #008080;">  7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> TYPE_HEADER_VIEW = 0x7683<span style="color: #000000;">;<br></span><span style="color: #008080;">  8</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> View headerView;<br></span><span style="color: #008080;">  9</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> TYPE_FOOTER_VIEW = 0x7684<span style="color: #000000;">;<br></span><span style="color: #008080;"> 10</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> View footerView;<br></span><span style="color: #008080;"> 11</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> extraCount;<br></span><span style="color: #008080;"> 12</span><br><span style="color: #008080;"> 13</span>     <span style="color: #0000ff;">protected</span><span style="color: #000000;"> ABRecyclerViewTypeExtraViewAdapter(View headerView, View footerView) {<br></span><span style="color: #008080;"> 14</span>         <span style="color: #0000ff;">this</span>.headerView =<span style="color: #000000;"> headerView;<br></span><span style="color: #008080;"> 15</span>         <span style="color: #0000ff;">this</span>.footerView =<span style="color: #000000;"> footerView;<br></span><span style="color: #008080;"> 16</span>         extraCount += hasHeaderView() ? 0 : 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 17</span>         extraCount += hasFooterView() ? 0 : 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 18</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 19</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> hasHeaderView() {<br></span><span style="color: #008080;"> 21</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> headerView;<br></span><span style="color: #008080;"> 22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 23</span><br><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> hasFooterView() {<br></span><span style="color: #008080;"> 25</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> footerView;<br></span><span style="color: #008080;"> 26</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 27</span><br><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> innerPositionToRealItemPosition(<span style="color: #0000ff;">int</span><span style="color: #000000;"> innerPosition) {<br></span><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">return</span> hasHeaderView() ? innerPosition - 1<span style="color: #000000;"> : innerPosition;<br></span><span style="color: #008080;"> 30</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 31</span><br><span style="color: #008080;"> 32</span> <span style="color: #000000;">    @TargetApi(Build.VERSION_CODES.DONUT)<br></span><span style="color: #008080;"> 33</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 34</span>     <span style="color: #0000ff;">public</span> ABRecyclerViewTypeExtraHolder onCreateViewHolder(ViewGroup viewGroup, <span style="color: #0000ff;">int</span><span style="color: #000000;"> viewType) {<br></span><span style="color: #008080;"> 35</span>         ABAdapterTypeRender&lt;ABRecyclerViewTypeExtraHolder&gt; render =<span style="color: #000000;"> getAdapterTypeRender(viewType);<br></span><span style="color: #008080;"> 36</span>         ABRecyclerViewTypeExtraHolder holder =<span style="color: #000000;"> render.getReusableComponent();<br></span><span style="color: #008080;"> 37</span> <span style="color: #000000;">        holder.itemView.setTag(R.id.ab<strong>id_adapter_item_type_render, render);<br></strong></span><span style="color: #008080;"> 38</span> <span style="color: #000000;">        render.fitEvents();<br></span><span style="color: #008080;"> 39</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> holder;<br></span><span style="color: #008080;"> 40</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span> <span style="color: #000000;">    @TargetApi(Build.VERSION_CODES.DONUT)<br></span><span style="color: #008080;"> 43</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 44</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onBindViewHolder(ABRecyclerViewTypeExtraHolder holder, <span style="color: #0000ff;">int</span><span style="color: #000000;"> innerPosition) {<br></span><span style="color: #008080;"> 45</span>         ABAdapterTypeRender&lt;ABRecyclerViewTypeExtraHolder&gt; render = (ABAdapterTypeRender&lt;ABRecyclerViewTypeExtraHolder&gt;<span style="color: #000000;">) holder.itemView.getTag(R.id.abid_adapter_item_type_render);<br></span><span style="color: #008080;"> 46</span>         <span style="color: #008000;">/</span><br><span style="color: #008080;"> 47</span> <span style="color: #008000;">         <em> 计算该item在list中的index（不包括headerView和footerView）<br></em></span><span style="color: #008080;"> 48</span>          <span style="color: #008000;">/</span><br><span style="color: #008080;"> 49</span>         <span style="color: #0000ff;">int</span> realItemPosition =<span style="color: #000000;"> innerPositionToRealItemPosition(innerPosition);<br></span><span style="color: #008080;"> 50</span> <span style="color: #000000;">        render.fitDatas(realItemPosition);<br></span><span style="color: #008080;"> 51</span>         <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 52</span> <span style="color: #008000;">         <em> 重新设置item在list中的index（不包括headerView和footerView）<br></em></span><span style="color: #008080;"> 53</span>          <span style="color: #008000;">/</span><br><span style="color: #008080;"> 54</span> <span style="color: #000000;">        holder.setRealItemPosition(realItemPosition);<br></span><span style="color: #008080;"> 55</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 56</span><br><span style="color: #008080;"> 57</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 58</span> <span style="color: #008000;">     <em> 通过类型获得对应的render（不包括headerView和footerView）<br></em></span><span style="color: #008080;"> 59</span> <span style="color: #008000;">     <br></span><span style="color: #008080;"> 60</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> type<br></span><span style="color: #008080;"> 61</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 62</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> ABAdapterTypeRender&lt;ABRecyclerViewTypeExtraHolder&gt; getAdapterTypeRenderExcludeExtraView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> type);<br></span><span style="color: #008080;"> 64</span><br><span style="color: #008080;"> 65</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 66</span> <span style="color: #008000;">      获取item的数量（不包括headerView和footerView）<br></span><span style="color: #008080;"> 67</span> <span style="color: #008000;">     <em><br></em></span><span style="color: #008080;"> 68</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 69</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 70</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getItemCountExcludeExtraView();<br></span><span style="color: #008080;"> 71</span><br><span style="color: #008080;"> 72</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 73</span> <span style="color: #008000;">      通过realItemPosition得到该item的类型（不包括headerView和footerView）<br></span><span style="color: #008080;"> 74</span> <span style="color: #008000;">     <em><br></em></span><span style="color: #008080;"> 75</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> realItemPosition<br></span><span style="color: #008080;"> 76</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 77</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 78</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">int</span> getItemViewTypeExcludeExtraView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> realItemPosition);<br></span><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span>     <span style="color: #0000ff;">public</span> ABAdapterTypeRender&lt;ABRecyclerViewTypeExtraHolder&gt; getAdapterTypeRender(<span style="color: #0000ff;">int</span><span style="color: #000000;"> type) {<br></span><span style="color: #008080;"> 81</span>         <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (type) {<br></span><span style="color: #008080;"> 82</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> TYPE_HEADER_VIEW:<br></span><span style="color: #008080;"> 83</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ABRecyclerViewTypeExtraRender(headerView);<br></span><span style="color: #008080;"> 84</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> TYPE_FOOTER_VIEW:<br></span><span style="color: #008080;"> 85</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ABRecyclerViewTypeExtraRender(footerView);<br></span><span style="color: #008080;"> 86</span>             <span style="color: #0000ff;">default</span><span style="color: #000000;">:<br></span><span style="color: #008080;"> 87</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> getAdapterTypeRenderExcludeExtraView(type);<br></span><span style="color: #008080;"> 88</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 89</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 90</span><br><span style="color: #008080;"> 91</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 92</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getItemCount() {<br></span><span style="color: #008080;"> 93</span>         <span style="color: #0000ff;">return</span> getItemCountExcludeExtraView() +<span style="color: #000000;"> extraCount;<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 95</span><br><span style="color: #008080;"> 96</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 97</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> getItemViewType(<span style="color: #0000ff;">int</span><span style="color: #000000;"> innerPosition) {<br></span><span style="color: #008080;"> 98</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> != headerView &amp;&amp; 0 == innerPosition) { <span style="color: #008000;">//</span><span style="color: #008000;"> header</span><br><span style="color: #008080;"> 99</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> TYPE_HEADER_VIEW;<br></span><span style="color: #008080;">100</span>         } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> != footerView &amp;&amp; getItemCount() - 1 == innerPosition) { <span style="color: #008000;">//</span><span style="color: #008000;"> footer</span><br><span style="color: #008080;">101</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> TYPE_FOOTER_VIEW;<br></span><span style="color: #008080;">102</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">103</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> getItemViewTypeExcludeExtraView(innerPositionToRealItemPosition(innerPosition));<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">105</span> }</pre><br></div>

<p>如上述代码所示：</p>
<p>因为我们的需求是需要添加&ldquo;加载进度条&rdquo;，所以需要像ListView那样，添加一个FooterView。可是坑爹的是，RecyclerView不提供addheaderView()和addFooterView()方法，所以只能我们自己去实现了，方法当然是使用不同type来区分类型。虽然headerView这里没有用到，但是也顺带实现下好了。</p>
<p>这里我们使用的Holder是<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraHolder.java" target="_blank" rel="noopener"><strong>ABRecyclerViewTypeExtraHolder</strong></a>，这个类待会分析。</p>
<p>headerView和footerView这里使用构造方法传入，并缓存headerView和footerView。在onCreateViewHolder中，我们通过不同type，生成相应的render。并把render绑定到holder的itemView上面，因为既然现在复用的是holder，那我的render也要实现复用的话，也绑定在holder里面吧。然后调用render的fitEvents方法，来实现render里面的事件绑定。</p>
<p>onBindViewHolder方法中，通过holder，取出render，然后注意Line49～54，里面执行了innerPositionToRealItemPosition()方法对innerPosition到RealItemPosition的转换，这里的innerPosition代表内部的position，因为这里可能会添加了headerView，一旦添加了headerView，那position跟数据源List中的index就不匹配了，这样的话绑定点击事件后，通过holder.getPositon()得到的position就不是index了，所以不能写&ldquo;list.get(position)…&rdquo;了。这里的realItemPosition就代表数据源对应的index 。所以我们要把innerPosition转换为realItemPosition，方法很简单，innerPosition－1=realItemPosition（这里的减去1实际上就是减去了headerView）。其实holder中本来就缓存了当前使用了这个holder的item的position，但是因为有了headerView的存在，position就不等于realItemPosition了，所以我们还需要缓存realItemPosition。所以代码Line46～54诞生了。</p>
<p>getItemCountExcludeExtraView()方法需要子类实现，返回数据源中的数据数量，然后再加上extraCount即是getItemCount的值。</p>
<p>getItemViewType()方法先执行了header类型和footer类型的逻辑，然后再让自类去实现getItemViewTypeExcludeExtraView()来执行其他类型的逻辑。</p>
<p>至于<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraRender.java" target="_blank" rel="noopener">ABRecyclerViewTypeExtraRender</a>（<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraRender.java" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraRender.java</a>）</strong></p>
<p>部分的实现可以查看</p>
<p><strong><a href="http://www.cnblogs.com/[Android]使用AdapterTypeRender对不同类型的item数据到UI的渲染" target="_blank" rel="noopener">[Android]使用AdapterTypeRender对不同类型的item数据到UI的渲染</a></strong>（<strong><a href="http://www.cnblogs.com/tiantianbyconan/p/3992843.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/3992843.html</a></strong>）</p>
<p>实现的原理大同小异了。</p>
<p>&nbsp;</p>
<p>然后分析下<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraHolder.java" target="_blank" rel="noopener">ABRecyclerViewTypeExtraHolder</a>（<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraHolder.java" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraHolder.java</a>）</strong>这个类，代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;"> <em> Author: wangjie<br></em></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">  Email: tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;"> <em> Date: 1/22/15.<br></em></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> ABRecyclerViewTypeExtraHolder <span style="color: #0000ff;">extends</span><span style="color: #000000;"> ABRecyclerViewHolder {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ABRecyclerViewTypeExtraHolder(View itemView) {<br></span><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(itemView);<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">12</span> <span style="color: #008000;">     <em> 保存当前position（list index，不包括headerView和footerView）<br></em></span><span style="color: #008080;">13</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">14</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> realItemPosition;<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getRealItemPosition() {<br></span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> realItemPosition;<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> setRealItemPosition(<span style="color: #0000ff;">int</span><span style="color: #000000;"> realItemPosition) {<br></span><span style="color: #008080;">21</span>         <span style="color: #0000ff;">this</span>.realItemPosition =<span style="color: #000000;"> realItemPosition;<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span> }</pre><br></div>

<p>它继承了<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/ABRecyclerViewHolder.java" target="_blank" rel="noopener"><strong>ABRecyclerViewHolder</strong></a>（<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/ABRecyclerViewHolder.java" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/ABRecyclerViewHolder.java</a></strong>），只是保存了一个刚刚讲到的realItemPosition对象。</p>
<p>所以我们再贴下<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/ABRecyclerViewHolder.java" target="_blank" rel="noopener">ABRecyclerViewHolder</a></strong>的代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;"> <em> Author: wangjie<br></em></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">  Email: tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;"> <em> Date: 1/19/15.<br></em></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> ABRecyclerViewHolder <span style="color: #0000ff;">extends</span><span style="color: #000000;"> RecyclerView.ViewHolder {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = ABRecyclerViewHolder.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">private</span> SparseArray&lt;View&gt; holder = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ABRecyclerViewHolder(View itemView) {<br></span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(itemView);<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">15</span> <span style="color: #008000;">     <em> 获取一个缓存的view<br></em></span><span style="color: #008080;">16</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">17</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> id<br></span><span style="color: #008080;">18</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> &lt;T&gt;<br></span><span style="color: #008080;">19</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">20</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span> &lt;T <span style="color: #0000ff;">extends</span> View&gt; T obtainView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> id) {<br></span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> holder) {<br></span><span style="color: #008080;">23</span>             holder = <span style="color: #0000ff;">new</span> SparseArray&lt;&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">25</span>         View view =<span style="color: #000000;"> holder.get(id);<br></span><span style="color: #008080;">26</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> view) {<br></span><span style="color: #008080;">27</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> (T) view;<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">29</span>         view =<span style="color: #000000;"> itemView.findViewById(id);<br></span><span style="color: #008080;">30</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> view) {<br></span><span style="color: #008080;">31</span>             Logger.e(TAG, “no view that id is “ +<span style="color: #000000;"> id);<br></span><span style="color: #008080;">32</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">        holder.put(id, view);<br></span><span style="color: #008080;">35</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> (T) view;<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">37</span><br><span style="color: #008080;">38</span>     <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">39</span> <span style="color: #008000;">      获取一个缓存的view，并自动转型<br></span><span style="color: #008080;">40</span> <span style="color: #008000;">     <em><br></em></span><span style="color: #008080;">41</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> id<br></span><span style="color: #008080;">42</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> &lt;T&gt;<br></span><span style="color: #008080;">43</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;">44</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">45</span>     <span style="color: #0000ff;">public</span> &lt;T&gt; T obtainView(<span style="color: #0000ff;">int</span> id, Class&lt;T&gt;<span style="color: #000000;"> viewClazz) {<br></span><span style="color: #008080;">46</span>         View view =<span style="color: #000000;"> obtainView(id);<br></span><span style="color: #008080;">47</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> view) {<br></span><span style="color: #008080;">48</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">49</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">50</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> (T) view;<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">52</span><br><span style="color: #008080;">53</span> }</pre><br></div>

<p>然后发现，它的作用是在于使用SparseArray来缓存findViewById后的控件。这样做的好处是，这个holder可以适用于任何的RecyclerView.Adapter中。只要通过obtainView()方法就能得到itemView中的具体的view对象，如下代码所示：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> Person person =<span style="color: #000000;"> adapter.getList().get(position);<br></span><span style="color: #008080;">2</span> holder.obtainView(R.id.recycler_view_test_item_person_name_tv, TextView.<span style="color: #0000ff;">class</span><span style="color: #000000;">).setText(person.getName());＝<br></span><span style="color: #008080;">3</span> holder.obtainView(R.id.recycler_view_test_item_person_age_tv, TextView.<span style="color: #0000ff;">class</span>).setText(person.getAge() + “岁”);</pre><br></div>

<p>&nbsp;</p>
<p><strong>示例代码：</strong></p>
<p><strong><a href="https://github.com/wangjiegulu/RecyclerViewSample" target="_blank" rel="noopener">https://github.com/wangjiegulu/RecyclerViewSample</a></strong></p>
<p>&nbsp;</p>
<p><span style="font-size: 16px; color: #ff0000;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4232560.html" target="_blank" rel="noopener"><span style="color: #ff0000;">[Android]使用RecyclerView替代ListView（一）</span></a></strong>：</span></p>
<p><span style="font-size: 16px;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4232560.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4232560.html</a></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><span style="font-size: 16px;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4268097.html" target="_blank" rel="noopener"><span style="color: #ff0000;">[Android]使用RecyclerView替代ListView（三）</span></a></strong>：</span>&nbsp;</span></p>
<p><span style="font-size: 16px; line-height: 24px;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4268097.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4268097.html</a></strong></span></p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ListView </tag>
            
            <tag> best practices </tag>
            
            <tag> RecyclerView </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]使用RecyclerView替代ListView（一）]]></title>
      <url>/2015/01/18/Android-%E4%BD%BF%E7%94%A8RecyclerView%E6%9B%BF%E4%BB%A3ListView%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>RecyclerView是一个比ListView更灵活的一个控件，以后可以直接抛弃ListView了。具体好在哪些地方，往下看就知道了。</p>
<p>首先我们来使用RecyclerView来实现ListView的效果，一个滚动列表，先看下效果图（除了有动画之外，没什么特别－－）：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201501/182259096511353.png" alt=""></p>
<p>&nbsp;</p>
<p>每个item的布局如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><span style="color: #ff0000;"><br>              android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_test_item_person_view”</span><span style="color: #ff0000;"><br>              android:orientation</span><span style="color: #0000ff;">=”vertical”</span><span style="color: #ff0000;"><br>              android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br>              android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br>              android:padding</span><span style="color: #0000ff;">=”15dp”</span><span style="color: #ff0000;"><br>              android:background</span><span style="color: #0000ff;">=”#aabbcc”</span><br>        <span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextView<br>            </span><span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_test_item_person_name_tv”</span><span style="color: #ff0000;"><br>            android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br>            android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br>            android:textSize</span><span style="color: #0000ff;">=”18sp”</span><span style="color: #ff0000;"><br>            android:background</span><span style="color: #0000ff;">=”#ccbbaa”</span><br>            <span style="color: #0000ff;">/&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextView<br>            </span><span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_test_item_person_age_tv”</span><span style="color: #ff0000;"><br>            android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br>            android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br>            android:paddingLeft</span><span style="color: #0000ff;">=”5dp”</span><span style="color: #ff0000;"><br>            android:background</span><span style="color: #0000ff;">=”#aaccbb”</span><span style="color: #ff0000;"><br>            android:textSize</span><span style="color: #0000ff;">=”15sp”</span><br>            <span style="color: #0000ff;">/&gt;</span><br><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>item的布局很简单，只有两个TextView，一个用来显示名字，一个用来显示年龄。</p>
<p>Person的实体类就不贴代码了，两个属性：名字和年龄。</p>
<p>然后需要使用到RecyclerView，所以需要把support v7添加到class path，并在布局中添加该控件：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">android.support.v7.widget.RecyclerView<br>                </span><span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_test_rv”</span><span style="color: #ff0000;"><br>                android:scrollbars</span><span style="color: #0000ff;">=”vertical”</span><span style="color: #ff0000;"><br>                android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br>                android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br>                android:background</span><span style="color: #0000ff;">=”#bbccaa”</span><br>                <span style="color: #0000ff;">/&gt;</span></pre><br></div>

<p>然后在onCreate中：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span>         recyclerView.setHasFixedSize(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">2</span><br><span style="color: #008080;">3</span>         RecyclerView.LayoutManager layoutManager = <span style="color: #0000ff;">new</span><span style="color: #000000;"> LinearLayoutManager(context);<br></span><span style="color: #008080;">4</span> <span style="color: #000000;">        recyclerView.setLayoutManager(layoutManager);<br></span><span style="color: #008080;">5</span><br><span style="color: #008080;">6</span> <span style="color: #000000;">        initData();<br></span><span style="color: #008080;">7</span>         adapter = <span style="color: #0000ff;">new</span><span style="color: #000000;"> PersonAdapter(personList);<br></span><span style="color: #008080;">8</span>         adapter.setOnRecyclerViewListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">9</span>         recyclerView.setAdapter(adapter);    </pre><br></div>

<p>&nbsp;</p>
<p>如上述代码：</p>
<p>Line1: 使RecyclerView保持固定的大小,这样会提高RecyclerView的性能。</p>
<p>Line3: LinearLayoutManager，如果你需要显示的是横向滚动的列表或者竖直滚动的列表，则使用这个LayoutManager。显然，我们要实现的是ListView的效果，所以需要使用它。生成这个LinearLayoutManager之后可以设置他滚动的方向，默认竖直滚动，所以这里没有显式地设置。</p>
<p>Line6: 初始化数据源。</p>
<p>Line7～9: 跟ListView一样，需要设置RecyclerView的Adapter，但是这里的Adapter跟ListView使用的Adapter不一样，这里的Adapter需要继承RecyclerView.Adapter，需要实现3个方法：</p>
<p>-&nbsp;onCreateViewHolder()</p>
<p>-&nbsp;onBindViewHolder()</p>
<p>-&nbsp;getItemCount()</p>
<p>直接看代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.helloandroid.sample.recycler.person;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v7.widget.RecyclerView;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.LayoutInflater;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.ViewGroup;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.LinearLayout;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.TextView;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.log.Logger;<br></span><span style="color: #008080;">10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.helloandroid.R;<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">15</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;">16</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">17</span> <span style="color: #008000;">  Date: 1/17/15.<br></span><span style="color: #008080;">18</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;">19</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> PersonAdapter <span style="color: #0000ff;">extends</span><span style="color: #000000;"> RecyclerView.Adapter {<br></span><span style="color: #008080;">20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> OnRecyclerViewListener {<br></span><span style="color: #008080;">21</span>         <span style="color: #0000ff;">void</span> onItemClick(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position);<br></span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">boolean</span> onItemLongClick(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position);<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> OnRecyclerViewListener onRecyclerViewListener;<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnRecyclerViewListener(OnRecyclerViewListener onRecyclerViewListener) {<br></span><span style="color: #008080;">28</span>         <span style="color: #0000ff;">this</span>.onRecyclerViewListener =<span style="color: #000000;"> onRecyclerViewListener;<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = PersonAdapter.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;">32</span>     <span style="color: #0000ff;">private</span> List&lt;Person&gt;<span style="color: #000000;"> list;<br></span><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span>     <span style="color: #0000ff;">public</span> PersonAdapter(List&lt;Person&gt;<span style="color: #000000;"> list) {<br></span><span style="color: #008080;">35</span>         <span style="color: #0000ff;">this</span>.list =<span style="color: #000000;"> list;<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">37</span><br><span style="color: #008080;">38</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">39</span>     <span style="color: #0000ff;">public</span> RecyclerView.ViewHolder onCreateViewHolder(ViewGroup viewGroup, <span style="color: #0000ff;">int</span><span style="color: #000000;"> i) {<br></span><span style="color: #008080;">40</span>         Logger.d(TAG, “onCreateViewHolder, i: “ +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">41</span>         View view = LayoutInflater.from(viewGroup.getContext()).inflate(R.layout.recycler_view_test_item_person, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">42</span>         LinearLayout.LayoutParams lp = <span style="color: #0000ff;">new</span><span style="color: #000000;"> LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT);<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">        view.setLayoutParams(lp);<br></span><span style="color: #008080;">44</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> PersonViewHolder(view);<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">48</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onBindViewHolder(RecyclerView.ViewHolder viewHolder, <span style="color: #0000ff;">int</span><span style="color: #000000;"> i) {<br></span><span style="color: #008080;">49</span>         Logger.d(TAG, “onBindViewHolder, i: “ + i + “, viewHolder: “ +<span style="color: #000000;"> viewHolder);<br></span><span style="color: #008080;">50</span>         PersonViewHolder holder =<span style="color: #000000;"> (PersonViewHolder) viewHolder;<br></span><span style="color: #008080;">51</span>         holder.position =<span style="color: #000000;"> i;<br></span><span style="color: #008080;">52</span>         Person person =<span style="color: #000000;"> list.get(i);<br></span><span style="color: #008080;">53</span> <span style="color: #000000;">        holder.nameTv.setText(person.getName());<br></span><span style="color: #008080;">54</span>         holder.ageTv.setText(person.getAge() + “岁”<span style="color: #000000;">);<br></span><span style="color: #008080;">55</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">56</span><br><span style="color: #008080;">57</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">58</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getItemCount() {<br></span><span style="color: #008080;">59</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> list.size();<br></span><span style="color: #008080;">60</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">61</span><br><span style="color: #008080;">62</span>     <span style="color: #0000ff;">class</span> PersonViewHolder <span style="color: #0000ff;">extends</span> RecyclerView.ViewHolder <span style="color: #0000ff;">implements</span><span style="color: #000000;"> View.OnClickListener, View.OnLongClickListener<br></span><span style="color: #008080;">63</span> <span style="color: #000000;">    {<br></span><span style="color: #008080;">64</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> View rootView;<br></span><span style="color: #008080;">65</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> TextView nameTv;<br></span><span style="color: #008080;">66</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> TextView ageTv;<br></span><span style="color: #008080;">67</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> position;<br></span><span style="color: #008080;">68</span><br><span style="color: #008080;">69</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> PersonViewHolder(View itemView) {<br></span><span style="color: #008080;">70</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">(itemView);<br></span><span style="color: #008080;">71</span>             nameTv =<span style="color: #000000;"> (TextView) itemView.findViewById(R.id.recycler_view_test_item_person_name_tv);<br></span><span style="color: #008080;">72</span>             ageTv =<span style="color: #000000;"> (TextView) itemView.findViewById(R.id.recycler_view_test_item_person_age_tv);<br></span><span style="color: #008080;">73</span>             rootView =<span style="color: #000000;"> itemView.findViewById(R.id.recycler_view_test_item_person_view);<br></span><span style="color: #008080;">74</span>             rootView.setOnClickListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">75</span>             rootView.setOnLongClickListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">76</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">77</span><br><span style="color: #008080;">78</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">79</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v) {<br></span><span style="color: #008080;">80</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> onRecyclerViewListener) {<br></span><span style="color: #008080;">81</span> <span style="color: #000000;">                onRecyclerViewListener.onItemClick(position);<br></span><span style="color: #008080;">82</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">83</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">84</span><br><span style="color: #008080;">85</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">86</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onLongClick(View v) {<br></span><span style="color: #008080;">87</span>             <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> onRecyclerViewListener){<br></span><span style="color: #008080;">88</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> onRecyclerViewListener.onItemLongClick(position);<br></span><span style="color: #008080;">89</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">90</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">91</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">92</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">93</span><br><span style="color: #008080;">94</span> }</pre><br></div>

<p>如上代码所示：</p>
<p>public RecyclerView.ViewHolder onCreateViewHolder(ViewGroup viewGroup, int i)</p>
<p>这个方法主要生成为每个Item inflater出一个View，但是该方法返回的是一个ViewHolder。方法是把View直接封装在ViewHolder中，然后我们面向的是ViewHolder这个实例，当然这个ViewHolder需要我们自己去编写。直接省去了当初的convertView.setTag(holder)和convertView.getTag()这些繁琐的步骤。</p>
<p>&nbsp;</p>
<p>public void onBindViewHolder(RecyclerView.ViewHolder viewHolder, int i)</p>
<p>这个方法主要用于适配渲染数据到View中。方法提供给你了一个viewHolder，而不是原来的convertView。</p>
<p>对比下以前的写法就一目了然了：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">@Override<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">public</span> View getView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position, View convertView, ViewGroup parent) {<br></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">        ViewHolder holder;<br></span><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> convertView){<br></span><span style="color: #008080;"> 5</span>             holder = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ViewHolder();<br></span><span style="color: #008080;"> 6</span>             LayoutInflater mInflater =<span style="color: #000000;"> (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);<br></span><span style="color: #008080;"> 7</span>             convertView = mInflater.inflate(R.layout.item, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 8</span>             holder.btn =<span style="color: #000000;"> (Button) convertView.findViewById(R.id.btn);<br></span><span style="color: #008080;"> 9</span>             holder.tv =<span style="color: #000000;"> (TextView) convertView.findViewById(R.id.tv);<br></span><span style="color: #008080;">10</span>             holder.iv =<span style="color: #000000;"> (TextView) convertView.findViewById(R.id.iv);<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span> <span style="color: #000000;">            convertView.setTag(holder);<br></span><span style="color: #008080;">13</span>         }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;">14</span>             holder =<span style="color: #000000;"> (ViewHolder) convertView.getTag();<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">final</span> HashMap&lt;String, Object&gt; map =<span style="color: #000000;"> list.get(position);<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>         holder.iv.setImageResource(Integer.valueOf(map.get(“iv”<span style="color: #000000;">).toString()));<br></span><span style="color: #008080;">19</span>         holder.tv.setText(map.get(“tv”<span style="color: #000000;">).toString());<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>         holder.btn.setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener() {<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">23</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v) {<br></span><span style="color: #008080;">24</span>                 Toast.makeText(context, map.get(“btn”<span style="color: #000000;">).toString(), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">27</span><br><span style="color: #008080;">28</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> convertView;<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span>     <span style="color: #0000ff;">class</span><span style="color: #000000;"> ViewHolder{<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">        Button btn;<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">        ImageView iv;<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">        TextView tv;<br></span><span style="color: #008080;">35</span><br><span style="color: #008080;">36</span>     }</pre><br></div>

<p>对比后可以发现：</p>
<p>旧的写法中Line5～Line12＋Line28部分的代码其实起到的作用相当于新的写法的onCreateViewHolder()；</p>
<p>旧的写法中Line14～Line26部分的代码其实起到的作用相当于新的写法的onBindViewHolder()；</p>
<p>既然是这样，那我们就把原来相应的代码搬到对应的onCreateViewHolder()和onBindViewHolder()这两个方法中就可以了。</p>
<p>因为RecyclerView帮我们封装了Holder，所以我们自己写的ViewHolder就需要继承RecyclerView.ViewHolder，只有这样，RecyclerView才能帮你去管理这个ViewHolder类。</p>
<p>既然getView方法的渲染数据部分的代码相当于onBindViewHolder()，所以如果调用adapter.notifyDataSetChanged()方法，应该也会重新调用onBindViewHolder()方法才对吧？实验后，果然如此！</p>
<p>除了adapter.notifyDataSetChanged()这个方法之外，新的Adapter还提供了其他的方法，如下：</p>
<div class="cnblogs_code"><br><pre>        <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> notifyDataSetChanged()<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemChanged(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position)<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemRangeChanged(<span style="color: #0000ff;">int</span> positionStart, <span style="color: #0000ff;">int</span><span style="color: #000000;"> itemCount)<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemInserted(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position)<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemMoved(<span style="color: #0000ff;">int</span> fromPosition, <span style="color: #0000ff;">int</span><span style="color: #000000;"> toPosition)<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemRangeInserted(<span style="color: #0000ff;">int</span> positionStart, <span style="color: #0000ff;">int</span><span style="color: #000000;"> itemCount)<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemRemoved(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position)<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemRangeRemoved(<span style="color: #0000ff;">int</span> positionStart, <span style="color: #0000ff;">int</span> itemCount) </pre><br></div>

<p>基本上看到方法的名字就知道这个方法是干嘛的了，</p>
<p>第一个方法没什么好讲的，跟以前一样。</p>
<p>notifyItemChanged(int position)，position数据发生了改变，那调用这个方法，就会回调对应position的onBindViewHolder()方法了，当然，因为ViewHolder是复用的，所以如果position在当前屏幕以外，也就不会回调了，因为没有意义，下次position滚动会当前屏幕以内的时候同样会调用onBindViewHolder()方法刷新数据了。其他的方法也是同样的道理。</p>
<p>public final void notifyItemRangeChanged(int positionStart, int itemCount)，顾名思义，可以刷新从positionStart开始itemCount数量的item了（这里的刷新指回调onBindViewHolder()方法）。</p>
<p>public final void notifyItemInserted(int position)，这个方法是在第position位置被插入了一条数据的时候可以使用这个方法刷新，注意这个方法调用后会有插入的动画，这个动画可以使用默认的，也可以自己定义。</p>
<p>public final void notifyItemMoved(int fromPosition, int toPosition)，这个方法是从fromPosition移动到toPosition为止的时候可以使用这个方法刷新</p>
<p>public final void notifyItemRangeInserted(int positionStart, int itemCount)，显然是批量添加。</p>
<p>public final void notifyItemRemoved(int position)，第position个被删除的时候刷新，同样会有动画。</p>
<p>public final void notifyItemRangeRemoved(int positionStart, int itemCount)，批量删除。</p>
<p>&nbsp;</p>
<p>这些方法分析完之后，我们来实现一个点击一个按钮，新增一条数据，长按一个item，删除一条数据的场景。</p>
<p>以下是新增一条数据的代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> Person person = <span style="color: #0000ff;">new</span> Person(i, “WangJie_” + i, 10 +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">2</span> adapter.notifyItemInserted(2<span style="color: #000000;">);<br></span><span style="color: #008080;">3</span> personList.add(2<span style="color: #000000;">, person);<br></span><span style="color: #008080;">4</span> adapter.notifyItemRangeChanged(2, adapter.getItemCount());</pre><br></div>

<p>如上代码：</p>
<p>Line2：表示在position为2的位置，插入一条数据，这个时候动画开始执行。</p>
<p>Line3: 表示在数据源中position为2的位置新增一条数据（其实这个才是真正的新增数据啦）。</p>
<p>Line4: 为什么要刷新position为2以后的数据呢？因为，在position为2的位置插入了一条数据后，新数据的position变成了2，那原来的position为2的应该变成了3，3的应该变成了4，所以2以后的所有数据的position都发生了改变，所以需要把position2以后的数据都要刷新。理论上是这样，但是实际上刷新的数量只有在屏幕上显示的position为2以后的数据而已。如果这里使用notifyDataSetChanged()来刷新屏幕上显示的所有item可以吗？结果不会出错，但是会有一个问题，前面调用了notifyItemInserted()方法后会在执行动画，如果你调用notifyDataSetChanged()刷新屏幕上显示的所有item的话，必然也会刷新当前正在执行动画的那个item，这样导致的结果是，前面的动画还没执行完，它马上又被刷新了，动画就看不见了。所以只要刷新2以后的item就可以了。</p>
<p>&nbsp;</p>
<p>看了RecyclerView的api，发现没有setOnItemClickListener－－，所以还是自己把onItemClick从Adapter中回调出来吧。这个很简单，就像上面PersonAdaper中写的OnRecyclerViewListener那样。</p>
<p>&nbsp;</p>
<p>长按删除的代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #000000;">adapter.notifyItemRemoved(position);<br></span><span style="color: #008080;">2</span> <span style="color: #000000;">personList.remove(position);<br></span><span style="color: #008080;">3</span> adapter.notifyItemRangeChanged(position, adapter.getItemCount());</pre><br></div>

<p>代码跟之前插入的代码基本一致。先通知执行动画，然后删除数据源中的数据，然后通知position之后的数据刷新就可以了。</p>
<p>这样ListView的效果就实现了。</p>
<p>&nbsp;</p>
<p><strong>示例代码：</strong></p>
<p><strong><a href="https://github.com/wangjiegulu/RecyclerViewSample" target="_blank" rel="noopener">https://github.com/wangjiegulu/RecyclerViewSample</a></strong></p>
<p>&nbsp;</p>
<p><span style="font-size: 16px; color: #ff0000;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener"><span style="color: #ff0000;">[Android]使用RecyclerView替代ListView（二）</span></a></strong>：</span></p>
<p><span style="font-size: 16px; color: #0000ff;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener"><span style="color: #0000ff;">http://www.cnblogs.com/tiantianbyconan/p/4242541.html</span></a></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><span style="font-size: 16px;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener"><span style="color: #ff0000;">[Android]使用RecyclerView替代ListView（三）</span></a></strong>：</span>&nbsp;</span></p>
<p><span style="color: #0000ff;"><a href="http://www.cnblogs.com/tiantianbyconan/p/4268097.html" target="_blank" rel="noopener"><span style="color: #0000ff;"><span style="font-size: 16px; line-height: 24px;"><strong><span style="text-decoration: underline;">http://www.cnblogs.com/tiantianbyconan/p/4268097.html</span></strong></span></span></a></span></p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ListView </tag>
            
            <tag> best practices </tag>
            
            <tag> RecyclerView </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]仿新版QQ的tab下面拖拽标记为已读的效果]]></title>
      <url>/2014/12/24/Android-%E4%BB%BF%E6%96%B0%E7%89%88QQ%E7%9A%84tab%E4%B8%8B%E9%9D%A2%E6%8B%96%E6%8B%BD%E6%A0%87%E8%AE%B0%E4%B8%BA%E5%B7%B2%E8%AF%BB%E7%9A%84%E6%95%88%E6%9E%9C/</url>
      <content type="html"><![CDATA[<p>可拖拽的红点，（仿新版QQ，tab下面拖拽标记为已读的效果），拖拽一定的距离可以消失回调。</p>
<p><img src="https://raw.githubusercontent.com/wangjiegulu/DraggableFlagView/master/screenshot/draggableflagview.gif" alt=""></p>
<p>&nbsp;<img src="https://raw.githubusercontent.com/wangjiegulu/DraggableFlagView/master/screenshot/draggableflagview_b.png" alt=""><span style="line-height: 1.5;">&nbsp;</span><img src="https://raw.githubusercontent.com/wangjiegulu/DraggableFlagView/master/screenshot/draggableflagview_d.png" alt=""></p>
<p>&nbsp;</p>
<p><strong>GitHub：<a href="https://github.com/wangjiegulu/DraggableFlagView" target="_blank" rel="noopener">DraggableFlagView</a>（<a href="https://github.com/wangjiegulu/DraggableFlagView" target="_blank" rel="noopener">https://github.com/wangjiegulu/DraggableFlagView</a>）</strong></p>
<p>实现原理：</p>
<p>当根据touch事件的移动，不断调用onDraw()方法进行刷新绘制。</p>
<p><span style="color: #ff0000;">*注意：这里原来的小红点称为红点A；根据手指移动绘制的小红点称为红点B。</span></p>
<p>touch事件移动的时候需要处理的逻辑：</p>
<p>1. <span style="color: #000000;">红点A的半径根据滑动的距离会不断地变小。</span></p>
<p><span style="color: #000000;">2. 红点B会紧随手指的位置移动。</span></p>
<p><span style="color: #000000;">3. 在红点A和红点B之间需要用贝塞尔曲线绘制连接区域。</span></p>
<p><span style="color: #000000;">4. 如果红点A和红点B之间的间距达到了设置的最大的距离，则表示，这次的拖拽会有效，一旦放手红点就会消失。</span></p>
<p><span style="color: #000000;">5. 如果达到了第4中情况，则红点A和中间连接的贝塞尔曲线不会被绘制。</span></p>
<p><span style="color: #000000;">6. 如果红点A和红点B之间的距离没有达到设置的最大的距离，则放手后，红点B消失，红点A从原来变小的半径使用反弹动画变换到原来最初的状态</span></p>
<p>一些工具类需要依赖&nbsp;<strong><a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">AndroidBucket</a>(<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket</a>)，nineoldandroid</strong></p>
<p><span style="font-size: 16px;"><strong><span style="color: #000000;">使用方式：</span></strong></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">com.wangjie.draggableflagview.DraggableFlagView<br>　　　　　　　</span><span style="color: #ff0000;">xmlns:dfv</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/com.wangjie.draggableflagview" target="_blank" rel="noopener">http://schemas.android.com/apk/res/com.wangjie.draggableflagview</a>“</span><span style="color: #ff0000;"><br>            android:id</span><span style="color: #0000ff;">=”@+id/main_dfv”</span><span style="color: #ff0000;"><br>            android:layout_width</span><span style="color: #0000ff;">=”20dp”</span><span style="color: #ff0000;"><br>            android:layout_height</span><span style="color: #0000ff;">=”20dp”</span><span style="color: #ff0000;"><br>            android:layout_alignParentBottom</span><span style="color: #0000ff;">=”true”</span><span style="color: #ff0000;"><br>            android:layout_margin</span><span style="color: #0000ff;">=”15dp”</span><span style="color: #ff0000;"><br>            dfv:color</span><span style="color: #0000ff;">=”#FF3B30”</span><br>            <span style="color: #0000ff;">/&gt;</span></pre><br></div>

<p>&nbsp;</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span> Activity <span style="color: #0000ff;">implements</span><span style="color: #000000;"> DraggableFlagView.OnDraggableFlagViewListener, View.OnClickListener {<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">        setContentView(R.layout.main);<br></span><span style="color: #008080;"> 7</span>         findViewById(R.id.main_btn).setOnClickListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>         DraggableFlagView draggableFlagView =<span style="color: #000000;"> (DraggableFlagView) findViewById(R.id.main_dfv);<br></span><span style="color: #008080;">10</span>         draggableFlagView.setOnDraggableFlagViewListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">11</span>         draggableFlagView.setText(“7”<span style="color: #000000;">);<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">15</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onFlagDismiss(DraggableFlagView view) {<br></span><span style="color: #008080;">16</span>         Toast.makeText(<span style="color: #0000ff;">this</span>, “onFlagDismiss”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v) {<br></span><span style="color: #008080;">21</span>         <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (v.getId()) {<br></span><span style="color: #008080;">22</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.main_btn:<br></span><span style="color: #008080;">23</span>                 Toast.makeText(<span style="color: #0000ff;">this</span>, “hello world”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">24</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">27</span> }</pre><br></div>

<p><span style="font-size: 16px;"><strong>DraggableFlagView代码：</strong></span></p>
<p>&nbsp;</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">  2</span> <span style="color: #008000;"> <em> Author: wangjie<br></em></span><span style="color: #008080;">  3</span> <span style="color: #008000;">  Email: tiantian.china.2@gmail.com<br></span><span style="color: #008080;">  4</span> <span style="color: #008000;"> <em> Date: 12/23/14.<br></em></span><span style="color: #008080;">  5</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">  6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> DraggableFlagView <span style="color: #0000ff;">extends</span><span style="color: #000000;"> View {<br></span><span style="color: #008080;">  7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = DraggableFlagView.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;">  8</span><br><span style="color: #008080;">  9</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> OnDraggableFlagViewListener {<br></span><span style="color: #008080;"> 10</span>         <span style="color: #008000;">/</span><br><span style="color: #008080;"> 11</span> <span style="color: #008000;">         <em> 拖拽销毁圆点后的回调<br></em></span><span style="color: #008080;"> 12</span> <span style="color: #008000;">         <br></span><span style="color: #008080;"> 13</span> <span style="color: #008000;">         <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> view<br></span><span style="color: #008080;"> 14</span>          <span style="color: #008000;">/</span><br><span style="color: #008080;"> 15</span>         <span style="color: #0000ff;">void</span><span style="color: #000000;"> onFlagDismiss(DraggableFlagView view);<br></span><span style="color: #008080;"> 16</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 17</span><br><span style="color: #008080;"> 18</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> OnDraggableFlagViewListener onDraggableFlagViewListener;<br></span><span style="color: #008080;"> 19</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnDraggableFlagViewListener(OnDraggableFlagViewListener onDraggableFlagViewListener) {<br></span><span style="color: #008080;"> 21</span>         <span style="color: #0000ff;">this</span>.onDraggableFlagViewListener =<span style="color: #000000;"> onDraggableFlagViewListener;<br></span><span style="color: #008080;"> 22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 23</span><br><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> DraggableFlagView(Context context) {<br></span><span style="color: #008080;"> 25</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;"> 26</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 27</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 28</span><br><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> patientColor =<span style="color: #000000;"> Color.RED;<br></span><span style="color: #008080;"> 30</span><br><span style="color: #008080;"> 31</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> DraggableFlagView(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;"> 32</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;"> 33</span>         TypedArray a =<span style="color: #000000;"> context.obtainStyledAttributes(attrs, R.styleable.DraggableFlagView);<br></span><span style="color: #008080;"> 34</span>         <span style="color: #0000ff;">int</span> indexCount =<span style="color: #000000;"> a.getIndexCount();<br></span><span style="color: #008080;"> 35</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; indexCount; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;"> 36</span>             <span style="color: #0000ff;">int</span> attrIndex =<span style="color: #000000;"> a.getIndex(i);<br></span><span style="color: #008080;"> 37</span>             <span style="color: #0000ff;">if</span> (attrIndex ==<span style="color: #000000;"> R.styleable.DraggableFlagView_color) {<br></span><span style="color: #008080;"> 38</span>                 patientColor =<span style="color: #000000;"> a.getColor(attrIndex, Color.RED);<br></span><span style="color: #008080;"> 39</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 40</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 41</span> <span style="color: #000000;">        a.recycle();<br></span><span style="color: #008080;"> 42</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 43</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 44</span><br><span style="color: #008080;"> 45</span>     <span style="color: #0000ff;">public</span> DraggableFlagView(Context context, AttributeSet attrs, <span style="color: #0000ff;">int</span><span style="color: #000000;"> defStyle) {<br></span><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs, defStyle);<br></span><span style="color: #008080;"> 47</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 48</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 49</span><br><span style="color: #008080;"> 50</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br></span><span style="color: #008080;"> 51</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> originRadius; <span style="color: #008000;">//</span><span style="color: #008000;"> 初始的圆的半径</span><br><span style="color: #008080;"> 52</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> originWidth;<br></span><span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> originHeight;<br></span><span style="color: #008080;"> 54</span><br><span style="color: #008080;"> 55</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> maxMoveLength; <span style="color: #008000;">//</span><span style="color: #008000;"> 最大的移动拉长距离</span><br><span style="color: #008080;"> 56</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isArrivedMaxMoved; <span style="color: #008000;">//</span><span style="color: #008000;"> 达到了最大的拉长距离（松手可以触发事件）</span><br><span style="color: #008080;"> 57</span><br><span style="color: #008080;"> 58</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> curRadius; <span style="color: #008000;">//</span><span style="color: #008000;"> 当前点的半径</span><br><span style="color: #008080;"> 59</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> touchedPointRadius; <span style="color: #008000;">//</span><span style="color: #008000;"> touch的圆的半径</span><br><span style="color: #008080;"> 60</span>     <span style="color: #0000ff;">private</span> Point startPoint = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Point();<br></span><span style="color: #008080;"> 61</span>     <span style="color: #0000ff;">private</span> Point endPoint = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Point();<br></span><span style="color: #008080;"> 62</span><br><span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">private</span> Paint paint; <span style="color: #008000;">//</span><span style="color: #008000;"> 绘制圆形图形</span><br><span style="color: #008080;"> 64</span>     <span style="color: #0000ff;">private</span> Paint textPaint; <span style="color: #008000;">//</span><span style="color: #008000;"> 绘制圆形图形</span><br><span style="color: #008080;"> 65</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Paint.FontMetrics textFontMetrics;<br></span><span style="color: #008080;"> 66</span><br><span style="color: #008080;"> 67</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;">[] location;<br></span><span style="color: #008080;"> 68</span><br><span style="color: #008080;"> 69</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isTouched; <span style="color: #008000;">//</span><span style="color: #008000;"> 是否是触摸状态</span><br><span style="color: #008080;"> 70</span><br><span style="color: #008080;"> 71</span>     <span style="color: #0000ff;">private</span> Triangle triangle = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Triangle();<br></span><span style="color: #008080;"> 72</span><br><span style="color: #008080;"> 73</span>     <span style="color: #0000ff;">private</span> String text = “”; <span style="color: #008000;">//</span><span style="color: #008000;"> 正常状态下显示的文字</span><br><span style="color: #008080;"> 74</span><br><span style="color: #008080;"> 75</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> init(Context context) {<br></span><span style="color: #008080;"> 76</span>         <span style="color: #0000ff;">this</span>.context =<span style="color: #000000;"> context;<br></span><span style="color: #008080;"> 77</span><br><span style="color: #008080;"> 78</span> <span style="color: #000000;">        setBackgroundColor(Color.TRANSPARENT);<br></span><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置绘制flag的paint</span><br><span style="color: #008080;"> 81</span>         paint = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Paint();<br></span><span style="color: #008080;"> 82</span> <span style="color: #000000;">        paint.setColor(patientColor);<br></span><span style="color: #008080;"> 83</span>         paint.setAntiAlias(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 84</span><br><span style="color: #008080;"> 85</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置绘制文字的paint</span><br><span style="color: #008080;"> 86</span>         textPaint = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Paint();<br></span><span style="color: #008080;"> 87</span>         textPaint.setAntiAlias(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 88</span> <span style="color: #000000;">        textPaint.setColor(Color.WHITE);<br></span><span style="color: #008080;"> 89</span>         textPaint.setTextSize(ABTextUtil.sp2px(context, 12<span style="color: #000000;">));<br></span><span style="color: #008080;"> 90</span> <span style="color: #000000;">        textPaint.setTextAlign(Paint.Align.CENTER);<br></span><span style="color: #008080;"> 91</span>         textFontMetrics =<span style="color: #000000;"> paint.getFontMetrics();<br></span><span style="color: #008080;"> 92</span><br><span style="color: #008080;"> 93</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 94</span><br><span style="color: #008080;"> 95</span>     RelativeLayout.LayoutParams originLp; <span style="color: #008000;">//</span><span style="color: #008000;"> 实际的layoutparams</span><br><span style="color: #008080;"> 96</span>     RelativeLayout.LayoutParams newLp; <span style="color: #008000;">//</span><span style="color: #008000;"> 触摸时候的LayoutParams</span><br><span style="color: #008080;"> 97</span><br><span style="color: #008080;"> 98</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isFirst = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 99</span><br><span style="color: #008080;">100</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">101</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> onSizeChanged(<span style="color: #0000ff;">int</span> w, <span style="color: #0000ff;">int</span> h, <span style="color: #0000ff;">int</span> oldw, <span style="color: #0000ff;">int</span><span style="color: #000000;"> oldh) {<br></span><span style="color: #008080;">102</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onSizeChanged(w, h, oldw, oldh);<br></span><span style="color: #008080;">103</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Logger.d(TAG, String.format(“onSizeChanged, w: %s, h: %s, oldw: %s, oldh: %s”, w, h, oldw, oldh));</span><br><span style="color: #008080;">104</span>         <span style="color: #0000ff;">if</span> (isFirst &amp;&amp; w &gt; 0 &amp;&amp; h &gt; 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">105</span>             isFirst = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">106</span><br><span style="color: #008080;">107</span>             originWidth =<span style="color: #000000;"> w;<br></span><span style="color: #008080;">108</span>             originHeight =<span style="color: #000000;"> h;<br></span><span style="color: #008080;">109</span><br><span style="color: #008080;">110</span>             originRadius = Math.min(originWidth, originHeight) / 2<span style="color: #000000;">;<br></span><span style="color: #008080;">111</span>             curRadius =<span style="color: #000000;"> originRadius;<br></span><span style="color: #008080;">112</span>             touchedPointRadius =<span style="color: #000000;"> originRadius;<br></span><span style="color: #008080;">113</span><br><span style="color: #008080;">114</span>             maxMoveLength = ABAppUtil.getDeviceHeight(context) / 6<span style="color: #000000;">;<br></span><span style="color: #008080;">115</span><br><span style="color: #008080;">116</span> <span style="color: #000000;">            refreshStartPoint();<br></span><span style="color: #008080;">117</span><br><span style="color: #008080;">118</span>             ViewGroup.LayoutParams lp = <span style="color: #0000ff;">this</span><span style="color: #000000;">.getLayoutParams();<br></span><span style="color: #008080;">119</span>             <span style="color: #0000ff;">if</span> (RelativeLayout.LayoutParams.<span style="color: #0000ff;">class</span><span style="color: #000000;">.isAssignableFrom(lp.getClass())) {<br></span><span style="color: #008080;">120</span>                 originLp =<span style="color: #000000;"> (RelativeLayout.LayoutParams) lp;<br></span><span style="color: #008080;">121</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">122</span>             newLp = <span style="color: #0000ff;">new</span><span style="color: #000000;"> RelativeLayout.LayoutParams(lp.width, lp.height);<br></span><span style="color: #008080;">123</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">124</span><br><span style="color: #008080;">125</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">126</span><br><span style="color: #008080;">127</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">128</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setLayoutParams(ViewGroup.LayoutParams params) {<br></span><span style="color: #008080;">129</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.setLayoutParams(params);<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">        refreshStartPoint();<br></span><span style="color: #008080;">131</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">132</span><br><span style="color: #008080;">133</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">134</span> <span style="color: #008000;">     <em> 修改layoutParams后，需要重新设置startPoint<br></em></span><span style="color: #008080;">135</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">136</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> refreshStartPoint() {<br></span><span style="color: #008080;">137</span>         location = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">int</span>[2<span style="color: #000000;">];<br></span><span style="color: #008080;">138</span>         <span style="color: #0000ff;">this</span><span style="color: #000000;">.getLocationInWindow(location);<br></span><span style="color: #008080;">139</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Logger.d(TAG, “location on screen: “ + Arrays.toString(location));<br></span><span style="color: #008080;">140</span> <span style="color: #008000;">//</span><span style="color: #008000;">            startPoint.set(location[0], location[1] + h);</span><br><span style="color: #008080;">141</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">142</span>             location[1] = location[1] -<span style="color: #000000;"> ABAppUtil.getTopBarHeight((Activity) context);<br></span><span style="color: #008080;">143</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception ex) {<br></span><span style="color: #008080;">144</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">145</span><br><span style="color: #008080;">146</span>         startPoint.set(location[0], location[1] +<span style="color: #000000;"> getMeasuredHeight());<br></span><span style="color: #008080;">147</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Logger.d(TAG, “startPoint: “ + startPoint);</span><br><span style="color: #008080;">148</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">149</span><br><span style="color: #008080;">150</span>     Path path = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Path();<br></span><span style="color: #008080;">151</span><br><span style="color: #008080;">152</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">153</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDraw(Canvas canvas) {<br></span><span style="color: #008080;">154</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDraw(canvas);<br></span><span style="color: #008080;">155</span> <span style="color: #000000;">        canvas.drawColor(Color.TRANSPARENT);<br></span><span style="color: #008080;">156</span><br><span style="color: #008080;">157</span>         <span style="color: #0000ff;">int</span> startCircleX = 0, startCircleY = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">158</span>         <span style="color: #0000ff;">if</span> (isTouched) { <span style="color: #008000;">//</span><span style="color: #008000;"> 触摸状态</span><br><span style="color: #008080;">159</span><br><span style="color: #008080;">160</span>             startCircleX = startPoint.x +<span style="color: #000000;"> curRadius;<br></span><span style="color: #008080;">161</span>             startCircleY = startPoint.y -<span style="color: #000000;"> curRadius;<br></span><span style="color: #008080;">162</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 绘制原来的圆形（触摸移动的时候半径会不断变化）</span><br><span style="color: #008080;">163</span> <span style="color: #000000;">            canvas.drawCircle(startCircleX, startCircleY, curRadius, paint);<br></span><span style="color: #008080;">164</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 绘制手指跟踪的圆形</span><br><span style="color: #008080;">165</span>             <span style="color: #0000ff;">int</span> endCircleX =<span style="color: #000000;"> endPoint.x;<br></span><span style="color: #008080;">166</span>             <span style="color: #0000ff;">int</span> endCircleY =<span style="color: #000000;"> endPoint.y;<br></span><span style="color: #008080;">167</span> <span style="color: #000000;">            canvas.drawCircle(endCircleX, endCircleY, originRadius, paint);<br></span><span style="color: #008080;">168</span><br><span style="color: #008080;">169</span>             <span style="color: #0000ff;">if</span> (!isArrivedMaxMoved) { <span style="color: #008000;">//</span><span style="color: #008000;"> 没有达到拉伸最大值</span><br><span style="color: #008080;">170</span> <span style="color: #000000;">                path.reset();<br></span><span style="color: #008080;">171</span>                 <span style="color: #0000ff;">double</span> sin = triangle.deltaY /<span style="color: #000000;"> triangle.hypotenuse;<br></span><span style="color: #008080;">172</span>                 <span style="color: #0000ff;">double</span> cos = triangle.deltaX /<span style="color: #000000;"> triangle.hypotenuse;<br></span><span style="color: #008080;">173</span><br><span style="color: #008080;">174</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> A点</span><br><span style="color: #008080;">175</span> <span style="color: #000000;">                path.moveTo(<br></span><span style="color: #008080;">176</span>                         (<span style="color: #0000ff;">float</span>) (startCircleX - curRadius <em><span style="color: #000000;"> sin),<br></span><span style="color: #008080;">177</span>                         (<span style="color: #0000ff;">float</span>) (startCircleY - curRadius </em><span style="color: #000000;"> cos)<br></span><span style="color: #008080;">178</span> <span style="color: #000000;">                );<br></span><span style="color: #008080;">179</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> B点</span><br><span style="color: #008080;">180</span> <span style="color: #000000;">                path.lineTo(<br></span><span style="color: #008080;">181</span>                         (<span style="color: #0000ff;">float</span>) (startCircleX + curRadius <em><span style="color: #000000;"> sin),<br></span><span style="color: #008080;">182</span>                         (<span style="color: #0000ff;">float</span>) (startCircleY + curRadius </em><span style="color: #000000;"> cos)<br></span><span style="color: #008080;">183</span> <span style="color: #000000;">                );<br></span><span style="color: #008080;">184</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> C点</span><br><span style="color: #008080;">185</span> <span style="color: #000000;">                path.quadTo(<br></span><span style="color: #008080;">186</span>                         (startCircleX + endCircleX) / 2, (startCircleY + endCircleY) / 2<span style="color: #000000;">,<br></span><span style="color: #008080;">187</span>                         (<span style="color: #0000ff;">float</span>) (endCircleX + originRadius <em> sin), (<span style="color: #0000ff;">float</span>) (endCircleY + originRadius </em><span style="color: #000000;"> cos)<br></span><span style="color: #008080;">188</span> <span style="color: #000000;">                );<br></span><span style="color: #008080;">189</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> D点</span><br><span style="color: #008080;">190</span> <span style="color: #000000;">                path.lineTo(<br></span><span style="color: #008080;">191</span>                         (<span style="color: #0000ff;">float</span>) (endCircleX - originRadius <em><span style="color: #000000;"> sin),<br></span><span style="color: #008080;">192</span>                         (<span style="color: #0000ff;">float</span>) (endCircleY - originRadius </em><span style="color: #000000;"> cos)<br></span><span style="color: #008080;">193</span> <span style="color: #000000;">                );<br></span><span style="color: #008080;">194</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> A点</span><br><span style="color: #008080;">195</span> <span style="color: #000000;">                path.quadTo(<br></span><span style="color: #008080;">196</span>                         (startCircleX + endCircleX) / 2, (startCircleY + endCircleY) / 2<span style="color: #000000;">,<br></span><span style="color: #008080;">197</span>                         (<span style="color: #0000ff;">float</span>) (startCircleX - curRadius <em> sin), (<span style="color: #0000ff;">float</span>) (startCircleY - curRadius </em><span style="color: #000000;"> cos)<br></span><span style="color: #008080;">198</span> <span style="color: #000000;">                );<br></span><span style="color: #008080;">199</span> <span style="color: #000000;">                canvas.drawPath(path, paint);<br></span><span style="color: #008080;">200</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">201</span><br><span style="color: #008080;">202</span><br><span style="color: #008080;">203</span>         } <span style="color: #0000ff;">else</span> { <span style="color: #008000;">//</span><span style="color: #008000;"> 非触摸状态</span><br><span style="color: #008080;">204</span>             <span style="color: #0000ff;">if</span> (curRadius &gt; 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">205</span>                 startCircleX =<span style="color: #000000;"> curRadius;<br></span><span style="color: #008080;">206</span>                 startCircleY = originHeight -<span style="color: #000000;"> curRadius;<br></span><span style="color: #008080;">207</span> <span style="color: #000000;">                canvas.drawCircle(startCircleX, startCircleY, curRadius, paint);<br></span><span style="color: #008080;">208</span>                 <span style="color: #0000ff;">if</span> (curRadius == originRadius) { <span style="color: #008000;">//</span><span style="color: #008000;"> 只有在恢复正常的情况下才显示文字<br></span><span style="color: #008080;">209</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 绘制文字</span><br><span style="color: #008080;">210</span>                     <span style="color: #0000ff;">float</span> textH = textFontMetrics.bottom -<span style="color: #000000;"> textFontMetrics.top;<br></span><span style="color: #008080;">211</span>                     canvas.drawText(text, startCircleX, startCircleY + textH / 2<span style="color: #000000;">, textPaint);<br></span><span style="color: #008080;">212</span> <span style="color: #008000;">//</span><span style="color: #008000;">                    canvas.drawText(text, startCircleX, startCircleY, textPaint);</span><br><span style="color: #008080;">213</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">214</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">215</span><br><span style="color: #008080;">216</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">217</span><br><span style="color: #008080;">218</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Logger.d(TAG, “circleX: “ + startCircleX + “, circleY: “ + startCircleY + “, curRadius: “ + curRadius);</span><br><span style="color: #008080;">219</span><br><span style="color: #008080;">220</span><br><span style="color: #008080;">221</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">222</span><br><span style="color: #008080;">223</span>     <span style="color: #0000ff;">float</span> downX =<span style="color: #000000;"> Float.MAX_VALUE;<br></span><span style="color: #008080;">224</span>     <span style="color: #0000ff;">float</span> downY =<span style="color: #000000;"> Float.MAX_VALUE;<br></span><span style="color: #008080;">225</span><br><span style="color: #008080;">226</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">227</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onTouchEvent(MotionEvent event) {<br></span><span style="color: #008080;">228</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onTouchEvent(event);<br></span><span style="color: #008080;">229</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Logger.d(TAG, “onTouchEvent: “ + event);</span><br><span style="color: #008080;">230</span>         <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (event.getAction()) {<br></span><span style="color: #008080;">231</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_DOWN:<br></span><span style="color: #008080;">232</span>                 isTouched = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">233</span>                 <span style="color: #0000ff;">this</span><span style="color: #000000;">.setLayoutParams(newLp);<br></span><span style="color: #008080;">234</span>                 endPoint.x = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) downX;<br></span><span style="color: #008080;">235</span>                 endPoint.y = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) downY;<br></span><span style="color: #008080;">236</span><br><span style="color: #008080;">237</span>                 changeViewHeight(<span style="color: #0000ff;">this</span><span style="color: #000000;">, ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT);<br></span><span style="color: #008080;">238</span> <span style="color: #000000;">                postInvalidate();<br></span><span style="color: #008080;">239</span><br><span style="color: #008080;">240</span>                 downX = event.getX() + location[0<span style="color: #000000;">];<br></span><span style="color: #008080;">241</span>                 downY = event.getY() + location[1<span style="color: #000000;">];<br></span><span style="color: #008080;">242</span> <span style="color: #008000;">//</span><span style="color: #008000;">                Logger.d(TAG, String.format(“downX: %f, downY: %f”, downX, downY));</span><br><span style="color: #008080;">243</span><br><span style="color: #008080;">244</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">245</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_MOVE:<br></span><span style="color: #008080;">246</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 计算直角边和斜边（用于计算绘制两圆之间的填充去）</span><br><span style="color: #008080;">247</span>                 triangle.deltaX = event.getX() -<span style="color: #000000;"> downX;<br></span><span style="color: #008080;">248</span>                 triangle.deltaY = -1 <em> (event.getY() - downY); <span style="color: #008000;">//</span><span style="color: #008000;"> y轴方向相反，所有需要取反</span><br><span style="color: #008080;">249</span>                 <span style="color: #0000ff;">double</span> distance = Math.sqrt(triangle.deltaX </em> triangle.deltaX + triangle.deltaY <em><span style="color: #000000;"> triangle.deltaY);<br></span><span style="color: #008080;">250</span>                 triangle.hypotenuse =<span style="color: #000000;"> distance;<br></span><span style="color: #008080;">251</span> <span style="color: #008000;">//</span><span style="color: #008000;">                Logger.d(TAG, “triangle: “ + triangle);</span><br><span style="color: #008080;">252</span>                 refreshCurRadiusByMoveDistance((<span style="color: #0000ff;">int</span><span style="color: #000000;">) distance);<br></span><span style="color: #008080;">253</span><br><span style="color: #008080;">254</span>                 endPoint.x = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) event.getX();<br></span><span style="color: #008080;">255</span>                 endPoint.y = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) event.getY();<br></span><span style="color: #008080;">256</span><br><span style="color: #008080;">257</span> <span style="color: #000000;">                postInvalidate();<br></span><span style="color: #008080;">258</span><br><span style="color: #008080;">259</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">260</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_UP:<br></span><span style="color: #008080;">261</span>                 isTouched = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">262</span>                 <span style="color: #0000ff;">this</span><span style="color: #000000;">.setLayoutParams(originLp);<br></span><span style="color: #008080;">263</span><br><span style="color: #008080;">264</span>                 <span style="color: #0000ff;">if</span> (isArrivedMaxMoved) { <span style="color: #008000;">//</span><span style="color: #008000;"> 触发事件</span><br><span style="color: #008080;">265</span>                     changeViewHeight(<span style="color: #0000ff;">this</span><span style="color: #000000;">, originWidth, originHeight);<br></span><span style="color: #008080;">266</span> <span style="color: #000000;">                    postInvalidate();<br></span><span style="color: #008080;">267</span>                     <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> onDraggableFlagViewListener) {<br></span><span style="color: #008080;">268</span>                         onDraggableFlagViewListener.onFlagDismiss(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">269</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">270</span>                     Logger.d(TAG, “触发事件…”<span style="color: #000000;">);<br></span><span style="color: #008080;">271</span> <span style="color: #000000;">                    resetAfterDismiss();<br></span><span style="color: #008080;">272</span>                 } <span style="color: #0000ff;">else</span> { <span style="color: #008000;">//</span><span style="color: #008000;"> 还原</span><br><span style="color: #008080;">273</span>                     changeViewHeight(<span style="color: #0000ff;">this</span><span style="color: #000000;">, originWidth, originHeight);<br></span><span style="color: #008080;">274</span>                     startRollBackAnimation(500<span style="color: #008000;">/</span></em><span style="color: #008000;">ms</span><span style="color: #008000;">*/</span><span style="color: #000000;">);<br></span><span style="color: #008080;">275</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">276</span><br><span style="color: #008080;">277</span>                 downX =<span style="color: #000000;"> Float.MAX_VALUE;<br></span><span style="color: #008080;">278</span>                 downY =<span style="color: #000000;"> Float.MAX_VALUE;<br></span><span style="color: #008080;">279</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">280</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">281</span><br><span style="color: #008080;">282</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">283</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">284</span><br><span style="color: #008080;">285</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">286</span> <span style="color: #008000;">     <em> 触发事件之后重置<br></em></span><span style="color: #008080;">287</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">288</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> resetAfterDismiss() {<br></span><span style="color: #008080;">289</span>         <span style="color: #0000ff;">this</span><span style="color: #000000;">.setVisibility(GONE);<br></span><span style="color: #008080;">290</span>         text = “”<span style="color: #000000;">;<br></span><span style="color: #008080;">291</span>         isArrivedMaxMoved = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">292</span>         curRadius =<span style="color: #000000;"> originRadius;<br></span><span style="color: #008080;">293</span> <span style="color: #000000;">        postInvalidate();<br></span><span style="color: #008080;">294</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">295</span><br><span style="color: #008080;">296</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">297</span> <span style="color: #008000;">     <em> 根据移动的距离来刷新原来的圆半径大小<br></em></span><span style="color: #008080;">298</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">299</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> distance<br></span><span style="color: #008080;">300</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">301</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> refreshCurRadiusByMoveDistance(<span style="color: #0000ff;">int</span><span style="color: #000000;"> distance) {<br></span><span style="color: #008080;">302</span>         <span style="color: #0000ff;">if</span> (distance &gt;<span style="color: #000000;"> maxMoveLength) {<br></span><span style="color: #008080;">303</span>             isArrivedMaxMoved = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">304</span>             curRadius = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">305</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">306</span>             isArrivedMaxMoved = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">307</span>             <span style="color: #0000ff;">float</span> calcRadius = (1 - 1f <em> distance / maxMoveLength) </em><span style="color: #000000;"> originRadius;<br></span><span style="color: #008080;">308</span>             <span style="color: #0000ff;">float</span> maxRadius = ABTextUtil.dip2px(context, 2<span style="color: #000000;">);<br></span><span style="color: #008080;">309</span>             curRadius = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) Math.max(calcRadius, maxRadius);<br></span><span style="color: #008080;">310</span> <span style="color: #008000;">//</span><span style="color: #008000;">            Logger.d(TAG, “[refreshCurRadiusByMoveDistance]curRadius: “ + curRadius + “, calcRadius: “ + calcRadius + “, maxRadius: “ + maxRadius);</span><br><span style="color: #008080;">311</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">312</span><br><span style="color: #008080;">313</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">314</span><br><span style="color: #008080;">315</span><br><span style="color: #008080;">316</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">317</span> <span style="color: #008000;">     <em> 改变某控件的高度<br></em></span><span style="color: #008080;">318</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">319</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> view<br></span><span style="color: #008080;">320</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> height<br></span><span style="color: #008080;">321</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">322</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> changeViewHeight(View view, <span style="color: #0000ff;">int</span> width, <span style="color: #0000ff;">int</span><span style="color: #000000;"> height) {<br></span><span style="color: #008080;">323</span>         ViewGroup.LayoutParams lp =<span style="color: #000000;"> view.getLayoutParams();<br></span><span style="color: #008080;">324</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> lp) {<br></span><span style="color: #008080;">325</span>             lp =<span style="color: #000000;"> originLp;<br></span><span style="color: #008080;">326</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">327</span>         lp.width =<span style="color: #000000;"> width;<br></span><span style="color: #008080;">328</span>         lp.height =<span style="color: #000000;"> height;<br></span><span style="color: #008080;">329</span> <span style="color: #000000;">        view.setLayoutParams(lp);<br></span><span style="color: #008080;">330</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">331</span><br><span style="color: #008080;">332</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">333</span> <span style="color: #008000;">      回滚状态动画<br></span><span style="color: #008080;">334</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">335</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> ValueAnimator rollBackAnim;<br></span><span style="color: #008080;">336</span><br><span style="color: #008080;">337</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> startRollBackAnimation(<span style="color: #0000ff;">long</span><span style="color: #000000;"> duration) {<br></span><span style="color: #008080;">338</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> rollBackAnim) {<br></span><span style="color: #008080;">339</span>             rollBackAnim =<span style="color: #000000;"> ValueAnimator.ofFloat(curRadius, originRadius);<br></span><span style="color: #008080;">340</span>             rollBackAnim.addUpdateListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> ValueAnimator.AnimatorUpdateListener() {<br></span><span style="color: #008080;">341</span> <span style="color: #000000;">                @Override<br></span><span style="color: #008080;">342</span>                 <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onAnimationUpdate(ValueAnimator animation) {<br></span><span style="color: #008080;">343</span>                     <span style="color: #0000ff;">float</span> value = (<span style="color: #0000ff;">float</span><span style="color: #000000;">) animation.getAnimatedValue();<br></span><span style="color: #008080;">344</span>                     curRadius = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) value;<br></span><span style="color: #008080;">345</span> <span style="color: #000000;">                    postInvalidate();<br></span><span style="color: #008080;">346</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">347</span> <span style="color: #000000;">            });<br></span><span style="color: #008080;">348</span>             rollBackAnim.setInterpolator(<span style="color: #0000ff;">new</span> BounceInterpolator()); <span style="color: #008000;">//</span><span style="color: #008000;"> 反弹效果</span><br><span style="color: #008080;">349</span>             rollBackAnim.addListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> AnimatorListenerAdapter() {<br></span><span style="color: #008080;">350</span> <span style="color: #000000;">                @Override<br></span><span style="color: #008080;">351</span>                 <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onAnimationEnd(Animator animation) {<br></span><span style="color: #008080;">352</span>                     <span style="color: #0000ff;">super</span><span style="color: #000000;">.onAnimationEnd(animation);<br></span><span style="color: #008080;">353</span>                     DraggableFlagView.<span style="color: #0000ff;">this</span><span style="color: #000000;">.clearAnimation();<br></span><span style="color: #008080;">354</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">355</span> <span style="color: #000000;">            });<br></span><span style="color: #008080;">356</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">357</span> <span style="color: #000000;">        rollBackAnim.setDuration(duration);<br></span><span style="color: #008080;">358</span> <span style="color: #000000;">        rollBackAnim.start();<br></span><span style="color: #008080;">359</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">360</span><br><span style="color: #008080;">361</span><br><span style="color: #008080;">362</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">363</span> <span style="color: #008000;">      计算四个坐标的三角边关系<br></span><span style="color: #008080;">364</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">365</span>     <span style="color: #0000ff;">class</span><span style="color: #000000;"> Triangle {<br></span><span style="color: #008080;">366</span>         <span style="color: #0000ff;">double</span><span style="color: #000000;"> deltaX;<br></span><span style="color: #008080;">367</span>         <span style="color: #0000ff;">double</span><span style="color: #000000;"> deltaY;<br></span><span style="color: #008080;">368</span>         <span style="color: #0000ff;">double</span><span style="color: #000000;"> hypotenuse;<br></span><span style="color: #008080;">369</span><br><span style="color: #008080;">370</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">371</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> String toString() {<br></span><span style="color: #008080;">372</span>             <span style="color: #0000ff;">return</span> “Triangle{“ +<br><span style="color: #008080;">373</span>                     “deltaX=” + deltaX +<br><span style="color: #008080;">374</span>                     “, deltaY=” + deltaY +<br><span style="color: #008080;">375</span>                     “, hypotenuse=” + hypotenuse +<br><span style="color: #008080;">376</span>                     ‘}’<span style="color: #000000;">;<br></span><span style="color: #008080;">377</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">378</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">379</span><br><span style="color: #008080;">380</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String getText() {<br></span><span style="color: #008080;">381</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> text;<br></span><span style="color: #008080;">382</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">383</span><br><span style="color: #008080;">384</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setText(String text) {<br></span><span style="color: #008080;">385</span>         <span style="color: #0000ff;">this</span>.text =<span style="color: #000000;"> text;<br></span><span style="color: #008080;">386</span> <span style="color: #000000;">        postInvalidate();<br></span><span style="color: #008080;">387</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">388</span> }</pre><br></div>

<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> view </tag>
            
            <tag> DaggerableFlagView </tag>
            
            <tag> qq </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]下拉刷新控件RefreshableView的实现]]></title>
      <url>/2014/12/18/Android-%E4%B8%8B%E6%8B%89%E5%88%B7%E6%96%B0%E6%8E%A7%E4%BB%B6RefreshableView%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
      <content type="html"><![CDATA[<p>&nbsp;</p>
<p>需求：自定义一个ViewGroup，实现可以下拉刷新的功能。下拉一定距离后（下拉时显示的界面可以自定义任何复杂的界面）释放手指可以回调刷新的功能，用户处理完刷新的内容后，可以调用方法onCompleteRefresh()通知刷新完毕，然后回归正常状态。效果如下：</p>
<p><img src="https://raw.githubusercontent.com/wangjiegulu/RefreshableView/master/screenshot/refreshableview.gif" alt="">&nbsp;&nbsp;&nbsp;<img src="https://raw.githubusercontent.com/wangjiegulu/RefreshableView/master/screenshot/refreshablelistview.gif" alt=""></p>
<p>&nbsp;</p>
<p><strong>源代码：<span style="color: #ff0000;"><a href="https://github.com/wangjiegulu/RefreshableView" target="_blank" rel="noopener"><span style="color: #ff0000;">RefreshableView</span></a></span>（<span style="color: #ff0000;"><a href="https://github.com/wangjiegulu/RefreshableView" target="_blank" rel="noopener"><span style="color: #ff0000;">https://github.com/wangjiegulu/RefreshableView</span></a></span>）</strong></p>
<p><span style="font-size: 18px;"><strong>分析：</strong></span></p>
<p>我们的目的是不管什么控件，只要在xml中外面包一层标签，那这个标签下面的所有子标签所在的控件都被支持可以下拉刷新了。所以，我们可以使用ViewGroup来实现，这里我选择的是继承LinearLayout，当然其他的（FrameLayout等）也一样了。</p>
<p>因为根据手指下滑，需要有一个刷新的view被显示出来，所以这里需要添加一个子view（称为refreshHeaderView），并放置在最顶部，使用LinearLayout的好处是可以设置为VERTICAL，这样可以直接&ldquo;this.addView(refreshHeaderView, 0);&rdquo;搞定了。然后就要根据手指滑动的距离，动态地去改变refreshHeaderView的高度。同时检测是否到达了可以刷新的高度了，如果达到了，更新当前的刷新状态。手指放开时，根据之前移动的刷新状态，执行刷新或者回归正常状态。</p>
<p>RefreshableView代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">  2</span> <span style="color: #008000;"> <em> 下拉刷新控件<br></em></span><span style="color: #008080;">  3</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;">  4</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">  5</span> <span style="color: #008000;">  Date: 12/13/14.<br></span><span style="color: #008080;">  6</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;">  7</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> RefreshableView <span style="color: #0000ff;">extends</span><span style="color: #000000;"> LinearLayout {<br></span><span style="color: #008080;">  8</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = RefreshableView.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;">  9</span><br><span style="color: #008080;"> 10</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> RefreshableView(Context context) {<br></span><span style="color: #008080;"> 11</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;"> 12</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 13</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 14</span><br><span style="color: #008080;"> 15</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> RefreshableView(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;"> 16</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;"> 17</span><br><span style="color: #008080;"> 18</span>         TypedArray a =<span style="color: #000000;"> context.obtainStyledAttributes(attrs, R.styleable.refreshableView);<br></span><span style="color: #008080;"> 19</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0, len = a.length(); i &lt; len; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;"> 20</span>             <span style="color: #0000ff;">int</span> attrIndex =<span style="color: #000000;"> a.getIndex(i);<br></span><span style="color: #008080;"> 21</span>             <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (attrIndex) {<br></span><span style="color: #008080;"> 22</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> R.styleable.refreshableView_interceptAllMoveEvents:<br></span><span style="color: #008080;"> 23</span>                     interceptAllMoveEvents = a.getBoolean(i, <span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 24</span>                     <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 25</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 26</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 27</span> <span style="color: #000000;">        a.recycle();<br></span><span style="color: #008080;"> 28</span><br><span style="color: #008080;"> 29</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 30</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 31</span><br><span style="color: #008080;"> 32</span>     <span style="color: #0000ff;">public</span> RefreshableView(Context context, AttributeSet attrs, <span style="color: #0000ff;">int</span><span style="color: #000000;"> defStyle) {<br></span><span style="color: #008080;"> 33</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs, defStyle);<br></span><span style="color: #008080;"> 34</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 35</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 36</span><br><span style="color: #008080;"> 37</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 38</span> <span style="color: #008000;">     <em> 刷新状态<br></em></span><span style="color: #008080;"> 39</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 40</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> STATE_REFRESH_NORMAL = 0x21<span style="color: #000000;">;<br></span><span style="color: #008080;"> 41</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> STATE_REFRESH_NOT_ARRIVED = 0x22<span style="color: #000000;">;<br></span><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> STATE_REFRESH_ARRIVED = 0x23<span style="color: #000000;">;<br></span><span style="color: #008080;"> 43</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> STATE_REFRESHING = 0x24<span style="color: #000000;">;<br></span><span style="color: #008080;"> 44</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshState;<br></span><span style="color: #008080;"> 45</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 刷新状态监听</span><br><span style="color: #008080;"> 46</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> RefreshableHelper refreshableHelper;<br></span><span style="color: #008080;"> 47</span><br><span style="color: #008080;"> 48</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setRefreshableHelper(RefreshableHelper refreshableHelper) {<br></span><span style="color: #008080;"> 49</span>         <span style="color: #0000ff;">this</span>.refreshableHelper =<span style="color: #000000;"> refreshableHelper;<br></span><span style="color: #008080;"> 50</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 51</span><br><span style="color: #008080;"> 52</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br></span><span style="color: #008080;"> 53</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 54</span> <span style="color: #008000;">     <em> 刷新的view<br></em></span><span style="color: #008080;"> 55</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 56</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> View refreshHeaderView;<br></span><span style="color: #008080;"> 57</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 58</span> <span style="color: #008000;">     <em> 刷新的view的真实高度<br></em></span><span style="color: #008080;"> 59</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 60</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> originRefreshHeight;<br></span><span style="color: #008080;"> 61</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 62</span> <span style="color: #008000;">     <em> 有效下拉刷新需要达到的高度<br></em></span><span style="color: #008080;"> 63</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 64</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshArrivedStateHeight;<br></span><span style="color: #008080;"> 65</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 66</span> <span style="color: #008000;">     <em> 刷新时显示的高度<br></em></span><span style="color: #008080;"> 67</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 68</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshingHeight;<br></span><span style="color: #008080;"> 69</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 70</span> <span style="color: #008000;">     <em> 正常未刷新高度<br></em></span><span style="color: #008080;"> 71</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 72</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshNormalHeight;<br></span><span style="color: #008080;"> 73</span><br><span style="color: #008080;"> 74</span><br><span style="color: #008080;"> 75</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 76</span> <span style="color: #008000;">     <em> 默认不允许拦截（即，往子view传递事件），该属性只有在interceptAllMoveEvents为false的时候才有效<br></em></span><span style="color: #008080;"> 77</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 78</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> disallowIntercept = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 79</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 80</span> <span style="color: #008000;">     <em> xml中可设置它的值为false，表示不把移动的事件传递给子控件<br></em></span><span style="color: #008080;"> 81</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 82</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> interceptAllMoveEvents;<br></span><span style="color: #008080;"> 83</span><br><span style="color: #008080;"> 84</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> init(Context context) {<br></span><span style="color: #008080;"> 85</span>         <span style="color: #0000ff;">this</span>.context =<span style="color: #000000;"> context;<br></span><span style="color: #008080;"> 86</span>         <span style="color: #0000ff;">this</span><span style="color: #000000;">.setOrientation(VERTICAL);<br></span><span style="color: #008080;"> 87</span><br><span style="color: #008080;"> 88</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Log.d(TAG, “[init]originRefreshHeight: “ + refreshHeaderView.getMeasuredHeight());</span><br><span style="color: #008080;"> 89</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 90</span><br><span style="color: #008080;"> 91</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 92</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> onSizeChanged(<span style="color: #0000ff;">int</span> w, <span style="color: #0000ff;">int</span> h, <span style="color: #0000ff;">int</span> oldw, <span style="color: #0000ff;">int</span><span style="color: #000000;"> oldh) {<br></span><span style="color: #008080;"> 93</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onSizeChanged(w, h, oldw, oldh);<br></span><span style="color: #008080;"> 94</span><br><span style="color: #008080;"> 95</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> refreshableHelper) {<br></span><span style="color: #008080;"> 96</span>             refreshHeaderView =<span style="color: #000000;"> refreshableHelper.onInitRefreshHeaderView();<br></span><span style="color: #008080;"> 97</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 98</span> <span style="color: #008000;">//</span><span style="color: #008000;">        refreshHeaderView = LayoutInflater.from(context).inflate(R.layout.refresh_head, null);</span><br><span style="color: #008080;"> 99</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> refreshHeaderView) {<br></span><span style="color: #008080;">100</span>             Log.e(TAG, “refreshHeaderView is null!”<span style="color: #000000;">);<br></span><span style="color: #008080;">101</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">102</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">103</span>         <span style="color: #0000ff;">this</span><span style="color: #000000;">.removeView(refreshHeaderView);<br></span><span style="color: #008080;">104</span>         <span style="color: #0000ff;">this</span>.addView(refreshHeaderView, 0<span style="color: #000000;">);<br></span><span style="color: #008080;">105</span><br><span style="color: #008080;">106</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 计算refreshHeadView尺寸</span><br><span style="color: #008080;">107</span>         <span style="color: #0000ff;">int</span> width = View.MeasureSpec.makeMeasureSpec(0<span style="color: #000000;">, View.MeasureSpec.UNSPECIFIED);<br></span><span style="color: #008080;">108</span>         <span style="color: #0000ff;">int</span> expandSpec = View.MeasureSpec.makeMeasureSpec(Integer.MAX_VALUE &gt;&gt; 2<span style="color: #000000;">, View.MeasureSpec.AT_MOST);<br></span><span style="color: #008080;">109</span> <span style="color: #000000;">        refreshHeaderView.measure(width, expandSpec);<br></span><span style="color: #008080;">110</span><br><span style="color: #008080;">111</span>         Log.d(TAG, “[onSizeChanged]w: “ + w + “, h: “ +<span style="color: #000000;"> h);<br></span><span style="color: #008080;">112</span>         Log.d(TAG, “[onSizeChanged]oldw: “ + oldw + “, oldh: “ +<span style="color: #000000;"> oldh);<br></span><span style="color: #008080;">113</span>         Log.d(TAG, “[onSizeChanged]child counts: “ + <span style="color: #0000ff;">this</span><span style="color: #000000;">.getChildCount());<br></span><span style="color: #008080;">114</span>         originRefreshHeight =<span style="color: #000000;"> refreshHeaderView.getMeasuredHeight();<br></span><span style="color: #008080;">115</span><br><span style="color: #008080;">116</span>         <span style="color: #0000ff;">boolean</span> isUseDefault = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">117</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> refreshableHelper) {<br></span><span style="color: #008080;">118</span>             isUseDefault =<span style="color: #000000;"> refreshableHelper.onInitRefreshHeight(originRefreshHeight);<br></span><span style="color: #008080;">119</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">120</span><br><span style="color: #008080;">121</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 初始化各个高度</span><br><span style="color: #008080;">122</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isUseDefault) {<br></span><span style="color: #008080;">123</span>             refreshArrivedStateHeight =<span style="color: #000000;"> originRefreshHeight;<br></span><span style="color: #008080;">124</span>             refreshingHeight =<span style="color: #000000;"> originRefreshHeight;<br></span><span style="color: #008080;">125</span>             refreshNormalHeight = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">126</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">127</span>         Log.d(TAG, “[onSizeChanged]refreshHeaderView origin height: “ +<span style="color: #000000;"> originRefreshHeight);<br></span><span style="color: #008080;">128</span> <span style="color: #000000;">        changeViewHeight(refreshHeaderView, refreshNormalHeight);<br></span><span style="color: #008080;">129</span><br><span style="color: #008080;">130</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 初始化为正常状态</span><br><span style="color: #008080;">131</span> <span style="color: #000000;">        setRefreshState(STATE_REFRESH_NORMAL);<br></span><span style="color: #008080;">132</span><br><span style="color: #008080;">133</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">134</span><br><span style="color: #008080;">135</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">136</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> dispatchTouchEvent(MotionEvent ev) {<br></span><span style="color: #008080;">137</span>         Log.d(TAG, “[dispatchTouchEvent]ev action: “ +<span style="color: #000000;"> ev.getAction());<br></span><span style="color: #008080;">138</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">super</span><span style="color: #000000;">.dispatchTouchEvent(ev);<br></span><span style="color: #008080;">139</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">140</span><br><span style="color: #008080;">141</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">142</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onInterceptTouchEvent(MotionEvent ev) {<br></span><span style="color: #008080;">143</span>         Log.d(TAG, “[onInterceptTouchEvent]ev action: “ +<span style="color: #000000;"> ev.getAction());<br></span><span style="color: #008080;">144</span>         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">interceptAllMoveEvents) {<br></span><span style="color: #008080;">145</span>             <span style="color: #0000ff;">return</span> !<span style="color: #000000;">disallowIntercept;<br></span><span style="color: #008080;">146</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">147</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了拦截所有move事件，即interceptAllMoveEvents为true</span><br><span style="color: #008080;">148</span>         <span style="color: #0000ff;">if</span> (MotionEvent.ACTION_MOVE ==<span style="color: #000000;"> ev.getAction()) {<br></span><span style="color: #008080;">149</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">150</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">151</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">152</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">153</span><br><span style="color: #008080;">154</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">155</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> requestDisallowInterceptTouchEvent(<span style="color: #0000ff;">boolean</span><span style="color: #000000;"> disallowIntercept) {<br></span><span style="color: #008080;">156</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.disallowIntercept ==<span style="color: #000000;"> disallowIntercept) {<br></span><span style="color: #008080;">157</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">158</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">159</span>         <span style="color: #0000ff;">this</span>.disallowIntercept =<span style="color: #000000;"> disallowIntercept;<br></span><span style="color: #008080;">160</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.requestDisallowInterceptTouchEvent(disallowIntercept);<br></span><span style="color: #008080;">161</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">162</span><br><span style="color: #008080;">163</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">float</span> downY =<span style="color: #000000;"> Float.MAX_VALUE;<br></span><span style="color: #008080;">164</span><br><span style="color: #008080;">165</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">166</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onTouchEvent(MotionEvent event) {<br></span><span style="color: #008080;">167</span> <span style="color: #008000;">//</span><span style="color: #008000;">        super.onTouchEvent(event);</span><br><span style="color: #008080;">168</span>         Log.d(TAG, “[onTouchEvent]ev action: “ +<span style="color: #000000;"> event.getAction());<br></span><span style="color: #008080;">169</span>         <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (event.getAction()) {<br></span><span style="color: #008080;">170</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_DOWN:<br></span><span style="color: #008080;">171</span>                 downY =<span style="color: #000000;"> event.getY();<br></span><span style="color: #008080;">172</span>                 Log.d(TAG, “Down –&gt; downY: “ +<span style="color: #000000;"> downY);<br></span><span style="color: #008080;">173</span>                 requestDisallowInterceptTouchEvent(<span style="color: #0000ff;">true</span>); <span style="color: #008000;">//</span><span style="color: #008000;"> 保证事件可往下传递</span><br><span style="color: #008080;">174</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">175</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_MOVE:<br></span><span style="color: #008080;">176</span><br><span style="color: #008080;">177</span>                 <span style="color: #0000ff;">float</span> curY =<span style="color: #000000;"> event.getY();<br></span><span style="color: #008080;">178</span>                 <span style="color: #0000ff;">float</span> deltaY = curY -<span style="color: #000000;"> downY;<br></span><span style="color: #008080;">179</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 是否是有效的往下拖动事件（则需要显示加载header）</span><br><span style="color: #008080;">180</span>                 <span style="color: #0000ff;">boolean</span> isDropDownValidate = Float.MAX_VALUE !=<span style="color: #000000;"> downY;<br></span><span style="color: #008080;">181</span>                 <span style="color: #008000;">/</span><br><span style="color: #008080;">182</span> <span style="color: #008000;">                 <em> 修改拦截设置<br></em></span><span style="color: #008080;">183</span> <span style="color: #008000;">                  如果是有效往下拖动事件，则事件需要在本ViewGroup中处理，所以需要拦截不往子控件传递，即不允许拦截设为false<br></span><span style="color: #008080;">184</span> <span style="color: #008000;">                 <em> 如果是有效往下拖动事件，则事件传递给子控件处理，所以不需要拦截，并往子控件传递，即不允许拦截设为true<br></em></span><span style="color: #008080;">185</span>                  <span style="color: #008000;">/</span><br><span style="color: #008080;">186</span>                 requestDisallowInterceptTouchEvent(!<span style="color: #000000;">isDropDownValidate);<br></span><span style="color: #008080;">187</span><br><span style="color: #008080;">188</span>                 downY =<span style="color: #000000;"> curY;<br></span><span style="color: #008080;">189</span>                 Log.d(TAG, “Move –&gt; deltaY(curY - downY): “ +<span style="color: #000000;"> deltaY);<br></span><span style="color: #008080;">190</span>                 <span style="color: #0000ff;">int</span> curHeight =<span style="color: #000000;"> refreshHeaderView.getMeasuredHeight();<br></span><span style="color: #008080;">191</span>                 <span style="color: #0000ff;">int</span> exceptHeight = curHeight + (<span style="color: #0000ff;">int</span>) (deltaY / 2<span style="color: #000000;">);<br></span><span style="color: #008080;">192</span><br><span style="color: #008080;">193</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 如果当前没有处在正在刷新状态，则更新刷新状态</span><br><span style="color: #008080;">194</span>                 <span style="color: #0000ff;">if</span> (STATE_REFRESHING !=<span style="color: #000000;"> refreshState) {<br></span><span style="color: #008080;">195</span>                     <span style="color: #0000ff;">if</span> (curHeight &gt;= refreshArrivedStateHeight) { <span style="color: #008000;">//</span><span style="color: #008000;"> 达到可刷新状态</span><br><span style="color: #008080;">196</span> <span style="color: #000000;">                        setRefreshState(STATE_REFRESH_ARRIVED);<br></span><span style="color: #008080;">197</span>                     } <span style="color: #0000ff;">else</span> { <span style="color: #008000;">//</span><span style="color: #008000;"> 未达到可刷新状态</span><br><span style="color: #008080;">198</span> <span style="color: #000000;">                        setRefreshState(STATE_REFRESH_NOT_ARRIVED);<br></span><span style="color: #008080;">199</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">200</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">201</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isDropDownValidate) {<br></span><span style="color: #008080;">202</span> <span style="color: #000000;">                    changeViewHeight(refreshHeaderView, Math.max(refreshNormalHeight, exceptHeight));<br></span><span style="color: #008080;">203</span>                 } <span style="color: #0000ff;">else</span> { <span style="color: #008000;">//</span><span style="color: #008000;"> 防止从子控件修改拦截后引发的downY为Float.MAX_VALUE的问题</span><br><span style="color: #008080;">204</span> <span style="color: #000000;">                    changeViewHeight(refreshHeaderView, Math.max(curHeight, exceptHeight));<br></span><span style="color: #008080;">205</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">206</span><br><span style="color: #008080;">207</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">208</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_UP:<br></span><span style="color: #008080;">209</span>                 downY =<span style="color: #000000;"> Float.MAX_VALUE;<br></span><span style="color: #008080;">210</span>                 Log.d(TAG, “Up –&gt; downY: “ +<span style="color: #000000;"> downY);<br></span><span style="color: #008080;">211</span>                 requestDisallowInterceptTouchEvent(<span style="color: #0000ff;">true</span>); <span style="color: #008000;">//</span><span style="color: #008000;"> 保证事件可往下传递<br></span><span style="color: #008080;">212</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 如果是达到刷新状态，则设置正在刷新状态的高度</span><br><span style="color: #008080;">213</span>                 <span style="color: #0000ff;">if</span> (STATE_REFRESH_ARRIVED == refreshState) { <span style="color: #008000;">//</span><span style="color: #008000;"> 达到了刷新的状态</span><br><span style="color: #008080;">214</span> <span style="color: #000000;">                    startHeightAnimation(refreshHeaderView, refreshHeaderView.getMeasuredHeight(), refreshingHeight);<br></span><span style="color: #008080;">215</span> <span style="color: #000000;">                    setRefreshState(STATE_REFRESHING);<br></span><span style="color: #008080;">216</span>                 } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (STATE_REFRESHING == refreshState) { <span style="color: #008000;">//</span><span style="color: #008000;"> 正在刷新的状态</span><br><span style="color: #008080;">217</span> <span style="color: #000000;">                    startHeightAnimation(refreshHeaderView, refreshHeaderView.getMeasuredHeight(), refreshingHeight);<br></span><span style="color: #008080;">218</span>                 } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">219</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 执行动画后回归正常状态</span><br><span style="color: #008080;">220</span> <span style="color: #000000;">                    startHeightAnimation(refreshHeaderView, refreshHeaderView.getMeasuredHeight(), refreshNormalHeight, normalAnimatorListener);<br></span><span style="color: #008080;">221</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">222</span><br><span style="color: #008080;">223</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">224</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_CANCEL:<br></span><span style="color: #008080;">225</span>                 Log.d(TAG, “cancel”<span style="color: #000000;">);<br></span><span style="color: #008080;">226</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">227</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">228</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">229</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">230</span><br><span style="color: #008080;">231</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">232</span> <span style="color: #008000;">     <em> 刷新完毕后调用此方法<br></em></span><span style="color: #008080;">233</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">234</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCompleteRefresh() {<br></span><span style="color: #008080;">235</span>         <span style="color: #0000ff;">if</span> (STATE_REFRESHING ==<span style="color: #000000;"> refreshState) {<br></span><span style="color: #008080;">236</span> <span style="color: #000000;">            setRefreshState(STATE_REFRESH_NORMAL);<br></span><span style="color: #008080;">237</span> <span style="color: #000000;">            startHeightAnimation(refreshHeaderView, refreshHeaderView.getMeasuredHeight(), refreshNormalHeight);<br></span><span style="color: #008080;">238</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">239</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">240</span><br><span style="color: #008080;">241</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">242</span> <span style="color: #008000;">     <em> 修改当前的刷新状态<br></em></span><span style="color: #008080;">243</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">244</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> expectRefreshState<br></span><span style="color: #008080;">245</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">246</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> setRefreshState(<span style="color: #0000ff;">int</span><span style="color: #000000;"> expectRefreshState) {<br></span><span style="color: #008080;">247</span>         <span style="color: #0000ff;">if</span> (expectRefreshState !=<span style="color: #000000;"> refreshState) {<br></span><span style="color: #008080;">248</span>             refreshState =<span style="color: #000000;"> expectRefreshState;<br></span><span style="color: #008080;">249</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> refreshableHelper) {<br></span><span style="color: #008080;">250</span> <span style="color: #000000;">                refreshableHelper.onRefreshStateChanged(refreshHeaderView, refreshState);<br></span><span style="color: #008080;">251</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">252</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">253</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">254</span><br><span style="color: #008080;">255</span><br><span style="color: #008080;">256</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">257</span> <span style="color: #008000;">     <em> 改变某控件的高度<br></em></span><span style="color: #008080;">258</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">259</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> view<br></span><span style="color: #008080;">260</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> height<br></span><span style="color: #008080;">261</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">262</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> changeViewHeight(View view, <span style="color: #0000ff;">int</span><span style="color: #000000;"> height) {<br></span><span style="color: #008080;">263</span>         Log.d(TAG, “[changeViewHeight]change Height: “ +<span style="color: #000000;"> height);<br></span><span style="color: #008080;">264</span>         ViewGroup.LayoutParams lp =<span style="color: #000000;"> view.getLayoutParams();<br></span><span style="color: #008080;">265</span>         lp.height =<span style="color: #000000;"> height;<br></span><span style="color: #008080;">266</span> <span style="color: #000000;">        view.setLayoutParams(lp);<br></span><span style="color: #008080;">267</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">268</span><br><span style="color: #008080;">269</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">270</span> <span style="color: #008000;">     <em> 改变某控件的高度动画<br></em></span><span style="color: #008080;">271</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">272</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> view<br></span><span style="color: #008080;">273</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> fromHeight<br></span><span style="color: #008080;">274</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> toHeight<br></span><span style="color: #008080;">275</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">276</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> startHeightAnimation(<span style="color: #0000ff;">final</span> View view, <span style="color: #0000ff;">int</span> fromHeight, <span style="color: #0000ff;">int</span><span style="color: #000000;"> toHeight) {<br></span><span style="color: #008080;">277</span>         startHeightAnimation(view, fromHeight, toHeight, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">278</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">279</span><br><span style="color: #008080;">280</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> startHeightAnimation(<span style="color: #0000ff;">final</span> View view, <span style="color: #0000ff;">int</span> fromHeight, <span style="color: #0000ff;">int</span><span style="color: #000000;"> toHeight, Animator.AnimatorListener animatorListener) {<br></span><span style="color: #008080;">281</span>         <span style="color: #0000ff;">if</span> (toHeight ==<span style="color: #000000;"> view.getMeasuredHeight()) {<br></span><span style="color: #008080;">282</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">283</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">284</span>         ValueAnimator heightAnimator =<span style="color: #000000;"> ValueAnimator.ofInt(fromHeight, toHeight);<br></span><span style="color: #008080;">285</span>         heightAnimator.addUpdateListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> ValueAnimator.AnimatorUpdateListener() {<br></span><span style="color: #008080;">286</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">287</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onAnimationUpdate(ValueAnimator valueAnimator) {<br></span><span style="color: #008080;">288</span>                 Integer value =<span style="color: #000000;"> (Integer) valueAnimator.getAnimatedValue();<br></span><span style="color: #008080;">289</span>                 <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> == value) <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">290</span> <span style="color: #000000;">                changeViewHeight(view, value);<br></span><span style="color: #008080;">291</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">292</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">293</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> animatorListener) {<br></span><span style="color: #008080;">294</span> <span style="color: #000000;">            heightAnimator.addListener(animatorListener);<br></span><span style="color: #008080;">295</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">296</span>         heightAnimator.setInterpolator(<span style="color: #0000ff;">new</span><span style="color: #000000;"> LinearInterpolator());<br></span><span style="color: #008080;">297</span>         heightAnimator.setDuration(300<span style="color: #008000;">/<em></em></span><span style="color: #008000;">ms</span><span style="color: #008000;">/</span><span style="color: #000000;">);<br></span><span style="color: #008080;">298</span> <span style="color: #000000;">        heightAnimator.start();<br></span><span style="color: #008080;">299</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">300</span><br><span style="color: #008080;">301</span>     AnimatorListenerAdapter normalAnimatorListener = <span style="color: #0000ff;">new</span><span style="color: #000000;"> AnimatorListenerAdapter() {<br></span><span style="color: #008080;">302</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">303</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onAnimationEnd(Animator animation) {<br></span><span style="color: #008080;">304</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">.onAnimationEnd(animation);<br></span><span style="color: #008080;">305</span>             setRefreshState(STATE_REFRESH_NORMAL); <span style="color: #008000;">//</span><span style="color: #008000;"> 回归正常状态</span><br><span style="color: #008080;">306</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">307</span> <span style="color: #000000;">    };<br></span><span style="color: #008080;">308</span><br><span style="color: #008080;">309</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setRefreshArrivedStateHeight(<span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshArrivedStateHeight) {<br></span><span style="color: #008080;">310</span>         <span style="color: #0000ff;">this</span>.refreshArrivedStateHeight =<span style="color: #000000;"> refreshArrivedStateHeight;<br></span><span style="color: #008080;">311</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">312</span><br><span style="color: #008080;">313</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setRefreshingHeight(<span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshingHeight) {<br></span><span style="color: #008080;">314</span>         <span style="color: #0000ff;">this</span>.refreshingHeight =<span style="color: #000000;"> refreshingHeight;<br></span><span style="color: #008080;">315</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">316</span><br><span style="color: #008080;">317</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setRefreshNormalHeight(<span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshNormalHeight) {<br></span><span style="color: #008080;">318</span>         <span style="color: #0000ff;">this</span>.refreshNormalHeight =<span style="color: #000000;"> refreshNormalHeight;<br></span><span style="color: #008080;">319</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">320</span><br><span style="color: #008080;">321</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getOriginRefreshHeight() {<br></span><span style="color: #008080;">322</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> originRefreshHeight;<br></span><span style="color: #008080;">323</span>     }</pre><br></div>

<p>其中：</p>
<p>originRefreshHeight，表示头部刷新view的实际高度。</p>
<p>refreshArrivedStateHeight，表示下拉多少距离可以执行刷新了</p>
<p>refreshingHeight，表示刷新的时候显示的高度时多少</p>
<p>refreshNormalHeight，表示正常状态下refreshHeaderView显示的高度是多少</p>
<p>&nbsp;</p>
<p>主要的核心代码应该是在onTouchEvent方法中，</p>
<p>先简单分析里面的主要代码：在ACTION_DOWN的时候，纪录当前手指下落的y坐标，然后再ACTION_MOVE的时候，去计算滑动的距离，并且判断如果滑动的距离大于refreshArrivedStateHeight，更新处于已经达到可刷新的状态，反之就更新处于未达到可刷新的状态。然后再ACTION_UP中，如果已经达到了可刷新的状态，则更新当前状态为正在刷新状态，并且回调状态改变的方法。</p>
<p>&nbsp;</p>
<p>如果里面有ScrollView等可以滚动的控件的时候，应该怎么处理里面的事件呢？</p>
<p>就以<a href="https://github.com/wangjiegulu/RefreshableView" target="_blank" rel="noopener">https://github.com/wangjiegulu/RefreshableView</a>&nbsp;为例</p>
<p>xml布局如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">com.wangjie.refreshableview.RefreshableView<br></span><span style="color: #008080;"> 2</span>             <span style="color: #ff0000;">xmlns:rv</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/com.wangjie.refreshableview" target="_blank" rel="noopener">http://schemas.android.com/apk/res/com.wangjie.refreshableview</a>“</span><br><span style="color: #008080;"> 3</span> <span style="color: #ff0000;">            android:id</span><span style="color: #0000ff;">=”@+id/main_refresh_view”</span><br><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;"> 6</span> <span style="color: #ff0000;">            rv:interceptAllMoveEvents</span><span style="color: #0000ff;">=”false”</span><br><span style="color: #008080;"> 7</span>             <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">com.wangjie.refreshableview.NestScrollView </span><span style="color: #ff0000;">android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"> android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 9</span> <span style="color: #ff0000;">                android:fillViewport</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;">10</span>                 <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextView<br></span><span style="color: #008080;">13</span>                     <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/main_tv”</span><br><span style="color: #008080;">14</span> <span style="color: #ff0000;">                    android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">15</span> <span style="color: #ff0000;">                    android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">16</span> <span style="color: #ff0000;">                    android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;">17</span> <span style="color: #ff0000;">                    android:padding</span><span style="color: #0000ff;">=”20dp”</span><br><span style="color: #008080;">18</span> <span style="color: #ff0000;">                    android:textSize</span><span style="color: #0000ff;">=”18sp”</span><br><span style="color: #008080;">19</span> <span style="color: #ff0000;">                    android:text</span><span style="color: #0000ff;">=”Drop Down For Refresh\n\n\n\n\n\n\n\n\n\n\nDrop Down For Refresh\nDrop Down For Refresh\n\n\n\n\n\n\n\n\n\n\nDrop Down For Refresh\nDrop Down For Refresh\n\n\n\n\n\n\n\n\n\n\nDrop Down For Refresh\nDrop Down For Refresh\n\n\n\n\n\n\n\n\n\n\nDrop Down For Refresh”</span><br><span style="color: #008080;">20</span>                     <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span>         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">com.wangjie.refreshableview.NestScrollView</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">23</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">com.wangjie.refreshableview.RefreshableView</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>如上，最外面是一个RefreshableView，然后里面是一个NestScrollView，NestScrollView里面是TextView，其中TextView中因为文字较多，所以使用NestScrollView来实现滚动（NestScrollView扩展自ScrollView，下面会讲到）。这个时候的逻辑应该是，当NestScrollView处于顶部的时候，手指向下滑动，这时这个touch事件应该交给RefreshableView处理；当手指向上滑动时，也就是ScrollView向下滚动，这时，需要把touch事件给RefreshableView来处理。</p>
<p>&nbsp;</p>
<p>下面分析里面的代码：</p>
<p>RefreshableView的interceptAllMoveEvents表示是否需要RefreshableView阻止所有MOVE的事件（也就是说由RefreshableView自己处理所有MOVE事件），如果自控件中没有ScrollView等需要处理MOVE事件的控件，则可以设置为true；如果有类似ScrollView等控件，则需要设置为false，这样的话，RefreshableView会把MOVE事件传递给子类，由子类去处理。显然，现在例子中的情况是需要把interceptAllMoveEvents设置为false。设置的方法可以看上面的xml文件，使用rv:interceptAllMoveEvents=”false”这个属性即可。</p>
<p>onInterceptTouchEvent()方法中，我们返回的是disallowIntercept，这个disallowIntercept是根据requestDisallowInterceptTouchEvent()方法的调用来动态变化的，这样可以做到切换touch事件的处理对象。</p>
<p>在手指落下的时候，先调用requestDisallowInterceptTouchEvent()方法，保证当前的事件可以正常往子控件传递，也就是现在的ScrollView。然后手指会开始移动，在ACTION_MOVE中，先计算出当前滑动的距离。</p>
<p>如果是有效往下拖动事件，则事件需要在RefreshableView中处理，所以需要拦截不往子控件传递，即不允许拦截设为false；如果不是有效往下拖动事件，则事件传递给子控件处理，所以不需要拦截，并往子控件传递，即不允许拦截设为true。</p>
<p>怎么去判断是否有效呢？根据downY，如果downY是原来的初始值Float.MAX_VALUE，说明，这个MOVE事件刚开始DOWN的时候是被子控件处理的，而不是RefreshableView处理的，说明对于RefreshableView来说，是一个无效的往下拖动事件；如果downY不是原来的初始值Float.MAX_VALUE，说明，这个MOVE事件在DOWN的时候就已经是RefreshableView处理的了，所以是有效的。</p>
<p>然后，计算refreshHeaderView的高度，根据滑动的差量对refreshHeaderView的高度进行变换。</p>
<p>如果当前的状态是正在刷新，那MOVE事件直接无效。</p>
<p>否则，再去判断当前的高度是不是达到了可刷新状态，或者没有达到可刷新状态，更新状态值。</p>
<p>在UP的时候，还是先保证事件往下传递。并重置downY。然后根据当前的状态，如果达到了刷新的状态，则开始刷新，并更新当前的额状态时正在刷新状态；如果没有达到刷新状态，则执行动画返回到正常状态；如果本来就是正在刷新状态，也执行动画回归到正在刷新的高度。</p>
<p>&nbsp;</p>
<p>然后分析下NestScrollView：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;"> <em> Author: wangjie<br></em></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">  Email: tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;"> <em> Date: 12/13/14.<br></em></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> NestScrollView <span style="color: #0000ff;">extends</span><span style="color: #000000;"> ScrollView {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = NestScrollView.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> NestScrollView(Context context) {<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> NestScrollView(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;">14</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span> NestScrollView(Context context, AttributeSet attrs, <span style="color: #0000ff;">int</span><span style="color: #000000;"> defStyle) {<br></span><span style="color: #008080;">18</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs, defStyle);<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">22</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> dispatchTouchEvent(MotionEvent ev) {<br></span><span style="color: #008080;">23</span>         Log.d(TAG, “<strong><em>[dispatchTouchEvent]ev action: “ +<span style="color: #000000;"> ev.getAction());<br></span><span style="color: #008080;">24</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">super</span><span style="color: #000000;">.dispatchTouchEvent(ev);<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onInterceptTouchEvent(MotionEvent ev) {<br></span><span style="color: #008080;">29</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onInterceptTouchEvent(ev);<br></span><span style="color: #008080;">30</span>         Log.d(TAG, “</em></strong>[onInterceptTouchEvent]ev action: “ +<span style="color: #000000;"> ev.getAction());<br></span><span style="color: #008080;">31</span>         <span style="color: #0000ff;">if</span> (MotionEvent.ACTION_MOVE ==<span style="color: #000000;"> ev.getAction()) {<br></span><span style="color: #008080;">32</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">34</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">36</span><br><span style="color: #008080;">37</span>     <span style="color: #0000ff;">float</span><span style="color: #000000;"> lastDownY;<br></span><span style="color: #008080;">38</span><br><span style="color: #008080;">39</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">40</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onTouchEvent(MotionEvent event) {<br></span><span style="color: #008080;">41</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onTouchEvent(event);<br></span><span style="color: #008080;">42</span>         <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (event.getAction()) {<br></span><span style="color: #008080;">43</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_DOWN:<br></span><span style="color: #008080;">44</span>                 lastDownY =<span style="color: #000000;"> event.getY();<br></span><span style="color: #008080;">45</span>                 parentRequestDisallowInterceptTouchEvent(<span style="color: #0000ff;">true</span>); <span style="color: #008000;">//</span><span style="color: #008000;"> 保证事件可往下传递</span><br><span style="color: #008080;">46</span>                 Log.d(TAG, “<strong>_Down”<span style="color: #000000;">);<br></span><span style="color: #008080;">47</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">48</span> <span style="color: #008000;">//</span><span style="color: #008000;">                break;</span><br><span style="color: #008080;">49</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION<em>MOVE:<br></em></span><span style="color: #008080;">50</span>                 Log.d(TAG, “</strong>move, this.getScrollY(): “ + <span style="color: #0000ff;">this</span><span style="color: #000000;">.getScrollY());<br></span><span style="color: #008080;">51</span>                 <span style="color: #0000ff;">boolean</span> isTop = event.getY() - lastDownY &gt; 0 &amp;&amp; <span style="color: #0000ff;">this</span>.getScrollY() == 0<span style="color: #000000;">;<br></span><span style="color: #008080;">52</span>                 <span style="color: #0000ff;">if</span> (isTop) { <span style="color: #008000;">//</span><span style="color: #008000;"> 允许父控件拦截，即不允许父控件拦截设为false</span><br><span style="color: #008080;">53</span>                     parentRequestDisallowInterceptTouchEvent(<span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;">54</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">55</span>                 } <span style="color: #0000ff;">else</span> { <span style="color: #008000;">//</span><span style="color: #008000;"> 不允许父控件拦截，即不允许父控件拦截设为true</span><br><span style="color: #008080;">56</span>                     parentRequestDisallowInterceptTouchEvent(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">57</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">58</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">59</span> <span style="color: #008000;">//</span><span style="color: #008000;">                break;</span><br><span style="color: #008080;">60</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_UP:<br></span><span style="color: #008080;">61</span>                 Log.d(TAG, “<strong>_up, this.getScrollY(): “ + <span style="color: #0000ff;">this</span><span style="color: #000000;">.getScrollY());<br></span><span style="color: #008080;">62</span>                 parentRequestDisallowInterceptTouchEvent(<span style="color: #0000ff;">true</span>); <span style="color: #008000;">//</span><span style="color: #008000;"> 保证事件可往下传递</span><br><span style="color: #008080;">63</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">64</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION<em>CANCEL:<br></em></span><span style="color: #008080;">65</span>                 Log.d(TAG, “</strong>cancel”<span style="color: #000000;">);<br></span><span style="color: #008080;">66</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">67</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">68</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">70</span><br><span style="color: #008080;">71</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">72</span> <span style="color: #008000;">     <em> 是否允许父控件拦截事件<br></em></span><span style="color: #008080;">73</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> disallowIntercept<br></span><span style="color: #008080;">74</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">75</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> parentRequestDisallowInterceptTouchEvent(<span style="color: #0000ff;">boolean</span><span style="color: #000000;"> disallowIntercept) {<br></span><span style="color: #008080;">76</span>         ViewParent vp =<span style="color: #000000;"> getParent();<br></span><span style="color: #008080;">77</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> vp) {<br></span><span style="color: #008080;">78</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">79</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">80</span> <span style="color: #000000;">        vp.requestDisallowInterceptTouchEvent(disallowIntercept);<br></span><span style="color: #008080;">81</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">82</span><br><span style="color: #008080;">83</span> }</pre><br></div>

<p>如上所示，也需要重写onInterceptTouchEvent()方法，它需要把除了MOVE事件外的所有事件传递下去，这样最里面的TextView才有OnClick等事件。</p>
<p>在onTouchEvent方法中，在ACTION_DOWN的时候，先纪录down的y坐标，然后保证parent（即，RefreshableView）的事件可以传递过来，所以需要调用getParent().requestDisallowInterceptTouchEvent()方法。因为下拉刷新只能发生在ScrollView滚动条在顶部的时候，所以在MOVE中，如果当前状态在顶部，那就需要让父控件（RefreshableView）拦截，然后直接返回false，让当前的事件传递到RefreshableView中的onTouchEvent方法中处理。如果不是在top，那就屏蔽调用父控件（RefreshableView）的处理，直接自己处理。最后在UP的时候再确保事件可以传递到ScrollView这里来。</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> view </tag>
            
            <tag> RefreshableView </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[基于git的源代码管理模型——git flow]]></title>
      <url>/2014/12/11/%E5%9F%BA%E4%BA%8Egit%E7%9A%84%E6%BA%90%E4%BB%A3%E7%A0%81%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9E%8B%E2%80%94%E2%80%94git-flow/</url>
      <content type="html"><![CDATA[<p><strong>说明：</strong>&nbsp;本文以nvie的&ldquo;<a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="noopener">a successful git branching model</a>&rdquo;为蓝本，结合我个人理解写成。如有谬误，还请各位指出。多谢！</p>
<p><strong>Note:</strong>&nbsp;This article is highly based on nvie’s&nbsp;<a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="noopener">a successful git branching model</a>. Thanks nvie.</p>
<div class="post-text"><br><br># Git Flow 是什么<br><br>Git Flow是构建在Git之上的一个组织软件开发活动的模型，是在Git之上构建的一项软件开发最佳实践。Git Flow是一套使用Git进行源代码管理时的一套行为规范和简化部分Git操作的工具。<br><br>2010年5月，在一篇名为&ldquo;<a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="noopener">一种成功的Git分支模型</a>&rdquo;的博文中，@nvie介绍了一种在Git之上的软件开发模型。通过利用Git创建和管理分支的能力，为每个分支设定具有特定的含义名称，并将软件生命周期中的各类活动归并到不同的分支上。实现了软件开发过程不同操作的相互隔离。这种软件开发的活动模型被nwie称为&ldquo;Git Flow&rdquo;。<br><br>一般而言，软件开发模型有常见的瀑布模型、迭代开发模型、以及最近出现的敏捷开发模型等不同的模型。每种模型有各自应用场景。Git Flow重点解决的是由于源代码在开发过程中的各种冲突导致开发活动混乱的问题。因此，Git flow可以很好的于各种现有开发模型相结合使用。<br><br>在开始研究Git Flow的具体内容前，下面这张图可以看到模型的全貌（引自nvie的<a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="noopener">博文</a>)：<br><br>&nbsp;<br><br># Git Flow中的分支<br><br>Git Flow模型中定义了主分支和辅助分支两类分支。其中主分支用于组织与软件开发、部署相关的活动；辅助分支组织为了解决特定的问题而进行的各种开发活动。<br><br>## 主分支<br><br>主分支是所有开发活动的核心分支。所有的开发活动产生的输出物最终都会反映到主分支的代码中。主分支分为master分支和development分支。<br><br>&nbsp;<br><br>### master分支<br><br>master分支上存放的应该是随时可供在生产环境中部署的代码（Production Ready state）。当开发活动告一段落，产生了一份新的可供部署的代码时，master分支上的代码会被更新。同时，每一次更新，最好添加对应的版本号标签（TAG）。<br><br>### develop分支<br><br>develop分支是保存当前最新开发成果的分支。通常这个分支上的代码也是可进行每日夜间发布的代码（Nightly build）。因此这个分支有时也可以被称作&ldquo;integration branch&rdquo;。<br><br>当develop分支上的代码已实现了软件需求说明书中所有的功能，通过了所有的测试后，并且代码已经足够稳定时，就可以将所有的开发成果合并回master分支了。对于master分支上的新提交的代码建议都打上一个新的版本号标签（TAG），供后续代码跟踪使用。<br><br>因此，每次将develop分支上的代码合并回master分支时，我们都可以认为一个新的可供在生产环境中部署的版本就产生了。通常而言，&ldquo;仅在发布新的可供部署的代码时才更新master分支上的代码&rdquo;是推荐所有人都遵守的行为准则。基于此，理论上说，每当有代码提交到master分支时，我们可以使用Git Hook触发软件自动测试以及生产环境代码的自动更新工作。这些自动化操作将有利于减少新代码发布之后的一些事务性工作。<br><br>## 辅助分支<br><br>辅助分支是用于组织解决特定问题的各种软件开发活动的分支。辅助分支主要用于组织软件新功能的并行开发、简化新功能开发代码的跟踪、辅助完成版本发布工作以及对生产代码的缺陷进行紧急修复工作。这些分支与主分支不同，通常只会在有限的时间范围内存在。<br><br>辅助分支包括：<br><br><em>   用于开发新功能时所使用的feature分支；
</em>   用于辅助版本发布的release分支；<br><em>   用于修正生产代码中的缺陷的hotfix分支。<br><br>以上这些分支都有固定的使用目的和分支操作限制。从单纯技术的角度说，这些分支与Git其他分支并没有什么区别，但通过命名，我们定义了使用这些分支的方法。<br><br>### feature分支<br><br>使用规范：

</em>   可以从develop分支发起feature分支<br><em>   代码必须合并回develop分支
</em>   feature分支的命名可以使用除<code>master</code>，<code>develop</code>，<code>release-*</code>，<code>hotfix-*</code>之外的任何名称<br><br>feature分支（有时也可以被叫做&ldquo;topic分支&rdquo;）通常是在开发一项新的软件功能的时候使用，这个分支上的代码变更最终合并回develop分支或者干脆被抛弃掉（例如实验性且效果不好的代码变更）。<br><br>一般而言，feature分支代码可以保存在开发者自己的代码库中而不强制提交到主代码库里。<br><br>&nbsp;<br><br>### release分支<br><br>使用规范：<br><br><em>   可以从develop分支派生
</em>   必须合并回develop分支和master分支<br><em>   分支命名惯例：`release-</em><code>release分支是为发布新的产品版本而设计的。在这个分支上的代码允许做小的缺陷修正、准备发布版本所需的各项说明信息（版本号、发布时间、编译时间等等）。通过在release分支上进行这些工作可以让develop分支空闲出来以接受新的feature分支上的代码提交，进入新的软件开发迭代周期。

当develop分支上的代码已经包含了所有即将发布的版本中所计划包含的软件功能，并且已通过所有测试时，我们就可以考虑准备创建release分支了。而所有在当前即将发布的版本之外的业务需求一定要确保不能混到release分支之内（避免由此引入一些不可控的系统缺陷）。

成功的派生了release分支，并被赋予版本号之后，develop分支就可以为&amp;ldquo;下一个版本&amp;rdquo;服务了。所谓的&amp;ldquo;下一个版本&amp;rdquo;是在当前即将发布的版本之后发布的版本。版本号的命名可以依据项目定义的版本号命名规则进行。

### hotfix分支

使用规范：

*   可以从master分支派生
*   必须合并回master分支和develop分支
*   分支命名惯例：</code>hotfix-<em><code>除了是计划外创建的以外，hotfix分支与release分支十分相似：都可以产生一个新的可供在生产环境部署的软件版本。

当生产环境中的软件遇到了异常情况或者发现了严重到必须立即修复的软件缺陷的时候，就需要从master分支上指定的TAG版本派生hotfix分支来组织代码的紧急修复工作。

这样做的显而易见的好处是不会打断正在进行的develop分支的开发工作，能够让团队中负责新功能开发的人与负责代码紧急修复的人并行的开展工作。

&amp;nbsp;

# 更进一步

Git Flow开发模型从源代码管理角度对通常意义上的软件开发活动进行了约束。应该说，为我们的软件开发提供了一个可供参考的管理模型。Git Flow开发模型让nvie的开发代码仓库保持整洁，让小组各个成员之间的开发相互隔离，能够有效避免处于开发状态中的代码相互影响而导致的效率低下和混乱。

所谓模型，在不同的开发团队，不同的文化，不同的项目背景情况下都有可能需要进行适当的裁剪或扩充。祝各位好运！

PS：为了简化使用Git Flow模型时Git指令的复杂性，nvie开发出了一套[git增强指令集](https://github.com/nvie/gitflow)。可以运行于Windows、Linux、Unix和Mac操作系统之下。有兴趣的同学可以去看看。

# 附录

## 安装Git Flow

Git Flow的在不同的操作系统之下有一些轻微的不同。好在nvie给出了详细的指导。

### Windows

配合Cygwin使用。Cygwin之下的安装非常简单。执行如下指令即可：</code>wget -q -O - –no-check-certificate <a href="https://github.com/nvie/gitflow/raw/develop/contrib/gitflow-installer.sh" target="_blank" rel="noopener">https://github.com/nvie/gitflow/raw/develop/contrib/gitflow-installer.sh</a> | bash`<br><br>使用这条命令在大多数情况下都可以完成Git Flow的安装。但在少数情况下也会遇到异常：

</em>   执行 git flow init 命令后出现错误：”flags: FATAL unable to determine getopt version”<br><br>需要使用Cygwin的Util-linux安装包。重新使用cywgin的setup安装吧。<br><br><em>   如果出现类似”$’\r’: command not found”的错误，则可能是换行符出现了问题。可以使用sed命令来快速解决。<br><br>`$ sed -i ‘s/\n\r/\n/mg’ /usr/local/bin/git-flow</em><br>$ sed -i ‘s/\n\r/\n/mg’ /usr/local/bin/gitflow-*`<br><br>&nbsp;<br><br></div><br><div class="copyright-announce">来自：<a href="http://www.ituring.com.cn/article/56870" target="_blank" rel="noopener">http://www.ituring.com.cn/article/56870</a></div>

]]></content>
      
        
        <tags>
            
            <tag> git </tag>
            
            <tag> git flow </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]在Adapter的getView方法中绑定OnClickListener比较好的方法]]></title>
      <url>/2014/12/05/Android-%E5%9C%A8Adapter%E7%9A%84getView%E6%96%B9%E6%B3%95%E4%B8%AD%E7%BB%91%E5%AE%9AOnClickListener%E6%AF%94%E8%BE%83%E5%A5%BD%E7%9A%84%E6%96%B9%E6%B3%95/</url>
      <content type="html"><![CDATA[<p>给ListView中每个item绑定点击事件的方法，比较常见的如下这种方式：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> View getView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> positon, View convertView, ViewGroup parent){<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> convertView){<br></span><span style="color: #008080;"> 3</span>         convertView = LayoutInflater.<span style="color: #0000ff;">from</span>(context).inflate(R.layout.item, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span>     Button button =<span style="color: #000000;"> ABViewUtil.obtainView(convertView, R.id.item_btn);<br></span><span style="color: #008080;"> 7</span>     button.setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener(){<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v){<br></span><span style="color: #008080;">10</span>             Toast.makeText(context, <span style="color: #800000;">“</span><span style="color: #800000;">position: </span><span style="color: #800000;">“</span> +<span style="color: #000000;"> position, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    });<br></span><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span> }</pre><br></div>

<p>然后运行，当然没问题。</p>
<p>但是这里有一个可以优化的地方，注意代码第7行，每次调用getView方法都会设置Button的OnClickListener，会生成很多不必要的OnClickListener对象。</p>
<p>所以，我们可以想到，在生成convertView时，同时设置Button的OnClickListener，convertView是被不断地复用的，这样的OnClickListener也就可以被不断地服用，也就是说在第3行和第4行之间进行这一步。这样，代码演化到如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> View getView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> positon, View convertView, ViewGroup parent){<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> convertView){<br></span><span style="color: #008080;"> 3</span>         convertView = LayoutInflater.from(context).inflate(R.layout.item, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 4</span>         Button button =<span style="color: #000000;"> ABViewUtil.obtainView(convertView, R.id.item_btn);<br></span><span style="color: #008080;"> 5</span>         button.setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener(){<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 7</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v){<br></span><span style="color: #008080;"> 8</span>                 Toast.makeText(context, “position: “ +<span style="color: #000000;"> position, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">12</span> }</pre><br></div>

<p>这个代码看上去没什么问题，但是问题就在onClick回调的的第8行中使用的position的时候，因为这里使用的是匿名内部类（这个匿名内部类实现了View.OnClickListener这个接口），所以如果需要在onClick中使用position这个变量的话，需要把position声明为final。一旦声明了final，等到编译之后，这个position就会被作为这个匿名内部类中的一个private的成员变量。这样，ListView往下滚动，下面需要显示的item会重用上面不显示的convertView，convertView中的Button设置的OnClickListener实现类的对象，回调onClick时，使用的position其实是该OnClickListener实现类的成员变量position（这个position的值只是在构造的时候被初始化了而已！）。所以，这个ListView刚加载完数据后，还未滚动时，点击屏幕上的item都是正常的，但是如果一旦滚动，有view被重用了，这个时候，position的值就错乱了，所以在onClick中通过position获取到的item的数据当然也是错乱的了。</p>
<p>所以，要解决这个问题，就需要让onClick方法回调的时候得到的position是个正确的值，我们可以选择使用把当前显示的convertView对应的position值保存在convertView中，然后把这个convertView对象传入OnClickListener中保存，所以代码演化到如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> View getView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> positon, View convertView, ViewGroup parent){<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> convertView){<br></span><span style="color: #008080;"> 3</span>         convertView = LayoutInflater.from(context).inflate(R.layout.item, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 4</span>         Button button =<span style="color: #000000;"> ABViewUtil.obtainView(convertView, R.id.item_btn);<br></span><span style="color: #008080;"> 5</span>         button.setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> OnConvertViewClickListener(convertView, R.id.ab<strong>id_adapter_item_position){<br></strong></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">                @Override<br></span><span style="color: #008080;"> 7</span>                 <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onClickCallBack(View registedView, <span style="color: #0000ff;">int</span><span style="color: #000000;">… positionIds){<br></span><span style="color: #008080;"> 8</span>                     Toast.makeText(context, “position: “ + positionIds[0<span style="color: #000000;">], Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    convertView.setTag(R.id.abid_adapter_item_position, position);<br></span><span style="color: #008080;">13</span> }</pre><br></div>

<p>就像上面第5行这样，Button绑定的是<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/adapter/listener/OnConvertViewClickListener.java" target="_blank" rel="noopener">OnConvertViewClickListener</a></strong>，它是OnClickListener的一个实现类可以保存convertView到Listener中，到时候回调onClick方法的时候可以从保存的convertView中获取到当前显示的item的position（这个position是以tag的方式保存在convertView中的）。</p>
<p>当然，还需要做第12行这一步，它的目的是把当前显示的position保存到convertView中，提供给<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/adapter/listener/OnConvertViewClickListener.java" target="_blank" rel="noopener">OnConvertViewClickListener</a></strong>获取当前的position。</p>
<p>这样就ok了，可以在onClickCallBack()方法中进行点击事件的处理了，每个button永远只有一个onClickListener。</p>
<p><span style="color: #008000;"><strong>注：使用<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/adapter/listener/OnConvertViewClickListener.java" target="_blank" rel="noopener"><span style="color: #008000;">OnConvertViewClickListener</span></a>可以依赖<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">AndroidBucket</a>（<a href="https://github.com/wangjiegulu/AndroidBucket）项目" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket）项目</a></strong></span></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ListView </tag>
            
            <tag> best practices </tag>
            
            <tag> adapter </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]ListView的Adapter.getView()方法中延迟加载图片的优化]]></title>
      <url>/2014/12/03/Android-ListView%E7%9A%84Adapter-getView-%E6%96%B9%E6%B3%95%E4%B8%AD%E5%BB%B6%E8%BF%9F%E5%8A%A0%E8%BD%BD%E5%9B%BE%E7%89%87%E7%9A%84%E4%BC%98%E5%8C%96/</url>
      <content type="html"><![CDATA[<p>举个例子吧，以好友列表为例</p>
<p>ListView中每个Item表示一个好友，每个好友中都有一个头像，需要从服务端加载到本地，然后显示在item中。</p>
<p>显然，启动加载图片的过程应该是在getView()方法中触发，启动一个线程，然后下载头像图片。这里使用我写的一个开源框架<strong><a href="https://github.com/wangjiegulu/ImageLoaderSample" target="_blank" rel="noopener">ImageLoaderSample</a></strong>（<a href="https://github.com/wangjiegulu/ImageLoaderSample" target="_blank" rel="noopener">https://github.com/wangjiegulu/ImageLoaderSample</a>）来加载图片，并实现内存缓存和本地缓存。</p>
<p>额－－这里不再介绍ImageLoaderSample的用法了，给个传送门：<a href="http://www.cnblogs.com/tiantianbyconan/p/3574131.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/3574131.html</a></p>
<p>&nbsp;</p>
<p>再来看看getView()方法的调用时机：</p>
<p>1. Adapter调用NotifyDataChanged的时候</p>
<p>2. ListView滚动时，也就是convertView不断复用的时候。</p>
<p>也就是说，每当ListView滚动时，getView()方法不断被调用，图片下载的过程不断地执行（当然，<strong><a href="https://github.com/wangjiegulu/ImageLoaderSample" target="_blank" rel="noopener">ImageLoaderSample</a></strong>中会有缓存，但是内存缓存时有限的，如果内存缓存中找不到要显示的图片，那就需要到文件缓存中查找，需要进行io读写，这个也是相对比较耗时的），显然，这里面还有优化的余地。</p>
<p>怎么去优化这里？只要让ListView滚动的时候图片显示的时候不要去进行io读写就好了，具体逻辑如下：</p>
<p>－如果调用GetView方法时，ListView处于停止状态，则先去内存中查找头像图片；如果内存图片存在，则显示内存中保存好的图片；如果内存图片不存在，则继续到文件缓存中找，如果文件缓存图片存在，则显示文件缓存中的图片；如果文件缓存图片不存在，则根据url去网络下载这张图片，然后显示；</p>
<p>－如果调用getView方法时，ListView处于滚动状态，则去内存中查找头像的图片；如果内存图片存在，则显示内存中保存好的图片；如果内存图片不存在，则显示一张默认的图片（省去了从文件缓存中找图片和网络中去请求图片的步骤）。</p>
<p>&nbsp;</p>
<p>这样的话，我们就必须要改写BaseAdapter，让它能够监测ListView的滚动状态，并在Adapter中可以获取到当前ListView的滚动状态。所以改造BaseAdapter，<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/adapter/ABaseAdapter.java" target="_blank" rel="noopener">ABaseAdapter</a></strong>（<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/adapter/ABaseAdapter.java" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/adapter/ABaseAdapter.java</a>）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.androidbucket.adapter;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span> android.widget.<em><span style="color: #000000;">;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.adapter.listener.OnAdapterScrollListener;<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span> <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 7</span> <span style="color: #008000;"> </span></em> Author: wangjie<br><span style="color: #008080;"> 8</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 9</span> <span style="color: #008000;">  Date: 12/3/14.<br></span><span style="color: #008080;">10</span>  <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">class</span> ABaseAdapter <span style="color: #0000ff;">extends</span> BaseAdapter <span style="color: #0000ff;">implements</span><span style="color: #000000;"> AbsListView.OnScrollListener {<br></span><span style="color: #008080;">12</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> OnAdapterScrollListener onAdapterScrollListener;<br></span><span style="color: #008080;">13</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">14</span> <span style="color: #008000;">      当前listview是否属于滚动状态<br></span><span style="color: #008080;">15</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">16</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isScrolling;<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isScrolling() {<br></span><span style="color: #008080;">19</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> isScrolling;<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnAdapterScrollListener(OnAdapterScrollListener onAdapterScrollListener) {<br></span><span style="color: #008080;">23</span>         <span style="color: #0000ff;">this</span>.onAdapterScrollListener =<span style="color: #000000;"> onAdapterScrollListener;<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">25</span><br><span style="color: #008080;">26</span>     <span style="color: #0000ff;">protected</span><span style="color: #000000;"> ABaseAdapter(AbsListView listView) {<br></span><span style="color: #008080;">27</span>         listView.setOnScrollListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">31</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onScroll(AbsListView view, <span style="color: #0000ff;">int</span> firstVisibleItem, <span style="color: #0000ff;">int</span> visibleItemCount, <span style="color: #0000ff;">int</span><span style="color: #000000;"> totalItemCount) {<br></span><span style="color: #008080;">32</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> onAdapterScrollListener) {<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">            onAdapterScrollListener.onScroll(view, firstVisibleItem, visibleItemCount, totalItemCount);<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">36</span><br><span style="color: #008080;">37</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">38</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onScrollStateChanged(AbsListView view, <span style="color: #0000ff;">int</span><span style="color: #000000;"> scrollState) {<br></span><span style="color: #008080;">39</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> onAdapterScrollListener) {<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">            onAdapterScrollListener.onScrollStateChanged(view, scrollState);<br></span><span style="color: #008080;">41</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">42</span><br><span style="color: #008080;">43</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置是否滚动的状态</span><br><span style="color: #008080;">44</span>         <span style="color: #0000ff;">if</span> (scrollState == AbsListView.OnScrollListener.SCROLL_STATE_IDLE) { <span style="color: #008000;">//</span><span style="color: #008000;"> 不滚动状态</span><br><span style="color: #008080;">45</span>             isScrolling = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">46</span>             <span style="color: #0000ff;">this</span><span style="color: #000000;">.notifyDataSetChanged();<br></span><span style="color: #008080;">47</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">48</span>             isScrolling = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">49</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">51</span> }</pre><br></div>

<p>如上述代码所示，该Adapter实现了AbsListView.OnScrollListener，并在构造方法中给ListView绑定了OnScrollListener，在实现的onScrollStateChanged方法中获取到当前滚动状态，并且保存这个状态isScrolling，并暴露isScrolling()方法给外面。</p>
<p>OnAdapterScrollListener这个接口是继承了AbsListView.OnScrollListener，因为这里在Adapter中一景设置了OnScrollListener了，所以如果在外面设置了新的OnScrollListener的话，就会失效了，所以必须提供另外一个setOnAdapterScrollListener，然后再传入一个OnScrollListener，然后在每个方法中进行回调就好了，因为考虑到以后可能会扩展其他的接口方法，所以这里新写了一个接口（为了以后扩展时原来的代码不会被影响，推荐使用OnAdapterScrollSampleListener这个实现类来代替OnAdapterScrollListener这个接口，OnAdapterScrollSampleListener这个类只是对OnAdapterScrollListener的所有方法进行了空实现）。</p>
<p>&nbsp;</p>
<p>然后我们编写一个MyAdapter继承ABaseAdapter，然后，在getView()方法中，需要显示头像的时候调用如下方法：</p>
<p>// 如果在滚动（从内存中查找，找不到也不进行网络请求）</p>
<div class="cnblogs_code"><br><pre>ImageLoader.getInstances().displayImage(headUrl, headIv, <span style="color: #0000ff;">null</span>, R.drawable.default_head, isScrolling());</pre><br></div>

<p>看到木有？</p>
<p>1. displayImage()方法发生了改变，多了最后一个参数isOnlyMemory这个参数，表示是否只是在内存缓存中找这张图片，如果没有就不再继续找下去了（displayImage原来的方法我还留着，所以不会影响之前的代码）。</p>
<p>2. 调用了isScrolling()方法，作为参数isOnlyMemory的值，表示，如果正在滚动的话，就只在缓存中找这张图片。</p>
<p>这样，运行原来的代码试试吧，是不是效率快了一些？</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ListView </tag>
            
            <tag> optimize </tag>
            
            <tag> best practices </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[直接拿来用！十大Material Design开源项目]]></title>
      <url>/2014/11/23/%E7%9B%B4%E6%8E%A5%E6%8B%BF%E6%9D%A5%E7%94%A8%EF%BC%81%E5%8D%81%E5%A4%A7Material-Design%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/</url>
      <content type="html"><![CDATA[<p>来自：<a href="http://www.csdn.net/article/2014-11-21/2822753-material-design-libs/1" target="_blank" rel="noopener">http://www.csdn.net/article/2014-11-21/2822753-material-design-libs/1</a></p>
<p>介于拟物和扁平之间的Material Design自面世以来，便引起了很多人的关注与思考，就此产生的讨论也不绝于耳。本文详细介绍了在Android开发者圈子里颇受青睐的十个Material Design开源项目，从示例、FAB、菜单、动画、Ripple到Dialog，看被称为&ldquo;Google第一次在设计语言和规范上超越了Apple&rdquo;的Material Design是如何逐渐成为App的一种全新设计标准。</p>
<p><strong>1.&nbsp;<a href="https://github.com/navasmdc/MaterialDesignLibrary" target="_blank" rel="noopener">MaterialDesignLibrary</a></strong></p>
<p>在众多新晋库中，MaterialDesignLibrary可以说是颇受开发者瞩目的一个控件效果库，能够让开发者在Android 2.2系统上使用Android 5.0才支持的控件效果，比如扁平、矩形、浮动按钮，复选框以及各式各样的进度指示器等。</p>
<p><img src="http://cms.csdnimg.cn/article/201411/21/546e9b100445a_middle.jpg" alt=""></p>
<p>除上述之外，MaterialDesignLibrary还拥有SnackBar、Dialog、Color selector组件，可非常便捷地对应用界面进行设置。</p>
<p>进度指示器样式效果设置：&nbsp;</p>
<div class="dp-highlighter bg_xml"><br><div class="bar"><br><div class="tools"><br><div class="cnblogs_code"><br><pre><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">com.gc.materialdesign.views.ProgressBarCircularIndetermininate<br>                </span><span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/progressBarCircularIndetermininate”</span><span style="color: #ff0000;"><br>                android:layout_width</span><span style="color: #0000ff;">=”32dp”</span><span style="color: #ff0000;"><br>                android:layout_height</span><span style="color: #0000ff;">=”32dp”</span><span style="color: #ff0000;"><br>                android:background</span><span style="color: #0000ff;">=”#1E88E5”</span> <span style="color: #0000ff;">/&gt;</span></pre><br></div>

<p>&nbsp;</p>
<p></p></div><br></div><br></div><p></p>
<p>Dialog：</p>
<div class="cnblogs_code"><br><pre>Dialog dialog = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Dialog(Context context,String title, String message);<br>dialog.show();</span></pre><br></div>

<p>&nbsp;</p>
<p><strong>2.&nbsp;<a href="https://github.com/traex/RippleEffect" target="_blank" rel="noopener">RippleEffect</a></strong></p>
<p>由来自法兰西的Robin Chutaux开发的RippleEffect基于MIT许可协议开源，能够在Android API 9+上实现Material Design，为开发者提供了一种极为简易的方式来创建带有可扩展视图的header视图，并且允许最大程度上的自定制。</p>
<p><img src="http://cms.csdnimg.cn/article/201411/21/546ea09e7c452_middle.jpg" alt=""></p>
<p>用法（在XML文件中声明一个RippleView）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">com.andexert.library.RippleView<br>  </span><span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/more”</span><span style="color: #ff0000;"><br>  android:layout_width</span><span style="color: #0000ff;">=”?android:actionBarSize”</span><span style="color: #ff0000;"><br>  android:layout_height</span><span style="color: #0000ff;">=”?android:actionBarSize”</span><span style="color: #ff0000;"><br>  android:layout_toLeftOf</span><span style="color: #0000ff;">=”@+id/more2”</span><span style="color: #ff0000;"><br>  android:layout_margin</span><span style="color: #0000ff;">=”5dp”</span><span style="color: #ff0000;"><br>  ripple:rv_centered</span><span style="color: #0000ff;">=”true”</span><span style="color: #0000ff;">&gt;</span><br><br>  <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">ImageView<br>    </span><span style="color: #ff0000;">android:layout_width</span><span style="color: #0000ff;">=”?android:actionBarSize”</span><span style="color: #ff0000;"><br>    android:layout_height</span><span style="color: #0000ff;">=”?android:actionBarSize”</span><span style="color: #ff0000;"><br>    android:src</span><span style="color: #0000ff;">=”@android:drawable/ic_menu_edit”</span><span style="color: #ff0000;"><br>    android:layout_centerInParent</span><span style="color: #0000ff;">=”true”</span><span style="color: #ff0000;"><br>    android:padding</span><span style="color: #0000ff;">=”10dp”</span><span style="color: #ff0000;"><br>    android:background</span><span style="color: #0000ff;">=”@android:color/holo_blue_dark”</span><span style="color: #0000ff;">/&gt;</span><br><br><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">com.andexert.library.RippleView</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>&nbsp;</p>
<p><strong>3.&nbsp;<a href="https://github.com/rengwuxian/MaterialEditText" target="_blank" rel="noopener">MaterialEditText</a></strong></p>
<p>随着Material Design的到来，AppCompat v21也为开发者提供了Material Design的控件外观支持，其中就包括EditText，但却并不好用，没有设置颜色的API，也没有任何Google Material Design Spec中提到的特性。于是，来自国内的开发者&ldquo;扔物线&rdquo;开发了MaterialEditText库，直接继承EditText，无需修改Java文件即能实现自定义控件颜色。</p>
<p><img src="http://cms.csdnimg.cn/article/201411/21/546ea1168a50c_middle.jpg" alt=""></p>
<p>自定义Base Color：</p>
<div class="cnblogs_code"><br><pre>app:baseColor=”#0056d3”</pre><br></div>

<p><img src="http://cms.csdnimg.cn/article/201411/21/546ea26d93a02_middle.jpg" alt=""></p>
<p>&nbsp;</p>
<p>自定义Error Color：</p>
<div class="cnblogs_code"><br><pre><span style="color: #000000;">app:maxCharacters=”10”<br>app:errorColor=”#ddaa00”</span></pre><br></div>

<p><span style="line-height: 1.5;">&nbsp;</span></p>
<p><img src="http://cms.csdnimg.cn/article/201411/21/546ea27b0fc23_middle.jpg" alt=""></p>
<p><strong>4.&nbsp;<a href="https://github.com/mikepenz/Android-LollipopShowcase" target="_blank" rel="noopener">Android-LollipopShowcase</a></strong></p>
<p>Android-LollipopShowcase是由来自奥地利的移动、后端及Web开发者Mike Penz所开发的演示应用，集中演示了新Material Design中所有的UI效果，以及Android Lollipop中其他非常酷炫的特性元素，比如Toolbar、RecyclerView、ActionBarDrawerToggle、Floating Action Button（FAB）、Android Compat Theme等。</p>
<p><img src="http://cms.csdnimg.cn/article/201411/21/546ed8a896530_middle.jpg" alt=""></p>
<p><strong>5.&nbsp;<a href="https://github.com/dexafree/MaterialList" target="_blank" rel="noopener">MaterialList</a></strong></p>
<p>MaterialList是一个能够帮助所有Android开发者获取谷歌UI设计规范中新增的CardView（卡片视图）的开源库，支持Android 2.3+系统。作为ListView的扩展，MaterialList可以接收、存储卡片列表，并根据它们的Android风格和设计模式进行展示。此外，开发者还可以创建专属于自己的卡片布局，并轻松将其添加到CardList中。</p>
<p><img src="http://cms.csdnimg.cn/article/201411/21/546ede74f3033_middle.jpg" alt=""></p>
<p>使用过程代码，在布局中声明MaterialListView：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RelativeLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><span style="color: #ff0000;"><br>    android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br>    android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br>    android:paddingLeft</span><span style="color: #0000ff;">=”@dimen/activity_horizontal_margin”</span><span style="color: #ff0000;"><br>    android:paddingRight</span><span style="color: #0000ff;">=”@dimen/activity_horizontal_margin”</span><span style="color: #ff0000;"><br>    android:paddingTop</span><span style="color: #0000ff;">=”@dimen/activity_vertical_margin”</span><span style="color: #ff0000;"><br>    android:paddingBottom</span><span style="color: #0000ff;">=”@dimen/activity_vertical_margin”</span><span style="color: #0000ff;">&gt;</span><br><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">com.dexafree.materiallistviewexample.view.MaterialListView<br>        </span><span style="color: #ff0000;">android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br>        android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br>        android:id</span><span style="color: #0000ff;">=”@+id/material_listview”</span><span style="color: #0000ff;">/&gt;</span><br><br><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">RelativeLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>&nbsp;</p>
<p><strong>6.&nbsp;<a href="https://github.com/futuresimple/android-floating-action-button" target="_blank" rel="noopener">android-floating-action-button</a></strong></p>
<p>Floating Action Button（FAB）是众多专家大牛针对Material Design讨论比较细化的一个点，通过圆形元素与分割线、卡片、各种Bar的直线形成鲜明对比，并使用色彩设定中鲜艳的辅色，带来更具突破性的视觉效果。也正因如此，在Github上，有着许多与FAB相关的开源项目，基于Material Design规范的开源Android浮动Action Button控件android-floating-action-button便是其中之一。</p>
<p><img src="http://cms.csdnimg.cn/article/201411/21/546efe7e3a855_middle.jpg?_=33895" alt="">&nbsp;<img src="http://cms.csdnimg.cn/article/201411/21/546efe84a5da6.jpg" alt=""></p>
<p>其主要特性如下：</p>
<p>&nbsp;</p>
<ul>
<li>支持常规56dp和最小40dp的按钮；</li>
<li>支持自定义正常、Press状态以及可拖拽图标的按钮背景颜色；</li>
<li>AddFloatingActionButton类能够让开发者非常方便地直接在代码中写入加号图标；</li>
<li>FloatingActionsMenu类支持展开/折叠显示动作。</li>
</ul>
<p>&nbsp;</p>
<p><strong>7.&nbsp;<a href="https://github.com/markushi/android-ui" target="_blank" rel="noopener">android-ui</a></strong></p>
<p>android-ui是Android UI组件类库，支持Android API 14+，包含了ActionView、RevealColorView等UI组件。其中，ActionView可使Action动作显示动画效果，而RevealColorView则带来了Android 5.0中的圆形显示/隐藏动画体验。</p>
<p><img src="http://cms.csdnimg.cn/article/201411/21/546f0a7681186.jpg" alt=""></p>
<p><strong>8.&nbsp;<a href="https://github.com/balysv/material-menu" target="_blank" rel="noopener">Material Menu</a></strong></p>
<p>Material Menu为开发者带来了非常酷炫的Android菜单、返回、删除以及检查按钮变形，完全控制动画，并为开发者提供了两种MaterialMenuDrawable包装。</p>
<p><img src="http://cms.csdnimg.cn/article/201411/21/546f0b8672e44.jpg" alt=""></p>
<p>自定义颜色等操作：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">//</span><span style="color: #008000;"> change color</span><br>MaterialMenu.setColor(<span style="color: #0000ff;">int</span><span style="color: #000000;"> color)<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;"> change transformation animation duration</span><br>MaterialMenu.setTransformationDuration(<span style="color: #0000ff;">int</span><span style="color: #000000;"> duration)<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;"> change pressed animation duration</span><br>MaterialMenu.setPressedDuration(<span style="color: #0000ff;">int</span><span style="color: #000000;"> duration)<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;"> change transformation interpolator</span><br><span style="color: #000000;">MaterialMenu.setInterpolator(Interpolator interpolator)<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;"> set RTL layout support</span><br>MaterialMenu.setRTLEnabled(<span style="color: #0000ff;">boolean</span> enabled)</pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p><strong>9.&nbsp;<a href="https://github.com/ksoichiro/Android-ObservableScrollView" target="_blank" rel="noopener">Android-ObservableScrollView</a></strong></p>
<p>Android-ObservableScrollView是一款用于在滚动视图中观测滚动事件的Android库。它能够轻而易举地与Android 5.0 Lollipop引进的工具栏（Toolbar）进行交互，还可以帮助开发者实现拥有Material Design应用视觉体验的界面外观，支持ListView、ScrollView、WebView、RecyclerView、GridView组件。</p>
<p><img src="http://cms.csdnimg.cn/article/201411/21/546ef6d6abfcd.jpg" alt=""><img src="http://cms.csdnimg.cn/article/201411/21/546ef6e476b55.jpg" alt=""><img src="http://cms.csdnimg.cn/article/201411/21/546ef6eea211e.jpg" alt=""></p>
<p>交互代码回调：</p>
<div class="cnblogs_code"><br><pre><span style="color: #000000;">@Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onUpOrCancelMotionEvent(ScrollState scrollState) {<br>        ActionBar ab </span>=<span style="color: #000000;"> getSupportActionBar();<br>        </span><span style="color: #0000ff;">if</span> (scrollState ==<span style="color: #000000;"> ScrollState.UP) {<br>            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (ab.isShowing()) {<br>                ab.hide();<br>            }<br>        } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (scrollState ==<span style="color: #000000;"> ScrollState.DOWN) {<br>            </span><span style="color: #0000ff;">if</span> (!<span style="color: #000000;">ab.isShowing()) {<br>                ab.show();<br>            }<br>        }<br>    }</span></pre><br></div>

<p>&nbsp;</p>
<p><strong>10.&nbsp;<a href="https://github.com/google/material-design-icons" target="_blank" rel="noopener">Material Design Icons</a></strong></p>
<p>最后，再来介绍一下Google Material Design规范的官方开源图标集Material Design Icons。良心Google开源了包括Material Design系统图标包在内的750个字形，涵盖动作、音视频、通信、内容、编辑器、文件、硬件、图像、地图、导航、通知、社交等各个方面，适用于Web、Android和iOS应用开发，绝对是开发者及设计师必备的资源。</p>
<p><img src="http://cms.csdnimg.cn/article/201411/21/546ef31fa0f7e_middle.jpg" alt=""></p>
<p>图标格式主要包括：&nbsp;</p>
<ul>
<li>SVG格式，24px和48px；</li>
<li>SVG和CSS Sprites；</li>
<li>适用于Web平台的1x、2x PNG格式图标；</li>
<li>适用于iOS的1x、2x、3x PNG图标；</li>
<li>所有图标的Hi-dpi版本（hdpi、mdpi、xhdpi、xxhdpi、xxxhdpi）。</li>
</ul>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> view </tag>
            
            <tag> Material Design </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]使用AdapterTypeRender对不同类型的item数据到UI的渲染]]></title>
      <url>/2014/09/25/Android-%E4%BD%BF%E7%94%A8AdapterTypeRender%E5%AF%B9%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84item%E6%95%B0%E6%8D%AE%E5%88%B0UI%E7%9A%84%E6%B8%B2%E6%9F%93/</url>
      <content type="html"><![CDATA[<p>本文讲的工具均放在<strong><a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">AndroidBucket</a></strong>开源项目中，欢迎大家star/fork，地址：<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket</a></p>
<p>&nbsp;</p>
<p>主要实现聊天功能中的发送不同类型的信息，比如纯文本、图片、语音、图文混排多媒体的数据等（具体效果看微信）。</p>
<p>这里使用AdapterTypeRender在BaseTypeAdapter（这个之后会讲到）中实现。</p>
<p>这里主要的实现方式是在ChatAdapter（继承BaseTypeAdapter）中根据每个position的item的type，来使用不同的AdapterTypeRender渲染器进行渲染。渲染的过程当然是在getView方法中进行。</p>
<p><strong>1.&nbsp;AdapterTypeRender</strong></p>
<p>先来看看AdapterTypeRender这个接口。它有3个方法：getConvertView()、fitEvents()、fitDatas()三个方法。</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.androidbucket.adapter;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br><br></span><span style="color: #008000;">/<strong></strong></span><span style="color: #008000;"><br> <em> 用于对不同类型item数据到UI的渲染
 </em> Author: wangjie<br> <em> Email: tiantian.china.2@gmail.com
 </em> Date: 9/14/14.<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> AdapterTypeRender {<br><br>    </span><span style="color: #008000;">/</span><span style="color: #008000;"><br>     <em> 返回一个item的convertView，也就是BaseAdapter中getView方法中返回的convertView
     </em> </span><span style="color: #808080;">@return</span><br>     <span style="color: #008000;"><em>/</em></span><span style="color: #000000;"><br>    View getConvertView();<br><br>    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
      填充item中各个控件的事件，比如按钮点击事件等<br>     </span><span style="color: #008000;"><em>/</em></span><br>    <span style="color: #0000ff;">void</span><span style="color: #000000;"> fitEvents();<br><br>    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
      对指定position的item进行数据的适配<br>     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> position<br>     </span><span style="color: #008000;">/</span><br>    <span style="color: #0000ff;">void</span> fitDatas(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position);<br><br>}</span></pre><br></div>

<p>－getconvertView()方法用于返回给BaseTypeAdapter一个convertView，一个AdapterTypeRender实现类对应一个convertView实例，该AdapterTypeRender可以被重用，所以convertView也可以被重用了。</p>
<p>－fitEvents()方法用于给当前的item中的各个控件注册事件，比如点击事件、touch事件等（具体的注册事件后面回讲到），因为这个方法是在getView中只有convertView为null时才会调用，所以只会调用一次，所以在这里添加事件是比较好的。</p>
<p>－fitDatas()方法用于把数据适配到item的各个view中进行显示。这个方法只要getView得到调用，就会被调用。</p>
<p><strong>2. BaseTypeAdapter</strong></p>
<p>这是一个抽象类，是继承于BaseAdapter的，重写了里面的getView方法。会自动根据指定position的item获取对应的type，然后通过type实例化一个AdapterTypeRender的实现，然后又使用了BaseAdapter中自带的convertView的重用机制进行对view的重用，同样也是对AdapterTypeRender的重用。</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.androidbucket.adapter.typeadapter;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.annotation.TargetApi;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Build;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.ViewGroup;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.BaseAdapter;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.R;<br><br></span><span style="color: #008000;">/<strong></strong></span><span style="color: #008000;"><br> <em> Author: wangjie
 </em> Email: tiantian.china.2@gmail.com<br> <em> Date: 9/25/14.<br> </em></span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">class</span> BaseTypeAdapter <span style="color: #0000ff;">extends</span><span style="color: #000000;"> BaseAdapter{<br>    @TargetApi(Build.VERSION_CODES.DONUT)<br>    @Override<br>    </span><span style="color: #0000ff;">public</span> View getView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position, View convertView, ViewGroup parent) {<br>        AdapterTypeRender typeRender;<br>        </span><span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> convertView){<br>            typeRender </span>=<span style="color: #000000;"> getAdapterTypeRender(position);<br>            convertView </span>=<span style="color: #000000;"> typeRender.getConvertView();<br>            convertView.setTag(R.id.ab<strong>id_adapter_item_type_render, typeRender);<br>            typeRender.fitEvents();<br>        }</strong></span><span style="color: #0000ff;">else</span><span style="color: #000000;">{<br>            typeRender </span>=<span style="color: #000000;"> (AdapterTypeRender) convertView.getTag(R.id.abid_adapter_item_type_render);<br>        }<br>        convertView.setTag(R.id.ab__id_adapter_item_position, position);<br><br>        </span><span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> typeRender){<br>            typeRender.fitDatas(position);<br>        }<br><br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> convertView;<br>    }<br><br>    </span><span style="color: #008000;">/</span><span style="color: #008000;"><br>     <em> 根据指定position的item获取对应的type，然后通过type实例化一个AdapterTypeRender的实现
     </em> </span><span style="color: #808080;">@param</span><span style="color: #008000;"> position<br>     <em> </em></span><span style="color: #808080;">@return</span><br>     <span style="color: #008000;">/</span><br>    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> AdapterTypeRender getAdapterTypeRender(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position);<br>}</span></pre><br></div>

<p>为了实现AdapterTypeRender的重用，一旦生成了一个AdapterTypeRender实现类的实例，则使用setTag的方法进行对convertView和AdapterTypeRender的绑定（R.id.ab__id_adapter_item_type_render这个id是在<strong><a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">AndroidBucket</a></strong>中定义了的），这个可以参考以前的ViewHolder的写法。</p>
<p>为了实现在同一个item中的事件（这里以view的点击事件为例）响应都共用一个观察者的实例，需要在convertView中保存对应的position。这是因为同一个convertView因为使用了view的重用，是被非显示页面的很多个item所共用的。所以只需要，在当前显示的一屏中，每个convertView对应的postion即可，毕竟这些事件触发只有在当前显示的一屏中才会被触发。保存postion的方式依然使用了setTag的方式（R.id.ab__id_adapter_item_position这个id是在<strong><a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">AndroidBucket</a></strong>中定义了的），注意：子类一般不需要重写getView方法了，其他的数据适配UI渲染都交给Render吧！</p>
<p>除了重写了getView方法之外，还定义了一个抽象方法：getAdapterTypeRender。这个方法需要子类去实现，需要告诉BaseTypeAdapter，指定position的item，它的type对应的AdapterTypeRender的实例是什么。</p>
<p><strong>3. 自定义AdapterTypeRender的实现</strong></p>
<p>接下来，就尝试自己实现几个不同布局的Render吧。这里假设需要实现两种：文本布局（TypeTextRender）、图片布局（TypeImageRender）。</p>
<p>a) TypeTextRender的实现：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.activities.typerendertest.adapter;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.LayoutInflater;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.ImageButton;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.ImageView;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.ProgressBar;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.TextView;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.adapter.typeadapter.AdapterTypeRender;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.adapter.listener.OnConvertViewClickListener;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.thread.ThreadPool;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.utils.ABTimeUtil;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.utils.ABViewUtil;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.imageloadersample.imageloader.ImageLoader;<br><br></span><span style="color: #008000;">/<strong></strong></span><span style="color: #008000;"><br> <em> Author: wangjie
 </em> Email: tiantian.china.2@gmail.com<br> <em> Date: 9/14/14.<br> </em></span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TypeTextRender <span style="color: #0000ff;">implements</span><span style="color: #000000;"> AdapterTypeRender {<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> ChatAdapter adapter;<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> View contentView;<br><br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> TypeTextRender(Context context, ChatAdapter adapter) {<br>        </span><span style="color: #0000ff;">this</span>.context =<span style="color: #000000;"> context;<br>        </span><span style="color: #0000ff;">this</span>.adapter =<span style="color: #000000;"> adapter;<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 解析文本类型的布局</span><br>        contentView = LayoutInflater.from(context).inflate(R.layout.item_type_text, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> View getConvertView() {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 返回文本类型的布局</span><br>        <span style="color: #0000ff;">return</span><span style="color: #000000;"> contentView;<br>    }<br><br>    </span><span style="color: #008000;">/</span><span style="color: #008000;"><br>     <em> 这个方法同一个convertView只会被调用一次，所以可以放心地在这里执行事件地绑定，不用担心生成过多的OnClickListener等<br>     </em></span><span style="color: #008000;">/</span><span style="color: #000000;"><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> fitEvents() {<br>        </span><span style="color: #008000;">/<strong></strong></span><span style="color: #008000;"><br>         <em> 生成一个在convertView中使用的clickListener<br>         </em></span><span style="color: #008000;">/</span><span style="color: #000000;"><br>        OnConvertViewClickListener onConvertViewClickListener </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> OnConvertViewClickListener(contentView, R.id.ab__id_adapter_item_position) {<br>            @Override<br>            </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onClickCallBack(View registedView, <span style="color: #0000ff;">int</span><span style="color: #000000;">… positionIds) {<br>                ChatAdapter.OnChatItemListener onChatItemListener </span>=<span style="color: #000000;"> adapter.getOnChatItemListener();<br>                </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (registedView.getId()) {<br>                    </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.item_type_text_view:<br>                        </span><span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> != onChatItemListener &amp;&amp; <span style="color: #0000ff;">null</span> != positionIds &amp;&amp; positionIds.length &gt; 0<span style="color: #000000;">) {<br>                            onChatItemListener.onItemClicked(positionIds[</span>0<span style="color: #000000;">]);<br>                        }<br>                        </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br><br>                    </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.item_type_text_head_iv:<br>                        </span><span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> != onChatItemListener &amp;&amp; <span style="color: #0000ff;">null</span> != positionIds &amp;&amp; positionIds.length &gt; 0<span style="color: #000000;">) {<br>                            onChatItemListener.onHeadClicked(positionIds[</span>0<span style="color: #000000;">]);<br>                        }<br>                        </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br><br>                }<br><br>            }<br>        };<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 通过ABViewUtil从contentView中获取对应id的控件，然后设置OnClickListener</span><br><span style="color: #000000;">        ABViewUtil.obtainView(contentView, R.id.item_type_text_view)<br>                .setOnClickListener(onConvertViewClickListener);<br>        ABViewUtil.obtainView(contentView, R.id.item_type_text_head_iv)<br>                .setOnClickListener(onConvertViewClickListener);<br><br>    }<br><br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> ImageView headIv;<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> View rootView;<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> TextView contentTv;<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> fitDatas(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position) {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 通过ABViewUtil从contentView中获取对应id的控件，然后设置OnClickListener</span><br>        headIv =<span style="color: #000000;"> ABViewUtil.obtainView(contentView, R.id.item_type_text_head_iv);<br>        contentTv </span>=<span style="color: #000000;"> ABViewUtil.obtainView(contentView, R.id.item_type_text_content_tv);<br>        </span><span style="color: #008000;">/</span><span style="color: #008000;"><br>         <em> 在这里适配数据到ui<br>         </em></span><span style="color: #008000;">/</span><span style="color: #000000;"><br>        Message message </span>=<span style="color: #000000;"> adapter.getItem(position);<br>        contentTv.setText(message.getContent());<br>        ImageLoader.getInstances().displayImage(message.getHeadUrl(), headIv, </span>100, <span style="color: #0000ff;">null</span><span style="color: #000000;">, R.drawable.default_head);<br><br>    }<br><br>}</span></pre><br></div>

<p>如上代码，该TypeTextRender实现了AdapterTypeRender接口，实现了其中的3个方法。注意：需要在构造方法中解析出convertView，用于提供给BaseTypeAdapter在getView中返回。</p>
<p>然后在fitEvents中注册各种事件，这里只注册了点击事件（一个rootView、一个headIv注册了点击事件）。这里的OnConvertViewClickListener是一个实现了View.OnClickListener的一个抽象类，生成一个OnConvertViewClickListener时需要传入convertView和positions的id，这样由于Render被重用后，convertView也是被重用了，导致onClickListener也是被重用了，这会导致响应点击事件的时候，回调的onClicked方法中无法得知点击的是哪个View，所以，需要把converView和positions的id传入，positions的id可以用来在convertView中绑定postion作为tag。positonsIds是一个可变长的参数，因为可能是一个ExpandableListView，需要groupPosition和childPosition两个positon来确定。回调的onClickCallBack中的参数registedView表示被点击的view，positionIds，被点击的item的positions（这个也是可以在<strong><a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">AndroidBucket</a></strong>中找到，以后有时间会针对这个详细说明）。</p>
<p>&ldquo;ABViewUtil.obtainView…&rdquo;这个方法对viewHolder进行了封装，把convertView中的控件都缓存在了一个SparseArray&lt;View&gt;中（作用跟常用的ViewHolder相同）。</p>
<p>然后在fitDatas方法中就可以进行对数据的适配了，相当于我们以前在BaseAdapter的getView方法中的操作了。</p>
<p>b) TypeImageRender的实现（与TypeTextRender大同小异，不做过多的说明了）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.activities.typerendertest.adapter;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.LayoutInflater;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.ImageButton;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.ImageView;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.ProgressBar;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.TextView;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.adapter.typeadapter.AdapterTypeRender;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.adapter.listener.OnConvertViewClickListener;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.thread.ThreadPool;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.utils.ABTimeUtil;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.utils.ABViewUtil;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.imageloadersample.imageloader.ImageLoader;<br><br></span><span style="color: #008000;">/<strong></strong></span><span style="color: #008000;"><br> <em> Author: wangjie
 </em> Email: tiantian.china.2@gmail.com<br> <em> Date: 9/14/14.<br> </em></span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> ChatTypeImageRender <span style="color: #0000ff;">implements</span><span style="color: #000000;"> AdapterTypeRender {<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> ChatAdapter adapter;<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> View contentView;<br><br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> ChatTypeImageRender(Context context, ChatAdapter adapter) {<br>        </span><span style="color: #0000ff;">this</span>.context =<span style="color: #000000;"> context;<br>        </span><span style="color: #0000ff;">this</span>.adapter =<span style="color: #000000;"> adapter;<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 解析图片类型的布局</span><br>        contentView = LayoutInflater.from(context).inflate(R.layout.item_type_text, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> View getConvertView() {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 返回文本类型的布局</span><br>        <span style="color: #0000ff;">return</span><span style="color: #000000;"> contentView;<br>    }<br><br>    </span><span style="color: #008000;">/</span><span style="color: #008000;"><br>     <em> 这个方法同一个convertView只会被调用一次，所以可以放心地在这里执行事件地绑定，不用担心生成过多的OnClickListener等<br>     </em></span><span style="color: #008000;">/</span><span style="color: #000000;"><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> fitEvents() {<br>        </span><span style="color: #008000;">/<strong></strong></span><span style="color: #008000;"><br>         <em> 生成一个在convertView中使用的clickListener<br>         </em></span><span style="color: #008000;">/</span><span style="color: #000000;"><br>        OnConvertViewClickListener onConvertViewClickListener </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> OnConvertViewClickListener(contentView, R.id.ab__id_adapter_item_position) {<br>            @Override<br>            </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onClickCallBack(View registedView, <span style="color: #0000ff;">int</span><span style="color: #000000;">… positionIds) {<br>                ChatAdapter.OnChatItemListener onChatItemListener </span>=<span style="color: #000000;"> adapter.getOnChatItemListener();<br>                </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (registedView.getId()) {<br>                    </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.item_type_text_view:<br>                        </span><span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> != onChatItemListener &amp;&amp; <span style="color: #0000ff;">null</span> != positionIds &amp;&amp; positionIds.length &gt; 0<span style="color: #000000;">) {<br>                            onChatItemListener.onItemClicked(positionIds[</span>0<span style="color: #000000;">]);<br>                        }<br>                        </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br><br>                    </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.item_type_text_head_iv:<br>                        </span><span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> != onChatItemListener &amp;&amp; <span style="color: #0000ff;">null</span> != positionIds &amp;&amp; positionIds.length &gt; 0<span style="color: #000000;">) {<br>                            onChatItemListener.onHeadClicked(positionIds[</span>0<span style="color: #000000;">]);<br>                        }<br>                        </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br>                    </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.item_type_text_content_iv:<br>                        </span><span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> != onChatItemListener &amp;&amp; <span style="color: #0000ff;">null</span> != positionIds &amp;&amp; positionIds.length &gt; 0<span style="color: #000000;">) {<br>                            onChatItemListener.onImageClicked(positionIds[</span>0<span style="color: #000000;">]);<br>                        }<br>                        </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br><br>                }<br><br>            }<br>        };<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 通过ABViewUtil从contentView中获取对应id的控件，然后设置OnClickListener</span><br><span style="color: #000000;">        ABViewUtil.obtainView(contentView, R.id.item_type_text_view)<br>                .setOnClickListener(onConvertViewClickListener);<br>        ABViewUtil.obtainView(contentView, R.id.item_type_text_head_iv)<br>                .setOnClickListener(onConvertViewClickListener);<br>        ABViewUtil.obtainView(contentView, R.id.item_type_text_content_iv)<br>                .setOnClickListener(onConvertViewClickListener);<br><br>    }<br><br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> ImageView headIv;<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> View rootView;<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> ImageView contentIv;<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> fitDatas(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position) {<br>        </span><span style="color: #008000;">//</span><span style="color: #008000;"> 通过ABViewUtil从contentView中获取对应id的控件，然后设置OnClickListener</span><br>        headIv =<span style="color: #000000;"> ABViewUtil.obtainView(contentView, R.id.item_type_text_head_iv);<br>        contentIv </span>=<span style="color: #000000;"> ABViewUtil.obtainView(contentView, R.id.item_type_text_content_iv);<br>        </span><span style="color: #008000;">/</span><span style="color: #008000;"><br>         <em> 在这里适配数据到ui<br>         </em></span><span style="color: #008000;">/</span><span style="color: #000000;"><br>        Message message </span>=<span style="color: #000000;"> adapter.getItem(position);<br>        ImageLoader.getInstances().displayImage(message.getHeadUrl(), headIv, </span>100, <span style="color: #0000ff;">null</span><span style="color: #000000;">, R.drawable.default_head);<br>        ImageLoader.getInstances().displayImage(message.getContentUrl(), headIv, </span>100, <span style="color: #0000ff;">null</span><span style="color: #000000;">, R.drawable.default_pic);<br><br>    }<br><br>}</span></pre><br></div>

<p><strong>3. BaseTypeAdapter的实现</strong></p>
<p>到这里，我们已经定义好了各种type的Render了，现在需要在Adapter中去使用它，方法之前讲过，只要继承BaseTypeAdapter，然后实现里面的getAdapterTypeRender方法即可：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.activities.typerendertest.adapter;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.adapter.typeadapter.AdapterTypeRender;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.adapter.typeadapter.BaseTypeAdapter;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br><br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  Author: wangjie<br> <em> Email: tiantian.china.2@gmail.com
 </em> Date: 9/14/14.<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MessageAdapter <span style="color: #0000ff;">extends</span><span style="color: #000000;"> BaseTypeAdapter {<br><br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> OnChatItemListener{<br>        </span><span style="color: #0000ff;">void</span> onImageClicked(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position);<br>        </span><span style="color: #0000ff;">void</span> onHeadClicked(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position);<br>        </span><span style="color: #0000ff;">void</span> onItemClicked(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position);<br>    }<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> OnChatItemListener onChatItemListener;<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnChatItemListener(OnChatItemListener onChatItemListener) {<br>        </span><span style="color: #0000ff;">this</span>.onChatItemListener =<span style="color: #000000;"> onChatItemListener;<br>    }<br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> OnChatItemListener getOnChatItemListener() {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> onChatItemListener;<br>    }<br><br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br>    </span><span style="color: #0000ff;">private</span> List&lt;Message&gt;<span style="color: #000000;"> list;<br>    </span><span style="color: #0000ff;">public</span> List&lt;Message&gt;<span style="color: #000000;"> getList() {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> list;<br>    }<br><br>    </span><span style="color: #0000ff;">public</span> MessageAdapter(Context context, List&lt;Message&gt;<span style="color: #000000;"> list) {<br>        </span><span style="color: #0000ff;">this</span>.context =<span style="color: #000000;"> context;<br>        </span><span style="color: #0000ff;">this</span>.list =<span style="color: #000000;"> list;<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getCount() {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> list.size();<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> DoctorFriendMessageViewModelProxy getItem(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position) {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> list.get(position);<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">long</span> getItemId(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position) {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> position;<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> getItemViewType(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position) {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> list.get(position).getTyp();<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getViewTypeCount() {<br>        </span><span style="color: #0000ff;">return</span> 2<span style="color: #000000;">;<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> AdapterTypeRender getAdapterTypeRender(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position){<br>        AdapterTypeRender typeRender </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>        </span><span style="color: #0000ff;">switch</span><span style="color: #000000;">(getItemViewType(position)){<br>            </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> MessageConstants.MessageType.IMAGE:<br>                typeRender </span>= <span style="color: #0000ff;">new</span> ChatTypeImageRender(context, <span style="color: #0000ff;">this</span><span style="color: #000000;">);<br>                </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br>            </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> MessageConstants.MessageType.TEXT:<br>            </span><span style="color: #0000ff;">default</span><span style="color: #000000;">:<br>                typeRender </span>= <span style="color: #0000ff;">new</span> ChatTypeTextRender(context, <span style="color: #0000ff;">this</span><span style="color: #000000;">);<br>                </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br>        }<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> typeRender;<br>    }<br><br>}</span></pre><br></div>

<p>如上代码所示，通过实现getAdapterTypeRender来获取对应类型的Render即可了。</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ListView </tag>
            
            <tag> best practices </tag>
            
            <tag> adapter </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android上的MVP：如何组织显示层的内容]]></title>
      <url>/2014/07/13/Android%E4%B8%8A%E7%9A%84MVP%EF%BC%9A%E5%A6%82%E4%BD%95%E7%BB%84%E7%BB%87%E6%98%BE%E7%A4%BA%E5%B1%82%E7%9A%84%E5%86%85%E5%AE%B9/</url>
      <content type="html"><![CDATA[<p>MVP（Model View Presenter）模式是著名的MVC（Model View Controller）模式的一个演化版本，目前它在Android应用开发中越来越重要了，大家也都在讨论关于MVP的理论，只是结构化的资料非常少。这就是我写这篇博客的原因，我想鼓励大家多参与讨论，然后把MVP模式运用在项目开发中。</p>
<h3 id="什么是MVP？"><a href="#什么是MVP？" class="headerlink" title="什么是MVP？"></a>什么是MVP？</h3><p>MVP模式可以分离显示层和逻辑层，所以功能接口如何工作与功能的展示可以实现分离，MVP模式理想化地可以实现同一份逻辑代码搭配不同的显示界面。首先要澄清就是MVP不是一个结构化的模式，它只是负责显示层而已，任何时候都可以在自己的项目结构中使用MVP模式。</p>
<h3 id="为什么要使用MVP？"><a href="#为什么要使用MVP？" class="headerlink" title="为什么要使用MVP？"></a>为什么要使用MVP？</h3><p>我们知道在Android上逻辑接口和数据存取是紧耦合的，这个问题可以看看CursorAdapter这个例子，它既融合了适配器，同时也有显示的成分，而cursor很大程度上应该是数据数据存取层的。</p>
<p>对于一个可扩展、稳定的应用来说，我们需要定义各个分离层，毕竟，我们不知道以后还要加入什么逻辑，是从本地数据库检索数据？还是从远程的web Service中？</p>
<p>MVP模式可以让显示界面和数据分离，我们开发的应用可以分离至少三层，这样也可以进行独立测试。有了MVP我们就可以从Activity中分离大部分代码，而且不用单元测试可以对每个模块进行单独测试了。</p>
<h3 id="怎么在Android上实现MVP？"><a href="#怎么在Android上实现MVP？" class="headerlink" title="怎么在Android上实现MVP？"></a>怎么在Android上实现MVP？</h3><p>说到这里，问题就有点复杂了。实现MVP的方式有很多种，每个人都可以根据自己的需求和自己喜欢的方式去修正MVP的实现方式，它可以随着Presenter的复杂程度变化。</p>
<p>在View中需不需要控制进度条？或者是在Presenter处理？还有，谁来决定Action Bar该显示什么操作？这是一个艰难的决定。这里我会展示我自己的做法，但是我希望本文成为一个讨论如何应用MVP的地方，因为目前为止还没有实现MVP的标准方式。</p>
<h3 id="Presenter"><a href="#Presenter" class="headerlink" title="Presenter"></a>Presenter</h3><p>Presenter主要作为沟通View和Model的桥梁，它从Model层检索数据后，返回给View层，但是不想典型的MVC结构，因为它也可以决定与View层的交互操作。</p>
<h3 id="View"><a href="#View" class="headerlink" title="View"></a>View</h3><p>View通常来说是由Activity实现的（也许是Fragment，VIew，取决于app的整体结构），它会包含一个Presenter的引用，最理想的是Presenter由一个依赖注入管理器提供，比如<a href="http://square.github.io/dagger/" target="_blank" rel="noopener">Dagger</a>，不过如果不用注入器的话，就需要独立创建Presenter对象了。View要做的就只是在每次有接口调用的时候（比如按钮点击后）调用Presenter的方法。</p>
<h3 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h3><p>对于一个结构化的APP来说，Model主要是通向主领域层或者逻辑层的通道，如果使用了<a href="http://blog.8thlight.com/uncle-bob/2012/08/13/the-clean-architecture.html" target="_blank" rel="noopener">Uncle Bob clean architecture</a>的话，Model就可能是一个实现了用例场景的交互工具，这也是我将要在另一篇文章中讨论的一个主题。现在，只要把它看做是给View提供数据的容器就对了。</p>
<h3 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h3><p>鉴于已经解释的太长了，本人写了一个例子<a href="https://github.com/antoniolg/androidmvp" target="_blank" rel="noopener">an MVP example on Github</a>，由一个登录界面组成，可以验证数据然后进入一个带有列表的主界面，数据来自Model，因为比较简单，所以本文就不讲代码了，但是如果读者觉得还是很难理解的话，我还可以再写一篇文章详细介绍。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在Android上要分离接口和逻辑不容易实现，但是Model-View-Presenter模式可以更简单的防止在Activity中掺杂太多代码在大的项目中，组织好代码结构是最基本的要求，不然，代码的稳定和扩展就很困难了。</p>
<p>&nbsp;</p>
<p>原文链接：&nbsp;<a href="http://antonioleiva.com/mvp-android/" target="_blank" rel="noopener">antonioleiva</a>&nbsp;&nbsp;&nbsp;翻译：&nbsp;<a href="http://blog.jobbole.com/" target="_blank" rel="noopener">伯乐在线&nbsp;</a>-&nbsp;<a href="http://blog.jobbole.com/author/chris/" target="_blank" rel="noopener">chris</a><br>译文链接：&nbsp;<a href="http://blog.jobbole.com/71209/" target="_blank" rel="noopener">http://blog.jobbole.com/71209/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> mvp </tag>
            
            <tag> framework </tag>
            
            <tag> mvc </tag>
            
            <tag> best practices </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]解决ClickableSpan中点击后ListView中item的长按冲突的问题]]></title>
      <url>/2014/07/03/Android-%E8%A7%A3%E5%86%B3ClickableSpan%E4%B8%AD%E7%82%B9%E5%87%BB%E5%90%8EListView%E4%B8%ADitem%E7%9A%84%E9%95%BF%E6%8C%89%E5%86%B2%E7%AA%81%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<p>项目中碰到一个问题，情景是这样的：</p>
<p>有一个ListView，每个item中有一个TextView，这个TextView实现了LongClick事件，这个TextView中又添加了ClickableSpan，实现了方法onClick。</p>
<p>我的需求是点击ClickableSpan，则响应ClickableSpan事件；长按ClickableSpan效果跟长按TextView应该一样，都响应TextView的LongClick事件。</p>
<p>然而结果是点击ClickableSpan响应正常；但是长按ClickableSpan时问题出现了：TextView的长按事件响应了，ClickableSpan点击事件也响应了！</p>
<p>研究了一下代码，解决方法如下：</p>
<p>继承LinkMovementMethod，然后重写里面的onTouchEvent方法，在里面判断，如果当前是长按的状态，则不执行ClickableSpan的onClick事件：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.kanchufang.privatedoctor.util.spannableparser;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.text.Layout;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.text.Selection;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.text.Spannable;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.text.method.LinkMovementMethod;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.text.style.ClickableSpan;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.MotionEvent;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.TextView;<br><br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  Author: wangjie<br> <em> Email: tiantian.china.2@gmail.com
 </em> Date: 7/3/14.<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> LinkMovementClickMethod <span style="color: #0000ff;">extends</span><span style="color: #000000;"> LinkMovementMethod{<br><br>    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> lastClickTime;<br><br>    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">long</span> CLICK_DELAY = 500l<span style="color: #000000;">;<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onTouchEvent(TextView widget, Spannable buffer, MotionEvent event) {<br>        </span><span style="color: #0000ff;">int</span> action =<span style="color: #000000;"> event.getAction();<br><br>        </span><span style="color: #0000ff;">if</span> (action == MotionEvent.ACTION_UP ||<span style="color: #000000;"><br>                action </span>==<span style="color: #000000;"> MotionEvent.ACTION_DOWN) {<br>            </span><span style="color: #0000ff;">int</span> x = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) event.getX();<br>            </span><span style="color: #0000ff;">int</span> y = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) event.getY();<br><br>            x </span>-=<span style="color: #000000;"> widget.getTotalPaddingLeft();<br>            y </span>-=<span style="color: #000000;"> widget.getTotalPaddingTop();<br><br>            x </span>+=<span style="color: #000000;"> widget.getScrollX();<br>            y </span>+=<span style="color: #000000;"> widget.getScrollY();<br><br>            Layout layout </span>=<span style="color: #000000;"> widget.getLayout();<br>            </span><span style="color: #0000ff;">int</span> line =<span style="color: #000000;"> layout.getLineForVertical(y);<br>            </span><span style="color: #0000ff;">int</span> off =<span style="color: #000000;"> layout.getOffsetForHorizontal(line, x);<br><br>            ClickableSpan[] link </span>= buffer.getSpans(off, off, ClickableSpan.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br><br>            </span><span style="color: #0000ff;">if</span> (link.length != 0<span style="color: #000000;">) {<br>                </span><span style="color: #0000ff;">if</span> (action ==<span style="color: #000000;"> MotionEvent.ACTION_UP) {<br>                    </span><span style="color: #0000ff;">if</span>(System.currentTimeMillis() - lastClickTime &lt;<span style="color: #000000;"> CLICK_DELAY){<br>                        link[</span>0<span style="color: #000000;">].onClick(widget);<br>                    }<br>                } </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (action ==<span style="color: #000000;"> MotionEvent.ACTION_DOWN) {<br>                    Selection.setSelection(buffer,<br>                            buffer.getSpanStart(link[</span>0<span style="color: #000000;">]),<br>                            buffer.getSpanEnd(link[</span>0<span style="color: #000000;">]));<br>                    lastClickTime </span>=<span style="color: #000000;"> System.currentTimeMillis();<br>                }<br><br>                </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br>                Selection.removeSelection(buffer);<br>            }<br>        }<br>        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">super</span><span style="color: #000000;">.onTouchEvent(widget, buffer, event);<br>    }<br><br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> LinkMovementClickMethod getInstance(){<br>        </span><span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> sInstance){<br>            sInstance </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> LinkMovementClickMethod();<br>        }<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> sInstance;<br>    }<br><br>    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> LinkMovementClickMethod sInstance;<br><br>}</span></pre><br></div>

<p>代码很简单，按住超过500ms，则认定为是长按，则不执行ClickableSpan的onClick</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ListView </tag>
            
            <tag> ClickableSpan </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]竖直滑动选择器WheelView的实现]]></title>
      <url>/2014/07/01/Android-%E7%AB%96%E7%9B%B4%E6%BB%91%E5%8A%A8%E9%80%89%E6%8B%A9%E5%99%A8WheelView%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
      <content type="html"><![CDATA[<p>公司项目中有这么一个需求，所以需要自己实现下。效果类似android4.0以上原生的DatePicker这种。</p>
<p>这个WheelView控件我已经放在github上了，大家有兴趣可以看看，地址：<a href="https://github.com/wangjiegulu/WheelView" target="_blank" rel="noopener">https://github.com/wangjiegulu/WheelView</a>，欢迎Star或者Fork哦！（建库的时候忘了选ignore了－－，所以有些gen什么的直接无视掉，我也懒得改了－－）</p>
<p>&nbsp;</p>
<p>先贴上效果图：</p>
<p><img src="http://images.cnitblog.com/i/378300/201407/012249013099471.png" alt="">&nbsp;<img src="http://images.cnitblog.com/i/378300/201407/012249532936951.png" alt="">&nbsp;<img src="http://images.cnitblog.com/i/378300/201407/012251028875647.png" alt=""></p>
<p>&nbsp;</p>
<p>讲下思路吧，因为这是一个滚动选择器，所以首先想到的是可以基于ListView或者ScrollView自定义。</p>
<p>刚开始我用的是继承ListView来实现，把滑动选择的每个item作为listview中的一个item，然后根据FirstVisiblePosition、LastVisiblePosition来判断某个item是否在选中的区域，但是后来发现偶尔有时候调用getFirstVisiblePosition和getLastVisiblePosition的结果跟我看到的界面显示的item并不一致（我是在Adapter中调用的这两个方法），后来分析可能是因为我调用了scrollTo后没有刷新adapter的原因吧。</p>
<p>再后来，就打算使用ScrollView来实现了，其中的每个item都是一个View（我这里使用了TextView）。因为这个选中框是在中间的位置，所以刚启动时第一个item应该需要在中间选中框显示，所以前面应该使用空白补全。最后一个也是如此，后面也需要空白补全。</p>
<p>在滑动过程中需要实现这种场景：滑动结束后，必须且只有一个item完整显示在选择框中。所以我们必须要监听滚动停止的事件，然后在滚动停止后判断是不是满足前面的场景，如果没有，则需要代码中实现滚动到正确位置。但是，蛋疼的是，sdk中竟然没有提供原生的监听滚动停止的api，然后在网上找了很久，得到的结果是只能另辟蹊径，使用了<a href="http://stackoverflow.com/questions/8181828/android-detect-when-scrollview-stops-scrolling/10198865#10198865" target="_blank" rel="noopener">stackoverflow</a>一个网友的做法通过主动检测是否停止滚动的方法去实现（总觉得方法有点坑，额 好吧 但是暂时先用了这个方法）。</p>
<p>思路就讲到这里了。</p>
<p>&nbsp;</p>
<p>使用方式：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  Author: wangjie<br> <em> Email: tiantian.china.2@gmail.com
 </em> Date: 7/1/14.<br> </span><span style="color: #008000;">*/</span><span style="color: #000000;"><br>@AILayout(R.layout.main)<br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> AIActivity {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = MainActivity.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br><br>    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String[] PLANETS = <span style="color: #0000ff;">new</span> String[]{“Mercury”, “Venus”, “Earth”, “Mars”, “Jupiter”, “Uranus”, “Neptune”, “Pluto”<span style="color: #000000;">};<br><br>    @AIView(R.id.main_wv)<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> WheelView wva;<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br>        </span><span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br><br>        wva.setOffset(</span>1<span style="color: #000000;">);<br>        wva.setItems(Arrays.asList(PLANETS));<br>        wva.setOnWheelViewListener(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> WheelView.OnWheelViewListener() {<br>            @Override<br>            </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onSelected(<span style="color: #0000ff;">int</span><span style="color: #000000;"> selectedIndex, String item) {<br>                Logger.d(TAG, </span>“selectedIndex: “ + selectedIndex + “, item: “ +<span style="color: #000000;"> item);<br>            }<br>        });<br><br>    }<br><br>    @AIClick({R.id.main_show_dialog_btn})<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClickCallbackSample(View view) {<br>        </span><span style="color: #0000ff;">switch</span><span style="color: #000000;"> (view.getId()) {<br>            </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.main_show_dialog_btn:<br>                View outerView </span>= LayoutInflater.from(context).inflate(R.layout.wheel_view, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br>                WheelView wv </span>=<span style="color: #000000;"> (WheelView) outerView.findViewById(R.id.wheel_view_wv);<br>                wv.setOffset(</span>2<span style="color: #000000;">);<br>                wv.setItems(Arrays.asList(PLANETS));<br>                wv.setSeletion(</span>3<span style="color: #000000;">);<br>                wv.setOnWheelViewListener(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> WheelView.OnWheelViewListener() {<br>                    @Override<br>                    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onSelected(<span style="color: #0000ff;">int</span><span style="color: #000000;"> selectedIndex, String item) {<br>                        Logger.d(TAG, </span>“[Dialog]selectedIndex: “ + selectedIndex + “, item: “ +<span style="color: #000000;"> item);<br>                    }<br>                });<br><br>                </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> AlertDialog.Builder(context)<br>                        .setTitle(</span>“WheelView in Dialog”<span style="color: #000000;">)<br>                        .setView(outerView)<br>                        .setPositiveButton(</span>“OK”, <span style="color: #0000ff;">null</span><span style="color: #000000;">)<br>                        .show();<br><br>                </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br>        }<br>    }<br><br>}</span></pre><br></div>

<p>&nbsp;</p>
<p>注意：这个Demo只是一个临时解决方案，比较适合选项较少的时候使用，比如选择性别、星期等。因为里面的买个item都是一个单独的View，并没有去实现View的缓存和重用，所以大家这点需要注意下。如果有时间我会完善优化这个代码，实现View的复用。关于View的复用，大家可以fork后自己尝试改写，我讲下主要的思路（我的思路，当然不能代表是最优的方案）是：假设，每页显示5个item以供选择，那么刚开始加载时，先生成6个item，其中6个是正常的6个选项所new出来的item，注意！因为每页显示5个item，所以第6个item不可见，但是却已经new出来了，其实可以正常显示。然后往下滚动时，监听滚动事件，第6个完全显示时，这个时候第一个item已经不可见了，所以可以重用该item的view。所以如果往下滚要显示第7个item时，重用第一个item的view，作为第7个item的view显示数据。再往下也是一样。总之，重用当前不可见的item的view给即将显示的item。</p>
<p>&nbsp;</p>
<p>注意：项目使用到了一部分注解、日志方面的东西，跟实现WheelView没关系，但是可以简化代码，提高编码效率</p>
<p>AndroidInject：<a href="https://github.com/wangjiegulu/androidInject" target="_blank" rel="noopener">https://github.com/wangjiegulu/androidInject</a></p>
<p>AndroidBucket：<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> github </tag>
            
            <tag> library </tag>
            
            <tag> WheelView </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android无线调试]]></title>
      <url>/2014/06/07/Android%E6%97%A0%E7%BA%BF%E8%B0%83%E8%AF%95/</url>
      <content type="html"><![CDATA[<p>方法一：</p>
<p>1. 使用USB数据线连接设备。</p>
<p>2. 命令输入adb tcpip 5555 ( 5555为端口号，可以自由指定）。</p>
<p>3. 断开 USB数据，此时可以连接你需要连接的|USB设备。</p>
<p>4. 再命令输入 adb connect &lt;设备的IP地址&gt;:5555</p>
<p>后面就可以使用ADB ，DDMS 来调试Android应用或显示Logcat 消息。</p>
<p>5. 如果需要恢复到USB数据线，可以在命令行输入adb usb</p>
<p>注： Android设备的IP地址可以在Settings-&gt;About Phone-&gt;Status 查到</p>
<p>参考：<a href="http://blog.csdn.net/daditao/article/details/19077281" target="_blank" rel="noopener">http://blog.csdn.net/daditao/article/details/19077281</a></p>
<p>&nbsp;</p>
<p>方法二：</p>
<p><span>首先让手机与电脑处于同一局域网下，然后下载一款名为adbWireless的应用（到Google Play商店可以搜索到），下载安装后运行软件，会显示手机在当前局域网的IP地址和端口（前提是手机需要ROOT），然后可以看到手机出现了IP地址和端口号。</span></p>
<p><span><span>随后打开命令行，进入安装SDK的目录中platform-tools文件夹并输入：adb connect 手机IP地址（我的是192.168.1.110）</span></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> debug </tag>
            
            <tag> debuggable </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[IOS]《A Swift Tour》翻译（一）]]></title>
      <url>/2014/06/04/IOS-%E3%80%8AA-Swift-Tour%E3%80%8B%E7%BF%BB%E8%AF%91%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>碎碎念。。。</p>
<p>Swift是苹果在WWDC刚发布的新语言，本人也没学过，现在看苹果官方文档一边翻译一边学习，再加上英语水平和对编程理解很有限，有错误的地方请大家指出，翻译只供参考，建议阅读<a href="https://developer.apple.com/library/prerelease/ios/documentation/Swift/Conceptual/Swift_Programming_Language/GuidedTour.html#//apple_ref/doc/uid/TP40014097-CH2-XID_1" target="_blank" rel="noopener">苹果Swift官方的文档</a></p>
<p>&nbsp;</p>
<p><span class="s1">Swift 之旅</span></p>
<p><span class="s1">按照传统，在开始学习一门新的语言时写的第一个程序应该是在屏幕上打印&ldquo;Hello, World&rdquo;，这个可以用一行来完成：</span></p>
<p>&nbsp;</p>
<p><span class="s1">print(&ldquo;Hello, world&rdquo;)</span></p>
<p>&nbsp;</p>
<p><span class="s1">&nbsp;如果你有写过C或者Objective-C的经验，这个语法你应该会感觉很熟悉&mdash;&mdash;在Swift中，这行代码就是一个完整的程序。你不需要像输入输出流或者字符串处理等那样去导入另外的具有功能性的库。在全局范围编写的代码即是程序的入口点，所以你不需要一个main方法。你也不需要在每个语句后面写上分号。</span></p>
<p><span class="s1">&nbsp; &nbsp; 这个旅程会带给你足够的信息让你用Swift来完成各种编程任务。不用担心你是否懂得一些编程&mdash;&mdash;这本书对各个方面都进行来详细的介绍。</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>基本数据</p>
<p><span class="s1">&nbsp; &nbsp; 使用let来表示一个常量，使用var来表示一个变量。常量的值不需要在编译时期被知道，但是你必须且只能一次分配一个值给它。这表示你一旦给这个常量分配了一个值，你就能在很多地方使用它了。</span></p>
<p>&nbsp;</p>
<p><span class="s1">var myVariable = 42;</span></p>
<p><span class="s1">myVariable = 50;</span></p>
<p><span class="s1">let myConstant = 42;</span></p>
<p>&nbsp;</p>
<p><span class="s1">一个常量或者变量的类型必须要跟你分配给它的值的类型一致。然而，你一般不需要精确的写明它的类型。当你创建了一个常量或者变量，并赋值后，编译器会自动推断出它的类型。比如在上面的例子中，编译器会推断出myVariable是一个integer，因为它的初始值就是一个integer。</span></p>
<p><span class="s1">如果初始值不能提供足够的信息（或者它根本没有初始值），可以在这个变量后面加上冒号，然后写上指定类型。</span></p>
<p>&nbsp;</p>
<p><span class="s1">let implicitInteger = 70</span></p>
<p><span class="s1">let implicitDouble = 70.0</span></p>
<p><span class="s1">let explicitDouble: Double = 70</span></p>
<p>&nbsp;</p>
<p><span class="s1">值不会隐式地被转换成另一种类型。如果你需要转换成一个不同类型的值，显示地生成一个期望类型的实例。</span></p>
<p>&nbsp;</p>
<p><span class="s1">let label = &ldquo;The width is &rdquo;</span></p>
<p><span class="s1">let width = 94</span></p>
<p><span class="s1">let widthLabel = label + String(width)</span></p>
<p>&nbsp;</p>
<p><span class="s1">还有一个更简单的方法，在字符串中包含变量值：写一对括号里面写一个变量值，然后在括号前面写一个反斜杠，举个例子：</span></p>
<p>&nbsp;</p>
<p><span class="s1">let apples = 3</span></p>
<p><span class="s1">let oranges = 5</span></p>
<p><span class="s1">let appleSummary = &ldquo;I have (apples) apples.&rdquo;</span></p>
<p><span class="s1">let fruitSummary = &ldquo;I have (apples + oranges) pieces of fruit.&rdquo;</span></p>
<p>&nbsp;</p>
<p><span class="s1">使用中括号（[]）来创建一个数组或者字典，使用index（索引）或者key（键）访问他们的某一项。</span></p>
<p>&nbsp;</p>
<p><span class="s1">var shoppingList = [&ldquo;catfish&rdquo;, &ldquo;water&rdquo;, &ldquo;tulips&rdquo;, &ldquo;blue paint&rdquo;]</span></p>
<p><span class="s1">shoppingList[1] = &ldquo;bottle of water&rdquo;</span></p>
<p><span class="s1">var occupations = [</span></p>
<p><span class="s1">&ldquo;Malcolm&rdquo;: &ldquo;Captain&rdquo;,</span></p>
<p><span class="s1">&ldquo;Kaylee&rdquo;: &ldquo;Mechanic&rdquo;,</span></p>
<p><span class="s1">]</span></p>
<p><span class="s1">occupations[&ldquo;Jayne&rdquo;] = &ldquo;Public Relations&rdquo;</span></p>
<p>&nbsp;</p>
<p><span class="s1">使用初始化器的语法来创建一个空的数组或者字典。</span></p>
<p>&nbsp;</p>
<p><span class="s1">let emptyArray = String<a href=""></a></span></p>
<p><span class="s1">let emptyDictionary = Dictionary&lt;String, Float&gt;()</span></p>
<p>&nbsp;</p>
<p><span class="s1">如果类型信息是可推断的，你可以使用[]创建一个空的数组，使用[:]来创建一个空的字典，举个例子，当你设置一个新的值或者往方法中传入一个变量作为参数</span></p>
<p>&nbsp;</p>
<p><span class="s1">shoppingList = []</span></p>
<p>&nbsp;</p>
<p><span class="s1">控制语句</span></p>
<p><span class="s1">使用if和switch来创建一个条件，使用for-in，for，while和do-while来创建一个循环。</span></p>
<p><span class="s1">条件和循环变量上的括号是可选的。if后面大括号和循环体的大括号是必须的。</span></p>
<p>&nbsp;</p>
<p><span class="s1">let individualScores = [75, 43, 103, 87, 12]</span></p>
<p><span class="s1">var teamScore = 0</span></p>
<p><span class="s1">for score in individualScores{</span></p>
<p><span class="s1">if score &gt; 50{</span></p>
<p><span class="s1">teamScore += 3</span></p>
<p><span class="s1">}else{</span></p>
<p><span class="s1">teamScore += 1</span></p>
<p><span class="s1">}</span></p>
<p><span class="s1">}</span></p>
<p><span class="s1">teamScore</span></p>
<p>&nbsp;</p>
<p><span class="s1">在一个if语句中，条件必须是一个布尔类型的表达式&mdash;&mdash;这表示像if score { &hellip; }这样的代码是错误的，这个score并不是隐式地去跟0比较。</span></p>
<p>&nbsp;</p>
<p><span class="s1">你可以在值可能为空的时候同时使用if和let。这些值就被表示为可选地。一个可选的值可能包含一个值或者包含一个nil，nil表示这个值是空。在这个值的类型后面写上一个疑问符号（?）可以把这个值标记为可选的。</span></p>
<p>&nbsp;</p>
<p><span class="s1">var optionalString: String? = &ldquo;Hello&rdquo;</span></p>
<p><span class="s1">optionalString == nil</span></p>
<p>&nbsp;</p>
<p><span class="s1">var optionalName: String? = &ldquo;John Appleseed&rdquo;</span></p>
<p><span class="s1">var greeting = &ldquo;Hello!&rdquo;</span></p>
<p><span class="s1">if let name = optionalName{</span></p>
<p><span class="s1">greeting = &ldquo;Hello, (name)&rdquo;</span></p>
<p><span class="s1">}</span></p>
<p>&nbsp;</p>
<p><span class="s1">如果可选值是nil，那么这个条件就为false，大括号中代码就会跳过。否则，可选值执行后面代码块中的代码并分配给let后面的常数。</span></p>
<p><span class="s1">Switches支持各种数据和各种各样的比较操作&mdash;&mdash;它们不局限于integers和相等式的比较。</span></p>
<p>&nbsp;</p>
<p><span class="s1">let vegetable = &ldquo;red pepper&rdquo;</span></p>
<p><span class="s1">switch vegetable{</span></p>
<p><span class="s1">case &ldquo;celery&rdquo;:</span></p>
<p><span class="s1">let vegetableComment = &ldquo;Add some raisins and make ants on a log.&rdquo;</span></p>
<p><span class="s1">case &ldquo;cucumber&rdquo;, &ldquo;watercress&rdquo;:</span></p>
<p><span class="s1">let vegetableComment = &ldquo;That would make a good tea sandwich.&rdquo;</span></p>
<p><span class="s1">case let x where x.hasSuffix(&ldquo;pepper&rdquo;):</span></p>
<p><span class="s1">let vegetableComment = &ldquo;Is it a spicy (x)?&rdquo;</span></p>
<p><span class="s1">default:</span></p>
<p><span class="s1">let vegetableComment = &ldquo;Everything tastes good in soup.&rdquo;</span></p>
<p><span class="s1">}</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span class="s1">在匹配的case中执行完代码后，程序退出switch语句。执行不会在下一个case中继续，所以不需要显示的在每个cases中的最后依次写上跳出该switch的break语句。</span></p>
<p><span class="s1">你可以使用for-in语句来迭代键值对形式的字典中的所有items。</span></p>
<p>&nbsp;</p>
<p><span class="s1">let interestingNumbers = [</span></p>
<p><span class="s1">&ldquo;Prime&rdquo;: [2, 3, 5, 7, 11, 13],</span></p>
<p><span class="s1">&ldquo;Fibonacci&rdquo;: [1, 1, 2, 3, 5, 8],</span></p>
<p><span class="s1">&ldquo;Square&rdquo;: [1, 4, 9, 16, 25],</span></p>
<p><span class="s1">]</span></p>
<p><span class="s1">var largest = 0</span></p>
<p><span class="s1">for(kind, numbers) in interestingNumbers{</span></p>
<p><span class="s1">for number in numbers{</span></p>
<p><span class="s1">if number &gt; largest{</span></p>
<p><span class="s1">largest = number</span></p>
<p><span class="s1">}</span></p>
<p><span class="s1">}</span></p>
<p><span class="s1">}</span></p>
<p><span class="s1">largest</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span class="s1">使用while来重复代码块中的代码，直到条件改变。循环条件也可以放在最后，可以确保这个循环至少执行一次。</span></p>
<p>&nbsp;</p>
<p><span class="s1">var n = 2</span></p>
<p><span class="s1">while n &lt; 100{</span></p>
<p><span class="s1">n = n * 2</span></p>
<p><span class="s1">}</span></p>
<p><span class="s1">n</span></p>
<p>&nbsp;</p>
<p><span class="s1">var m = 2</span></p>
<p><span class="s1">do{</span></p>
<p><span class="s1">m = m * 2</span></p>
<p><span class="s1">} while m &lt; 100</span></p>
<p><span class="s1">m</span></p>
<p>&nbsp;</p>
<p><span class="s1">你可以在循环中保持一个索引index&mdash;&mdash;通过使用..来限定一个索引范围或者指明初始值，条件和增量。下面两个结果一样的循环：</span></p>
<p>&nbsp;</p>
<p><span class="s1">var firstForLoop = 0</span></p>
<p><span class="s1">for i in 0..3{</span></p>
<p><span class="s1">firstForLoop += i</span></p>
<p><span class="s1">}</span></p>
<p><span class="s1">firstForLoop</span></p>
<p>&nbsp;</p>
<p><span class="s1">var secondForLoop = 0</span></p>
<p><span class="s1">for var i = 0; i &lt; 3; ++i{</span></p>
<p><span class="s1">secondForLoop += 1</span></p>
<p><span class="s1">}</span></p>
<p><span class="s1">secondForLoop</span></p>
<p>&nbsp;</p>
<p><span class="s1">使用..来限定范围会省略范围的上限值，使用…来限定范围会包含所有限定值。（译者注：..是左闭右开整数区间，&hellip;是左闭右闭整数区间）</span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> 翻译 </tag>
            
            <tag> iOS </tag>
            
            <tag> swift </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android Property Animation动画]]></title>
      <url>/2014/05/19/Android-Property-Animation%E5%8A%A8%E7%94%BB/</url>
      <content type="html"><![CDATA[<p>3.0以前，android支持两种动画模式，tween animation,frame animation，在android3.0中又引入了一个新的动画系统：property animation，这三种动画模式在SDK中被称为property animation,view animation,drawable animation。 可通过<a href="http://nineoldandroids.com/" title="NineOldAndroids" target="_blank" rel="noopener">NineOldAndroids</a>项目在3.0之前的系统中使用Property Animation</p>
<h1 id="1-View-Animation（Tween-Animation）"><a href="#1-View-Animation（Tween-Animation）" class="headerlink" title="1. View Animation（Tween Animation）"></a>1. View Animation（Tween Animation）</h1><p>　　View Animation（Tween Animation）：补间动画，给出两个关键帧，通过一些算法将给定属性值在给定的时间内在两个关键帧间渐变。</p>
<p>　　View animation只能应用于View对象，而且只支持一部分属性，如支持缩放旋转而不支持背景颜色的改变。</p>
<p>　　而且对于View animation，它只是改变了View对象绘制的位置，而没有改变View对象本身，比如，你有一个Button，坐标（100,100），Width:200,Height:50，而你有一个动画使其变为Width：100，Height：100，你会发现动画过程中触发按钮点击的区域仍是(100,100)-(300,150)。</p>
<p>　　View Animation就是一系列View形状的变换，如大小的缩放，透明度的改变，位置的改变，动画的定义既可以用代码定义也可以用XML定义，当然，建议用XML定义。</p>
<p>　　可以给一个View同时设置多个动画，比如从透明至不透明的淡入效果，与从小到大的放大效果，这些动画可以同时进行，也可以在一个完成之后开始另一个。</p>
<p>　　用XML定义的动画放在/res/anim/文件夹内，XML文件的根元素可以为&lt;alpha&gt;,&lt;scale&gt;,&lt;translate&gt;,&lt;rotate&gt;,interpolator元素或&lt;set&gt;(表示以上几个动画的集合，set可以嵌套)。默认情况下，所有动画是同时进行的，可以通过startOffset属性设置各个动画的开始偏移（开始时间）来达到动画顺序播放的效果。</p>
<p>　　可以通过设置interpolator属性改变动画渐变的方式，如AccelerateInterpolator，开始时慢，然后逐渐加快。默认为AccelerateDecelerateInterpolator。</p>
<p>　　定义好动画的XML文件后，可以通过类似下面的代码对指定View应用动画。</p>
<div class="cnblogs_code"><br><pre>ImageView spaceshipImage = (ImageView)findViewById(R.id.spaceshipImage);<br>Animation hyperspaceJumpAnimation=AnimationUtils.loadAnimation(<span>this</span>, R.anim.hyperspace_jump);<br>spaceshipImage.startAnimation(hyperspaceJumpAnimation);</pre><br></div>

<h1 id="2-Drawable-Animation（Frame-Animation）"><a href="#2-Drawable-Animation（Frame-Animation）" class="headerlink" title="2. Drawable Animation（Frame Animation）"></a>2. Drawable Animation（Frame Animation）</h1><p>　　Drawable Animation（Frame Animation）：帧动画，就像GIF图片，通过一系列Drawable依次显示来模拟动画的效果。在XML中的定义方式如下：</p>
<pre class="brush: xml; auto-links: true; collapse: false; first-line: 1; gutter: true; html-script: false; light: false; ruler: false; smart-tabs: true; tab-size: 4; toolbar: true;">&lt;animation-list xmlns:android="http://schemas.android.com/apk/res/android"
    android:oneshot="true"&gt;
    &lt;item android:drawable="@drawable/rocket_thrust1" android:duration="200" /&gt;
    &lt;item android:drawable="@drawable/rocket_thrust2" android:duration="200" /&gt;
    &lt;item android:drawable="@drawable/rocket_thrust3" android:duration="200" /&gt;
&lt;/animation-list&gt;</pre>

<p>　　必须以&lt;animation-list&gt;为根元素，以&lt;item&gt;表示要轮换显示的图片，duration属性表示各项显示的时间。XML文件要放在/res/drawable/目录下。示例：</p>
<div class="cnblogs_code"><br><pre><span>protected</span> <span>void</span> onCreate(Bundle savedInstanceState) {<br>        <span>//</span><span> TODO Auto-generated method stub</span><span><br></span>        <span>super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.main);<br>        imageView = (ImageView) findViewById(R.id.imageView1);<br>        imageView.setBackgroundResource(R.drawable.drawable_anim);<br>        anim = (AnimationDrawable) imageView.getBackground();<br>    }<br><br>    <span>public</span> <span>boolean</span> onTouchEvent(MotionEvent event) {<br>        <span>if</span> (event.getAction() == MotionEvent.ACTION_DOWN) {<br>            anim.stop();<br>            anim.start();<br>            <span>return</span> <span>true</span>;<br>        }<br>        <span>return</span> <span>super</span>.onTouchEvent(event);<br>    }</pre><br></div>

<p>　　我在实验中遇到两点问题：</p>
<ol>
<li>要在代码中调用Imageview的setBackgroundResource方法，如果直接在XML布局文件中设置其src属性当触发动画时会FC。</li>
<li>在动画start()之前要先stop()，不然在第一次动画之后会停在最后一帧，这样动画就只会触发一次。</li>
<li>最后一点是SDK中提到的，不要在onCreate中调用start，因为AnimationDrawable还没有完全跟Window相关联，如果想要界面显示时就开始动画的话，可以在onWindowFoucsChanged()中调用start()。</li>
</ol>
<h1 id="3-Property-Animation"><a href="#3-Property-Animation" class="headerlink" title="3. Property Animation"></a>3. Property Animation</h1><p>　　属性动画，这个是在Android 3.0中才引进的，以前学WPF时里面的动画机制好像就是这个，它更改的是对象的实际属性，在View Animation（Tween Animation）中，其改变的是View的绘制效果，真正的View的属性保持不变，比如无论你在对话中如何缩放Button的大小，Button的有效点击区域还是没有应用动画时的区域，其位置与大小都不变。而在Property Animation中，改变的是对象的实际属性，如Button的缩放，Button的位置与大小属性值都改变了。而且Property Animation不止可以应用于View，还可以应用于任何对象。Property Animation只是表示一个值在一段时间内的改变，当值改变时要做什么事情完全是你自己决定的。</p>
<p>在Property Animation中，可以对动画应用以下属性：</p>
<ul>
<li>Duration：动画的持续时间</li>
<li>TimeInterpolation：属性值的计算方式，如先快后慢</li>
<li>TypeEvaluator：根据属性的开始、结束值与TimeInterpolation计算出的因子计算出当前时间的属性值</li>
<li>Repeat Count and behavoir：重复次数与方式，如播放3次、5次、无限循环，可以此动画一直重复，或播放完时再反向播放</li>
<li>Animation sets：动画集合，即可以同时对一个对象应用几个动画，这些动画可以同时播放也可以对不同动画设置不同开始偏移</li>
<li>Frame refreash delay：多少时间刷新一次，即每隔多少时间计算一次属性值，默认为10ms，最终刷新时间还受系统进程调度与硬件的影响</li>
</ul>
<h2 id="3-1-Property-Animation的工作方式"><a href="#3-1-Property-Animation的工作方式" class="headerlink" title="3.1 Property Animation的工作方式"></a>3.1 Property Animation的工作方式</h2><p>　　对于下图的动画，这个对象的X坐标在40ms内从0移动到40 pixel.按默认的10ms刷新一次，这个对象会移动4次，每次移动40/4=10pixel。</p>
<p><img src="http://pic002.cnblogs.com/images/2011/168097/2011120119185844.png" alt=""></p>
<p>　　也可以改变属性值的改变方法，即设置不同的interpolation，在下图中运动速度先逐渐增大再逐渐减小</p>
<p><img src="http://pic002.cnblogs.com/images/2011/168097/2011120119190666.png" alt=""></p>
<p>　　下图显示了与上述动画相关的关键对象</p>
<p><img src="http://pic002.cnblogs.com/images/2011/168097/2011120119191590.png" alt=""></p>
<p>ValueAnimator &nbsp;表示一个动画，包含动画的开始值，结束值，持续时间等属性。</p>
<p>ValueAnimator封装了一个TimeInterpolator，TimeInterpolator定义了属性值在开始值与结束值之间的插值方法。</p>
<p>ValueAnimator还封装了一个TypeAnimator，根据开始、结束值与TimeIniterpolator计算得到的值计算出属性值。</p>
<p>ValueAnimator根据动画已进行的时间跟动画总时间（duration）的比计算出一个时间因子（0~1），然后根据TimeInterpolator计算出另一个因子，最后TypeAnimator通过这个因子计算出属性值，如上例中10ms时：</p>
<p>首先计算出时间因子，即经过的时间百分比：t=10ms/40ms=0.25</p>
<p>经插值计算(inteplator)后的插值因子:大约为0.15，上述例子中用了AccelerateDecelerateInterpolator，计算公式为（input即为时间因子）：</p>
<div class="cnblogs_code"><br><pre>(Math.cos((input + 1) * Math.PI) / 2.0f) + 0.5f;  </pre><br></div>

<p>最后根据TypeEvaluator计算出在10ms时的属性值：0.15*（40-0）=6pixel。上例中TypeEvaluator为FloatEvaluator，计算方法为 ：</p>
<div class="cnblogs_code"><br><pre>public Float evaluate(<span>float</span><span> fraction, Number startValue, Number endValue) {<br>    </span><span>float</span> startFloat =<span> startValue.floatValue();<br>    </span><span>return</span> startFloat + fraction * (endValue.floatValue() -<span> startFloat);<br>}</span></pre><br></div>

<p>参数分别为上一步的插值因子，开始值与结束值。</p>
<h2 id="3-2-ValueAnimator"><a href="#3-2-ValueAnimator" class="headerlink" title="3.2 ValueAnimator"></a>3.2 ValueAnimator</h2><p>　　ValueAnimator包含Property Animation动画的所有核心功能，如动画时间，开始、结束属性值，相应时间属性值计算方法等。应用Property Animation有两个步聚：</p>
<ol>
<li>计算属性值</li>
<li>根据属性值执行相应的动作，如改变对象的某一属性。</li>
</ol>
<p>　　ValuAnimiator只完成了第一步工作，如果要完成第二步，需要实现ValueAnimator.onUpdateListener接口，这个接口只有一个函数onAnimationUpdate()，在这个函数中会传入ValueAnimator对象做为参数，通过这个ValueAnimator对象的getAnimatedValue()函数可以得到当前的属性值如：</p>
<div class="cnblogs_code"><br><pre>ValueAnimator animation = ValueAnimator.ofFloat(0f, 1f);<br>animation.setDuration(1000);<br>animation.addUpdateListener(<span>new</span> AnimatorUpdateListener() {<br>    @Override<br>    <span>public</span> <span>void</span> onAnimationUpdate(ValueAnimator animation) {<br>        Log.i(“update”, ((Float) animation.getAnimatedValue()).toString());<br>    }<br>});<br>animation.setInterpolator(<span>new</span> CycleInterpolator(3));<br>animation.start();</pre><br></div>

<p>此示例中只是向Logcat输出了一些信息，可以改为想做的工作。</p>
<p><strong>Animator.AnimatorListener</strong></p>
<div class="cnblogs_code"><br><pre><span>onAnimationStart()<br><br>onAnimationEnd()<br><br>onAnimationRepeat()<br><br></span><span>//</span><span>当动画被取消时调用，同时会调用onAnimationEnd().</span><br>onAnimationCancel()</pre><br></div>

<p><strong>ValueAnimator.AnimatorUpdateListener</strong></p>
<div class="cnblogs_code"><br><pre>onAnimationUpdate()　　<span>//</span><span>通过监听这个事件在属性的值更新时执行相应的操作，对于ValueAnimator一般要监听此事件执行相应的动作，不然Animation没意义，在ObjectAnimator（继承自ValueAnimator）中会自动更新属性，如无必要不必监听。在函数中会传递一个ValueAnimator参数，通过此参数的getAnimatedValue()取得当前动画属性值。</span></pre><br></div>

<p>　　可以继承AnimatorListenerAdapter而不是实现AnimatorListener接口来简化操作，这个类对AnimatorListener中的函数都定义了一个空函数体，这样我们就只用定义想监听的事件而不用实现每个函数却只定义一空函数体。</p>
<div class="cnblogs_code"><br><pre>ObjectAnimator oa=ObjectAnimator.ofFloat(tv, “alpha”<span>, 0f, 1f);<br>oa.setDuration(</span>3000<span>);<br>oa.addListener(</span><span>new</span><span> AnimatorListenerAdapter(){<br>    </span><span>public</span> <span>void</span><span> on AnimationEnd(Animator animation){<br>        Log.i(</span>“Animation”,”end”<span>);<br>    }<br>});<br>oa.start();</span></pre><br></div>

<h2 id="3-3-ObjectAnimator"><a href="#3-3-ObjectAnimator" class="headerlink" title="3.3 ObjectAnimator"></a>3.3 ObjectAnimator</h2><p>　　继承自ValueAnimator，要指定一个对象及该对象的一个属性，当属性值计算完成时自动设置为该对象的相应属性，即完成了Property Animation的全部两步操作。实际应用中一般都会用ObjectAnimator来改变某一对象的某一属性，但用ObjectAnimator有一定的限制，要想使用ObjectAnimator，应该满足以下条件：</p>
<ul>
<li>对象应该有一个setter函数：set&lt;PropertyName&gt;（驼峰命名法）</li>
<li>如上面的例子中，像ofFloat之类的工场方法，第一个参数为对象名，第二个为属性名，后面的参数为可变参数，如果values&hellip;参数只设置了一个值的话，那么会假定为目的值，属性值的变化范围为当前值到目的值，为了获得当前值，该对象要有相应属性的getter方法：get&lt;PropertyName&gt;</li>
<li>如果有getter方法，其应返回值类型应与相应的setter方法的参数类型一致。</li>
</ul>
<p>　　如果上述条件不满足，则不能用ObjectAnimator，应用ValueAnimator代替。</p>
<div class="cnblogs_code"><br><pre>tv=<span>(TextView)findViewById(R.id.textview1);<br>btn</span>=<span>(Button)findViewById(R.id.button1);<br>btn.setOnClickListener(</span><span>new</span><span> OnClickListener() {<br>　　@Override<br>　　</span><span>public</span> <span>void</span><span> onClick(View v) {<br>　　　　ObjectAnimator oa</span>=ObjectAnimator.ofFloat(tv, “alpha”<span>, 0f, 1f);<br>　　　　oa.setDuration(</span>3000<span>);<br>　　　　oa.start();<br>　　}<br>});</span></pre><br></div>

<p>　　把一个TextView的透明度在3秒内从0变至1。</p>
<p><strong>　　根据应用动画的对象或属性的不同，可能需要在onAnimationUpdate函数中调用invalidate()函数刷新视图。</strong></p>
<h2 id="3-4-通过AnimationSet应用多个动画"><a href="#3-4-通过AnimationSet应用多个动画" class="headerlink" title="3.4 通过AnimationSet应用多个动画"></a>3.4 通过AnimationSet应用多个动画</h2><p>　　AnimationSet提供了一个把多个动画组合成一个组合的机制，并可设置组中动画的时序关系，如同时播放，顺序播放等。</p>
<p>　　以下例子同时应用5个动画：</p>
<ol>
<li>播放anim1；</li>
<li>同时播放anim2,anim3,anim4；</li>
<li>播放anim5。<div class="cnblogs_code"><br><pre>AnimatorSet bouncer = <span>new</span><span> AnimatorSet();<br>bouncer.play(anim1).before(anim2);<br>bouncer.play(anim2).with(anim3);<br>bouncer.play(anim2).with(anim4)<br>bouncer.play(anim5).after(amin2);<br>animatorSet.start();</span></pre><br></div>

</li>
</ol>
<h2 id="3-5-TypeEvalutors"><a href="#3-5-TypeEvalutors" class="headerlink" title="3.5 TypeEvalutors"></a>3.5 TypeEvalutors</h2><p>　　根据属性的开始、结束值与TimeInterpolation计算出的因子计算出当前时间的属性值，android提供了以下几个evalutor：</p>
<ul>
<li>IntEvaluator：属性的值类型为int；</li>
<li>FloatEvaluator：属性的值类型为float；</li>
<li>ArgbEvaluator：属性的值类型为十六进制颜色值；</li>
<li>TypeEvaluator：一个接口，可以通过实现该接口自定义Evaluator。</li>
</ul>
<p>　　自定义TypeEvalutor很简单，只需要实现一个方法，如FloatEvalutor的定义：</p>
<div class="cnblogs_code"><br><pre><span>public</span> <span>class</span> FloatEvaluator <span>implements</span><span> TypeEvaluator {<br>    </span><span>public</span> Object evaluate(<span>float</span><span> fraction, Object startValue, Object endValue) {<br>        </span><span>float</span> startFloat =<span> ((Number) startValue).floatValue();<br>        </span><span>return</span> startFloat + fraction * (((Number) endValue).floatValue() -<span> startFloat);<br>    }<br>}</span></pre><br></div>

<p>　　根据动画执行的时间跟应用的Interplator，会计算出一个0~1之间的因子，即evalute函数中的fraction参数，通过上述FloatEvaluator应该很好看出其意思。</p>
<h2 id="3-6-TimeInterplator"><a href="#3-6-TimeInterplator" class="headerlink" title="3.6 TimeInterplator"></a>3.6 TimeInterplator</h2><p>　　Time interplator定义了属性值变化的方式，如线性均匀改变，开始慢然后逐渐快等。在Property Animation中是TimeInterplator，在View Animation中是Interplator，这两个是一样的，在3.0之前只有Interplator，3.0之后实现代码转移至了TimeInterplator。Interplator继承自TimeInterplator，内部没有任何其他代码。</p>
<ul>
<li>AccelerateInterpolator　　　　　 &nbsp; &nbsp; 加速，开始时慢中间加速</li>
<li>DecelerateInterpolator　　　 　　 &nbsp; 减速，开始时快然后减速</li>
<li>AccelerateDecelerateInterolator　 &nbsp; 先加速后减速，开始结束时慢，中间加速</li>
<li>AnticipateInterpolator　　　　　　 &nbsp;反向 ，先向相反方向改变一段再加速播放</li>
<li>AnticipateOvershootInterpolator　 &nbsp; 反向加回弹，先向相反方向改变，再加速播放，会超出目的值然后缓慢移动至目的值</li>
<li>BounceInterpolator　　　　　　　 &nbsp;跳跃，快到目的值时值会跳跃，如目的值100，后面的值可能依次为85，77，70，80，90，100</li>
<li>CycleIinterpolator　　　　　　　　 循环，动画循环一定次数，值的改变为一正弦函数：Math.sin(2 <em> mCycles </em> Math.PI * input)</li>
<li>LinearInterpolator　　　　　　　　 线性，线性均匀改变</li>
<li>OvershottInterpolator　　　　　　 &nbsp;回弹，最后超出目的值然后缓慢改变到目的值</li>
<li>TimeInterpolator　　　　　　　　 &nbsp; 一个接口，允许你自定义interpolator，以上几个都是实现了这个接口</li>
</ul>
<h2 id="3-7-当Layout改变时应用动画"><a href="#3-7-当Layout改变时应用动画" class="headerlink" title="3.7 当Layout改变时应用动画"></a>3.7 当Layout改变时应用动画</h2><p>　　ViewGroup中的子元素可以通过setVisibility使其Visible、Invisible或Gone，当有子元素可见性改变时(VISIBLE、GONE)，可以向其应用动画，通过LayoutTransition类应用此类动画：</p>
<div class="cnblogs_code"><br><pre>transition.setAnimator(LayoutTransition.DISAPPEARING, customDisappearingAnim);</pre><br></div>

<p>　　通过setAnimator应用动画，第一个参数表示应用的情境，可以以下4种类型：</p>
<ul>
<li>APPEARING　　　　　　　　当一个元素在其父元素中变为Visible时对这个元素应用动画</li>
<li>CHANGE_APPEARING　　　 当一个元素在其父元素中变为Visible时，因系统要重新布局有一些元素需要移动，对这些要移动的元素应用动画</li>
<li>DISAPPEARING　　　　　　 当一个元素在其父元素中变为GONE时对其应用动画</li>
<li>CHANGE_DISAPPEARING　 &nbsp;当一个元素在其父元素中变为GONE时，因系统要重新布局有一些元素需要移动，这些要移动的元素应用动画.</li>
</ul>
<p>　　第二个参数为一Animator。</p>
<div class="cnblogs_code"><br><pre>mTransitioner.setStagger(LayoutTransition.CHANGE_APPEARING, 30);</pre><br></div>

<p>　　此函数设置动画延迟时间，参数分别为类型与时间。</p>
<h2 id="3-8-Keyframes"><a href="#3-8-Keyframes" class="headerlink" title="3.8 Keyframes"></a>3.8 Keyframes</h2><p>　　keyFrame是一个 时间/值 对，通过它可以定义一个在特定时间的特定状态，即关键帧，而且在两个keyFrame之间可以定义不同的Interpolator，就好像多个动画的拼接，第一个动画的结束点是第二个动画的开始点。KeyFrame是抽象类，要通过ofInt(),ofFloat(),ofObject()获得适当的KeyFrame，然后通过PropertyValuesHolder.ofKeyframe获得PropertyValuesHolder对象，如以下例子：</p>
<div class="cnblogs_code"><br><pre>Keyframe kf0 = Keyframe.ofInt(0, 400<span>);<br>Keyframe kf1 </span>= Keyframe.ofInt(0.25f, 200<span>);<br>Keyframe kf2 </span>= Keyframe.ofInt(0.5f, 400<span>);<br>Keyframe kf4 </span>= Keyframe.ofInt(0.75f, 100<span>);<br>Keyframe kf3 </span>= Keyframe.ofInt(1f, 500<span>);<br>PropertyValuesHolder pvhRotation </span>= PropertyValuesHolder.ofKeyframe(“width”<span>, kf0, kf1, kf2, kf4, kf3);<br>ObjectAnimator rotationAnim </span>=<span> ObjectAnimator.ofPropertyValuesHolder(btn2, pvhRotation);<br>rotationAnim.setDuration(</span>2000);</pre><br></div>

<p>　　上述代码的意思为：设置btn对象的width属性值使其：</p>
<ul>
<li>开始时 Width=400</li>
<li>动画开始1/4时 Width=200</li>
<li>动画开始1/2时 Width=400</li>
<li>动画开始3/4时 Width=100</li>
<li>动画结束时 Width=500<div>　　第一个参数为时间百分比，第二个参数是在第一个参数的时间时的属性值。</div><br><div>　　定义了一些Keyframe后，通过PropertyValuesHolder类的方法ofKeyframe一个PropertyValuesHolder对象，然后通过ObjectAnimator.ofPropertyValuesHolder获得一个Animator对象。</div><br><div>　　用下面的代码可以实现同样的效果（上述代码时间值是线性，变化均匀）：</div><br><div><br><div class="cnblogs_code"><br><pre>ObjectAnimator oa=ObjectAnimator.ofInt(btn2, “width”, 400,200,400,100,500);<br>oa.setDuration(2000);<br>oa.start();</pre><br></div><br></div>

</li>
</ul>
<h2 id="3-9-Animating-Views"><a href="#3-9-Animating-Views" class="headerlink" title="3.9 Animating Views"></a>3.9 Animating Views</h2><p>　　在View Animation中，对View应用Animation并没有改变View的属性，动画的实现是通过其Parent View实现的，在View被drawn时Parents View改变它的绘制参数，draw后再改变参数invalidate，这样虽然View的大小或旋转角度等改变了，但View的实际属性没变，所以有效区域还是应用动画之前的区域，比如你把一按钮放大两倍，但还是放大这前的区域可以触发点击事件。为了改变这一点，在Android 3.0中给View增加了一些参数并对这些参数增加了相应的getter/setter函数（ObjectAnimator要用这些函数改变这些属性）：</p>
<ul>
<li>translationX,translationY: View相对于原始位置的偏移量</li>
<li>rotation,rotationX,rotationY: 旋转，rotation用于2D旋转角度，3D中用到后两个</li>
<li>scaleX,scaleY: 缩放比</li>
<li>x,y: View的最终坐标，是View的left，top位置加上translationX，translationY</li>
<li>alpha: 透明度<div>　　跟位置有关的参数有3个，以X坐标为例，可以通过getLeft(),getX(),getTranslateX()获得，若有一Button btn2，布局时其坐标为（40,0）：</div><br><div><br><div class="cnblogs_code"><br><pre><span>//</span><span>应用动画之前</span><span><br></span>btn2.getLeft();    <span>//</span><span>40</span><span><br></span>btn2.getX();    <span>//</span><span>40</span><span><br></span>btn2.getTranslationX();    <span>//</span><span>0<br></span><span>//</span><span>应用translationX动画</span><span><br></span>ObjectAnimator oa=ObjectAnimator.ofFloat(btn2,”translationX”, 200);<br>oa.setDuration(2000);<br>oa.start();<br><span>/<em></em></span><span>应用translationX动画后<br>btn2.getLeft();    //40<br>btn2.getX();    //240<br>btn2.getTranslationX();    //200<br></span><span>/</span><br><span>//</span><span>应用X动画，假设没有应用之前的translationX动画</span><span><br></span>ObjectAnimator oa=ObjectAnimator.ofFloat(btn2, “x”, 200);<br>oa.setDuration(2000);<br>oa.start();<br><span>/<em></em></span><span>应用X动画后<br>btn2.getLeft();    //40<br>btn2.getX();    //200<br>btn2.getTranslationX();    //160<br></span><span>/</span></pre><br></div><br></div><br><div>　　无论怎样应用动画，原来的布局时的位置通过getLeft()获得，保持不变；</div><br><div>　　X是View最终的位置；</div><br><div>　　translationX为最终位置与布局时初始位置这差。</div><br><div>　　所以若就用translationX即为在原来基础上移动多少，X为最终多少</div><br><div>　　getX()的值为getLeft()与getTranslationX()的和</div><br><div>　　对于X动画，源代码是这样的：</div><br><div><br><div class="cnblogs_code"><br><pre><span>case</span> X:<br>   info.mTranslationX = value - mView.mLeft;<br>   <span>break</span>;</pre><br></div><br></div>

</li>
</ul>
<p>　　Property Animation也可以在XML中定义</p>
<ul>
<li>&lt;set&gt; - AnimatorSet</li>
<li>&lt;animator&gt; -&nbsp;ValueAnimator</li>
<li>&lt;objectAnimator&gt; -&nbsp;ObjectAnimator<div>　　XML文件应放大/res/animator/中，通过以下方式应用动画：</div><br><div><br><div class="cnblogs_code"><br><pre>AnimatorSet set = (AnimatorSet) AnimatorInflater.loadAnimator(myContext, R.anim.property_animator);<br>set.setTarget(myObject);<br>set.start();</pre><br></div><br></div>

</li>
</ul>
<h2 id="3-10-ViewPropertyAnimator"><a href="#3-10-ViewPropertyAnimator" class="headerlink" title="3.10 ViewPropertyAnimator"></a>3.10 ViewPropertyAnimator</h2><p>　　如果需要对一个View的多个属性进行动画可以用ViewPropertyAnimator类，该类对多属性动画进行了优化，会合并一些invalidate()来减少刷新视图，该类在3.1中引入。</p>
<p>　　以下两段代码实现同样的效果：　</p>
<div class="cnblogs_code"><br><pre>PropertyValuesHolder pvhX = PropertyValuesHolder.ofFloat(“x”, 50f);<br>PropertyValuesHolder pvhY = PropertyValuesHolder.ofFloat(“y”, 100f);<br>ObjectAnimator.ofPropertyValuesHolder(myView, pvhX, pvyY).start();</pre><br></div><br><div class="cnblogs_code"><br><pre>myView.animate().x(50f).y(100f);</pre><br></div>

<p>&nbsp;</p>
<p>作者：AngelDevil<br>出处：www.cnblogs.com/angeldevil</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> property animation </tag>
            
            <tag> animation </tag>
            
            <tag> animator </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]AndroidBucket增加碎片SubLayout功能及AISubLayout的注解支持]]></title>
      <url>/2014/05/05/Android-AndroidBucket%E5%A2%9E%E5%8A%A0%E7%A2%8E%E7%89%87SubLayout%E5%8A%9F%E8%83%BD%E5%8F%8AAISubLayout%E7%9A%84%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81/</url>
      <content type="html"><![CDATA[<p>之前写过一篇博客，是使用Fragment来实现TabHost的效果，并且模拟TabHost的切换各个fragment生命周期的调用，见<a href="http://www.cnblogs.com/tiantianbyconan/p/3360938.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/3360938.html</a></p>
<p>但是如果要实现的效果是两级的Tab，比如在第一级tab中又有三个子Tab切换不同的布局，</p>
<p>相当于在Fragment中嵌套来Fragment，这个怎么实现？</p>
<p>也有个官方的实现方法，通过使用<span>android-support-v13.jar包中的<span>getChildFragmentManager方法来获取一个Manager。</span></span></p>
<p>这里带来我写的一个新的方案，使用SubLayout来实现。</p>
<p>相关源码：<a href="https://github.com/wangjiegulu/AndroidBucket/tree/master/src/com/wangjie/androidbucket/customviews/sublayout" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/tree/master/src/com/wangjie/androidbucket/customviews/sublayout</a></p>
<p>下面使用一个例子来说下使用方法，先看下最后的效果（项目使用了我的开源<strong><a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">AndroidBucket</a></strong>和<strong><a href="https://github.com/wangjiegulu/androidInject" target="_blank" rel="noopener">AndroidInject</a>&nbsp;请先添加依赖项目，欢迎star／fork</strong>）：</p>
<p><img src="http://images.cnitblog.com/i/378300/201405/051955327296296.png" alt=""></p>
<p>效果跟以前的例子大同小异，点击第一个tab上的TextView，然后Toast提示EditText上的信息，但是使用方式却是不一样的。</p>
<p>大体的思路是在MainActivity布局中增加一个FrameLayout，然后在切换过程中不停的用相应的布局去替换FrameLayout中。</p>
<p>main.xml布局如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><br><span style="color: #008080;"> 3</span> <span style="color: #ff0000;">              android:orientation</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">              android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">              android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">FrameLayout<br></span><span style="color: #008080;"> 9</span>             <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/main_content_view”</span><br><span style="color: #008080;">10</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">11</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”0dp”</span><br><span style="color: #008080;">12</span> <span style="color: #ff0000;">            android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span><br><span style="color: #008080;">13</span>             <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioGroup<br></span><span style="color: #008080;">16</span>             <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/main_tabs_rg”</span><br><span style="color: #008080;">17</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">18</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”65dp”</span><br><span style="color: #008080;">19</span> <span style="color: #ff0000;">            android:background</span><span style="color: #0000ff;">=”#aabbcc”</span><br><span style="color: #008080;">20</span> <span style="color: #ff0000;">            android:gravity</span><span style="color: #0000ff;">=”center_vertical”</span><br><span style="color: #008080;">21</span> <span style="color: #ff0000;">            android:orientation</span><span style="color: #0000ff;">=”horizontal”</span> <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;">24</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/main_tab_a_rb”</span><br><span style="color: #008080;">25</span> <span style="color: #ff0000;">                style</span><span style="color: #0000ff;">=”@style/tab_item_background”</span><br><span style="color: #008080;">26</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/ic_launcher”</span><br><span style="color: #008080;">27</span> <span style="color: #ff0000;">                android:paddingTop</span><span style="color: #0000ff;">=”7dp”</span><br><span style="color: #008080;">28</span> <span style="color: #ff0000;">                android:textSize</span><span style="color: #0000ff;">=”13sp”</span><br><span style="color: #008080;">29</span> <span style="color: #ff0000;">                android:checked</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;">30</span>                 <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">31</span><br><span style="color: #008080;">32</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;">33</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/main_tab_b_rb”</span><br><span style="color: #008080;">34</span> <span style="color: #ff0000;">                style</span><span style="color: #0000ff;">=”@style/tab_item_background”</span><br><span style="color: #008080;">35</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/ic_launcher”</span><br><span style="color: #008080;">36</span> <span style="color: #ff0000;">                android:paddingTop</span><span style="color: #0000ff;">=”7dp”</span><br><span style="color: #008080;">37</span> <span style="color: #ff0000;">                android:textSize</span><span style="color: #0000ff;">=”13sp”</span><br><span style="color: #008080;">38</span>                 <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">39</span><br><span style="color: #008080;">40</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;">41</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/main_tab_c_rb”</span><br><span style="color: #008080;">42</span> <span style="color: #ff0000;">                style</span><span style="color: #0000ff;">=”@style/tab_item_background”</span><br><span style="color: #008080;">43</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/ic_launcher”</span><br><span style="color: #008080;">44</span> <span style="color: #ff0000;">                android:paddingTop</span><span style="color: #0000ff;">=”7dp”</span><br><span style="color: #008080;">45</span> <span style="color: #ff0000;">                android:textSize</span><span style="color: #0000ff;">=”13sp”</span><br><span style="color: #008080;">46</span>                 <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">47</span><br><span style="color: #008080;">48</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">RadioGroup</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">49</span><br><span style="color: #008080;">50</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>布局很简单，一个FrameLayout用于存放不同界面的布局，3个RadioButton表示下面的每一项Tab按钮。</p>
<p>在MainActivity中代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #000000;">@AILayout(R.layout.main)<br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> AIActivity {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = MainActivity.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br><br>    @AIView(R.id.main_content_view)<br>    ViewGroup contentView;<br><br>    @AIView(R.id.main_tabs_rg)<br>    RadioGroup rg;<br><br>    SubLayoutManager sbManager;<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br>        </span><span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br><br>        sbManager </span>= <span style="color: #0000ff;">new</span> SubLayoutManager&lt;SubLayout&gt;(context, contentView, TabASubLayout.<span style="color: #0000ff;">class</span>, TabBSubLayout.<span style="color: #0000ff;">class</span>, TabCSubLayout.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br><br>        sbManager.setSwitchListener(</span><span style="color: #0000ff;">new</span> SubLayoutManager.LayoutSwitchListener&lt;SubLayout&gt;<span style="color: #000000;">() {<br>            @Override<br>            </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> switchSelf(SubLayout subLayout, <span style="color: #0000ff;">int</span><span style="color: #000000;"> position) {<br>                Logger.d(TAG, </span>“[switch listener]switchSelf, subLayout: “ + subLayout + “, position: “ +<span style="color: #000000;"> position);<br>            }<br><br>            @Override<br>            </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> switchCompleted(SubLayout subLayout, <span style="color: #0000ff;">int</span><span style="color: #000000;"> position) {<br>                Logger.d(TAG, </span>“[switch listener]switchCompleted, subLayout: “ + subLayout + “, position: “ +<span style="color: #000000;"> position);<br>            }<br>        });<br><br>        rg.setOnCheckedChangeListener(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> RadioGroup.OnCheckedChangeListener() {<br>            @Override<br>            </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCheckedChanged(RadioGroup radioGroup, <span style="color: #0000ff;">int</span><span style="color: #000000;"> i) {<br>                </span><span style="color: #0000ff;">int</span> index = -1<span style="color: #000000;">;<br>                </span><span style="color: #0000ff;">switch</span><span style="color: #000000;">(i){<br>                    </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.main_tab_a_rb:<br>                        index </span>= 0<span style="color: #000000;">;<br>                        </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br><br>                    </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.main_tab_b_rb:<br>                        index </span>= 1<span style="color: #000000;">;<br>                        </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br><br>                    </span><span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.main_tab_c_rb:<br>                        index </span>= 2<span style="color: #000000;">;<br>                        </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br>                }<br>                </span><span style="color: #0000ff;">if</span>(index &lt; 0 || index &gt;=<span style="color: #000000;"> sbManager.getSubLayoutSize()){<br>                    </span><span style="color: #0000ff;">return</span><span style="color: #000000;">;<br>                }<br>                sbManager.switchLayout(index);<br>            }<br>        });<br><br>        sbManager.switchLayout(</span>0); <span style="color: #008000;">//</span><span style="color: #008000;"> 默认切换第一页</span><br><span style="color: #000000;"><br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDestroy() {<br>        </span><span style="color: #0000ff;">super</span><span style="color: #000000;">.onDestroy();<br>        sbManager.destoryClear();<br>        sbManager </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br><br>    }<br><br>}</span></pre><br></div>

<p>上面的SubLayout相当于一个Fragment，SubLayoutManager用于管理多个SubLayout之间的切换。SubLayoutManager可以通过new获取。</p>
<p>其中构造方法中：</p>
<p>public SubLayoutManager(Context context, ViewGroup contentView, Class&lt;? extends T&gt;… slszzs) {</p>
<p>参数二：contentView表示在MainActivity中预留给SubLayout显示的FrameLayout。</p>
<p>参数三：是个可变长参数，可以在后面（有序）追加所有需要切换的SubLayout的Class对象。</p>
<p>第一次初始化后各个SubLayout对象不会马上生成，只会在切换到改页面时才会生成该对象，会执行SubLayout的initLayout()方法，这个方法只会调用一次（类似onCreate()方法）</p>
<p>需要切换页面时只需要执行SubLayoutManager的switchLayout()方法，传入SubLayout的position就可以了，这个position跟参数三的顺序一致。</p>
<p>&nbsp;</p>
<p>接下来看下几个SubLayout是怎么去实现的，因为三个SubLayout大致相同，所以只分析一个就可以了：</p>
<p>TabASubLayout代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">@AILayout(R.layout.tab_a)<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TabASubLayout <span style="color: #0000ff;">extends</span><span style="color: #000000;"> AISubLayout {<br></span><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = TabASubLayout.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span> <span style="color: #008000;">//</span><span style="color: #008000;">    @AIView(R.id.tab_a_tv)<br></span><span style="color: #008080;"> 7</span> <span style="color: #008000;">//</span><span style="color: #008000;">    TextView tv;</span><br><span style="color: #008080;"> 8</span> <span style="color: #000000;">    @AIView(R.id.tab_a_et)<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    EditText et;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> TabASubLayout(Context context) {<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;">13</span> <span style="color: #008000;">//</span><span style="color: #008000;">        setContentView(R.layout.tab_a);</span><br><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">18</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> initLayout() {<br></span><span style="color: #008080;">19</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.initLayout();<br></span><span style="color: #008080;">20</span>         Logger.d(TAG, “initLayout…”<span style="color: #000000;">);<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> <span style="color: #000000;">    @AIClick({R.id.tab_a_tv})<br></span><span style="color: #008080;">24</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClickCallbackSample(View view) {<br></span><span style="color: #008080;">25</span>         Toast.makeText(context, “clicked: “ + ((TextView)view).getText() + “, “ +<span style="color: #000000;"> et.getText(), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">27</span><br><span style="color: #008080;">28</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">29</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onResume() {<br></span><span style="color: #008080;">30</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onResume();<br></span><span style="color: #008080;">31</span>         Logger.d(TAG, “onResume…”<span style="color: #000000;">);<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">35</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPause() {<br></span><span style="color: #008080;">36</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPause();<br></span><span style="color: #008080;">37</span>         Logger.d(TAG, “onPause…”<span style="color: #000000;">);<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">39</span><br><span style="color: #008080;">40</span> }</pre><br></div>

<p>代码很简单，继承AISubLayout即可，AISubLayout是AndroidInject中AndroidBucket的子类，实现了SubLayout的注解的支持。当然你也可以直接继承SubLayout，这样的话就不能使用注解了，看上面的被注释的代码，可以通过setContentView来设置对应的布局，可以通过findViewById来获取控件对象。</p>
<p>它也有onResume和onPause方法，当前页A被切换到B的话会调用A的onPause，然后调用B的onResume（如果之前B没有被初始化过，则先调用initLayout再调用onResume方法）</p>
<p>下面来看看log打印的日志：</p>
<p>&nbsp;</p>
<p>// 以下为启动应用，默认加载TabA</p>
<p><em>05-05 08:22:32.216 1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ —–switch start———————–<br>05-05 08:22:32.216    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ switch before………: [DelayObj{clazz=class com.wangjie.sublayouttest.TabASubLayout, delayObj=null}, DelayObj{clazz=class com.wangjie.sublayouttest.TabBSubLayout, delayObj=null}, DelayObj{clazz=class com.wangjie.sublayouttest.TabCSubLayout, delayObj=null}]<br>05-05 08:22:32.336    1086-1086/com.wangjie.sublayouttest D/TabASubLayout﹕ initLayout…<br>05-05 08:22:32.336    1086-1086/com.wangjie.sublayouttest D/TabASubLayout﹕ onResume…<br>05-05 08:22:32.336    1086-1086/com.wangjie.sublayouttest D/MainActivity﹕ [switch listener]switchCompleted, subLayout: com.wangjie.sublayouttest.TabASubLayout@b4dff088, position: 0<br>05-05 08:22:32.336    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ switch after………: [DelayObj{clazz=class com.wangjie.sublayouttest.TabASubLayout, delayObj=com.wangjie.sublayouttest.TabASubLayout@b4dff088}, DelayObj{clazz=class com.wangjie.sublayouttest.TabBSubLayout, delayObj=null}, DelayObj{clazz=class com.wangjie.sublayouttest.TabCSubLayout, delayObj=null}]<br>05-05 08:22:32.336    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ —–switch end———————–</em></p>
<p><em><br>// TabA切换到TabB<br>05-05 08:22:37.926    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ —–switch start———————–<br>05-05 08:22:37.926    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ switch before………: [DelayObj{clazz=class com.wangjie.sublayouttest.TabASubLayout, delayObj=com.wangjie.sublayouttest.TabASubLayout@b4dff088}, DelayObj{clazz=class com.wangjie.sublayouttest.TabBSubLayout, delayObj=null}, DelayObj{clazz=class com.wangjie.sublayouttest.TabCSubLayout, delayObj=null}]<br>05-05 08:22:37.946    1086-1086/com.wangjie.sublayouttest D/TabASubLayout﹕ onPause…<br>05-05 08:22:37.986    1086-1086/com.wangjie.sublayouttest D/TabBSubLayout﹕ initLayout…<br>05-05 08:22:37.996    1086-1086/com.wangjie.sublayouttest D/TabBSubLayout﹕ onResume…<br>05-05 08:22:37.996    1086-1086/com.wangjie.sublayouttest D/MainActivity﹕ [switch listener]switchCompleted, subLayout: com.wangjie.sublayouttest.TabBSubLayout@b4de1d80, position: 1<br>05-05 08:22:37.996    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ switch after………: [DelayObj{clazz=class com.wangjie.sublayouttest.TabASubLayout, delayObj=com.wangjie.sublayouttest.TabASubLayout@b4dff088}, DelayObj{clazz=class com.wangjie.sublayouttest.TabBSubLayout, delayObj=com.wangjie.sublayouttest.TabBSubLayout@b4de1d80}, DelayObj{clazz=class com.wangjie.sublayouttest.TabCSubLayout, delayObj=null}]<br>05-05 08:22:37.996    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ —–switch end———————–</em></p>
<p><em><br>// TabB切换到TabC<br>05-05 08:22:41.486    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ —–switch start———————–<br>05-05 08:22:41.486    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ switch before………: [DelayObj{clazz=class com.wangjie.sublayouttest.TabASubLayout, delayObj=com.wangjie.sublayouttest.TabASubLayout@b4dff088}, DelayObj{clazz=class com.wangjie.sublayouttest.TabBSubLayout, delayObj=com.wangjie.sublayouttest.TabBSubLayout@b4de1d80}, DelayObj{clazz=class com.wangjie.sublayouttest.TabCSubLayout, delayObj=null}]<br>05-05 08:22:41.496    1086-1086/com.wangjie.sublayouttest D/TabBSubLayout﹕ onPause…<br>05-05 08:22:41.516    1086-1086/com.wangjie.sublayouttest D/TabCSubLayout﹕ initLayout…<br>05-05 08:22:41.516    1086-1086/com.wangjie.sublayouttest D/TabCSubLayout﹕ onResume…<br>05-05 08:22:41.516    1086-1086/com.wangjie.sublayouttest D/MainActivity﹕ [switch listener]switchCompleted, subLayout: com.wangjie.sublayouttest.TabCSubLayout@b4e17840, position: 2<br>05-05 08:22:41.516    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ switch after………: [DelayObj{clazz=class com.wangjie.sublayouttest.TabASubLayout, delayObj=com.wangjie.sublayouttest.TabASubLayout@b4dff088}, DelayObj{clazz=class com.wangjie.sublayouttest.TabBSubLayout, delayObj=com.wangjie.sublayouttest.TabBSubLayout@b4de1d80}, DelayObj{clazz=class com.wangjie.sublayouttest.TabCSubLayout, delayObj=com.wangjie.sublayouttest.TabCSubLayout@b4e17840}]<br>05-05 08:22:41.526    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ —–switch end———————–</em></p>
<p>&nbsp;</p>
<p>_// TabC切换到TabA<br>05-05 08:22:44.086    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ —–switch start———————–<br>05-05 08:22:44.086    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ switch before………: [DelayObj{clazz=class com.wangjie.sublayouttest.TabASubLayout, delayObj=com.wangjie.sublayouttest.TabASubLayout@b4dff088}, DelayObj{clazz=class com.wangjie.sublayouttest.TabBSubLayout, delayObj=com.wangjie.sublayouttest.TabBSubLayout@b4de1d80}, DelayObj{clazz=class com.wangjie.sublayouttest.TabCSubLayout, delayObj=com.wangjie.sublayouttest.TabCSubLayout@b4e17840}]<br>05-05 08:22:44.086    1086-1086/com.wangjie.sublayouttest D/TabCSubLayout﹕ onPause…<br>05-05 08:22:44.136    1086-1086/com.wangjie.sublayouttest D/TabASubLayout﹕ onResume…<br>05-05 08:22:44.136    1086-1086/com.wangjie.sublayouttest D/MainActivity﹕ [switch listener]switchCompleted, subLayout: com.wangjie.sublayouttest.TabASubLayout@b4dff088, position: 0<br>05-05 08:22:44.136    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ switch after………: [DelayObj{clazz=class com.wangjie.sublayouttest.TabASubLayout, delayObj=com.wangjie.sublayouttest.TabASubLayout@b4dff088}, DelayObj{clazz=class com.wangjie.sublayouttest.TabBSubLayout, delayObj=com.wangjie.sublayouttest.TabBSubLayout@b4de1d80}, DelayObj{clazz=class com.wangjie.sublayouttest.TabCSubLayout, delayObj=com.wangjie.sublayouttest.TabCSubLayout@b4e17840}]<br>05-05 08:22:44.136    1086-1086/com.wangjie.sublayouttest D/SubLayoutManager﹕ —–switch end———————–</p>
<p>_</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android bucket </tag>
            
            <tag> annotations </tag>
            
            <tag> library </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[关于Android 的内存泄露及分析]]></title>
      <url>/2014/04/22/%E5%85%B3%E4%BA%8EAndroid-%E7%9A%84%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E5%8F%8A%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<p>一、 Android的内存机制<br>Android的程序由Java语言编写，所以Android的内存管理与Java的内存管理相似。程序员通过new为对象分配内存，所有对象在java堆内分配空间；然而对象的释放是由垃圾回收器来完成的.<br>那么GC怎么能够确认某一个对象是不是已经被废弃了呢？Java采用了有向图的原理。Java将引用关系考虑为图的有向边，有向边从引用者指向引用对象。线程对象可以作为有向图的起始顶点，该图就是从起始顶点开始的一棵树，根顶点可以到达的对象都是有效对象，GC不会回收这些对象。如果某个对象 (连通子图)与这个根顶点不可达(注意，该图为有向图)，那么我们认为这个(这些)对象不再被引用，可以被GC回收。</p>
<p>二、Android的内存溢出</p>
<p>1、内存泄露导致</p>
<p>由于我们程序的失误，长期保持某些资源（如Context）的引用，造成内存泄露，资源造成得不到释放。&nbsp;</p>
<p>Android 中常见就是Activity 被引用没有在调用finish之后却没有释放，第二次打开activity 又重新创建，这样的内存泄露则会导致内存的溢出。<br>2、占用内存较多的对象</p>
<p>&nbsp;保存了多个耗用内存过大的对象（如Bitmap）或加载单个超大的图片，造成内存超出限制。</p>
<p>三、常见的内存泄漏<br><span>1.万恶的static</span><br>&nbsp; static是Java中的一个关键字，当用它来修饰成员变量时，那么该变量就属于该类，而不是该类的实例。</p>
<p>&nbsp;&nbsp;&nbsp; private static Activity mContext;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //省略&nbsp;</p>
<p>&nbsp;如何才能有效的避免这种引用的发生呢？</p>
<p>&nbsp;&nbsp;&nbsp; 第一，应该尽量避免static成员变量引用资源耗费过多的实例，比如Context。</p>
<p>&nbsp;&nbsp;&nbsp; 第二、Context尽量使用Application Context，因为Application的Context的生命周期比较长，引用它不会出现内存泄露的问题。</p>
<p>&nbsp;&nbsp;&nbsp; 第三、使用WeakReference代替强引用。比如可以使用WeakReference&lt;Context&gt; mContextRef;</p>
<p><span>2.线程惹的祸</span><br>线程也是造成内存泄露的一个重要的源头。线程产生内存泄露的主要原因在于线程生命周期的不可控。我们来考虑下面一段代码。</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MyActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Activity {<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">@Override<br></span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 4</span>   <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">  setContentView(R.layout.main);<br></span><span style="color: #008080;"> 6</span>   <span style="color: #0000ff;">new</span><span style="color: #000000;"> MyThread().start();<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">class</span> MyThread <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Thread{<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">@Override<br></span><span style="color: #008080;">10</span>   <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;">11</span>   <span style="color: #0000ff;">super</span><span style="color: #000000;">.run();<br></span><span style="color: #008080;">12</span>   <span style="color: #008000;">//</span><span style="color: #008000;">do somthing         </span><br><span style="color: #008080;">13</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">15</span> }  </pre><br></div>

<p><span>我们思考一个问题：假设MyThread的run函数是一个很费时的操作，当调用finish的时候Activity 会销毁掉吗？</span></p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp;事实上由于我们的线程是Activity的内部类，所以MyThread中保存了Activity的一个引用，当MyThread的run函数没有结束时，MyThread是不会被销毁的，因此它所引用的老的Activity也不会被销毁，因此就出现了内存泄露的问题。</p>
<p>&nbsp;</p>
<p><span><strong>解决方案</strong></span></p>
<p>&nbsp;&nbsp;&nbsp; 第一、将线程的内部类，改为静态内部类。</p>
<p>&nbsp;&nbsp;&nbsp; 第二、如果需要引用Acitivity，使用弱引用。<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; 另外在使用handler 的时候， 尤其用到循环调用的时候，在Activity 退出的时候注意移除。否则也会导致泄露</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> ThreadDemo <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Activity {<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “ThreadDemo”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> count = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">private</span> Handler mHandler =  <span style="color: #0000ff;">new</span><span style="color: #000000;"> Handler();<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">private</span> Runnable mRunnable = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable() {<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;"> 9</span>             <span style="color: #008000;">//</span><span style="color: #008000;">为了方便 查看，我们用Log打印出来   </span><br><span style="color: #008080;">10</span>             Log.e(TAG, Thread.currentThread().getName() + “ “ +<span style="color: #000000;">count);<br></span><span style="color: #008080;">11</span>             <span style="color: #008000;">//</span><span style="color: #008000;">每2秒执行一次   </span><br><span style="color: #008080;">12</span>             mHandler.postDelayed(mRunnable, 2000<span style="color: #000000;">);<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">    };<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">        setContentView(R.layout.main);<br></span><span style="color: #008080;">19</span>         <span style="color: #008000;">//</span><span style="color: #008000;">通过Handler启动线程   </span><br><span style="color: #008080;">20</span> <span style="color: #000000;">        mHandler.post(mRunnable);<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">24</span> <span style="color: #008000;">//</span><span style="color: #008000;">所以我们在应用退出时，要将线程销毁，我们只要在Activity中的，onDestory()方法处理一下就OK了，如下代码所示:</span><br><span style="color: #008080;">25</span> <span style="color: #000000;">@Override<br></span><span style="color: #008080;">26</span>   <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDestroy() {<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">    mHandler.removeCallbacks(mRunnable);<br></span><span style="color: #008080;">28</span>     <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDestroy();<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">  }<br></span><span style="color: #008080;">30</span>  </pre><br></div>

<p><span>3.Bitmap</span><br>可以说出现OutOfMemory问题的绝大多数人，都是因为Bitmap的问题。因为Bitmap占用的内存实在是太多了，特别是分辨率大的图片，如果要显示多张那问题就更显著了。</p>
<p>&nbsp;&nbsp;&nbsp; 解决方案：</p>
<p>&nbsp;&nbsp;&nbsp; 第一、及时的销毁。</p>
<p>&nbsp;&nbsp;&nbsp; 虽然，系统能够确认Bitmap分配的内存最终会被销毁，但是由于它占用的内存过多，所以很可能会超过java堆的限制。因此，在用完Bitmap时，要及时的recycle掉。recycle并不能确定立即就会将Bitmap释放掉，但是会给虚拟机一个暗示：&ldquo;该图片可以释放了&rdquo;。</p>
<p>&nbsp;&nbsp;&nbsp; 第二、设置一定的采样率。</p>
<p>&nbsp;&nbsp;&nbsp; 有时候，我们要显示的区域很小，没有必要将整个图片都加载出来，而只需要记载一个缩小过的图片，这时候可以设置一定的采样率，那么就可以大大减小占用的内存。如下面的代码：</p>
<p>private ImageView preview;&nbsp;&nbsp;</p>
<p>BitmapFactory.Options options = new BitmapFactory.Options();&nbsp;&nbsp;</p>
<p>options.inSampleSize = 2;//图片宽高都为原来的二分之一，即图片为原来的四分之一&nbsp;&nbsp;</p>
<p>Bitmap bitmap = BitmapFactory.decodeStream(cr.openInputStream(uri), null, options);&nbsp; preview.setImageBitmap(bitmap);&nbsp;</p>
<p>第三、巧妙的运用软引用（SoftRefrence）</p>
<p>&nbsp;&nbsp;&nbsp; 有些时候，我们使用Bitmap后没有保留对它的引用，因此就无法调用Recycle函数。这时候巧妙的运用软引用，可以使Bitmap在内存快不足时得到有效的释放。<br>&nbsp;&nbsp;</p>
<p><span>4.行踪诡异的Cursor</span></p>
<p>&nbsp;&nbsp;&nbsp; Cursor是Android查询数据后得到的一个管理数据集合的类，正常情况下，如果查询得到的数据量较小时不会有内存问题，而且虚拟机能够保证Cusor最终会被释放掉。</p>
<p>&nbsp;&nbsp;&nbsp; 然而如果Cursor的数据量特表大，特别是如果里面有Blob信息时，应该保证Cursor占用的内存被及时的释放掉，而不是等待GC来处理。并且Android明显是倾向于编程者手动的将Cursor close掉</p>
<p>&nbsp; 而且android数据库中对Cursor资源的是又限制个数的，如果不及时close掉，会导致别的地方无法获得<br>&nbsp;&nbsp;&nbsp;&nbsp;<br><span>5.构造Adapter时，没有使用缓存的 convertView&nbsp;</span><br>&nbsp; 以构造ListView的BaseAdapter为例，在BaseAdapter中提高了方法：<br>&nbsp; &nbsp;public View getView(int position, View convertView, ViewGroup parent)</p>
<p>&nbsp; AdapterView 在使用View会有一个循环的View队列的，把不显示的View重新投入使用，所以在<span>convertView不为空的时候，不要直接创建新的View</span></p>
<p>小结:</p>
<p>static:引用了大对象如context</p>
<p>线程：切屏时Activity因为线程引用而没有如期被销毁；handler有关，Activity意外终止但线程还在</p>
<p>Bitmap:要及时recycle,降低采样率</p>
<p>Cursor:要及时关闭</p>
<p>Adapter:没有使用缓存的convertView</p>
<p>&nbsp;</p>
<p>四、内存泄漏调试:<br>(1).内存监测工具 DDMS –&gt; Heap<br>&nbsp;用 Heap监测应用进程使用内存情况的步骤如下：<br>&nbsp; &nbsp; &nbsp; 1. 切换到DDMS透视图，并确认Devices视图、Heap视图都是打开的；<br>&nbsp; &nbsp; &nbsp; 2. 正常与手机链接成功后，在DDMS的Devices视图中将会显示手机设备的序列号，以及设备中正在运行的部分进程信息；<br>&nbsp; &nbsp; &nbsp; 3. 点击选中想要监测的进程<br>&nbsp; &nbsp; &nbsp; 4. 点击选中Devices视图界面中最上方一排图标中的&ldquo;Update Heap&rdquo;图标；<br>&nbsp; &nbsp; &nbsp; 5. 点击Heap视图中的&ldquo;Cause GC&rdquo;按钮；<br>&nbsp; &nbsp; &nbsp; 6. 此时在Heap视图中就会看到当前选中的进程的内存使用量的详细情况。<br>&nbsp; &nbsp;Heap视图界面会定时刷新，在对应用的不断的操作过程中就可以看到内存使用的变化；<br>&nbsp; 如何才能知道我们的程序是否有内存泄漏的可能性呢。这里需要注意一个值：Heap视图中部有一个Type叫做data object，即数据对象，也就是我们的程序中大量存在的类类型的对象。在data object一行中有一列是&ldquo;Total Size&rdquo;，其值就是当前进程中所有Java数据对象的内存总量，一般情况下，这个值的大小决定了是否会有内存泄漏。可以这样判断：<br>&nbsp; &nbsp;a) 不断的操作当前应用，同时注意观察data object的Total Size值；<br>&nbsp; &nbsp;b) 正常情况下Total Size值都会稳定在一个有限的范围内，也就是说由于程序中的的代码良好，没有造成对象不被垃圾回收的情况，所以说 &nbsp;虽然我们不断的操作会不断的生成很多对象，而在虚拟机不断的进行GC的过程中，这些对象都被回收了，内存占用量会会落到一个稳定的水平；<br>&nbsp; &nbsp; c) 反之如果代码中存在没有释放对象引用的情况，则data object的Total Size值在每次GC后不会有明显的回落，随着操作次数的增多Total Size的值会越来越大，</p>
<p><span>(2)</span><span>内存分析工具 MAT(Memory Analyzer Tool)</span><br><span>&nbsp; 这里介绍一个极好的内存分析工具 – Memory Analyzer Tool(MAT)。</span><br><span>&nbsp;&nbsp;MAT是一个Eclipse插件，同时也有单独的RCP客户端。官方下载地址、MAT介绍和详细的使用教程请参见：</span><a href="http://www.eclipse.org/mat" target="_blank" rel="noopener">www.eclipse.org/mat</a><span>，在此不进行说明了。另外在MAT安装后的帮助文档里也有完备的使用教程。在此仅举例说明其使用方法。我自己使用的是MAT的eclipse插件，使用插件要比RCP稍微方便一些。插件安装成功后，分析步骤（安装方法有多重，大家随便）</span><br><span>&nbsp;</span><br><span>&nbsp; &nbsp;(a) 生成.hprof文件</span><br><span>&nbsp;&nbsp;</span><br><span>&nbsp; &nbsp; &nbsp; 1. 打开eclipse并切换到DDMS</span><br><span>&nbsp; &nbsp; &nbsp; 2. 点击选中想要分析的应用的进程，在Devices视图上方的一行图标按钮中，选中&ldquo;Update Heap&rdquo;。</span><br><span>&nbsp; &nbsp; &nbsp; 3. 当内存你感觉异常的时候，按下&ldquo;Dump HPROF file&rdquo;按钮，这个时候会提示设置hprof文件的保存路径。</span><br><span>(二) 使用MAT导入.hprof文件</span><br><span>&nbsp; &nbsp; &nbsp;1. 通过</span><span>/ANDROID_SDK/tools目录下的hprof-conv.exe工具（使用命令同adb），输入命令hprof-conv xxx.hprof yyy.hprof，其中xxx.hprof为原始文件，yyy.hprof为转换过后的文件。</span><br><span>&nbsp; &nbsp; 2. 在Eclipse中点击Windows-&gt;Open Perspective-&gt;Other-&gt;Memory Analysis perspective界面。在MAT中点击File-&gt;Open File，浏览并导入刚刚 转换而得到的.hprof文件。</span><br><span>(三) 使用MAT的视图工具分析内存</span><br><span>&nbsp;&nbsp;导入.hprof文件以后，MAT会自动解析并生成报告，报告中会列出使用内存过多或者初始化的实例过多的类。</span></p>
<p><span>&nbsp;点击Dominator Tree，并按Package分组，选择报告中提到的可疑实例的类，在弹出菜单中选择List objects-&gt;With incoming references。这时会列出所有可疑类，右键点击某一项，并选择Path to GC Roots -&gt; exclude weak/soft references，会进一步筛选出跟程序相关的所有有内存泄露的类。据此，可以追踪到代码中的某一个产生泄露的类。</span><br><span><span>&nbsp;</span><span>&nbsp; 主要是看可疑类的引用是因为什么代码的引用而导致无法释放的</span></span><br><span>&nbsp;&nbsp;总之使用MAT分析内存查找内存泄漏的根本思路，就是找到哪个类的对象的引用没有被释放，找到没有被释放的原因，也就可以很容易定位代码中的哪些片段的逻辑有问题了。</span></p>
<p>&nbsp;</p>
<p>转自：<a href="http://blog.csdn.net/cs_epo/article/details/7843766" target="_blank" rel="noopener">http://blog.csdn.net/cs_epo/article/details/7843766</a></p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> memory leak </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]对BaseAdapter中ViewHolder编写简化]]></title>
      <url>/2014/04/03/Android-%E5%AF%B9BaseAdapter%E4%B8%ADViewHolder%E7%BC%96%E5%86%99%E7%AE%80%E5%8C%96/</url>
      <content type="html"><![CDATA[<p>在Android项目中，经常都会用到ListView这个控件，而相应的Adapter中getView()方法的编写有一个标准的形式，如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">@Override<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">public</span> View getView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position, View convertView, ViewGroup parent) {<br></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">        ViewHolder holder;<br></span><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> convertView){<br></span><span style="color: #008080;"> 5</span>             holder = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ViewHolder();<br></span><span style="color: #008080;"> 6</span>             LayoutInflater mInflater =<span style="color: #000000;"> (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);<br></span><span style="color: #008080;"> 7</span>             convertView = mInflater.inflate(R.layout.item, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 8</span>             holder.btn =<span style="color: #000000;"> (Button) convertView.findViewById(R.id.btn);<br></span><span style="color: #008080;"> 9</span>             holder.tv =<span style="color: #000000;"> (TextView) convertView.findViewById(R.id.tv);<br></span><span style="color: #008080;">10</span>             holder.iv =<span style="color: #000000;"> (TextView) convertView.findViewById(R.id.iv);<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span> <span style="color: #000000;">            convertView.setTag(holder);<br></span><span style="color: #008080;">13</span>         }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;">14</span>             holder =<span style="color: #000000;"> (ViewHolder) convertView.getTag();<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">final</span> HashMap&lt;String, Object&gt; map =<span style="color: #000000;"> list.get(position);<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>         holder.iv.setImageResource(Integer.valueOf(map.get(“iv”<span style="color: #000000;">).toString()));<br></span><span style="color: #008080;">19</span>         holder.tv.setText(map.get(“tv”<span style="color: #000000;">).toString());<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>         holder.btn.setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener() {<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">23</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v) {<br></span><span style="color: #008080;">24</span>                 Toast.makeText(context, map.get(“btn”<span style="color: #000000;">).toString(), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">27</span><br><span style="color: #008080;">28</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> convertView;<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span>     <span style="color: #0000ff;">class</span><span style="color: #000000;"> ViewHolder{<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">        Button btn;<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">        ImageView iv;<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">        TextView tv;<br></span><span style="color: #008080;">35</span><br><span style="color: #008080;">36</span>     }</pre><br></div>

<p>以下是碎碎念（想直接看代码的，就跳过这段吧-_-！）：</p>
<p>也就是说每次编写Adapter都需要编写class ViewHolder…、if(null == convertView){…等等。这些代码跟业务逻辑关系不大，没有必要每次都写重复代码，</p>
<p>所以，显然有简化代码的余地。</p>
<p>既然我们的需求是不需要重复编写ViewHolder等内部类，那就把它移到父类吧。</p>
<p>但是ViewHolder中在实际项目中有不同的View，那就用list存放起来吧，但是放在list中的话，怎么取出来？用index？显然不是好的方法，不是有Resource Id这玩意，通过这个取不就好了么？所以以Resource Id为key放在Map中比较合适，但是既然以int（Resource Id）为key，那自然而然想到使用SparseArray了。</p>
<p>然后再把if(null == converView)…这些代码统统移到父类中。</p>
<p>所以ABaseAdapter诞生了，代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;"> <em> 实现对BaseAdapter中ViewHolder相关的简化<br></em></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 5</span> <span style="color: #008000;">  Date: 14-4-2<br></span><span style="color: #008080;"> 6</span> <span style="color: #008000;"> <em> Time: 下午5:54<br></em></span><span style="color: #008080;"> 7</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">class</span> ABaseAdapter <span style="color: #0000ff;">extends</span><span style="color: #000000;"> BaseAdapter{<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    Context context;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span>     <span style="color: #0000ff;">protected</span><span style="color: #000000;"> ABaseAdapter(Context context) {<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">this</span>.context =<span style="color: #000000;"> context;<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">protected</span><span style="color: #000000;"> ABaseAdapter() {<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">19</span> <span style="color: #008000;">     <em> 各个控件的缓存<br></em></span><span style="color: #008080;">20</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">21</span>     public <span style="color: #0000ff;">class</span><span style="color: #000000;"> ViewHolder{<br></span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">public</span> SparseArray&lt;View&gt; views = <span style="color: #0000ff;">new</span> SparseArray&lt;View&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span>         <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">25</span> <span style="color: #008000;">         <em> 指定resId和类型即可获取到相应的view<br></em></span><span style="color: #008080;">26</span> <span style="color: #008000;">          </span><span style="color: #808080;">@param</span><span style="color: #008000;"> convertView<br></span><span style="color: #008080;">27</span> <span style="color: #008000;">         <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> resId<br></span><span style="color: #008080;">28</span> <span style="color: #008000;">          </span><span style="color: #808080;">@param</span><span style="color: #008000;"> &lt;T&gt;<br></span><span style="color: #008080;">29</span> <span style="color: #008000;">         <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">30</span>          <span style="color: #008000;">/</span><br><span style="color: #008080;">31</span>         <span style="color: #0000ff;">public</span> &lt;T <span style="color: #0000ff;">extends</span> View&gt; T obtainView(View convertView, <span style="color: #0000ff;">int</span><span style="color: #000000;"> resId){<br></span><span style="color: #008080;">32</span>             View v =<span style="color: #000000;"> views.get(resId);<br></span><span style="color: #008080;">33</span>             <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> v){<br></span><span style="color: #008080;">34</span>                 v =<span style="color: #000000;"> convertView.findViewById(resId);<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">                views.put(resId, v);<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">37</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> (T)v;<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">39</span><br><span style="color: #008080;">40</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">41</span><br><span style="color: #008080;">42</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">43</span> <span style="color: #008000;">     <em> 改方法需要子类实现，需要返回item布局的resource id<br></em></span><span style="color: #008080;">44</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;">45</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">46</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> itemLayoutRes();<br></span><span style="color: #008080;">47</span><br><span style="color: #008080;">48</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">49</span>     <span style="color: #0000ff;">public</span> View getView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position, View convertView, ViewGroup parent) {<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">        ViewHolder holder;<br></span><span style="color: #008080;">51</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> convertView){<br></span><span style="color: #008080;">52</span>             holder = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ViewHolder();<br></span><span style="color: #008080;">53</span>             convertView = LayoutInflater.from(context).inflate(itemLayoutRes(), <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">54</span> <span style="color: #000000;">            convertView.setTag(holder);<br></span><span style="color: #008080;">55</span>         }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;">56</span>             holder =<span style="color: #000000;"> (ViewHolder) convertView.getTag();<br></span><span style="color: #008080;">57</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">58</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> getView(position, convertView, parent, holder);<br></span><span style="color: #008080;">59</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">60</span><br><span style="color: #008080;">61</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">62</span> <span style="color: #008000;">      使用该getView方法替换原来的getView方法，需要子类实现<br></span><span style="color: #008080;">63</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> position<br></span><span style="color: #008080;">64</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> convertView<br></span><span style="color: #008080;">65</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> parent<br></span><span style="color: #008080;">66</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> holder<br></span><span style="color: #008080;">67</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">68</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">69</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> View getView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position, View convertView, ViewGroup parent, ViewHolder holder);<br></span><span style="color: #008080;">70</span><br><span style="color: #008080;">71</span> }</pre><br></div>

<p>如上代码：增加了一个itemLayoutRes()的抽象方法，该抽象方法提供给子类实现，返回item布局的resource id，为后面的getView方法提供调用。</p>
<p>可以看到上述代码中，在系统的getView方法中，进行我们以前在BaseAdapter实现类中所做的事（初始化converView，并绑定ViewHolder作为tag），然后抛弃了系统提供的getView方法，直接去调用自己写的getView抽象方法，这个getView方法是提供给子类去实现的，作用跟系统的getView一样，但是这个getView方法中携带了一个ViewHolder对象，子类可以通过这个对象进行获取item中的控件。</p>
<p>具体使用方式如下，比如创建了MyAdapter并继承了ABaseAdapter：</p>
<p>注意，在构造方法中需要调用父类的构造方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">public</span> MyAdapter(Context context, List&lt;HashMap&lt;String, Object&gt;&gt;<span style="color: #000000;"> list) {<br></span><span style="color: #008080;">2</span>     <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;">3</span>     <span style="color: #0000ff;">this</span>.list =<span style="color: #000000;"> list;<br></span><span style="color: #008080;">4</span> }</pre><br></div>

<p>即，以上的&ldquo;super(context);&rdquo;必须调用。</p>
<p>接着实现itemLayoutRes()方法，返回item的布局：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #000000;">@Override<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> itemLayoutRes() {<br></span><span style="color: #008080;">3</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> R.layout.item;<br></span><span style="color: #008080;">4</span> }</pre><br></div>

<p>&nbsp;</p>
<p>getView方法中的实现如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">@Override<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">public</span> View getView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position, View convertView, ViewGroup parent, ViewHolder holder) {<br></span><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">final</span> HashMap&lt;String, Object&gt; map =<span style="color: #000000;"> list.get(position);<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span>     Button btn =<span style="color: #000000;"> holder.obtainView(convertView, R.id.item_btn);<br></span><span style="color: #008080;"> 6</span>     ImageView iv =<span style="color: #000000;"> holder.obtainView(convertView, R.id.item_iv);<br></span><span style="color: #008080;"> 7</span>     TextView tv =<span style="color: #000000;"> holder.obtainView(convertView, R.id.item_tv);<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>      btn.setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener() {<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v) {<br></span><span style="color: #008080;">12</span>             Toast.makeText(context, map.get(“btn”<span style="color: #000000;">).toString(), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">         }<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">     });<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span>      iv.setImageResource(Integer.valueOf(map.get(“iv”<span style="color: #000000;">).toString()));<br></span><span style="color: #008080;">17</span>      tv.setText(map.get(“tv”<span style="color: #000000;">).toString());<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> convertView;<br></span><span style="color: #008080;">20</span>     }</pre><br></div>

<p>如上代码：调用holder.obtainView方法既可获取item中的控件；</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ListView </tag>
            
            <tag> best practices </tag>
            
            <tag> adapter </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android高级模糊技术[转]]]></title>
      <url>/2014/03/28/Android%E9%AB%98%E7%BA%A7%E6%A8%A1%E7%B3%8A%E6%8A%80%E6%9C%AF-%E8%BD%AC/</url>
      <content type="html"><![CDATA[<p>今天我们来更深入了解一下Android开发上的模糊技术。我读过几篇有关的文章，也在StackOverFlow上看过一些相关教程的帖子，所以我想在这里总结一下学到的东西。</p>
<h3 id="为什么学习这个模糊技术？"><a href="#为什么学习这个模糊技术？" class="headerlink" title="为什么学习这个模糊技术？"></a>为什么学习这个模糊技术？</h3><p>现在越来越多的开发者喜欢在自定义控件的时候加上各种模糊背景，看看RomanNurik开发的<a href="https://play.google.com/store/apps/details?id=net.nurik.roman.muzei" target="_blank" rel="noopener">Muzei</a>或者Yahoo的<a href="https://play.google.com/store/apps/details?id=com.yahoo.mobile.client.android.weather" target="_blank" rel="noopener">Weather应用</a>app都非常不错。我非常喜欢他们的设计。</p>
<p>我从<strong>Mark Allison</strong>的帖子(<a href="http://blog.stylingandroid.com/archives/2304" target="_blank" rel="noopener">帖子地址</a>)得到启发，然后写了这篇文章。</p>
<p>这是我们需要完成下图展示的效果：</p>
<p><a href="http://www.linuxeden.com/upimg/allimg/140328/0S1031332-0.png" title="Android高级模糊技术" target="_blank" rel="noopener"><img src="http://www.linuxeden.com/upimg/allimg/140328/0S1031332-0.png" alt="1"></a></p>
<h3 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h3><p>首先描述一下我们需要的文件。我们需要一个主<code>Activity</code>，里面有一个含有多个<code>Fragment</code>的<code>ViewPager</code>，每个<code>Fragment</code>展示一种模糊技术。</p>
<p><span>这是主</span><code>Activity</code><span>的布局文件内容：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">android.support.v4.view.ViewPager<br></span><span style="color: #008080;">2</span> <span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><br><span style="color: #008080;">3</span> <span style="color: #ff0000;">    xmlns:tools</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/tools" target="_blank" rel="noopener">http://schemas.android.com/tools</a>“</span><br><span style="color: #008080;">4</span> <span style="color: #ff0000;">    android:id</span><span style="color: #0000ff;">=”@+id/pager”</span><br><span style="color: #008080;">5</span> <span style="color: #ff0000;">    android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">6</span> <span style="color: #ff0000;">    android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">7</span> <span style="color: #ff0000;">    tools:context</span><span style="color: #0000ff;">=”com.paveldudka.MainActivity”</span> <span style="color: #0000ff;">/&gt;</span></pre><br></div>

<p><span>这是</span><code>Fragment</code><span>的布局文件内容：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">FrameLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><br><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">    android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">    android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">ImageView<br></span><span style="color: #008080;"> 8</span>         <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/picture”</span><br><span style="color: #008080;"> 9</span> <span style="color: #ff0000;">        android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">10</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">11</span> <span style="color: #ff0000;">        android:src</span><span style="color: #0000ff;">=”@drawable/picture”</span><br><span style="color: #008080;">12</span> <span style="color: #ff0000;">        android:scaleType</span><span style="color: #0000ff;">=”centerCrop”</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextView<br></span><span style="color: #008080;">15</span>         <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/text”</span><br><span style="color: #008080;">16</span> <span style="color: #ff0000;">        android:gravity</span><span style="color: #0000ff;">=”center_horizontal”</span><br><span style="color: #008080;">17</span> <span style="color: #ff0000;">        android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">18</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">19</span> <span style="color: #ff0000;">        android:text</span><span style="color: #0000ff;">=”My super text”</span><br><span style="color: #008080;">20</span> <span style="color: #ff0000;">        android:textColor</span><span style="color: #0000ff;">=”&lt;a href=”</span><span style="color: #ff0000;"><a href="http://www.jobbole.com/members/android/" target="_blank" rel="noopener">http://www.jobbole.com/members/android/</a>“ rel</span><span style="color: #0000ff;">=”nofollow”</span><span style="color: #0000ff;">&gt;</span>@android<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">a</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">:color/white”<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">        android:layout_gravity=”center_vertical”<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">        android:textStyle=”bold”<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">        android:textSize=”48sp” /&gt;<br></span><span style="color: #008080;">24</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout<br></span><span style="color: #008080;">25</span>         <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/controls”</span><br><span style="color: #008080;">26</span> <span style="color: #ff0000;">        android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">27</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">28</span> <span style="color: #ff0000;">        android:background</span><span style="color: #0000ff;">=”#7f000000”</span><br><span style="color: #008080;">29</span> <span style="color: #ff0000;">        android:orientation</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;">30</span> <span style="color: #ff0000;">        android:layout_gravity</span><span style="color: #0000ff;">=”bottom”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">31</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">FrameLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>我们只是在布局上放了一个<code>ImageView</code>，然后在中间加一个<code>TextView</code>，还有一些作为效果显示和测试的控件（如 @+id/controls）。</p>
<p>最普遍的模糊技术是这样做的：</p>
<ul>
<li>从<code>TextView</code>的后一层背景中截取一部分；</li>
<li>进行模糊处理；</li>
<li>把模糊处理后的部分设置为<code>TextView</code>的背景。</li>
</ul>
<h3 id="Renderscript"><a href="#Renderscript" class="headerlink" title="Renderscript"></a>Renderscript</h3><p>那怎么在Android中实现模糊处理呢？最好的答案就是Renderscript。这是一个功能强大的图形处理&ldquo;引擎&rdquo;。RenderScript的底层原理就不做介绍了（因为我也不知道），而且这超过了我们这篇文章的范围。</p>
<p>先看下面的代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">public class RSBlurFragment extends Fragment {<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">    private ImageView image;<br></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    private TextView text;<br></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">    private TextView statusText;<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">        View view = inflater.inflate(R.layout.fragment_layout, container, false);<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">        image = (ImageView) view.findViewById(R.id.picture);<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">        text = (TextView) view.findViewById(R.id.text);<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">        statusText = addStatusText((ViewGroup) view.findViewById(R.id.controls));<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">        applyBlur();<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">        return view;<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> <span style="color: #000000;">    private void applyBlur() {<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">        image.getViewTreeObserver().addOnPreDrawListener(new ViewTreeObserver.OnPreDrawListener() {<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">            public boolean onPreDraw() {<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">                image.getViewTreeObserver().removeOnPreDrawListener(this);<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">                image.buildDrawingCache();<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> <span style="color: #000000;">                Bitmap bmp = image.getDrawingCache();<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">                blur(bmp, text);<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">                return true;<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span> <span style="color: #000000;">    @TargetApi(Build.VERSION_CODES.JELLY_BEAN_MR1)<br></span><span style="color: #008080;">31</span> <span style="color: #000000;">    private void blur(Bitmap bkg, View view) {<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">        long startMs = System.currentTimeMillis();<br></span><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span> <span style="color: #000000;">        float radius = 20;<br></span><span style="color: #008080;">35</span><br><span style="color: #008080;">36</span> <span style="color: #000000;">        Bitmap overlay = Bitmap.createBitmap((int) (view.getMeasuredWidth()),<br></span><span style="color: #008080;">37</span> <span style="color: #000000;">                (int) (view.getMeasuredHeight()), Bitmap.Config.ARGB_8888);<br></span><span style="color: #008080;">38</span><br><span style="color: #008080;">39</span> <span style="color: #000000;">        Canvas canvas = new Canvas(overlay);<br></span><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span> <span style="color: #000000;">        canvas.translate(-view.getLeft(), -view.getTop());<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">        canvas.drawBitmap(bkg, 0, 0, null);<br></span><span style="color: #008080;">43</span><br><span style="color: #008080;">44</span> <span style="color: #000000;">        RenderScript rs = RenderScript.create(getActivity());<br></span><span style="color: #008080;">45</span><br><span style="color: #008080;">46</span> <span style="color: #000000;">        Allocation overlayAlloc = Allocation.createFromBitmap(<br></span><span style="color: #008080;">47</span> <span style="color: #000000;">                rs, overlay);<br></span><span style="color: #008080;">48</span><br><span style="color: #008080;">49</span> <span style="color: #000000;">        ScriptIntrinsicBlur blur = ScriptIntrinsicBlur.create(<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">                rs, overlayAlloc.getElement());<br></span><span style="color: #008080;">51</span><br><span style="color: #008080;">52</span> <span style="color: #000000;">        blur.setInput(overlayAlloc);<br></span><span style="color: #008080;">53</span><br><span style="color: #008080;">54</span> <span style="color: #000000;">        blur.setRadius(radius);<br></span><span style="color: #008080;">55</span><br><span style="color: #008080;">56</span> <span style="color: #000000;">        blur.forEach(overlayAlloc);<br></span><span style="color: #008080;">57</span><br><span style="color: #008080;">58</span> <span style="color: #000000;">        overlayAlloc.copyTo(overlay);<br></span><span style="color: #008080;">59</span><br><span style="color: #008080;">60</span> <span style="color: #000000;">        view.setBackground(new BitmapDrawable(<br></span><span style="color: #008080;">61</span> <span style="color: #000000;">                getResources(), overlay));<br></span><span style="color: #008080;">62</span><br><span style="color: #008080;">63</span> <span style="color: #000000;">        rs.destroy();<br></span><span style="color: #008080;">64</span> <span style="color: #000000;">        statusText.setText(System.currentTimeMillis() - startMs + “ms”);<br></span><span style="color: #008080;">65</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">66</span><br><span style="color: #008080;">67</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">68</span> <span style="color: #000000;">    public String toString() {<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">        return “RenderScript”;<br></span><span style="color: #008080;">70</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">71</span><br><span style="color: #008080;">72</span> <span style="color: #000000;">    private TextView addStatusText(ViewGroup container) {<br></span><span style="color: #008080;">73</span> <span style="color: #000000;">        TextView result = new TextView(getActivity());<br></span><span style="color: #008080;">74</span> <span style="color: #000000;">        result.setLayoutParams(new ViewGroup.LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT));<br></span><span style="color: #008080;">75</span> <span style="color: #000000;">        result.setTextColor(0xFFFFFFFF);<br></span><span style="color: #008080;">76</span> <span style="color: #000000;">        container.addView(result);<br></span><span style="color: #008080;">77</span> <span style="color: #000000;">        return result;<br></span><span style="color: #008080;">78</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">79</span> }</pre><br></div>

<ul>
<li>在<code>Fragment</code>创建的时候，我先载入了布局文件，然后把<code>TextView</code>添加到我在布局文件中定义的LinearLayout中（用来显示模糊效果，进行效果测试），最后对图片做模糊处理。</li>
<li>在<code>applyBlur()</code>函数中我注册了<code>onPreDrawListener()</code>。因为在<code>applyBlur()</code>方法调用的时候界面还没有开始布局，所以我需要实现这个监听器否则不能进行模糊处理。需要等到布局文件全都经过<strong>measured</strong>、<strong>laid out</strong>、<strong>displayed</strong>的时候，才能进行操作。</li>
<li>在<code>onPreDraw()</code>回调函数中，我首先把返回值<strong>false</strong>改成<strong>true</strong>。这个很重要，如果返回<strong>false</strong>的话，刚开始出现的那一帧画面会被跳过，但是我们需要显示这第一帧，所以要返回<strong>true</strong>。</li>
<li>接着我去掉了里面的回调方法，因为我们不需要监听它的<code>preDraw</code>事件。</li>
<li>然后我们需要从<code>ImageView</code>中获取<code>Bitmap</code>，然后用<code>getDrawingCache()</code>函数创建<strong>drawing cache</strong>并保存。</li>
<li>最后就是进行模糊处理了，我们接下来会详细讨论这个环节。</li>
</ul>
<p>需要说明的是，我的代码中在两种情况下考虑不是很周全：</p>
<ul>
<li>在布局文件改变时不会再自动重新模糊处理。这个问题可以通过注册<code>onGlobalLayoutListener</code>监听器解决，在布局文件改变时重新进行模糊处理就可以了。</li>
<li>这个模糊处理操作是在主线程中进行的。我们知道在实际开发中不会这么做，但是为了方便暂时先这么做了。</li>
</ul>
<p>现在回到<code>blur()</code>方法：</p>
<ul>
<li>首先我创建了一个空的bitmap，把背景的一部分复制进去，之后我会对这个bitmap进行模糊处理并设置为<code>TextView</code>的背景。</li>
<li>通过这个bitmap保存<code>Canvas</code>的状态；</li>
<li>在父布局文件中把<code>Canvas</code>移动到<code>TextView</code>的位置；</li>
<li>把<code>ImageView</code>的内容绘到bitmap中；</li>
<li>此时，我们就有了一个和<code>TextView</code>一样大小的bitmap，它包含了<code>ImageView</code>的一部分内容，也就是<code>TextView</code>背后一层布局的内容；</li>
<li>创建一个Renderscript的实例；</li>
<li>把bitmap复制一份到Renderscript需要的数据片中；</li>
<li>创建Renderscript模糊处理的实例；</li>
<li>设置输入，半径范围然后进行模糊处理；</li>
<li>把处理后的结果复制回之前的bitmap中；</li>
<li>好了，我们已经把bitmap惊醒模糊处理了，可以将它设置为<code>TextView</code>背景了；</li>
</ul>
<p>这是我们处理后的效果：</p>
<p><a href="http://www.linuxeden.com/upimg/allimg/140328/0S1032447-1.png" title="Android高级模糊技术" target="_blank" rel="noopener"><img src="http://www.linuxeden.com/upimg/allimg/140328/0S1032447-1.png" alt="2"></a></p>
<p>可以看到效果还不错，但是它用了57ms的时间。我们知道在Android中渲染一帧的时间应该不超过16ms（60fps），但如果在UI线程中做模糊处理就会让帧率降到了17fps。显然这是不可接受的，我们需要把这个操作移到<strong>AsyncTask</strong>上或者使用别的机制实现。</p>
<p>而且有必要说明的是，<strong>ScriptIntrinsicBlur</strong>只支持API17以上，当然也可以用Renderscript的<strong>support lib</strong>降低一些API版本的要求。</p>
<p>可是我们还是需要支持一些老一些的API版本，它们不支持Renderscript，现在我们看看该怎么办吧。</p>
<h3 id="FastBlur"><a href="#FastBlur" class="headerlink" title="FastBlur"></a>FastBlur</h3><p>因为我们知道，这种模糊处理的过程也就是像素处理而已，所以我们可以尝试着手动进行模糊操作。幸运的是，Java上已经有了很多实现模糊处理方案的例子。我们唯一要做的就是找到一个相对快速的实现方案。</p>
<p>感谢在StackOverFlow上的一篇帖子，我找到了一个能快速实现模糊处理的方案。先看看它是怎么样的。</p>
<p>因为很多代码都是一样的，所以这里只讨论关于模糊处理的函数：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">private void blur(Bitmap bkg, View view) {<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">    long startMs = System.currentTimeMillis();<br></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    float radius = 20;<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #000000;">    Bitmap overlay = Bitmap.createBitmap((int) (view.getMeasuredWidth()),<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">            (int) (view.getMeasuredHeight()), Bitmap.Config.ARGB_8888);<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    Canvas canvas = new Canvas(overlay);<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    canvas.translate(-view.getLeft(), -view.getTop());<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    canvas.drawBitmap(bkg, 0, 0, null);<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">    overlay = FastBlur.doBlur(overlay, (int)radius, true);<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">    view.setBackground(new BitmapDrawable(getResources(), overlay));<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    statusText.setText(System.currentTimeMillis() - startMs + “ms”);<br></span><span style="color: #008080;">13</span> }</pre><br></div>

<p>实现的效果如下：</p>
<p><a href="http://www.linuxeden.com/upimg/allimg/140328/0S10323F-2.png" title="Android高级模糊技术" target="_blank" rel="noopener"><img src="http://www.linuxeden.com/upimg/allimg/140328/0S10323F-2.png" alt="3"></a></p>
<p>可以看到，模糊处理的效果也相当不错。使用FastBlur的好处是，我们可以去掉对Renderscript的依赖（还有最低API版本的限制）。但是可恶的是，理模糊操作竟然花费了147ms！这还不是最慢的<strong>SW</strong>模糊算法，我都不敢用高斯模糊了&hellip;</p>
<h3 id="继续深入"><a href="#继续深入" class="headerlink" title="继续深入"></a>继续深入</h3><p>现在我们要想想该怎么做。模糊处理的过程都会有精度损失，你知道什么是精度损失吗？对，要降低尺寸。</p>
<p>既然这样，为什么不把bitmap的尺寸先降低然后进行模糊处理，然后再放大尺寸呢？我试着实现了一下这个想法，这是处理后得到的效果：</p>
<p><a href="http://www.linuxeden.com/upimg/allimg/140328/0S10345Z-3.png" title="Android高级模糊技术" target="_blank" rel="noopener"><img src="http://www.linuxeden.com/upimg/allimg/140328/0S10345Z-3.png" alt="4"></a></p>
<p>看到了吗！Renderscript只用了13ms，FastBlur只用了2ms！还不错。</p>
<p>再看看代码。这里只讨论FastBlur版本，因为Renderscript也是一样的，全部代码都可以从<span class="wp_keywordlink"><a href="http://blog.jobbole.com/6492/" title="GitHub如何运作系列文章" target="_blank" rel="noopener">GitHub</a></span>仓库中检出。</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">private void blur(Bitmap bkg, View view) {<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">    long startMs = System.currentTimeMillis();<br></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    float scaleFactor = 1;<br></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">    float radius = 20;<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">    if (downScale.isChecked()) {<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">        scaleFactor = 8;<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">        radius = 2;<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #000000;">    Bitmap overlay = Bitmap.createBitmap((int) (view.getMeasuredWidth()/scaleFactor),<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">            (int) (view.getMeasuredHeight()/scaleFactor), Bitmap.Config.ARGB_8888);<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    Canvas canvas = new Canvas(overlay);<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">    canvas.translate(-view.getLeft()/scaleFactor, -view.getTop()/scaleFactor);<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">    canvas.scale(1 / scaleFactor, 1 / scaleFactor);<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">    Paint paint = new Paint();<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">    paint.setFlags(Paint.FILTER_BITMAP_FLAG);<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">    canvas.drawBitmap(bkg, 0, 0, paint);<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> <span style="color: #000000;">    overlay = FastBlur.doBlur(overlay, (int)radius, true);<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">    view.setBackground(new BitmapDrawable(getResources(), overlay));<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">    statusText.setText(System.currentTimeMillis() - startMs + “ms”);<br></span><span style="color: #008080;">22</span> }</pre><br></div>

<p>我们过一遍这个代码：</p>
<ul>
<li><strong>scaleFactor</strong>提供了需要缩小的等级，在代码中我把bitmap的尺寸缩小到原图的1/8。因为这个bitmap在模糊处理时会先被缩小然后再放大，所以在我的模糊算法中就不用<strong>radius</strong>这个参数了，所以把它设成2。</li>
<li>接着需要创建bitmap，这个bitmap比最后需要的小八倍。</li>
<li>请注意我给<strong>Paint</strong>提供了<strong>FILTER_BITMAP_FLAG</strong>标示，这样的话在处理bitmap缩放的时候，就可以达到双缓冲的效果，模糊处理的过程就更加顺畅了。</li>
<li>接下来和之前一样进行模糊处理操作，这次的图片小了很多，幅度也降低了很多，所以模糊过程非常快。</li>
<li>把模糊处理后的图片作为背景，它会自动进行放大操作的。</li>
</ul>
<p>之前说到FastBlur进行模糊操作比Renderscript还要快，这是因为FastBlur在进行bitmap复制操作时还会同时进行其他操作，节省了时间。经过了这些处理后，我们应该已经掌握了相对快速的模糊处理方案和原理，并去掉了对Renderscript的依赖。</p>
<p>本文的示例代码：<a href="https://github.com/paveldudka/blurring" target="_blank" rel="noopener">GitHub &ndash; blurring</a>。</p>
<p>&nbsp;</p>
<p><span>原文链接：&nbsp;</span><a href="http://trickyandroid.com/advanced-blurring-techniques/" target="_blank" rel="noopener">trickyandroid</a><span>&nbsp;&nbsp;&nbsp;翻译：&nbsp;</span><a href="http://blog.jobbole.com/" target="_blank" rel="noopener">伯乐在线&nbsp;</a><span>-&nbsp;</span><a href="http://blog.jobbole.com/author/chris/" target="_blank" rel="noopener">chris</a><br><span>译文链接：&nbsp;</span><a href="http://blog.jobbole.com/63894/" target="_blank" rel="noopener">http://blog.jobbole.com/63894/</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> blur </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]AndroidInject增加sqlite3数据库映射注解(ORM)]]></title>
      <url>/2014/03/25/Android-AndroidInject%E5%A2%9E%E5%8A%A0sqlite3%E6%95%B0%E6%8D%AE%E5%BA%93%E6%98%A0%E5%B0%84%E6%B3%A8%E8%A7%A3-ORM/</url>
      <content type="html"><![CDATA[<p>AndroidInject项目是我写的一个使用注解注入来简化代码的开源项目</p>
<p><a href="https://github.com/wangjiegulu/androidInject" target="_blank" rel="noopener">https://github.com/wangjiegulu/androidInject</a></p>
<p>今天新增功能如下：</p>
<p>1. 增加对sqlite3数据库的orm注解支持，增加@AIColumn、@AIPrimaryKey、@AITable三个注解来映射到表（有待改进）</p>
<p>2. 使用反射来封装AIDbExecutor类，实现半自动化orm，类似mybatis</p>
<p><img src="http://images.cnitblog.com/i/378300/201403/251333009205565.png" alt=""></p>
<p>　　先说说使用的方式吧</p>
<p>　　一. 新建DatabaseHelper，继承AIDatabaseHelper（AndroidInject提供，直接继承了SQLiteOpenHelper），在onCreate中调用如下方法来新建表user：</p>
<div class="cnblogs_code"><br><pre><span style="color: #000000;">@Override<br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(SQLiteDatabase db) {<br>        AIDbUtil.createTableIfNotExist(db,<br>                </span>“create table user(uid INTEGER PRIMARY KEY AUTOINCREMENT, “ +<br>                        “username varchar(20), “ +<br>                        “password varchar(20), “ +<br>                        “createmillis long, “ +<br>                        “height float, “ +<br>                        “weight double)”<span style="color: #000000;">,<br>                </span>“user”<span style="color: #000000;">);<br>}</span></pre><br></div>

<p>其中方法createTableIfNotExist (SQLiteDatabase db, String sql, String tableName) 用于新建表，如果存在该表，则不创建&nbsp; &nbsp;&nbsp;</p>
<p>　　二. 既然是ORM，不管怎么样，总要在表与持久层对象之间映射，所以新建表完毕之后，就要新建类User：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">  Date: 14-3-25<br></span><span style="color: #008080;"> 5</span> <span style="color: #008000;"> <em> Time: 上午10:04<br></em></span><span style="color: #008080;"> 6</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 7</span> <span style="color: #000000;">@AITable(“user”)<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> User <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Serializable{<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    @AIColumn<br></span><span style="color: #008080;">10</span>     @AIPrimaryKey(insertable = <span style="color: #0000ff;">false</span><span style="color: #000000;">)<br></span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> uid;<br></span><span style="color: #008080;">12</span>     @AIColumn(“username”<span style="color: #000000;">)<br></span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String username;<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">    @AIColumn<br></span><span style="color: #008080;">15</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String password;<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">    @AIColumn<br></span><span style="color: #008080;">17</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> createmillis;<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">    @AIColumn<br></span><span style="color: #008080;">19</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">float</span><span style="color: #000000;"> height;<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">    @AIColumn<br></span><span style="color: #008080;">21</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">double</span><span style="color: #000000;"> weight;<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String notCol;<br></span><span style="color: #008080;">24</span>     // getter/setter…<br><span style="color: #008080;">25</span> }</pre><br></div>

<p>如上面的代码所示：</p>
<p>@AITable&nbsp;类注解，用于映射类到表， value()表示要映射到的表的名称，不填写或未增加该注解则默认以类名小写为表名</p>
<p>@AIPrimaryKey&nbsp;属性注解，用于指定属性为主键，insertable()表示插入数据时是否同时也插入主键到表。默认为false，即表的主键应该为自动生成</p>
<p>@AIColumn&nbsp;属性注解，用于映射属性到表字段，value()表示要映射到的表字段名称，不填写则默认以属性名作为表字段名</p>
<p>这样，类和表之间就用以上的几个注解进行了映射。</p>
<p>&nbsp; &nbsp; 三. AndroidInject提供了一个AIDbExecutor抽象类来对表数据进行操作，使用时需要自己编写一个DbExecutor来继承AIDbExecutor，并实现obtainDbHelper()方法，用于提供给DbExecutor一个AIDatabaseHelper。如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> DbExecutor&lt;T&gt; <span style="color: #0000ff;">extends</span> AIDbExecutor&lt;T&gt;<span style="color: #000000;">{<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> String TAG = DbExecutor.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> String DB_NAME = “androidinject_db”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> VERSION = 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> DbExecutor(Context context) {<br></span><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> AIDatabaseHelper obtainDbHelper() {<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> DatabaseHelper(context, DB_NAME, VERSION);<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> }</pre><br></div>

<p>&nbsp; &nbsp;接下来就可以直接使用AIDbExecutor来进行数据库的操作了，如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">//</span><span style="color: #008000;"> 创建一个用于操作user表的dbExecutor对象</span><br>AIDbExecutor&lt;User&gt; userExecutor = <span style="color: #0000ff;">new</span> DbExecutor&lt;User&gt;<span style="color: #000000;">(context);<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;"> 插入一条user数据：</span><br>User dbUser = <span style="color: #0000ff;">new</span> User(“wangjie” + rd.nextInt(10000), String.valueOf(rd.nextInt(10000) + 10000), System.currentTimeMillis(), rd.nextInt(80) + 120, rd.nextInt(80) + 120, “aaaa”<span style="color: #000000;">);<br>userExecutor.executeSave(dbUser);<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;"> 查询user表</span><br>List&lt;User&gt; users = userExecutor.executeQuery(“select * from user where uid &gt; ?”, <span style="color: #0000ff;">new</span> String[]{“4”}, User.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;"> 删除user表中的一条数据</span><br>userExecutor.executeDelete(users.get(0<span style="color: #000000;">));<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;"> 更新user表中的一条数据</span><br>User user = users.get(0<span style="color: #000000;">);<br>user.setUsername(user.getUsername().startsWith(</span>“wangjie”) ? “jiewang” + rd.nextInt(10000) : “wangjie” + rd.nextInt(10000<span style="color: #000000;">));<br>user.setPassword(user.getPassword().startsWith(</span>“123456”) ? “abcdef” : “123456”<span style="color: #000000;">);<br>user.setCreatemillis(System.currentTimeMillis());<br>user.setHeight(rd.nextInt(</span>80) + 120<span style="color: #000000;">);<br>user.setWeight(rd.nextInt(</span>80) + 120<span style="color: #000000;">);<br>user.setNotCol(</span>“bbb”<span style="color: #000000;">);<br>userExecutor.executeUpdate(user, </span><span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">new</span> String[]{“createmillis”});</pre><br></div>

<p>四. AIDbExecutor类中提供的方法有：</p>
<p>1. public List&lt;T&gt; executeQuery(String sql, String[] selectionArgs, Class&lt;?&gt; clazz) throws Exception;</p>
<p>用于查询表，并自动封装到List&lt;T&gt;中，告别Cursor</p>
<p>2.&nbsp;public int executeSave(final T obj) throws Exception;</p>
<p>用于保存一条数据</p>
<p>3.&nbsp;public int executeUpdate(final T obj, final String[] includeParams, final String[] excludeParams) throws Exception;</p>
<p>用于更新一条数据，更新数据时，是根据主键去更新其他字段的。可以对其他要更新的字段进行包含和排除（填写类的属性）。</p>
<p>注意：包含在includeParams，并且不包含在excludeParams中才会被更新。</p>
<p>4.&nbsp;public int executeDelete(final T obj) throws Exception;</p>
<p>删除一条数据，根据主键删除一条数据</p>
<p>5.&nbsp;public void executeSql(String sql, Object[] selectionArgs) throws Exception;</p>
<p>执行一条sql语句（insert、update、delete）</p>
<p>6. 同时提供了生成SQLiteDatabase对象的方法</p>
<p>public SQLiteDatabase getReadableDatabase();</p>
<p>public SQLiteDatabase getWritableDatabase();</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> library </tag>
            
            <tag> inject </tag>
            
            <tag> sqlite </tag>
            
            <tag> sqlite3 </tag>
            
            <tag> database </tag>
            
            <tag> orm </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java8 Lambda表达式教程]]></title>
      <url>/2014/03/20/Java8-Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%95%99%E7%A8%8B/</url>
      <content type="html"><![CDATA[<p>转自：<a href="http://blog.csdn.net/ioriogami/article/details/12782141" target="_blank" rel="noopener">http://blog.csdn.net/ioriogami/article/details/12782141</a></p>
<p>&nbsp;</p>
<p><span><strong>1. 什么是&lambda;表达式</strong></span></p>
<p>&lambda;表达式本质上是一个匿名方法。让我们来看下面这个例子：</p>
<p>&nbsp;&nbsp;&nbsp; public int add(int x, int y) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return x + y;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>转成&lambda;表达式后是这个样子：<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; (int x, int y) -&gt; x + y;</p>
<p>参数类型也可以省略，Java编译器会根据上下文推断出来：</p>
<p>&nbsp;&nbsp;&nbsp; (x, y) -&gt; x + y; //返回两数之和<br>&nbsp;<br>或者</p>
<p>&nbsp;&nbsp;&nbsp; (x, y) -&gt; { return x + y; } //显式指明返回值</p>
<p>可见&lambda;表达式有三部分组成：参数列表，箭头（-&gt;），以及一个表达式或语句块。</p>
<p>下面这个例子里的&lambda;表达式没有参数，也没有返回值（相当于一个方法接受0个参数，返回void，其实就是Runnable里run方法的一个实现）：</p>
<p>&nbsp;&nbsp;&nbsp; () -&gt; { System.out.println(“Hello Lambda!”); }</p>
<p>如果只有一个参数且可以被Java推断出类型，那么参数列表的括号也可以省略：</p>
<p>&nbsp;&nbsp;&nbsp; c -&gt; { return c.size(); }</p>
<p>&nbsp;</p>
<p><span><strong>2. &lambda;表达式的类型（它是Object吗？）</strong></span></p>
<p>&lambda;表达式可以被当做是一个Object（注意措辞）。&lambda;表达式的类型，叫做&ldquo;目标类型（target type）&rdquo;。&lambda;表达式的目标类型是&ldquo;函数接口（functional interface）&rdquo;，这是Java8新引入的概念。它的定义是：一个接口，如果只有一个显式声明的抽象方法，那么它就是一个函数接口。一般用@FunctionalInterface标注出来（也可以不标）。举例如下：</p>
<p>&nbsp;&nbsp;&nbsp; @FunctionalInterface<br>&nbsp;&nbsp;&nbsp; public interface Runnable { void run(); }<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; public interface Callable&lt;V&gt; { V call() throws Exception; }<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; public interface ActionListener { void actionPerformed(ActionEvent e); }<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; public interface Comparator&lt;T&gt; { int compare(T o1, T o2); boolean equals(Object obj); }</p>
<p>注意最后这个Comparator接口。它里面声明了两个方法，貌似不符合函数接口的定义，但它的确是函数接口。这是因为equals方法是Object的，所有的接口都会声明Object的public方法&mdash;&mdash;虽然大多是隐式的。所以，Comparator显式的声明了equals不影响它依然是个函数接口。</p>
<p>你可以用一个&lambda;表达式为一个函数接口赋值：<br>&nbsp;<br>&nbsp;&nbsp;&nbsp; Runnable r1 = () -&gt; {System.out.println(“Hello Lambda!”);};<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>然后再赋值给一个Object：</p>
<p>&nbsp;&nbsp;&nbsp; Object obj = r1;<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>但却不能这样干：</p>
<p>&nbsp;&nbsp;&nbsp; Object obj = () -&gt; {System.out.println(“Hello Lambda!”);}; // ERROR! Object is not a functional interface!</p>
<p>必须显式的转型成一个函数接口才可以：</p>
<p>&nbsp;&nbsp;&nbsp; Object o = (Runnable) () -&gt; { System.out.println(“hi”); }; // correct<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>一个&lambda;表达式只有在转型成一个函数接口后才能被当做Object使用。所以下面这句也不能编译：</p>
<p>&nbsp;&nbsp;&nbsp; System.out.println( () -&gt; {} ); //错误! 目标类型不明<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>必须先转型:</p>
<p>&nbsp;&nbsp;&nbsp; System.out.println( (Runnable)() -&gt; {} ); // 正确</p>
<p>假设你自己写了一个函数接口，长的跟Runnable一模一样：</p>
<p>&nbsp;&nbsp;&nbsp; @FunctionalInterface<br>&nbsp;&nbsp;&nbsp; public interface MyRunnable {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void run();<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>那么</p>
<p>&nbsp;&nbsp;&nbsp; Runnable r1 =&nbsp;&nbsp;&nbsp; () -&gt; {System.out.println(“Hello Lambda!”);};<br>&nbsp;&nbsp;&nbsp; MyRunnable2 r2 = () -&gt; {System.out.println(“Hello Lambda!”);};</p>
<p>都是正确的写法。这说明一个&lambda;表达式可以有多个目标类型（函数接口），只要函数匹配成功即可。<br>但需注意一个&lambda;表达式必须至少有一个目标类型。</p>
<p>JDK预定义了很多函数接口以避免用户重复定义。最典型的是Function：</p>
<p>&nbsp;&nbsp;&nbsp; @FunctionalInterface<br>&nbsp;&nbsp;&nbsp; public interface Function&lt;T, R&gt; {&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R apply(T t);<br>&nbsp;&nbsp;&nbsp; }</p>
<p>这个接口代表一个函数，接受一个T类型的参数，并返回一个R类型的返回值。&nbsp;&nbsp;&nbsp;</p>
<p>另一个预定义函数接口叫做Consumer，跟Function的唯一不同是它没有返回值。</p>
<p>&nbsp;&nbsp;&nbsp; @FunctionalInterface<br>&nbsp;&nbsp;&nbsp; public interface Consumer&lt;T&gt; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void accept(T t);<br>&nbsp;&nbsp;&nbsp; }</p>
<p>还有一个Predicate，用来判断某项条件是否满足。经常用来进行筛滤操作：<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; @FunctionalInterface<br>&nbsp;&nbsp;&nbsp; public interface Predicate&lt;T&gt; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; boolean test(T t);<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>综上所述，一个&lambda;表达式其实就是定义了一个匿名方法，只不过这个方法必须符合至少一个函数接口。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><span><strong>3. &lambda;表达式的使用</strong></span></p>
<p><span><strong>3.1 &lambda;表达式用在何处</strong></span></p>
<p>&lambda;表达式主要用于替换以前广泛使用的内部匿名类，各种回调，比如事件响应器、传入Thread类的Runnable等。看下面的例子：</p>
<p>&nbsp;&nbsp;&nbsp; Thread oldSchool = new Thread( new Runnable () {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @Override<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void run() {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(“This is from an anonymous class.”);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; } );<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; Thread gaoDuanDaQiShangDangCi = new Thread( () -&gt; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(“This is from an anonymous method (lambda exp).”);<br>&nbsp;&nbsp;&nbsp; } );</p>
<p>注意第二个线程里的&lambda;表达式，你并不需要显式地把它转成一个Runnable，因为Java能根据上下文自动推断出来：一个Thread的构造函数接受一个Runnable参数，而传入的&lambda;表达式正好符合其run()函数，所以Java编译器推断它为Runnable。</p>
<p>从形式上看，&lambda;表达式只是为你节省了几行代码。但将&lambda;表达式引入Java的动机并不仅仅为此。Java8有一个短期目标和一个长期目标。短期目标是：配合&ldquo;集合类批处理操作&rdquo;的内部迭代和并行处理（下面将要讲到）；长期目标是将Java向函数式编程语言这个方向引导（并不是要完全变成一门函数式编程语言，只是让它有更多的函数式编程语言的特性），也正是由于这个原因，Oracle并没有简单地使用内部类去实现&lambda;表达式，而是使用了一种更动态、更灵活、易于将来扩展和改变的策略（invokedynamic）。</p>
<p><span><strong>3.2 &lambda;表达式与集合类批处理操作（或者叫块操作）</strong></span></p>
<p>上文提到了集合类的批处理操作。这是Java8的另一个重要特性，它与&lambda;表达式的配合使用乃是Java8的最主要特性。集合类的批处理操作API的目的是实现集合类的&ldquo;内部迭代&rdquo;，并期望充分利用现代多核CPU进行并行计算。<br>Java8之前集合类的迭代（Iteration）都是外部的，即客户代码。而内部迭代意味着改由Java类库来进行迭代，而不是客户代码。例如：</p>
<p>&nbsp;&nbsp;&nbsp; for(Object o: list) { // 外部迭代<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(o);<br>&nbsp;&nbsp;&nbsp; }</p>
<p>可以写成：</p>
<p>&nbsp;&nbsp;&nbsp; list.forEach(o -&gt; {System.out.println(o);}); //forEach函数实现内部迭代</p>
<p>集合类（包括List）现在都有一个forEach方法，对元素进行迭代（遍历），所以我们不需要再写for循环了。forEach方法接受一个函数接口Consumer做参数，所以可以使用&lambda;表达式。</p>
<p>这种内部迭代方法广泛存在于各种语言，如C++的STL算法库、python、ruby、scala等。</p>
<p>Java8为集合类引入了另一个重要概念：流（stream）。一个流通常以一个集合类实例为其数据源，然后在其上定义各种操作。流的API设计使用了管道（pipelines）模式。对流的一次操作会返回另一个流。如同IO的API或者StringBuffer的append方法那样，从而多个不同的操作可以在一个语句里串起来。看下面的例子：</p>
<p>&nbsp;&nbsp;&nbsp; List&lt;Shape&gt; shapes = …<br>&nbsp;&nbsp;&nbsp; shapes.stream()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .filter(s -&gt; s.getColor() == BLUE)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .forEach(s -&gt; s.setColor(RED));</p>
<p>首先调用stream方法，以集合类对象shapes里面的元素为数据源，生成一个流。然后在这个流上调用filter方法，挑出蓝色的，返回另一个流。最后调用forEach方法将这些蓝色的物体喷成红色。（forEach方法不再返回流，而是一个终端方法，类似于StringBuffer在调用若干append之后的那个toString）</p>
<p>filter方法的参数是Predicate类型，forEach方法的参数是Consumer类型，它们都是函数接口，所以可以使用&lambda;表达式。</p>
<p>还有一个方法叫parallelStream()，顾名思义它和stream()一样，只不过指明要并行处理，以期充分利用现代CPU的多核特性。</p>
<p>&nbsp;&nbsp;&nbsp; shapes.parallelStream(); // 或shapes.stream().parallel()</p>
<p>来看更多的例子。下面是典型的大数据处理方法，Filter-Map-Reduce：</p>
<p>&nbsp;&nbsp;&nbsp; //给出一个String类型的数组，找出其中所有不重复的素数<br>&nbsp;&nbsp;&nbsp; public void distinctPrimary(String… numbers) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;String&gt; l = Arrays.asList(numbers);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;Integer&gt; r = l.stream()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .map(e -&gt; new Integer(e))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .filter(e -&gt; Primes.isPrime(e))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .distinct()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .collect(Collectors.toList());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(“distinctPrimary result is: “ + r);<br>&nbsp;&nbsp;&nbsp; }</p>
<p>第一步：传入一系列String（假设都是合法的数字），转成一个List，然后调用stream()方法生成流。</p>
<p>第二步：调用流的map方法把每个元素由String转成Integer，得到一个新的流。map方法接受一个Function类型的参数，上面介绍了，Function是个函数接口，所以这里用&lambda;表达式。</p>
<p>第三步：调用流的filter方法，过滤那些不是素数的数字，并得到一个新流。filter方法接受一个Predicate类型的参数，上面介绍了，Predicate是个函数接口，所以这里用&lambda;表达式。</p>
<p>第四步：调用流的distinct方法，去掉重复，并得到一个新流。这本质上是另一个filter操作。</p>
<p>第五步：用collect方法将最终结果收集到一个List里面去。collect方法接受一个Collector类型的参数，这个参数指明如何收集最终结果。在这个例子中，结果简单地收集到一个List中。我们也可以用Collectors.toMap(e-&gt;e, e-&gt;e)把结果收集到一个Map中，它的意思是：把结果收到一个Map，用这些素数自身既作为键又作为值。toMap方法接受两个Function类型的参数，分别用以生成键和值，Function是个函数接口，所以这里都用&lambda;表达式。</p>
<p>你可能会觉得在这个例子里，List l被迭代了好多次，map，filter，distinct都分别是一次循环，效率会不好。实际并非如此。这些返回另一个Stream的方法都是&ldquo;懒（lazy）&rdquo;的，而最后返回最终结果的collect方法则是&ldquo;急（eager）&rdquo;的。在遇到eager方法之前，lazy的方法不会执行。</p>
<p>当遇到eager方法时，前面的lazy方法才会被依次执行。而且是管道贯通式执行。这意味着每一个元素依次通过这些管道。例如有个元素&ldquo;3&rdquo;，首先它被map成整数型3；然后通过filter，发现是素数，被保留下来；又通过distinct，如果已经有一个3了，那么就直接丢弃，如果还没有则保留。这样，3个操作其实只经过了一次循环。</p>
<p>除collect外其它的eager操作还有forEach，toArray，reduce等。</p>
<p>下面来看一下也许是最常用的收集器方法，groupingBy：</p>
<p>&nbsp;&nbsp;&nbsp; //给出一个String类型的数组，找出其中所有不重复的素数，并统计其出现次数<br>&nbsp;&nbsp;&nbsp; public void primaryOccurrence(String… numbers) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;String&gt; l = Arrays.asList(numbers);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Map&lt;Integer, Integer&gt; r = l.stream()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .map(e -&gt; new Integer(e))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .filter(e -&gt; Primes.isPrime(e))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .collect( Collectors.groupingBy(p-&gt;p, Collectors.summingInt(p-&gt;1)) );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(“primaryOccurrence result is: “ + r);<br>&nbsp;&nbsp;&nbsp; }</p>
<p>注意这一行：</p>
<p>&nbsp;&nbsp;&nbsp; Collectors.groupingBy(p-&gt;p, Collectors.summingInt(p-&gt;1))</p>
<p>它的意思是：把结果收集到一个Map中，用统计到的各个素数自身作为键，其出现次数作为值。</p>
<p>下面是一个reduce的例子：</p>
<p>&nbsp;&nbsp;&nbsp; //给出一个String类型的数组，求其中所有不重复素数的和<br>&nbsp;&nbsp;&nbsp; public void distinctPrimarySum(String… numbers) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;String&gt; l = Arrays.asList(numbers);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int sum = l.stream()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .map(e -&gt; new Integer(e))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .filter(e -&gt; Primes.isPrime(e))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .distinct()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .reduce(0, (x,y) -&gt; x+y); // equivalent to .sum()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(“distinctPrimarySum result is: “ + sum);<br>&nbsp;&nbsp;&nbsp; }</p>
<p>reduce方法用来产生单一的一个最终结果。<br>流有很多预定义的reduce操作，如sum()，max()，min()等。</p>
<p>再举个现实世界里的栗子比如：</p>
<p>&nbsp;&nbsp;&nbsp; // 统计年龄在25-35岁的男女人数、比例<br>&nbsp;&nbsp;&nbsp; public void boysAndGirls(List&lt;Person&gt; persons) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Map&lt;Integer, Integer&gt; result = persons.parallelStream().filter(p -&gt; p.getAge()&gt;=25 &amp;&amp; p.getAge()&lt;=35).<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; collect(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Collectors.groupingBy(p-&gt;p.getSex(), Collectors.summingInt(p-&gt;1))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.print(“boysAndGirls result is “ + result);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(“, ratio (male : female) is “ + (float)result.get(Person.MALE)/result.get(Person.FEMALE));<br>&nbsp;&nbsp;&nbsp; }</p>
<p><strong><span>3.3 &lambda;表达式的更多用法</span></strong></p>
<p>&nbsp;&nbsp;&nbsp; // 嵌套的&lambda;表达式<br>&nbsp;&nbsp;&nbsp; Callable&lt;Runnable&gt; c1 = () -&gt; () -&gt; { System.out.println(“Nested lambda”); };<br>&nbsp;&nbsp;&nbsp; c1.call().run();</p>
<p>&nbsp;&nbsp;&nbsp; // 用在条件表达式中<br>&nbsp;&nbsp;&nbsp; Callable&lt;Integer&gt; c2 = true ? (() -&gt; 42) : (() -&gt; 24);<br>&nbsp;&nbsp;&nbsp; System.out.println(c2.call());</p>
<p>&nbsp;&nbsp;&nbsp; // 定义一个递归函数<br>&nbsp;&nbsp;&nbsp; private UnaryOperator&lt;Integer&gt; factorial = i -&gt; { return i == 0 ? 1 : i * factorial.apply( i - 1 ); };<br>&nbsp;&nbsp;&nbsp; …<br>&nbsp;&nbsp;&nbsp; System.out.println(factorial.apply(3));</p>
<p>在Java中，随声明随调用的方式是不行的，比如下面这样，声明了一个&lambda;表达式(x, y) -&gt; x + y，同时企图通过传入实参(2, 3)来调用它：</p>
<p>&nbsp;&nbsp;&nbsp; int five = ( (x, y) -&gt; x + y ) (2, 3); // ERROR! try to call a lambda in-place</p>
<p>这在C++中是可以的，但Java中不行。Java的&lambda;表达式只能用作赋值、传参、返回值等。</p>
<p><span><strong>4. 其它相关概念</strong></span></p>
<p><strong><span>4.1 捕获（Capture）</span></strong></p>
<p>捕获的概念在于解决在&lambda;表达式中我们可以使用哪些外部变量（即除了它自己的参数和内部定义的本地变量）的问题。</p>
<p>答案是：与内部类非常相似，但有不同点。不同点在于内部类总是持有一个其外部类对象的引用。而&lambda;表达式呢，除非在它内部用到了其外部类（包围类）对象的方法或者成员，否则它就不持有这个对象的引用。</p>
<p>在Java8以前，如果要在内部类访问外部对象的一个本地变量，那么这个变量必须声明为final才行。在Java8中，这种限制被去掉了，代之以一个新的概念，&ldquo;effectively final&rdquo;。它的意思是你可以声明为final，也可以不声明final但是按照final来用，也就是一次赋值永不改变。换句话说，保证它加上final前缀后不会出编译错误。</p>
<p>在Java8中，内部类和&lambda;表达式都可以访问effectively final的本地变量。&lambda;表达式的例子如下：</p>
<p>&nbsp;&nbsp;&nbsp; …&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; int tmp1 = 1; //包围类的成员变量<br>&nbsp;&nbsp;&nbsp; static int tmp2 = 2; //包围类的静态成员变量<br>&nbsp;&nbsp;&nbsp; public void testCapture() {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int tmp3 = 3; //没有声明为final，但是effectively final的本地变量<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; final int tmp4 = 4; //声明为final的本地变量<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int tmp5 = 5; //普通本地变量<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Function&lt;Integer, Integer&gt; f1 = i -&gt; i + tmp1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Function&lt;Integer, Integer&gt; f2 = i -&gt; i + tmp2;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Function&lt;Integer, Integer&gt; f3 = i -&gt; i + tmp3;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Function&lt;Integer, Integer&gt; f4 = i -&gt; i + tmp4;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Function&lt;Integer, Integer&gt; f5 = i -&gt; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tmp5&nbsp; += i; // 编译错！对tmp5赋值导致它不是effectively final的<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return tmp5;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; …<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tmp5 = 9; // 编译错！对tmp5赋值导致它不是effectively final的<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; …</p>
<p>Java要求本地变量final或者effectively final的原因是多线程并发问题。内部类、&lambda;表达式都有可能在不同的线程中执行，允许多个线程同时修改一个本地变量不符合Java的设计理念。</p>
<p><strong><span>4.2 方法引用（Method reference）</span></strong></p>
<p>任何一个&lambda;表达式都可以代表某个函数接口的唯一方法的匿名描述符。我们也可以使用某个类的某个具体方法来代表这个描述符，叫做方法引用。例如：</p>
<p>&nbsp;&nbsp;&nbsp; Integer::parseInt //静态方法引用<br>&nbsp;&nbsp;&nbsp; System.out::print //实例方法引用<br>&nbsp;&nbsp;&nbsp; Person::new&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //构造器引用</p>
<p>下面是一组例子，教你使用方法引用代替&lambda;表达式：</p>
<p>&nbsp;&nbsp;&nbsp; //c1 与 c2 是一样的（静态方法引用）<br>&nbsp;&nbsp;&nbsp; Comparator&lt;Integer&gt; c2 = (x, y) -&gt; Integer.compare(x, y);<br>&nbsp;&nbsp;&nbsp; Comparator&lt;Integer&gt; c1 = Integer::compare;<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; //下面两句是一样的（实例方法引用1）<br>&nbsp;&nbsp;&nbsp; persons.forEach(e -&gt; System.out.println(e));<br>&nbsp;&nbsp;&nbsp; persons.forEach(System.out::println);<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; //下面两句是一样的（实例方法引用2）<br>&nbsp;&nbsp;&nbsp; persons.forEach(person -&gt; person.eat());<br>&nbsp;&nbsp;&nbsp; persons.forEach(Person::eat);<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; //下面两句是一样的（构造器引用）<br>&nbsp;&nbsp;&nbsp; strList.stream().map(s -&gt; new Integer(s));<br>&nbsp;&nbsp;&nbsp; strList.stream().map(Integer::new);<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>使用方法引用，你的程序会变得更短些。现在distinctPrimarySum方法可以改写如下：</p>
<p>&nbsp;&nbsp;&nbsp; public void distinctPrimarySum(String… numbers) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;String&gt; l = Arrays.asList(numbers);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int sum = l.stream().map(Integer::new).filter(Primes::isPrime).distinct().sum();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.out.println(“distinctPrimarySum result is: “ + sum);<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>还有一些其它的方法引用:</p>
<p>&nbsp;&nbsp;&nbsp; super::methName //引用某个对象的父类方法<br>&nbsp;&nbsp;&nbsp; TypeName[]::new //引用一个数组的构造器</p>
<p><strong><span>4.3 默认方法（Default method）</span></strong></p>
<p>Java8中，接口声明里可以有方法实现了，叫做默认方法。在此之前，接口里的方法全部是抽象方法。</p>
<p>&nbsp;&nbsp;&nbsp; public interface MyInterf {<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String m1();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default String m2() {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return “Hello default method!”;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>这实际上有点混淆接口和抽象类，但一个类仍然可以实现多个接口，而只能继承一个抽象类。</p>
<p>这么做的原因是：由于Collection库需要为批处理操作添加新的方法，如forEach()，stream()等，但是不能修改现有的Collection接口&mdash;&mdash;如果那样做的话所有的实现类都要进行修改，包括很多客户自制的实现类。</p>
<p>那么，我们就面临一种类似多继承的问题。如果类Sub继承了两个接口，Base1和Base2，而这两个接口恰好具有完全相同的两个默认方法，那么就会产生冲突。这时Sub类就必须通过重载来显式指明自己要使用哪一个接口的实现（或者提供自己的实现）：<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; public class Sub implements Base1, Base2 {<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void hello() {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Base1.super.hello(); //使用Base1的实现<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>除了默认方法，Java8的接口也可以有静态方法的实现：</p>
<p>&nbsp;&nbsp;&nbsp; public interface MyInterf {<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; String m1();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default String m2() {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return “Hello default method!”;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static String m3() {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return “Hello static method in Interface!”;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;<br><strong><span>4.4 生成器函数（Generator function）</span></strong></p>
<p>有时候一个流的数据源不一定是一个已存在的集合对象，也可能是个&ldquo;生成器函数&rdquo;。一个生成器函数会产生一系列元素，供给一个流。Stream.generate(Supplier&lt;T&gt; s)就是一个生成器函数。其中参数Supplier是一个函数接口，里面有唯一的抽象方法 &lt;T&gt; get()。</p>
<p>下面这个例子生成并打印5个随机数：</p>
<p>&nbsp;&nbsp;&nbsp; Stream.generate(Math::random).limit(5).forEach(System.out::println);</p>
<p>注意这个limit(5)，如果没有这个调用，那么这条语句会永远地执行下去。也就是说这个生成器是无穷的。这种调用叫做终结操作，或者短路（short-circuiting）操作。</p>
<p>&nbsp;</p>
<p><span><strong>参考资料：</strong></span><br><a href="http://openjdk.java.net/projects/lambda/" target="_blank" rel="noopener">http://openjdk.java.net/projects/lambda/</a><br><a href="http://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html" target="_blank" rel="noopener">http://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html</a></p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> java8 </tag>
            
            <tag> lambda </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Android]异步加载图片，内存缓存，文件缓存，imageview显示图片时增加淡入淡出动画]]></title>
      <url>/2014/02/28/Android-%E5%BC%82%E6%AD%A5%E5%8A%A0%E8%BD%BD%E5%9B%BE%E7%89%87%EF%BC%8C%E5%86%85%E5%AD%98%E7%BC%93%E5%AD%98%EF%BC%8C%E6%96%87%E4%BB%B6%E7%BC%93%E5%AD%98%EF%BC%8Cimageview%E6%98%BE%E7%A4%BA%E5%9B%BE%E7%89%87%E6%97%B6%E5%A2%9E%E5%8A%A0%E6%B7%A1%E5%85%A5%E6%B7%A1%E5%87%BA%E5%8A%A8%E7%94%BB/</url>
      <content type="html"><![CDATA[<p>这个可以实现ImageView异步加载图片，内存缓存，文件缓存，imageview显示图片时增加淡入淡出动画。</p>
<p>github地址：<a href="https://github.com/wangjiegulu/ImageLoaderSample" target="_blank" rel="noopener">https://github.com/wangjiegulu/ImageLoaderSample</a></p>
<p>解决了：</p>
<p>1. listview加载oom问题</p>
<p>2. listview加载时卡顿的现象</p>
<p>3. listview加载时item中图片重复错位等情况</p>
<p>可以配置：</p>
<p>1. 设置加载图片的最大尺寸</p>
<p>2. 设置默认图片的显示</p>
<p>3. 设置图片位图模式</p>
<p>4. 设置内存缓存的最大值。</p>
<p>5. 文件缓存保存的目录</p>
<p>　　这个框架基本的代码是很久以前不知道哪里弄的，零零碎碎的，现在已经优化了很多，所以现在上传到github上共享。</p>
<p>　　讲讲使用方式吧：</p>
<p>&nbsp;</p>
<p>首先使用前下载源码或者jar包（见github：<a href="https://github.com/wangjiegulu/ImageLoaderSample" target="_blank" rel="noopener">https://github.com/wangjiegulu/ImageLoaderSample</a>）</p>
<p>然后进行图片加载器（ImageLoader）的配置和初始化，推荐的方法如下：</p>
<p>新建MyApplication类，继承Application，在onCreate中增加如下代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">  Date: 14-2-27<br></span><span style="color: #008080;"> 5</span> <span style="color: #008000;"> <em> Time: 上午11:25<br></em></span><span style="color: #008080;"> 6</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MyApplication <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Application{<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate() {<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate();<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">        ImageLoader.init(getApplicationContext(),<br></span><span style="color: #008080;">12</span>                 <span style="color: #0000ff;">new</span><span style="color: #000000;"> CacheConfig()<br></span><span style="color: #008080;">13</span>                     .setDefRequiredSize(600) <span style="color: #008000;">//</span><span style="color: #008000;"> 设置默认的加载图片尺寸（表示宽高任一不超过该值，默认是70px）</span><br><span style="color: #008080;">14</span>                     .setDefaultResId(R.drawable.ic_launcher) <span style="color: #008000;">//</span><span style="color: #008000;"> 设置显示的默认图片（默认是0，即空白图片）</span><br><span style="color: #008080;">15</span>                     .setBitmapConfig(Bitmap.Config.ARGB_8888) <span style="color: #008000;">//</span><span style="color: #008000;"> 设置图片位图模式（默认是Bitmap.CacheConfig.ARGB_8888）</span><br><span style="color: #008080;">16</span>                     .setMemoryCachelimit(Runtime.getRuntime().maxMemory() / 3) <span style="color: #008000;">//</span><span style="color: #008000;"> 设置图片内存缓存大小（默认是Runtime.getRuntime().maxMemory() / 4）<br></span><span style="color: #008080;">17</span> <span style="color: #008000;">//</span><span style="color: #008000;">                  .setFileCachePath(Environment.getExternalStorageDirectory().toString() + “/mycache”) </span><span style="color: #008000;">//</span><span style="color: #008000;"> 设置文件缓存保存目录</span><br><span style="color: #008080;">18</span> <span style="color: #000000;">        );<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> <span style="color: #000000;">    &hellip;&hellip;<br></span><span style="color: #008080;">24</span> }</pre><br></div>

<p>&nbsp;</p>
<p>然后再AndroidManifest.xml中添加：</p>
<div class="cnblogs_code"><br><pre>&lt;<span style="color: #000000;">application<br>            ……<br>            android:name</span>=”MyApplication”&gt;<span style="color: #000000;"><br>            ……<br></span>&lt;/application&gt;</pre><br></div>

<p>到此，配置已经全部完成：</p>
<p>接下来，使用ImageLoader来加载图片：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> holder.progress.setText(“0%”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">    holder.progress.setVisibility(View.VISIBLE);<br></span><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">final</span> ViewHolder vhr =<span style="color: #000000;"> holder;<br></span><span style="color: #008080;"> 4</span>     ImageLoader.getInstances().displayImage(list.get(position), holder.image, <span style="color: #0000ff;">new</span><span style="color: #000000;"> ImageLoader.OnImageLoaderListener() {<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onProgressImageLoader(ImageView imageView, <span style="color: #0000ff;">int</span> currentSize, <span style="color: #0000ff;">int</span><span style="color: #000000;"> totalSize) {<br></span><span style="color: #008080;"> 7</span>             vhr.progress.setText(currentSize * 100 / totalSize + “%”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onFinishedImageLoader(ImageView imageView, Bitmap bitmap) {<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">            vhr.progress.setVisibility(View.GONE);<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">    });<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">    或者：<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">    ImageLoader.getInstances().displayImage(url, imageIv);<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">    或者<br></span><span style="color: #008080;">18</span>     ImageLoader.getInstances().displayImage(url, imageIv, 100);</pre><br></div>

<p>备注：</p>
<p>例子中，用到了一部分注解（与ImageLoader功能无关，但是可以简化代码的编写） 可以点下面连接进入：</p>
<p>github：<a href="https://github.com/wangjiegulu/androidInject" target="_blank" rel="noopener">https://github.com/wangjiegulu/androidInject</a></p>
<p>博客：</p>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/3459139.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/3459139.html</a></p>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/3540427.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/3540427.html</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ImageView </tag>
            
            <tag> ImageLoader </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Hbase Java API详解]]></title>
      <url>/2014/02/20/Hbase-Java-API%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<p>HBase是Hadoop的数据库，能够对大数据提供随机、实时读写访问。他是开源的，分布式的，多版本的，面向列的，存储模型。</p>
<p>在讲解的时候我首先给大家讲解一下HBase的整体结构，如下图：</p>
<p><img src="http://static.open-open.com/lib/uploadImg/20120717/20120717163859_417.jpg" alt=" HBase Java API详解 "></p>
<p>HBase Master是服务器负责管理所有的HRegion服务器，HBase Master并不存储HBase服务器的任何数据，HBase逻辑上的表可能会划分为多个HRegion，然后存储在HRegion Server群中，HBase Master Server中存储的是从数据到HRegion Server的映射。</p>
<p>一台机器只能运行一个HRegion服务器，数据的操作会记录在Hlog中，在读取数据时候，HRegion会先访问Hmemcache缓存，如果 缓存中没有数据才回到Hstore中上找，没一个列都会有一个Hstore集合，每个Hstore集合包含了很多具体的HstoreFile文件，这些文 件是B树结构的，方便快速读取。</p>
<p>&nbsp;</p>
<p>再看下HBase数据物理视图如下：</p>
<p>&nbsp;</p>
<table border="1" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td rowspan="2" width="67"><strong>Row Key</strong></td><br><td rowspan="2" width="104"><strong>Timestamp</strong></td><br><td colspan="2" width="385"><strong>Column Family</strong></td><br></tr><br><tr><br><td width="227"><strong>URI</strong></td><br><td width="158"><strong>Parser</strong></td><br></tr><br><tr><br><td rowspan="3" width="67">r1</td><br><td width="104">t3</td><br><td width="227">url=<a href="http://www.taobao.com" target="_blank" rel="noopener">http://www.taobao.com</a></td><br><td width="158">title=天天特价</td><br></tr><br><tr><br><td width="104">t2</td><br><td width="227">host=taobao.com</td><br><td width="158">&nbsp;</td><br></tr><br><tr><br><td width="104">t1</td><br><td width="227">&nbsp;</td><br><td width="158">&nbsp;</td><br></tr><br><tr><br><td rowspan="2" width="67">r2</td><br><td width="104">t5</td><br><td width="227">url=<a href="http://www.alibaba.com" target="_blank" rel="noopener">http://www.alibaba.com</a></td><br><td width="158">content=每天&hellip;</td><br></tr><br><tr><br><td width="104">t4</td><br><td width="227">host=alibaba.com</td><br><td width="158">&nbsp;</td><br></tr><br></tbody><br></table>

<p><span>&Oslash;&nbsp;&nbsp;Row Key: 行键，Table的主键，Table中的记录按照Row Key排序</span></p>
<p><span>&Oslash;&nbsp;&nbsp;Timestamp: 时间戳，每次数据操作对应的时间戳，可以看作是数据的version number</span></p>
<p><span>&Oslash;&nbsp;&nbsp;Column Family：列簇，Table在水平方向有一个或者多个Column Family组成，一个Column Family中可以由任意多个Column组成，即Column Family支持动态扩展，无需预先定义Column的数量以及类型，所有Column均以二进制格式存储，用户需要自行进行类型转换。</span></p>
<p>&nbsp;</p>
<p>了解了HBase的体系结构和HBase数据视图够，现在让我们一起看看怎样通过Java来操作HBase数据吧！</p>
<p>先说说具体的API先，如下</p>
<p>&nbsp;</p>
<p><span>HBaseConfiguration</span>是每一个hbase client都会使用到的对象，它代表的<span>是HBase配置信息</span>。它有两种构造方式：</p>
<p>public HBaseConfiguration()</p>
<p>public HBaseConfiguration(final Configuration c)</p>
<p>默认的构造方式会尝试从hbase-default.xml和hbase-site.xml中读取配置。如果classpath没有这两个文件，就需要你自己设置配置。</p>
<p>Configuration HBASE_CONFIG = new Configuration();</p>
<p>HBASE_CONFIG.set(&ldquo;hbase.zookeeper.quorum&rdquo;, &ldquo;zkServer&rdquo;);</p>
<p>HBASE_CONFIG.set(&ldquo;hbase.zookeeper.property.clientPort&rdquo;, &ldquo;2181&Prime;);</p>
<p>HBaseConfiguration cfg = new HBaseConfiguration(HBASE_CONFIG);</p>
<p>&nbsp;</p>
<p>创建表</p>
<p><span>创建表是通过HBaseAdmin对象来操作的</span>。HBaseAdmin负责表的META信息处理。HBaseAdmin提供了createTable这个方法：</p>
<p>public void createTable(HTableDescriptor desc)</p>
<p><span>HTableDescriptor 代表的是表的schema</span>, 提供的方法中比较有用的有</p>
<p>setMaxFileSize，指定最大的region size</p>
<p>setMemStoreFlushSize 指定memstore flush到HDFS上的文件大小</p>
<p>&nbsp;</p>
<p>增加family通过 addFamily方法</p>
<p>public void addFamily(final HColumnDescriptor family)</p>
<p>HColumnDescriptor 代表的是column的schema，提供的方法比较常用的有</p>
<p><span>setTimeToLive:指定最大的TTL,单位是ms,过期数据会被自动删除</span>。</p>
<p>setInMemory:指定是否放在内存中，对小表有用，可用于提高效率。默认关闭</p>
<p>setBloomFilter:指定是否使用BloomFilter,可提高随机查询效率。默认关闭</p>
<p>setCompressionType:设定数据压缩类型。默认无压缩。</p>
<p>setMaxVersions:指定数据最大保存的版本个数。默认为3。</p>
<p>&nbsp;</p>
<p><span>一个简单的例子，创建了4个family的表：</span></p>
<div class="cnblogs_code"><br><pre>HBaseAdmin hAdmin = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HBaseAdmin(hbaseConfig);<br><br>HTableDescriptor t </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> HTableDescriptor(tableName);<br><br>t.addFamily(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> HColumnDescriptor(&ldquo;f1&Prime;));<br><br>t.addFamily(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> HColumnDescriptor(&ldquo;f2&Prime;));<br><br>t.addFamily(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> HColumnDescriptor(&ldquo;f3&Prime;));<br><br>t.addFamily(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> HColumnDescriptor(&ldquo;f4&Prime;));<br><br>hAdmin.createTable(t);</span></pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p>删除表</p>
<p><span>删除表也是通过HBaseAdmin来操作，删除表之前首先要disable表。</span>这是一个非常耗时的操作，所以不建议频繁删除表。</p>
<p>disableTable和deleteTable分别用来disable和delete表。</p>
<p>Example:</p>
<div class="cnblogs_code"><br><pre>HBaseAdmin hAdmin = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HBaseAdmin(hbaseConfig);<br><br></span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (hAdmin.tableExists(tableName)) {<br><br>       hAdmin.disableTable(tableName);<br><br>       hAdmin.deleteTable(tableName);<br><br>}</span></pre><br></div>

<p><span style="line-height: 1.5;">&nbsp;</span></p>
<p>查询数据</p>
<p><span>查询分为单条随机查询和批量查询。</span></p>
<p><span>单条查询是通过rowkey在table中查询某一行的数据</span>。HTable提供了get方法来完成单条查询。</p>
<p><span>批量查询是通过制定一段rowkey的范围来查询</span>。HTable提供了个getScanner方法来完成批量查询。</p>
<p>public Result get(final Get get)</p>
<p>public ResultScanner getScanner(final Scan scan)</p>
<p>Get对象包含了一个Get查询需要的信息。它的构造方法有两种：</p>
<p>&nbsp; public Get(byte [] row)</p>
<p>&nbsp; public Get(byte [] row, RowLock rowLock)</p>
<p>Rowlock是为了保证读写的原子性，你可以传递一个已经存在Rowlock，否则HBase会自动生成一个新的rowlock。</p>
<p>Scan对象提供了默认构造函数，一般使用默认构造函数。</p>
<p>&nbsp;</p>
<p>Get/Scan的常用方法有：</p>
<p>addFamily/addColumn:指定需要的family或者column,如果没有调用任何addFamily或者Column,会返回所有的columns.</p>
<p>setMaxVersions:指定最大的版本个数。如果不带任何参数调用setMaxVersions,表示取所有的版本。如果不掉用setMaxVersions,只会取到最新的版本。</p>
<p>setTimeRange:指定最大的时间戳和最小的时间戳，只有在此范围内的cell才能被获取。</p>
<p>setTimeStamp:指定时间戳。</p>
<p>setFilter:指定Filter来过滤掉不需要的信息</p>
<p>&nbsp;</p>
<p>Scan特有的方法：</p>
<p>setStartRow:指定开始的行。如果不调用，则从表头开始。</p>
<p>setStopRow:指定结束的行（不含此行）。</p>
<p>setBatch:指定最多返回的Cell数目。用于防止一行中有过多的数据，导致OutofMemory错误。</p>
<p>ResultScanner是Result的一个容器，每次调用ResultScanner的next方法，会返回Result.</p>
<p>public Result next() throws IOException;</p>
<p>public Result [] next(int nbRows) throws IOException;</p>
<p>&nbsp;</p>
<p>Result代表是一行的数据。常用方法有：</p>
<p>getRow:返回rowkey</p>
<p>raw:返回所有的key value数组。</p>
<p>getValue:按照column来获取cell的值</p>
<p>&nbsp;</p>
<p>Example:</p>
<div class="cnblogs_code"><br><pre>Scan s = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Scan();<br><br>s.setMaxVersions();<br><br>ResultScanner ss </span>=<span style="color: #000000;"> table.getScanner(s);<br><br></span><span style="color: #0000ff;">for</span><span style="color: #000000;">(Result r:ss){<br><br>    System.out.println(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> String(r.getRow()));<br><br>    </span><span style="color: #0000ff;">for</span><span style="color: #000000;">(KeyValue kv:r.raw()){<br><br>       System.out.println(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> String(kv.getColumn()));<br><br>    }<br><br>}</span></pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span>插入数据</span></p>
<p>HTable通过put方法来插入数据。&nbsp;</p>
<p>public void put(final Put put) throws IOException</p>
<p>public void put(final List&nbsp;puts) throws IOException</p>
<p>可以传递单个批Put对象或者List put对象来分别实现单条插入和批量插入。</p>
<p>Put提供了3种构造方式：</p>
<p>public Put(byte [] row)</p>
<p>public Put(byte [] row, RowLock rowLock)</p>
<p>public Put(Put putToCopy)&nbsp;</p>
<p>&nbsp;</p>
<p>Put常用的方法有：</p>
<p>add:增加一个Cell</p>
<p>setTimeStamp:指定所有cell默认的timestamp,如果一个Cell没有指定timestamp,就会用到这个值。如果没有调用，HBase会将当前时间作为未指定timestamp的cell的timestamp.</p>
<p>setWriteToWAL: WAL是Write Ahead Log的缩写，指的是HBase在插入操作前是否写Log。默认是打开，关掉会提高性能，但是如果系统出现故障(负责插入的Region Server挂掉)，数据可能会丢失。</p>
<p>另外HTable也有两个方法也会影响插入的性能</p>
<p>setAutoFlash: AutoFlush指的是在每次调用HBase的Put操作，是否提交到HBase Server。默认是true,每次会提交。如果此时是单条插入，就会有更多的IO,从而降低性能.</p>
<p>setWriteBufferSize: Write Buffer Size在AutoFlush为false的时候起作用，默认是2MB,也就是当插入数据超过2MB,就会自动提交到Server</p>
<p>&nbsp;</p>
<p>Example:</p>
<div class="cnblogs_code"><br><pre>HTable table = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HTable(hbaseConfig, tableName);<br><br>table.setAutoFlush(autoFlush);<br><br>List lp </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> ArrayList();<br><br></span><span style="color: #0000ff;">int</span> count = 10000<span style="color: #000000;">;<br><br></span><span style="color: #0000ff;">byte</span>[] buffer = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">byte</span>[1024<span style="color: #000000;">];<br><br>Random r </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Random();<br><br></span><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 1; i &lt;= count; ++<span style="color: #000000;">i) {<br><br>       Put p </span>= <span style="color: #0000ff;">new</span> Put(String.format(&ldquo;row%<span style="color: #000000;">09d&rdquo;,i).getBytes());<br><br>       r.nextBytes(buffer);<br><br>       p.add(&ldquo;f1&Prime;.getBytes(), </span><span style="color: #0000ff;">null</span><span style="color: #000000;">, buffer);<br><br>       p.add(&ldquo;f2&Prime;.getBytes(), </span><span style="color: #0000ff;">null</span><span style="color: #000000;">, buffer);<br><br>       p.add(&ldquo;f3&Prime;.getBytes(), </span><span style="color: #0000ff;">null</span><span style="color: #000000;">, buffer);<br><br>       p.add(&ldquo;f4&Prime;.getBytes(), </span><span style="color: #0000ff;">null</span><span style="color: #000000;">, buffer);<br><br>       p.setWriteToWAL(wal);<br><br>       lp.add(p);<br><br>       </span><span style="color: #0000ff;">if</span>(i%1000==0<span style="color: #000000;">){<br><br>           table.put(lp);<br><br>           lp.clear();<br><br>       }<br><br>    }</span></pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span>删除数据</span></p>
<p>HTable 通过delete方法来删除数据。</p>
<p>&nbsp; public void delete(final Delete delete)&nbsp;</p>
<p>&nbsp;</p>
<p>Delete构造方法有：</p>
<p>public Delete(byte [] row)</p>
<p>public Delete(byte [] row, long timestamp, RowLock rowLock)</p>
<p>public Delete(final Delete d)</p>
<p>Delete常用方法有</p>
<p>deleteFamily/deleteColumns:指定要删除的family或者column的数据。如果不调用任何这样的方法，将会删除整行。</p>
<p>注意：如果某个Cell的timestamp高于当前时间，这个Cell将不会被删除，仍然可以查出来。</p>
<p>&nbsp;</p>
<p>Example:</p>
<div class="cnblogs_code"><br><pre>HTable table = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HTable(hbaseConfig, &ldquo;mytest&rdquo;);<br><br>Delete d </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Delete(&ldquo;row1&Prime;.getBytes());<br><br>table.delete(d) </span></pre><br></div>

<p><span style="line-height: 1.5;">&nbsp;</span></p>
<p><span>切分表</span></p>
<p>HBaseAdmin提供split方法来将table 进行split.</p>
<p>public void split(final String tableNameOrRegionName)</p>
<p>&nbsp;</p>
<p>如果提供的tableName，那么会将table所有region进行split ;如果提供的region Name，那么只会split这个region.</p>
<p>由于split是一个异步操作，我们并不能确切的控制region的个数。</p>
<p>&nbsp;</p>
<p>Example:</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> split(String tableName,<span style="color: #0000ff;">int</span> number,<span style="color: #0000ff;">int</span> timeout) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {<br><br>    Configuration HBASE_CONFIG </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Configuration();<br><br>    HBASE_CONFIG.set(&ldquo;hbase.zookeeper.quorum&rdquo;, GlobalConf.ZOOKEEPER_QUORUM);<br><br>    HBASE_CONFIG.set(&ldquo;hbase.zookeeper.property.clientPort&rdquo;, GlobalConf.ZOOKEEPER_PORT);<br><br>    HBaseConfiguration cfg </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> HBaseConfiguration(HBASE_CONFIG);<br><br>    HBaseAdmin hAdmin </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> HBaseAdmin(cfg);<br><br>    HTable hTable </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> HTable(cfg,tableName);<br><br>    </span><span style="color: #0000ff;">int</span> oldsize = 0<span style="color: #000000;">;<br><br>    t </span>=<span style="color: #000000;">  System.currentTimeMillis();<br><br>    </span><span style="color: #0000ff;">while</span>(<span style="color: #0000ff;">true</span><span style="color: #000000;">){<br><br>       </span><span style="color: #0000ff;">int</span> size =<span style="color: #000000;"> hTable.getRegionsInfo().size();<br><br>       logger.info(&ldquo;the region number</span>=&rdquo;+<span style="color: #000000;">size);<br><br>       </span><span style="color: #0000ff;">if</span>(size&gt;=number ) <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br><br>       </span><span style="color: #0000ff;">if</span>(size!=<span style="color: #000000;">oldsize){<br><br>           hAdmin.split(hTable.getTableName());<br><br>           oldsize </span>=<span style="color: #000000;"> size;<br><br>       }       </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(System.currentTimeMillis()-t&gt;<span style="color: #000000;">timeout){<br><br>           </span><span style="color: #0000ff;">break</span><span style="color: #000000;">;<br><br>       }<br><br>       Thread.sleep(</span>1000*10<span style="color: #000000;">);<br><br>    }<br><br>}</span></pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p>来自：<a href="http://www.open-open.com/lib/view/open1342514370807.html" target="_blank" rel="noopener">http://www.open-open.com/lib/view/open1342514370807.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> java </tag>
            
            <tag> Hbase </tag>
            
            <tag> j2ee </tag>
            
            <tag> java web </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[在Ubuntu上安装Hadoop（单机模式）步骤]]></title>
      <url>/2014/02/17/%E5%9C%A8Ubuntu%E4%B8%8A%E5%AE%89%E8%A3%85Hadoop%EF%BC%88%E5%8D%95%E6%9C%BA%E6%A8%A1%E5%BC%8F%EF%BC%89%E6%AD%A5%E9%AA%A4/</url>
      <content type="html"><![CDATA[<p>1. 安装jdk：<br>sudo apt-get install openjdk-6-jdk</p>
<p>2. 配置ssh：<br>安装ssh：<br>apt-get install openssh-server</p>
<p>为运行hadoop的用户生成一个SSH key：<br>$ ssh-keygen -t rsa -P “”</p>
<p>让你可以通过新生成的key来登录本地机器：<br>$ cp ~/.ssh/id_rsa.pub ~/.ssh/authorized_keys</p>
<p>3. 安装hadoop：<br>下载hadoop tar.gz包<br>并解压：<br>tar -zxvf hadoop-2.2.0.tar.gz</p>
<p>4. 配置：</p>
<ul>
<li><p>在~/.bashrc文件中添加：<br>export HADOOP_HOME=/usr/local/hadoop<br>export JAVA_HOME=/usr/lib/jvm/java-6-openjdk-amd64<br>export PATH=$PATH:$HADOOP_HOME/bin<br>在修改完成后保存，重新登录，相应的环境变量就配置好了。</p>
</li>
<li><p>配置hadoop-env.sh：<br>export JAVA_HOME=/usr/lib/jvm/java-6-openjdk-amd64</p>
</li>
<li><p>配置hdfs-site.xml：<br>&lt;property&gt;</p>
<p>  &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;</p>
<p>  &lt;value&gt;/app/hadoop/tmp&lt;/value&gt;<br>  &lt;description&gt;A base for other temporary directories.&lt;/description&gt;</p>
</li>
</ul>
<p>&lt;/property&gt;</p>
<p>&lt;property&gt;<br>    &lt;name&gt;fs.default.name&lt;/name&gt;</p>
<pre><code>&amp;lt;value&amp;gt;hdfs://localhost:9000&amp;lt;/value&amp;gt;
&amp;lt;description&amp;gt;The name of the default file system.  A URI whose
</code></pre><p>  scheme and </p>
<p>authority determine the FileSystem implementation.  The<br>  uri’s scheme determines the </p>
<p>config property (fs.SCHEME.impl) naming<br>  the FileSystem implementation class.  The uri’s </p>
<p>authority is used to<br>  determine the host, port, etc. for a filesystem.&lt;/description&gt;<br>&lt;/property&gt;</p>
<ul>
<li><p>配置mapred-site.xml：<br>&lt;property&gt;<br>&lt;name&gt;mapred.job.tracker&lt;/name&gt;<br>&lt;value&gt;localhost:9001&lt;/value&gt;<br>&lt;description&gt;The host and port that the MapReduce job tracker runs<br>at.  If “local”, then jobs are run in-process as a single map<br>and reduce task.<br>&lt;/description&gt;<br>&lt;/property&gt;</p>
</li>
<li><p>配置hdfs-site.xml：<br>&lt;property&gt;</p>
<p>  &lt;name&gt;dfs.replication&lt;/name&gt;</p>
<p>  &lt;value&gt;1&lt;/value&gt;<br>  &lt;description&gt;Default block replication.<br>The actual number of replications can be </p>
</li>
</ul>
<p>specified when the file is created.<br>  The default is used if replication is not specified </p>
<p>in create time.<br>  &lt;/description&gt;</p>
<p>&lt;/property&gt;</p>
<p>5. 通过 NameNode 来格式化 HDFS 文件系统<br>$ /usr/local/hadoop/bin/hadoop namenode -format</p>
<p>6. 运行hadoop<br>$ /usr/local/hadoop/sbin/start-all.sh</p>
<p>7. 检查hadoop的运行状况</p>
<ul>
<li><p>使用jps来检查hadoop的运行状况：<br>$ jps</p>
</li>
<li><p>使用netstat 命令来检查 hadoop 是否正常运行：<br>$ sudo netstat -plten | grep java</p>
</li>
</ul>
<p>8. 停止运行hadoop：<br>$ /usr/local/hadoop/bins/stop-all.sh</p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> j2ee </tag>
            
            <tag> java web </tag>
            
            <tag> ubuntu </tag>
            
            <tag> hadoop </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[android]亲自破解Flappy Bird（去广告+永生）]]></title>
      <url>/2014/02/11/android-%E4%BA%B2%E8%87%AA%E7%A0%B4%E8%A7%A3Flappy-Bird%EF%BC%88%E5%8E%BB%E5%B9%BF%E5%91%8A-%E6%B0%B8%E7%94%9F%EF%BC%89/</url>
      <content type="html"><![CDATA[<p><span>听说最近Flappy Bird很火，但是难度令人发指，于是怒了，亲自破解（去广告+永生）</span></p>
<p><span>只要不碰到地上，永远不死，直接穿过管道- -！下载地址：</span><a href="http://pan.baidu.com/s/1kT7bA55" target="_blank" rel="noopener">http://pan.baidu.com/s/1kT7bA55</a></p>
<p>注意：只支持android版本</p>
<p>效果图：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201402/111729388451360.png" alt="">&nbsp;<img src="http://images.cnitblog.com/blog/378300/201402/111730054144409.png" alt=""></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>反编译后修改smali：</p>
<p><span style="color: #ff0000;">去广告：</span></p>
<p>修改Flappy_Bird\smali\com\dotgears\a.smali和b.smali中run()方法中对应修改为：</p>
<div class="cnblogs_code"><br><pre><span style="color: #000000;">const/4 v1, 0x4<br><br>    invoke-virtual {v0, v1}, Lcom/google/ads/AdView;-&gt;setVisibility(I)V</span></pre><br></div>

<p>&nbsp;</p>
<p><span style="line-height: 1.5; color: #ff0000;">永生（取消碰撞检测即可）：</span></p>
<p>修改Flappy_Bird\smali\com\dotgears\flappy\c.smali</p>
<div class="cnblogs_code"><br><pre><span style="color: #000000;">.method public static a(IIIIIIII)Z<br>    .locals 1<br><br>    add-int v0, p0, p2<br><br>    if-lt v0, p4, :cond_0<br><br>    add-int v0, p4, p6<br><br>    if-gt p0, v0, :cond_0<br><br>    add-int v0, p1, p3<br><br>    if-lt v0, p5, :cond_0<br><br>    add-int v0, p5, p7<br><br>    if-le p1, v0, :cond_1<br><br>    :cond_0<br>    const/4 v0, 0x0<br><br>    :goto_0<br>    return v0<br><br>    :cond_1<br>    const/4 v0, 0x1<br><br>    goto :goto_0<br>.end method</span></pre><br></div>

<p>改为：</p>
<div class="cnblogs_code"><br><pre><span style="color: #000000;">.method public static a(IIIIIIII)Z<br>    .locals 1<br><br>    :cond_0<br>    const/4 v0, 0x0<br><br>    :goto_0<br>    return v0<br><br>    :cond_1<br>    const/4 v0, 0x1<br><br>    goto :goto_0<br>.end method</span></pre><br></div>

<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> 破解 </tag>
            
            <tag> Flappy Bird </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[AndroidInject项目使用动态代理增加对网络请求的支持]]></title>
      <url>/2014/02/08/AndroidInject%E9%A1%B9%E7%9B%AE%E4%BD%BF%E7%94%A8%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%A2%9E%E5%8A%A0%E5%AF%B9%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E7%9A%84%E6%94%AF%E6%8C%81/</url>
      <content type="html"><![CDATA[<p>AndroidInject项目是我写的一个使用注解注入来简化代码的开源项目</p>
<p><a href="https://github.com/wangjiegulu/androidInject" target="_blank" rel="noopener">https://github.com/wangjiegulu/androidInject</a></p>
<p>今天新增功能如下：</p>
<p>1. 增加@AIScreenSize注解，作用于属性，用于注入当前设备的屏幕大小（宽高）<br>2. 增加对网络请求的支持，使用动态代理实现：@AIGet注解，作用于接口方法，表示以GET来请求url；@AIPost注解，作用于接口方法，表示以POST来请求url；@AIParam，用于注入请求参数<br>3. 增加@AINetWorker注解，作用于属性，用于注入网络请求服务<br>4. 增加GET或POST请求时请求参数可使用Params类传入，简化代码</p>
<p>&nbsp;</p>
<p>主要执行代码如下：</p>
<p>用@AINetWorker注解注入NetWorker接口的子类代理（动态代理模式）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #000000;">@AINetWorker<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">private</span> PersonWorker personWorker;</pre><br></div>

<p><span style="line-height: 1.5;">然后启动线程，在线程中调用进行网络请求：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">new</span> Thread(<span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable() {<br></span><span style="color: #008080;">2</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">3</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;">4</span> <span style="color: #008000;">//</span><span style="color: #008000;">        RetMessage&lt;Person&gt; retMsg = personWorker.getPersonsForGet(“a1”, “b1”, “c1”);<br></span><span style="color: #008080;">5</span> <span style="color: #008000;">//</span><span style="color: #008000;">        RetMessage&lt;Person&gt; retMsg = personWorker.getPersonsForGet2(new Params().add(“aa”, “a1”).add(“bb”, “b1”).add(“cc”, “c1”));</span><br><span style="color: #008080;">6</span>         RetMessage&lt;Person&gt; retMsg = personWorker.getPersonsForPost2(<span style="color: #0000ff;">new</span> Params().add(“aa”, “a1”).add(“bb”, “b1”).add(“cc”, “c1”<span style="color: #000000;">));<br></span><span style="color: #008080;">7</span> <span style="color: #000000;">        System.out.println(retMsg.getList().toString());<br></span><span style="color: #008080;">8</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">9</span> }).start();</pre><br></div>

<p>请求的结果封装在RetMessage类中（AndroidInject框架所作的事就是执行Get或者Post请求，获得返回结果，然后json解析后封装在RetMessage中）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.core.net;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.google.gson.Gson;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br><br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  Json响应结果包装类<br> <em> Created with IntelliJ IDEA.
 </em> Author: wangjie  email:tiantian.china.2@gmial.com<br> <em> Date: 14-2-7
 </em> Time: 下午4:25<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> RetMessage&lt;T&gt;<span style="color: #000000;"><br>{<br>    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> resultCode; <span style="color: #008000;">//</span><span style="color: #008000;"> 结果码，必须包含</span><br><br>    <span style="color: #0000ff;">private</span> List&lt;T&gt; list; <span style="color: #008000;">//</span><span style="color: #008000;"> 返回的数据</span><br><br>    <span style="color: #0000ff;">private</span> T obj; <span style="color: #008000;">//</span><span style="color: #008000;"> 返回的数据</span><br><br>    <span style="color: #0000ff;">private</span> Integer size; <span style="color: #008000;">//</span><span style="color: #008000;"> 返回数据长度</span><br><br>    <span style="color: #0000ff;">private</span> String errorMessage; <span style="color: #008000;">//</span><span style="color: #008000;"> 返回错误信息</span><br><br>    <span style="color: #0000ff;">public</span><span style="color: #000000;"> String toJson(){<br>        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Gson().toJson(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br>    }<br>    </span><span style="color: #008000;">//</span><span style="color: #008000;"> getter和setter方法省略…</span><span style="color: #000000;"><br>}</span></pre><br></div>

<p>接下来看下PersonWorker接口中所作的事情：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.androidinject;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.annotations.net.AIGet;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.annotations.net.AIParam;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.annotations.net.AIPost;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.core.net.RetMessage;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.util.Params;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.model.Person;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">11</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;">12</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">13</span> <span style="color: #008000;">  Date: 14-2-7<br></span><span style="color: #008080;">14</span> <span style="color: #008000;"> <em> Time: 下午1:44<br></em></span><span style="color: #008080;">15</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> PersonWorker {<br></span><span style="color: #008080;">17</span>     @AIGet(“<a href="http://192.168.2.198:8080/HelloSpringMVC/person/findPersons?aa=#{a3}&amp;bb=#{b3}&amp;cc=#{c3}" target="_blank" rel="noopener">http://192.168.2.198:8080/HelloSpringMVC/person/findPersons?aa=#{a3}&amp;bb=#{b3}&amp;cc=#{c3}</a>“<span style="color: #000000;">)<br></span><span style="color: #008080;">18</span>     <span style="color: #0000ff;">public</span> RetMessage&lt;Person&gt; getPersonsForGet(@AIParam(“a3”)String a2, @AIParam(“b3”) String b2, @AIParam(“c3”<span style="color: #000000;">) String c2);<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>     @AIPost(“<a href="http://192.168.2.198:8080/HelloSpringMVC/person/findPersons" target="_blank" rel="noopener">http://192.168.2.198:8080/HelloSpringMVC/person/findPersons</a>“<span style="color: #000000;">)<br></span><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span> RetMessage&lt;Person&gt; getPersonsForPost(@AIParam(“aa”)String a2, @AIParam(“bb”) String b2, @AIParam(“cc”<span style="color: #000000;">) String c2);<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span>     @AIGet(“<a href="http://192.168.2.198:8080/HelloSpringMVC/person/findPersons" target="_blank" rel="noopener">http://192.168.2.198:8080/HelloSpringMVC/person/findPersons</a>“<span style="color: #000000;">)<br></span><span style="color: #008080;">24</span>     <span style="color: #0000ff;">public</span> RetMessage&lt;Person&gt;<span style="color: #000000;"> getPersonsForGet2(Params params);<br></span><span style="color: #008080;">25</span><br><span style="color: #008080;">26</span>     @AIPost(“<a href="http://192.168.2.198:8080/HelloSpringMVC/person/findPersons" target="_blank" rel="noopener">http://192.168.2.198:8080/HelloSpringMVC/person/findPersons</a>“<span style="color: #000000;">)<br></span><span style="color: #008080;">27</span>     <span style="color: #0000ff;">public</span> RetMessage&lt;Person&gt;<span style="color: #000000;"> getPersonsForPost2(Params params);<br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span> }</pre><br></div>

<p>PersonWorker是自己写的一个接口（以后需要有新的网络请求，都可以类似编写Worker），声明了执行网络请求的各种方法，这些方法需要加上@AIGet或者@AIPost注解，用于声明请求方式，并在此注解中的value()值设置为所要请求的url（此注解的其他属性后续会陆续扩展）</p>
<p>方法的@AIParam注解是作用与mybatis的@Param注解类似，可以设置请求携带的参数</p>
<p>如果参数比较多，则推荐使用Params来存放参数，以此来简化代码，Params类实质上就是一个HashMap，存放参数的键值对即可。</p>
<p>&nbsp;</p>
<p>接下来分析下框架是怎么实现的，其实上面讲过，主要是用Annotaion和动态代理了</p>
<p>首先看看PersonWorker的注入，在AIActivity（AIActivity，AndroidInject开源项目中的Activity使用注解的话，你写的Activity必须继承AIActivity，另外如果要使用FragmentActivity，则需要继承AISupportFragmentActivity）启动时，首先会去解析添加的注解，这里讨论@AINetWorker注解，内部代码很简单：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">2</span> <span style="color: #008000;">  注入NetWorker<br></span><span style="color: #008080;">3</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> field<br></span><span style="color: #008080;">4</span> <span style="color: #008000;">  </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> Exception<br></span><span style="color: #008080;">5</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;">6</span>  <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> netWorkerBind(Field field) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception{<br></span><span style="color: #008080;">7</span>         field.setAccessible(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">8</span> <span style="color: #000000;">        field.set(present, NetInvoHandler.getWorker(field.getType()));<br></span><span style="color: #008080;">9</span>  }</pre><br></div>

<p>通过代码可知，是使用反射来实现的，主要的代码是这句：</p>
<div class="cnblogs_code"><br><pre>NetInvoHandler.getWorker(field.getType());</pre><br></div>

<p>这句代码的作用是通过Class获得一个PersonWorker实现类的代理对象，这里很明显是使用了动态代理。</p>
<p>所以，最核心的类应该是NetInvoHandler这个类，这个类的代码如下（篇幅问题，所以就折叠了）：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('7d38bbca-82a1-429f-a5c2-68b2ebe85e58')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_7d38bbca-82a1-429f-a5c2-68b2ebe85e58" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.core.net;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.text.TextUtils;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.google.gson.Gson;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.annotations.net.AIGet;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.annotations.net.AIParam;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.annotations.net.AIPost;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.util.Params;<br></span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.util.StringUtil;<br></span><span style="color: #008080;"> 10</span><br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.annotation.Annotation;<br></span><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.InvocationHandler;<br></span><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Method;<br></span><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Proxy;<br></span><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashMap;<br></span><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;<br></span><span style="color: #008080;"> 17</span><br><span style="color: #008080;"> 18</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 19</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;"> 20</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 21</span> <span style="color: #008000;">  Date: 14-2-7<br></span><span style="color: #008080;"> 22</span> <span style="color: #008000;"> <em> Time: 下午1:40<br></em></span><span style="color: #008080;"> 23</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 24</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> NetInvoHandler <span style="color: #0000ff;">implements</span><span style="color: #000000;"> InvocationHandler{<br></span><span style="color: #008080;"> 25</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> HashMap&lt;Class&lt;?&gt;, NetInvoHandler&gt; invoHandlers = <span style="color: #0000ff;">new</span> HashMap&lt;Class&lt;?&gt;, NetInvoHandler&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;"> 26</span><br><span style="color: #008080;"> 27</span>     <span style="color: #0000ff;">private</span> Object proxy; <span style="color: #008000;">//</span><span style="color: #008000;"> 代理对象</span><br><span style="color: #008080;"> 28</span><br><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">synchronized</span>  <span style="color: #0000ff;">static</span>&lt;T&gt; T getWorker(Class&lt;T&gt;<span style="color: #000000;"> clazz){<br></span><span style="color: #008080;"> 30</span>         NetInvoHandler netInvoHandler =<span style="color: #000000;"> invoHandlers.get(clazz);<br></span><span style="color: #008080;"> 31</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> netInvoHandler){<br></span><span style="color: #008080;"> 32</span>             netInvoHandler = <span style="color: #0000ff;">new</span><span style="color: #000000;"> NetInvoHandler();<br></span><span style="color: #008080;"> 33</span>             netInvoHandler.setProxy(Proxy.newProxyInstance(clazz.getClassLoader(), <span style="color: #0000ff;">new</span><span style="color: #000000;"> Class[]{clazz}, netInvoHandler));<br></span><span style="color: #008080;"> 34</span> <span style="color: #000000;">            invoHandlers.put(clazz, netInvoHandler);<br></span><span style="color: #008080;"> 35</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 36</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> (T)netInvoHandler.getProxy();<br></span><span style="color: #008080;"> 37</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 38</span><br><span style="color: #008080;"> 39</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 40</span>     <span style="color: #0000ff;">public</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Throwable {<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> get请求</span><br><span style="color: #008080;"> 43</span>         <span style="color: #0000ff;">if</span>(method.isAnnotationPresent(AIGet.<span style="color: #0000ff;">class</span><span style="color: #000000;">)){<br></span><span style="color: #008080;"> 44</span>             AIGet aiGet = method.getAnnotation(AIGet.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 45</span>             String url =<span style="color: #000000;"> aiGet.value();<br></span><span style="color: #008080;"> 46</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(url)){<br></span><span style="color: #008080;"> 47</span>                 <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(“net work [“ + method.getName() + “]@AIGet value()[url] is empty!!”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 48</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 49</span>             Annotation[][] annotaions =<span style="color: #000000;"> method.getParameterAnnotations();<br></span><span style="color: #008080;"> 50</span>             <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; args.length; i++<span style="color: #000000;">){<br></span><span style="color: #008080;"> 51</span>                 <span style="color: #0000ff;">if</span>(Params.<span style="color: #0000ff;">class</span>.isAssignableFrom(args[i].getClass())){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果属性为Params，则追加在后面</span><br><span style="color: #008080;"> 52</span>                     url =<span style="color: #000000;"> StringUtil.appendParamsAfterUrl(url, (Params)args[i]);<br></span><span style="color: #008080;"> 53</span>                 }<span style="color: #0000ff;">else</span>{ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果属性添加了@AIParam注解，则替换链接中#{xxx}</span><br><span style="color: #008080;"> 54</span>                     String repName = ((AIParam)annotaions[i][0<span style="color: #000000;">]).value();<br></span><span style="color: #008080;"> 55</span>                     url = url.replace(“#{“ + repName + “}”, args[i] + “”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 57</span><br><span style="color: #008080;"> 58</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 59</span>             StringBuilder sb =<span style="color: #000000;"> NetWork.getStringFromUrl(url);<br></span><span style="color: #008080;"> 60</span>             <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> sb){<br></span><span style="color: #008080;"> 61</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 62</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 63</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Gson().fromJson(sb.toString(), method.getReturnType());<br></span><span style="color: #008080;"> 64</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 65</span><br><span style="color: #008080;"> 66</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> post请求</span><br><span style="color: #008080;"> 67</span>         <span style="color: #0000ff;">if</span>(method.isAnnotationPresent(AIPost.<span style="color: #0000ff;">class</span><span style="color: #000000;">)){<br></span><span style="color: #008080;"> 68</span>             AIPost aiPost = method.getAnnotation(AIPost.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 69</span>             String url =<span style="color: #000000;"> aiPost.value();<br></span><span style="color: #008080;"> 70</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(url)){<br></span><span style="color: #008080;"> 71</span>                 <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(“net work [“ + method.getName() + “]@AIPost value()[url] is empty!!”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 72</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 73</span>             Annotation[][] annotaions =<span style="color: #000000;"> method.getParameterAnnotations();<br></span><span style="color: #008080;"> 74</span>             Map&lt;String, String&gt; map = <span style="color: #0000ff;">new</span> HashMap&lt;String, String&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;"> 75</span>             <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; args.length; i++<span style="color: #000000;">){<br></span><span style="color: #008080;"> 76</span>                 <span style="color: #0000ff;">if</span>(Params.<span style="color: #0000ff;">class</span>.isAssignableFrom(args[i].getClass())){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果属性为Params，则追加在后面</span><br><span style="color: #008080;"> 77</span> <span style="color: #000000;">                    map.putAll((Params)args[i]);<br></span><span style="color: #008080;"> 78</span>                 }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 79</span>                     String repName = ((AIParam)annotaions[i][0<span style="color: #000000;">]).value();<br></span><span style="color: #008080;"> 80</span>                     map.put(repName, args[i] + “”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 81</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 82</span><br><span style="color: #008080;"> 83</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 84</span>             StringBuilder sb =<span style="color: #000000;"> NetWork.postStringFromUrl(url, map);<br></span><span style="color: #008080;"> 85</span>             <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> sb){<br></span><span style="color: #008080;"> 86</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 87</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 88</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Gson().fromJson(sb.toString(), method.getReturnType());<br></span><span style="color: #008080;"> 89</span><br><span style="color: #008080;"> 90</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 91</span><br><span style="color: #008080;"> 92</span><br><span style="color: #008080;"> 93</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 95</span><br><span style="color: #008080;"> 96</span><br><span style="color: #008080;"> 97</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Object getProxy() {<br></span><span style="color: #008080;"> 98</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> proxy;<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">100</span><br><span style="color: #008080;">101</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setProxy(Object proxy) {<br></span><span style="color: #008080;">102</span>         <span style="color: #0000ff;">this</span>.proxy =<span style="color: #000000;"> proxy;<br></span><span style="color: #008080;">103</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">104</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>里面的代码还没有好好的重构，所以，看起来会更直白，该类实现了InvocationHandler，很明显的动态代理。</p>
<p>我们通过NetInvoHandler的getWorker静态方法，来获取一个指定Class的Worker实现类的代理对象，由于实际应用时，Worker接口应该会很多，为了不重复生成相同Worker实现类的代理对象，所以这里在生成一个后，保存起来，确保一个Worker只生成一个代理对象，一个NetInvoHandler。</p>
<p>这里有个地方需要注意一下，以前使用的动态代理，需要一个RealSubject，也就是真实对象，是Worker的实现类。这样，在invoke方法中就可以调用真实对象的对应方法了，但是现在，进行网络请求，我们没有去写一个类然后实现PersonWorker接口，因为没有必要，我们完全可以在invoke方法中去执行相同的网络请求。</p>
<p>请想下，之所以需要框架的存在 不就是为了把一些模板的东西给简化掉么？现在的网络请求这些步骤就是一些模板话的东西，我们需要的就是调用方法，自动进行网络请求（框架做的事），然后返回给我结果。所以网络请求这一步，写在invoke方法中即可。</p>
<p>而不是所谓的编写一个类，实现PersonWorker接口，在这个实现类中进行网络请求，然后在invoke方法中调用真实对象的对应该方法。</p>
<p>因此，在Proxy.newProxyInstance的interfaces中填写需要实现的接口，也就是现在的PersonWorker。</p>
<p>&nbsp;</p>
<p>接下来看下invoke中做的事情，首先根据方法增加的注解来识别是GET请求还是POST请求。然后各自执行请求（因为我请求的执行，写在NetWork中了，这里直接返回了请求结果字符串StringBuilder sb）。</p>
<p>接下来，使用Gson这个霸气的工具，一键从json解析封装成RetMessage对象。（所以，这里是需要Gson库的支持，大家网上下载gson.jar，或者使用maven）</p>
<p>当然，要使用Gson一键解析封装的前提是服务器端的编写需要保存一致性，下面是我服务器端测试的代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> @RequestMapping(“/findPersons”<span style="color: #000000;">)<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> findPersons(HttpServletRequest request, HttpServletResponse response,<br></span><span style="color: #008080;"> 3</span>                                 @RequestParam(“aa”<span style="color: #000000;">) String aa,<br></span><span style="color: #008080;"> 4</span>                                 @RequestParam(“bb”<span style="color: #000000;">) String bb,<br></span><span style="color: #008080;"> 5</span>                                 @RequestParam(“cc”) String cc) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException{<br></span><span style="color: #008080;"> 6</span>         System.out.println(“aa: “ + aa + “, bb: “ + bb + “, cc: “ +<span style="color: #000000;"> cc);<br></span><span style="color: #008080;"> 7</span>         RetMessage&lt;Person&gt; rm = <span style="color: #0000ff;">new</span> RetMessage&lt;Person&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>         rm.setResultCode(0<span style="color: #000000;">);<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span>         List&lt;Person&gt; persons = <span style="color: #0000ff;">new</span> ArrayList&lt;Person&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; 5; i++<span style="color: #000000;">){<br></span><span style="color: #008080;">13</span>             Person p = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Person();<br></span><span style="color: #008080;">14</span>             p.setName(“wangjie_” +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">15</span>             p.setAge(20 +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">            persons.add(p);<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> <span style="color: #000000;">        rm.setList(persons);<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> <span style="color: #000000;">        ServletUtil.obtinUTF8JsonWriter(response).write(rm.toJson());<br></span><span style="color: #008080;">22</span>     }</pre><br></div>

<p>服务器端返回结果时，也是封装在RetMessage类中，这个类服务器端和客户端是保持一致的，所以可以一键转换。</p>
<p>如果你在开发的过程中，RetMessage类中封装的东西不能满足你的需求，可以自己编写结果类，当然在Worker中声明方法中返回值就应该是你写的结果类了。</p>
<p>&nbsp;</p>
<p>到此为止，讲解完毕</p>
<p>另：如果，你需要写一个查询User信息的网络请求，应该怎么写？</p>
<p>只需编写UserWorker接口，然后声明方法findUsers()，写上@AIGet或者@AIPost注解，写明url和请求参数。然后通过@AINetWorker注解注入userWorker，然后开启线程，调用userWorker的findUsers()方法即可。</p>
<p>当然UserWorker也可以不使用注解获得，而是调用&ldquo;NetInvoHandler.getWorker(UserWorker.class)&rdquo;获得！</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> annotations </tag>
            
            <tag> library </tag>
            
            <tag> proxy </tag>
            
            <tag> dynamic proxy </tag>
            
            <tag> http </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[android]AndroidInject框架——我的第一个android小型框架]]></title>
      <url>/2013/12/05/android-AndroidInject%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AAandroid%E5%B0%8F%E5%9E%8B%E6%A1%86%E6%9E%B6/</url>
      <content type="html"><![CDATA[<p>作为一个移动应用开发者，随着需求的日益增多，Android项目的越来越臃肿，代码量越来越大，</p>
<p>现在冷静下来回头看看我们的代码，有多少代码跟业务逻辑没什么关系的</p>
<p>&nbsp;</p>
<p>所以，本人自不量力，在github上建了个开源项目，希望能一定程度地简化我的代码-。-</p>
<p>现在第一个版本完成，希望有兴趣的朋友能加入一起完善。</p>
<p>本人才疏学浅，代码中有写得不妥的地方希望大家不吝赐教哈！</p>
<p><strong>github地址：</strong></p>
<p><a href="https://github.com/wangjiegulu/androidInject" target="_blank" rel="noopener">https://github.com/wangjiegulu/androidInject</a></p>
<p><strong>androidInject_1.0.jar：</strong></p>
<p><a href="http://pan.baidu.com/s/1rcSiy" target="_blank" rel="noopener">http://pan.baidu.com/s/1rcSiy</a></p>
<p>&nbsp;</p>
<p>主要的思想就是通过注解的方式，把我们要做的事情直接注入进来给我们，&ldquo;不是我去调用对象，而是对象自己来找我&rdquo;</p>
<p>现在刚写完了10个注解：</p>
<p>@AINoTitle， @AIFullScreen， @AILayout， @AIView， @AIBean， @AISystemService， @AIClick， @AIItemClick， @AILongClick， @AIItemLongClick</p>
<p>使用方法如下：</p>
<p>Activity中使用：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('519219a9-a150-4491-a51e-2962ccedc68e')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_519219a9-a150-4491-a51e-2962ccedc68e" class="cnblogs_code_hide"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.androidinject;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.app.AlarmManager;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Intent;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.location.LocationManager;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.LayoutInflater;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #0000ff;">import</span> android.widget.<em><span style="color: #000000;">;<br></span><span style="color: #0000ff;">import</span> com.wangjie.androidinject.annotation.annotations.</em><span style="color: #000000;">;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.present.AIActivity;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.model.Person;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashMap;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;<br><br>@AIFullScreen<br>@AINoTitle<br>@AILayout(R.layout.main)<br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> AIActivity{<br><br>    @AIView(id </span>= R.id.btn1, clickMethod = “onClickCallback”, longClickMethod = “onLongClickCallback”<span style="color: #000000;">)<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Button btn1;<br><br>    @AIView(clickMethod </span>= “onClickCallback”, longClickMethod = “onLongClickCallback”<span style="color: #000000;">)<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Button btn2;<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;">    @AIView(id = R.id.btn3)<br></span><span style="color: #008000;">//</span><span style="color: #008000;">    private Button btn3;<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;">    @AIView(id = R.id.listView, itemClickMethod = “onItemClickCallback”, itemLongClickMethod = “onItemLongClickCallbackForListView”)</span><br>    @AIView(id =<span style="color: #000000;"> R.id.listView)<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> ListView listView;<br><br>    @AIBean<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Person person;<br><br>    @AISystemService<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> AlarmManager alarmManager;<br>    @AISystemService<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> LocationManager locationManager;<br>    @AISystemService<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> LayoutInflater inflater;<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br>        </span><span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br><br>        List</span>&lt;Map&lt;String, String&gt;&gt; list = <span style="color: #0000ff;">new</span> ArrayList&lt;Map&lt;String, String&gt;&gt;<span style="color: #000000;">();<br>        Map</span>&lt;String, String&gt;<span style="color: #000000;"> map;<br>        </span><span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; 10; i++<span style="color: #000000;">){<br>            map </span>= <span style="color: #0000ff;">new</span> HashMap&lt;String, String&gt;<span style="color: #000000;">();<br>            map.put(</span>“title”, “item_” +<span style="color: #000000;"> i);<br>            list.add(map);<br>        }<br><br>        SimpleAdapter adapter </span>= <span style="color: #0000ff;">new</span> SimpleAdapter(context, list, R.layout.list_item, <span style="color: #0000ff;">new</span> String[]{“title”}, <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">int</span><span style="color: #000000;">[]{R.id.list_item_title_tv});<br>        listView.setAdapter(adapter);<br><br>        person.setName(</span>“wangjie”<span style="color: #000000;">);<br>        person.setAge(</span>23<span style="color: #000000;">);<br>        System.out.println(person.toString());<br><br>        System.out.println(</span>“alarmManager: “ + alarmManager + “, locationManager: “ + locationManager + “, inflater: “ +<span style="color: #000000;"> inflater);<br><br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClickCallback(View view){<br>        </span><span style="color: #0000ff;">if</span>(view <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> Button){<br>            Toast.makeText(context, </span>“onClickCallback: “ +<span style="color: #000000;"> ((Button)view).getText(), Toast.LENGTH_SHORT).show();<br>        }<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onLongClickCallback(View view){<br>        </span><span style="color: #0000ff;">if</span>(view <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> Button){<br>            Toast.makeText(context, </span>“onLongClickCallback: “ +<span style="color: #000000;"> ((Button)view).getText(), Toast.LENGTH_SHORT).show();<br>        }<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onItemClickCallback(AdapterView&lt;?&gt; adapterView, View view, <span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">long</span><span style="color: #000000;"> l) {<br>        Toast.makeText(context, </span>“onItemClickCallback: “ + ((Map&lt;String, String&gt;)adapterView.getAdapter().getItem(i)).get(“title”<span style="color: #000000;">), Toast.LENGTH_SHORT).show();<br>    }<br><br>    @AIClick({R.id.btn3, R.id.toFragmentBtn})<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClickCallbackForBtn3(View view){<br>        </span><span style="color: #0000ff;">if</span>(view <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> Button){<br>            Toast.makeText(context, </span>“onClickForBtn3: “ +<span style="color: #000000;"> ((Button)view).getText(), Toast.LENGTH_SHORT).show();<br>        }<br><br>        </span><span style="color: #0000ff;">if</span>(view.getId() ==<span style="color: #000000;"> R.id.toFragmentBtn){<br>            startActivity(</span><span style="color: #0000ff;">new</span> Intent(context, SecendActivity.<span style="color: #0000ff;">class</span><span style="color: #000000;">));<br>        }<br><br>    }<br><br>    @AILongClick({R.id.btn3})<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onLongClickCallbackForBtn3(View view){<br>        </span><span style="color: #0000ff;">if</span>(view <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> Button){<br>            Toast.makeText(context, </span>“onLongClickCallbackForBtn3: “ +<span style="color: #000000;"> ((Button)view).getText(), Toast.LENGTH_SHORT).show();<br>        }<br>    }<br><br>    @AIItemClick({R.id.listView})<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onItemClickCallbackForListView(AdapterView&lt;?&gt; adapterView, View view, <span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">long</span><span style="color: #000000;"> l){<br>        Toast.makeText(context, </span>“onItemClickCallbackForListView: “ + ((Map&lt;String, String&gt;)adapterView.getAdapter().getItem(i)).get(“title”<span style="color: #000000;">), Toast.LENGTH_SHORT).show();<br>    }<br><br>    @AIItemLongClick(R.id.listView)<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span> onItemLongClickCallbackForListView(AdapterView&lt;?&gt; adapterView, View view, <span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">long</span><span style="color: #000000;"> l) {<br>        Toast.makeText(context, </span>“onItemLongClickCallbackForListView: “ + ((Map&lt;String, String&gt;)adapterView.getAdapter().getItem(i)).get(“title”<span style="color: #000000;">), Toast.LENGTH_SHORT).show();<br>        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>    }<br><br>}</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>Fragment中使用：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('456512ad-1927-42c5-b337-ab7c6067fadc')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_456512ad-1927-42c5-b337-ab7c6067fadc" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.androidinject;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.app.AlarmManager;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span> android.widget.<em><span style="color: #000000;">;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span> com.wangjie.androidinject.annotation.annotations.</em><span style="color: #000000;">;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.present.AISupportFragment;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.model.Person;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;">12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashMap;<br></span><span style="color: #008080;">13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;">14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">17</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;">18</span> <span style="color: #008000;"> <em> Author: wangjie  email:wangjie@cyyun.com<br></em></span><span style="color: #008080;">19</span> <span style="color: #008000;">  Date: 13-12-4<br></span><span style="color: #008080;">20</span> <span style="color: #008000;"> <em> Time: 下午4:37<br></em></span><span style="color: #008080;">21</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">22</span> <span style="color: #000000;">@AILayout(R.layout.fragment_a)<br></span><span style="color: #008080;">23</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> FragmentA <span style="color: #0000ff;">extends</span><span style="color: #000000;"> AISupportFragment{<br></span><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span> <span style="color: #000000;">    @AIView<br></span><span style="color: #008080;">26</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Button fragmentABtn1;<br></span><span style="color: #008080;">27</span><br><span style="color: #008080;">28</span> <span style="color: #000000;">    @AIView<br></span><span style="color: #008080;">29</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> GridView fragmentGv;<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span> <span style="color: #000000;">    @AIBean<br></span><span style="color: #008080;">32</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Person person;<br></span><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span> <span style="color: #000000;">    @AISystemService<br></span><span style="color: #008080;">35</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> AlarmManager alarmManager;<br></span><span style="color: #008080;">36</span><br><span style="color: #008080;">37</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">38</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onActivityCreated(Bundle savedInstanceState) {<br></span><span style="color: #008080;">39</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onActivityCreated(savedInstanceState);<br></span><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span>         List&lt;Map&lt;String, String&gt;&gt; list = <span style="color: #0000ff;">new</span> ArrayList&lt;Map&lt;String, String&gt;&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">42</span>         Map&lt;String, String&gt;<span style="color: #000000;"> map;<br></span><span style="color: #008080;">43</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; 10; i++<span style="color: #000000;">){<br></span><span style="color: #008080;">44</span>             map = <span style="color: #0000ff;">new</span> HashMap&lt;String, String&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">45</span>             map.put(“title”, “fragment<em>item</em>“ +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">46</span> <span style="color: #000000;">            list.add(map);<br></span><span style="color: #008080;">47</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">48</span><br><span style="color: #008080;">49</span>         SimpleAdapter adapter = <span style="color: #0000ff;">new</span> SimpleAdapter(context, list, R.layout.list_item, <span style="color: #0000ff;">new</span> String[]{“title”}, <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">int</span><span style="color: #000000;">[]{R.id.list_item_title_tv});<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">        fragmentGv.setAdapter(adapter);<br></span><span style="color: #008080;">51</span><br><span style="color: #008080;">52</span>         person.setName(“androidInject”<span style="color: #000000;">);<br></span><span style="color: #008080;">53</span>         person.setAge(1<span style="color: #000000;">);<br></span><span style="color: #008080;">54</span> <span style="color: #000000;">        System.out.println(person.toString());<br></span><span style="color: #008080;">55</span><br><span style="color: #008080;">56</span>         System.out.println(“alarmManager: “ +<span style="color: #000000;"> alarmManager);<br></span><span style="color: #008080;">57</span><br><span style="color: #008080;">58</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">59</span><br><span style="color: #008080;">60</span> <span style="color: #000000;">    @AIClick(R.id.fragmentABtn1)<br></span><span style="color: #008080;">61</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> btnOnclick(View view){<br></span><span style="color: #008080;">62</span>         <span style="color: #0000ff;">if</span>(view <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> Button){<br></span><span style="color: #008080;">63</span>             Toast.makeText(context, “btnOnclick: “ +<span style="color: #000000;"> ((Button)view).getText(), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">64</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">65</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">66</span><br><span style="color: #008080;">67</span> <span style="color: #000000;">    @AILongClick(R.id.fragmentABtn1)<br></span><span style="color: #008080;">68</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> btnOnLongClick(View view){<br></span><span style="color: #008080;">69</span>         <span style="color: #0000ff;">if</span>(view <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> Button){<br></span><span style="color: #008080;">70</span>             Toast.makeText(context, “btnOnLongClick: “ +<span style="color: #000000;"> ((Button)view).getText(), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">71</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">72</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">73</span><br><span style="color: #008080;">74</span> <span style="color: #000000;">    @AIItemClick(R.id.fragmentGv)<br></span><span style="color: #008080;">75</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> gvOnItemClick(AdapterView&lt;?&gt; adapterView, View view, <span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">long</span><span style="color: #000000;"> l){<br></span><span style="color: #008080;">76</span>         Toast.makeText(context, “gvOnItemClick: “ + ((Map&lt;String, String&gt;)adapterView.getAdapter().getItem(i)).get(“title”<span style="color: #000000;">), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">77</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">78</span><br><span style="color: #008080;">79</span> <span style="color: #000000;">    @AIItemLongClick(R.id.fragmentGv)<br></span><span style="color: #008080;">80</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> gvOnItemLongClick(AdapterView&lt;?&gt; adapterView, View view, <span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">long</span><span style="color: #000000;"> l){<br></span><span style="color: #008080;">81</span>         Toast.makeText(context, “gvOnItemLongClick: “ + ((Map&lt;String, String&gt;)adapterView.getAdapter().getItem(i)).get(“title”<span style="color: #000000;">), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">82</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">83</span><br><span style="color: #008080;">84</span><br><span style="color: #008080;">85</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>&nbsp;</p>
<p>具体注解如下：</p>
<p>@AINoTitle: 类注解, 只适用于Activity(需继承于AIActivity), 设置Activity不显示Title</p>
<p>@AIFullScreen: 类注解, 只适用于Activity(需继承于AIActivity), 设置Activity全屏</p>
<p> @AILayout: 类注解<br>            value[int]: 用于设置该Activity的布局 —- setContentView(resId);</p>
<pre><code>@AIView: 属性注解
    id[int]: 用于绑定控件 ---- findViewById(resId);(default identifier[R.id.{field name}] if did not set id)
    clickMethod[String]: 用于设置控件点击事件的回调方法, 可选, 方法名称任意, 参数必须为(View view)
    longClickMethod[String]: 用于设置控件长按的回调方法, 可选, 方法名任意, 参数必须为(View view)
    itemClickMethod[String]: 用于设置控件item点击的回调方法, 可选, 方法名任意, 参数必须为(AdapterView, View, int, long)
    itemLongClickMethod[String]: 用于设置控件item长按的回调方法, 可选, 方法名任意, 参数必须为(AdapterView, View, int, long)

@AIBean: 属性注解, 为该属性生成一个对象并注入, 该对象必须有个默认的不带参数的构造方法

@AISystemService: 属性注解，为该属性注入系统服务对象

@AIClick: 方法注解
    value[int[], 所要绑定控件的id]: 用于绑定控件点击事件的回调方法, 方法名称任意, 参数必须为(View view)

@AIItemClick: 方法注解
    value[int[], 所要绑定控件的id]: 用于绑定控件item点击事件的回调方法, 方法名称任意, 参数必须为(AdapterView, View, int, long)

@AILongClick: 方法注解
    value[int[], 所要绑定控件的id]: 用于绑定控件长按事件的回调方法, 方法名称任意, 参数必须为(View view)

@AIItemLongClick: 方法注解
    value[int[], 所要绑定控件的id]: 用于绑定控件item长按事件的回调方法, 方法名称任意, 参数必须为(AdapterView, View, int, long)
</code></pre><p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> library </tag>
            
            <tag> inject </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ios7 tableview被navigationbar挡住]]></title>
      <url>/2013/11/08/ios7-tableview%E8%A2%ABnavigationbar%E6%8C%A1%E4%BD%8F/</url>
      <content type="html"><![CDATA[<p><pre class="lang-c prettyprint prettyprinted"><span>用ego下拉刷新的时候，每次在ios7时，tableview都会上移。。。导致被navagationbar挡住。<br>ios6是正常的，于是在init的时候添加如下代码。。。</span></pre></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> NSComparisonResult order = [[UIDevice currentDevice].systemVersion compare: <span style="color: #800000;">@”</span><span style="color: #800000;">7.0</span><span style="color: #800000;">“</span><span style="color: #000000;"> options: NSNumericSearch];<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">if</span> (order == NSOrderedSame || order ==<span style="color: #000000;"> NSOrderedDescending)<br></span><span style="color: #008080;">3</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">4</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> OS version &gt;= 7.0</span><br><span style="color: #008080;">5</span>     self.edgesForExtendedLayout =<span style="color: #000000;"> UIRectEdgeNone;<br></span><span style="color: #008080;">6</span> }</pre><br></div>

<p>&nbsp;</p>
<p>转自：<a href="http://www.cnblogs.com/x1957/archive/2013/09/29/3345264.html" target="_blank" rel="noopener">http://www.cnblogs.com/x1957/archive/2013/09/29/3345264.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> iOS </tag>
            
            <tag> TableView </tag>
            
            <tag> NavigationBar </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【ios】使用Block对POST异步操作的简单封装]]></title>
      <url>/2013/11/06/%E3%80%90ios%E3%80%91%E4%BD%BF%E7%94%A8Block%E5%AF%B9POST%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C%E7%9A%84%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85/</url>
      <content type="html"><![CDATA[<p>一般情况下的POST异步操作需要实现以下几步：</p>
<p>1. 在controller.h上实现&lt;NSURLConnectionDataDelegate&gt;协议</p>
<p>2. 实现协议的几个方法，</p>
<ul>
<li><p>(<span class="s1">void</span>)connection:(<span class="s2">NSURLConnection</span> <em>)connection didReceiveResponse:(<span class="s2">NSURLResponse</span> </em>)response</p>
</li>
<li><p>(<span class="s1">void</span>)connection:(<span class="s2">NSURLConnection</span> <em>)connection didReceiveData:(<span class="s2">NSData</span> </em>)data</p>
</li>
<li><p>(<span class="s1">void</span>)connectionDidFinishLoading:(<span class="s2">NSURLConnection</span> *)connection</p>
</li>
</ul>
<p>3. 编写执行post请求的代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> NSURL <em>url = [NSURL URLWithString:urlStr]; <span style="color: #008000;">//</span><span style="color: #008000;"> 生成NSURL对象<br></span><span style="color: #008080;">2</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 生成Request请求对象（并设置它的缓存协议、网络请求超时配置）</span><br><span style="color: #008080;">3</span>     NSMutableURLRequest </em>request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:<span style="color: #800080;">30</span><span style="color: #000000;">];<br></span><span style="color: #008080;">4</span><br><span style="color: #008080;">5</span>     [request setHTTPBody:[<span style="color: #0000ff;">params</span> dataUsingEncoding:NSUTF8StringEncoding]]; <span style="color: #008000;">//</span><span style="color: #008000;"> 设置请求参数<br></span><span style="color: #008080;">6</span><br><span style="color: #008080;">7</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 执行请求连接</span><br><span style="color: #008080;">8</span>     NSURLConnection *conn = [[NSURLConnection alloc] initWithRequest:request <span style="color: #0000ff;">delegate</span>:executorDelegate];</pre><br></div>

<p>&nbsp;</p>
<p>如果controller有很多异步操作，处理就会很麻烦，而且，很多时候我们只需要处理完成和异常（比如超时）的时候的反馈即可</p>
<p>所以，我需要编写一个post请求的封装类，只要传入请求的url、请求参数（字符串形式）、完成时的回调block</p>
<p>首先，新建类：HttpPostExecutor，.h如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">//</span><span style="color: #008000;">  HttpPostExecutor.h<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">//</span><span style="color: #008000;">  HttpTest<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 5</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Created by WANGJIE on 13-11-6.<br></span><span style="color: #008080;"> 6</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Copyright (c) 2013年 WANGJIE. All rights reserved.<br></span><span style="color: #008080;"> 7</span> <span style="color: #008000;">//<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">#import</span> &lt;Foundation/Foundation.h&gt;<br><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">@interface</span> HttpPostExecutor : NSObject&lt;NSURLConnectionDataDelegate&gt;<br><span style="color: #008080;">12</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">13</span>     NSMutableData <em>resultData; <span style="color: #008000;">//</span><span style="color: #008000;"> 存放请求结果</span><br><span style="color: #008080;">14</span>     <span style="color: #0000ff;">void</span> (^finishCallbackBlock)(NSString </em>); <span style="color: #008000;">//</span><span style="color: #008000;"> 执行完成后回调的block</span><br><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">17</span> @property NSMutableData <em><span style="color: #000000;">resultData;<br></span><span style="color: #008080;">18</span> @property(strong) <span style="color: #0000ff;">void</span> (^finishCallbackBlock)(NSString </em><span style="color: #000000;">);<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span> + (<span style="color: #0000ff;">void</span>)postExecuteWithUrlStr:(NSString <em>)urlStr Paramters:(NSString </em>)<span style="color: #0000ff;">params</span> FinishCallbackBlock:(<span style="color: #0000ff;">void</span> (^)(NSString *<span style="color: #000000;">))block;<br></span><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span> <span style="color: #0000ff;">@end</span></pre><br></div>

<p>&nbsp;</p>
<p>实现了&lt;NSURLConnectionDataDelegate&gt;协议，因为它要接收post请求的几个回调。</p>
<p>有一个NSMutableData对象，这个对象用于储存请求的结果。</p>
<p>一个finishCallbackBlock的block，这个block用于执行完成后的回调，这个block传入的参数就是返回的结果（这个结果已转成utf-8编码的字符串形式），我们可以在这个block中去处理请求完成后的逻辑</p>
<p>还有一个类方法，这个类方法暴露给外面，让外面进行调用</p>
<p>&nbsp;</p>
<p>接下来，我们看下实现的方法.m文件：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('5746940f-c0f2-458d-b9ae-6f828341562c')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_5746940f-c0f2-458d-b9ae-6f828341562c" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">//</span><br><span style="color: #008080;">  2</span> <span style="color: #008000;">//</span><span style="color: #008000;">  POST异步请求的封装<br></span><span style="color: #008080;">  3</span> <span style="color: #008000;">//</span><span style="color: #008000;">  使用方法，只需传入url，参数组成的字符串，执行完成后的回调block<br></span><span style="color: #008080;">  4</span> <span style="color: #008000;">//</span><span style="color: #008000;">  如下：<br></span><span style="color: #008080;">  5</span> <span style="color: #008000;">//</span><span style="color: #008000;">  [HttpPostExecutor postExecuteWithUrlStr:@”</span><span style="color: #008000; text-decoration: underline;"><a href="http://www.baidu.com" target="_blank" rel="noopener">http://www.baidu.com</a></span><span style="color: #008000;">“<br></span><span style="color: #008080;">  6</span> <span style="color: #008000;">//</span><span style="color: #008000;">                              Paramters:@””<br></span><span style="color: #008080;">  7</span> <span style="color: #008000;">//</span><span style="color: #008000;">                    FinishCallbackBlock:^(NSString <em>result){  </em></span><span style="color: #008000;">//</span><span style="color: #008000;"> 设置执行完成的回调block<br></span><span style="color: #008080;">  8</span> <span style="color: #008000;">//</span><span style="color: #008000;">                        NSLog(@”finish callback block, result: %@”, result);<br></span><span style="color: #008080;">  9</span> <span style="color: #008000;">//</span><span style="color: #008000;">                    }];<br></span><span style="color: #008080;"> 10</span> <span style="color: #008000;">//</span><span style="color: #008000;">  post提交的参数，格式如下：<br></span><span style="color: #008080;"> 11</span> <span style="color: #008000;">//</span><span style="color: #008000;">  参数1名字=参数1数据&amp;参数2名字＝参数2数据&amp;参数3名字＝参数3数据&amp;…<br></span><span style="color: #008080;"> 12</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 13</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 14</span> <span style="color: #008000;">//</span><span style="color: #008000;">  HttpPostExecutor.m<br></span><span style="color: #008080;"> 15</span> <span style="color: #008000;">//</span><span style="color: #008000;">  HttpTest<br></span><span style="color: #008080;"> 16</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 17</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Created by WANGJIE on 13-11-6.<br></span><span style="color: #008080;"> 18</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Copyright (c) 2013年 WANGJIE. All rights reserved.<br></span><span style="color: #008080;"> 19</span> <span style="color: #008000;">//<br></span><span style="color: #008080;"> 20</span><br><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">HttpPostExecutor.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 22</span><br><span style="color: #008080;"> 23</span> <span style="color: #0000ff;">@implementation</span><span style="color: #000000;"> HttpPostExecutor<br></span><span style="color: #008080;"> 24</span> <span style="color: #0000ff;">@synthesize</span><span style="color: #000000;"> resultData, finishCallbackBlock;<br></span><span style="color: #008080;"> 25</span><br><span style="color: #008080;"> 26</span> <span style="color: #008000;">/</span><span style="color: #008000;"><em><br></em></span><span style="color: #008080;"> 27</span> <span style="color: #008000;">  执行POST请求<br></span><span style="color: #008080;"> 28</span>  <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 29</span> + (<span style="color: #0000ff;">void</span>)postExecuteWithUrlStr:(NSString )urlStr Paramters:(NSString <em>)<span style="color: #0000ff;">params</span> FinishCallbackBlock:(<span style="color: #0000ff;">void</span> (^)(NSString </em><span style="color: #000000;">))block<br></span><span style="color: #008080;"> 30</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 31</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 生成一个post请求回调委托对象（实现了&lt;NSURLConnectionDataDelegate&gt;协议）</span><br><span style="color: #008080;"> 32</span>     HttpPostExecutor <em>executorDelegate =<span style="color: #000000;"> [[HttpPostExecutor alloc] init];<br></span><span style="color: #008080;"> 33</span>     executorDelegate.finishCallbackBlock = block; <span style="color: #008000;">//</span><span style="color: #008000;"> 绑定执行完成时的block</span><br><span style="color: #008080;"> 34</span><br><span style="color: #008080;"> 35</span><br><span style="color: #008080;"> 36</span>     NSURL </em>url = [NSURL URLWithString:urlStr]; <span style="color: #008000;">//</span><span style="color: #008000;"> 生成NSURL对象<br></span><span style="color: #008080;"> 37</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 生成Request请求对象（并设置它的缓存协议、网络请求超时配置）</span><br><span style="color: #008080;"> 38</span>     NSMutableURLRequest <em>request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:<span style="color: #800080;">30</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 39</span><br><span style="color: #008080;"> 40</span>     [request setHTTPBody:[<span style="color: #0000ff;">params</span> dataUsingEncoding:NSUTF8StringEncoding]]; <span style="color: #008000;">//</span><span style="color: #008000;"> 设置请求参数<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 执行请求连接</span><br><span style="color: #008080;"> 43</span>     NSURLConnection </em>conn = [[NSURLConnection alloc] initWithRequest:request <span style="color: #0000ff;">delegate</span><span style="color: #000000;">:executorDelegate];<br></span><span style="color: #008080;"> 44</span><br><span style="color: #008080;"> 45</span>     NSLog(conn ? <span style="color: #800000;">@”</span><span style="color: #800000;">连接创建成功</span><span style="color: #800000;">“</span> : <span style="color: #800000;">@”</span><span style="color: #800000;">连接创建失败</span><span style="color: #800000;">“</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 46</span><br><span style="color: #008080;"> 47</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span><br><span style="color: #008080;"> 50</span> <span style="color: #008000;">/<em></em></span><span style="color: #008000;"><br></span><span style="color: #008080;"> 51</span> <span style="color: #008000;"> <em> 接收到服务器回应的时回调<br></em></span><span style="color: #008080;"> 52</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 53</span> - (<span style="color: #0000ff;">void</span>)connection:(NSURLConnection <em>)connection didReceiveResponse:(NSURLResponse </em><span style="color: #000000;">)response<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 55</span>     NSHTTPURLResponse <em>resp = (NSHTTPURLResponse </em><span style="color: #000000;">)response;<br></span><span style="color: #008080;"> 56</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 初始化NSMutableData对象（用于保存执行结果）</span><br><span style="color: #008080;"> 57</span>     <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">resultData){<br></span><span style="color: #008080;"> 58</span>         resultData =<span style="color: #000000;"> [[NSMutableData alloc] init];<br></span><span style="color: #008080;"> 59</span>     }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 60</span>         [resultData setLength:<span style="color: #800080;">0</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 62</span><br><span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> ([response respondsToSelector:@selector(allHeaderFields)]) {<br></span><span style="color: #008080;"> 64</span><br><span style="color: #008080;"> 65</span>         NSDictionary <em>dictionary =<span style="color: #000000;"> [resp allHeaderFields];<br></span><span style="color: #008080;"> 66</span><br><span style="color: #008080;"> 67</span>         NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">[network]allHeaderFields:%@</span><span style="color: #800000;">“</span><span style="color: #000000;">,[dictionary description]);<br></span><span style="color: #008080;"> 68</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 69</span><br><span style="color: #008080;"> 70</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 71</span> <span style="color: #008000;">/</span></em><span style="color: #008000;"><em><br></em></span><span style="color: #008080;"> 72</span> <span style="color: #008000;">  接收到服务器传输数据的时候调用，此方法根据数据大小执行若干次<br></span><span style="color: #008080;"> 73</span>  <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 74</span> - (<span style="color: #0000ff;">void</span>)connection:(NSURLConnection )connection didReceiveData:(NSData <em><span style="color: #000000;">)data<br></span><span style="color: #008080;"> 75</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 76</span>     [resultData appendData:data]; <span style="color: #008000;">//</span><span style="color: #008000;"> 追加结果</span><br><span style="color: #008080;"> 77</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 78</span> <span style="color: #008000;">/</span></em><span style="color: #008000;"><em><br></em></span><span style="color: #008080;"> 79</span> <span style="color: #008000;">  数据传完之后调用此方法<br></span><span style="color: #008080;"> 80</span>  <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 81</span> - (<span style="color: #0000ff;">void</span>)connectionDidFinishLoading:(NSURLConnection <span style="color: #000000;">)connection<br></span><span style="color: #008080;"> 82</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 83</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 把请求结果以UTF-8编码转换成字符串</span><br><span style="color: #008080;"> 84</span>     NSString <em>resultStr =<span style="color: #000000;"> [[NSString alloc] initWithData:[self resultData] encoding:NSUTF8StringEncoding];<br></span><span style="color: #008080;"> 85</span><br><span style="color: #008080;"> 86</span>     <span style="color: #0000ff;">if</span> (finishCallbackBlock) { <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了回调的block，直接调用</span><br><span style="color: #008080;"> 87</span> <span style="color: #000000;">        finishCallbackBlock(resultStr);<br></span><span style="color: #008080;"> 88</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 89</span><br><span style="color: #008080;"> 90</span><br><span style="color: #008080;"> 91</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 92</span> <span style="color: #008000;">/</span></em><span style="color: #008000;"><em><br></em></span><span style="color: #008080;"> 93</span> <span style="color: #008000;">  网络请求过程中，出现任何错误（断网，连接超时等）会进入此方法<br></span><span style="color: #008080;"> 94</span>  <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 95</span> - (<span style="color: #0000ff;">void</span>)connection:(NSURLConnection )connection didFailWithError:(NSError *<span style="color: #000000;">)error<br></span><span style="color: #008080;"> 96</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 97</span>     NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">network error: %@</span><span style="color: #800000;">“</span><span style="color: #000000;">, [error localizedDescription]);<br></span><span style="color: #008080;"> 98</span><br><span style="color: #008080;"> 99</span>     <span style="color: #0000ff;">if</span> (finishCallbackBlock) { <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了回调的block，直接调用</span><br><span style="color: #008080;">100</span> <span style="color: #000000;">        finishCallbackBlock(nil);<br></span><span style="color: #008080;">101</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">102</span><br><span style="color: #008080;">103</span><br><span style="color: #008080;">104</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">105</span> <span style="color: #0000ff;">@end</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>在这个实现类中，我们在类方法中，先生成一个HttpPostExecutor对象，这个对象用于post请求的回调（因为实现了&lt;NSURLConnectionDataDelegate&gt;协议），然后去执行post连接。</p>
<p>接下来就等下面实现的回调方法被自动调用了，一旦调用</p>
<ul>
<li>(<span class="s1">void</span>)connection:(<span class="s2">NSURLConnection</span> <em>)connection didReceiveResponse:(<span class="s2">NSURLResponse</span> </em>)response</li>
</ul>
<p>这个方法，就对resultData（用于存储post请求结果）进行初始化或者清空，因为要开始真正存储数据了嘛；</p>
<p>&nbsp;</p>
<ul>
<li>(<span class="s1">void</span>)connection:(<span class="s2">NSURLConnection</span> <em>)connection didReceiveData:(<span class="s2">NSData</span> </em>)data</li>
</ul>
<p>这个方法进行回调的时候，把返回过来的这部分数据存储到resultData中，没什么好说的；</p>
<p>&nbsp;</p>
<p>一旦回调- (<span class="s1">void</span>)connectionDidFinishLoading:(<span class="s2">NSURLConnection</span> *)connection这个方法，说明数据传输完毕了，要做的逻辑就是把数据转成utf-8编码的字符串，然后回调我们设置的回调finishCallbackBlock，把转好的结果字符串传进去，这样我们在回调block方法中实现的逻辑就能正常执行了。</p>
<p>&nbsp;</p>
<p>一旦回调- (<span class="s1">void</span>)connection:(<span class="s2">NSURLConnection</span> <em>)connection didFailWithError:(<span class="s2">NSError</span> </em>)error这个方法，说明请求过程中出错了，比如断电、超时等，这时候，也回调我们设置的回调finishCallbackBlock，nil作为结果，这样我们在finishCallbackBlock中就能判断是正常的执行了post还是出了问题。</p>
<p>&nbsp;</p>
<p>好了，接下来，我们就可以在外面去调用了，如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> [HttpPostExecutor postExecuteWithUrlStr:<span style="color: #800000;">@”</span><span style="color: #800000;"><a href="http://www.baidu.com" target="_blank" rel="noopener">http://www.baidu.com</a></span><span style="color: #800000;">“</span><br><span style="color: #008080;">2</span>                                   Paramters:<span style="color: #800000;">@””</span><br><span style="color: #008080;">3</span>                         FinishCallbackBlock:^(NSString *<span style="color: #000000;">result){<br></span><span style="color: #008080;">4</span>                             <span style="color: #008000;">//</span><span style="color: #008000;"> 执行post请求完成后的逻辑</span><br><span style="color: #008080;">5</span>                             NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">finish callback block, result: %@</span><span style="color: #800000;">“</span><span style="color: #000000;">, result);<br></span><span style="color: #008080;">6</span>                         }];</pre><br></div>

<p>这样，以后post请求只需要去调用上面这个方法，在回调block中去处理结果</p>
<p>之后，在我们的代码编写中，就可以只关心业务逻辑，不需要去在意请求协议和回调了</p>
<p>&nbsp;</p>
<p><span style="color: #800000; font-size: 16px;"><strong><a href="http://pan.baidu.com/s/1uxVGh" target="_blank" rel="noopener"><span style="color: #800000;">测试demo下载</span></a></strong></span></p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> iOS </tag>
            
            <tag> block </tag>
            
            <tag> post </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【IOS】ios中NSUserDefault与android中的SharedPreference用法简单对比]]></title>
      <url>/2013/11/03/%E3%80%90IOS%E3%80%91ios%E4%B8%ADNSUserDefault%E4%B8%8Eandroid%E4%B8%AD%E7%9A%84SharedPreference%E7%94%A8%E6%B3%95%E7%AE%80%E5%8D%95%E5%AF%B9%E6%AF%94/</url>
      <content type="html"><![CDATA[<p>有Android开发经验的朋友对SharedPreference的用法应该比较亲切的吧，它一般用来保存和读取用户的设置参数，比如保存用户名、加密后的登录密码，是否选择了自动登录，应用选择了哪一套主题皮肤等用户配置信息，使用也非常简单，put/get就能保存/读取这个配置文件，这个文件是用xml形式保存在应用的目录下面</p>
<p>在ios中，也有这么一个类似的工具&mdash;&mdash;NSUserDefault，它支持的数据格式有：NSNumber（Integer、Float、Double），NSString，NSDate，NSArray，NSDictionary，BOOL类型。它是存储在/Library/Prefereces里面，有个plist文件。</p>
<p>下面，我们写一个demo来测试下：</p>
<p>界面很简单，两个button，一个label</p>
<p>点击第一个button用来保存数据，点击第二个button用来显示数据到label</p>
<p>代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> - (IBAction)buttonClicked:(<span style="color: #0000ff;">id</span><span style="color: #000000;">)sender {<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">switch</span><span style="color: #000000;"> ([sender tag]) {<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">1</span>: <span style="color: #008000;">//</span><span style="color: #008000;"> 保存数据</span><br><span style="color: #008080;"> 4</span> <span style="color: #000000;">            [self saveData];<br></span><span style="color: #008080;"> 5</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">2</span>: <span style="color: #008000;">//</span><span style="color: #008000;"> 显示数据</span><br><span style="color: #008080;"> 7</span> <span style="color: #000000;">            [self showData];<br></span><span style="color: #008080;"> 8</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>         <span style="color: #0000ff;">default</span><span style="color: #000000;">:<br></span><span style="color: #008080;">11</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)saveData<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">18</span>     NSUserDefaults <em>userDef =<span style="color: #000000;"> [NSUserDefaults standardUserDefaults];<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>     [userDef setObject:<span style="color: #800000;">@”</span><span style="color: #800000;">wangjie</span><span style="color: #800000;">“</span> forKey:<span style="color: #800000;">@”</span><span style="color: #800000;">name</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;">21</span>     [userDef setInteger:<span style="color: #800080;">23</span> forKey:<span style="color: #800000;">@”</span><span style="color: #800000;">age</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;">22</span>     [userDef setBool:YES forKey:<span style="color: #800000;">@”</span><span style="color: #800000;">isAutoLogin</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;">23</span>     [userDef setDouble:<span style="color: #800080;">115.0</span> forKey:<span style="color: #800000;">@”</span><span style="color: #800000;">weight</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;">24</span>     [userDef setFloat:<span style="color: #800080;">171.2</span> forKey:<span style="color: #800000;">@”</span><span style="color: #800000;">height</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;">25</span><br><span style="color: #008080;">26</span> <span style="color: #000000;">    [userDef synchronize];<br></span><span style="color: #008080;">27</span>     NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">save success!</span><span style="color: #800000;">“</span><span style="color: #000000;">);<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)showData<br></span><span style="color: #008080;">31</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">32</span>     NSUserDefaults </em>userDef =<span style="color: #000000;"> [NSUserDefaults standardUserDefaults];<br></span><span style="color: #008080;">33</span>     NSString *content = [NSString stringWithFormat:<span style="color: #800000;">@”</span><span style="color: #800000;">name: %@; age: %d; isAutoLogin: %hhd; weight: %f; height: %f</span><span style="color: #800000;">“</span><span style="color: #000000;">,<br></span><span style="color: #008080;">34</span>                          [userDef stringForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">name</span><span style="color: #800000;">“</span><span style="color: #000000;">],<br></span><span style="color: #008080;">35</span>                          [userDef integerForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">age</span><span style="color: #800000;">“</span><span style="color: #000000;">],<br></span><span style="color: #008080;">36</span>                          [userDef boolForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">isAutoLogin</span><span style="color: #800000;">“</span><span style="color: #000000;">],<br></span><span style="color: #008080;">37</span>                          [userDef doubleForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">weight</span><span style="color: #800000;">“</span><span style="color: #000000;">],<br></span><span style="color: #008080;">38</span>                          [userDef floatForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">height</span><span style="color: #800000;">“</span><span style="color: #000000;">]<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">                         ];<br></span><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span> <span style="color: #000000;">    [[self showLb] setText:content];<br></span><span style="color: #008080;">42</span>     NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">%@</span><span style="color: #800000;">“</span><span style="color: #000000;">, [[self showLb] text]);<br></span><span style="color: #008080;">43</span> }</pre><br></div>

<p>一：启动应用程序后直接点击第二个button，因为数据之前没有被保存，所以显示的数据都是默认的数据：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/03193439-fb31db723c6f47598890193e5f312773.png" alt=""></p>
<p>二：点击第一个button（数据会被插入），再点击第二个button（已有数据可以显示），此时情况如下：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/03193549-8ad8294a8e8b46d49770631d4937e47f.png" alt=""></p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> iOS </tag>
            
            <tag> NSUserDefault </tag>
            
            <tag> SharedPreference </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【IOS】从android角度来实现(理解)IOS的UITableView]]></title>
      <url>/2013/11/02/%E3%80%90IOS%E3%80%91%E4%BB%8Eandroid%E8%A7%92%E5%BA%A6%E6%9D%A5%E5%AE%9E%E7%8E%B0-%E7%90%86%E8%A7%A3-IOS%E7%9A%84UITableView/</url>
      <content type="html"><![CDATA[<p>本人从在学校开始到现在上班（13年毕业）一直做web和android方面的开发，最近才开学习及ios的开发，所以ios学习中有不当之处，请大家留言指点</p>
<p>以前从来没有接触过Objective-C这门语言，不过我想面向对象编程应该大体思想都差不多</p>
<p>在ios中的UITableView学习中，开发过android的朋友应该马上会联想到ListView和GridView这两个控件，接下来以ListView为例子，跟UITableView做个对比，看看它们实现的方式有什么相同之处。怎么样能让有android开发经验的朋友，马上掌握UITableView这个控件</p>
<p>先新建一个demo，取名TabViewTest（原谅我吧- -，本来要取名TableViewTest，谁知脑抽新建项目的时候写错了，诶。。。算了，将错就错吧- -）</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/02004946-2ab5264ce0bc47dfb40b97a3911a7079.png" alt=""></p>
<p>ios没有命名空间的概念，没有包概念（这也是为什么ios中的类都有前缀的原因，比如NS等），所以上面像&ldquo;包&rdquo;一样的文件夹都是我自己新建的&ldquo;group&rdquo;，只是为了看起来比较有分层的概念而已，打开finder，到项目文件里一看如下图，妈呀- -，所有的类都挤在一个文件夹里面。。。这是我觉得蛋疼的地方之一-。-</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/02005325-69347d3e30f24d08bfe4d313ca0895f0.png" alt=""></p>
<p>&nbsp;</p>
<p>再回来看看我们项目结构，我分的几个group，如果我把controller这个group的名字改成&ldquo;activity&rdquo;，android开发者肯定有种似曾相识的感觉了：</p>
<p>controller：控制层group，相当于android中的activity</p>
<p>layout：布局group，相当于android中res目录下的layout（xml布局文件）</p>
<p>model：这个不用说就知道放了什么东西了，经典的Person这个测试用的数据结构</p>
<p>adapter：为了还念android中的适配器，然后我就取了这么个group名字</p>
<p>&nbsp;</p>
<p>好了，现在正式开始代码的编写</p>
<p>打开MainAppDelegate.m，它实现了UIApplicationDelegate协议，所以可以在该类中实现应用状态的回调函数</p>
<p>在application:didFinishLaunchingWithOptions:方法（应用程序启动时回调该方法）中来设置它的RootController（根控制器，不知道这样翻译专不专业- -），我的实现是生成一个UINavigationController作为它的root controller，然后把自己新建的一个NaviRootController（在这个Controller中放入一个UITableView，具体下面会讲到）作为UINavigationController的root view，具体代码如下（这个不是我们本次的重点，所以一笔带过）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> - (BOOL)application:(UIApplication <em>)application didFinishLaunchingWithOptions:(NSDictionary </em><span style="color: #000000;">)launchOptions<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 3</span>     self.window =<span style="color: #000000;"> [[UIWindow alloc] initWithFrame:[[UIScreen mainScreen] bounds]];<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 生成UINavigationController对象，并设置它的RootController</span><br><span style="color: #008080;"> 6</span>     UINavigationController *naviController =<span style="color: #000000;"> [[UINavigationController alloc] initWithRootViewController:[[NaviRootController alloc] init]];<br></span><span style="color: #008080;"> 7</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 然后把NavigationController设置为window的RootViewController</span><br><span style="color: #008080;"> 8</span> <span style="color: #000000;">    [self.window setRootViewController:naviController];<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>     self.window.backgroundColor =<span style="color: #000000;"> [UIColor whiteColor];<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">    [self.window makeKeyAndVisible];<br></span><span style="color: #008080;">12</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> YES;<br></span><span style="color: #008080;">13</span> }</pre><br></div>

<p>然后，重点就是NaviRootController这个Controller了，</p>
<p>新建NaviRootController，继承UIViewController，在.h文件中：</p>
<p>声明一个NSMutableArray对象data作为tableView的数据源（<span style="color: #993366;"><strong>相当于在android中经常用到的ArrayList&lt;Person&gt; data。NSMutableArray是数组，ArrayList在java中的底层实现本来用的就是数组，所以很好理解</strong></span>）</p>
<p>声明一个用于适配和绑定tableView数据的适配器TableViewAdapter<span class="s1"> <em>adapter（这个类是我自己写的，下面会讲到。<em>*<span style="color: #993366;">java中要实现ListView中的数据绑定适配，也要通过一个继承于BaseAdapter的适配器进行数据的适配吧，也很好理解</span></em></em>）</span></p>
<p><span class="s1">声明一个UITableView对象（<strong><span style="color: #993366;">相当于android中，在activity中声明一个private ListView listView;</span></strong>）</span></p>
<p>具体代码如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('d9c08616-f985-42b7-8567-4e754559345f')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_d9c08616-f985-42b7-8567-4e754559345f" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">//</span><span style="color: #008000;">  NaviRootController.h<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">//</span><span style="color: #008000;">  TabViewTest<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 5</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Created by WANGJIE on 13-10-31.<br></span><span style="color: #008080;"> 6</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Copyright (c) 2013年 WANGJIE. All rights reserved.<br></span><span style="color: #008080;"> 7</span> <span style="color: #008000;">//<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">#import</span> &lt;UIKit/UIKit.h&gt;<br><span style="color: #008080;">10</span> <span style="color: #0000ff;">@class</span><span style="color: #000000;"> TableViewAdapter;<br></span><span style="color: #008080;">11</span> <span style="color: #0000ff;">@interface</span><span style="color: #000000;"> NaviRootController : UIViewController<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">13</span>     NSMutableArray <em><span style="color: #000000;">data;<br></span><span style="color: #008080;">14</span>     TableViewAdapter </em><span style="color: #000000;">adapter;<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span> @property (weak, nonatomic) IBOutlet UITableView <em><span style="color: #000000;">tableView;<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span> @property NSMutableArray </em><span style="color: #000000;">data;<br></span><span style="color: #008080;">21</span> @property(strong, nonatomic) TableViewAdapter *<span style="color: #000000;">adapter;<br></span><span style="color: #008080;">22</span> <span style="color: #0000ff;">@end</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>好了，声明部分到此为止，接下来看看实现部分</p>
<p><span class="s1">刚刚在</span>MainAppDelegate中，生成了一个NaviRootController对象，然后把这个对象加入到了UINavigationController对象的rootViewController。生成NaviRootController对象的时候，调用了init方法，我们应该在init方法里面去初始化布局，如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('a6fdcec3-37ba-4d77-9aef-f331f7e32fea')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_a6fdcec3-37ba-4d77-9aef-f331f7e32fea" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> - (<span style="color: #0000ff;">id</span><span style="color: #000000;">)init<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 3</span>     self = [self initWithNibName:<span style="color: #800000;">@”</span><span style="color: #800000;">navi_root</span><span style="color: #800000;">“</span><span style="color: #000000;"> bundle:nil];<br></span><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> self;<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> - (<span style="color: #0000ff;">id</span>)initWithNibName:(NSString <em>)nibNameOrNil bundle:(NSBundle </em><span style="color: #000000;">)nibBundleOrNil<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 9</span>     self =<span style="color: #000000;"> [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];<br></span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (self) {<br></span><span style="color: #008080;">11</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获得当前导航栏对象</span><br><span style="color: #008080;">12</span>         UINavigationItem <em>item =<span style="color: #000000;"> [self navigationItem];<br></span><span style="color: #008080;">13</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置导航栏左按钮</span><br><span style="color: #008080;">14</span>         UIBarButtonItem </em>leftButton = [[UIBarButtonItem alloc] initWithTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">leftButton</span><span style="color: #800000;">“</span><span style="color: #000000;"> style:UIBarButtonItemStylePlain target:self action:@selector(buttonClickedAction:)];<br></span><span style="color: #008080;">15</span>         [leftButton setTag:<span style="color: #800080;">0</span><span style="color: #000000;">];<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">        [item setLeftBarButtonItem:leftButton animated:YES];<br></span><span style="color: #008080;">17</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置导航栏右按钮</span><br><span style="color: #008080;">18</span>         UIBarButtonItem *rightButton = [[UIBarButtonItem alloc] initWithTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">rightButton</span><span style="color: #800000;">“</span><span style="color: #000000;"> style:UIBarButtonItemStyleDone target:self action:@selector(buttonClickedAction:)];<br></span><span style="color: #008080;">19</span>         [rightButton setTag:<span style="color: #800080;">1</span><span style="color: #000000;">];<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">        [item setRightBarButtonItem:rightButton animated:YES];<br></span><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">23</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> self;<br></span><span style="color: #008080;">24</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>我们在init方法中调用了initWithNibName:bundle:方法，传入了NibName这个字符串，这个是什么？<strong><span style="color: #993366;">Nib是ios里面的布局文件，也就是相当于android中类似main.xml这种布局文件吧，现在传进去的时nibname，也就是布局文件的名称。</span></strong>所以，没错，传入这个参数后，当前的controller（也就是NaviRootController就跟传入的这个布局文件绑定起来了，<strong><span style="color: #993366;">类似于android中activity中熟悉的setContentView(R.layout.main)一样！</span></strong>）</p>
<p>然后我们顺便看看navi_root.xib这个布局文件：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/02020218-ffb5db3c54c54a6184439f8ed617d17d.png" alt=""></p>
<p>整个界面就一个UITableView，对了，别忘了在File’s Owner中把custom class改成NaviRootController。键盘按住control，用鼠标拖动左边栏的&ldquo;Table View&rdquo;到NaviRootController.h中，会自动生成UITableView声明，并自动绑定。</p>
<p>接下来回到NaviRootController的初始化方法中。</p>
<p>initWithNibName:bundle:方法中后面的UINavigationItem相关的代码是用来设置导航栏左边和右边的按钮，既然是个demo，所以也没什么特别的功能，就是点击下，跳出一个UIAlertView提示下，所以一笔带过。</p>
<p>此时界面布局和controller已经绑定起来了，现在的任务应该是初始化UITableView的数据，也就是上面的data属性，但是在哪里初始化比较好呢？</p>
<p>刚开始，我是直接在init方法中直接去初始化数据，但是失败了，不管在init方法中初始化多少次（data调用多少次addObject方法），data的值永远都是nil（相当于在android中，不管调用多少次list.add(…)方法，list中一条数据也没有加入！），猜测是因为在init方法中的时候属性和控件都还没有被初始化。</p>
<p>最后我的解决办法就是在viewDidLoad方法中去加载数据。viewDidLoad这个回调方法是会在控件加载完毕后调用，所以，我认为在这里去加载数据和做控件的初始化操作是比较合理的。</p>
<p>viewDidLoad方法实现如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('c37254db-2ea2-4e96-a9e5-0ecddbd3c8cc')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_c37254db-2ea2-4e96-a9e5-0ecddbd3c8cc" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)viewDidLoad<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> Do any additional setup after loading the view.</span><br><span style="color: #008080;"> 5</span> <span style="color: #000000;">    [super viewDidLoad];<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">adapter) {<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">        [self initData];<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 生成适配器委托对象</span><br><span style="color: #008080;">11</span>         adapter =<span style="color: #000000;"> [[TableViewAdapter alloc] initWithSource:data Controller:self];<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置适配器委托对象</span><br><span style="color: #008080;">14</span> <span style="color: #000000;">        [[self tableView] setDelegate:adapter];<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        [[self tableView] setDataSource:adapter];<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">18</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>如上，在viewDidLoad中，我先去初始化数据（demo中的实现其实就是循环了14次，往data中加了14个Person对象），然后生成一个适配器委托对象，传入data（数据源）和self（当前controller对象），<strong><span style="color: #993366;">相当于android中的 adapter = new MyAdapter(list, this);有木有？？！！</span></strong></p>
<p>然后，setDelegate用来设置委托对象（<strong><span style="color: #993366;">相当于android中的listView.setAdapter(adapter)</span></strong>），setDataSource用来设置数据源。</p>
<p>这里，完整地列出NaviRootController的代码：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('2b006d06-4ce6-4ae1-bd35-7ec3abe88e1e')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_2b006d06-4ce6-4ae1-bd35-7ec3abe88e1e" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">//</span><br><span style="color: #008080;">  2</span> <span style="color: #008000;">//</span><span style="color: #008000;">  NaviRootController.m<br></span><span style="color: #008080;">  3</span> <span style="color: #008000;">//</span><span style="color: #008000;">  TabViewTest<br></span><span style="color: #008080;">  4</span> <span style="color: #008000;">//</span><br><span style="color: #008080;">  5</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Created by WANGJIE on 13-10-31.<br></span><span style="color: #008080;">  6</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Copyright (c) 2013年 WANGJIE. All rights reserved.<br></span><span style="color: #008080;">  7</span> <span style="color: #008000;">//<br></span><span style="color: #008080;">  8</span><br><span style="color: #008080;">  9</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">NaviRootController.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">Person.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">TableViewAdapter.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 12</span><br><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">@interface</span><span style="color: #000000;"> NaviRootController ()<br></span><span style="color: #008080;"> 14</span><br><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">@end</span><br><span style="color: #008080;"> 16</span><br><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">@implementation</span><span style="color: #000000;"> NaviRootController<br></span><span style="color: #008080;"> 18</span> <span style="color: #0000ff;">@synthesize</span><span style="color: #000000;"> data, adapter;<br></span><span style="color: #008080;"> 19</span><br><span style="color: #008080;"> 20</span> - (<span style="color: #0000ff;">id</span><span style="color: #000000;">)init<br></span><span style="color: #008080;"> 21</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 22</span>     self = [self initWithNibName:<span style="color: #800000;">@”</span><span style="color: #800000;">navi_root</span><span style="color: #800000;">“</span><span style="color: #000000;"> bundle:nil];<br></span><span style="color: #008080;"> 23</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> self;<br></span><span style="color: #008080;"> 24</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 25</span><br><span style="color: #008080;"> 26</span> - (<span style="color: #0000ff;">id</span>)initWithNibName:(NSString <em>)nibNameOrNil bundle:(NSBundle </em><span style="color: #000000;">)nibBundleOrNil<br></span><span style="color: #008080;"> 27</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 28</span>     self =<span style="color: #000000;"> [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];<br></span><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (self) {<br></span><span style="color: #008080;"> 30</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> Custom initialization<br></span><span style="color: #008080;"> 31</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获得当前导航栏对象</span><br><span style="color: #008080;"> 32</span>         UINavigationItem <em>item =<span style="color: #000000;"> [self navigationItem];<br></span><span style="color: #008080;"> 33</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置导航栏左按钮</span><br><span style="color: #008080;"> 34</span>         UIBarButtonItem </em>leftButton = [[UIBarButtonItem alloc] initWithTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">leftButton</span><span style="color: #800000;">“</span><span style="color: #000000;"> style:UIBarButtonItemStylePlain target:self action:@selector(buttonClickedAction:)];<br></span><span style="color: #008080;"> 35</span>         [leftButton setTag:<span style="color: #800080;">0</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 36</span> <span style="color: #000000;">        [item setLeftBarButtonItem:leftButton animated:YES];<br></span><span style="color: #008080;"> 37</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置导航栏右按钮</span><br><span style="color: #008080;"> 38</span>         UIBarButtonItem <em>rightButton = [[UIBarButtonItem alloc] initWithTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">rightButton</span><span style="color: #800000;">“</span><span style="color: #000000;"> style:UIBarButtonItemStyleDone target:self action:@selector(buttonClickedAction:)];<br></span><span style="color: #008080;"> 39</span>         [rightButton setTag:<span style="color: #800080;">1</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 40</span> <span style="color: #000000;">        [item setRightBarButtonItem:rightButton animated:YES];<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span><br><span style="color: #008080;"> 43</span><br><span style="color: #008080;"> 44</span><br><span style="color: #008080;"> 45</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 46</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> self;<br></span><span style="color: #008080;"> 47</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span> <span style="color: #008000;">/</span></em><span style="color: #008000;"><em><br></em></span><span style="color: #008080;"> 50</span> <span style="color: #008000;">  初始化列表数据<br></span><span style="color: #008080;"> 51</span>  <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 52</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)initData<br></span><span style="color: #008080;"> 53</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 54</span>     data =<span style="color: #000000;"> [[NSMutableArray alloc] init];<br></span><span style="color: #008080;"> 55</span>     NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">%@</span><span style="color: #800000;">“</span><span style="color: #000000;">, NSStringFromSelector(_cmd));<br></span><span style="color: #008080;"> 56</span>     Person <span style="color: #000000;">person;<br></span><span style="color: #008080;"> 57</span>     <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = <span style="color: #800080;">0</span>; i &lt; <span style="color: #800080;">14</span>; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;"> 58</span>         person =<span style="color: #000000;"> [[Person alloc] init];<br></span><span style="color: #008080;"> 59</span>         [person setName:[<span style="color: #800000;">@”</span><span style="color: #800000;">name</span><span style="color: #800000;">“</span><span style="color: #000000;"> stringByAppendingString:<br></span><span style="color: #008080;"> 60</span>                          [NSString stringWithFormat:<span style="color: #800000;">@”</span><span style="color: #800000;">%d</span><span style="color: #800000;">“</span><span style="color: #000000;">, i]<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">                         ]<br></span><span style="color: #008080;"> 62</span> <span style="color: #000000;">         ];<br></span><span style="color: #008080;"> 63</span><br><span style="color: #008080;"> 64</span>         [person setAge:i + <span style="color: #800080;">10</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 65</span><br><span style="color: #008080;"> 66</span>         [person setPic:[UIImage imageNamed:<span style="color: #800000;">@”</span><span style="color: #800000;">Hypno.png</span><span style="color: #800000;">“</span><span style="color: #000000;">]];<br></span><span style="color: #008080;"> 67</span><br><span style="color: #008080;"> 68</span> <span style="color: #000000;">        [data addObject:person];<br></span><span style="color: #008080;"> 69</span><br><span style="color: #008080;"> 70</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 71</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 72</span><br><span style="color: #008080;"> 73</span><br><span style="color: #008080;"> 74</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)viewDidLoad<br></span><span style="color: #008080;"> 75</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 76</span><br><span style="color: #008080;"> 77</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> Do any additional setup after loading the view.</span><br><span style="color: #008080;"> 78</span> <span style="color: #000000;">    [super viewDidLoad];<br></span><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">adapter) {<br></span><span style="color: #008080;"> 81</span> <span style="color: #000000;">        [self initData];<br></span><span style="color: #008080;"> 82</span><br><span style="color: #008080;"> 83</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 生成适配器委托对象</span><br><span style="color: #008080;"> 84</span>         adapter =<span style="color: #000000;"> [[TableViewAdapter alloc] initWithSource:data Controller:self];<br></span><span style="color: #008080;"> 85</span><br><span style="color: #008080;"> 86</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置适配器委托对象</span><br><span style="color: #008080;"> 87</span> <span style="color: #000000;">        [[self tableView] setDelegate:adapter];<br></span><span style="color: #008080;"> 88</span> <span style="color: #000000;">        [[self tableView] setDataSource:adapter];<br></span><span style="color: #008080;"> 89</span><br><span style="color: #008080;"> 90</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 91</span><br><span style="color: #008080;"> 92</span><br><span style="color: #008080;"> 93</span><br><span style="color: #008080;"> 94</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 95</span><br><span style="color: #008080;"> 96</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)viewWillAppear:(BOOL)animated<br></span><span style="color: #008080;"> 97</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 98</span> <span style="color: #000000;">    [super viewWillAppear:YES];<br></span><span style="color: #008080;"> 99</span><br><span style="color: #008080;">100</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">101</span><br><span style="color: #008080;">102</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)didReceiveMemoryWarning<br></span><span style="color: #008080;">103</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">    [super didReceiveMemoryWarning];<br></span><span style="color: #008080;">105</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> Dispose of any resources that can be recreated.</span><br><span style="color: #008080;">106</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">107</span><br><span style="color: #008080;">108</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 按钮点击事件回调</span><br><span style="color: #008080;">109</span> - (<span style="color: #0000ff;">void</span>)buttonClickedAction:(<span style="color: #0000ff;">id</span><span style="color: #000000;">)sender<br></span><span style="color: #008080;">110</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">111</span><br><span style="color: #008080;">112</span>     NSString <em><span style="color: #000000;">message;<br></span><span style="color: #008080;">113</span>     <span style="color: #0000ff;">switch</span><span style="color: #000000;"> ([sender tag]) {<br></span><span style="color: #008080;">114</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">0</span><span style="color: #000000;">:<br></span><span style="color: #008080;">115</span>             message = <span style="color: #800000;">@”</span><span style="color: #800000;">left button clicked!</span><span style="color: #800000;">“</span><span style="color: #000000;">;<br></span><span style="color: #008080;">116</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">117</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">1</span><span style="color: #000000;">:<br></span><span style="color: #008080;">118</span>             message = <span style="color: #800000;">@”</span><span style="color: #800000;">right button clicked!</span><span style="color: #800000;">“</span><span style="color: #000000;">;<br></span><span style="color: #008080;">119</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">120</span>         <span style="color: #0000ff;">default</span><span style="color: #000000;">:<br></span><span style="color: #008080;">121</span>             message = <span style="color: #800000;">@”</span><span style="color: #800000;">unknow button clicked!</span><span style="color: #800000;">“</span><span style="color: #000000;">;<br></span><span style="color: #008080;">122</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">123</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">124</span><br><span style="color: #008080;">125</span>     UIAlertView </em>alert = [[UIAlertView alloc] initWithTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">alert view</span><span style="color: #800000;">“</span> message:message <span style="color: #0000ff;">delegate</span>:self cancelButtonTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">cancel</span><span style="color: #800000;">“</span><span style="color: #000000;"> otherButtonTitles:nil, nil];<br></span><span style="color: #008080;">126</span> <span style="color: #000000;">    [alert show];<br></span><span style="color: #008080;">127</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">128</span><br><span style="color: #008080;">129</span><br><span style="color: #008080;">130</span><br><span style="color: #008080;">131</span><br><span style="color: #008080;">132</span> <span style="color: #0000ff;">@end</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>&nbsp;</p>
<p>好了，UITableView的初始化准备工作到此就做完了，现在干嘛？</p>
<p>当然去编写TableViewAdapter这个类啊。数据源有了（并且初始化完毕），用以显示的控件（UITableView）有了（并且初始化完毕），而且两个还已经绑定起来了。但是还缺的就是一个角色，这个角色可以把数据源中的数据跟控件中某个相应的子控件适配起来。比如数据源中有4个数据，A、B、C、D，控件有one、two、three、four这4个控件，这个角色的任务就是告诉one：你要显示的数据是A；告诉two：你要显示的数据是B；告诉three：你要显示的数据是C；告诉four：你要显示的数据是D！</p>
<p>这个角色就是适配器！也就是下面要说的那个TableViewAdapter</p>
<p>新建TableViewAdapter，实现<span class="s1">&lt;</span>UITableViewDataSource<span class="s1">, </span>UITableViewDelegate<span class="s1">&gt;这两个协议（<strong><span style="color: #993366;">android中适配器不同的是要继承BaseAdapter类</span></strong>）。声明一个数据源data，这个数据源是从NaviRootController中传过来的已经初始化好了的数据源，还有一个声明是</span>NaviRootController对象传过来的self（需要什么，就让调用者传什么过来，这个应该都懂的-。-），另外还有一个自己写的初始化方法（自己写初始化方法init打头的方法就行，不像java中的构造方法，方法名要跟类名相同，不过这些都是换汤不换药）</p>
<p><span class="s1">然后看看TableViewAdapter的实现类（.m）</span></p>
<p><span class="s1">实现了这两个协议后，你就能覆写里面的一些UITableView的回调方法了，比如：</span></p>
<p>tableView:numberOfRowsInSection:方法，返回数据源的数量就行了（<strong><span style="color: #993366;">类似android的adapter中自己要实现的getCount()方法！</span></strong>）</p>
<p>tableView:cellForRowAtIndexPath:这个是方法是这里最关键的一个方法了，就是在这里进行数据的适配工作（<strong><span style="color: #993366;">类似android的adapter中自己要实现的getView()方法！</span></strong>），这里返回的UITableViewCell就是类表中的一项（<strong><span style="color: #993366;">类似android中listview的一个item</span></strong>），这个一项的布局，已经在table_cell.xib文件中布局完毕，如下：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/02023019-1ef72e95265e49d892e83e1a84ef423c.png" alt=""></p>
<p>设置File’s Owner为TableViewAdapter，设置Table View Cell的identifier设置为&ldquo;MyTableCell&rdquo;，这个可以任意取名，但是要跟后面的方法实现中统一（跟哪里统一？作用是神马？这些下面会讲到，别急-。-），接着设置ImageView的tag为1，nameLabel的tag为2，ageLabel的tag为3（tag的作用，下面也会讲到）。</p>
<p>接着，回到tableView:cellForRowAtIndexPath:这个方法，它的实现如下所示：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> - (UITableViewCell <em>)tableView:(UITableView </em>)tableView cellForRowAtIndexPath:(NSIndexPath <em><span style="color: #000000;">)indexPath<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 3</span>     Person </em>p =<span style="color: #000000;"> [data objectAtIndex:[indexPath row]];<br></span><span style="color: #008080;"> 4</span>     UITableViewCell <em>cell = [tableView dequeueReusableCellWithIdentifier:<span style="color: #800000;">@”</span><span style="color: #800000;">MyTableCell</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">cell) {<br></span><span style="color: #008080;"> 6</span>         NSArray </em>nibViews = [[NSBundle mainBundle] loadNibNamed:<span style="color: #800000;">@”</span><span style="color: #800000;">table_cell</span><span style="color: #800000;">“</span><span style="color: #000000;"> owner:self options:nil];<br></span><span style="color: #008080;"> 7</span>         cell = [nibViews objectAtIndex:<span style="color: #800080;">0</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>     UIImageView <em>picIv = (UIImageView </em>)[cell viewWithTag:<span style="color: #800080;">1</span><span style="color: #000000;">];<br></span><span style="color: #008080;">11</span>     UILabel <em>nameLb = (UILabel </em>)[cell viewWithTag:<span style="color: #800080;">2</span><span style="color: #000000;">];<br></span><span style="color: #008080;">12</span>     UILabel <em>ageLb = (UILabel </em>)[cell viewWithTag:<span style="color: #800080;">3</span><span style="color: #000000;">];<br></span><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span> <span style="color: #000000;">    [nameLb setText:[p name]];<br></span><span style="color: #008080;">15</span>     [ageLb setText:[NSString stringWithFormat:<span style="color: #800000;">@”</span><span style="color: #800000;">%d</span><span style="color: #800000;">“</span><span style="color: #000000;">, [p age]]];<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">    [picIv setImage:[p pic]];<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> cell;<br></span><span style="color: #008080;">19</span> }</pre><br></div>

<p>如上图所示：</p>
<p>第3行，是用于获得所要显示的数据Person对象（<strong><span style="color: #993366;">这里的[indexPath row]相当于android的adapter的getView方法的position参数</span></strong>。indexPath中有两个参数，row和section，表示行和列，因为我们现在是要显示一个列表，所以只需要row这个参数就可以了）</p>
<p><span class="s1">第4行，是用于资源的重复利用，根据标示符&ldquo;MyTableCell&rdquo;去获得一个可再利用的UITableViewCell（这里的标示符就要跟前面在xib文件中设置的标示符要一致，这样才能被识别到，然后在这里被获取到），如果没有获得到，就去新创建一个UITableViewCell。</span></p>
<p><span class="s1">第6、7行，是创建新的UITableViewCell的代码，通过mianBundle的loadNibNamed:owner:options方法根据xib的名字去创建（<strong><span style="color: #993366;">跟</span></strong></span><strong><span style="color: #993366;">android<span class="s1">中的</span>LayoutInflater.inflate()</span></strong><span class="s1"><strong><span style="color: #993366;">方法通过R.layout.xxx的方法创建类似</span></strong>），loadNibNamed:owner:options返回的是一个数组，得到第一个就是UITableViewCell了。</span></p>
<p><span class="s1">第10、11、12行，是获取到或者新建的cell通过控件之前设置的tag来获得相应地子控件（现在知道之前为什么要设置xib文件中控件的tag了吧？<strong><span style="color: #993366;">这个跟</span></strong></span><strong><span style="color: #993366;">android<span class="s1">中的</span>findViewByTag/findViewById又是很类似的！</span></strong><span class="s1">）</span></p>
<p><span class="s1">第14、15、16行，是为刚刚获得的cell中的子控件适配数据，让它可以把数据显示出来。</span></p>
<p><span class="s1">第18行，把生成数据适配完毕的UITableViewCell返回出去（<strong><span style="color: #993366;">这跟android中的也是很类似</span></strong>）</span></p>
<p>TableViewAdapter代码如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('ec009a67-93fe-4bda-989e-4fcd65ed3131')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_ec009a67-93fe-4bda-989e-4fcd65ed3131" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">//</span><span style="color: #008000;">  TableViewAdapter.m<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">//</span><span style="color: #008000;">  TabViewTest<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 5</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Created by WANGJIE on 13-10-31.<br></span><span style="color: #008080;"> 6</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Copyright (c) 2013年 WANGJIE. All rights reserved.<br></span><span style="color: #008080;"> 7</span> <span style="color: #008000;">//<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">TableViewAdapter.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;">10</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">Person.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">NaviRootController.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">@implementation</span><span style="color: #000000;"> TableViewAdapter<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> - (<span style="color: #0000ff;">id</span>)initWithSource:(NSMutableArray <em>)source Controller:(NaviRootController </em><span style="color: #000000;">)context<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">17</span>     NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">initWithSource…</span><span style="color: #800000;">“</span><span style="color: #000000;">);<br></span><span style="color: #008080;">18</span>     self =<span style="color: #000000;"> [super init];<br></span><span style="color: #008080;">19</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (self) {<br></span><span style="color: #008080;">20</span>         data =<span style="color: #000000;"> source;<br></span><span style="color: #008080;">21</span>         controller =<span style="color: #000000;"> context;<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">23</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> self;<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">25</span><br><span style="color: #008080;">26</span> - (NSInteger)tableView:(UITableView <em><span style="color: #000000;">)tableView numberOfRowsInSection:(NSInteger)section<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> [data count];<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">31</span><br><span style="color: #008080;">32</span> - (UITableViewCell </em>)tableView:(UITableView <em>)tableView cellForRowAtIndexPath:(NSIndexPath </em><span style="color: #000000;">)indexPath<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">34</span>     NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">%@</span><span style="color: #800000;">“</span><span style="color: #000000;">, NSStringFromSelector(_cmd));<br></span><span style="color: #008080;">35</span> <span style="color: #008000;">//</span><span style="color: #008000;">    UITableViewCell <em>cell = [tableView dequeueReusableCellWithIdentifier:@”UITableViewCell”];<br></em></span><span style="color: #008080;">36</span> <span style="color: #008000;">//</span><span style="color: #008000;">    if (!cell) {<br></span><span style="color: #008080;">37</span> <span style="color: #008000;">//</span><span style="color: #008000;">        cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:@”UITableViewCell”];<br></span><span style="color: #008080;">38</span> <span style="color: #008000;">//</span><span style="color: #008000;">    }<br></span><span style="color: #008080;">39</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 获得当前要显示的数据</span><br><span style="color: #008080;">40</span>     Person p =<span style="color: #000000;"> [data objectAtIndex:[indexPath row]];<br></span><span style="color: #008080;">41</span> <span style="color: #008000;">//</span><br><span style="color: #008080;">42</span> <span style="color: #008000;">//</span><span style="color: #008000;">    [[cell textLabel] setText:[p name]];<br></span><span style="color: #008080;">43</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 记得在cell.xib文件中设置identifier以达到重用的目的</span><br><span style="color: #008080;">44</span>     UITableViewCell <em>cell = [tableView dequeueReusableCellWithIdentifier:<span style="color: #800000;">@”</span><span style="color: #800000;">MyTableCell</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;">45</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">cell) {<br></span><span style="color: #008080;">46</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 通过mainBundle的loadNibNamed方法去加载布局，类似android中的LayoutInflater.inflate()方法</span><br><span style="color: #008080;">47</span>         NSArray </em>nibViews = [[NSBundle mainBundle] loadNibNamed:<span style="color: #800000;">@”</span><span style="color: #800000;">table_cell</span><span style="color: #800000;">“</span><span style="color: #000000;"> owner:self options:nil];<br></span><span style="color: #008080;">48</span>         cell = [nibViews objectAtIndex:<span style="color: #800080;">0</span><span style="color: #000000;">];<br></span><span style="color: #008080;">49</span> <span style="color: #008000;">//</span><span style="color: #008000;">        cell.selectionStyle = UITableViewCellSelectionStyleNone;</span><br><span style="color: #008080;">50</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">51</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 通过在cell.xib中各控件设置的tag来获得控件，类似android中的findViewByTag/findViewById</span><br><span style="color: #008080;">52</span>     UIImageView <em>picIv = (UIImageView </em>)[cell viewWithTag:<span style="color: #800080;">1</span><span style="color: #000000;">];<br></span><span style="color: #008080;">53</span>     UILabel <em>nameLb = (UILabel </em>)[cell viewWithTag:<span style="color: #800080;">2</span><span style="color: #000000;">];<br></span><span style="color: #008080;">54</span>     UILabel <em>ageLb = (UILabel </em>)[cell viewWithTag:<span style="color: #800080;">3</span><span style="color: #000000;">];<br></span><span style="color: #008080;">55</span><br><span style="color: #008080;">56</span> <span style="color: #000000;">    [nameLb setText:[p name]];<br></span><span style="color: #008080;">57</span>     [ageLb setText:[NSString stringWithFormat:<span style="color: #800000;">@”</span><span style="color: #800000;">%d</span><span style="color: #800000;">“</span><span style="color: #000000;">, [p age]]];<br></span><span style="color: #008080;">58</span> <span style="color: #000000;">    [picIv setImage:[p pic]];<br></span><span style="color: #008080;">59</span><br><span style="color: #008080;">60</span><br><span style="color: #008080;">61</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> cell;<br></span><span style="color: #008080;">62</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">63</span><br><span style="color: #008080;">64</span><br><span style="color: #008080;">65</span> - (<span style="color: #0000ff;">void</span>)tableView:(UITableView <em>)tableView didSelectRowAtIndexPath:(NSIndexPath </em><span style="color: #000000;">)indexPath<br></span><span style="color: #008080;">66</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">67</span>     Person <em>person =<span style="color: #000000;"> [data objectAtIndex:[indexPath row]];<br></span><span style="color: #008080;">68</span>     UIAlertView </em>alert = [[UIAlertView alloc] initWithTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">cell clicked!</span><span style="color: #800000;">“</span> message:[NSString stringWithFormat:<span style="color: #800000;">@”</span><span style="color: #800000;">%@ clicked!</span><span style="color: #800000;">“</span>, [person name]]<span style="color: #0000ff;">delegate</span>:self cancelButtonTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">cancel</span><span style="color: #800000;">“</span><span style="color: #000000;"> otherButtonTitles:nil, nil];<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">    [alert show];<br></span><span style="color: #008080;">70</span><br><span style="color: #008080;">71</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">72</span><br><span style="color: #008080;">73</span> - (CGFloat)tableView:(UITableView <em>)tableView heightForRowAtIndexPath:(NSIndexPath </em><span style="color: #000000;">)indexPath<br></span><span style="color: #008080;">74</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">75</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> [self tableView:tableView cellForRowAtIndexPath:indexPath].frame.size.height;<br></span><span style="color: #008080;">76</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">77</span><br><span style="color: #008080;">78</span><br><span style="color: #008080;">79</span> <span style="color: #0000ff;">@end</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>&nbsp;</p>
<p>好了！到此为止整个UITableView实现的流程基本完成了，可以看出跟android的ListView和GridView的实现流程很相似，理解了其中一个，另一个也能很好的理解它的工作流程。</p>
<p>最后来一张效果图：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/02030600-2d2805ccefc04db9b4e0085845980d43.png" alt=""></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> iOS </tag>
            
            <tag> UITableView </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android NDK环境搭建及调用JNI的简单步骤]]></title>
      <url>/2013/10/30/Android-NDK%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%8F%8A%E8%B0%83%E7%94%A8JNI%E7%9A%84%E7%AE%80%E5%8D%95%E6%AD%A5%E9%AA%A4/</url>
      <content type="html"><![CDATA[<p><span>Java Native Interface (JNI)标准是java平台的一部分，它允许Java代码和其他语言写的代码进行交互。JNI 是本地编程接口，它使得在 Java 虚拟机 (VM) 内部运行的 Java 代码能够与用其它编程语言(如 C、C++ 和汇编语言)编写的应用程序和库进行交互操作。</span></p>
<p>1. 下载NDK（<a href="http://developer.android.com/tools/sdk/ndk/index.html" target="_blank" rel="noopener">http://developer.android.com/tools/sdk/ndk/index.html</a>），并解压，配置Path路径</p>
<p>&nbsp;</p>
<p>2. 在项目中新建一个名为jni的文件夹，在jni中新增Android.mk文件，文件内容如下：</p>
<div class="cnblogs_Highlighter"><br><pre class="brush:html;gutter:false;">LOCAL_PATH := $(call my-dir)<br>include $(CLEAR_VARS)<br>LOCAL_MODULE    := PhotoUtil<br>LOCAL_SRC_FILES := PhotoUtil.c<br>LOCAL_LDLIBS    := -llog -ljnigraphics<br>include $(BUILD_SHARED_LIBRARY)<br></pre><br></div>

<p><span>LOCAL_MODULE：当前模块的名称</span></p>
<p><span><span>LOCAL_SHARED_LIBRARIES：当前模块需要依赖的共享库。&nbsp;</span></span></p>
<p><span><span>LOCAL_SRC_FILES：所要调用的C源码</span></span></p>
<p>&nbsp;</p>
<p><span><span>3. 把PhotoUtil.c文件复制到jni目录下</span></span></p>
<p><span><span>PhotoUtil.c，包含一个图片处理方法：</span></span></p>
<div class="cnblogs_code"><br><pre>JNIEXPORT <span style="color: #0000ff;">void</span> JNICALL Java_com_wangjie_customviews_PicturesDialog_functionToBlur(JNIEnv*<span style="color: #000000;"> env, jobject obj, jobject bitmapIn, jobject bitmapOut, jint radius) {<br>    &hellip;&hellip;<br>}</span></pre><br></div>

<p>方法Java_com_wangjie_customviews_PicturesDialog_functionToBlur的取名方式：</p>
<p>Java_：固定<br>com_wangjie_customviews：java包名<br>PicturesDialog：java类名<br>functionToBlur：java使用的方法名</p>
<p>&nbsp;</p>
<p>4. 编译C源码，生产so库文件</p>
<p>进入jni目录：</p>
<p>ndk-build 或者</p>
<p><span>ndk-build&nbsp;APP_PLATFORM=android-8</span></p>
<div class="cnblogs_Highlighter"><br><pre class="brush:html;gutter:true;">“Compile thumb : PhotoUtil &lt;= PhotoUtil.c<br>SharedLibrary  : libPhotoUtil.so<br>Install        : libPhotoUtil.so =&gt; libs/armeabi/libPhotoUtil.so</pre><br></div>

<p><span>执行完毕之后，android项目的libs目录下就会生成so文件：</span></p>
<p><span>\libs\armeabi\libPhotoUtil.so</span></p>
<p><span><span>5. 在android中java代码调用：</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">static</span><span style="color: #000000;">{<br>      System.loadLibrary(</span>“PhotoUtil”<span style="color: #000000;">);<br>}</span></pre><br></div>

<p>加载photoUtil库（libPhotoUtil.so）</p>
<p>并添加：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">native</span> <span style="color: #0000ff;">void</span> functionToBlur(Bitmap bitmapIn, Bitmap bitmapOut, <span style="color: #0000ff;">int</span> radius);</pre><br></div>

<p>然后在其他地方只需要调用该functionToBlur()方法即可：</p>
<div class="cnblogs_code"><br><pre>functionToBlur(bgBitmap, bitmapOut, 50);</pre><br></div>

<p>&nbsp;</p>
<p>参考：</p>
<p><a href="http://www.ibm.com/developerworks/opensource/tutorials/os-androidndk/section5.html" target="_blank" rel="noopener">http://www.ibm.com/developerworks/opensource/tutorials/os-androidndk/section5.html</a></p>
<p><a href="http://developer.android.com/tools/sdk/ndk/index.html#Installing" target="_blank" rel="noopener">http://developer.android.com/tools/sdk/ndk/index.html#Installing</a></p>
<p><a href="http://stackoverflow.com/questions/2067955/fast-bitmap-blur-for-android-sdk" target="_blank" rel="noopener">http://stackoverflow.com/questions/2067955/fast-bitmap-blur-for-android-sdk</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ndk </tag>
            
            <tag> jni </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android使用Fragment来实现ViewPager的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信]]></title>
      <url>/2013/10/12/Android%E4%BD%BF%E7%94%A8Fragment%E6%9D%A5%E5%AE%9E%E7%8E%B0ViewPager%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%88%E8%A7%A3%E5%86%B3%E5%88%87%E6%8D%A2Fragment%E7%8A%B6%E6%80%81%E4%B8%8D%E4%BF%9D%E5%AD%98%EF%BC%89%E4%BB%A5%E5%8F%8A%E5%90%84%E4%B8%AAFragment%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1/</url>
      <content type="html"><![CDATA[<p>我前两天写过一篇博客《Android使用Fragment来实现TabHost的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信》（<a href="http://www.cnblogs.com/tiantianbyconan/p/3360938.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/3360938.html</a>），实现了Tab切换时保留当前Fragment状态，并在切换前自动回调onPause()方法，在切换后自动调用onResume()，这样就做到了跟TahHost一样的功能。</p>
<p>今天来实现下ViewPager的功能，google提供了一个FragmentPagerAdapter这么一个适配器，蛋疼的是，碰到了跟上次类似的问题。比如ViewPager有5个page，刚打开的时候，会加载page1和page2，我们手动切换到page2的时候，会加载page3，切换到page3的时候，加载page4的同时会destory掉page1，所以，还是面临同样的问题，page的状态无法保存，于是，咱还是自己来实现下好了，自己动手，丰衣足食嘛！（同样&nbsp;<span>有朋友知道解决办法的话，希望联系我，赐教下哈</span>）</p>
<p>先来看下整个demo的结构，跟上次实现TabHost的例子差不多：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201310/12093410-5a0bb7a1077d4614898ce8b0fbb85d07.jpg" alt=""></p>
<p><span>TabAFm到TabEFm都是Fragment，并且每个Fragment对应一个布局文件。</span></p>
<p><span><span>TabAFm.java：</span></span></p>
<p>&nbsp;</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('9a8422d4-8368-43fb-ba86-2c66b20d04f0')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_9a8422d4-8368-43fb-ba86-2c66b20d04f0" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.fragmentviewpagertest;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.app.Activity;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.Fragment;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.LayoutInflater;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.ViewGroup;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">11</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;">12</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">13</span> <span style="color: #008000;">  Date: 13-6-14<br></span><span style="color: #008080;">14</span> <span style="color: #008000;"> <em> Time: 下午2:39<br></em></span><span style="color: #008080;">15</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TabAFm <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Fragment{<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">18</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onAttach(Activity activity) {<br></span><span style="color: #008080;">19</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onAttach(activity);<br></span><span style="color: #008080;">20</span>         System.out.println(“AAAAAAAAAA<strong><strong>onAttach”<span style="color: #000000;">);<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">24</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;">25</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;">26</span>         System.out.println(“AAAAAAAAAA</strong></strong>onCreate”<span style="color: #000000;">);<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">30</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {<br></span><span style="color: #008080;">31</span>         System.out.println(“AAAAAAAAAA<strong><strong>onCreateView”<span style="color: #000000;">);<br></span><span style="color: #008080;">32</span>         <span style="color: #0000ff;">return</span> inflater.inflate(R.layout.tab_a, container, <span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">34</span><br><span style="color: #008080;">35</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">36</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onActivityCreated(Bundle savedInstanceState) {<br></span><span style="color: #008080;">37</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onActivityCreated(savedInstanceState);<br></span><span style="color: #008080;">38</span>         System.out.println(“AAAAAAAAAA</strong></strong>onActivityCreated”<span style="color: #000000;">);<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">42</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onStart() {<br></span><span style="color: #008080;">43</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onStart();<br></span><span style="color: #008080;">44</span>         System.out.println(“AAAAAAAAAA<strong><strong>onStart”<span style="color: #000000;">);<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">48</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onResume() {<br></span><span style="color: #008080;">49</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onResume();<br></span><span style="color: #008080;">50</span>         System.out.println(“AAAAAAAAAA</strong></strong>onResume”<span style="color: #000000;">);<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">52</span><br><span style="color: #008080;">53</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">54</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPause() {<br></span><span style="color: #008080;">55</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPause();<br></span><span style="color: #008080;">56</span>         System.out.println(“AAAAAAAAAA<strong><strong>onPause”<span style="color: #000000;">);<br></span><span style="color: #008080;">57</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">58</span><br><span style="color: #008080;">59</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">60</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onStop() {<br></span><span style="color: #008080;">61</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onStop();<br></span><span style="color: #008080;">62</span>         System.out.println(“AAAAAAAAAA</strong></strong>onStop”<span style="color: #000000;">);<br></span><span style="color: #008080;">63</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">64</span><br><span style="color: #008080;">65</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">66</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDestroyView() {<br></span><span style="color: #008080;">67</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDestroyView();<br></span><span style="color: #008080;">68</span>         System.out.println(“AAAAAAAAAA<strong><strong>onDestroyView”<span style="color: #000000;">);<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">70</span><br><span style="color: #008080;">71</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">72</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDestroy() {<br></span><span style="color: #008080;">73</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDestroy();<br></span><span style="color: #008080;">74</span>         System.out.println(“AAAAAAAAAA</strong></strong>onDestroy”<span style="color: #000000;">);<br></span><span style="color: #008080;">75</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">76</span><br><span style="color: #008080;">77</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">78</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDetach() {<br></span><span style="color: #008080;">79</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDetach();<br></span><span style="color: #008080;">80</span>         System.out.println(“AAAAAAAAAA____onDetach”<span style="color: #000000;">);<br></span><span style="color: #008080;">81</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">82</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>如上述代码所示，TabAFm是一个Fragment，对应的布局文件是tab_a.xml，并实现了他的所有的生命周期回调函数并打印，便于调试</p>
<p>tab_a.xml布局中有个EditText</p>
<p>其他的Fragment大同小异，这里就不贴出代码了</p>
<p>&nbsp;</p>
<p><span>现在来看MainActivity：</span></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('dbc347d7-5a93-47e3-90cc-e45cae3803c7')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_dbc347d7-5a93-47e3-90cc-e45cae3803c7" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.fragmentviewpagertest;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.Fragment;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.FragmentActivity;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.view.ViewPager;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> FragmentActivity {<br></span><span style="color: #008080;">12</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> ViewPager viewPager;<br></span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">public</span> List&lt;Fragment&gt; fragments = <span style="color: #0000ff;">new</span> ArrayList&lt;Fragment&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">14</span>     <span style="color: #0000ff;">public</span> String hello = “hello “<span style="color: #000000;">;<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;">18</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">        setContentView(R.layout.main);<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabAFm());<br></span><span style="color: #008080;">22</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabBFm());<br></span><span style="color: #008080;">23</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabCFm());<br></span><span style="color: #008080;">24</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabDFm());<br></span><span style="color: #008080;">25</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabEFm());<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span>         viewPager =<span style="color: #000000;"> (ViewPager) findViewById(R.id.viewPager);<br></span><span style="color: #008080;">28</span>         FragmentViewPagerAdapter adapter = <span style="color: #0000ff;">new</span> FragmentViewPagerAdapter(<span style="color: #0000ff;">this</span><span style="color: #000000;">.getSupportFragmentManager(), viewPager,fragments);<br></span><span style="color: #008080;">29</span>         adapter.setOnExtraPageChangeListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> FragmentViewPagerAdapter.OnExtraPageChangeListener(){<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">31</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onExtraPageSelected(<span style="color: #0000ff;">int</span><span style="color: #000000;"> i) {<br></span><span style="color: #008080;">32</span>                 System.out.println(“Extra…i: “ +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">35</span><br><span style="color: #008080;">36</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">37</span><br><span style="color: #008080;">38</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>MainActivity上述代码所示</p>
<p>MainActivity是包含Fragment的Activity（也就是这里的5个Fragment）</p>
<p>他继承了FragmentActivity（因为我这里用的是android-support-v4.jar）</p>
<p>用一个List&lt;Fragment&gt;去维护5个Fragment，也就是5个page。</p>
<p>MainActivity的布局很简单，就一个ViewPager，main.xml如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('0e611c66-2fd1-4dc0-9690-f0b0cbcacee6')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_0e611c66-2fd1-4dc0-9690-f0b0cbcacee6" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><br><span style="color: #008080;"> 3</span> <span style="color: #ff0000;">              android:orientation</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">              android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">              android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">android.support.v4.view.ViewPager<br></span><span style="color: #008080;"> 8</span>         <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/viewPager”</span><br><span style="color: #008080;"> 9</span> <span style="color: #ff0000;">        android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">10</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">11</span>         <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>&nbsp;</p>
<p><span>现在回到MainActivity中，下面这个FragmentViewPagerAdapter类是关键，是我自己编写的用于绑定和处理fragments和ViewPager之间的逻辑关系</span></p>
<div class="cnblogs_code"><br><pre>FragmentViewPagerAdapter adapter = <span style="color: #0000ff;">new</span> FragmentViewPagerAdapter(<span style="color: #0000ff;">this</span>.getSupportFragmentManager(), viewPager,fragments);</pre><br></div>

<p>&nbsp;</p>
<p><span>现在看下FragmentViewPagerAdapter：</span></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('f1a422a5-1bf1-44e2-9205-f1cf67fe1843')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_f1a422a5-1bf1-44e2-9205-f1cf67fe1843" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.fragmentviewpagertest;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.Fragment;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.FragmentManager;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.FragmentTransaction;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.view.PagerAdapter;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.view.ViewPager;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.ViewGroup;<br></span><span style="color: #008080;"> 10</span><br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;"> 12</span><br><span style="color: #008080;"> 13</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 14</span> <span style="color: #008000;"> <em> 为ViewPager添加布局（Fragment），绑定和处理fragments和viewpager之间的逻辑关系<br></em></span><span style="color: #008080;"> 15</span> <span style="color: #008000;"> <br></span><span style="color: #008080;"> 16</span> <span style="color: #008000;"> <em> Created with IntelliJ IDEA.<br></em></span><span style="color: #008080;"> 17</span> <span style="color: #008000;">  Author: wangjie  email:tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 18</span> <span style="color: #008000;"> <em> Date: 13-10-11<br></em></span><span style="color: #008080;"> 19</span> <span style="color: #008000;">  Time: 下午3:03<br></span><span style="color: #008080;"> 20</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> FragmentViewPagerAdapter <span style="color: #0000ff;">extends</span> PagerAdapter <span style="color: #0000ff;">implements</span><span style="color: #000000;"> ViewPager.OnPageChangeListener{<br></span><span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">private</span> List&lt;Fragment&gt; fragments; <span style="color: #008000;">//</span><span style="color: #008000;"> 每个Fragment对应一个Page</span><br><span style="color: #008080;"> 23</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> FragmentManager fragmentManager;<br></span><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">private</span> ViewPager viewPager; <span style="color: #008000;">//</span><span style="color: #008000;"> viewPager对象</span><br><span style="color: #008080;"> 25</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> currentPageIndex = 0; <span style="color: #008000;">//</span><span style="color: #008000;"> 当前page索引（切换之前）</span><br><span style="color: #008080;"> 26</span><br><span style="color: #008080;"> 27</span>     <span style="color: #0000ff;">private</span> OnExtraPageChangeListener onExtraPageChangeListener; <span style="color: #008000;">//</span><span style="color: #008000;"> ViewPager切换页面时的额外功能添加接口</span><br><span style="color: #008080;"> 28</span><br><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">public</span> FragmentViewPagerAdapter(FragmentManager fragmentManager, ViewPager viewPager , List&lt;Fragment&gt;<span style="color: #000000;"> fragments) {<br></span><span style="color: #008080;"> 30</span>         <span style="color: #0000ff;">this</span>.fragments =<span style="color: #000000;"> fragments;<br></span><span style="color: #008080;"> 31</span>         <span style="color: #0000ff;">this</span>.fragmentManager =<span style="color: #000000;"> fragmentManager;<br></span><span style="color: #008080;"> 32</span>         <span style="color: #0000ff;">this</span>.viewPager =<span style="color: #000000;"> viewPager;<br></span><span style="color: #008080;"> 33</span>         <span style="color: #0000ff;">this</span>.viewPager.setAdapter(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 34</span>         <span style="color: #0000ff;">this</span>.viewPager.setOnPageChangeListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 35</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 36</span><br><span style="color: #008080;"> 37</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 38</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getCount() {<br></span><span style="color: #008080;"> 39</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> fragments.size();<br></span><span style="color: #008080;"> 40</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 43</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isViewFromObject(View view, Object o) {<br></span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">return</span> view ==<span style="color: #000000;"> o;<br></span><span style="color: #008080;"> 45</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 46</span><br><span style="color: #008080;"> 47</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 48</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> destroyItem(ViewGroup container, <span style="color: #0000ff;">int</span><span style="color: #000000;"> position, Object object) {<br></span><span style="color: #008080;"> 49</span>         container.removeView(fragments.get(position).getView()); <span style="color: #008000;">//</span><span style="color: #008000;"> 移出viewpager两边之外的page布局</span><br><span style="color: #008080;"> 50</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 51</span><br><span style="color: #008080;"> 52</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">public</span> Object instantiateItem(ViewGroup container, <span style="color: #0000ff;">int</span><span style="color: #000000;"> position) {<br></span><span style="color: #008080;"> 54</span>         Fragment fragment =<span style="color: #000000;"> fragments.get(position);<br></span><span style="color: #008080;"> 55</span>         <span style="color: #0000ff;">if</span>(!fragment.isAdded()){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果fragment还没有added</span><br><span style="color: #008080;"> 56</span>             FragmentTransaction ft =<span style="color: #000000;"> fragmentManager.beginTransaction();<br></span><span style="color: #008080;"> 57</span> <span style="color: #000000;">            ft.add(fragment, fragment.getClass().getSimpleName());<br></span><span style="color: #008080;"> 58</span> <span style="color: #000000;">            ft.commit();<br></span><span style="color: #008080;"> 59</span>             <span style="color: #008000;">/</span><br><span style="color: #008080;"> 60</span> <span style="color: #008000;">             <em> 在用FragmentTransaction.commit()方法提交FragmentTransaction对象后<br></em></span><span style="color: #008080;"> 61</span> <span style="color: #008000;">              会在进程的主线程中，用异步的方式来执行。<br></span><span style="color: #008080;"> 62</span> <span style="color: #008000;">             <em> 如果想要立即执行这个等待中的操作，就要调用这个方法（只能在主线程中调用）。<br></em></span><span style="color: #008080;"> 63</span> <span style="color: #008000;">              要注意的是，所有的回调和相关的行为都会在这个调用中被执行完成，因此要仔细确认这个方法的调用位置。<br></span><span style="color: #008080;"> 64</span>              <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 65</span> <span style="color: #000000;">            fragmentManager.executePendingTransactions();<br></span><span style="color: #008080;"> 66</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 67</span><br><span style="color: #008080;"> 68</span>         <span style="color: #0000ff;">if</span>(fragment.getView().getParent() == <span style="color: #0000ff;">null</span><span style="color: #000000;">){<br></span><span style="color: #008080;"> 69</span>             container.addView(fragment.getView()); <span style="color: #008000;">//</span><span style="color: #008000;"> 为viewpager增加布局</span><br><span style="color: #008080;"> 70</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 71</span><br><span style="color: #008080;"> 72</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> fragment.getView();<br></span><span style="color: #008080;"> 73</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 74</span><br><span style="color: #008080;"> 75</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 76</span> <span style="color: #008000;">      当前page索引（切换之前）<br></span><span style="color: #008080;"> 77</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 78</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 79</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getCurrentPageIndex() {<br></span><span style="color: #008080;"> 80</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> currentPageIndex;<br></span><span style="color: #008080;"> 81</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 82</span><br><span style="color: #008080;"> 83</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> OnExtraPageChangeListener getOnExtraPageChangeListener() {<br></span><span style="color: #008080;"> 84</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> onExtraPageChangeListener;<br></span><span style="color: #008080;"> 85</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 86</span><br><span style="color: #008080;"> 87</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 88</span> <span style="color: #008000;">     <em> 设置页面切换额外功能监听器<br></em></span><span style="color: #008080;"> 89</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> onExtraPageChangeListener<br></span><span style="color: #008080;"> 90</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 91</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnExtraPageChangeListener(OnExtraPageChangeListener onExtraPageChangeListener) {<br></span><span style="color: #008080;"> 92</span>         <span style="color: #0000ff;">this</span>.onExtraPageChangeListener =<span style="color: #000000;"> onExtraPageChangeListener;<br></span><span style="color: #008080;"> 93</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 94</span><br><span style="color: #008080;"> 95</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 96</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onPageScrolled(<span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">float</span> v, <span style="color: #0000ff;">int</span><span style="color: #000000;"> i2) {<br></span><span style="color: #008080;"> 97</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> != onExtraPageChangeListener){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了额外功能接口</span><br><span style="color: #008080;"> 98</span> <span style="color: #000000;">            onExtraPageChangeListener.onExtraPageScrolled(i, v, i2);<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">100</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">101</span><br><span style="color: #008080;">102</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">103</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onPageSelected(<span style="color: #0000ff;">int</span><span style="color: #000000;"> i) {<br></span><span style="color: #008080;">104</span>         fragments.get(currentPageIndex).onPause(); <span style="color: #008000;">//</span><span style="color: #008000;"> 调用切换前Fargment的onPause()<br></span><span style="color: #008080;">105</span> <span style="color: #008000;">//</span><span style="color: #008000;">        fragments.get(currentPageIndex).onStop(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> 调用切换前Fargment的onStop()</span><br><span style="color: #008080;">106</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(fragments.get(i).isAdded()){<br></span><span style="color: #008080;">107</span> <span style="color: #008000;">//</span><span style="color: #008000;">            fragments.get(i).onStart(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> 调用切换后Fargment的onStart()</span><br><span style="color: #008080;">108</span>             fragments.get(i).onResume(); <span style="color: #008000;">//</span><span style="color: #008000;"> 调用切换后Fargment的onResume()</span><br><span style="color: #008080;">109</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">110</span>         currentPageIndex =<span style="color: #000000;"> i;<br></span><span style="color: #008080;">111</span><br><span style="color: #008080;">112</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> != onExtraPageChangeListener){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了额外功能接口</span><br><span style="color: #008080;">113</span> <span style="color: #000000;">            onExtraPageChangeListener.onExtraPageSelected(i);<br></span><span style="color: #008080;">114</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">115</span><br><span style="color: #008080;">116</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">117</span><br><span style="color: #008080;">118</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">119</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onPageScrollStateChanged(<span style="color: #0000ff;">int</span><span style="color: #000000;"> i) {<br></span><span style="color: #008080;">120</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> != onExtraPageChangeListener){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了额外功能接口</span><br><span style="color: #008080;">121</span> <span style="color: #000000;">            onExtraPageChangeListener.onExtraPageScrollStateChanged(i);<br></span><span style="color: #008080;">122</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">123</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">124</span><br><span style="color: #008080;">125</span><br><span style="color: #008080;">126</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">127</span> <span style="color: #008000;">     <em> page切换额外功能接口<br></em></span><span style="color: #008080;">128</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">129</span>     <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> OnExtraPageChangeListener{<br></span><span style="color: #008080;">130</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onExtraPageScrolled(<span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">float</span> v, <span style="color: #0000ff;">int</span><span style="color: #000000;"> i2){}<br></span><span style="color: #008080;">131</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onExtraPageSelected(<span style="color: #0000ff;">int</span><span style="color: #000000;"> i){}<br></span><span style="color: #008080;">132</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onExtraPageScrollStateChanged(<span style="color: #0000ff;">int</span><span style="color: #000000;"> i){}<br></span><span style="color: #008080;">133</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">134</span><br><span style="color: #008080;">135</span><br><span style="color: #008080;">136</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p><span>这里解决Fragment切换重新加载布局的办法，用的是把几个Fragment全部Add，然后根据要显示的哪个Fragment就把哪个Fragment的View给添加到&ldquo;ViewGroup container&rdquo;上去。</span></p>
<p><span>效果输出：</span></p>
<p><span>// 以下打开程序后，加载PageA和PageB</span></p>
<p>10-12 09:42:46.671: INFO/System.out(27248): AAAAAAAAAA<strong><strong>onAttach<br>10-12 09:42:46.671: INFO/System.out(27248): AAAAAAAAAA</strong></strong>onCreate<br>10-12 09:42:46.671: INFO/System.out(27248): AAAAAAAAAA<strong><strong>onCreateView<br>10-12 09:42:46.761: INFO/System.out(27248): AAAAAAAAAA</strong></strong>onActivityCreated<br>10-12 09:42:46.765: INFO/System.out(27248): AAAAAAAAAA<strong><strong>onStart<br>10-12 09:42:46.765: INFO/System.out(27248): AAAAAAAAAA</strong></strong>onResume<br>10-12 09:42:46.847: INFO/System.out(27248): BBBBBBBBBBB<strong><strong>onAttach<br>10-12 09:42:46.847: INFO/System.out(27248): BBBBBBBBBBB</strong></strong>onCreate<br>10-12 09:42:46.851: INFO/System.out(27248): BBBBBBBBBBB<strong><strong>onCreateView<br>10-12 09:42:46.867: INFO/System.out(27248): BBBBBBBBBBB</strong></strong>onActivityCreated<br>10-12 09:42:46.867: INFO/System.out(27248): BBBBBBBBBBB<strong><strong>onStart<br>10-12 09:42:46.867: INFO/System.out(27248): BBBBBBBBBBB</strong></strong>onResume</p>
<p>// 以下切换到PageB</p>
<p>10-12 09:42:57.285: INFO/System.out(27248): AAAAAAAAAA<strong><strong>onPause　　　　// 切换到PageB前会调用PageA的onPause()方法<br>10-12 09:42:57.285: INFO/System.out(27248): BBBBBBBBBBB</strong></strong>onResume　　// 切换到PageB后会调用PageB的onResume()方法<br>10-12 09:42:57.285: INFO/System.out(27248): Extra…i: 1　　　　　　　　　　　　// 切换页面时会调用切换额外功能接口（用户可以自己写需要的逻辑）<br>10-12 09:42:57.582: INFO/System.out(27248): CCCCCCCCCC<strong><strong>onAttach　　　　// 切换到PageB后会加载PageC<br>10-12 09:42:57.586: INFO/System.out(27248): CCCCCCCCCC</strong></strong>onCreate<br>10-12 09:42:57.586: INFO/System.out(27248): CCCCCCCCCC<strong><strong>onCreateView<br>10-12 09:42:57.675: INFO/System.out(27248): CCCCCCCCCC</strong></strong>onActivityCreated<br>10-12 09:42:57.675: INFO/System.out(27248): CCCCCCCCCC<strong><strong>onStart<br>10-12 09:42:57.675: INFO/System.out(27248): CCCCCCCCCC</strong></strong>onResume</p>
<p>// 以下切换到PageC</p>
<p>10-12 09:43:18.261: INFO/System.out(27248): BBBBBBBBBBB<strong><strong>onPause&nbsp;　　　　// 切换到PageC前会调用PageB的onPause()方法<br>10-12 09:43:18.261: INFO/System.out(27248): CCCCCCCCCC</strong></strong>onResume　　　　// 切换到PageC后会调用PageC的onResume()方法<br>10-12 09:43:18.261: INFO/System.out(27248): Extra…i: 2　　　　　　　　　　　　　　// 切换页面时会调用切换额外功能接口（用户可以自己写需要的逻辑）<br>10-12 09:43:18.726: INFO/System.out(27248): DDDDDDDDD<strong><strong>onAttach　　　　　　// 切换到PageC后会加载PageD<br>10-12 09:43:18.726: INFO/System.out(27248): DDDDDDDDD</strong></strong>onCreate<br>10-12 09:43:18.726: INFO/System.out(27248): DDDDDDDDD<strong><strong>onCreateView<br>10-12 09:43:18.738: INFO/System.out(27248): DDDDDDDDD</strong></strong>onActivityCreated<br>10-12 09:43:18.738: INFO/System.out(27248): DDDDDDDDD<strong><strong>onStart<br>10-12 09:43:18.742: INFO/System.out(27248): DDDDDDDDD</strong></strong>onResume</p>
<p>// 以下切换到PageB<br>10-12 09:43:20.742: INFO/System.out(27248): CCCCCCCCCC<strong><strong>onPause　　　　　　// 切换到PageB前会调用PageC的onPause()方法<br>10-12 09:43:20.742: INFO/System.out(27248): BBBBBBBBBBB</strong></strong>onResume　　　　//&nbsp;切换到PageB后会调用PageB的onResume()方法<br>10-12 09:43:20.746: INFO/System.out(27248): Extra…i: 1　　　　　　　　　　　　　　// 切换页面时会调用切换额外功能接口（用户可以自己写需要的逻辑）</p>
<p>&nbsp;</p>
<p>好了，到此为止，我们已经用Fragment实现了ViewPager的功能了，同样，下面来看下各个Fragment之间的通信</p>
<p>现在的情况是TabAFm中有个EditText，TabBFm中有个Button，MainActivity中有个变量&ldquo;hello&rdquo;</p>
<p>要做的是，切换到A，输入&ldquo;I’m PageA&rdquo;，切换到B，点击Button后，Toast显示&ldquo;hello I’m PageA&rdquo;</p>
<p>MainActivity中没什么好说的，就一个hello变量：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> String hello = “hello “;</pre><br></div>

<p><span>TabBFm中：</span></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('0e5b4cd8-d376-4ab8-aae2-68446bfeb227')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_0e5b4cd8-d376-4ab8-aae2-68446bfeb227" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">@Override<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onActivityCreated(Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onActivityCreated(savedInstanceState);<br></span><span style="color: #008080;"> 4</span>         System.out.println(“BBBBBBBBBBB____onActivityCreated”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">this</span>.getView().findViewById(R.id.clickme).setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener() {<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 7</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View view) {<br></span><span style="color: #008080;"> 8</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 获得绑定的FragmentActivity</span><br><span style="color: #008080;"> 9</span>                 MainActivity activity =<span style="color: #000000;"> ((MainActivity)getActivity());<br></span><span style="color: #008080;">10</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 获得TabAFm的控件</span><br><span style="color: #008080;">11</span>                 EditText editText = (EditText) activity.fragments.get(0<span style="color: #000000;">).getView().findViewById(R.id.edit);<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span>                 Toast.makeText(activity, activity.hello +<span style="color: #000000;"> editText.getText(), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">16</span>     }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>&nbsp;</p>
<p>最终效果图：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201310/12095728-8961829b190244259fb98e23eb7f59b5.png" alt=""></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong>demo下载：<a href="http://pan.baidu.com/s/1stGQ7" target="_blank" rel="noopener">http://pan.baidu.com/s/1stGQ7</a></strong></span></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> fragment </tag>
            
            <tag> ViewPager </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android使用Fragment来实现TabHost的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信]]></title>
      <url>/2013/10/10/Android%E4%BD%BF%E7%94%A8Fragment%E6%9D%A5%E5%AE%9E%E7%8E%B0TabHost%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%88%E8%A7%A3%E5%86%B3%E5%88%87%E6%8D%A2Fragment%E7%8A%B6%E6%80%81%E4%B8%8D%E4%BF%9D%E5%AD%98%EF%BC%89%E4%BB%A5%E5%8F%8A%E5%90%84%E4%B8%AAFragment%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1/</url>
      <content type="html"><![CDATA[<p><img src="http://images.cnitblog.com/blog/378300/201310/10104944-40b5dbc296894475bdaf8914a59d0498.png" alt=""></p>
<p>如新浪微博下面的标签切换功能，我以前也写过一篇博文（<a href="http://www.cnblogs.com/tiantianbyconan/archive/2012/02/24/2366237.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/archive/2012/02/24/2366237.html</a>），可以实现，用的是TabHost。但是android发展比较迅速，TabHost这玩意现在已经被弃用了，虽说用现在也能用，但是被弃用的东西还是少用为妙。</p>
<p>官方有个FragmentTabHost这么一个替代品，于是试了一下，发现每次切换tab，都会调用<span>onCreateView()方法，控件被重新加载，也就是说你从tab1切换到别的tab后，再切换回来，tab1的状态并没有保存，重新加载了控件。</span></p>
<p><span>搞了半天，暂时没有好的解决办法（有朋友知道解决办法的话，希望联系我，赐教下哈）</span></p>
<p><span style="line-height: 1.5;">于是，怒了，自己实现一个吧- -</span></p>
<p>&nbsp;</p>
<p><span style="line-height: 1.5;">先来看看整个demo的结构：</span></p>
<p><span style="line-height: 1.5;"><img src="http://images.cnitblog.com/blog/378300/201310/10110710-b8f18222f40441d4b46f9ae54fc2c83f.jpg" alt=""></span></p>
<p><span style="line-height: 1.5;">TabAFm到TabEFm都是Fragment，并且每个Fragment对应一个布局文件。</span></p>
<p><span style="line-height: 1.5;">TabAFm.java：</span></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('85262c98-765c-40bc-8095-dbdf4707c217')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_85262c98-765c-40bc-8095-dbdf4707c217" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.fragmenttabhost;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.app.Activity;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.Fragment;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.LayoutInflater;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.ViewGroup;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">11</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;">12</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">13</span> <span style="color: #008000;">  Date: 13-6-14<br></span><span style="color: #008080;">14</span> <span style="color: #008000;"> <em> Time: 下午2:39<br></em></span><span style="color: #008080;">15</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TabAFm <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Fragment{<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">18</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onAttach(Activity activity) {<br></span><span style="color: #008080;">19</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onAttach(activity);<br></span><span style="color: #008080;">20</span>         System.out.println(“AAAAAAAAAA<strong><strong>onAttach”<span style="color: #000000;">);<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">24</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;">25</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;">26</span>         System.out.println(“AAAAAAAAAA</strong></strong>onCreate”<span style="color: #000000;">);<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">30</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {<br></span><span style="color: #008080;">31</span>         System.out.println(“AAAAAAAAAA<strong><strong>onCreateView”<span style="color: #000000;">);<br></span><span style="color: #008080;">32</span>         <span style="color: #0000ff;">return</span> inflater.inflate(R.layout.tab_a, container, <span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">34</span><br><span style="color: #008080;">35</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">36</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onActivityCreated(Bundle savedInstanceState) {<br></span><span style="color: #008080;">37</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onActivityCreated(savedInstanceState);<br></span><span style="color: #008080;">38</span>         System.out.println(“AAAAAAAAAA</strong></strong>onActivityCreated”<span style="color: #000000;">);<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">42</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onStart() {<br></span><span style="color: #008080;">43</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onStart();<br></span><span style="color: #008080;">44</span>         System.out.println(“AAAAAAAAAA<strong><strong>onStart”<span style="color: #000000;">);<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">48</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onResume() {<br></span><span style="color: #008080;">49</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onResume();<br></span><span style="color: #008080;">50</span>         System.out.println(“AAAAAAAAAA</strong></strong>onResume”<span style="color: #000000;">);<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">52</span><br><span style="color: #008080;">53</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">54</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPause() {<br></span><span style="color: #008080;">55</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPause();<br></span><span style="color: #008080;">56</span>         System.out.println(“AAAAAAAAAA<strong><strong>onPause”<span style="color: #000000;">);<br></span><span style="color: #008080;">57</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">58</span><br><span style="color: #008080;">59</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">60</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onStop() {<br></span><span style="color: #008080;">61</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onStop();<br></span><span style="color: #008080;">62</span>         System.out.println(“AAAAAAAAAA</strong></strong>onStop”<span style="color: #000000;">);<br></span><span style="color: #008080;">63</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">64</span><br><span style="color: #008080;">65</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">66</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDestroyView() {<br></span><span style="color: #008080;">67</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDestroyView();<br></span><span style="color: #008080;">68</span>         System.out.println(“AAAAAAAAAA<strong><strong>onDestroyView”<span style="color: #000000;">);<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">70</span><br><span style="color: #008080;">71</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">72</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDestroy() {<br></span><span style="color: #008080;">73</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDestroy();<br></span><span style="color: #008080;">74</span>         System.out.println(“AAAAAAAAAA</strong></strong>onDestroy”<span style="color: #000000;">);<br></span><span style="color: #008080;">75</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">76</span><br><span style="color: #008080;">77</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">78</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDetach() {<br></span><span style="color: #008080;">79</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDetach();<br></span><span style="color: #008080;">80</span>         System.out.println(“AAAAAAAAAA____onDetach”<span style="color: #000000;">);<br></span><span style="color: #008080;">81</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">82</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>如上述代码所示，TabAFm是一个Fragment，对应的布局文件是tab_a.xml，并实现了他的所有的生命周期回调函数并打印，便于调试</p>
<p>tab_a.xml布局中有个EditText</p>
<p>其他的Fragment大同小异，这里就不贴出代码了</p>
<p>&nbsp;</p>
<p>现在来看MainActivity：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('fd8312f8-350d-43e1-95d2-8e9f8c7ec8dc')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_fd8312f8-350d-43e1-95d2-8e9f8c7ec8dc" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.fragmenttabhost;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.Fragment;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.FragmentActivity;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.RadioGroup;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> FragmentActivity {<br></span><span style="color: #008080;">12</span>     <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">13</span> <span style="color: #008000;">      Called when the activity is first created.<br></span><span style="color: #008080;">14</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> RadioGroup rgs;<br></span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">public</span> List&lt;Fragment&gt; fragments = <span style="color: #0000ff;">new</span> ArrayList&lt;Fragment&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">public</span> String hello = “hello “<span style="color: #000000;">;<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">        setContentView(R.layout.main);<br></span><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabAFm());<br></span><span style="color: #008080;">26</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabBFm());<br></span><span style="color: #008080;">27</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabCFm());<br></span><span style="color: #008080;">28</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabDFm());<br></span><span style="color: #008080;">29</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabEFm());<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span><br><span style="color: #008080;">32</span>         rgs =<span style="color: #000000;"> (RadioGroup) findViewById(R.id.tabs_rg);<br></span><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span>         FragmentTabAdapter tabAdapter = <span style="color: #0000ff;">new</span> FragmentTabAdapter(<span style="color: #0000ff;">this</span><span style="color: #000000;">, fragments, R.id.tab_content, rgs);<br></span><span style="color: #008080;">35</span>         tabAdapter.setOnRgsExtraCheckedChangedListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> FragmentTabAdapter.OnRgsExtraCheckedChangedListener(){<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">37</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> OnRgsExtraCheckedChanged(RadioGroup radioGroup, <span style="color: #0000ff;">int</span> checkedId, <span style="color: #0000ff;">int</span><span style="color: #000000;"> index) {<br></span><span style="color: #008080;">38</span>                 System.out.println(“Extra—- “ + index + “ checked!!! “<span style="color: #000000;">);<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">41</span><br><span style="color: #008080;">42</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">43</span><br><span style="color: #008080;">44</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>MainActivity上述代码所示</p>
<p>MainActivity是包含Fragment的Activity（也就是这里的5个Fragment）</p>
<p>他继承了FragmentActivity（因为我这里用的是android-support-v4.jar）</p>
<p>用一个List&lt;Fragment&gt;去维护5个Fragment，也就是5个tab</p>
<p>main布局中有一个id为tab_content的FrameLayout，用来存放要显示的Fragment。底部有一个RadioGroup，用于tab的切换，如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('1616a5c6-aec1-4ccd-98f6-7d115ad2bef5')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_1616a5c6-aec1-4ccd-98f6-7d115ad2bef5" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;">  2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><br><span style="color: #008080;">  3</span> <span style="color: #ff0000;">              android:orientation</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;">  4</span> <span style="color: #ff0000;">              android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">  5</span> <span style="color: #ff0000;">              android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">  6</span> <span style="color: #ff0000;">              android:background</span><span style="color: #0000ff;">=”@android:color/white”</span><br><span style="color: #008080;">  7</span>         <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">  8</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout<br></span><span style="color: #008080;">  9</span>             <span style="color: #ff0000;">android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 10</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 11</span> <span style="color: #ff0000;">            android:orientation</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;"> 12</span>         <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 13</span><br><span style="color: #008080;"> 14</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">FrameLayout<br></span><span style="color: #008080;"> 15</span>             <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tab_content”</span><br><span style="color: #008080;"> 16</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 17</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”0dp”</span><br><span style="color: #008080;"> 18</span> <span style="color: #ff0000;">            android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span><br><span style="color: #008080;"> 19</span> <span style="color: #ff0000;">            android:background</span><span style="color: #0000ff;">=”#77557799”</span><br><span style="color: #008080;"> 20</span>             <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 21</span><br><span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioGroup<br></span><span style="color: #008080;"> 23</span>             <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tabs_rg”</span><br><span style="color: #008080;"> 24</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 25</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 26</span> <span style="color: #ff0000;">            android:orientation</span><span style="color: #0000ff;">=”horizontal”</span><br><span style="color: #008080;"> 27</span> <span style="color: #ff0000;">            android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;"> 28</span> <span style="color: #ff0000;">            android:paddingTop</span><span style="color: #0000ff;">=”7dp”</span><br><span style="color: #008080;"> 29</span> <span style="color: #ff0000;">            android:paddingBottom</span><span style="color: #0000ff;">=”7dp”</span><br><span style="color: #008080;"> 30</span>             <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 31</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;"> 32</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tab_rb_a”</span><br><span style="color: #008080;"> 33</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”0dp”</span><br><span style="color: #008080;"> 34</span> <span style="color: #ff0000;">                android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 35</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tablatestalert”</span><br><span style="color: #008080;"> 36</span> <span style="color: #ff0000;">                android:button</span><span style="color: #0000ff;">=”@null”</span><br><span style="color: #008080;"> 37</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”Tab1”</span><br><span style="color: #008080;"> 38</span> <span style="color: #ff0000;">                android:textColor</span><span style="color: #0000ff;">=”#000000”</span><br><span style="color: #008080;"> 39</span> <span style="color: #ff0000;">                android:textSize</span><span style="color: #0000ff;">=”13sp”</span><br><span style="color: #008080;"> 40</span> <span style="color: #ff0000;">                android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span><br><span style="color: #008080;"> 41</span> <span style="color: #ff0000;">                android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;"> 42</span> <span style="color: #ff0000;">                android:singleLine</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;"> 43</span> <span style="color: #ff0000;">                android:checked</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;"> 44</span> <span style="color: #ff0000;">                android:background</span><span style="color: #0000ff;">=”@drawable/selector_tab”</span><br><span style="color: #008080;"> 45</span>                 <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;"> 47</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tab_rb_b”</span><br><span style="color: #008080;"> 48</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”0dp”</span><br><span style="color: #008080;"> 49</span> <span style="color: #ff0000;">                android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 50</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tabsearch”</span><br><span style="color: #008080;"> 51</span> <span style="color: #ff0000;">                android:button</span><span style="color: #0000ff;">=”@null”</span><br><span style="color: #008080;"> 52</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”Tab2”</span><br><span style="color: #008080;"> 53</span> <span style="color: #ff0000;">                android:textColor</span><span style="color: #0000ff;">=”#000000”</span><br><span style="color: #008080;"> 54</span> <span style="color: #ff0000;">                android:textSize</span><span style="color: #0000ff;">=”13sp”</span><br><span style="color: #008080;"> 55</span> <span style="color: #ff0000;">                android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span><br><span style="color: #008080;"> 56</span> <span style="color: #ff0000;">                android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;"> 57</span> <span style="color: #ff0000;">                android:singleLine</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;"> 58</span> <span style="color: #ff0000;">                android:background</span><span style="color: #0000ff;">=”@drawable/selector_tab”</span><br><span style="color: #008080;"> 59</span>                 <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 60</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;"> 61</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tab_rb_c”</span><br><span style="color: #008080;"> 62</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”0dp”</span><br><span style="color: #008080;"> 63</span> <span style="color: #ff0000;">                android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 64</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tabrecommd”</span><br><span style="color: #008080;"> 65</span> <span style="color: #ff0000;">                android:button</span><span style="color: #0000ff;">=”@null”</span><br><span style="color: #008080;"> 66</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”Tab3”</span><br><span style="color: #008080;"> 67</span> <span style="color: #ff0000;">                android:textColor</span><span style="color: #0000ff;">=”#000000”</span><br><span style="color: #008080;"> 68</span> <span style="color: #ff0000;">                android:textSize</span><span style="color: #0000ff;">=”13sp”</span><br><span style="color: #008080;"> 69</span> <span style="color: #ff0000;">                android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span><br><span style="color: #008080;"> 70</span> <span style="color: #ff0000;">                android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;"> 71</span> <span style="color: #ff0000;">                android:singleLine</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;"> 72</span> <span style="color: #ff0000;">                android:background</span><span style="color: #0000ff;">=”@drawable/selector_tab”</span><br><span style="color: #008080;"> 73</span>                 <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 74</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;"> 75</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tab_rb_d”</span><br><span style="color: #008080;"> 76</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”0dp”</span><br><span style="color: #008080;"> 77</span> <span style="color: #ff0000;">                android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 78</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tabconfigicon”</span><br><span style="color: #008080;"> 79</span> <span style="color: #ff0000;">                android:button</span><span style="color: #0000ff;">=”@null”</span><br><span style="color: #008080;"> 80</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”Tab4”</span><br><span style="color: #008080;"> 81</span> <span style="color: #ff0000;">                android:textColor</span><span style="color: #0000ff;">=”#000000”</span><br><span style="color: #008080;"> 82</span> <span style="color: #ff0000;">                android:textSize</span><span style="color: #0000ff;">=”13sp”</span><br><span style="color: #008080;"> 83</span> <span style="color: #ff0000;">                android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span><br><span style="color: #008080;"> 84</span> <span style="color: #ff0000;">                android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;"> 85</span> <span style="color: #ff0000;">                android:singleLine</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;"> 86</span> <span style="color: #ff0000;">                android:background</span><span style="color: #0000ff;">=”@drawable/selector_tab”</span><br><span style="color: #008080;"> 87</span>                 <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 88</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;"> 89</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tab_rb_e”</span><br><span style="color: #008080;"> 90</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”0dp”</span><br><span style="color: #008080;"> 91</span> <span style="color: #ff0000;">                android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 92</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tababoutus”</span><br><span style="color: #008080;"> 93</span> <span style="color: #ff0000;">                android:button</span><span style="color: #0000ff;">=”@null”</span><br><span style="color: #008080;"> 94</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”Tab5”</span><br><span style="color: #008080;"> 95</span> <span style="color: #ff0000;">                android:textColor</span><span style="color: #0000ff;">=”#000000”</span><br><span style="color: #008080;"> 96</span> <span style="color: #ff0000;">                android:textSize</span><span style="color: #0000ff;">=”13sp”</span><br><span style="color: #008080;"> 97</span> <span style="color: #ff0000;">                android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span><br><span style="color: #008080;"> 98</span> <span style="color: #ff0000;">                android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;"> 99</span> <span style="color: #ff0000;">                android:singleLine</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;">100</span> <span style="color: #ff0000;">                android:background</span><span style="color: #0000ff;">=”@drawable/selector_tab”</span><br><span style="color: #008080;">101</span>                 <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">102</span><br><span style="color: #008080;">103</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">RadioGroup</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">104</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">105</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>现在回到MainActivity中，下面这个FragmentTabAdapter类是关键，是我自己编写的用于绑定和处理fragments和RadioGroup之间的逻辑关系</p>
<div class="cnblogs_code"><br><pre>FragmentTabAdapter tabAdapter = <span style="color: #0000ff;">new</span> FragmentTabAdapter(<span style="color: #0000ff;">this</span>, fragments, R.id.tab_content, rgs);</pre><br></div>

<p>&nbsp;</p>
<p>现在看下FragmentTabAdapter：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('1827caab-5f05-4ffc-9974-0616b027aa79')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_1827caab-5f05-4ffc-9974-0616b027aa79" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.fragmenttabhost;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.Fragment;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.FragmentActivity;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.FragmentTransaction;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.RadioGroup;<br></span><span style="color: #008080;">  7</span><br><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;">  9</span><br><span style="color: #008080;"> 10</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 11</span> <span style="color: #008000;"> <em> Created with IntelliJ IDEA.<br></em></span><span style="color: #008080;"> 12</span> <span style="color: #008000;">  Author: wangjie  email:tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 13</span> <span style="color: #008000;"> <em> Date: 13-10-10<br></em></span><span style="color: #008080;"> 14</span> <span style="color: #008000;">  Time: 上午9:25<br></span><span style="color: #008080;"> 15</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> FragmentTabAdapter <span style="color: #0000ff;">implements</span><span style="color: #000000;"> RadioGroup.OnCheckedChangeListener{<br></span><span style="color: #008080;"> 17</span>     <span style="color: #0000ff;">private</span> List&lt;Fragment&gt; fragments; <span style="color: #008000;">//</span><span style="color: #008000;"> 一个tab页面对应一个Fragment</span><br><span style="color: #008080;"> 18</span>     <span style="color: #0000ff;">private</span> RadioGroup rgs; <span style="color: #008000;">//</span><span style="color: #008000;"> 用于切换tab</span><br><span style="color: #008080;"> 19</span>     <span style="color: #0000ff;">private</span> FragmentActivity fragmentActivity; <span style="color: #008000;">//</span><span style="color: #008000;"> Fragment所属的Activity</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> fragmentContentId; <span style="color: #008000;">//</span><span style="color: #008000;"> Activity中所要被替换的区域的id</span><br><span style="color: #008080;"> 21</span><br><span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> currentTab; <span style="color: #008000;">//</span><span style="color: #008000;"> 当前Tab页面索引</span><br><span style="color: #008080;"> 23</span><br><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">private</span> OnRgsExtraCheckedChangedListener onRgsExtraCheckedChangedListener; <span style="color: #008000;">//</span><span style="color: #008000;"> 用于让调用者在切换tab时候增加新的功能</span><br><span style="color: #008080;"> 25</span><br><span style="color: #008080;"> 26</span>     <span style="color: #0000ff;">public</span> FragmentTabAdapter(FragmentActivity fragmentActivity, List&lt;Fragment&gt; fragments, <span style="color: #0000ff;">int</span><span style="color: #000000;"> fragmentContentId, RadioGroup rgs) {<br></span><span style="color: #008080;"> 27</span>         <span style="color: #0000ff;">this</span>.fragments =<span style="color: #000000;"> fragments;<br></span><span style="color: #008080;"> 28</span>         <span style="color: #0000ff;">this</span>.rgs =<span style="color: #000000;"> rgs;<br></span><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">this</span>.fragmentActivity =<span style="color: #000000;"> fragmentActivity;<br></span><span style="color: #008080;"> 30</span>         <span style="color: #0000ff;">this</span>.fragmentContentId =<span style="color: #000000;"> fragmentContentId;<br></span><span style="color: #008080;"> 31</span><br><span style="color: #008080;"> 32</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 默认显示第一页</span><br><span style="color: #008080;"> 33</span>         FragmentTransaction ft =<span style="color: #000000;"> fragmentActivity.getSupportFragmentManager().beginTransaction();<br></span><span style="color: #008080;"> 34</span>         ft.add(fragmentContentId, fragments.get(0<span style="color: #000000;">));<br></span><span style="color: #008080;"> 35</span> <span style="color: #000000;">        ft.commit();<br></span><span style="color: #008080;"> 36</span><br><span style="color: #008080;"> 37</span>         rgs.setOnCheckedChangeListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 38</span><br><span style="color: #008080;"> 39</span><br><span style="color: #008080;"> 40</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 43</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCheckedChanged(RadioGroup radioGroup, <span style="color: #0000ff;">int</span><span style="color: #000000;"> checkedId) {<br></span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; rgs.getChildCount(); i++<span style="color: #000000;">){<br></span><span style="color: #008080;"> 45</span>             <span style="color: #0000ff;">if</span>(rgs.getChildAt(i).getId() ==<span style="color: #000000;"> checkedId){<br></span><span style="color: #008080;"> 46</span>                 Fragment fragment =<span style="color: #000000;"> fragments.get(i);<br></span><span style="color: #008080;"> 47</span>                 FragmentTransaction ft =<span style="color: #000000;"> obtainFragmentTransaction(i);<br></span><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span>                 getCurrentFragment().onPause(); <span style="color: #008000;">//</span><span style="color: #008000;"> 暂停当前tab<br></span><span style="color: #008080;"> 50</span> <span style="color: #008000;">//</span><span style="color: #008000;">                getCurrentFragment().onStop(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> 暂停当前tab</span><br><span style="color: #008080;"> 51</span><br><span style="color: #008080;"> 52</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;">(fragment.isAdded()){<br></span><span style="color: #008080;"> 53</span> <span style="color: #008000;">//</span><span style="color: #008000;">                    fragment.onStart(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> 启动目标tab的onStart()</span><br><span style="color: #008080;"> 54</span>                     fragment.onResume(); <span style="color: #008000;">//</span><span style="color: #008000;"> 启动目标tab的onResume()</span><br><span style="color: #008080;"> 55</span>                 }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">                    ft.add(fragmentContentId, fragment);<br></span><span style="color: #008080;"> 57</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 58</span>                 showTab(i); <span style="color: #008000;">//</span><span style="color: #008000;"> 显示目标tab</span><br><span style="color: #008080;"> 59</span> <span style="color: #000000;">                ft.commit();<br></span><span style="color: #008080;"> 60</span><br><span style="color: #008080;"> 61</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了切换tab额外功能功能接口</span><br><span style="color: #008080;"> 62</span>                 <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> onRgsExtraCheckedChangedListener){<br></span><span style="color: #008080;"> 63</span> <span style="color: #000000;">                    onRgsExtraCheckedChangedListener.OnRgsExtraCheckedChanged(radioGroup, checkedId, i);<br></span><span style="color: #008080;"> 64</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 65</span><br><span style="color: #008080;"> 66</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 68</span><br><span style="color: #008080;"> 69</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 70</span><br><span style="color: #008080;"> 71</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 72</span> <span style="color: #008000;">     <em> 切换tab<br></em></span><span style="color: #008080;"> 73</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> idx<br></span><span style="color: #008080;"> 74</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 75</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> showTab(<span style="color: #0000ff;">int</span><span style="color: #000000;"> idx){<br></span><span style="color: #008080;"> 76</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; fragments.size(); i++<span style="color: #000000;">){<br></span><span style="color: #008080;"> 77</span>             Fragment fragment =<span style="color: #000000;"> fragments.get(i);<br></span><span style="color: #008080;"> 78</span>             FragmentTransaction ft =<span style="color: #000000;"> obtainFragmentTransaction(idx);<br></span><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span>             <span style="color: #0000ff;">if</span>(idx ==<span style="color: #000000;"> i){<br></span><span style="color: #008080;"> 81</span> <span style="color: #000000;">                ft.show(fragment);<br></span><span style="color: #008080;"> 82</span>             }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 83</span> <span style="color: #000000;">                ft.hide(fragment);<br></span><span style="color: #008080;"> 84</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 85</span> <span style="color: #000000;">            ft.commit();<br></span><span style="color: #008080;"> 86</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 87</span>         currentTab = idx; <span style="color: #008000;">//</span><span style="color: #008000;"> 更新目标tab为当前tab</span><br><span style="color: #008080;"> 88</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 89</span><br><span style="color: #008080;"> 90</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 91</span> <span style="color: #008000;">      获取一个带动画的FragmentTransaction<br></span><span style="color: #008080;"> 92</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> index<br></span><span style="color: #008080;"> 93</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 94</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 95</span>     <span style="color: #0000ff;">private</span> FragmentTransaction obtainFragmentTransaction(<span style="color: #0000ff;">int</span><span style="color: #000000;"> index){<br></span><span style="color: #008080;"> 96</span>         FragmentTransaction ft =<span style="color: #000000;"> fragmentActivity.getSupportFragmentManager().beginTransaction();<br></span><span style="color: #008080;"> 97</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置切换动画</span><br><span style="color: #008080;"> 98</span>         <span style="color: #0000ff;">if</span>(index &gt;<span style="color: #000000;"> currentTab){<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">            ft.setCustomAnimations(R.anim.slide_left_in, R.anim.slide_left_out);<br></span><span style="color: #008080;">100</span>         }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;">101</span> <span style="color: #000000;">            ft.setCustomAnimations(R.anim.slide_right_in, R.anim.slide_right_out);<br></span><span style="color: #008080;">102</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">103</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> ft;<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">105</span><br><span style="color: #008080;">106</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getCurrentTab() {<br></span><span style="color: #008080;">107</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> currentTab;<br></span><span style="color: #008080;">108</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">109</span><br><span style="color: #008080;">110</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Fragment getCurrentFragment(){<br></span><span style="color: #008080;">111</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> fragments.get(currentTab);<br></span><span style="color: #008080;">112</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">113</span><br><span style="color: #008080;">114</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> OnRgsExtraCheckedChangedListener getOnRgsExtraCheckedChangedListener() {<br></span><span style="color: #008080;">115</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> onRgsExtraCheckedChangedListener;<br></span><span style="color: #008080;">116</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">117</span><br><span style="color: #008080;">118</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnRgsExtraCheckedChangedListener(OnRgsExtraCheckedChangedListener onRgsExtraCheckedChangedListener) {<br></span><span style="color: #008080;">119</span>         <span style="color: #0000ff;">this</span>.onRgsExtraCheckedChangedListener =<span style="color: #000000;"> onRgsExtraCheckedChangedListener;<br></span><span style="color: #008080;">120</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">121</span><br><span style="color: #008080;">122</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">123</span> <span style="color: #008000;">       切换tab额外功能功能接口<br></span><span style="color: #008080;">124</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">125</span>     <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> OnRgsExtraCheckedChangedListener{<br></span><span style="color: #008080;">126</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> OnRgsExtraCheckedChanged(RadioGroup radioGroup, <span style="color: #0000ff;">int</span> checkedId, <span style="color: #0000ff;">int</span><span style="color: #000000;"> index){<br></span><span style="color: #008080;">127</span><br><span style="color: #008080;">128</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">129</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">130</span><br><span style="color: #008080;">131</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>这里解决Fragment切换重新加载布局的办法，用的是把几个Fragment全部Add，然后根据要显示的哪个Fragment设置show或者hide</p>
<p>效果输出：</p>
<p>10-10 11:55:41.168: INFO/System.out(18368): AAAAAAAAAA<strong><strong>onAttach　　　　　　<span style="color: #0000ff;">// 第一次进入，显示TabA</span><br>10-10 11:55:41.168: INFO/System.out(18368): AAAAAAAAAA</strong></strong>onCreate<br>10-10 11:55:41.168: INFO/System.out(18368): AAAAAAAAAA<strong><strong>onCreateView<br>10-10 11:55:41.175: INFO/System.out(18368): AAAAAAAAAA</strong></strong>onActivityCreated<br>10-10 11:55:41.179: INFO/System.out(18368): AAAAAAAAAA<strong><strong>onStart<br>10-10 11:55:41.179: INFO/System.out(18368): AAAAAAAAAA</strong></strong>onResume<br>10-10 11:55:44.980: INFO/System.out(18368): AAAAAAAAAA<strong><strong>onPause　　　　　　<span style="color: #0000ff;">// 从TabA切换到TabB（TabA调用onPause）</span><br>10-10 11:55:44.980: INFO/System.out(18368): Extra—- 1 checked!!!<br>10-10 11:55:44.996: INFO/System.out(18368): BBBBBBBBBBB</strong></strong>onAttach<br>10-10 11:55:44.996: INFO/System.out(18368): BBBBBBBBBBB<strong><strong>onCreate<br>10-10 11:55:44.996: INFO/System.out(18368): BBBBBBBBBBB</strong></strong>onCreateView<br>10-10 11:55:45.004: INFO/System.out(18368): BBBBBBBBBBB<strong><strong>onActivityCreated<br>10-10 11:55:45.004: INFO/System.out(18368): BBBBBBBBBBB</strong></strong>onStart<br>10-10 11:55:45.004: INFO/System.out(18368): BBBBBBBBBBB<strong><strong>onResume<br>10-10 11:55:52.062: INFO/System.out(18368): BBBBBBBBBBB</strong></strong>onPause　　　　　　<span style="color: #0000ff;">// 从TabB切换到TabC（TabB调用onPause）</span><br>10-10 11:55:52.062: INFO/System.out(18368): Extra—- 2 checked!!!<br>10-10 11:55:52.082: INFO/System.out(18368): CCCCCCCCCC<strong><strong>onAttach<br>10-10 11:55:52.082: INFO/System.out(18368): CCCCCCCCCC</strong></strong>onCreate<br>10-10 11:55:52.086: INFO/System.out(18368): CCCCCCCCCC<strong><strong>onCreateView<br>10-10 11:55:52.090: INFO/System.out(18368): CCCCCCCCCC</strong></strong>onActivityCreated<br>10-10 11:55:52.090: INFO/System.out(18368): CCCCCCCCCC<strong><strong>onStart<br>10-10 11:55:52.090: INFO/System.out(18368): CCCCCCCCCC</strong></strong>onResume<br>10-10 11:56:06.535: INFO/System.out(18368): CCCCCCCCCC<strong><strong>onPause　　　　　　<span style="color: #0000ff;">// 从TabC切换到TabB（TabC调用onPause）</span><br>10-10 11:56:06.535: INFO/System.out(18368): BBBBBBBBBBB</strong></strong>onResume　　　　<span style="color: #0000ff;">//&nbsp;从TabC切换到TabB（TabB调用onResume）</span><br>10-10 11:56:06.535: INFO/System.out(18368): Extra—- 1 checked!!!</p>
<p>&nbsp;</p>
<p>好了，到此为止，我们已经用Fragment实现了类似TabHost的功能了，下面来看下各个Fragment之间的通信</p>
<p>现在的情况是TabAFm中有个EditText，TabBFm中有个Button，MainActivity中有个变量&ldquo;hello&rdquo;</p>
<p>要做的是，切换到TabA，输入&ldquo;I’m TabA&rdquo;，切换到B，点击Button后，Toast显示&ldquo;hello I’m TabA&rdquo;</p>
<p>MainActivity中没什么好说的，就一个hello变量：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> String hello = “hello “;</pre><br></div>

<p>TabAFm在布局文件tab_a.xml中加个EditText，设置个id就可以了</p>
<p>TabBFm中：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('584d6f2a-4f17-4bc3-b261-291e61788031')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_584d6f2a-4f17-4bc3-b261-291e61788031" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">@Override<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onActivityCreated(Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onActivityCreated(savedInstanceState);<br></span><span style="color: #008080;"> 4</span>         System.out.println(“BBBBBBBBBBB____onActivityCreated”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">this</span>.getView().findViewById(R.id.clickme).setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener() {<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 7</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View view) {<br></span><span style="color: #008080;"> 8</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 获得绑定的FragmentActivity</span><br><span style="color: #008080;"> 9</span>                 MainActivity activity =<span style="color: #000000;"> ((MainActivity)getActivity());<br></span><span style="color: #008080;">10</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 获得TabAFm的控件</span><br><span style="color: #008080;">11</span>                 EditText editText = (EditText) activity.fragments.get(0<span style="color: #000000;">).getView().findViewById(R.id.edit);<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span>                 Toast.makeText(activity, activity.hello +<span style="color: #000000;"> editText.getText(), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">16</span>     }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div><br><div class="cnblogs_code"><br><pre><span style="color: #008000;">//</span><span style="color: #008000;"> 获得绑定的FragmentActivity</span><br>MainActivity activity = ((MainActivity)getActivity());</pre><br></div>

<p>通过getActivity()即可得到Fragment所在的FragmentActivity</p>
<p>&nbsp;</p>
<p>最终效果图：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201310/10114324-42b27a496916463e91d7400c5c3d1884.png" alt=""></p>
<p><span style="color: #ff0000;"><strong>demo下载地址：<a href="http://pan.baidu.com/s/1wxsIX" target="_blank" rel="noopener"><span style="color: #ff0000;">http://pan.baidu.com/s/1wxsIX</span></a></strong></span></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> fragment </tag>
            
            <tag> TabHost </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Hibernate3注解[转]]]></title>
      <url>/2013/10/08/Hibernate3%E6%B3%A8%E8%A7%A3-%E8%BD%AC/</url>
      <content type="html"><![CDATA[<p>&nbsp;Hibernate3注解 收藏&nbsp;<br>1、@Entity(name=”EntityName”)&nbsp;<br>必须,name为可选,对应数据库中一的个表</p>
<p>2、@Table(name=””,catalog=””,schema=””)&nbsp;<br>可选,通常和@Entity配合使用,只能标注在实体的class定义处,表示实体对应的数据库表的信息&nbsp;<br>name:可选,表示表的名称.默认地,表名和实体名称一致,只有在不一致的情况下才需要指定表名&nbsp;<br>catalog:可选,表示Catalog名称,默认为Catalog(“”).&nbsp;<br>schema:可选,表示Schema名称,默认为Schema(“”).</p>
<p>3、@id&nbsp;<br>必须&nbsp;<br>@id定义了映射到数据库表的主键的属性,一个实体只能有一个属性被映射为主键.置于getXxxx()前.</p>
<p>4、@GeneratedValue(strategy=GenerationType,generator=””)&nbsp;<br>可选&nbsp;<br>strategy:表示主键生成策略,有AUTO,INDENTITY,SEQUENCE 和 TABLE 4种,分别表示让ORM框架自动选择,&nbsp;<br>根据数据库的Identity字段生成,根据数据库表的Sequence字段生成,以有根据一个额外的表生成主键,默认为AUTO&nbsp;<br>generator:表示主键生成器的名称,这个属性通常和ORM框架相关,例如,Hibernate可以指定uuid等主键生成方式.&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @Id&nbsp;<br>&nbsp;&nbsp;&nbsp; @GeneratedValues(strategy=StrategyType.SEQUENCE)&nbsp;<br>&nbsp;&nbsp;&nbsp; public int getPk() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return pk;&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>5、@Basic(fetch=FetchType,optional=true)&nbsp;<br>可选&nbsp;<br>@Basic表示一个简单的属性到数据库表的字段的映射,对于没有任何标注的getXxxx()方法,默认即为@Basic&nbsp;<br>fetch: 表示该属性的读取策略,有EAGER和LAZY两种,分别表示主支抓取和延迟加载,默认为EAGER.&nbsp;<br>optional:表示该属性是否允许为null,默认为true&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @Basic(optional=false)&nbsp;<br>&nbsp;&nbsp;&nbsp; public String getAddress() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return address;&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>6、@Column&nbsp;<br>可选&nbsp;<br>@Column描述了数据库表中该字段的详细定义,这对于根据JPA注解生成数据库表结构的工具非常有作用.&nbsp;<br>name:表示数据库表中该字段的名称,默认情形属性名称一致&nbsp;<br>nullable:表示该字段是否允许为null,默认为true&nbsp;<br>unique:表示该字段是否是唯一标识,默认为false&nbsp;<br>length:表示该字段的大小,仅对String类型的字段有效&nbsp;<br>insertable:表示在ORM框架执行插入操作时,该字段是否应出现INSETRT语句中,默认为true&nbsp;<br>updateable:表示在ORM框架执行更新操作时,该字段是否应该出现在UPDATE语句中,默认为true.对于一经创建就不可以更改的字段,该属性非常有用,如对于birthday字段.&nbsp;<br>columnDefinition:表示该字段在数据库中的实际类型.通常ORM框架可以根据属性类型自动判断数据库中字段的类型,但是对于Date类型仍无法确定数据库中字段类型究竟是DATE,TIME还是TIMESTAMP.此外,String的默认映射类型为VARCHAR,如果要将String类型映射到特定数据库的BLOB或TEXT字段类型,该属性非常有用.&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @Column(name=”BIRTH”,nullable=”false”,columnDefinition=”DATE”)&nbsp;<br>&nbsp;&nbsp;&nbsp; public String getBithday() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return birthday;&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>7、@Transient&nbsp;<br>可选&nbsp;<br>@Transient表示该属性并非一个到数据库表的字段的映射,ORM框架将忽略该属性.&nbsp;<br>如果一个属性并非数据库表的字段映射,就务必将其标示为@Transient,否则,ORM框架默认其注解为@Basic&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; //根据birth计算出age属性&nbsp;<br>&nbsp;&nbsp;&nbsp; @Transient&nbsp;<br>&nbsp;&nbsp;&nbsp; public int getAge() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return getYear(new Date()) - getYear(birth);&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>8、@ManyToOne(fetch=FetchType,cascade=CascadeType)&nbsp;<br>可选&nbsp;<br>@ManyToOne表示一个多对一的映射,该注解标注的属性通常是数据库表的外键&nbsp;<br>optional:是否允许该字段为null,该属性应该根据数据库表的外键约束来确定,默认为true&nbsp;<br>fetch:表示抓取策略,默认为FetchType.EAGER&nbsp;<br>cascade:表示默认的级联操作策略,可以指定为ALL,PERSIST,MERGE,REFRESH和REMOVE中的若干组合,默认为无级联操作&nbsp;<br>targetEntity:表示该属性关联的实体类型.该属性通常不必指定,ORM框架根据属性类型自动判断targetEntity.&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; //订单Order和用户User是一个ManyToOne的关系&nbsp;<br>&nbsp;&nbsp;&nbsp; //在Order类中定义&nbsp;<br>&nbsp;&nbsp;&nbsp; @ManyToOne()&nbsp;<br>&nbsp;&nbsp;&nbsp; @JoinColumn(name=”USER”)&nbsp;<br>&nbsp;&nbsp;&nbsp; public User getUser() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return user;&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>9、@JoinColumn&nbsp;<br>可选&nbsp;<br>@JoinColumn和@Column类似,介量描述的不是一个简单字段,而一一个关联字段,例如.描述一个@ManyToOne的字段.&nbsp;<br>name:该字段的名称.由于@JoinColumn描述的是一个关联字段,如ManyToOne,则默认的名称由其关联的实体决定.&nbsp;<br>例如,实体Order有一个user属性来关联实体User,则Order的user属性为一个外键,&nbsp;<br>其默认的名称为实体User的名称+下划线+实体User的主键名称&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; 见@ManyToOne</p>
<p>10、@OneToMany(fetch=FetchType,cascade=CascadeType)&nbsp;<br>可选&nbsp;<br>@OneToMany描述一个一对多的关联,该属性应该为集体类型,在数据库中并没有实际字段.&nbsp;<br>fetch:表示抓取策略,默认为FetchType.LAZY,因为关联的多个对象通常不必从数据库预先读取到内存&nbsp;<br>cascade:表示级联操作策略,对于OneToMany类型的关联非常重要,通常该实体更新或删除时,其关联的实体也应当被更新或删除&nbsp;<br>例如:实体User和Order是OneToMany的关系,则实体User被删除时,其关联的实体Order也应该被全部删除&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @OneTyMany(cascade=ALL)&nbsp;<br>&nbsp;&nbsp;&nbsp; public List getOrders() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return orders;&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>11、@OneToOne(fetch=FetchType,cascade=CascadeType)&nbsp;<br>可选&nbsp;<br>@OneToOne描述一个一对一的关联&nbsp;<br>fetch:表示抓取策略,默认为FetchType.LAZY&nbsp;<br>cascade:表示级联操作策略&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @OneToOne(fetch=FetchType.LAZY)&nbsp;<br>&nbsp;&nbsp;&nbsp; public Blog getBlog() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return blog;&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>12、@ManyToMany&nbsp;<br>可选&nbsp;<br>@ManyToMany 描述一个多对多的关联.多对多关联上是两个一对多关联,但是在ManyToMany描述中,中间表是由ORM框架自动处理&nbsp;<br>targetEntity:表示多对多关联的另一个实体类的全名,例如:package.Book.class&nbsp;<br>mappedBy:表示多对多关联的另一个实体类的对应集合属性名称&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; User实体表示用户,Book实体表示书籍,为了描述用户收藏的书籍,可以在User和Book之间建立ManyToMany关联&nbsp;<br>&nbsp;&nbsp;&nbsp; @Entity&nbsp;<br>&nbsp;&nbsp;&nbsp; public class User {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private List books;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @ManyToMany(targetEntity=package.Book.class)&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public List getBooks() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return books;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void setBooks(List books) {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.books=books;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; @Entity&nbsp;<br>&nbsp;&nbsp;&nbsp; public class Book {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private List users;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @ManyToMany(targetEntity=package.Users.class, mappedBy=”books”)&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public List getUsers() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return users;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void setUsers(List users) {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.users=users;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp; }&nbsp;<br>两个实体间相互关联的属性必须标记为@ManyToMany,并相互指定targetEntity属性,&nbsp;<br>需要注意的是,有且只有一个实体的@ManyToMany注解需要指定mappedBy属性,指向targetEntity的集合属性名称&nbsp;<br>利用ORM工具自动生成的表除了User和Book表外,还自动生成了一个User_Book表,用于实现多对多关联</p>
<p>13、@MappedSuperclass&nbsp;<br>可选&nbsp;<br>@MappedSuperclass可以将超类的JPA注解传递给子类,使子类能够继承超类的JPA注解&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @MappedSuperclass&nbsp;<br>&nbsp;&nbsp;&nbsp; public class Employee() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ….&nbsp;<br>&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; @Entity&nbsp;<br>&nbsp;&nbsp;&nbsp; public class Engineer extends Employee {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; …..&nbsp;<br>&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp; @Entity&nbsp;<br>&nbsp;&nbsp;&nbsp; public class Manager extends Employee {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; …..&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>14、@Embedded&nbsp;<br>可选&nbsp;<br>@Embedded将几个字段组合成一个类,并作为整个Entity的一个属性.&nbsp;<br>例如User包括id,name,city,street,zip属性.&nbsp;<br>我们希望city,street,zip属性映射为Address对象.这样,User对象将具有id,name和address这三个属性.&nbsp;<br>Address对象必须定义为@Embededable&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @Embeddable&nbsp;<br>&nbsp;&nbsp;&nbsp; public class Address {city,street,zip}&nbsp;<br>&nbsp;&nbsp;&nbsp; @Entity&nbsp;<br>&nbsp;&nbsp;&nbsp; public class User {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @Embedded&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Address getAddress() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ……….&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>　　现在，让我们来动手使用Hibernate Annotation。</p>
<p>安装 Hibernate Annotation&nbsp;<br>　　要使用 Hibernate Annotation，您至少需要具备 Hibernate 3.2和Java 5。可以从 Hibernate 站点 下载 Hibernate 3.2 和 Hibernate Annotation库。除了标准的 Hibernate JAR 和依赖项之外，您还需要 Hibernate Annotations .jar 文件（hibernate-annotations.jar）、Java 持久性 API （lib/ejb3-persistence.jar）。如果您正在使用 Maven，只需要向 POM 文件添加相应的依赖项即可，如下所示：</p>
<p>&nbsp;&nbsp;&nbsp; …&nbsp;<br>&lt;dependency&gt;&nbsp;<br>&lt;groupId&gt;org.hibernate&lt;/groupId&gt;&nbsp;<br>&lt;artifactId&gt;hibernate&lt;/artifactId&gt;&nbsp;<br>&lt;version&gt;3.2.1.ga&lt;/version&gt;&nbsp;<br>&lt;/dependency&gt;&nbsp;<br>&lt;dependency&gt;&nbsp;<br>&lt;groupId&gt;org.hibernate&lt;/groupId&gt;&nbsp;<br>&lt;artifactId&gt;hibernate-annotations&lt;/artifactId&gt;&nbsp;<br>&lt;version&gt;3.2.0.ga&lt;/version&gt;&nbsp;<br>&lt;/dependency&gt;&nbsp;<br>&lt;dependency&gt;&nbsp;<br>&lt;groupId&gt;javax.persistence&lt;/groupId&gt;&nbsp;<br>&lt;artifactId&gt;persistence-api&lt;/artifactId&gt;&nbsp;<br>&lt;version&gt;1.0&lt;/version&gt;&nbsp;<br>&lt;/dependency&gt;&nbsp;<br>…&nbsp;<br>　　下一步就是获取 Hibernate 会话工厂。尽管无需惊天的修改，但这一工作与使用 Hibernate Annotations有所不同。您需要使用 AnnotationConfiguration 类来建立会话工厂：</p>
<p>sessionFactory = new&nbsp;<br>AnnotationConfiguration().buildSessionFactory();&nbsp;<br>　　尽管通常使用 &lt;mapping&gt; 元素来声明持久性类，您还是需要在 Hibernate 配置文件（通常是 hibernate.cfg.xml）中声明持久性类：</p>
<p>&lt;!DOCTYPE hibernate-configuration PUBLIC&nbsp;<br>“-//Hibernate/Hibernate Configuration DTD 3.0//EN”&nbsp;<br>“<a href="http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd" target="_blank" rel="noopener">http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd</a>“&gt;&nbsp;<br>&lt;hibernate-configuration&gt;&nbsp;<br>&lt;session-factory&gt;&nbsp;<br>&lt;mapping class=”com.onjava.modelplanes.domain.PlaneType”/&gt;&nbsp;<br>&lt;mapping class=”com.onjava.modelplanes.domain.ModelPlane”/&gt;&nbsp;<br>&lt;/session-factory&gt;&nbsp;<br>&lt;/hibernate-configuration&gt;&nbsp;<br>　　近期的许多 Java 项目都使用了轻量级的应用框架，例如 Spring。如果您正在使用 Spring 框架，可以使用 AnnotationSessionFactoryBean 类轻松建立一个基于注释的 Hibernate 会话工厂，如下所示：</p>
<p>&lt;!– Hibernate session factory –&gt;&nbsp;<br>&lt;bean id=”sessionFactory”&nbsp;<br>class=”org.springframework.orm.hibernate3.annotation.AnnotationSessionFactoryBean”&gt;&nbsp;<br>&lt;property name=”dataSource”&gt;&nbsp;<br>&lt;ref bean=”dataSource”/&gt;&nbsp;<br>&lt;/property&gt;&nbsp;<br>&lt;property name=”hibernateProperties”&gt;&nbsp;<br>&lt;props&gt;&nbsp;<br>&lt;prop key=”hibernate.dialect”&gt;org.hibernate.dialect.DerbyDialect&lt;/prop&gt;&nbsp;<br>&lt;prop key=”hibernate.hbm2ddl.auto”&gt;create&lt;/prop&gt;&nbsp;<br>…&nbsp;<br>&lt;/props&gt;&nbsp;<br>&lt;/property&gt;&nbsp;<br>&lt;property name=”annotatedClasses”&gt;&nbsp;<br>&lt;list&gt;&nbsp;<br>&lt;value&gt;com.onjava.modelplanes.domain.PlaneType&lt;/value&gt;&nbsp;<br>&lt;value&gt;com.onjava.modelplanes.domain.ModelPlane&lt;/value&gt;&nbsp;<br>…&nbsp;<br>&lt;/list&gt;&nbsp;<br>&lt;/property&gt;&nbsp;<br>&lt;/bean&gt;&nbsp;<br>第一个持久性类&nbsp;<br>　　既然已经知道了如何获得注释所支持的 Hibernate 会话，下面让我们来了解一下带注释的持久性类的情况：</p>
<p>　　像在其他任何 Hibernate应用程序中一样，带注释的持久性类也是普通 POJO。差不多可以说是。您需要向 Java 持久性 API （javax.persistence.<em>）添加依赖项，如果您正在使用任何特定于 Hibernate的扩展，那很可能就是 Hibernate Annotation 程序包（org.hibernate.annotations.</em>），但除此之外，它们只是具备了持久性注释的普通 POJO 。下面是一个简单的例子：</p>
<p>@Entity&nbsp;<br>public class ModelPlane {&nbsp;<br>private Long id;&nbsp;<br>private String name;&nbsp;<br>@Id&nbsp;<br>public Long getId() {&nbsp;<br>return id;&nbsp;<br>}&nbsp;<br>public void setId(Long id) {&nbsp;<br>this.id = id;&nbsp;<br>}&nbsp;<br>public String getName() {&nbsp;<br>return name;&nbsp;<br>}&nbsp;<br>public void setName(String name) {&nbsp;<br>this.name = name;&nbsp;<br>}&nbsp;<br>}&nbsp;<br>　　正像我们所提到的，这非常简单。@Entity 注释声明该类为持久类。@Id 注释可以表明哪种属性是该类中的独特标识符。事实上，您既可以保持字段（注释成员变量），也可以保持属性（注释getter方法）的持久性。后文中将使用基于属性的注释。基于注释的持久性的优点之一在于大量使用了默认值（最大的优点就是 &ldquo;惯例优先原则（convention over configuration）&rdquo;）。例如，您无需说明每个属性的持久性&mdash;&mdash;任何属性都被假定为持久的，除非您使用 @Transient 注释来说明其他情况。这简化了代码，相对使用老的 XML 映射文件而言也大幅地减少了输入工作量。</p>
<p>生成主键&nbsp;<br>　　Hibernate 能够出色地自动生成主键。Hibernate/EBJ 3 注释也可以为主键的自动生成提供丰富的支持，允许实现各种策略。下面的示例说明了一种常用的方法，其中 Hibernate 将会根据底层数据库来确定一种恰当的键生成策略：</p>
<p>@Id&nbsp;<br>@GeneratedValue(strategy=GenerationType.AUTO)&nbsp;<br>public Long getId() {&nbsp;<br>return id;&nbsp;<br>}&nbsp;<br>定制表和字段映射&nbsp;<br>　　默认情况下，Hibernate 会将持久类以匹配的名称映射到表和字段中。例如，前一个类可以与映射到以如下代码创建的表中：</p>
<p>CREATE TABLE MODELPLANE&nbsp;<br>(&nbsp;<br>ID long,&nbsp;<br>NAME varchar&nbsp;<br>)&nbsp;<br>　　如果您是自己生成并维护数据库，那么这种方法很有效，通过省略代码可以大大简化代码维护。然而，这并不能满足所有人的需求。有些应用程序需要访问外部数据库，而另一些可能需要遵从公司的数据库命名惯例。如果有必要，您可以使用 @Table 和 @Column 注释来定制您自己的持久性映射，如下所示：</p>
<p>@Entity&nbsp;<br>@Table(name=”T_MODEL_PLANE”)&nbsp;<br>public class ModelPlane {&nbsp;<br>private Long id;&nbsp;<br>private String name;&nbsp;<br>@Id&nbsp;<br>@Column(name=”PLANE_ID”)&nbsp;<br>public Long getId() {&nbsp;<br>return id;&nbsp;<br>}&nbsp;<br>public void setId(Long id) {&nbsp;<br>this.id = id;&nbsp;<br>}&nbsp;<br>@Column(name=”PLANE_NAME”)&nbsp;<br>public String getName() {&nbsp;<br>return name;&nbsp;<br>}&nbsp;<br>public void setName(String name) {&nbsp;<br>this.name = name;&nbsp;<br>}&nbsp;<br>}&nbsp;<br>　　该内容将映射到下表中：</p>
<p>CREATE TABLE T_MODEL_PLANE&nbsp;<br>(&nbsp;<br>PLANE_ID long,&nbsp;<br>PLANE_NAME varchar&nbsp;<br>)&nbsp;<br>　　也可以使用其他图和列的属性来定制映射。这使您可以指定诸如列长度、非空约束等详细内容。Hibernate支持大量针对这些注释的属性。下例中就包含了几种属性：</p>
<p>&nbsp;&nbsp;&nbsp; …&nbsp;<br>@Column(name=”PLANE_ID”, length=80, nullable=true)&nbsp;<br>public String getName() {&nbsp;<br>return name;&nbsp;<br>}&nbsp;<br>…&nbsp;<br>映射关系&nbsp;<br>　　Java 持久性映射过程中最重要和最复杂的一环就是确定如何映射表间的关系。像其他产品一样， Hibernate 在该领域中提供了高度的灵活性，但却是以复杂度的增加为代价。我们将通过研究几个常见案例来了解如何使用注释来处理这一问题。</p>
<p>　　其中一种最常用的关系就是多对一的关系。假定在以上示例中每个 ModelPlane 通过多对一的关系（也就是说，每个飞机模型只与一种飞机类型建立联系，尽管指定的飞机类型可以与七种飞机模型建立联系）来与 PlaneType 建立联系。可如下进行映射：</p>
<p>&nbsp;&nbsp;&nbsp; @ManyToOne( cascade = {CascadeType.PERSIST, CascadeType.MERGE} )&nbsp;<br>public PlaneType getPlaneType() {&nbsp;<br>return planeType;&nbsp;<br>}&nbsp;<br>　　CascadeType 值表明 Hibernate 应如何处理级联操作。</p>
<p>　　另一种常用的关系与上述关系相反：一对多再对一关系，也称为集合。在老式的 Hibernate 版本中进行映射或使用注释时，集合令人头疼，这里我们将简要加以探讨，以使您了解如何处理集合，例如，在以上示例中每个 PlaneType 对象都可能会包含一个 ModelPlanes 集合。可映射如下：</p>
<p>@OneToMany(mappedBy=”planeType”,&nbsp;<br>cascade=CascadeType.ALL,&nbsp;<br>fetch=FetchType.EAGER)&nbsp;<br>@OrderBy(“name”)&nbsp;<br>public List&lt;ModelPlane&gt; getModelPlanes() {&nbsp;<br>return modelPlanes;&nbsp;<br>}&nbsp;<br>命名查询&nbsp;<br>　　Hibernate 最优秀的功能之一就在于它能够在您的映射文件中声明命名查询。随后即可通过代码中的名称调用此类查询，这使您可以专注于查询，而避免了 SQL 或者 HQL 代码分散于整个应用程序中的情况。</p>
<p>　　也可以使用注释来实现命名查询，可以使用 @NamedQueries 和 @NamedQuery 注释，如下所示：</p>
<p>@NamedQueries(&nbsp;<br>{&nbsp;<br>@NamedQuery(&nbsp;<br>name=”planeType.findById”,&nbsp;<br>query=”select p from PlaneType p left join fetch p.modelPlanes where id=:id”&nbsp;<br>),&nbsp;<br>@NamedQuery(&nbsp;<br>name=”planeType.findAll”,&nbsp;<br>query=”select p from PlaneType p”&nbsp;<br>),&nbsp;<br>@NamedQuery(&nbsp;<br>name=”planeType.delete”,&nbsp;<br>query=”delete from PlaneType where id=:id”&nbsp;<br>)&nbsp;<br>}&nbsp;<br>)&nbsp;<br>　　一旦完成了定义，您就可以像调用其他任何其他命名查询一样来调用它们。</p>
<p>结束语&nbsp;<br>　　Hibernate 3 注释提供了强大而精致的 API，简化了 Java 数据库中的持久性代码，本文中只进行了简单的讨论。您可以选择遵从标准并使用 Java 持久性 API，也可以利用特定于 Hibernate的扩展，这些功能以损失可移植性为代价提供了更为强大的功能和更高的灵活性。无论如何，通过消除对 XML 映射文件的需求，Hibernate 注释将简化应用程序的维护，同时也可以使您对EJB 3 有初步认识。来试试吧！&nbsp;<br>&nbsp;<br>&nbsp;<br>本文来自CSDN博客，转载请标明出处：<a href="http://blog.csdn.net/dingqinghu/archive/2011/03/25/6275798.aspx" target="_blank" rel="noopener">http://blog.csdn.net/dingqinghu/archive/2011/03/25/6275798.aspx</a></p>
]]></content>
      
        
        <tags>
            
            <tag> orm </tag>
            
            <tag> j2ee </tag>
            
            <tag> java web </tag>
            
            <tag> Hibernate </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[java使用动态代理来实现AOP（日志记录）]]></title>
      <url>/2013/09/24/java%E4%BD%BF%E7%94%A8%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9D%A5%E5%AE%9E%E7%8E%B0AOP%EF%BC%88%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%EF%BC%89/</url>
      <content type="html"><![CDATA[<p><span style="line-height: 1.5;">AOP（面向方面）的思想，就是把项目共同的那部分功能分离开来，比如日志记录，避免在业务逻辑里面夹杂着跟业务逻辑无关的代码。</span></p>
<p>下面是一个AOP实现的简单例子：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201309/24111801-c8f719406a074bf5805d2a94ac2dcccb.jpg" alt=""></p>
<p>首先定义一些业务方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;"> <em> Created with IntelliJ IDEA.<br></em></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">  Author: wangjie  email:tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;"> <em> Date: 13-9-23<br></em></span><span style="color: #008080;"> 5</span> <span style="color: #008000;">  Time: 下午3:49<br></span><span style="color: #008080;"> 6</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> BussinessService {<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String login(String username, String password);<br></span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String find();<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> BussinessServiceImpl <span style="color: #0000ff;">implements</span><span style="color: #000000;"> BussinessService {<br></span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">private</span> Logger logger = Logger.getLogger(<span style="color: #0000ff;">this</span><span style="color: #000000;">.getClass().getSimpleName());<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String login(String username, String password) {<br></span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">return</span> “login success”<span style="color: #000000;">;<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String find() {<br></span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">return</span> “find success”<span style="color: #000000;">;<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span> }</pre><br></div><br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/</span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;"> <em> Created with IntelliJ IDEA.<br></em></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">  Author: wangjie  email:tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;"> <em> Date: 13-9-24<br></em></span><span style="color: #008080;"> 5</span> <span style="color: #008000;">  Time: 上午10:27<br></span><span style="color: #008080;"> 6</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> WorkService {<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String work();<br></span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String sleep();<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> WorkServiceImpl <span style="color: #0000ff;">implements</span><span style="color: #000000;"> WorkService{<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">14</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String work() {<br></span><span style="color: #008080;">15</span>         <span style="color: #0000ff;">return</span> “work success”<span style="color: #000000;">;<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">19</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String sleep() {<br></span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">return</span> “sleep success”<span style="color: #000000;">;<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">22</span> }</pre><br></div>

<p>实现InvocationHandler接口，使用map来存储不同的InvocationHandler对象，避免生成过多。</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.aoptest2.invohandler;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.InvocationHandler;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Method;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Proxy;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Arrays;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashMap;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.logging.Logger;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">11</span> <span style="color: #008000;"> <em> Created with IntelliJ IDEA.<br></em></span><span style="color: #008080;">12</span> <span style="color: #008000;">  Author: wangjie  email:tiantian.china.2@gmail.com<br></span><span style="color: #008080;">13</span> <span style="color: #008000;"> <em> Date: 13-9-23<br></em></span><span style="color: #008080;">14</span> <span style="color: #008000;">  Time: 下午3:47<br></span><span style="color: #008080;">15</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;">16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> LogInvoHandler <span style="color: #0000ff;">implements</span><span style="color: #000000;"> InvocationHandler{<br></span><span style="color: #008080;">17</span>     <span style="color: #0000ff;">private</span> Logger logger = Logger.getLogger(<span style="color: #0000ff;">this</span><span style="color: #000000;">.getClass().getSimpleName());<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span>     <span style="color: #0000ff;">private</span> Object target; <span style="color: #008000;">//</span><span style="color: #008000;"> 代理目标</span><br><span style="color: #008080;">20</span>     <span style="color: #0000ff;">private</span> Object proxy; <span style="color: #008000;">//</span><span style="color: #008000;"> 代理对象</span><br><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> HashMap&lt;Class&lt;?&gt;, LogInvoHandler&gt; invoHandlers = <span style="color: #0000ff;">new</span> HashMap&lt;Class&lt;?&gt;, LogInvoHandler&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> LogInvoHandler() {<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">28</span> <span style="color: #008000;">     <em> 通过Class来生成动态代理对象Proxy<br></em></span><span style="color: #008080;">29</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> clazz<br></span><span style="color: #008080;">30</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">31</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">32</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">static</span>&lt;T&gt; T getProxyInstance(Class&lt;T&gt;<span style="color: #000000;"> clazz){<br></span><span style="color: #008080;">33</span>         LogInvoHandler invoHandler =<span style="color: #000000;"> invoHandlers.get(clazz);<br></span><span style="color: #008080;">34</span><br><span style="color: #008080;">35</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> invoHandler){<br></span><span style="color: #008080;">36</span>             invoHandler = <span style="color: #0000ff;">new</span><span style="color: #000000;"> LogInvoHandler();<br></span><span style="color: #008080;">37</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">38</span>                 T tar =<span style="color: #000000;"> clazz.newInstance();<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">                invoHandler.setTarget(tar);<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">                invoHandler.setProxy(Proxy.newProxyInstance(tar.getClass().getClassLoader(),<br></span><span style="color: #008080;">41</span> <span style="color: #000000;">                        tar.getClass().getInterfaces(), invoHandler));<br></span><span style="color: #008080;">42</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">                e.printStackTrace();<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">            invoHandlers.put(clazz, invoHandler);<br></span><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">48</span><br><span style="color: #008080;">49</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> (T)invoHandler.getProxy();<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">51</span><br><span style="color: #008080;">52</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">53</span>     <span style="color: #0000ff;">public</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Throwable {<br></span><span style="color: #008080;">54</span><br><span style="color: #008080;">55</span>         Object result = method.invoke(target, args); <span style="color: #008000;">//</span><span style="color: #008000;"> 执行业务处理<br></span><span style="color: #008080;">56</span><br><span style="color: #008080;">57</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 打印日志</span><br><span style="color: #008080;">58</span>         logger.info(“____invoke method: “ +<span style="color: #000000;"> method.getName()<br></span><span style="color: #008080;">59</span>                     + “; args: “ + (<span style="color: #0000ff;">null</span> == args ? “null”<span style="color: #000000;"> : Arrays.asList(args).toString())<br></span><span style="color: #008080;">60</span>                     + “; return: “ +<span style="color: #000000;"> result);<br></span><span style="color: #008080;">61</span><br><span style="color: #008080;">62</span><br><span style="color: #008080;">63</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> result;<br></span><span style="color: #008080;">64</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">65</span><br><span style="color: #008080;">66</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Object getTarget() {<br></span><span style="color: #008080;">67</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> target;<br></span><span style="color: #008080;">68</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">69</span><br><span style="color: #008080;">70</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setTarget(Object target) {<br></span><span style="color: #008080;">71</span>         <span style="color: #0000ff;">this</span>.target =<span style="color: #000000;"> target;<br></span><span style="color: #008080;">72</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">73</span><br><span style="color: #008080;">74</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Object getProxy() {<br></span><span style="color: #008080;">75</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> proxy;<br></span><span style="color: #008080;">76</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">77</span><br><span style="color: #008080;">78</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setProxy(Object proxy) {<br></span><span style="color: #008080;">79</span>         <span style="color: #0000ff;">this</span>.proxy =<span style="color: #000000;"> proxy;<br></span><span style="color: #008080;">80</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">81</span> }</pre><br></div>

<p>&nbsp;</p>
<p>然后编写一个Test类测试：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">  Date: 13-9-24<br></span><span style="color: #008080;"> 5</span> <span style="color: #008000;"> <em> Time: 上午9:54<br></em></span><span style="color: #008080;"> 6</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Test {<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> Logger logger = Logger.getLogger(Test.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName());<br></span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span>         BussinessService bs = LogInvoHandler.getProxyInstance(BussinessServiceImpl.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;">12</span>         bs.login(“zhangsan”, “123456”<span style="color: #000000;">);<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">        bs.find();<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>         logger.info(“————————————–”<span style="color: #000000;">);<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span>         WorkService ws = LogInvoHandler.getProxyInstance(WorkServiceImpl.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">        ws.work();<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">        ws.sleep();<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>         logger.info(“————————————–”<span style="color: #000000;">);<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span>         BussinessService bss = LogInvoHandler.getProxyInstance(BussinessServiceImpl.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;">24</span>         bss.login(“lisi”, “654321”<span style="color: #000000;">);<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">        bss.find();<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">28</span> }</pre><br></div>

<p>以后需要添加新的业务逻辑XXXService，只需要调用</p>
<p>XXXService xs = LogInvoHandler.getProxyInstance(XXXServiceImpl.class);</p>
<p>即可。</p>
<p>也可以模仿Spring等框架的配置，把bean的类名配置在xml文件中，如：</p>
<p>&lt;bean id=”bussinessService” class=”com.wangjie.aoptest2.service.impl.BussinessServiceImpl”&gt;</p>
<p>然后在java代码中解析xml，通过Class.forName(“com.wangjie.aoptest2.service.impl.BussinessServiceImpl”);获得Class对象</p>
<p>然后通过LogInvoHandler.getProxyInstance(Class.forName(“com.wangjie.aoptest2.service.impl.BussinessServiceImpl”));获得代理对象Proxy</p>
<p>再使用反射去调用代理对象的方法。</p>
<p>&nbsp;</p>
<p>运行结果如下：</p>
<p>九月 24, 2013 11:08:03 上午 com.wangjie.aoptest2.invohandler.LogInvoHandler invoke<br>INFO: <strong><strong>invoke method: login; args: [zhangsan, 123456]; return: login success<br>九月 24, 2013 11:08:03 上午 com.wangjie.aoptest2.invohandler.LogInvoHandler invoke<br>INFO: </strong></strong>invoke method: find; args: null; return: find success<br>九月 24, 2013 11:08:03 上午 com.wangjie.aoptest2.Test main<br>INFO: ————————————–<br>九月 24, 2013 11:08:03 上午 com.wangjie.aoptest2.invohandler.LogInvoHandler invoke<br>INFO: <strong><strong>invoke method: work; args: null; return: work success<br>九月 24, 2013 11:08:03 上午 com.wangjie.aoptest2.invohandler.LogInvoHandler invoke<br>INFO: </strong></strong>invoke method: sleep; args: null; return: sleep success<br>九月 24, 2013 11:08:03 上午 com.wangjie.aoptest2.Test main<br>INFO: ————————————–<br>九月 24, 2013 11:08:03 上午 com.wangjie.aoptest2.invohandler.LogInvoHandler invoke<br>INFO: <strong><strong>invoke method: login; args: [lisi, 654321]; return: login success<br>九月 24, 2013 11:08:03 上午 com.wangjie.aoptest2.invohandler.LogInvoHandler invoke<br>INFO: </strong></strong>invoke method: find; args: null; return: find success</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> dynamic proxy </tag>
            
            <tag> aop </tag>
            
            <tag> log </tag>
            
            <tag> logger </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android自定义ScrollView分段加载大文本数据到TextView]]></title>
      <url>/2013/09/10/Android%E8%87%AA%E5%AE%9A%E4%B9%89ScrollView%E5%88%86%E6%AE%B5%E5%8A%A0%E8%BD%BD%E5%A4%A7%E6%96%87%E6%9C%AC%E6%95%B0%E6%8D%AE%E5%88%B0TextView/</url>
      <content type="html"><![CDATA[<p>这是我现在碰到的一个问题，如果需要在TextView中加载大文本的时候，比如几M的txt文件时，TextView载入的时候会出现卡死的现象，甚至会出现异常等待退出出现。</p>
<p>解决办法之一就是通过&ldquo;分段&rdquo;或&ldquo;分页&rdquo;来显示数据，在TextView（嵌入在ScrollView之中实现了TextView的滚动）中滚动到底部的时候，再去加载下一部分的数据，依次类推，这样每次加载的数据相对来说都比较小，不会出现卡顿的现象。</p>
<p>遇到的问题是，如何监听ScrollView滚动的位置（滚动到顶部还是底部？）。</p>
<p>&nbsp;</p>
<p>如下，通过自定义ScrollView类(BorderScrollView)：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.bigtextloadtest;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.graphics.Rect;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.AttributeSet;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.ScrollView;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 9</span> <span style="color: #008000;"> <em> Created with IntelliJ IDEA.<br></em></span><span style="color: #008080;">10</span> <span style="color: #008000;">  Author: wangjie  email:tiantian.china.2@gmail.com<br></span><span style="color: #008080;">11</span> <span style="color: #008000;"> <em> Date: 13-9-6<br></em></span><span style="color: #008080;">12</span> <span style="color: #008000;">  Time: 下午2:06<br></span><span style="color: #008080;">13</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;">14</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> BorderScrollView <span style="color: #0000ff;">extends</span><span style="color: #000000;"> ScrollView{<br></span><span style="color: #008080;">15</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> millis;<br></span><span style="color: #008080;">16</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 滚动监听者</span><br><span style="color: #008080;">17</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> OnScrollChangedListener onScrollChangedListener;<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> BorderScrollView(Context context) {<br></span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> BorderScrollView(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;">24</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span>     <span style="color: #0000ff;">public</span> BorderScrollView(Context context, AttributeSet attrs, <span style="color: #0000ff;">int</span><span style="color: #000000;"> defStyle) {<br></span><span style="color: #008080;">28</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs, defStyle);<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">32</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> onScrollChanged(<span style="color: #0000ff;">int</span> l, <span style="color: #0000ff;">int</span> t, <span style="color: #0000ff;">int</span> oldl, <span style="color: #0000ff;">int</span><span style="color: #000000;"> oldt) {<br></span><span style="color: #008080;">33</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onScrollChanged(l, t, oldl, oldt);<br></span><span style="color: #008080;">34</span><br><span style="color: #008080;">35</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> onScrollChangedListener){<br></span><span style="color: #008080;">36</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">37</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">38</span><br><span style="color: #008080;">39</span>         <span style="color: #0000ff;">long</span> now =<span style="color: #000000;"> System.currentTimeMillis();<br></span><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 通知监听者当前滚动的具体信息</span><br><span style="color: #008080;">42</span> <span style="color: #000000;">        onScrollChangedListener.onScrollChanged(l, t, oldl, oldt);<br></span><span style="color: #008080;">43</span><br><span style="color: #008080;">44</span>         <span style="color: #0000ff;">if</span>(now - millis &gt; 1000l<span style="color: #000000;">){<br></span><span style="color: #008080;">45</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 滚动到底部（前提：从不是底部滚动到底部）</span><br><span style="color: #008080;">46</span>             <span style="color: #0000ff;">if</span>((<span style="color: #0000ff;">this</span>.getHeight() + oldt) != <span style="color: #0000ff;">this</span><span style="color: #000000;">.getTotalVerticalScrollRange()<br></span><span style="color: #008080;">47</span>                     &amp;&amp; (<span style="color: #0000ff;">this</span>.getHeight() + t) == <span style="color: #0000ff;">this</span><span style="color: #000000;">.getTotalVerticalScrollRange()){<br></span><span style="color: #008080;">48</span><br><span style="color: #008080;">49</span>                 onScrollChangedListener.onScrollBottom(); <span style="color: #008000;">//</span><span style="color: #008000;"> 通知监听者滚动到底部</span><br><span style="color: #008080;">50</span><br><span style="color: #008080;">51</span>                 millis =<span style="color: #000000;"> now;<br></span><span style="color: #008080;">52</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">53</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">54</span><br><span style="color: #008080;">55</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 滚动到顶部（前提：从不是顶部滚动到顶部）</span><br><span style="color: #008080;">56</span>         <span style="color: #0000ff;">if</span>(oldt != 0 &amp;&amp; t == 0<span style="color: #000000;">){<br></span><span style="color: #008080;">57</span>             onScrollChangedListener.onScrollTop(); <span style="color: #008000;">//</span><span style="color: #008000;"> 通知监听者滚动到顶部</span><br><span style="color: #008080;">58</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">59</span><br><span style="color: #008080;">60</span><br><span style="color: #008080;">61</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">62</span><br><span style="color: #008080;">63</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> OnScrollChangedListener getOnScrollChangedListener() {<br></span><span style="color: #008080;">64</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> onScrollChangedListener;<br></span><span style="color: #008080;">65</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">66</span><br><span style="color: #008080;">67</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnScrollChangedListener(OnScrollChangedListener onScrollChangedListener) {<br></span><span style="color: #008080;">68</span>         <span style="color: #0000ff;">this</span>.onScrollChangedListener =<span style="color: #000000;"> onScrollChangedListener;<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">70</span><br><span style="color: #008080;">71</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">72</span> <span style="color: #008000;">     <em> 获得滚动总长度<br></em></span><span style="color: #008080;">73</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;">74</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">75</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getTotalVerticalScrollRange() {<br></span><span style="color: #008080;">76</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.computeVerticalScrollRange();<br></span><span style="color: #008080;">77</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">78</span><br><span style="color: #008080;">79</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">80</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> computeScrollDeltaToGetChildRectOnScreen(Rect rect) {<br></span><span style="color: #008080;">81</span>         <span style="color: #0000ff;">return</span> 0; <span style="color: #008000;">//</span><span style="color: #008000;"> 禁止ScrollView在子控件的布局改变时自动滚动</span><br><span style="color: #008080;">82</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">83</span><br><span style="color: #008080;">84</span> }</pre><br></div>

<p>&nbsp;</p>
<p>滚动监听器接口OnScrollChangedListener：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.bigtextloadtest;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 4</span> <span style="color: #008000;"> <em> Created with IntelliJ IDEA.<br></em></span><span style="color: #008080;"> 5</span> <span style="color: #008000;">  Author: wangjie  email:tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 6</span> <span style="color: #008000;"> <em> Date: 13-9-6<br></em></span><span style="color: #008080;"> 7</span> <span style="color: #008000;">  Time: 下午2:53<br></span><span style="color: #008080;"> 8</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> OnScrollChangedListener {<br></span><span style="color: #008080;">10</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">11</span> <span style="color: #008000;">     <em> 监听滚动变化<br></em></span><span style="color: #008080;">12</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> l<br></span><span style="color: #008080;">13</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> t<br></span><span style="color: #008080;">14</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> oldl<br></span><span style="color: #008080;">15</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> oldt<br></span><span style="color: #008080;">16</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onScrollChanged(<span style="color: #0000ff;">int</span> l, <span style="color: #0000ff;">int</span> t, <span style="color: #0000ff;">int</span> oldl, <span style="color: #0000ff;">int</span><span style="color: #000000;"> oldt);<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">20</span> <span style="color: #008000;">     <em> 监听滚动到顶部<br></em></span><span style="color: #008080;">21</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">22</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onScrollTop();<br></span><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">25</span> <span style="color: #008000;">     <em> 监听滚动到底部<br></em></span><span style="color: #008080;">26</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">27</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onScrollBottom();<br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> }</pre><br></div>

<p>&nbsp;</p>
<p>滚动监听器的空实现OnScrollChangedListenerSimple（简洁真正用时候的代码）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.bigtextloadtest;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 4</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;"> 5</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 6</span> <span style="color: #008000;">  Date: 13-9-9<br></span><span style="color: #008080;"> 7</span> <span style="color: #008000;"> <em> Time: 下午2:39<br></em></span><span style="color: #008080;"> 8</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> OnScrollChangedListenerSimple <span style="color: #0000ff;">implements</span><span style="color: #000000;"> OnScrollChangedListener{<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onScrollChanged(<span style="color: #0000ff;">int</span> l, <span style="color: #0000ff;">int</span> t, <span style="color: #0000ff;">int</span> oldl, <span style="color: #0000ff;">int</span><span style="color: #000000;"> oldt) {}<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">14</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onScrollTop() {}<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onScrollBottom() {}<br></span><span style="color: #008080;">18</span> }</pre><br></div>

<p>&nbsp;</p>
<p>异步加载分段文本（这里每次加载50行）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.bigtextloadtest;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.AsyncTask;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Handler;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span> java.io.<em><span style="color: #000000;">;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #008000;">/**</span><br><span style="color: #008080;">11</span> <span style="color: #008000;"> </span></em> Created with IntelliJ IDEA.<br><span style="color: #008080;">12</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">13</span> <span style="color: #008000;">  Date: 13-9-6<br></span><span style="color: #008080;">14</span> <span style="color: #008000;"> <em> Time: 上午11:34<br></em></span><span style="color: #008080;">15</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> AsyncTextLoadTask <span style="color: #0000ff;">extends</span> AsyncTask&lt;Object, String, String&gt;<span style="color: #000000;"> {<br></span><span style="color: #008080;">17</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br></span><span style="color: #008080;">18</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> MainActivity activity;<br></span><span style="color: #008080;">19</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> BufferedReader br;<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> AsyncTextLoadTask(Context context, BufferedReader br) {<br></span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">this</span>.context =<span style="color: #000000;"> context;<br></span><span style="color: #008080;">23</span>         <span style="color: #0000ff;">this</span>.br =<span style="color: #000000;"> br;<br></span><span style="color: #008080;">24</span>         activity =<span style="color: #000000;"> (MainActivity)context;<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">28</span>     <span style="color: #0000ff;">protected</span><span style="color: #000000;"> String doInBackground(Object… params) {<br></span><span style="color: #008080;">29</span>         StringBuilder paragraph = <span style="color: #0000ff;">new</span><span style="color: #000000;"> StringBuilder();<br></span><span style="color: #008080;">30</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">31</span><br><span style="color: #008080;">32</span>             String line = “”<span style="color: #000000;">;<br></span><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span>             <span style="color: #0000ff;">int</span> index = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">35</span>             <span style="color: #0000ff;">while</span>(index &lt; 50 &amp;&amp; (line = br.readLine()) != <span style="color: #0000ff;">null</span><span style="color: #000000;">){<br></span><span style="color: #008080;">36</span>                 paragraph.append(line + “\n”<span style="color: #000000;">);<br></span><span style="color: #008080;">37</span>                 index++<span style="color: #000000;">;<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">39</span><br><span style="color: #008080;">40</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;">41</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">43</span><br><span style="color: #008080;">44</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> paragraph.toString();<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span><br><span style="color: #008080;">48</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">49</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPreExecute() {<br></span><span style="color: #008080;">50</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPreExecute();<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">52</span><br><span style="color: #008080;">53</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">54</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPostExecute(String result) {<br></span><span style="color: #008080;">55</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPostExecute(result);<br></span><span style="color: #008080;">56</span> <span style="color: #000000;">        activity.contentTv.setText(result);<br></span><span style="color: #008080;">57</span>         <span style="color: #0000ff;">new</span> Handler().postDelayed(<span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable() {<br></span><span style="color: #008080;">58</span><br><span style="color: #008080;">59</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">60</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;">61</span>                 activity.contentScroll.scrollTo(0, 0); <span style="color: #008000;">//</span><span style="color: #008000;"> 记载完新数据后滚动到顶部</span><br><span style="color: #008080;">62</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">63</span>         }, 100<span style="color: #000000;">);<br></span><span style="color: #008080;">64</span>         activity.isLoading = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">65</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">66</span><br><span style="color: #008080;">67</span> }</pre><br></div>

<p>&nbsp;</p>
<p>真正使用分段加载数据Activity（这里加载一本小说《百年孤独》）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.bigtextloadtest;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.app.Activity;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.TextView;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.BufferedReader;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.IOException;<br></span><span style="color: #008080;">10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.InputStream;<br></span><span style="color: #008080;">11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.InputStreamReader;<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Activity {<br></span><span style="color: #008080;">14</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> BorderScrollView contentScroll;<br></span><span style="color: #008080;">15</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> TextView contentTv;<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> BufferedReader br;<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isLoading;<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span>     <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">25</span> <span style="color: #008000;">      Called when the activity is first created.<br></span><span style="color: #008080;">26</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">27</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;">29</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">        setContentView(R.layout.main);<br></span><span style="color: #008080;">31</span>         context = <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;">32</span><br><span style="color: #008080;">33</span>         contentTv =<span style="color: #000000;"> (TextView) findViewById(R.id.content);<br></span><span style="color: #008080;">34</span>         contentScroll =<span style="color: #000000;"> (BorderScrollView) findViewById(R.id.contentScroll);<br></span><span style="color: #008080;">35</span><br><span style="color: #008080;">36</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 注册刚写的滚动监听器</span><br><span style="color: #008080;">37</span>         contentScroll.setOnScrollChangedListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> OnScrollChangedListenerSimple(){<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">39</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onScrollBottom() {<br></span><span style="color: #008080;">40</span>                 <span style="color: #0000ff;">synchronized</span> (MainActivity.<span style="color: #0000ff;">class</span><span style="color: #000000;">){<br></span><span style="color: #008080;">41</span>                     <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">isLoading){<br></span><span style="color: #008080;">42</span>                         isLoading = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">43</span>                         <span style="color: #0000ff;">new</span><span style="color: #000000;"> AsyncTextLoadTask(context, br).execute();<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">46</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">47</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">48</span><br><span style="color: #008080;">49</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;">{<br></span><span style="color: #008080;">50</span>             InputStream is = context.getAssets().open(“bngd.txt”<span style="color: #000000;">);<br></span><span style="color: #008080;">51</span>             br = <span style="color: #0000ff;">new</span> BufferedReader(<span style="color: #0000ff;">new</span><span style="color: #000000;"> InputStreamReader(is));<br></span><span style="color: #008080;">52</span><br><span style="color: #008080;">53</span>             <span style="color: #0000ff;">new</span><span style="color: #000000;"> AsyncTextLoadTask(context, br).execute();<br></span><span style="color: #008080;">54</span><br><span style="color: #008080;">55</span>         }<span style="color: #0000ff;">catch</span><span style="color: #000000;">(Exception ex){<br></span><span style="color: #008080;">56</span> <span style="color: #000000;">            ex.printStackTrace();<br></span><span style="color: #008080;">57</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">58</span><br><span style="color: #008080;">59</span><br><span style="color: #008080;">60</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">61</span><br><span style="color: #008080;">62</span><br><span style="color: #008080;">63</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">64</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDestroy() {<br></span><span style="color: #008080;">65</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDestroy();<br></span><span style="color: #008080;">66</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> br){<br></span><span style="color: #008080;">67</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">68</span> <span style="color: #000000;">                br.close();<br></span><span style="color: #008080;">69</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;">70</span> <span style="color: #000000;">                e.printStackTrace();<br></span><span style="color: #008080;">71</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">72</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">73</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">74</span><br><span style="color: #008080;">75</span> }</pre><br></div>

<p>&nbsp;</p>
<p>贴上布局：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><br><span style="color: #008080;"> 3</span> <span style="color: #ff0000;">              android:orientation</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">              android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">              android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">com.wangjie.bigtextloadtest.BorderScrollView<br></span><span style="color: #008080;"> 8</span>             <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/contentScroll”</span><br><span style="color: #008080;"> 9</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">10</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">11</span>             <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">12</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout<br></span><span style="color: #008080;">13</span>                 <span style="color: #ff0000;">android:orientation</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;">14</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">15</span> <span style="color: #ff0000;">                android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">16</span>                 <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">17</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextView<br></span><span style="color: #008080;">18</span>                     <span style="color: #ff0000;">android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">19</span> <span style="color: #ff0000;">                    android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">20</span> <span style="color: #ff0000;">                    android:text</span><span style="color: #0000ff;">=”asdfasdf”</span><br><span style="color: #008080;">21</span>                     <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">22</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextView<br></span><span style="color: #008080;">23</span>                     <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/content”</span><br><span style="color: #008080;">24</span> <span style="color: #ff0000;">                    android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">25</span> <span style="color: #ff0000;">                    android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">26</span> <span style="color: #ff0000;">                    android:text</span><span style="color: #0000ff;">=”Hello World, MainActivity”</span><br><span style="color: #008080;">27</span>                     <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">28</span>         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">com.wangjie.bigtextloadtest.BorderScrollView</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">31</span><br><span style="color: #008080;">32</span><br><span style="color: #008080;">33</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ScrollView </tag>
            
            <tag> TextView </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[IOS推送功能的实现（javapns）]]></title>
      <url>/2013/06/06/IOS%E6%8E%A8%E9%80%81%E5%8A%9F%E8%83%BD%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%88javapns%EF%BC%89/</url>
      <content type="html"><![CDATA[<h2 id="IOS的推送实现由这样几步来完成"><a href="#IOS的推送实现由这样几步来完成" class="headerlink" title="IOS的推送实现由这样几步来完成:"></a>IOS的推送实现由这样几步来完成:</h2><ol>
<li>创建Push SSL Certification</li>
<li>IOS客户端注册Push功能并获得DeviceToken</li>
<li>使用Provider向APNS发送Push消息</li>
<li>IOS客户端接收处理由APNS发来的消息</li>
</ol>
<h2 id="创建Push-SSL-Certification"><a href="#创建Push-SSL-Certification" class="headerlink" title="创建Push SSL Certification"></a><a name="t1"></a>创建Push SSL Certification</h2><p>&nbsp;&nbsp;&nbsp; 登录developer.apple.com，创建新的App ID，要求此ID的Bundle Identifier不包含通配符，否则不能启用Push以及IAP功能。例如 com.soso.sosoimage。</p>
<p>&nbsp;&nbsp;&nbsp; 在App IDs列表页面，点击刚创建的app id右面的Configure链接，进入Configure App ID界面，选中”Enable for App Push Notification service”。点击Development Push SSL Certificate一行的Configure按钮，弹出”Apple Push Notification service SSL Certificate Assistant”对话框，依对话框操作，类似于创建开发或发布用的Certificate。</p>
<p>&nbsp;&nbsp;&nbsp; 最终将Development Push SSL Certificate下载并安装到本地Keychain Access。导出成p12文件，备用。导出时需要设置密码，不得为空。</p>
<p>&nbsp;&nbsp;&nbsp; 在developer.apple.com，创建一个新的Provisioning Profile，使用我们刚刚创建的支持Push功能的App ID。下载并安装到本地。</p>
<p>&nbsp;</p>
<h2 id="IOS客户端注册Push功能并获得DeviceToken"><a href="#IOS客户端注册Push功能并获得DeviceToken" class="headerlink" title="IOS客户端注册Push功能并获得DeviceToken"></a><a name="t2"></a>IOS客户端注册Push功能并获得DeviceToken</h2><p><span>&nbsp;&nbsp;&nbsp; 创建本地工程，info.plist中设置Bundle identifier为刚刚创建的Bundle Id。Com.soso.sosoimage。设定Code Signing Identity为刚刚创建的Provisioning Profile。</span></p>
<p>&nbsp;&nbsp;&nbsp; 程序第一次执行的时候，调用如下代码.</p>
<div class="cnblogs_code"><br><pre>[[UIApplication sharedApplication] registerForRemoteNotificationTypes:(UIRemoteNotificationTypeAlert | UIRemoteNotificationTypeBadge | UIRemoteNotificationTypeSound)];</pre><br></div>

<p>三个参数分别代表消息（横幅或提醒，由用户Setting决定，程序不可更改）、数字标记、声音。</p>
<p><span>在AppDelegate.m中添加两个方法.</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">//</span><span style="color: #008000;">iPhone 从APNs服务器获取deviceToken后回调此方法</span><br>- (<span style="color: #0000ff;">void</span>)application:(UIApplication <em>)app didRegisterForRemoteNotificationsWithDeviceToken:(NSData </em><span style="color: #000000;">)deviceToken<br>{<br>    NSString</span><em> dt = [[deviceToken description] stringByTrimmingCharactersInSet:[NSCharacterSet characterSetWithCharactersInString:<span style="color: #800000;">@”</span><span style="color: #800000;">&lt;&gt;</span><span style="color: #800000;">“</span><span style="color: #000000;">]];<br>    NSLog(</span><span style="color: #800000;">@”</span><span style="color: #800000;">deviceToken:%@</span><span style="color: #800000;">“</span><span style="color: #000000;">, dt);<br>}<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;">注册push功能失败 后 返回错误信息，执行相应的处理</span><br>- (<span style="color: #0000ff;">void</span>)application:(UIApplication </em>)app didFailToRegisterForRemoteNotificationsWithError:(NSError *<span style="color: #000000;">)err<br>{<br>    NSLog(</span><span style="color: #800000;">@”</span><span style="color: #800000;">Push Register Error:%@</span><span style="color: #800000;">“</span><span style="color: #000000;">, err.description);<br>}</span></pre><br></div>

<p><span>获取DeviceToken后，将其传给Provider。</span></p>
<h2 id="使用Provider向APNS发送Push消息"><a href="#使用Provider向APNS发送Push消息" class="headerlink" title="使用Provider向APNS发送Push消息"></a><a name="t3"></a>使用Provider向APNS发送Push消息</h2><p> <span>Provider，将推送信息发送给APNS（苹果推送服务器）的程序。有很多开源的实现，我们使用javapns ( <a href="http://code.google.com/p/javapns/" target="_blank" rel="noopener">http://code.google.com/p/javapns/</a> )。</span><br><span>首先，Provider要有目标DeviceToken，这是发送目标，由客户端传给Provider之后存在某处。</span><br><span>安装javapns，需要导入的jar为bcprov-jdk15-146.jar, log4j-1.2.15.jar, JavaPNS_2.3_Alpha_5.jar。</span><br><span>将前面导出的P12文件放在Provider的工程目录下。</span><br><span>Provider向APNS发送消息可以参考javapns中NotificationTest.java。也可以参考如下例子。</span></p>
<h3 id="1-使客户端图标显示数字标记"><a href="#1-使客户端图标显示数字标记" class="headerlink" title="(1)使客户端图标显示数字标记"></a><a name="t4"></a>(1)使客户端图标显示数字标记</h3><div class="cnblogs_code"><br><pre>Push.badge(2, keystore, password, <span style="color: #0000ff;">false</span>, “7bb8d508e32df651c6c239439737dbd40a88d2461ad2ac1e5dbe49ecea5ccc67”);</pre><br></div>

<p><span>其中，2为要显示的数字；</span></p>
<div class="cnblogs_code"><br><pre>String keystore = “PushCertificates.p12”;     <span style="color: #008000;">//</span><span style="color: #008000;">P12文件的路径；</span><br>String password = “sosoimage”;                <span style="color: #008000;">//</span><span style="color: #008000;">P12文件的密码；</span></pre><br></div>

<p><span>false，指的是使用测试环境，使用正式产品环境应传入true.</span><br><span>“7bb8d508e32df651c6c239439737dbd40a88d2461ad2ac1e5dbe49ecea5ccc67”为客户端获得并传给Provider的DeviceToken，此参数还可以传入String[]对象，以同时向多个客户端Push消息。</span></p>
<h3 id="2-使客户端显示横幅或提醒"><a href="#2-使客户端显示横幅或提醒" class="headerlink" title="(2)使客户端显示横幅或提醒"></a><a name="t5"></a>(2)使客户端显示横幅或提醒</h3><p>Provider可以向客户端Push一条Message，但客户端有权限决定这条Message的显示方式（无、横幅、提醒）。</p>
<div class="cnblogs_code"><br><pre>Push.alert(“A Message”, keystore, password, )<span style="color: #0000ff;">false</span>, “7bb8d508e32df651c6c239439737dbd40a88d2461ad2ac1e5dbe49ecea5ccc67”);</pre><br></div>

<h3 id="3-混合方式"><a href="#3-混合方式" class="headerlink" title="(3)混合方式"></a>(3)混合方式</h3><p><span>可以在一个Push消息里附带多种信息，Message, 标记，声音，可以使用如下代码.</span></p>
<div class="cnblogs_code"><br><pre>PushNotificationPayload payload =<span style="color: #000000;"> PushNotificationPayload.complex();<br>payload.addAlert(</span>“A Message”<span style="color: #000000;">);<br>payload.addBadge(</span>2<span style="color: #000000;">);<br>payload.addSound(</span>“test.aiff”<span style="color: #000000;">);<br>Push.payload(payload, , keystore, password, </span><span style="color: #0000ff;">false</span>, “7bb8d508e32df651c6c239439737dbd40a88d2461ad2ac1e5dbe49ecea5ccc67”);</pre><br></div>

<p><span>上面的代码都有可能会有相应的Exception抛出来，需要处理。更多的使用方式可以参考 <a href="http://code.google.com/p/javapns/&amp;nbsp" target="_blank" rel="noopener">http://code.google.com/p/javapns/&amp;nbsp</a>;</span></p>
<h2 id="IOS客户端接收处理由APNS发来的消息"><a href="#IOS客户端接收处理由APNS发来的消息" class="headerlink" title="IOS客户端接收处理由APNS发来的消息"></a><a name="t7"></a>IOS客户端接收处理由APNS发来的消息</h2><p><span>(1)当程序未启动，用户接收到消息。需要在AppDelegate中的didFinishLaunchingWithOptions得到消息内容。代码如下，</span></p>
<div class="cnblogs_code"><br><pre>- (BOOL)application:(UIApplication <em>)application didFinishLaunchingWithOptions:(NSDictionary </em><span style="color: #000000;">)launchOptions<br>{<br>    …<br><br>    NSDictionary</span>* payload =<span style="color: #000000;"> [launchOptions objectForKey:UIApplicationLaunchOptionsRemoteNotificationKey];<br>    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (payload)<br>    {<br>    …<br>    }<br><br>    </span><span style="color: #000000;">…<br>}</span></pre><br></div>

<p><span>(2)当程序在前台运行，接收到消息不会有消息提示（提示框或横幅）。当程序运行在后台，接收到消息会有消息提示，点击消息后进入程序，AppDelegate的didReceiveRemoteNotification函数会被调用（需要自己重写），消息做为此函数的参数传入，代码如下</span></p>
<div class="cnblogs_code"><br><pre>- (<span style="color: #0000ff;">void</span>)application:(UIApplication <em>)application didReceiveRemoteNotification:(NSDictionary </em><span style="color: #000000;">)payload<br>{<br>    …<br>}</span></pre><br></div>

<p><span>(3)无论在哪个函数传入，消息总是一个NSDictionary对象，处理方式可以参考如下代码</span></p>
<div class="cnblogs_code"><br><pre>- (<span style="color: #0000ff;">void</span>)application:(UIApplication <em>)application didReceiveRemoteNotification:(NSDictionary </em><span style="color: #000000;">)payload<br>{<br>    NSLog(</span><span style="color: #800000;">@”</span><span style="color: #800000;">remote notification: %@</span><span style="color: #800000;">“</span><span style="color: #000000;">,[payload description]);<br>    NSString</span><em> alertStr =<span style="color: #000000;"> nil;<br>    NSDictionary </span></em>apsInfo = [payload objectForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">aps</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br>    NSObject </span><em>alert = [apsInfo objectForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">alert</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br>    </span><span style="color: #0000ff;">if</span> ([alert isKindOfClass:[NSString <span style="color: #0000ff;">class</span><span style="color: #000000;">]])<br>    {<br>        alertStr </span>= (NSString</em><span style="color: #000000;">)alert;<br>    }<br>    </span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> ([alert isKindOfClass:[NSDictionary <span style="color: #0000ff;">class</span><span style="color: #000000;">]])<br>    {<br>        NSDictionary</span><em> alertDict = (NSDictionary</em><span style="color: #000000;">)alert;<br>        alertStr </span>= [alertDict objectForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">body</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br>    }<br>    application.applicationIconBadgeNumber </span>= [[apsInfo objectForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">badge</span><span style="color: #800000;">“</span><span style="color: #000000;">] integerValue];<br>    </span><span style="color: #0000ff;">if</span> ([application applicationState] == UIApplicationStateActive &amp;&amp; alertStr !=<span style="color: #000000;"> nil)<br>    {<br>        UIAlertView</span>* alertView = [[UIAlertView alloc] initWithTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">Pushed Message</span><span style="color: #800000;">“</span> message:alertStr <span style="color: #0000ff;">delegate</span>:nil cancelButtonTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">OK</span><span style="color: #800000;">“</span><span style="color: #000000;"> otherButtonTitles:nil];<br>        [alertView show];<br>    }<br>}</span></pre><br></div>

<p>&nbsp;</p>
<p>来自：<a href="http://blog.csdn.net/worldmatrix/article/details/7634596" target="_blank" rel="noopener">http://blog.csdn.net/worldmatrix/article/details/7634596</a></p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> iOS </tag>
            
            <tag> push </tag>
            
            <tag> javapns </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[IntelliJ IDEA 12 创建Web项目 教程 超详细版]]></title>
      <url>/2013/05/18/IntelliJ-IDEA-12-%E5%88%9B%E5%BB%BAWeb%E9%A1%B9%E7%9B%AE-%E6%95%99%E7%A8%8B-%E8%B6%85%E8%AF%A6%E7%BB%86%E7%89%88/</url>
      <content type="html"><![CDATA[<p>IntelliJ IDEA 12&nbsp;新版本发布 第一时间去官网看了下&nbsp;&nbsp;黑色的主题 很给力 大体使用了下&nbsp;&nbsp;对于一开始就是用eclipse的童鞋们</p>
<p>估计很难从eclipse中走出来&nbsp;当然 我也很艰难的走在路上 …</p>
<p><strong><span>首先要说一点，在IntelliJ IDEA里面&ldquo;new Project&rdquo; 就相当于我们eclipse的&ldquo;workspace&rdquo;，而&ldquo;new Module&rdquo;才是创建一个工程。</span></strong></p>
<p><strong><span>这个和Eclipse有很大的区别</span></strong></p>
<p>&nbsp;</p>
<p><strong>1.官网下载下来的默认不是黑色的主题&nbsp;这里需要修改一下&nbsp;工具栏上的扳手图标 或者是用ctrl+alt+s打开设置窗口</strong></p>
<p><strong>在打开窗口的左侧&nbsp; 找到Appearance&gt;Theme 选择Darcula主题 应用&nbsp; 重启就ok了</strong></p>
<p><strong>2.中文乱码问题&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 软件无论是打开项目空间还是其他的&nbsp;&nbsp;&nbsp;&nbsp; 字体显示不全 中文都是口口&nbsp;</strong></p>
<p><strong>解决方法:</strong></p>
<p><strong>Appearance&gt;Override default fonts by(not recommended)&nbsp;前面打勾</strong></p>
<p><strong>此时下方的name下拉框为可选状态&nbsp;&nbsp;找到Name:DialogInput.plain - Size:12&nbsp;&nbsp; 应用就ok了</strong></p>
<p>&nbsp;</p>
<p><strong>下面开始一步步的来创建一个web项目</strong></p>
<p><span><strong>1.首先 创建一个Project&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**</strong>也就是项目空间**</span></p>
<p><strong><img src="http://images.cnitblog.com/blog/355865/201301/29152002-599bc4776245421f9309c080241deb40.gif" alt=""></strong></p>
<p>2.选择项目类型&nbsp;这里选Java Module&nbsp; 自定义工作空间名称 和路径</p>
<p><img src="http://images.cnitblog.com/blog/355865/201301/29152128-8f769e2278e0466082619fa750448237.png" alt=""></p>
<p>3.选择需要用到的框架组件&nbsp;这里只选了第一个&nbsp;Web Application &gt; Finish</p>
<p><img src="http://images.cnitblog.com/blog/355865/201301/29152333-404c8da875d945ec845fbec85b3c5b36.gif" alt=""></p>
<p>4.创建完工作空间&nbsp;默认会是一个Module也就是一个项目 但是不推荐使用该项目进行开发</p>
<p><img src="http://images.cnitblog.com/blog/355865/201301/29152650-dab203ebafa04bddbcb6be16ebfa5ee1.png" alt=""></p>
<p>5.在该项目空间中&nbsp;添加新的工程 选中工作空间&nbsp;右键Open Module Settings 或者是按下F4</p>
<p><img src="http://images.cnitblog.com/blog/355865/201301/29153307-89ea6cef216f45319017b50159edd604.png" alt=""></p>
<p>6.添加工程</p>
<p><img src="http://images.cnitblog.com/blog/355865/201301/29154653-eda8d28c584048b6b346d7514ba3d515.png" alt=""></p>
<p>&nbsp;</p>
<p><strong><img src="http://images.cnitblog.com/blog/355865/201301/29154807-49eacbe0dc524460b3f177b6a2668b34.png" alt=""></strong></p>
<p>然后Finish&nbsp;&nbsp;找到新建工程的web&gt;WEB-INF下创建&nbsp;classes 和lib文件夹&nbsp;</p>
<p><img src="http://images.cnitblog.com/blog/355865/201301/29155004-ac0e1d8b9d6f4edb99597a88db0f136f.png" alt=""></p>
<p>修改编译输出目录&nbsp; Paths&gt;Use module compile output path 转到自定义的classes文件夹</p>
<p><img src="http://images.cnitblog.com/blog/355865/201301/29155259-15fc13084bea4b95936b158d6f546473.png" alt=""></p>
<p>同样可以指定lib库目录&nbsp;&nbsp;添加&gt;jars or directories 指向创建的lib文件夹&nbsp; 弹出窗口选择jar directory<img src="http://images.cnitblog.com/blog/355865/201301/29155450-beee086f18d148ebb5480a7686cc9b8f.png" alt=""></p>
<p>&nbsp;</p>
<p>接下来&nbsp;部署测试&nbsp; 配置tomcat服务器&nbsp; 点击图&nbsp;箭头方向 那个下拉地方&nbsp;有个编辑服务器的 弹出右侧窗口</p>
<p>点击绿色的添加按钮 &gt;&nbsp;选择tomcat服务器 &gt;local</p>
<p><img src="http://images.cnitblog.com/blog/355865/201301/29160928-b7ce076af8e949178a877ac0d554bd68.png" alt=""></p>
<p>选择部署的应用</p>
<p><img src="http://images.cnitblog.com/blog/355865/201301/29162337-0e28706311fd4e34b8cc51c63b4cac58.png" alt=""></p>
<p>&nbsp;</p>
<p><img src="http://images.cnitblog.com/blog/355865/201301/29162455-100451324e694e2f81aac0b53423ce0d.png" alt=""></p>
<p>&nbsp;</p>
<p>启动测试…</p>
<p><img src="http://images.cnitblog.com/blog/355865/201301/29162525-3b11e6a77d8f42aeadd6beb5a7edf59e.png" alt=""></p>
<p>ok &gt;</p>
<p><img src="http://images.cnitblog.com/blog/355865/201301/29162653-328ea1b084644954a1980cde7c504a3b.png" alt=""></p>
<p>转自&nbsp;<a href="http://www.cnblogs.com/cnjava/archive/2013/01/29/2881654.html" target="_blank" rel="noopener">http://www.cnblogs.com/cnjava/archive/2013/01/29/2881654.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> j2ee </tag>
            
            <tag> java web </tag>
            
            <tag> Intellij IDEA </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java Collection]]></title>
      <url>/2013/04/11/Java-Collection/</url>
      <content type="html"><![CDATA[<p><span>在 Java2中，有一套设计优良的接口和类组成了Java集合框架Collection，使程序员操作成批的数据或对象元素极为方便。这些接口和类有很多对抽象数据类型操作的API，而这是我们常用的且在数据结构中熟知的。例如Map，Set，List等。并且Java用面向对象的设计对这些数据结构和算法进行了封装，这就极大的减化了程序员编程时的负担。程序员也可以以这个集合框架为基础，定义更高级别的数据抽象，比如栈、队列和线程安全的集合等，从而满足自己的需要。&nbsp;</span></p>
<p><span>Java2的集合框架，抽其核心，主要有三种：List、Set和Map。如下图所示：&nbsp;</span></p>
<p><span>需要注意的是，这里的 Collection、List、Set和Map都是接口（Interface），不是具体的类实现。 List lst = new ArrayList(); 这是我们平常经常使用的创建一个新的List的语句，在这里， List是接口，ArrayList才是具体的类。&nbsp;</span></p>
<p><span>常用集合类的继承结构如下：&nbsp;</span><br><span>Collection&lt;–List&lt;–Vector&nbsp;</span><br><span>Collection&lt;–List&lt;–ArrayList&nbsp;</span><br><span>Collection&lt;–List&lt;–LinkedList&nbsp;</span><br><span>Collection&lt;–Set&lt;–HashSet&nbsp;</span><br><span>Collection&lt;–Set&lt;–HashSet&lt;–LinkedHashSet&nbsp;</span><br><span>Collection&lt;–Set&lt;–SortedSet&lt;–TreeSet&nbsp;</span><br><span>Map&lt;–SortedMap&lt;–TreeMap&nbsp;</span><br><span>Map&lt;–HashMap&nbsp;</span></p>
<p><span>———————————————–SB分割线——————————————&nbsp;</span></p>
<p><span>List：</span><span>&nbsp;</span><br><span>List是有序的Collection，使用此接口能够精确的控制每个元素插入的位置。用户能够使用索引（元素在List中的位置，类似于数组下 &gt;标）来访问List中的元素，这类似于Java的数组。&nbsp;</span></p>
<p><span>Vector：</span><span>&nbsp;</span><br><span>基于数组（Array）的List，其实就是封装了数组所不具备的一些功能方便我们使用，所以它难易避免数组的限制，同时性能也不可能超越数组。所以，在可能的情况下，我们要多运用数组。另外很重要的一点就是Vector是线程同步的(sychronized)的，这也是Vector和ArrayList 的一个的重要区别。&nbsp;</span></p>
<p><span>ArrayList：</span><span>&nbsp;</span><br><span>同Vector一样是一个基于数组上的链表，但是不同的是ArrayList不是同步的。所以在性能上要比Vector好一些，但是当运行到多线程环境中时，可需要自己在管理线程的同步问题。&nbsp;</span></p>
<p><span>LinkedList：</span><span>&nbsp;</span><br><span>LinkedList不同于前面两种List，它不是基于数组的，所以不受数组性能的限制。&nbsp;</span><br><span>它每一个节点（Node）都包含两方面的内容：&nbsp;</span><br><span>1.节点本身的数据（data）；&nbsp;</span><br><span>2.下一个节点的信息（nextNode）。&nbsp;</span><br><span>所以当对LinkedList做添加，删除动作的时候就不用像基于数组的ArrayList一样，必须进行大量的数据移动。只要更改nextNode的相关信息就可以实现了，这是LinkedList的优势。&nbsp;</span></p>
<p><span>List总结：</span><span>&nbsp;</span></p>
<ul>
<li>所有的List中只能容纳单个不同类型的对象组成的表，而不是Key－Value键值对。例如：[ tom,1,c ]</li>
</ul>
<p>&nbsp;</p>
<ul>
<li>所有的List中可以有相同的元素，例如Vector中可以有 [ tom,koo,too,koo ]</li>
</ul>
<p>&nbsp;</p>
<ul>
<li>所有的List中可以有null元素，例如[ tom,null,1 ]</li>
</ul>
<p>&nbsp;</p>
<ul>
<li>基于Array的List（Vector，ArrayList）适合查询，而LinkedList 适合添加，删除操作</li>
</ul>
<p><span>————————————–NB分割线————————————&nbsp;</span></p>
<p><span>Set：</span><span>&nbsp;</span><br><span>Set是一种不包含重复的元素的无序Collection。&nbsp;</span></p>
<p><span>HashSet：</span><span>&nbsp;</span><br><span>虽然Set同List都实现了Collection接口，但是他们的实现方式却大不一样。List基本上都是以Array为基础。但是Set则是在 HashMap的基础上来实现的，这个就是Set和List的根本区别。HashSet的存储方式是把HashMap中的Key作为Set的对应存储项。看看 HashSet的add（Object obj）方法的实现就可以一目了然了。&nbsp;</span></p>
<div id="" class="dp-highlighter"><br><div class="bar"><br><div class="tools">Java代码&nbsp;&nbsp;<a href="http://www.cnblogs.com/tiantianbyconan/admin/" title="收藏这段代码" target="_blank" rel="noopener"><img src="http://skyuck.iteye.com/images/icon_star.png" alt="收藏代码"></a></div>

<p></p></div><p></p>
<ol>
<li><span><span class="keyword">public</span>&nbsp;<span class="keyword">boolean</span>&nbsp;add(Object&nbsp;obj)&nbsp;{&nbsp;&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>&nbsp;map.put(obj,&nbsp;PRESENT)&nbsp;==&nbsp;<span class="keyword">null</span>;&nbsp;&nbsp;&nbsp;</span></li>
<li><span>}&nbsp;&nbsp;&nbsp;</span></li></ol></div>

<p><span>这个也是为什么在Set中不能像在List中一样有重复的项的根本原因，因为HashMap的key是不能有重复的。&nbsp;</span></p>
<p><span>LinkedHashSet：</span><span>&nbsp;</span><br><span>HashSet的一个子类，一个链表。&nbsp;</span></p>
<p><span>TreeSet：</span><span>&nbsp;</span><br><span>SortedSet的子类，它不同于HashSet的根本就是TreeSet是有序的。它是通过SortedMap来实现的。&nbsp;</span></p>
<p><span>Set总结：</span><span>&nbsp;</span></p>
<ul>
<li>Set实现的基础是Map（HashMap）</li>
</ul>
<p>&nbsp;</p>
<ul>
<li>Set中的元素是不能重复的，如果使用add(Object obj)方法添加已经存在的对象，则会覆盖前面的对象</li>
</ul>
<p><span>————————————–2B分割线————————————&nbsp;</span></p>
<p><span>Map：</span><span>&nbsp;</span><br><span>Map 是一种把键对象和值对象进行关联的容器，而一个值对象又可以是一个Map，依次类推，这样就可形成一个多级映射。对于键对象来说，像Set一样，一个 Map容器中的键对象不允许重复，这是为了保持查找结果的一致性;如果有两个键对象一样，那你想得到那个键对象所对应的值对象时就有问题了，可能你得到的并不是你想的那个值对象，结果会造成混乱，所以键的唯一性很重要，也是符合集合的性质的。当然在使用过程中，某个键所对应的值对象可能会发生变化，这时会按照最后一次修改的值对象与键对应。对于值对象则没有唯一性的要求，你可以将任意多个键都映射到一个值对象上，这不会发生任何问题（不过对你的使用却可能会造成不便，你不知道你得到的到底是那一个键所对应的值对象）。&nbsp;</span></p>
<p><span>Map有两种比较常用的实现：HashMap和TreeMap。&nbsp;</span></p>
<p><span>HashMap也用到了哈希码的算法，以便快速查找一个键，&nbsp;</span></p>
<p><span>TreeMap则是对键按序存放，因此它便有一些扩展的方法，比如firstKey(),lastKey()等，你还可以从TreeMap中指定一个范围以取得其子Map。&nbsp;</span><br><span>键和值的关联很简单，用put(Object key,Object value)方法即可将一个键与一个值对象相关联。用get(Object key)可得到与此key对象所对应的值对象。&nbsp;</span></p>
<p><span>————————————–JB分割线————————————&nbsp;</span></p>
<p><span>其它：</span><span>&nbsp;</span><br><span>一、几个常用类的区别&nbsp;</span><br><span>1．ArrayList: 元素单个，效率高，多用于查询&nbsp;</span><br><span>2．Vector: 元素单个，线程安全，多用于查询&nbsp;</span><br><span>3．LinkedList:元素单个，多用于插入和删除&nbsp;</span><br><span>4．HashMap: 元素成对，元素可为空&nbsp;</span><br><span>5．HashTable: 元素成对，线程安全，元素不可为空&nbsp;</span></p>
<p><span>二、Vector、ArrayList和LinkedList&nbsp;</span><br><span>大多数情况下，从性能上来说ArrayList最好，但是当集合内的元素需要频繁插入、删除时LinkedList会有比较好的表现，但是它们三个性能都比不上数组，另外Vector是线程同步的。所以：&nbsp;</span><br><span>如果能用数组的时候(元素类型固定，数组长度固定)，请尽量使用数组来代替List；&nbsp;</span><br><span>如果没有频繁的删除插入操作，又不用考虑多线程问题，优先选择ArrayList；&nbsp;</span><br><span>如果在多线程条件下使用，可以考虑Vector；&nbsp;</span><br><span>如果需要频繁地删除插入，LinkedList就有了用武之地；&nbsp;</span><br><span>如果你什么都不知道，用ArrayList没错。&nbsp;</span></p>
<p><span>三、Collections和Arrays&nbsp;</span><br><span>在 Java集合类框架里有两个类叫做Collections（注意，不是Collection！）和Arrays，这是JCF里面功能强大的工具，但初学者往往会忽视。按JCF文档的说法，这两个类提供了封装器实现（Wrapper Implementations）、数据结构算法和数组相关的应用。&nbsp;</span><br><span>想必大家不会忘记上面谈到的&ldquo;折半查找&rdquo;、&ldquo;排序&rdquo;等经典算法吧，Collections类提供了丰富的静态方法帮助我们轻松完成这些在数据结构课上烦人的工作：&nbsp;</span><br><span>binarySearch：折半查找。&nbsp;</span></p>
<p><span>sort：排序，这里是一种类似于快速排序的方法，效率仍然是O(n * log n)，但却是一种稳定的排序方法。&nbsp;</span></p>
<p><span>reverse：将线性表进行逆序操作，这个可是从前数据结构的经典考题哦！&nbsp;</span></p>
<p><span>rotate：以某个元素为轴心将线性表&ldquo;旋转&rdquo;。&nbsp;</span></p>
<p><span>swap：交换一个线性表中两个元素的位置。&nbsp;</span><br><span>&hellip;&hellip;&nbsp;</span><br><span>Collections还有一个重要功能就是&ldquo;封装器&rdquo;（Wrapper），它提供了一些方法可以把一个集合转换成一个特殊的集合，如下：&nbsp;</span></p>
<p><span>unmodifiableXXX：转换成只读集合，这里XXX代表六种基本集合接口：Collection、List、Map、Set、SortedMap和SortedSet。如果你对只读集合进行插入删除操作，将会抛出UnsupportedOperationException异常。&nbsp;</span></p>
<p><span>synchronizedXXX：转换成同步集合。&nbsp;</span></p>
<p><span>singleton：创建一个仅有一个元素的集合，这里singleton生成的是单元素Set，&nbsp;</span><br><span>singletonList和singletonMap分别生成单元素的List和Map。&nbsp;</span></p>
<p><span>空集：由Collections的静态属性EMPTY_SET、EMPTY_LIST和EMPTY_MAP表示。&nbsp;</span></p>
<p><span>这次关于Java集合类概述就到这里，下一次我们来讲解Java集合类的具体应用，如List排序、删除重复元素。</span></p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java数据结构和算法——汉诺塔问题]]></title>
      <url>/2013/03/04/Java%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95%E2%80%94%E2%80%94%E6%B1%89%E8%AF%BA%E5%A1%94%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.tiantian.algorithms;<br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
     _|<em>1              |                |<br> <em>   <strong>|</strong>2             |                |
 </em>  __</em>|<strong>_3            |                |            (1).把A上的4个木块移动到C上。<br> * __</strong>|<strong>_<em>4           |                |<br> <em>     A                B                C
 </em><br> <em>     |                |                |
 </em>     |               </em>|_1              |<br> *     |              </strong>|<strong>2             |            要完成(1)的效果，必须要把1、2、3木块移动到B，这样才能把4移动到C<br> * __</strong>|<strong>_<em>4        </em></strong>|<strong><em>3            |            如：代码中的&ldquo;调用(XX)&rdquo;<br> <em>     A                B                C
 </em><br> <em>     |                |                |
 </em>     |               </em>|_1              |<br> *     |              </strong>|<strong>2             |            此时，题目就变成了把B上的3个木块移动到C上，回到了题目(1)<br> *     |             _</strong>|<strong>_3        __</strong>|____4        如：代码中的&ldquo;调用(YY)&rdquo;<br> <em>     A                B                C
 </em><br> <em>     然后循环这个过程
 </em><br> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie
  </span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2013-3-4 下午4:09:53<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> HanoiTowerTest {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br>        doTowers(</span>4, ‘A’, ‘B’, ‘C’<span style="color: #000000;">);<br>    }<br><br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> doTowers(<span style="color: #0000ff;">int</span> topN, <span style="color: #0000ff;">char</span> from, <span style="color: #0000ff;">char</span> inter, <span style="color: #0000ff;">char</span><span style="color: #000000;"> to){<br>        </span><span style="color: #0000ff;">if</span>(topN == 1<span style="color: #000000;">){<br>            System.out.println(</span>“最后把木块1从” + from + “移动到” +<span style="color: #000000;"> to);<br>        }</span><span style="color: #0000ff;">else</span><span style="color: #000000;">{<br>            doTowers(topN </span>- 1, from, to, inter); <span style="color: #008000;">//</span><span style="color: #008000;"> 调用(XX)</span><br>            System.out.println(“把木块” + topN + “从” + from + “移动到” +<span style="color: #000000;"> to);<br>            doTowers(topN </span>- 1, inter, from ,to); <span style="color: #008000;">//</span><span style="color: #008000;"> 调用(YY)</span><br><span style="color: #000000;">        }<br><br>    }<br>}</span></pre><br></div>

<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Struts+iBatis+Spring+mysql整合开发]]></title>
      <url>/2013/03/03/Struts-iBatis-Spring-mysql%E6%95%B4%E5%90%88%E5%BC%80%E5%8F%91/</url>
      <content type="html"><![CDATA[<p><span style="line-height: 1.5;">本文使用Struts+iBatis+Spring三层框架开实现对user表的CRUD。</span></p>
<p><span style="line-height: 1.5;">分层如下：</span></p>
<p><img src="http://images.cnitblog.com/blog/378300/201303/03145921-9115e3b0b60448bab6e391c5233f80c8.jpg" alt=""></p>
<p>&nbsp;</p>
<p><span style="line-height: 1.5;">iBatis配置文件（sqlMapConfig.xml）：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”UTF-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE sqlMapConfig<br>    PUBLIC “-//ibatis.apache.org//DTD SQL Map Config 2.0//EN”<br>    “<a href="http://ibatis.apache.org/dtd/sql-map-config-2.dtd" target="_blank" rel="noopener">http://ibatis.apache.org/dtd/sql-map-config-2.dtd</a>“</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">sqlMapConfig</span><span style="color: #0000ff;">&gt;</span><br><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">settings </span><span style="color: #ff0000;">cacheModelsEnabled</span><span style="color: #0000ff;">=”true”</span><span style="color: #ff0000;"> enhancementEnabled</span><span style="color: #0000ff;">=”true”</span><span style="color: #ff0000;"><br>        lazyLoadingEnabled</span><span style="color: #0000ff;">=”true”</span><span style="color: #ff0000;"> errorTracingEnabled</span><span style="color: #0000ff;">=”true”</span><span style="color: #ff0000;"> maxRequests</span><span style="color: #0000ff;">=”32”</span><span style="color: #ff0000;"><br>        maxSessions</span><span style="color: #0000ff;">=”10”</span><span style="color: #ff0000;"> maxTransactions</span><span style="color: #0000ff;">=”5”</span><span style="color: #ff0000;"> useStatementNamespaces</span><span style="color: #0000ff;">=”false”</span> <span style="color: #0000ff;">/&gt;</span><br><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">sqlMap </span><span style="color: #ff0000;">resource</span><span style="color: #0000ff;">=”com/tiantian/ibatis/model/user.xml”</span> <span style="color: #0000ff;">/&gt;</span><br><br><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">sqlMapConfig</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>&nbsp;</p>
<p>struts.xml：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”UTF-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE struts PUBLIC<br>    “-//Apache Software Foundation//DTD Struts Configuration 2.3//EN”<br>    “<a href="http://struts.apache.org/dtds/struts-2.3.dtd" target="_blank" rel="noopener">http://struts.apache.org/dtds/struts-2.3.dtd</a>“</span><span style="color: #0000ff;">&gt;</span><br><br><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">struts</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">package </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”ibatis_test”</span><span style="color: #ff0000;"> extends</span><span style="color: #0000ff;">=”struts-default”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 注册User action </span><span style="color: #008000;">–&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">action </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”registerUser”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”registerUserAction”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">action</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 删除User action </span><span style="color: #008000;">–&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">action </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”deleteUser”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”deleteUserAction”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">action</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 更新User action </span><span style="color: #008000;">–&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">action </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”updateUser”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”updateUserAction”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">action</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 查询所有User action </span><span style="color: #008000;">–&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">action </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”findAllUsers”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”findAllUsersAction”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">action</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 查询指定id的User action </span><span style="color: #008000;">–&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">action </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”findUserById”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”findUserByIdAction”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">action</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 模糊查询User action </span><span style="color: #008000;">–&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">action </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”findUsersBykeyword”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”findUsersBykeywordAction”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">action</span><span style="color: #0000ff;">&gt;</span><br><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">package</span><span style="color: #0000ff;">&gt;</span><br><br><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">struts</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>&nbsp;</p>
<p>user.xml配置文件：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”UTF-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE sqlMap<br>    PUBLIC “-//ibatis.apache.org//DTD SQL Map 2.0//EN”<br>    “<a href="http://ibatis.apache.org/dtd/sql-map-2.dtd" target="_blank" rel="noopener">http://ibatis.apache.org/dtd/sql-map-2.dtd</a>“</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">sqlMap</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 为Student类取个别名 </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">typeAlias </span><span style="color: #ff0000;">alias</span><span style="color: #0000ff;">=”UserAlias”</span><span style="color: #ff0000;"> type</span><span style="color: #0000ff;">=”com.tiantian.ibatis.model.User”</span><span style="color: #0000ff;">/&gt;</span><br><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 配置表和实体Bean之间的映射关系 </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">resultMap </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”userMap”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”com.tiantian.ibatis.model.User”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">result </span><span style="color: #ff0000;">property</span><span style="color: #0000ff;">=”id”</span><span style="color: #ff0000;"> column</span><span style="color: #0000ff;">=”id”</span><span style="color: #0000ff;">/&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">result </span><span style="color: #ff0000;">property</span><span style="color: #0000ff;">=”username”</span><span style="color: #ff0000;"> column</span><span style="color: #0000ff;">=”username”</span><span style="color: #0000ff;">/&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">result </span><span style="color: #ff0000;">property</span><span style="color: #0000ff;">=”password”</span><span style="color: #ff0000;"> column</span><span style="color: #0000ff;">=”password”</span><span style="color: #0000ff;">/&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">result </span><span style="color: #ff0000;">property</span><span style="color: #0000ff;">=”age”</span><span style="color: #ff0000;"> column</span><span style="color: #0000ff;">=”age”</span><span style="color: #0000ff;">/&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">resultMap</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 添加数据 </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">insert </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”registerUser”</span><span style="color: #ff0000;"> parameterClass</span><span style="color: #0000ff;">=”UserAlias”</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;"><br>        INSERT INTO user VALUES (NULL, #username#, #password#, #age#);<br>    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">insert</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 删除指定id的数据 </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">delete </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”deleteUser”</span><span style="color: #ff0000;"> parameterClass</span><span style="color: #0000ff;">=”UserAlias”</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;"><br>        DELETE FROM user WHERE id = #id#;<br>    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">delete</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 修改指定id的数据 </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">update </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”updateUser”</span><span style="color: #ff0000;"> parameterClass</span><span style="color: #0000ff;">=”UserAlias”</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;"><br>        UPDATE user<br>        SET username = #username#, password = #password#, age = #age#<br>        WHERE id = #id#;<br>    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">update</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 查询所有User信息 </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">select </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”findAllUsers”</span><span style="color: #ff0000;"> resultMap</span><span style="color: #0000ff;">=”userMap”</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;"><br>        SELECT <em> FROM user;<br>    </em></span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">select</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 查询指定id的User信息 </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">select </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”findUserById”</span><span style="color: #ff0000;"> resultMap</span><span style="color: #0000ff;">=”userMap”</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;"><br>        SELECT  FROM user WHERE id = #id#;<br>    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">select</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 模糊查询 </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">select </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”findUsersByKeyword”</span><span style="color: #ff0000;"> resultMap</span><span style="color: #0000ff;">=”userMap”</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;"><br>        SELECT * FROM user WHERE username LIKE ‘%$keyword$%’;<br>    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">select</span><span style="color: #0000ff;">&gt;</span><br><br><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">sqlMap</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>&nbsp;</p>
<p>applicationContext.xml配置文件：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”UTF-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">beans </span><span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">=”<a href="http://www.springframework.org/schema/beans" target="_blank" rel="noopener">http://www.springframework.org/schema/beans</a>“</span><span style="color: #ff0000;"><br>    xmlns:xsi</span><span style="color: #0000ff;">=”<a href="http://www.w3.org/2001/XMLSchema-instance" target="_blank" rel="noopener">http://www.w3.org/2001/XMLSchema-instance</a>“</span><span style="color: #ff0000;"> xmlns:p</span><span style="color: #0000ff;">=”<a href="http://www.springframework.org/schema/p" target="_blank" rel="noopener">http://www.springframework.org/schema/p</a>“</span><span style="color: #ff0000;"><br>    xsi:schemaLocation</span><span style="color: #0000ff;">=”<a href="http://www.springframework.org/schema/beans" target="_blank" rel="noopener">http://www.springframework.org/schema/beans</a> <a href="http://www.springframework.org/schema/beans/spring-beans-3.0.xsd" target="_blank" rel="noopener">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</a>“</span><span style="color: #0000ff;">&gt;</span><br><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”dataSource”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”org.apache.commons.dbcp.BasicDataSource”</span><span style="color: #ff0000;"><br>        destroy-method</span><span style="color: #0000ff;">=”close”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”driverClassName”</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">=”com.mysql.jdbc.Driver”</span> <span style="color: #0000ff;">/&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”url”</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">=”jdbc:mysql://localhost:3306/test”</span> <span style="color: #0000ff;">/&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”username”</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">=”root”</span> <span style="color: #0000ff;">/&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”password”</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">=”XXXX”</span> <span style="color: #0000ff;">/&gt;</span><br><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”validationQuery”</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">=”select user.id from user”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”maxIdle”</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">=”15”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”maxActive”</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">=”15”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”maxWait”</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">=”1000”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span><br><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”sqlMapClient”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”org.springframework.orm.ibatis.SqlMapClientFactoryBean”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”configLocation”</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">=”classpath:sqlMapConfig.xml”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”dataSource”</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">=”dataSource”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span><br><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 事务管理 </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”transactionManager”</span><span style="color: #ff0000;"><br>        class</span><span style="color: #0000ff;">=”org.springframework.jdbc.datasource.DataSourceTransactionManager”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”dataSource”</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">=”dataSource”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span><br><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> 声明式事务管理 </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”baseTransactionProxy”</span><span style="color: #ff0000;"><br>        class</span><span style="color: #0000ff;">=”org.springframework.transaction.interceptor.TransactionProxyFactoryBean”</span><span style="color: #ff0000;"><br>        abstract</span><span style="color: #0000ff;">=”true”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”transactionManager”</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">=”transactionManager”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”transactionAttributes”</span><span style="color: #0000ff;">&gt;</span><br>            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">props</span><span style="color: #0000ff;">&gt;</span><br>                <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"><br>                    表示设置事务属性所有以”find”和”get”开头的方法：<br>                    - PROPAGATION_REQUIRED: 当前存在事务则使用存在的事务，如果不存在，则开启一个新的事务<br>                    - readOnly:表示只读的事务<br>                 </span><span style="color: #008000;">–&gt;</span><br>                <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">prop </span><span style="color: #ff0000;">key</span><span style="color: #0000ff;">=”find<em>“</em></span><span style="color: #0000ff;">&gt;</span>PROPAGATION_REQUIRED,readOnly<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">prop</span><span style="color: #0000ff;">&gt;</span><br>                <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">prop </span><span style="color: #ff0000;">key</span><span style="color: #0000ff;">=”get“</span><span style="color: #0000ff;">&gt;</span>PROPAGATION_REQUIRED,readOnly<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">prop</span><span style="color: #0000ff;">&gt;</span><br>                <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">prop </span><span style="color: #ff0000;">key</span><span style="color: #0000ff;">=”<em>“</em></span><span style="color: #0000ff;">&gt;</span>PROPAGATION_REQUIRED<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">prop</span><span style="color: #0000ff;">&gt;</span><br>            <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">props</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> <strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong>以上一般只需修改数据库配置<strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong> </span><span style="color: #008000;">–&gt;</span><br><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> <strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong>DAO<strong><strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong></strong> </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> DAO、Service一般都配置成singleton（可以不写，因为默认是singleton） </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”userDao”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”com.tiantian.ibatis.dao.impl.UserDaoImpl”</span><span style="color: #ff0000;"> scope</span><span style="color: #0000ff;">=”singleton”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”sqlMapClient”</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">=”sqlMapClient”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span><br><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> <strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong>Service<strong><strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong></strong> </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> Service，没有事务功能 </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”userServiceTarget”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”com.tiantian.ibatis.service.impl.UserServiceImpl”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”userDao”</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">=”userDao”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> Service的代理，目的是为Service添加事务的功能 </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”userService”</span><span style="color: #ff0000;"> parent</span><span style="color: #0000ff;">=”baseTransactionProxy”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”target”</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">=”userServiceTarget”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span><br><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> <strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong>Action<strong><strong><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong></strong></strong> </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><em>**</em></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong> </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> Action一般都配置成prototype（必须要写!） </span><span style="color: #008000;">–&gt;</span><br><span style="color: #008000;">&lt;!–</span><span style="color: #008000;"> <strong>User Actions</strong> </span><span style="color: #008000;">–&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”registerUserAction”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”com.tiantian.ibatis.action.user.RegisterUserAction”</span><span style="color: #ff0000;"> scope</span><span style="color: #0000ff;">=”prototype”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”userService”</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">=”userService”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”deleteUserAction”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”com.tiantian.ibatis.action.user.DeleteUserAction”</span><span style="color: #ff0000;"> scope</span><span style="color: #0000ff;">=”prototype”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”userService”</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">=”userService”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”updateUserAction”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”com.tiantian.ibatis.action.user.UpdateUserAction”</span><span style="color: #ff0000;"> scope</span><span style="color: #0000ff;">=”prototype”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”userService”</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">=”userService”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”findAllUsersAction”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”com.tiantian.ibatis.action.user.FindAllUsersAction”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”userService”</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">=”userService”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”findUserByIdAction”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”com.tiantian.ibatis.action.user.FindUserByIdAction”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”userService”</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">=”userService”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">=”findUsersBykeywordAction”</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">=”com.tiantian.ibatis.action.user.FindUsersByKeywordAction”</span><span style="color: #0000ff;">&gt;</span><br>        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”userService”</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">=”userService”</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span><br><br><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">beans</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>&nbsp;</p>
<p>DAO接口：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2013-3-1 下午5:44:21<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> UserDao {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> registerUser(User user);<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> deleteUser(User user);<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> updateUser(User user);<br>    </span><span style="color: #0000ff;">public</span> List&lt;User&gt;<span style="color: #000000;"> findAllUsers();<br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> User findUserById(User user);<br>    </span><span style="color: #0000ff;">public</span> List&lt;User&gt;<span style="color: #000000;"> findUsersByKeyword(String keyword);<br>}</span></pre><br></div>

<p>DAO实现类（执行各个Action所需的数据库查询操作）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.tiantian.ibatis.dao.impl;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.orm.ibatis.support.SqlMapClientDaoSupport;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.tiantian.ibatis.dao.UserDao;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.tiantian.ibatis.model.User;<br><br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2013-3-1 下午6:09:53<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> UserDaoImpl <span style="color: #0000ff;">extends</span> SqlMapClientDaoSupport <span style="color: #0000ff;">implements</span><span style="color: #000000;"> UserDao{<br><br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> registerUser(User user) {<br>        getSqlMapClientTemplate().insert(</span>“registerUser”<span style="color: #000000;">, user);<br>    }<br><br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> deleteUser(User user) {<br>        </span><span style="color: #0000ff;">boolean</span> result = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>        </span><span style="color: #0000ff;">int</span> effectedRow = getSqlMapClientTemplate().delete(“deleteUser”<span style="color: #000000;">, user);<br>        System.out.println(</span>“delete effectedRow: “ +<span style="color: #000000;"> effectedRow);<br>        result </span>= effectedRow &gt; 0 ? <span style="color: #0000ff;">true</span> : <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> result;<br>    }<br><br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> updateUser(User user) {<br>        </span><span style="color: #0000ff;">boolean</span> result = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>        </span><span style="color: #0000ff;">int</span> effectedRow = getSqlMapClientTemplate().update(“updateUser”<span style="color: #000000;">, user);<br>        System.out.println(</span>“update effectedRow: “ +<span style="color: #000000;"> effectedRow);<br>        result </span>= effectedRow &gt; 0 ? <span style="color: #0000ff;">true</span> : <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> result;<br>    }<br><br>    </span><span style="color: #0000ff;">public</span> List&lt;User&gt;<span style="color: #000000;"> findAllUsers() {<br>        </span><span style="color: #0000ff;">return</span> (List&lt;User&gt;)getSqlMapClientTemplate().queryForList(“findAllUsers”<span style="color: #000000;">);<br>    }<br><br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> User findUserById(User user) {<br>        </span><span style="color: #0000ff;">return</span> (User) getSqlMapClientTemplate().queryForObject(“findUserById”<span style="color: #000000;">, user);<br>    }<br><br>    </span><span style="color: #0000ff;">public</span> List&lt;User&gt;<span style="color: #000000;"> findUsersByKeyword(String keyword) {<br>        </span><span style="color: #0000ff;">return</span> (List&lt;User&gt;)getSqlMapClientTemplate().queryForList(“findUsersByKeyword”<span style="color: #000000;">, keyword);<br>    }<br><br>}</span></pre><br></div>

<p>Action类（以RegisterUserAction为例）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.tiantian.ibatis.action.user;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.opensymphony.xwork2.ActionSupport;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.tiantian.ibatis.model.User;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.tiantian.ibatis.service.UserService;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.tiantian.ibatis.service.impl.UserServiceImpl;<br><br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2013-3-2 下午11:26:18<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> RegisterUserAction <span style="color: #0000ff;">extends</span><span style="color: #000000;"> ActionSupport{<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> UserService userService;<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> User user;<br><br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> User getUser() {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> user;<br>    }<br><br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setUser(User user) {<br>        </span><span style="color: #0000ff;">this</span>.user =<span style="color: #000000;"> user;<br>    }<br><br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> UserService getUserService() {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> userService;<br>    }<br><br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setUserService(UserService userService) {<br>        </span><span style="color: #0000ff;">this</span>.userService =<span style="color: #000000;"> userService;<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> String execute() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {<br>        userService.registerUser(user);<br>        System.out.println(</span>“数据已经插入”<span style="color: #000000;">);<br>        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>    }<br>}</span></pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> database </tag>
            
            <tag> j2ee </tag>
            
            <tag> java web </tag>
            
            <tag> struts </tag>
            
            <tag> ibatis </tag>
            
            <tag> spring </tag>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[svn的使用]]></title>
      <url>/2013/02/27/svn%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
      <content type="html"><![CDATA[<p>新建如下结构的文件夹：<br>sv_workspace<br>    |–svn_repos<br>    |–svn_imports<br>    |–svn_checkouts</p>
<p>svn_repos：中创建各种版本库（一个项目使用一个版本库）<br>svn_imports：导入最初始的项目<br>svn_checkouts：从版本库中检出的项目，真正的工作目录</p>
<p>1.先在svn_repos中新建版本库，如：infolife_repo，右键在此创建版本库。<br>2.在svn_imports文件夹中新建对应的文件夹检出，如：infolife_import。<br>右键检出，此时该文件夹会生成branches、tags、trunk和一个.svn的文件夹<br>3。.在eclipse中新建项目后，把项目复制到svn_imports目录的truck目录下，</p>
<p>然后右键导入，url写版本库的truck目录</p>
<p>4.最后在工作目录（svn_checkouts）新建一个目录比如c:\svnclient\rolex</p>
<p>\trunk，然后在trunk上checkout出svn://IP/infolife/trunk上的内容。<br>或者在使用eclipse的import，检出目录选择svn_checkouts即可</p>
]]></content>
      
        
        <tags>
            
            <tag> svn </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[看书笔记]《深入java虚拟机》——java体系结构（二）]]></title>
      <url>/2013/02/24/%E7%9C%8B%E4%B9%A6%E7%AC%94%E8%AE%B0-%E3%80%8A%E6%B7%B1%E5%85%A5java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B%E2%80%94%E2%80%94java%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>java虚拟机的三种含义：</p>
<ul>
<li>抽象的规范</li>
<li>一个具体的实现</li>
<li>一个运行中的虚拟机实例</li>
</ul>
<p>———————java虚拟机的生命周期：<br>java虚拟机实例的天职就是负责运行一个java程序。<br>启动一个java程序，一个虚拟机实例诞生了；程序关闭退出，虚拟机消亡。<br>有几个java程序正在运行，就有几个java虚拟机实例。每个java程序都运行在自己的java虚拟机实例中。</p>
<p>java虚拟机中有两种线程：</p>
<ul>
<li>守护线程：由虚拟机自己使用的（执行垃圾收集线程），java程序也可以把任何线程标记为守护线程。</li>
<li>非守护线程：main()这种。</li>
</ul>
<p>非守护线程都终止时，虚拟机实例才自动退出。（也可以调用Runtime或System的exit()方法退出程序）。</p>
<p>———————java虚拟机的体系结构：<br>见同目录第五章.Java虚拟机-体系结构图！<br>方法区和堆是该虚拟机实例的所有线程共享的。<br>当虚拟机装载一个class文件时，他会从这个class文件包含的二进制数据中解析类型信息，然后把这些类型信息放到方法区中。<br>当程序运行时，虚拟机会把所有该程序在运行时创建的对象都放到堆中。</p>
<p>每个新线程被创建时，他都将得到它自己的PC寄存器以及一个java栈（不是所有线程共享）。<br>java虚拟机为每个线程创建内存区，这些内存区域是私有的，任何线程都不能访问另一个线程的PC寄存器或者java栈。<br>如果线程正在执行的是一个java方法（非本地方法），那么PC寄存器的值将总是指示下一条将被执行的指令。<br>java栈则总是存储该线程中java方法调用的状态（局部变量、被调用时传进来的参数、返回值、运算的中间结果）</p>
<p>本地方法调用的状态则是以某种依赖于具体实现的方式存储在本地方法栈中，也可能在寄存器或者其他某些特定实现相关的内存区中。</p>
<p>———————栈帧（1）：<br>java栈上由许多栈帧（帧）组成的，一个栈帧包含一个java方法调用的状态。<br>当线程调用一个java方法时，虚拟机压入一个新的栈帧到该线程的java栈中；当方法返回时，这个栈帧被从java栈中弹出并抛弃。</p>
<p>java虚拟机没有寄存器，其指令集使用java栈来存储中间数据（为了平台无关性）。</p>
<p>———————类型数据<br>类型数据分为来那个中：<br>基本类型：float、double、byte、short、int、long、char、boolean<br>引用类型：reference（类引用、接口引用、数组引用）<br>注意：编译成字节码时boolean用int表示，</p>
<p>java虚拟机中，最基本的数据单元就是字，至少选择32位作为字长。<br>运行时数据区的大部分内容，都是基于&ldquo;字&rdquo;这个抽象概念的。</p>
<p>———————类装载器子系统：<br>类装载器的装载、连接和初始化：</p>
<ul>
<li>装载：查找并装载类型的二进制数据</li>
<li>连接：执行验证，准备，以及解析（可选）。<br>  验证：确保被导入类型的正确性。<br>  准备：为静态变量分配内存，并将其初始化为默认值。<br>  解析：把类型中的符号引用转换为直接引用。</li>
<li>初始化：把静态变量初始化为正确初始值。</li>
</ul>
<p>启动类装载器：<br>只要是符合java class文件格式的二进制文件，java虚拟机实现都必须能够从中辨别并装载器中的类和接口。每个java虚拟机实现必须有一个启动类加载器来加载受信任的类，比如java API。</p>
<p>用户自定义类装载器：<br>用户自定义的类装载器是普通的java对象，它的类必须派生自java.lang.ClassLoader类。ClassLoader类中定义的方法为程序提供了访问类装载器机制的接口。<br>用户自定义类装载器和Class类的实例都放在内存中的堆区，而装载的类型信息则都位于方法区。</p>
<p>ClassLoader类的四个通往java虚拟机的方法：<br>protected final Class defineClass(String name, byte data[], int offset, int length);<br>接收一个名为data[]的字节数组，并且在data[offset]到data[data+length]之间的二进制数据必须符合java class格式（表示一个新的可用类），name是该类型的全限定名，并将赋以默认的保护域。注意：该方法返回Class对象实例时表示指定的class文件已经被找到并装载到了方法区（不一定连接和初始化）</p>
<p>protected final Class defineClass(String name, byte data[], int offset, int length,<br>ProtectionDomain protectionDomain);<br>与前面一样，只是，该类型的保护域将由它的protectionDomain参数指定。</p>
<p>protected final Class findSystemClass(String name);<br>接收一个字符串name（该类型的全限定名），用于启动系统类装载器（必须保证能启动）。</p>
<p>protected final void resolveClass(Class c);<br>接收一个Class实例的引用作为参数，它将对该Class实例表示的类型执行连接动作（必须保证能执行连接动作）。</p>
<p>———————方法区：<br>所有线程都共享方法区，所以它们对方法区数据的访问必须被设计为是线程安全的。<br>方法区的大小不必说固定的，虚拟机可以根据应用的需要动态调整。<br>方法区不必是连续的。<br>方法区也可以被垃圾收集。</p>
<p>类型信息：<br>对每个装载的类型，虚拟机都会在方法区中存储一下类型信息：</p>
<ul>
<li>该类型全限定名</li>
<li>该类型的直接超类的全限定名（除非是Object类，没有超类）</li>
<li>该类型是类类型还是接口类型</li>
<li>该类型的访问修饰符（public、abstract、final的某个子集）</li>
<li><p>任何型直接超接口的全限定名的有序列表</p>
</li>
<li><p>该类型的常量池【核心】：所有常量的类型字段方法的符号引用(索引访问)</p>
</li>
<li>字段信息：字段名，字段类型，字段修饰符</li>
<li>方法信息：方法名，返回类型，参数数量和类型(按序)，方法修饰符</li>
<li>除了常量以外的静态变量</li>
<li>一个到类ClassLoader的引用：跟踪保存该类加载时所用的加载器的类别</li>
<li>一个到Class类的引用：虚拟机会创建一个相应的java.lang.Class类的实例</li>
</ul>
<p>———————方法表：<br>方法表：类型数据结构<br>虚拟机为每个非抽象类都生成一个表，把它作为类信息的一部分保存在方法区。<br>方法表是一个数组，元素是所有它的实例可能被调用的实例方法的直接引用<br>，包括是超类直接继承过来的方法。运行时可以通过方法表快速搜寻在对象中调用的实例方法。</p>
<p>———————堆：<br>java程序在运行时创建的所有类实例或数组都放在同一个堆中（要考虑线程同步问题）。<br>和方法区一样，堆空间也不是连续的内存区。</p>
<p>———————数组：<br>数组的内部表示：<br>在java中，数组才是真正的对象<br>和其他对象一样，数组总是存储在堆中。<br>和其他对象一样，数组也有一个与他们的类关联的Class实例，所有具有相同维度和类型的数组都是同一个类的实例（不管数组的长度是多少）。</p>
<p>数组类的名称由两部分组成，每一维度用一个”[“表示，用字符或字符串表示元素类型。如&ldquo;[[Ljava/lang/Object&rdquo;表示元素为Object的二维数组。</p>
<p>在堆中，每一个数组对象还必须要保存数组的长度、数组数据以及某些指向数组的类数据的引用。</p>
<p>———————程序计数器（PC寄存器）：<br>每一个线程都有它自己的PC寄存器，它是在该线程启动的时候创建的。<br>PC寄存器的大小是字长，因此能够持有一个本地指针，也能够持有一个returnAddress。当线程执行某个java方法时，PC寄存器的内容总是写一条将被执行的指令的地址，这里的地址可以是个本地指针，也可以是在方法字节码中相对于该方法其实指令的偏移量。如果该线程正在执行一个本地方法，此时PC寄存器的值是&ldquo;undefined&rdquo;。</p>
<p>———————Java栈：<br>每当启动一个新线程时，java虚拟机都会为它分配一个java栈。<br>虚拟机智慧直接对java栈执行两种操作：以帧为单位的压栈或出栈。<br>每当线程调用一个java方法时，虚拟机都会在该java栈中压入一个新帧。<br>java方法不管是正常返回还是抛异常中止，虚拟机都会将当前栈弹出java栈，然后释放内存。</p>
<p>java栈和栈帧在内存中也不必说连续的。</p>
<p>———————栈帧（2）：<br>栈帧的构成：</p>
<ul>
<li><p>局部变量区：</p>
<pre><code>是一个以字长为单位，从0开始计数的数组。字节码指令通过从0开始的索引来使用其中的数据。
 int、float、reference和returnAddress的值在数组中只占一项；
 byte、short、char的值在存入数组前都被转换成int，所以也只占一项；
 boolean虚拟机不支持，用int来表示，所以也只占一项；
 long、double的值在数组中占两项（使用只要指出第一项索引值）。
 局部变量区包含对应的方法参数和局部变量。
 按参数的顺序来存入局部变量数组中。真正的局部变量顺序任意。
</code></pre></li>
<li><p>操作数栈：</p>
<pre><code>是一个以字节为单位的数组（不是通过索引来访问），是通过标准的栈操作（压栈和出栈）来访问。
存储的数据类型和局部变量区的一样。
虚拟机把操作数栈作为他的工作区，大多数指令都要从这里弹出数据，执行计算，然后把结果压回到操作数栈中。
</code></pre></li>
<li><p>帧数据区：</p>
<pre><code>常量池解析、正常方法返回、异常派发机制。
每当虚拟机要执行某个需要用到常量池数据的指令时，它都会通过帧数据区中指向常量池的指针来访问它。
帧数据区还要帮助虚拟机处理java方法的正常结束或异常中止：
如果正常结束：虚拟机必须恢复发起调用的方法的（上一个）栈帧，调用完成方法的指令的下一个指令。如果有返回值，虚拟机将把返回值压倒发
</code></pre></li>
</ul>
<p>起调用的方法的操作数栈。<br>         如果抛出异常，根据帧数据区的异常表来处理。如果有catch语句，就会交给catch中的代码，如果没有，则立即异常中止。</p>
<p>———————本地方法栈：<br>当线程调用本地方法时，虚拟机会保持java栈不变，不再在线程的java栈中压入新的帧，虚拟机只是简单地动态连接并直接调用指定的本地方法。</p>
<p>就像其他运行时内存区一样，本地方法栈占用的内存区也不必说固定大小的，它可以根据需要动态扩展或者收缩。</p>
<p>———————执行引擎：<br>任何java虚拟机实现的核心都是它的执行引擎。<br>在java虚拟机规范中，执行引擎的行为使用指令集来定义。<br>作为运行时实例的执行引擎就是一个线程。<br>运行中java程序的每一个线程都是一个独立的虚拟机执行引擎的实例。从生命周期的开始到结束，它要么在执行字节码，要么在执行本地方法。</p>
<p><img src="http://images.cnitblog.com/blog/378300/201302/24100155-fc24aa95237c49d8b70f462592324040.jpg" alt=""></p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> JVM </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[lucene 使用教程]]></title>
      <url>/2013/02/24/lucene-%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/</url>
      <content type="html"><![CDATA[<p><span>1 lucene简介&nbsp;</span><br><span>1.1 什么是lucene&nbsp;</span><br><span>Lucene是一个全文搜索框架，而不是应用产品。因此它并不像</span><a href="http://www.baidu.com/" target="_blank" rel="noopener"><span>http://www.baidu.com/</span></a><span>&nbsp;或者google Desktop那么拿来就能用，它只是提供了一种工具让你能实现这些产品。</span></p>
<p><span>1.2 lucene能做什么&nbsp;</span><br><span>要回答这个问题，先要了解lucene的本质。实际上lucene的功能很单一，说到底，就是你给它若干个字符串，然后它为你提供一个全文搜索服务，告诉你你要搜索的关键词出现在哪里。知道了这个本质，你就可以发挥想象做任何符合这个条件的事情了。你可以把站内新闻都索引了，做个资料库；你可以把一个数据库表的若干个字段索引起来，那就不用再担心因为&ldquo;%like%&rdquo;而锁表了；你也可以写个自己的搜索引擎&hellip;&hellip;</span></p>
<p><span>1.3 你该不该选择lucene&nbsp;</span><br><span>下面给出一些测试数据，如果你觉得可以接受，那么可以选择。&nbsp;</span><br><span>测试一：250万记录，300M左右文本，生成索引380M左右，800线程下平均处理时间300ms。&nbsp;</span><br><span>测试二：37000记录，索引数据库中的两个varchar字段，索引文件2.6M，800线程下平均处理时间1.5ms。</span></p>
<p><span>2 lucene的工作方式&nbsp;</span><br><span>lucene提供的服务实际包含两部分：一入一出。所谓入是写入，即将你提供的源（本质是字符串）写入索引或者将其从索引中删除；所谓出是读出，即向用户提供全文搜索服务，让用户可以通过关键词定位源。</span></p>
<p><span>2.1写入流程&nbsp;</span><br><span>源字符串首先经过analyzer处理，包括：分词，分成一个个单词；去除stopword（可选）。&nbsp;</span><br><span>将源中需要的信息加入Document的各个Field中，并把需要索引的Field索引起来，把需要存储的Field存储起来。&nbsp;</span><br><span>将索引写入存储器，存储器可以是内存或磁盘。</span></p>
<p><span>2.2读出流程&nbsp;</span><br><span>用户提供搜索关键词，经过analyzer处理。&nbsp;</span><br><span>对处理后的关键词搜索索引找出对应的Document。&nbsp;</span><br><span>用户根据需要从找到的Document中提取需要的Field。</span></p>
<p><span>3 一些需要知道的概念&nbsp;</span><br><span>lucene用到一些概念，了解它们的含义，有利于下面的讲解。</span></p>
<p><span>3.1 analyzer&nbsp;</span><br><span>Analyzer 是分析器，它的作用是把一个字符串按某种规则划分成一个个词语，并去除其中的无效词语，这里说的无效词语是指英文中的&ldquo;of&rdquo;、 &ldquo;the&rdquo;，中文中的 &ldquo;的&rdquo;、&ldquo;地&rdquo;等词语，这些词语在文章中大量出现，但是本身不包含什么关键信息，去掉有利于缩小索引文件、提高效率、提高命中率。&nbsp;</span><br><span>分词的规则千变万化，但目的只有一个：按语义划分。这点在英文中比较容易实现，因为英文本身就是以单词为单位的，已经用空格分开；而中文则必须以某种方法将连成一片的句子划分成一个个词语。具体划分方法下面再详细介绍，这里只需了解分析器的概念即可。</span></p>
<p><span>3.2 document&nbsp;</span><br><span>用户提供的源是一条条记录，它们可以是文本文件、字符串或者数据库表的一条记录等等。一条记录经过索引之后，就是以一个Document的形式存储在索引文件中的。用户进行搜索，也是以Document列表的形式返回。</span></p>
<p><span>3.3 field&nbsp;</span><br><span>一个Document可以包含多个信息域，例如一篇文章可以包含&ldquo;标题&rdquo;、&ldquo;正文&rdquo;、&ldquo;最后修改时间&rdquo;等信息域，这些信息域就是通过Field在Document中存储的。&nbsp;</span><br><span>Field有两个属性可选：存储和索引。通过存储属性你可以控制是否对这个Field进行存储；通过索引属性你可以控制是否对该Field进行索引。这看起来似乎有些废话，事实上对这两个属性的正确组合很重要，下面举例说明：&nbsp;</span><br><span>还是以刚才的文章为例子，我们需要对标题和正文进行全文搜索，所以我们要把索引属性设置为真，同时我们希望能直接从搜索结果中提取文章标题，所以我们把标题域的存储属性设置为真，但是由于正文域太大了，我们为了缩小索引文件大小，将正文域的存储属性设置为假，当需要时再直接读取文件；我们只是希望能从搜索解果中提取最后修改时间，不需要对它进行搜索，所以我们把最后修改时间域的存储属性设置为真，索引属性设置为假。上面的三个域涵盖了两个属性的三种组合，还有一种全为假的没有用到，事实上Field不允许你那么设置，因为既不存储又不索引的域是没有意义的。</span></p>
<p><span>3.4 term&nbsp;</span><br><span>term是搜索的最小单位，它表示文档的一个词语，term由两部分组成：它表示的词语和这个词语所出现的field。</span></p>
<p><span>3.5 tocken&nbsp;</span><br><span>tocken是term的一次出现，它包含trem文本和相应的起止偏移，以及一个类型字符串。一句话中可以出现多次相同的词语，它们都用同一个term表示，但是用不同的tocken，每个tocken标记该词语出现的地方。</span></p>
<p><span>3.6 segment&nbsp;</span><br><span>添加索引时并不是每个document都马上添加到同一个索引文件，它们首先被写入到不同的小文件，然后再合并成一个大索引文件，这里每个小文件都是一个segment。</span></p>
<p><span>4 lucene的结构&nbsp;</span><br><span>lucene包括core和sandbox两部分，其中core是lucene稳定的核心部分，sandbox包含了一些附加功能，例如highlighter、各种分析器。&nbsp;</span><br><span>Lucene core有七个包：analysis，document，index，queryParser，search，store，util。&nbsp;</span><br><span>4.1 analysis&nbsp;</span><br><span>Analysis包含一些内建的分析器，例如按空白字符分词的WhitespaceAnalyzer，添加了stopwrod过滤的StopAnalyzer，最常用的StandardAnalyzer。&nbsp;</span><br><span>4.2 document&nbsp;</span><br><span>Document包含文档的数据结构，例如Document类定义了存储文档的数据结构，Field类定义了Document的一个域。&nbsp;</span><br><span>4.3 index&nbsp;</span><br><span>Index 包含了索引的读写类，例如对索引文件的segment进行写、合并、优化的IndexWriter类和对索引进行读取和删除操作的 IndexReader类，这里要注意的是不要被IndexReader这个名字误导，以为它是索引文件的读取类，实际上删除索引也是由它完成， IndexWriter只关心如何将索引写入一个个segment，并将它们合并优化；IndexReader则关注索引文件中各个文档的组织形式。&nbsp;</span><br><span>4.4 queryParser&nbsp;</span><br><span>QueryParser 包含了解析查询语句的类，lucene的查询语句和sql语句有点类似，有各种保留字，按照一定的语法可以组成各种查询。 Lucene有很多种 Query类，它们都继承自Query，执行各种特殊的查询，QueryParser的作用就是解析查询语句，按顺序调用各种 Query类查找出结果。&nbsp;</span><br><span>4.5 search&nbsp;</span><br><span>Search包含了从索引中搜索结果的各种类，例如刚才说的各种Query类，包括TermQuery、BooleanQuery等就在这个包里。&nbsp;</span><br><span>4.6 store&nbsp;</span><br><span>Store包含了索引的存储类，例如Directory定义了索引文件的存储结构，FSDirectory为存储在文件中的索引，RAMDirectory为存储在内存中的索引，MmapDirectory为使用内存映射的索引。&nbsp;</span><br><span>4.7 util&nbsp;</span><br><span>Util包含一些公共工具类，例如时间和字符串之间的转换工具。</span></p>
<p><span>5 如何建索引&nbsp;</span><br><span>5.1 最简单的能完成索引的代码片断</span></p>
<p><span>IndexWriter writer = new IndexWriter(&ldquo;/data/index/&rdquo;, new StandardAnalyzer(), true);&nbsp;</span><br><span>Document doc = new Document();&nbsp;</span><br><span>doc.add(new Field(“title”, “lucene introduction”, Field.Store.YES, Field.Index.TOKENIZED));&nbsp;</span><br><span>doc.add(new Field(“content”, “lucene works well”, Field.Store.YES, Field.Index.TOKENIZED));&nbsp;</span><br><span>writer.addDocument(doc);&nbsp;</span><br><span>writer.optimize();&nbsp;</span><br><span>writer.close();</span></p>
<p><span>下面我们分析一下这段代码。&nbsp;</span><br><span>首先我们创建了一个writer，并指定存放索引的目录为&ldquo;/data/index&rdquo;，使用的分析器为StandardAnalyzer，第三个参数说明如果已经有索引文件在索引目录下，我们将覆盖它们。&nbsp;</span><br><span>然后我们新建一个document。&nbsp;</span><br><span>我们向document添加一个field，名字是&ldquo;title&rdquo;，内容是&ldquo;lucene introduction&rdquo;，对它进行存储并索引。&nbsp;</span><br><span>再添加一个名字是&ldquo;content&rdquo;的field，内容是&ldquo;lucene works well&rdquo;，也是存储并索引。&nbsp;</span><br><span>然后我们将这个文档添加到索引中，如果有多个文档，可以重复上面的操作，创建document并添加。&nbsp;</span><br><span>添加完所有document，我们对索引进行优化，优化主要是将多个segment合并到一个，有利于提高索引速度。&nbsp;</span><br><span>随后将writer关闭，这点很重要。</span></p>
<p><span>对，创建索引就这么简单！&nbsp;</span><br><span>当然你可能修改上面的代码获得更具个性化的服务。</span></p>
<p><span>5.2 将索引直接写在内存&nbsp;</span><br><span>你需要首先创建一个RAMDirectory，并将其传给writer，代码如下：</span></p>
<p><span>Directory dir = new RAMDirectory();&nbsp;</span><br><span>IndexWriter writer = new IndexWriter(dir, new StandardAnalyzer(), true);&nbsp;</span><br><span>Document doc = new Document();&nbsp;</span><br><span>doc.add(new Field(“title”, “lucene introduction”, Field.Store.YES, Field.Index.TOKENIZED));&nbsp;</span><br><span>doc.add(new Field(“content”, “lucene works well”, Field.Store.YES, Field.Index.TOKENIZED));&nbsp;</span><br><span>writer.addDocument(doc);&nbsp;</span><br><span>writer.optimize();&nbsp;</span><br><span>writer.close();</span></p>
<p><span>5.3 索引文本文件&nbsp;</span><br><span>如果你想把纯文本文件索引起来，而不想自己将它们读入字符串创建field，你可以用下面的代码创建field：</span></p>
<p><span>Field field = new Field(“content”, new FileReader(file));</span></p>
<p><span>这里的file就是该文本文件。该构造函数实际上是读去文件内容，并对其进行索引，但不存储。</span></p>
<p><span>6 如何维护索引&nbsp;</span><br><span>索引的维护操作都是由IndexReader类提供。</span></p>
<p><span>6.1 如何删除索引&nbsp;</span><br><span>lucene提供了两种从索引中删除document的方法，一种是</span></p>
<p><span>void deleteDocument(int docNum)</span></p>
<p><span>这种方法是根据document在索引中的编号来删除，每个document加进索引后都会有个唯一编号，所以根据编号删除是一种精确删除，但是这个编号是索引的内部结构，一般我们不会知道某个文件的编号到底是几，所以用处不大。另一种是</span></p>
<p><span>void deleteDocuments(Term term)</span></p>
<p><span>这种方法实际上是首先根据参数term执行一个搜索操作，然后把搜索到的结果批量删除了。我们可以通过这个方法提供一个严格的查询条件，达到删除指定document的目的。&nbsp;</span><br><span>下面给出一个例子：</span></p>
<p><span>Directory dir = FSDirectory.getDirectory(PATH, false);&nbsp;</span><br><span>IndexReader reader = IndexReader.open(dir);&nbsp;</span><br><span>Term term = new Term(field, key);&nbsp;</span><br><span>reader.deleteDocuments(term);&nbsp;</span><br><span>reader.close();</span></p>
<p><span>6.2 如何更新索引&nbsp;</span><br><span>lucene并没有提供专门的索引更新方法，我们需要先将相应的document删除，然后再将新的document加入索引。例如：</span></p>
<p><span>Directory dir = FSDirectory.getDirectory(PATH, false);&nbsp;</span><br><span>IndexReader reader = IndexReader.open(dir);&nbsp;</span><br><span>Term term = new Term(&ldquo;title&rdquo;, &ldquo;lucene introduction&rdquo;);&nbsp;</span><br><span>reader.deleteDocuments(term);&nbsp;</span><br><span>reader.close();</span></p>
<p><span>IndexWriter writer = new IndexWriter(dir, new StandardAnalyzer(), true);&nbsp;</span><br><span>Document doc = new Document();&nbsp;</span><br><span>doc.add(new Field(“title”, “lucene introduction”, Field.Store.YES, Field.Index.TOKENIZED));&nbsp;</span><br><span>doc.add(new Field(“content”, “lucene is funny”, Field.Store.YES, Field.Index.TOKENIZED));&nbsp;</span><br><span>writer.addDocument(doc);&nbsp;</span><br><span>writer.optimize();&nbsp;</span><br><span>writer.close();</span></p>
<p><span>7 如何搜索&nbsp;</span><br><span>lucene 的搜索相当强大，它提供了很多辅助查询类，每个类都继承自Query类，各自完成一种特殊的查询，你可以像搭积木一样将它们任意组合使用，完成一些复杂操作；另外lucene还提供了Sort类对结果进行排序，提供了Filter类对查询条件进行限制。你或许会不自觉地拿它跟SQL语句进行比较： &ldquo;lucene能执行and、or、order by、where、like &lsquo;%xx%&rsquo;操作吗？&rdquo;回答是：&ldquo;当然没问题！&rdquo;</span></p>
<p><span>7.1 各种各样的Query&nbsp;</span><br><span>下面我们看看lucene到底允许我们进行哪些查询操作：</span></p>
<p><span>7.1.1 TermQuery&nbsp;</span><br><span>首先介绍最基本的查询，如果你想执行一个这样的查询：&ldquo;在content域中包含&lsquo;lucene&rsquo;的document&rdquo;，那么你可以用TermQuery：</span></p>
<p><span>Term t = new Term(“content”, “ lucene”;&nbsp;</span><br><span>Query query = new TermQuery(t);</span></p>
<p><span>7.1.2 BooleanQuery&nbsp;</span><br><span>如果你想这么查询：&ldquo;在content域中包含java或perl的document&rdquo;，那么你可以建立两个TermQuery并把它们用BooleanQuery连接起来：</span></p>
<p><span>TermQuery termQuery1 = new TermQuery(new Term(“content”, “java”);&nbsp;</span><br><span>TermQuery termQuery 2 = new TermQuery(new Term(“content”, “perl”);&nbsp;</span><br><span>BooleanQuery booleanQuery = new BooleanQuery();&nbsp;</span><br><span>booleanQuery.add(termQuery 1, BooleanClause.Occur.SHOULD);&nbsp;</span><br><span>booleanQuery.add(termQuery 2, BooleanClause.Occur.SHOULD);</span></p>
<p><span>7.1.3 WildcardQuery&nbsp;</span><br><span>如果你想对某单词进行通配符查询，你可以用WildcardQuery，通配符包括&rsquo;?&rsquo;匹配一个任意字符和&rsquo;<em>&rsquo;匹配零个或多个任意字符，例如你搜索&rsquo;use</em>&rsquo;，你可能找到&rsquo;useful&rsquo;或者&rsquo;useless&rsquo;：</span></p>
<p><span>Query query = new WildcardQuery(new Term(“content”, “use*”);</span></p>
<p><span>7.1.4 PhraseQuery&nbsp;</span><br><span>你可能对中日关系比较感兴趣，想查找&lsquo;中&rsquo;和&lsquo;日&rsquo;挨得比较近（5个字的距离内）的文章，超过这个距离的不予考虑，你可以：</span></p>
<p><span>PhraseQuery query = new PhraseQuery();&nbsp;</span><br><span>query.setSlop(5);&nbsp;</span><br><span>query.add(new Term(“content “, &ldquo;中&rdquo;));&nbsp;</span><br><span>query.add(new Term(&ldquo;content&rdquo;, &ldquo;日&rdquo;));</span></p>
<p><span>那么它可能搜到&ldquo;中日合作&hellip;&hellip;&rdquo;、&ldquo;中方和日方&hellip;&hellip;&rdquo;，但是搜不到&ldquo;中国某高层领导说日本欠扁&rdquo;。</span></p>
<p><span>7.1.5 PrefixQuery&nbsp;</span><br><span>如果你想搜以&lsquo;中&rsquo;开头的词语，你可以用PrefixQuery：</span></p>
<p><span>PrefixQuery query = new PrefixQuery(new Term(“content “, “中”);</span></p>
<p><span>7.1.6 FuzzyQuery&nbsp;</span><br><span>FuzzyQuery用来搜索相似的term，使用Levenshtein算法。假设你想搜索跟&lsquo;wuzza&rsquo;相似的词语，你可以：</span></p>
<p><span>Query query = new FuzzyQuery(new Term(“content”, “wuzza”);</span></p>
<p><span>你可能得到&lsquo;fuzzy&rsquo;和&lsquo;wuzzy&rsquo;。</span></p>
<p><span>7.1.7 RangeQuery&nbsp;</span><br><span>另一个常用的Query是RangeQuery，你也许想搜索时间域从20060101到20060130之间的document，你可以用RangeQuery：</span></p>
<p><span>RangeQuery query = new RangeQuery(new Term(&ldquo;time&rdquo;, &ldquo;20060101&rdquo;), new Term(&ldquo;time&rdquo;, &ldquo;20060130&rdquo;), true);</span></p>
<p><span>最后的true表示用闭合区间。</span></p>
<p><span>7.2 QueryParser&nbsp;</span><br><span>看了这么多Query，你可能会问：&ldquo;不会让我自己组合各种Query吧，太麻烦了！&rdquo;当然不会，lucene提供了一种类似于SQL语句的查询语句，我们姑且叫它lucene语句，通过它，你可以把各种查询一句话搞定，lucene会自动把它们查分成小块交给相应Query执行。下面我们对应每种 Query演示一下：&nbsp;</span><br><span>TermQuery可以用&ldquo;field:key&rdquo;方式，例如&ldquo;content:lucene&rdquo;。&nbsp;</span><br><span>BooleanQuery中&lsquo;与&rsquo;用&lsquo;+&rsquo;，&lsquo;或&rsquo;用&lsquo; &rsquo;，例如&ldquo;content:java contenterl&rdquo;。&nbsp;</span><br><span>WildcardQuery仍然用&lsquo;?&rsquo;和&lsquo;<em>&rsquo;，例如&ldquo;content:use</em>&rdquo;。&nbsp;</span><br><span>PhraseQuery用&lsquo;~&rsquo;，例如&ldquo;content:”中日”~5&rdquo;。&nbsp;</span><br><span>PrefixQuery用&lsquo;<em>&rsquo;，例如&ldquo;中</em>&rdquo;。&nbsp;</span><br><span>FuzzyQuery用&lsquo;~&rsquo;，例如&ldquo;content: wuzza ~&rdquo;。&nbsp;</span><br><span>RangeQuery用&lsquo;[]&rsquo;或&lsquo;{}&rsquo;，前者表示闭区间，后者表示开区间，例如&ldquo;time:[20060101 TO 20060130]&rdquo;，注意TO区分大小写。&nbsp;</span><br><span>你可以任意组合query string，完成复杂操作，例如&ldquo;标题或正文包括lucene，并且时间在20060101到20060130之间的文章&rdquo;可以表示为：&ldquo;+ (title:lucene content:lucene) +time:[20060101 TO 20060130]&rdquo;。代码如下：</span></p>
<p><span>Directory dir = FSDirectory.getDirectory(PATH, false);&nbsp;</span><br><span>IndexSearcher is = new IndexSearcher(dir);&nbsp;</span><br><span>QueryParser parser = new QueryParser(“content”, new StandardAnalyzer());&nbsp;</span><br><span>Query query = parser.parse(“+(title:lucene content:lucene) +time:[20060101 TO 20060130]”;&nbsp;</span><br><span>Hits hits = is.search(query);&nbsp;</span><br><span>for (int i = 0; i &lt; hits.length(); i++)&nbsp;</span><br><span>{&nbsp;</span><br><span>Document doc = hits.doc(i);&nbsp;</span><br><span>System.out.println(doc.get(“title”);&nbsp;</span><br><span>}&nbsp;</span><br><span>is.close();</span></p>
<p><span>首先我们创建一个在指定文件目录上的IndexSearcher。&nbsp;</span><br><span>然后创建一个使用StandardAnalyzer作为分析器的QueryParser，它默认搜索的域是content。&nbsp;</span><br><span>接着我们用QueryParser来parse查询字串，生成一个Query。&nbsp;</span><br><span>然后利用这个Query去查找结果，结果以Hits的形式返回。&nbsp;</span><br><span>这个Hits对象包含一个列表，我们挨个把它的内容显示出来。</span></p>
<p><span>7.3 Filter&nbsp;</span><br><span>filter 的作用就是限制只查询索引的某个子集，它的作用有点像SQL语句里的where，但又有区别，它不是正规查询的一部分，只是对数据源进行预处理，然后交给查询语句。注意它执行的是预处理，而不是对查询结果进行过滤，所以使用filter的代价是很大的，它可能会使一次查询耗时提高一百倍。&nbsp;</span><br><span>最常用的filter是RangeFilter和QueryFilter。RangeFilter是设定只搜索指定范围内的索引；QueryFilter是在上次查询的结果中搜索。&nbsp;</span><br><span>Filter的使用非常简单，你只需创建一个filter实例，然后把它传给searcher。继续上面的例子，查询&ldquo;时间在20060101到20060130之间的文章&rdquo;除了将限制写在query string中，你还可以写在RangeFilter中：</span></p>
<p><span>Directory dir = FSDirectory.getDirectory(PATH, false);&nbsp;</span><br><span>IndexSearcher is = new IndexSearcher(dir);&nbsp;</span><br><span>QueryParser parser = new QueryParser(“content”, new StandardAnalyzer());&nbsp;</span><br><span>Query query = parser.parse(“title:lucene content:lucene”;&nbsp;</span><br><span>RangeFilter filter = new RangeFilter(“time”, “20060101”, “20060230”, true, true);&nbsp;</span><br><span>Hits hits = is.search(query, filter);&nbsp;</span><br><span>for (int i = 0; i &lt; hits.length(); i++)&nbsp;</span><br><span>{&nbsp;</span><br><span>Document doc = hits.doc(i);&nbsp;</span><br><span>System.out.println(doc.get(“title”);&nbsp;</span><br><span>}&nbsp;</span><br><span>is.close();</span></p>
<p><span>7.4 Sort&nbsp;</span><br><span>有时你想要一个排好序的结果集，就像SQL语句的&ldquo;order by&rdquo;，lucene能做到：通过Sort。&nbsp;</span><br><span>Sort sort = new Sort(&ldquo;time&rdquo;); //相当于SQL的&ldquo;order by time&rdquo;&nbsp;</span><br><span>Sort sort = new Sort(&ldquo;time&rdquo;, true); // 相当于SQL的&ldquo;order by time desc&rdquo;&nbsp;</span><br><span>下面是一个完整的例子：</span></p>
<p><span>Directory dir = FSDirectory.getDirectory(PATH, false);&nbsp;</span><br><span>IndexSearcher is = new IndexSearcher(dir);&nbsp;</span><br><span>QueryParser parser = new QueryParser(“content”, new StandardAnalyzer());&nbsp;</span><br><span>Query query = parser.parse(“title:lucene content:lucene”;&nbsp;</span><br><span>RangeFilter filter = new RangeFilter(“time”, “20060101”, “20060230”, true, true);&nbsp;</span><br><span>Sort sort = new Sort(&ldquo;time&rdquo;);&nbsp;</span><br><span>Hits hits = is.search(query, filter, sort);&nbsp;</span><br><span>for (int i = 0; i &lt; hits.length(); i++)&nbsp;</span><br><span>{&nbsp;</span><br><span>Document doc = hits.doc(i);&nbsp;</span><br><span>System.out.println(doc.get(“title”);&nbsp;</span><br><span>}&nbsp;</span><br><span>is.close();</span></p>
<p><span>8 分析器&nbsp;</span><br><span>在前面的概念介绍中我们已经知道了分析器的作用，就是把句子按照语义切分成一个个词语。英文切分已经有了很成熟的分析器： StandardAnalyzer，很多情况下StandardAnalyzer是个不错的选择。甚至你会发现StandardAnalyzer也能对中文进行分词。&nbsp;</span><br><span>但是我们的焦点是中文分词，StandardAnalyzer能支持中文分词吗？实践证明是可以的，但是效果并不好，搜索&ldquo;如果&rdquo; 会把&ldquo;牛奶不如果汁好喝&rdquo;也搜索出来，而且索引文件很大。那么我们手头上还有什么分析器可以使用呢？core里面没有，我们可以在sandbox里面找到两个： ChineseAnalyzer和CJKAnalyzer。但是它们同样都有分词不准的问题。相比之下用StandardAnalyzer和 ChineseAnalyzer建立索引时间差不多，索引文件大小也差不多，CJKAnalyzer表现会差些，索引文件大且耗时比较长。&nbsp;</span><br><span>要解决问题，首先分析一下这三个分析器的分词方式。StandardAnalyzer和ChineseAnalyzer都是把句子按单个字切分，也就是说 &ldquo;牛奶不如果汁好喝&rdquo;会被它们切分成&ldquo;牛 奶 不 如 果 汁 好 喝&rdquo;；而CJKAnalyzer则会切分成&ldquo;牛奶 奶不 不如 如果 果汁 汁好好喝&rdquo;。这也就解释了为什么搜索&ldquo;果汁&rdquo;都能匹配这个句子。&nbsp;</span><br><span>以上分词的缺点至少有两个：匹配不准确和索引文件大。我们的目标是将上面的句子分解成 &ldquo;牛奶 不如 果汁好喝&rdquo;。这里的关键就是语义识别，我们如何识别&ldquo;牛奶&rdquo;是一个词而&ldquo;奶不&rdquo;不是词语？我们很自然会想到基于词库的分词法，也就是我们先得到一个词库，里面列举了大部分词语，我们把句子按某种方式切分，当得到的词语与词库中的项匹配时，我们就认为这种切分是正确的。这样切词的过程就转变成匹配的过程，而匹配的方式最简单的有正向最大匹配和逆向最大匹配两种，说白了就是一个从句子开头向后进行匹配，一个从句子末尾向前进行匹配。基于词库的分词词库非常重要，词库的容量直接影响搜索结果，在相同词库的前提下，据说逆向最大匹配优于正向最大匹配。&nbsp;</span><br><span>当然还有别的分词方法，这本身就是一个学科，我这里也没有深入研究。回到具体应用，我们的目标是能找到成熟的、现成的分词工具，避免重新发明车轮。经过网上搜索，用的比较多的是中科院的 ICTCLAS和一个不开放源码但是免费的JE-Analysis。ICTCLAS有个问题是它是一个动态链接库， java调用需要本地方法调用，不方便也有安全隐患，而且口碑也确实不大好。JE-Analysis效果还不错，当然也会有分词不准的地方，相比比较方便放心。</span></p>
<p><span>9 性能优化&nbsp;</span><br><span>一直到这里，我们还是在讨论怎么样使lucene跑起来，完成指定任务。利用前面说的也确实能完成大部分功能。但是测试表明lucene的性能并不是很好，在大数据量大并发的条件下甚至会有半分钟返回的情况。另外大数据量的数据初始化建立索引也是一个十分耗时的过程。那么如何提高lucene的性能呢？下面从优化创建索引性能和优化搜索性能两方面介绍。</span></p>
<p><span>9.1 优化创建索引性能&nbsp;</span><br><span>这方面的优化途径比较有限，IndexWriter提供了一些接口可以控制建立索引的操作，另外我们可以先将索引写入RAMDirectory，再批量写入FSDirectory，不管怎样，目的都是尽量少的文件IO，因为创建索引的最大瓶颈在于磁盘IO。另外选择一个较好的分析器也能提高一些性能。</span></p>
<p><span>9.1.1 通过设置IndexWriter的参数优化索引建立&nbsp;</span><br><span>setMaxBufferedDocs(int maxBufferedDocs)&nbsp;</span><br><span>控制写入一个新的segment前内存中保存的document的数目，设置较大的数目可以加快建索引速度，默认为10。&nbsp;</span><br><span>setMaxMergeDocs(int maxMergeDocs)&nbsp;</span><br><span>控制一个segment中可以保存的最大document数目，值较小有利于追加索引的速度，默认Integer.MAX_VALUE，无需修改。&nbsp;</span><br><span>setMergeFactor(int mergeFactor)&nbsp;</span><br><span>控制多个segment合并的频率，值较大时建立索引速度较快，默认是10，可以在建立索引时设置为100。</span></p>
<p><span>9.1.2 通过RAMDirectory缓写提高性能&nbsp;</span><br><span>我们可以先把索引写入RAMDirectory，达到一定数量时再批量写进FSDirectory，减少磁盘IO次数。</span></p>
<p><span>FSDirectory fsDir = FSDirectory.getDirectory(“/data/index”, true);&nbsp;</span><br><span>RAMDirectory ramDir = new RAMDirectory();&nbsp;</span><br><span>IndexWriter fsWriter = new IndexWriter(fsDir, new StandardAnalyzer(), true);&nbsp;</span><br><span>IndexWriter ramWriter = new IndexWriter(ramDir, new StandardAnalyzer(), true);&nbsp;</span><br><span>while (there are documents to index)&nbsp;</span><br><span>{&nbsp;</span><br><span>… create Document …&nbsp;</span><br><span>ramWriter.addDocument(doc);&nbsp;</span><br><span>if (condition for flushing memory to disk has been met)&nbsp;</span><br><span>{&nbsp;</span><br><span>fsWriter.addIndexes(new Directory[] { ramDir });&nbsp;</span><br><span>ramWriter.close();&nbsp;</span><br><span>ramWriter = new IndexWriter(ramDir, new StandardAnalyzer(), true);&nbsp;</span><br><span>}&nbsp;</span><br><span>}</span></p>
<p><span>9.1.3 选择较好的分析器&nbsp;</span><br><span>这个优化主要是对磁盘空间的优化，可以将索引文件减小将近一半，相同测试数据下由600M减少到380M。但是对时间并没有什么帮助，甚至会需要更长时间，因为较好的分析器需要匹配词库，会消耗更多cpu，测试数据用StandardAnalyzer耗时133分钟；用MMAnalyzer耗时150分钟。</span></p>
<p><span>9.2 优化搜索性能&nbsp;</span><br><span>虽然建立索引的操作非常耗时，但是那毕竟只在最初创建时才需要，平时只是少量的维护操作，更何况这些可以放到一个后台进程处理，并不影响用户搜索。我们创建索引的目的就是给用户搜索，所以搜索的性能才是我们最关心的。下面就来探讨一下如何提高搜索性能。</span></p>
<p><span>9.2.1 将索引放入内存&nbsp;</span><br><span>这是一个最直观的想法，因为内存比磁盘快很多。Lucene提供了RAMDirectory可以在内存中容纳索引：</span></p>
<p><span>Directory fsDir = FSDirectory.getDirectory(&ldquo;/data/index/&rdquo;, false);&nbsp;</span><br><span>Directory ramDir = new RAMDirectory(fsDir);&nbsp;</span><br><span>Searcher searcher = new IndexSearcher(ramDir);</span></p>
<p><span>但是实践证明RAMDirectory和FSDirectory速度差不多，当数据量很小时两者都非常快，当数据量较大时（索引文件400M）RAMDirectory甚至比FSDirectory还要慢一点，这确实让人出乎意料。&nbsp;</span><br><span>而且lucene的搜索非常耗内存，即使将400M的索引文件载入内存，在运行一段时间后都会out of memory，所以个人认为载入内存的作用并不大。</span></p>
<p><span>9.2.2 优化时间范围限制&nbsp;</span><br><span>既然载入内存并不能提高效率，一定有其它瓶颈，经过测试发现最大的瓶颈居然是时间范围限制，那么我们可以怎样使时间范围限制的代价最小呢？&nbsp;</span><br><span>当需要搜索指定时间范围内的结果时，可以：&nbsp;</span><br><span>1、用RangeQuery，设置范围，但是RangeQuery的实现实际上是将时间范围内的时间点展开，组成一个个BooleanClause加入到 BooleanQuery中查询，因此时间范围不可能设置太大，经测试，范围超过一个月就会抛 BooleanQuery.TooManyClauses，可以通过设置 BooleanQuery.setMaxClauseCount (int maxClauseCount)扩大，但是扩大也是有限的，并且随着maxClauseCount扩大，占用内存也扩大&nbsp;</span><br><span>2、用 RangeFilter代替RangeQuery，经测试速度不会比RangeQuery慢，但是仍然有性能瓶颈，查询的90%以上时间耗费在 RangeFilter，研究其源码发现RangeFilter实际上是首先遍历所有索引，生成一个BitSet，标记每个document，在时间范围内的标记为true，不在的标记为false，然后将结果传递给Searcher查找，这是十分耗时的。&nbsp;</span><br><span>3、进一步提高性能，这个又有两个思路：&nbsp;</span><br><span>a、缓存Filter结果。既然RangeFilter的执行是在搜索之前，那么它的输入都是一定的，就是IndexReader，而 IndexReader是由Directory决定的，所以可以认为RangeFilter的结果是由范围的上下限决定的，也就是由具体的 RangeFilter对象决定，所以我们只要以RangeFilter对象为键，将filter结果BitSet缓存起来即可。lucene API 已经提供了一个CachingWrapperFilter类封装了Filter及其结果，所以具体实施起来我们可以 cache CachingWrapperFilter对象，需要注意的是，不要被CachingWrapperFilter的名字及其说明误导， CachingWrapperFilter看起来是有缓存功能，但的缓存是针对同一个filter的，也就是在你用同一个filter过滤不同 IndexReader时，它可以帮你缓存不同IndexReader的结果，而我们的需求恰恰相反，我们是用不同filter过滤同一个 IndexReader，所以只能把它作为一个封装类。&nbsp;</span><br><span>b、降低时间精度。研究Filter的工作原理可以看出，它每次工作都是遍历整个索引的，所以时间粒度越大，对比越快，搜索时间越短，在不影响功能的情况下，时间精度越低越好，有时甚至牺牲一点精度也值得，当然最好的情况是根本不作时间限制。&nbsp;</span><br><span>下面针对上面的两个思路演示一下优化结果（都采用800线程随机关键词随即时间范围）：&nbsp;</span><br><span>第一组，时间精度为秒：&nbsp;</span><br><span>方式 直接用RangeFilter 使用cache 不用filter&nbsp;</span><br><span>平均每个线程耗时 10s 1s 300ms</span></p>
<p><span>第二组，时间精度为天&nbsp;</span><br><span>方式 直接用RangeFilter 使用cache 不用filter&nbsp;</span><br><span>平均每个线程耗时 900ms 360ms 300ms</span></p>
<p><span>由以上数据可以得出结论：&nbsp;</span><br><span>1、 尽量降低时间精度，将精度由秒换成天带来的性能提高甚至比使用cache还好，最好不使用filter。&nbsp;</span><br><span>2、 在不能降低时间精度的情况下，使用cache能带了10倍左右的性能提高。</span></p>
<p><span>9.2.3 使用更好的分析器&nbsp;</span><br><span>这个跟创建索引优化道理差不多，索引文件小了搜索自然会加快。当然这个提高也是有限的。较好的分析器相对于最差的分析器对性能的提升在20%以下。</span></p>
<p><span>10 一些经验</span></p>
<p><span>10.1关键词区分大小写&nbsp;</span><br><span>or AND TO等关键词是区分大小写的，lucene只认大写的，小写的当做普通单词。</span></p>
<p><span>10.2 读写互斥性&nbsp;</span><br><span>同一时刻只能有一个对索引的写操作，在写的同时可以进行搜索</span></p>
<p><span>10.3 文件锁&nbsp;</span><br><span>在写索引的过程中强行退出将在tmp目录留下一个lock文件，使以后的写操作无法进行，可以将其手工删除</span></p>
<p><span>10.4 时间格式&nbsp;</span><br><span>lucene只支持一种时间格式yyMMddHHmmss，所以你传一个yy-MM-dd HH:mm:ss的时间给lucene它是不会当作时间来处理的</span></p>
<p><span>10.5 设置boost&nbsp;</span><br><span>有些时候在搜索时某个字段的权重需要大一些，例如你可能认为标题中出现关键词的文章比正文中出现关键词的文章更有价值，你可以把标题的boost设置的更大，那么搜索结果会优先显示标题中出现关键词的文章（没有使用排序的前题下）。使用方法：&nbsp;</span><br><span>Field. setBoost(float boost);默认值是1.0，也就是说要增加权重的需要设置得比1大。</span></p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> lucene </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[看书笔记]《深入java虚拟机》——java体系结构（一）]]></title>
      <url>/2013/02/23/%E7%9C%8B%E4%B9%A6%E7%AC%94%E8%AE%B0-%E3%80%8A%E6%B7%B1%E5%85%A5java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B%E2%80%94%E2%80%94java%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>java的这种适合网络环境的能力是由其体系结构决定的，它可以保证安全的、健壮的且和平台无关的程序通过网络传播，在很多不同的计算机和设备上运行。</p>
<p>体系结构包括四个独立但相关的技术：</p>
<ul>
<li>java程序设计语言</li>
<li>java class文件</li>
<li>java应用编程接口（API）</li>
<li>java虚拟机</li>
</ul>
<p>用java编程语言编写源代码，把它编译成java class文件，然后再在java虚拟机中运行class文件。当程序运行的时候，它通过调用class文件中实现了java API的方法来满足程序的java API调用。</p>
<p>java虚拟机和java API组成了一个&ldquo;平台&rdquo;，所有java程序都在这上面编译。被称为&ldquo;java运行时系统&rdquo;，或者&ldquo;java平台&rdquo;。</p>
<p>—————-java虚拟机：<br>java面向网络的核心就是java虚拟机，它支持java面向网络体系结构三大支柱的所有方面：平台无关性、安全性、网络移动性。<br>java虚拟机上一台抽象的计算机，其规范定义了每个java虚拟机都必须实现的特性，但是为每个特定实现都留下了很多选择。（比如都要能执行字节码，但是执行的技术可以自己选择）。</p>
<p>java虚拟机的主要任务就是装载class文件并执行其中的字节码。虚拟机包含一个类装载器，它可以从程序和API中装载class文件。java API中只有程序执行时需要的那些类才会被装载。字节码由执行引擎来执行。</p>
<p>不同java虚拟机中，执行引擎可能实现得非常不同：</p>
<ul>
<li>&ldquo;一次性解释字节码&rdquo;，是软件实现的虚拟机中，最简单的引擎。</li>
<li>&ldquo;即使编译器&rdquo;，更快、但是消耗内存。这时，在第一次被执行的字节码会被编译成本地机器代码。编译出的本地机器代码会被缓存，当方法以后被调用的时候可以重用。</li>
<li>&ldquo;自适应优化器&rdquo;，这时，虚拟机开始的时候解释字节码，但是会见时运行中的程序活动，并记录下使用最频繁的代码段，程序运行时时，虚拟机会只把活动最频繁的代码编译成本地机器代码，其它的代码由于使用不频繁，继续保留成字节码&mdash;&mdash;由虚拟机继续解释它们。</li>
<li>最后一种虚拟机由硬件芯片后成，它用本地方法执行java字节码，这种执行那个引擎实际上是内嵌在芯片里的。</li>
</ul>
<p>当java虚拟机由主机操作系统的软件实现时，java程序通过调用本地方法和主机交互。<br>java中有两种方法：java方法和本地方法。</p>
<ul>
<li>java方法是由java语言编写，编译成字节码，储存在class文件中。</li>
<li>本地方法是由其它语言（比如C、C++，或者汇编语言）编写的，编译成和处理器相关的机器代码。保存在动态链接库中，格式是各个平台专有的。<br>java方法是平台无关的。<br>本地方法是平台有关的。<br>运行中的java程序调用本地方法时，虚拟机装载包含这个本地方法的动态库，并调用这个方法。本地方法是联系java程序和底层主机操作系统的连接方法。</li>
</ul>
<p>—————-类装载器体系结构：<br>一个java程序可以使用两种类装载器：启动类装载器和用户定义类装载器。<br>启动类装载器（系统唯一）是java虚拟机实现的一部分。<br>java程序能够在运行时安装用户定义的类装载器。这种类装载器能够使用自定义的方式来装载类。</p>
<p>启动类装载器是虚拟机实现的本质部分，但是用户定义类装载器不是。但用户类装载器能够用java编写，能够被编译成class文件，能够被虚拟机装载，能够像其他类一样实例化，他们实际上只是运行中的java应用程序可执行代码的一部分。</p>
<p>由于有用户定义类装载器，所以不必在编译的时候就知道运行中的java程序中最终会加入的所有类。使得在运行时扩展java程序称为可能。但它运行时程序能够决定它需要哪些额外的类，能够决定是使用一个或是更多的用户定义类装载器来装载。</p>
<p>每一个类被装载的时候，java虚拟机都监视这个类，看他到底是被哪个类装载器装载。当被装载的类引用了另一个类时，虚拟机会使用装载第一个类的类装载器来装载被引用的类。</p>
<p>java程序能够从一个或多个类中实例化多个用户定义类装载器。所以需要多少个用户定义类装载器就能创建多少个。被不同的类装载器装载的类存放在不同的命名空间中，它们不能互相访问，除非应用程序显示地允许这样做。<br>当编写应用程序的时候，从不同源文件装载的类可以分隔在不同的命名空间中。这样就能够使用java类装载器的体系结构来控制任何从不同源文件中装载的代码之间的互相应用，特别是能够阻止恶意代码获取访问和破坏善意代码的权限。</p>
<p>网络移动性的支持：允许实例化用户定义类装载器来知道如何从网络下载class文件。<br>安全性的支持：允许使用不同的用户定义类装载器装载不同来源的class文件，把不同来源的class文件放置在不同的命名空间中，这就能够限制或阻止不同来源的代码之间的互相访问。</p>
<p>—————-java class文件：<br>平台无关性：</p>
<ul>
<li>为java程序提供独立于底层主机平台的二进制形式的服务。</li>
<li>java class文件是可以运行在任何支持java虚拟机的硬件平台和操作系统的二进制文件。</li>
<li>java编译器把java源文件的指令翻译成字节码，这种字节码就是java虚拟机的&ldquo;机器语言&rdquo;。</li>
<li>java class文件中字节顺序是高位在前，这与使用何种平台产生这个文件和何种平台上使用这个文件都没关系。</li>
</ul>
<p>网络移动性：</p>
<ul>
<li>class文件设计得紧凑，因此可快速在网络上传送。</li>
<li>由于java程序是动态链接和动态扩展的，class可以在需要的时候下载。</li>
</ul>
<p>—————-java API：<br>java API是运行库的集合，它提供一套访问主机系统资源的标准方法。<br>所有被装载的class文件和所有已经装载的动态库共同组成了java虚拟机上运行的整个程序。</p>
<p>平台无关性：在每个特定的主机平台上都明确地实现了java虚拟机和java API。</p>
<p>—————-java程序设计语言：<br>java能够提高开发者的效率，这种效率主要来自java对直接内存操作的约束。<br>（在C++中：不再使用的对象没有被释放会导致内存泄漏；多次释放一个对象会导致内存冲突。这两种情况都会导致C++程序崩溃。）</p>
<p>提高开发者的效率+为终端用户增强健壮性。</p>
<p>—————-java体系结构的代价：</p>
<ul>
<li>和其它技术（如C++）相比，java程序的执行速度可能较低，这是java在面向网络特性上的主要代价之一（虚拟机性能问题[执行引擎的效率]）。</li>
<li>因为跨平台，所以要保证在多种虚拟机上都有令人满意的性能。随着代码和对象通过网络在虚拟机之间移动，开发者也无从知晓他们的程序究竟会运行在哪些虚拟机上</li>
<li>java在内存管理和线程调度上的缺陷，垃圾收集器可以使得许多程序更加健壮，但是在程序运行时的性能加入了一些不确定性（无法确定gc什么时候开始收集垃圾，无法确认是否开始收集垃圾，无法确认垃圾收集要持续多长时间）；java虚拟机规范讨论线程调度的地方非常笼统，这种对线程行为的松散规范有利于将java虚拟机移植到许多不同类型的硬件上去，但是这种线程管理使得程序员无法了解应该如何调度线程，无法控制线程调度。</li>
<li>为了实现平台无关性，引发的最小公分母问题。各个操作系统之间虽然有许多共性，但是每个操作系统通常都有一些自己的特性。在大多数os上由的特性，可能会被添加到java的os系统服务API中，但是这时还要在不具备这个特性的的os上由API模拟实现它。</li>
<li>容易被逆向编译。因为java class文件与java程序语言之间是紧密联系的，和java天生的动态链接特性，所以从一个类到另一个类的引用时符号化的。在java class中，指向另一个类的引用通过字符串清楚地标明了所指向的这个类的名字。如果引用指向一个字段，则这个字段的名称和描述符（字段类别）都会被详细说明；如果这个引用指向的是一个成员方法，则这个成员方法的名称和描述符（返回类型，方法参数数量和类型）也会被详细说明。还包含了自己字段和成员方法的符号引用和可选的调试信息（包含局部变量名称和类型）。<br>一个class文件的符号信息，以及字节码指令集和java语言之间的密切关系，这些方法使得把java class文件逆向编译为java源码文件相当容易。<br>（可以用混淆器来混淆你的class文件，通过改变类、字段、方法和、局部变量的名字，但它不改变工作流程）。</li>
</ul>
<p>—————-总结：<br>java程序设计语言是一种十分通过的语言，它和其他技术相比有着明显的优势，特别是java能在极大程度上提高程序员的效率，增强程序的健壮性，与老的程序设计技术（比如C、C++）相比，具有过得去的性能。</p>
<p><img src="http://images.cnitblog.com/blog/378300/201302/23101002-a56a028cbdc04d5881e39f7e3e86d321.jpg" alt=""></p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> JVM </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[工具库]JFileDownloader工具类——多线程下载网络文件，并保存在本地]]></title>
      <url>/2013/02/20/%E5%B7%A5%E5%85%B7%E5%BA%93-JFileDownloader%E5%B7%A5%E5%85%B7%E7%B1%BB%E2%80%94%E2%80%94%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%EF%BC%8C%E5%B9%B6%E4%BF%9D%E5%AD%98%E5%9C%A8%E6%9C%AC%E5%9C%B0/</url>
      <content type="html"><![CDATA[<p>本人大四即将毕业的准程序员（JavaSE、JavaEE、android等）一枚，小项目也做过一点，于是乎一时兴起就写了一些工具。</p>
<p>我会在本博客中陆续发布一些平时可能会用到的工具。</p>
<p>代码质量可能不是很好，大家多担待！</p>
<p>代码或者思路有不妥之处，还希望大牛们能不吝赐教哈！</p>
<p>&nbsp;</p>
<p><span>以下代码为本人原创，转载请注明：</span></p>
<p><span>本文转载，来自：<a href="http://www.cnblogs.com/tiantianbyconan/archive/2013/02/20/2919132.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/archive/2013/02/20/2919132.html</a></span></p>
<p>&nbsp;</p>
<p>JFileDownloader：用于多线程下载网络文件，并保存在本地。</p>
<p><strong>源码如下：</strong></p>
<p>1.JFileDownloader类：主要负责下载的初始化可启动工作。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('d395f922-7845-43c4-b066-96e79a7d1609')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_d395f922-7845-43c4-b066-96e79a7d1609" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.extrautil.jfiledownloader;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.File;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.HttpURLConnection;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.URL;<br></span><span style="color: #008080;">  6</span><br><span style="color: #008080;">  7</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">  8</span> <span style="color: #008000;"> <em><br></em></span><span style="color: #008080;">  9</span> <span style="color: #008000;">  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 10</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2013-2-7 下午1:40:52<br></span><span style="color: #008080;"> 11</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> JFileDownloader{<br></span><span style="color: #008080;"> 13</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String urlPath;<br></span><span style="color: #008080;"> 14</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String destFilePath;<br></span><span style="color: #008080;"> 15</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> threadCount;<br></span><span style="color: #008080;"> 16</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> JFileDownloadThread[] threads;<br></span><span style="color: #008080;"> 17</span><br><span style="color: #008080;"> 18</span>     <span style="color: #0000ff;">private</span> JFileDownloadListener fileDownloadListener; <span style="color: #008000;">//</span><span style="color: #008000;"> 进度监听器</span><br><span style="color: #008080;"> 19</span>     <span style="color: #0000ff;">private</span> JFileDownloaderNotificationThread notificationThread; <span style="color: #008000;">//</span><span style="color: #008000;"> 通知进度线程</span><br><span style="color: #008080;"> 20</span><br><span style="color: #008080;"> 21</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> File destFile;<br></span><span style="color: #008080;"> 22</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 23</span> <span style="color: #008000;">     <em> 下载过程中文件的后缀名。<br></em></span><span style="color: #008080;"> 24</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 25</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> String DOWNLOADING_SUFFIX = “.jd”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 26</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 27</span> <span style="color: #008000;">     <em> 默认使用的线程数量。&lt;br&gt;<br></em></span><span style="color: #008080;"> 28</span> <span style="color: #008000;">      如果不设置线程数量参数（threadCount），则默认线程启动数量为1，即单线程下载。<br></span><span style="color: #008080;"> 29</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 30</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> DEFAULT_THREADCOUNT = 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 31</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 32</span> <span style="color: #008000;">     <em> 生成JFileDownloader对象。<br></em></span><span style="color: #008080;"> 33</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> urlPath 要下载的目标文件URL路径<br></span><span style="color: #008080;"> 34</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> destFilePath 要保存的文件目标（路径+文件名）<br></span><span style="color: #008080;"> 35</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> threadCount 下载该文件所需要的线程数量<br></span><span style="color: #008080;"> 36</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 37</span>     <span style="color: #0000ff;">public</span> JFileDownloader(String urlPath, String destFilePath, <span style="color: #0000ff;">int</span><span style="color: #000000;"> threadCount) {<br></span><span style="color: #008080;"> 38</span>         <span style="color: #0000ff;">this</span>.urlPath =<span style="color: #000000;"> urlPath;<br></span><span style="color: #008080;"> 39</span>         <span style="color: #0000ff;">this</span>.destFilePath =<span style="color: #000000;"> destFilePath;<br></span><span style="color: #008080;"> 40</span>         <span style="color: #0000ff;">this</span>.threadCount =<span style="color: #000000;"> threadCount;<br></span><span style="color: #008080;"> 41</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 42</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 43</span> <span style="color: #008000;">      生成JFileDownloader对象，其中下载线程数量默认是1，也就是选择单线程下载。<br></span><span style="color: #008080;"> 44</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> urlPath urlPath 要下载的目标文件URL路径<br></span><span style="color: #008080;"> 45</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> destFilePath destFilePath 要保存的文件目标（路径+文件名）<br></span><span style="color: #008080;"> 46</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 47</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> JFileDownloader(String urlPath, String destFilePath) {<br></span><span style="color: #008080;"> 48</span>         <span style="color: #0000ff;">this</span><span style="color: #000000;">(urlPath, destFilePath, DEFAULT_THREADCOUNT);<br></span><span style="color: #008080;"> 49</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 50</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 51</span> <span style="color: #008000;">      默认的构造方法，使用构造方法后必须要调用set方法来设置url等下载所需配置。<br></span><span style="color: #008080;"> 52</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> JFileDownloader() {<br></span><span style="color: #008080;"> 54</span><br><span style="color: #008080;"> 55</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 56</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 57</span> <span style="color: #008000;">      开始下载方法（流程分为3步）。<br></span><span style="color: #008080;"> 58</span> <span style="color: #008000;">     <em> &lt;br&gt;&lt;ul&gt;<br></em></span><span style="color: #008080;"> 59</span> <span style="color: #008000;">      &lt;li&gt;检验URL的合法性&lt;br&gt;<br></span><span style="color: #008080;"> 60</span> <span style="color: #008000;">     <em> &lt;li&gt;计算下载所需的线程数量和每个线程需下载多少大小的文件&lt;br&gt;<br></em></span><span style="color: #008080;"> 61</span> <span style="color: #008000;">      &lt;li&gt;启动各线程。<br></span><span style="color: #008080;"> 62</span> <span style="color: #008000;">     <em> &lt;/ul&gt;<br></em></span><span style="color: #008080;"> 63</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 64</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@throws</span><span style="color: #008000;"> Exception 如果设置的URL，includes等参数不合法，则抛出该异常<br></span><span style="color: #008080;"> 65</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 66</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> startDownload() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception{<br></span><span style="color: #008080;"> 67</span>         checkSettingfValidity(); <span style="color: #008000;">//</span><span style="color: #008000;"> 检验参数合法性</span><br><span style="color: #008080;"> 68</span><br><span style="color: #008080;"> 69</span>         URL url = <span style="color: #0000ff;">new</span><span style="color: #000000;"> URL(urlPath);<br></span><span style="color: #008080;"> 70</span>         HttpURLConnection conn =<span style="color: #000000;"> (HttpURLConnection)url.openConnection();<br></span><span style="color: #008080;"> 71</span>         conn.setConnectTimeout(20 <em> 1000<span style="color: #000000;">);<br></span><span style="color: #008080;"> 72</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获取文件长度</span><br><span style="color: #008080;"> 73</span>         <span style="color: #0000ff;">long</span> size =<span style="color: #000000;"> conn.getContentLength();<br></span><span style="color: #008080;"> 74</span> <span style="color: #008000;">//</span><span style="color: #008000;">        int size = conn.getInputStream().available();</span><br><span style="color: #008080;"> 75</span>         <span style="color: #0000ff;">if</span>(size &lt; 0 || <span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> conn.getInputStream()){<br></span><span style="color: #008080;"> 76</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(“网络连接错误，请检查URL地址是否正确”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 77</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 78</span> <span style="color: #000000;">        conn.disconnect();<br></span><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span><br><span style="color: #008080;"> 81</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 计算每个线程需要下载多少byte的文件</span><br><span style="color: #008080;"> 82</span>         <span style="color: #0000ff;">long</span> perSize = size % threadCount == 0 ? size / threadCount : (size / threadCount + 1<span style="color: #000000;">);<br></span><span style="color: #008080;"> 83</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 建立目标文件（文件以.jd结尾）</span><br><span style="color: #008080;"> 84</span>         destFile = <span style="color: #0000ff;">new</span> File(destFilePath +<span style="color: #000000;"> DOWNLOADING_SUFFIX);<br></span><span style="color: #008080;"> 85</span> <span style="color: #000000;">        destFile.createNewFile();<br></span><span style="color: #008080;"> 86</span><br><span style="color: #008080;"> 87</span>         threads = <span style="color: #0000ff;">new</span><span style="color: #000000;"> JFileDownloadThread[threadCount];<br></span><span style="color: #008080;"> 88</span><br><span style="color: #008080;"> 89</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 启动进度通知线程</span><br><span style="color: #008080;"> 90</span>         notificationThread = <span style="color: #0000ff;">new</span><span style="color: #000000;"> JFileDownloaderNotificationThread(threads, fileDownloadListener, destFile, size);<br></span><span style="color: #008080;"> 91</span> <span style="color: #000000;">        notificationThread.start();<br></span><span style="color: #008080;"> 92</span><br><span style="color: #008080;"> 93</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 初始化若干个下载线程</span><br><span style="color: #008080;"> 94</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; threadCount; i++<span style="color: #000000;">){<br></span><span style="color: #008080;"> 95</span>             <span style="color: #0000ff;">if</span>(i != (threadCount - 1<span style="color: #000000;">)){<br></span><span style="color: #008080;"> 96</span>                 threads[i] = <span style="color: #0000ff;">new</span><span style="color: #000000;"> JFileDownloadThread(urlPath, destFile,<br></span><span style="color: #008080;"> 97</span>                         i </em><span style="color: #000000;"> perSize, perSize, notificationThread);<br></span><span style="color: #008080;"> 98</span>             }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 99</span>                 threads[i] = <span style="color: #0000ff;">new</span><span style="color: #000000;"> JFileDownloadThread(urlPath, destFile,<br></span><span style="color: #008080;">100</span>                         i <em> perSize, size - (threadCount - 1) </em><span style="color: #000000;"> perSize, notificationThread);<br></span><span style="color: #008080;">101</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">102</span>             threads[i].setPriority(8<span style="color: #000000;">);<br></span><span style="color: #008080;">103</span> <span style="color: #008000;">//</span><span style="color: #008000;">            threads[i].start();</span><br><span style="color: #008080;">104</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">105</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 启动若干个下载线程（因为下载线程JFileDownloaderNotificationThread中使用了threads属性，所以必须等下载线程全部初始化以后才能启动线程）</span><br><span style="color: #008080;">106</span>         <span style="color: #0000ff;">for</span><span style="color: #000000;">(JFileDownloadThread thread : threads){<br></span><span style="color: #008080;">107</span> <span style="color: #000000;">            thread.start();<br></span><span style="color: #008080;">108</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">109</span><br><span style="color: #008080;">110</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">111</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">112</span> <span style="color: #008000;">     <em> 取消所有下载线程。<br></em></span><span style="color: #008080;">113</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">114</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">115</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> cancelDownload(){<br></span><span style="color: #008080;">116</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> != threads &amp;&amp; 0 != threads.length &amp;&amp; <span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> notificationThread){<br></span><span style="color: #008080;">117</span>             <span style="color: #0000ff;">for</span>(JFileDownloadThread thread : threads){ <span style="color: #008000;">//</span><span style="color: #008000;"> 终止所有下载线程</span><br><span style="color: #008080;">118</span> <span style="color: #000000;">                thread.cancelThread();<br></span><span style="color: #008080;">119</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">120</span>             notificationThread.cancelThread(); <span style="color: #008000;">//</span><span style="color: #008000;"> 终止通知线程</span><br><span style="color: #008080;">121</span>             System.out.println(“下载已被终止。”<span style="color: #000000;">);<br></span><span style="color: #008080;">122</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">123</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">124</span>         System.out.println(“下载线程还未启动，无法终止。”<span style="color: #000000;">);<br></span><span style="color: #008080;">125</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">126</span><br><span style="color: #008080;">127</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">128</span> <span style="color: #008000;">     <em> 设置要下载的目标文件URL路径。<br></em></span><span style="color: #008080;">129</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">130</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> urlPath 要下载的目标文件URL路径<br></span><span style="color: #008080;">131</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回当前JFileDownloader对象<br></span><span style="color: #008080;">132</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">133</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> JFileDownloader setUrlPath(String urlPath) {<br></span><span style="color: #008080;">134</span>         <span style="color: #0000ff;">this</span>.urlPath =<span style="color: #000000;"> urlPath;<br></span><span style="color: #008080;">135</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;">136</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">137</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">138</span> <span style="color: #008000;">      设置要保存的目标文件（路径+文件名）。<br></span><span style="color: #008080;">139</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">140</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> destFilePath 要保存的文件目标（路径+文件名）<br></span><span style="color: #008080;">141</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回当前JFileDownloader对象<br></span><span style="color: #008080;">142</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">143</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> JFileDownloader setDestFilePath(String destFilePath) {<br></span><span style="color: #008080;">144</span>         <span style="color: #0000ff;">this</span>.destFilePath =<span style="color: #000000;"> destFilePath;<br></span><span style="color: #008080;">145</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;">146</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">147</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">148</span> <span style="color: #008000;">     <em> 设置下载该文件所需要的线程数量。<br></em></span><span style="color: #008080;">149</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">150</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> threadCount 下载该文件所需要的线程数量<br></span><span style="color: #008080;">151</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回当前JFileDownloader对象<br></span><span style="color: #008080;">152</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">153</span>     <span style="color: #0000ff;">public</span> JFileDownloader setThreadCount(<span style="color: #0000ff;">int</span><span style="color: #000000;"> threadCount) {<br></span><span style="color: #008080;">154</span>         <span style="color: #0000ff;">this</span>.threadCount =<span style="color: #000000;"> threadCount;<br></span><span style="color: #008080;">155</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;">156</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">157</span><br><span style="color: #008080;">158</span>     <span style="color: #008000;">//</span><span style="color: #008000;">观察者模式来获取下载进度</span><br><span style="color: #008080;">159</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">160</span> <span style="color: #008000;">     <em> 设置监听器，以获取下载进度。<br></em></span><span style="color: #008080;">161</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">162</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> JFileDownloader setFileDownloadListener(<br></span><span style="color: #008080;">163</span> <span style="color: #000000;">            JFileDownloadListener fileDownloadListener) {<br></span><span style="color: #008080;">164</span>         <span style="color: #0000ff;">this</span>.fileDownloadListener =<span style="color: #000000;"> fileDownloadListener;<br></span><span style="color: #008080;">165</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;">166</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">167</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">168</span> <span style="color: #008000;">     <em> 通过该方法移出相应的监听器对象。<br></em></span><span style="color: #008080;">169</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">170</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> fileDownloadListener 要移除的监听器对象<br></span><span style="color: #008080;">171</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">172</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> removeFileDownloadListener(<br></span><span style="color: #008080;">173</span> <span style="color: #000000;">            JFileDownloadListener fileDownloadListener) {<br></span><span style="color: #008080;">174</span>         fileDownloadListener = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">175</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">176</span><br><span style="color: #008080;">177</span><br><span style="color: #008080;">178</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">179</span> <span style="color: #008000;">     <em> 检验设置的参数是否合法。<br></em></span><span style="color: #008080;">180</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">181</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@throws</span><span style="color: #008000;"> Exception 目标文件URL路径不合法，或者线程数小于1，则抛出该异常<br></span><span style="color: #008080;">182</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">183</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> checkSettingfValidity() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception{<br></span><span style="color: #008080;">184</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> == urlPath || “”<span style="color: #000000;">.equals(urlPath)){<br></span><span style="color: #008080;">185</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(“目标文件URL路径不能为空”<span style="color: #000000;">);<br></span><span style="color: #008080;">186</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">187</span>         <span style="color: #0000ff;">if</span>(threadCount &lt; 1<span style="color: #000000;">){<br></span><span style="color: #008080;">188</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(“线程数不能小于1”<span style="color: #000000;">);<br></span><span style="color: #008080;">189</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">190</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">191</span><br><span style="color: #008080;">192</span> }</pre><br></div><br></div>

<p>&nbsp;</p>
<p>2.JFileDownloadListener接口：该接口用于监听JFileDownloader下载的进度。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('ee01f91f-781d-4fde-9833-bb14aaf3a587')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_ee01f91f-781d-4fde-9833-bb14aaf3a587" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.extrautil.jfiledownloader;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.File;<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 6</span> <span style="color: #008000;"> <em><br></em></span><span style="color: #008080;"> 7</span> <span style="color: #008000;">  该接口用于监听JFileDownloader下载的进度。<br></span><span style="color: #008080;"> 8</span> <span style="color: #008000;"> <em><br></em></span><span style="color: #008080;"> 9</span> <span style="color: #008000;">  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">10</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2013-2-7 下午2:12:45<br></span><span style="color: #008080;">11</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">12</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> JFileDownloadListener {<br></span><span style="color: #008080;">13</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">14</span> <span style="color: #008000;">     <em> 该方法可获得文件的下载进度信息。<br></em></span><span style="color: #008080;">15</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">16</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> progress 文件下载的进度值，范围（0-100）。0表示文件还未开始下载；100则表示文件下载完成。<br></span><span style="color: #008080;">17</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> speed 此时下载瞬时速度（单位：kb/每秒）。<br></span><span style="color: #008080;">18</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> remainTime 此时剩余下载所需时间（单位为毫秒）。<br></span><span style="color: #008080;">19</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> downloadProgress(<span style="color: #0000ff;">int</span> progress, <span style="color: #0000ff;">double</span> speed, <span style="color: #0000ff;">long</span><span style="color: #000000;"> remainTime);<br></span><span style="color: #008080;">21</span>     <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">22</span> <span style="color: #008000;">      文件下载完成会调用该方法。<br></span><span style="color: #008080;">23</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">24</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> file 返回下载完成的File对象。<br></span><span style="color: #008080;">25</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> downloadTime 下载所用的总时间（单位为毫秒）。<br></span><span style="color: #008080;">26</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">27</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> downloadCompleted(File file, <span style="color: #0000ff;">long</span><span style="color: #000000;"> downloadTime);<br></span><span style="color: #008080;">28</span> }</pre><br></div><br></div>

<p>&nbsp;</p>
<p>3.JFileDownloaderNotificationThread类：该线程为通知下载进度的线程。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('606a576f-1d6a-48a8-bb25-21c2a4df4a63')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_606a576f-1d6a-48a8-bb25-21c2a4df4a63" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.extrautil.jfiledownloader;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.File;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.math.BigDecimal;<br></span><span style="color: #008080;">  5</span><br><span style="color: #008080;">  6</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">  7</span> <span style="color: #008000;"> <em> 该线程为通知下载进度的线程。<br></em></span><span style="color: #008080;">  8</span> <span style="color: #008000;">  用于在下载未完成时通知用户下载的进度，范围（0-100）。0表示文件还未开始下载；100则表示文件下载完成。<br></span><span style="color: #008080;">  9</span> <span style="color: #008000;"> <em> 此时下载瞬时速度（单位：kb/每秒）。<br></em></span><span style="color: #008080;"> 10</span> <span style="color: #008000;">  在完成时返回下载完成的File对象给用户。返回下载所用的总时间（单位为毫秒）给用户。<br></span><span style="color: #008080;"> 11</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 12</span> <span style="color: #008000;">  </span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2013-2-17 下午12:23:59<br></span><span style="color: #008080;"> 13</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> JFileDownloaderNotificationThread <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Thread{<br></span><span style="color: #008080;"> 15</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> JFileDownloadThread[] threads;<br></span><span style="color: #008080;"> 16</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> JFileDownloadListener fileDownloadListener;<br></span><span style="color: #008080;"> 17</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> File destFile;<br></span><span style="color: #008080;"> 18</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> destFileSize;<br></span><span style="color: #008080;"> 19</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isRunning; <span style="color: #008000;">//</span><span style="color: #008000;"> 线程运行停止标志</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> notificationTag; <span style="color: #008000;">//</span><span style="color: #008000;"> 通知标志</span><br><span style="color: #008080;"> 21</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 22</span> <span style="color: #008000;">     <em> 通过该方法构建一个进度通知线程。<br></em></span><span style="color: #008080;"> 23</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> threads 下载某文件需要的所有线程。<br></span><span style="color: #008080;"> 24</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> fileDownloadListener 要通知进度的监听器对象。<br></span><span style="color: #008080;"> 25</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> destFile 下载的文件对象。<br></span><span style="color: #008080;"> 26</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 27</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> JFileDownloaderNotificationThread(JFileDownloadThread[] threads,<br></span><span style="color: #008080;"> 28</span>             JFileDownloadListener fileDownloadListener, File destFile, <span style="color: #0000ff;">long</span><span style="color: #000000;"> destFileSize) {<br></span><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">this</span>.threads =<span style="color: #000000;"> threads;<br></span><span style="color: #008080;"> 30</span>         <span style="color: #0000ff;">this</span>.fileDownloadListener =<span style="color: #000000;"> fileDownloadListener;<br></span><span style="color: #008080;"> 31</span>         <span style="color: #0000ff;">this</span>.destFile =<span style="color: #000000;"> destFile;<br></span><span style="color: #008080;"> 32</span>         <span style="color: #0000ff;">this</span>.destFileSize =<span style="color: #000000;"> destFileSize;<br></span><span style="color: #008080;"> 33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 34</span><br><span style="color: #008080;"> 35</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 36</span> <span style="color: #008000;">      不断地循环来就检查更新进度。<br></span><span style="color: #008080;"> 37</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 38</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;"> 40</span>         isRunning = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 41</span>         <span style="color: #0000ff;">long</span> startTime = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 42</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> fileDownloadListener){<br></span><span style="color: #008080;"> 43</span>             startTime = System.currentTimeMillis(); <span style="color: #008000;">//</span><span style="color: #008000;"> 文件下载开始时间</span><br><span style="color: #008080;"> 44</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 45</span><br><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">long</span> oldTemp = 0; <span style="color: #008000;">//</span><span style="color: #008000;"> 上次已下载数据长度</span><br><span style="color: #008080;"> 47</span>         <span style="color: #0000ff;">long</span> oldTime = 0; <span style="color: #008000;">//</span><span style="color: #008000;"> 上次下载的当前时间</span><br><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span>         <span style="color: #0000ff;">while</span><span style="color: #000000;">(isRunning){<br></span><span style="color: #008080;"> 50</span>             <span style="color: #0000ff;">if</span>(notificationTag){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果此时正等待检查更新进度。<br></span><span style="color: #008080;"> 51</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 计算此时的所有线程下载长度的总和</span><br><span style="color: #008080;"> 52</span>                 <span style="color: #0000ff;">long</span> temp = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 53</span>                 <span style="color: #0000ff;">for</span><span style="color: #000000;">(JFileDownloadThread thread : threads){<br></span><span style="color: #008080;"> 54</span>                     temp +=<span style="color: #000000;"> thread.currentLength;<br></span><span style="color: #008080;"> 55</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 56</span> <span style="color: #008000;">//</span><span style="color: #008000;">                System.out.println(“temp: “ + temp);<br></span><span style="color: #008080;"> 57</span> <span style="color: #008000;">//</span><span style="color: #008000;">                System.out.println(“destFileSize: “ + destFileSize);<br></span><span style="color: #008080;"> 58</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 换算成进度</span><br><span style="color: #008080;"> 59</span>                 <span style="color: #0000ff;">int</span> progress = (<span style="color: #0000ff;">int</span>) ((<span style="color: #0000ff;">double</span>)temp  100 / (<span style="color: #0000ff;">double</span><span style="color: #000000;">)destFileSize);<br></span><span style="color: #008080;"> 60</span><br><span style="color: #008080;"> 61</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 把进度通知给监听器</span><br><span style="color: #008080;"> 62</span>                 <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> fileDownloadListener){<br></span><span style="color: #008080;"> 63</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 计算瞬时速度</span><br><span style="color: #008080;"> 64</span>                     <span style="color: #0000ff;">long</span> detaTemp = temp - oldTemp; <span style="color: #008000;">//</span><span style="color: #008000;"> 两次更新进度的时间段内的已下载数据差</span><br><span style="color: #008080;"> 65</span>                     <span style="color: #0000ff;">long</span> detaTime = System.currentTimeMillis() - oldTime; <span style="color: #008000;">//</span><span style="color: #008000;"> 两次更新进度的时间段内的时间差<br></span><span style="color: #008080;"> 66</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 两次更新进度的时间段内的速度作为瞬时速度</span><br><span style="color: #008080;"> 67</span>                     <span style="color: #0000ff;">double</span> speed = ((<span style="color: #0000ff;">double</span>)detaTemp / 1024) / ((<span style="color: #0000ff;">double</span>)(detaTime) / 1000<span style="color: #000000;">);<br></span><span style="color: #008080;"> 68</span><br><span style="color: #008080;"> 69</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 保留小数点后2位，最后一位四舍五入</span><br><span style="color: #008080;"> 70</span>                     speed = <span style="color: #0000ff;">new</span> BigDecimal(speed).setScale(2<span style="color: #000000;">, BigDecimal.ROUND_HALF_UP).doubleValue();<br></span><span style="color: #008080;"> 71</span><br><span style="color: #008080;"> 72</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 计算剩余下载时间</span><br><span style="color: #008080;"> 73</span>                     <span style="color: #0000ff;">double</span> remainTime = (<span style="color: #0000ff;">double</span>)(destFileSize - temp) /<span style="color: #000000;"> speed;<br></span><span style="color: #008080;"> 74</span>                     <span style="color: #0000ff;">if</span>(Double.isInfinite(remainTime) ||<span style="color: #000000;"> Double.isNaN(remainTime)){<br></span><span style="color: #008080;"> 75</span>                         remainTime = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 76</span>                     }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 77</span>                         remainTime = <span style="color: #0000ff;">new</span> BigDecimal(remainTime).setScale(0<span style="color: #000000;">, BigDecimal.ROUND_HALF_UP).longValue();<br></span><span style="color: #008080;"> 78</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 通知监听者进度和速度以及下载剩余时间</span><br><span style="color: #008080;"> 81</span>                     fileDownloadListener.downloadProgress(progress, speed, (<span style="color: #0000ff;">long</span><span style="color: #000000;">)remainTime);<br></span><span style="color: #008080;"> 82</span><br><span style="color: #008080;"> 83</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 重置上次已下载数据长度和上次下载的当前时间</span><br><span style="color: #008080;"> 84</span>                     oldTemp =<span style="color: #000000;"> temp;<br></span><span style="color: #008080;"> 85</span>                     oldTime =<span style="color: #000000;"> System.currentTimeMillis();<br></span><span style="color: #008080;"> 86</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 87</span><br><span style="color: #008080;"> 88</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 如果下载进度达到100，则表示下载完毕</span><br><span style="color: #008080;"> 89</span>                 <span style="color: #0000ff;">if</span>(100 &lt;=<span style="color: #000000;"> progress){<br></span><span style="color: #008080;"> 90</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 给下载好的文件进行重命名，即去掉DOWNLOADING_SUFFIX后缀</span><br><span style="color: #008080;"> 91</span>                     String oldPath =<span style="color: #000000;"> destFile.getPath();<br></span><span style="color: #008080;"> 92</span>                     File newFile = <span style="color: #0000ff;">new</span> File(oldPath.substring(0, oldPath.lastIndexOf(“.”<span style="color: #000000;">)));<br></span><span style="color: #008080;"> 93</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 检查去掉后的文件是否存在。如果存在，则删除原来的文件并重命名下载的文件（即：覆盖原文件）</span><br><span style="color: #008080;"> 94</span>                     <span style="color: #0000ff;">if</span><span style="color: #000000;">(newFile.exists()){<br></span><span style="color: #008080;"> 95</span> <span style="color: #000000;">                        newFile.delete();<br></span><span style="color: #008080;"> 96</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;"> 97</span>                     System.out.println(destFile.renameTo(newFile));<span style="color: #008000;">//</span><span style="color: #008000;"> 重命名<br></span><span style="color: #008080;"> 98</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 通知监听器，并传入新的文件对象</span><br><span style="color: #008080;"> 99</span>                     <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> fileDownloadListener){<br></span><span style="color: #008080;">100</span>                         fileDownloadListener.downloadCompleted(newFile, System.currentTimeMillis() -<span style="color: #000000;"> startTime);<br></span><span style="color: #008080;">101</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">102</span>                     isRunning = <span style="color: #0000ff;">false</span>; <span style="color: #008000;">//</span><span style="color: #008000;"> 文件下载完就结束通知线程。</span><br><span style="color: #008080;">103</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">104</span>                 notificationTag = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">105</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">106</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 设置为每100毫秒进行检查并更新通知</span><br><span style="color: #008080;">107</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">108</span>                 Thread.sleep(100<span style="color: #000000;">);<br></span><span style="color: #008080;">109</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;">110</span> <span style="color: #000000;">                e.printStackTrace();<br></span><span style="color: #008080;">111</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">112</span><br><span style="color: #008080;">113</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">114</span><br><span style="color: #008080;">115</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">116</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">117</span> <span style="color: #008000;">     <em> 调用这个方法，则会使得线程处于待检查更新进度状态。<br></em></span><span style="color: #008080;">118</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">119</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">120</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> notificationProgress(){<br></span><span style="color: #008080;">121</span>         notificationTag = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">122</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">123</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">124</span> <span style="color: #008000;">     <em> 取消该通知线程<br></em></span><span style="color: #008080;">125</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">126</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">127</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> cancelThread(){<br></span><span style="color: #008080;">128</span>         isRunning = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">129</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">130</span><br><span style="color: #008080;">131</span><br><span style="color: #008080;">132</span> }</pre><br></div><br></div>

<p>&nbsp;</p>
<p>4.JFileDownloadThread类：真正的下载线程，该线程用于执行该线程所要负责下载的数据。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('c46c22f4-1e9a-43c7-b6e7-f5c514b5483e')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_c46c22f4-1e9a-43c7-b6e7-f5c514b5483e" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.extrautil.jfiledownloader;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.File;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.IOException;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.InputStream;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.RandomAccessFile;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.HttpURLConnection;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.URL;<br></span><span style="color: #008080;">  9</span><br><span style="color: #008080;"> 10</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 11</span> <span style="color: #008000;"> <em><br></em></span><span style="color: #008080;"> 12</span> <span style="color: #008000;">  真正的下载线程，该线程用于执行该线程所要负责下载的数据。<br></span><span style="color: #008080;"> 13</span> <span style="color: #008000;"> <em><br></em></span><span style="color: #008080;"> 14</span> <span style="color: #008000;">  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 15</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2013-2-7 上午11:58:24<br></span><span style="color: #008080;"> 16</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> JFileDownloadThread <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Thread{<br></span><span style="color: #008080;"> 18</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String urlPath;<br></span><span style="color: #008080;"> 19</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> File destFile;<br></span><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> startPos;<br></span><span style="color: #008080;"> 21</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 22</span> <span style="color: #008000;">     <em> 此线程需要下载的数据长度。<br></em></span><span style="color: #008080;"> 23</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> length;<br></span><span style="color: #008080;"> 25</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 26</span> <span style="color: #008000;">     <em> 此线程现在已下载好了的数据长度。<br></em></span><span style="color: #008080;"> 27</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> currentLength;<br></span><span style="color: #008080;"> 29</span><br><span style="color: #008080;"> 30</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> JFileDownloaderNotificationThread notificationThread;<br></span><span style="color: #008080;"> 31</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isRunning = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 32</span><br><span style="color: #008080;"> 33</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 34</span> <span style="color: #008000;">     <em> 构造方法，可生成配置完整的JFileDownloadThread对象<br></em></span><span style="color: #008080;"> 35</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> urlPath 要下载的目标文件URL<br></span><span style="color: #008080;"> 36</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> destFile 要保存的目标文件<br></span><span style="color: #008080;"> 37</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> startPos 该线程需要下载目标文件第几个byte之后的数据<br></span><span style="color: #008080;"> 38</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> length 该线程需要下载多少长度的数据<br></span><span style="color: #008080;"> 39</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> notificationThread 通知进度线程<br></span><span style="color: #008080;"> 40</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 41</span>     <span style="color: #0000ff;">public</span> JFileDownloadThread(String urlPath, File destFile, <span style="color: #0000ff;">long</span><span style="color: #000000;"> startPos,<br></span><span style="color: #008080;"> 42</span>             <span style="color: #0000ff;">long</span><span style="color: #000000;"> length, JFileDownloaderNotificationThread notificationThread) {<br></span><span style="color: #008080;"> 43</span>         <span style="color: #0000ff;">this</span>.urlPath =<span style="color: #000000;"> urlPath;<br></span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">this</span>.destFile =<span style="color: #000000;"> destFile;<br></span><span style="color: #008080;"> 45</span>         <span style="color: #0000ff;">this</span>.startPos =<span style="color: #000000;"> startPos;<br></span><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">this</span>.length =<span style="color: #000000;"> length;<br></span><span style="color: #008080;"> 47</span>         <span style="color: #0000ff;">this</span>.notificationThread =<span style="color: #000000;"> notificationThread;<br></span><span style="color: #008080;"> 48</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 49</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 50</span> <span style="color: #008000;">      该方法将执行下载功能，并把数据存储在目标文件中的相应位置。<br></span><span style="color: #008080;"> 51</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 52</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;"> 54</span>         RandomAccessFile raf = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 55</span>         HttpURLConnection conn = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 56</span>         InputStream is = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 57</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 58</span> <span style="color: #008000;">//</span><span style="color: #008000;">            URL url = new URL(“</span><span style="color: #008000; text-decoration: underline;"><a href="http://localhost" target="_blank" rel="noopener">http://localhost</a></span><span style="color: #008000;">:8080/firstserver/files/hibernate.zip”);</span><br><span style="color: #008080;"> 59</span>             URL url = <span style="color: #0000ff;">new</span><span style="color: #000000;"> URL(urlPath);<br></span><span style="color: #008080;"> 60</span>             conn =<span style="color: #000000;"> (HttpURLConnection)url.openConnection();<br></span><span style="color: #008080;"> 61</span>             conn.setConnectTimeout(20  1000<span style="color: #000000;">);<br></span><span style="color: #008080;"> 62</span>             is =<span style="color: #000000;"> conn.getInputStream();<br></span><span style="color: #008080;"> 63</span>             raf = <span style="color: #0000ff;">new</span> RandomAccessFile(destFile, “rw”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 64</span>             raf.setLength(conn.getContentLength()); <span style="color: #008000;">//</span><span style="color: #008000;"> 设置保存文件的大小<br></span><span style="color: #008080;"> 65</span> <span style="color: #008000;">//</span><span style="color: #008000;">            raf.setLength(conn.getInputStream().available());<br></span><span style="color: #008080;"> 66</span><br><span style="color: #008080;"> 67</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 设置读入和写入的文件位置</span><br><span style="color: #008080;"> 68</span> <span style="color: #000000;">            is.skip(startPos);<br></span><span style="color: #008080;"> 69</span> <span style="color: #000000;">            raf.seek(startPos);<br></span><span style="color: #008080;"> 70</span><br><span style="color: #008080;"> 71</span>             currentLength = 0; <span style="color: #008000;">//</span><span style="color: #008000;"> 当前已下载好的文件长度</span><br><span style="color: #008080;"> 72</span>             <span style="color: #0000ff;">byte</span>[] buffer = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">byte</span>[1024 <em> 1024<span style="color: #000000;">];<br></span><span style="color: #008080;"> 73</span>             <span style="color: #0000ff;">int</span> len = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 74</span>             <span style="color: #0000ff;">while</span>(currentLength &lt; length &amp;&amp; -1 != (len =<span style="color: #000000;"> is.read(buffer))){<br></span><span style="color: #008080;"> 75</span>                 <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">isRunning){<br></span><span style="color: #008080;"> 76</span>                     <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 77</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 78</span>                 <span style="color: #0000ff;">if</span>(currentLength + len &gt;<span style="color: #000000;"> length){<br></span><span style="color: #008080;"> 79</span>                     raf.write(buffer, 0, (<span style="color: #0000ff;">int</span>)(length -<span style="color: #000000;"> currentLength));<br></span><span style="color: #008080;"> 80</span>                     currentLength =<span style="color: #000000;"> length;<br></span><span style="color: #008080;"> 81</span>                     notificationThread.notificationProgress(); <span style="color: #008000;">//</span><span style="color: #008000;"> 通知进度线程来更新进度</span><br><span style="color: #008080;"> 82</span>                     <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 83</span>                 }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 84</span>                     raf.write(buffer, 0<span style="color: #000000;">, len);<br></span><span style="color: #008080;"> 85</span>                     currentLength +=<span style="color: #000000;"> len;<br></span><span style="color: #008080;"> 86</span>                     notificationThread.notificationProgress(); <span style="color: #008000;">//</span><span style="color: #008000;"> 通知进度线程来更新进度</span><br><span style="color: #008080;"> 87</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 88</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 89</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 90</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;"> 91</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 92</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 93</span> <span style="color: #000000;">                is.close();<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">                raf.close();<br></span><span style="color: #008080;"> 95</span> <span style="color: #000000;">                conn.disconnect();<br></span><span style="color: #008080;"> 96</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;"> 97</span> <span style="color: #000000;">                e.printStackTrace();<br></span><span style="color: #008080;"> 98</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">100</span><br><span style="color: #008080;">101</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">102</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">103</span> <span style="color: #008000;">     </span></em> 取消该线程下载<br><span style="color: #008080;">104</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">105</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">106</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> cancelThread(){<br></span><span style="color: #008080;">107</span>         isRunning = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">108</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">109</span><br><span style="color: #008080;">110</span><br><span style="color: #008080;">111</span> }</pre><br></div><br></div>

<p>&nbsp;</p>
<p><strong>使用方法如下：</strong></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> String urlPath = “<a href="http://localhost:8080/firstserver/files/test.zip" target="_blank" rel="noopener">http://localhost:8080/firstserver/files/test.zip</a>“<span style="color: #000000;">;<br></span><span style="color: #008080;"> 2</span> String destFilePath = “C:\Users\admin\Desktop\杂\临时仓库\test.zip”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">int</span> threadCount = 3<span style="color: #000000;">;<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> JFileDownloader downloader = <span style="color: #0000ff;">new</span><span style="color: #000000;"> JFileDownloader(urlPath, destFilePath, threadCount);<br></span><span style="color: #008080;"> 6</span> <span style="color: #008000;">//</span><span style="color: #008000;">或者：</span><br><span style="color: #008080;"> 7</span> JFileDownloader downloader = <span style="color: #0000ff;">new</span><span style="color: #000000;"> JFileDownloader()<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">            .setUrlPath(urlPath)<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">            .setDestFilePath(destFilePath)<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">            .setThreadCount(threadCount)<br></span><span style="color: #008080;">11</span>             .setFileDownloadListener(<span style="color: #0000ff;">new</span> JFileDownloadListener() { <span style="color: #008000;">//</span><span style="color: #008000;"> 设置进度监听器</span><br><span style="color: #008080;">12</span>                     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> downloadProgress(<span style="color: #0000ff;">int</span> progress, <span style="color: #0000ff;">double</span> speed, <span style="color: #0000ff;">long</span><span style="color: #000000;"> remainTime) {<br></span><span style="color: #008080;">13</span>                         System.out.println(“文件已下载：” + progress + “%，下载速度为：” + speed + “kb/s，剩余所需时间：” + remainTime + “毫秒”<span style="color: #000000;">);<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">15</span>                     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> downloadCompleted(File file, <span style="color: #0000ff;">long</span><span style="color: #000000;"> downloadTime) {<br></span><span style="color: #008080;">16</span>                         System.out.println(“文件：” + file.getName() + “下载完成，用时：” + downloadTime + “毫秒”<span style="color: #000000;">);<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">            });<br></span><span style="color: #008080;">19</span>     <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">20</span>         downloader.startDownload(); <span style="color: #008000;">//</span><span style="color: #008000;"> 开始下载</span><br><span style="color: #008080;">21</span>     } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">        e.printStackTrace();<br></span><span style="color: #008080;">23</span>     }</pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[[工具库]JOJSONBuilder工具类——一键把多个bean对象数据转换为JSON格式数据]]></title>
      <url>/2013/02/19/%E5%B7%A5%E5%85%B7%E5%BA%93-JOJSONBuilder%E5%B7%A5%E5%85%B7%E7%B1%BB%E2%80%94%E2%80%94%E4%B8%80%E9%94%AE%E6%8A%8A%E5%A4%9A%E4%B8%AAbean%E5%AF%B9%E8%B1%A1%E6%95%B0%E6%8D%AE%E8%BD%AC%E6%8D%A2%E4%B8%BAJSON%E6%A0%BC%E5%BC%8F%E6%95%B0%E6%8D%AE/</url>
      <content type="html"><![CDATA[<p>本人大四即将毕业的准程序员（JavaSE、JavaEE、android等）一枚，小项目也做过一点，于是乎一时兴起就写了一些工具。</p>
<p>我会在本博客中陆续发布一些平时可能会用到的工具。</p>
<p>代码质量可能不是很好，大家多担待！</p>
<p>代码或者思路有不妥之处，还希望大牛们能不吝赐教哈！</p>
<p>&nbsp;</p>
<p><span>以下代码为本人原创，转载请注明：</span></p>
<p><span>本文转载，来自：<a href="http://www.cnblogs.com/tiantianbyconan/archive/2013/02/19/2917433.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/archive/2013/02/19/2917433.html</a></span></p>
<p>&nbsp;</p>
<p>JOJSONBuilder工具类：一键把多个域对象数据转换为JSON格式数据，方便用于数据的传输和交互。功能类似于通过Gson来生成Json数据。</p>
<p><strong>源码如下：</strong></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('4379b86f-99f7-4b7d-81ce-f459e2888a57')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_4379b86f-99f7-4b7d-81ce-f459e2888a57" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.extrautil.jojsonbuilder;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Field;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Method;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Arrays;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Iterator;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Set;<br></span><span style="color: #008080;"> 10</span><br><span style="color: #008080;"> 11</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 12</span> <span style="color: #008000;"> <em><br></em></span><span style="color: #008080;"> 13</span> <span style="color: #008000;">  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 14</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2013-2-14 上午10:49:59<br></span><span style="color: #008080;"> 15</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> JOJSONBuilder {<br></span><span style="color: #008080;"> 17</span>     <span style="color: #0000ff;">private</span> List&lt;?&gt; list; <span style="color: #008000;">//</span><span style="color: #008000;"> 传入的List数据</span><br><span style="color: #008080;"> 18</span>     <span style="color: #0000ff;">private</span> StringBuilder result = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 19</span>     <span style="color: #0000ff;">private</span> List&lt;String&gt; includes = <span style="color: #0000ff;">null</span>; <span style="color: #008000;">//</span><span style="color: #008000;"> 要包含的属性列表</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">private</span> List&lt;String&gt; excludes = <span style="color: #0000ff;">null</span>; <span style="color: #008000;">//</span><span style="color: #008000;"> 要排除的属性列表</span><br><span style="color: #008080;"> 21</span><br><span style="color: #008080;"> 22</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 23</span> <span style="color: #008000;">     <em> 默认构造方法。&lt;br&gt;<br></em></span><span style="color: #008080;"> 24</span> <span style="color: #008000;">      使用此默认的构造方法之后必须要调用setList()传入List<br></span><span style="color: #008080;"> 25</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 26</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> JOJSONBuilder() {<br></span><span style="color: #008080;"> 27</span><br><span style="color: #008080;"> 28</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 29</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 30</span> <span style="color: #008000;">      此构造方法会把list中每项的所有属性信息都会生成在json中。<br></span><span style="color: #008080;"> 31</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> list 所要生成Json的List数据源<br></span><span style="color: #008080;"> 32</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 33</span>     <span style="color: #0000ff;">public</span> JOJSONBuilder(List&lt;?&gt;<span style="color: #000000;"> list) {<br></span><span style="color: #008080;"> 34</span>         <span style="color: #0000ff;">this</span>.list =<span style="color: #000000;"> list;<br></span><span style="color: #008080;"> 35</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 36</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 37</span> <span style="color: #008000;">     <em> 此构造方法提供list中每项属性信息的&lt;b&gt;包含&lt;/b&gt;和&lt;b&gt;排除&lt;/b&gt;。&lt;br&gt;<br></em></span><span style="color: #008080;"> 38</span> <span style="color: #008000;">      &lt;ol&gt;<br></span><span style="color: #008080;"> 39</span> <span style="color: #008000;">     <em> &lt;li&gt;使用includes，不使用excludes：只生成在includes中的信息&lt;br&gt;<br></em></span><span style="color: #008080;"> 40</span> <span style="color: #008000;">      &lt;li&gt;不使用includes，使用excludes：只生成不在excludes中的信息&lt;br&gt;<br></span><span style="color: #008080;"> 41</span> <span style="color: #008000;">     <em> &lt;li&gt;既使用includes，又使用exclude(不建议)：&lt;br&gt;<br></em></span><span style="color: #008080;"> 42</span> <span style="color: #008000;">       - 如果includes中和excludes中的信息不冲突，则生成不在excludes中的信息&lt;br&gt;<br></span><span style="color: #008080;"> 43</span> <span style="color: #008000;">     <em>  - 如果includes中和excludes中的信息冲突(某个属性都出现在这两个数组中)，则冲突部分的信息还是会生成&lt;br&gt;<br></em></span><span style="color: #008080;"> 44</span> <span style="color: #008000;">      &lt;li&gt;includes和excludes都不使用，则会把list中每项的所有属性信息都会生成在json中<br></span><span style="color: #008080;"> 45</span> <span style="color: #008000;">     <em> &lt;/ol&gt;<br></em></span><span style="color: #008080;"> 46</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> list 所要生成Json的List数据源。<br></span><span style="color: #008080;"> 47</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> includes 所要包含的属性名称数组。<br></span><span style="color: #008080;"> 48</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> excludes 所要排除的属性名称数组。<br></span><span style="color: #008080;"> 49</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 50</span>     <span style="color: #0000ff;">public</span> JOJSONBuilder(List&lt;?&gt;<span style="color: #000000;"> list, String[] includes, String[] excludes) {<br></span><span style="color: #008080;"> 51</span>         <span style="color: #0000ff;">this</span>.list =<span style="color: #000000;"> list;<br></span><span style="color: #008080;"> 52</span>         <span style="color: #0000ff;">this</span>.includes = <span style="color: #0000ff;">null</span> == includes || includes.length == 0 ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : Arrays.asList(includes);<br></span><span style="color: #008080;"> 53</span>         <span style="color: #0000ff;">this</span>.excludes = <span style="color: #0000ff;">null</span> == excludes || excludes.length == 0 ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : Arrays.asList(excludes);<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 55</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 56</span> <span style="color: #008000;">     <em> 获得正在进行生成json文件的信息来源List。<br></em></span><span style="color: #008080;"> 57</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 58</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回正在进行生成json文件的信息来源List<br></span><span style="color: #008080;"> 59</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 60</span>     <span style="color: #0000ff;">public</span> List&lt;?&gt;<span style="color: #000000;"> getList() {<br></span><span style="color: #008080;"> 61</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> list;<br></span><span style="color: #008080;"> 62</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 63</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 64</span> <span style="color: #008000;">     <em> 可使用此方法来传入、替换JOJSONBuilder对象中的List对象。<br></em></span><span style="color: #008080;"> 65</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 66</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> list 所要生成Json的List数据源。<br></span><span style="color: #008080;"> 67</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回当前JOJSONBuilder对象<br></span><span style="color: #008080;"> 68</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 69</span>     <span style="color: #0000ff;">public</span> JOJSONBuilder setList(List&lt;?&gt;<span style="color: #000000;"> list) {<br></span><span style="color: #008080;"> 70</span>         <span style="color: #0000ff;">this</span>.list =<span style="color: #000000;"> list;<br></span><span style="color: #008080;"> 71</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 72</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 73</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 74</span> <span style="color: #008000;">     <em> 设置包含的属性信息。<br></em></span><span style="color: #008080;"> 75</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 76</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> incFieldName 要包含的属性名<br></span><span style="color: #008080;"> 77</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回当前JOJSONBuilder对象<br></span><span style="color: #008080;"> 78</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 79</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> JOJSONBuilder setIncludes(String… incFieldName) {<br></span><span style="color: #008080;"> 80</span>         <span style="color: #0000ff;">this</span>.includes = <span style="color: #0000ff;">null</span> == incFieldName || incFieldName.length == 0 ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : Arrays.asList(incFieldName);<br></span><span style="color: #008080;"> 81</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 82</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 83</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 84</span> <span style="color: #008000;">      设置排除的属性信息。<br></span><span style="color: #008080;"> 85</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 86</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> excFieldName 要排除的属性名<br></span><span style="color: #008080;"> 87</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回当前JOJSONBuilder对象<br></span><span style="color: #008080;"> 88</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 89</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> JOJSONBuilder setExcludes(String… excFieldName) {<br></span><span style="color: #008080;"> 90</span>         <span style="color: #0000ff;">this</span>.excludes = <span style="color: #0000ff;">null</span> == excFieldName || excFieldName.length == 0 ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : Arrays.asList(excFieldName);<br></span><span style="color: #008080;"> 91</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 92</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 93</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 94</span> <span style="color: #008000;">     <em> 获得指定Class类型的所有属性，并打印在控制台上。<br></em></span><span style="color: #008080;"> 95</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 96</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> clazz 要获取的属性的类的Class对象。<br></span><span style="color: #008080;"> 97</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回该Class对象的所有属性。<br></span><span style="color: #008080;"> 98</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 99</span>     <span style="color: #0000ff;">public</span> Field[] getFields(Class&lt;?&gt;<span style="color: #000000;"> clazz) {<br></span><span style="color: #008080;">100</span>         Field[] fields =<span style="color: #000000;"> clazz.getDeclaredFields();<br></span><span style="color: #008080;">101</span>         System.out.print(“fields of the class that named “ + clazz.getName() + “: “<span style="color: #000000;">);<br></span><span style="color: #008080;">102</span>         <span style="color: #0000ff;">for</span><span style="color: #000000;">(Field field : fields){<br></span><span style="color: #008080;">103</span>             System.out.print(field.getName() + “, “<span style="color: #000000;">);<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">105</span> <span style="color: #000000;">        System.out.println();<br></span><span style="color: #008080;">106</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> fields;<br></span><span style="color: #008080;">107</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">108</span><br><span style="color: #008080;">109</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">110</span> <span style="color: #008000;">     <em> 根据list中的对象来生成对应的json文件。<br></em></span><span style="color: #008080;">111</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">112</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回生成的Json字符串。<br></span><span style="color: #008080;">113</span> <span style="color: #008000;">      </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> Exception 如果List检验不通过，则抛出异常。<br></span><span style="color: #008080;">114</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">115</span>     <span style="color: #0000ff;">public</span> StringBuilder jsonBuild() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception{<br></span><span style="color: #008080;">116</span>         <span style="color: #008000;">//</span><span style="color: #008000;">检验传入的List是否有效</span><br><span style="color: #008080;">117</span> <span style="color: #000000;">        checkValidityList();<br></span><span style="color: #008080;">118</span>         <span style="color: #008000;">//</span><span style="color: #008000;">json文件开始生成————————-</span><br><span style="color: #008080;">119</span>         result = <span style="color: #0000ff;">new</span><span style="color: #000000;"> StringBuilder();<br></span><span style="color: #008080;">120</span>         jsonSubBuild(list); <span style="color: #008000;">//</span><span style="color: #008000;"> 递归生成</span><br><span style="color: #008080;">121</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> result;<br></span><span style="color: #008080;">122</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">123</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">124</span> <span style="color: #008000;">      生成json可递归部分的子数据（根据某些对象组成的List来生成属性json文件）<br></span><span style="color: #008080;">125</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">126</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> list<br></span><span style="color: #008080;">127</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">128</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> jsonSubBuild(List&lt;?&gt;<span style="color: #000000;"> list){<br></span><span style="color: #008080;">129</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Class&lt;?&gt; clazz = list.get(0).getClass(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> 获取对应的Class对象</span><br><span style="color: #008080;">130</span>         Object curObj = <span style="color: #0000ff;">null</span>; <span style="color: #008000;">//</span><span style="color: #008000;"> 每次循环当前的类对象（资源）</span><br><span style="color: #008080;">131</span>         <span style="color: #0000ff;">int</span> listLength = list.size(); <span style="color: #008000;">//</span><span style="color: #008000;"> 类对象个数<br></span><span style="color: #008080;">132</span> <span style="color: #008000;">//</span><span style="color: #008000;">        String simpleName = clazz.getSimpleName(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> 获取类名（不含包名）</span><br><span style="color: #008080;">133</span><br><span style="color: #008080;">134</span>         result.append(“[“); <span style="color: #008000;">//</span><span style="color: #008000;"> 根标签开始</span><br><span style="color: #008080;">135</span><br><span style="color: #008080;">136</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; listLength; i++<span style="color: #000000;">){<br></span><span style="color: #008080;">137</span>             <span style="color: #0000ff;">if</span>(i != 0<span style="color: #000000;">){<br></span><span style="color: #008080;">138</span>                 result.append(“,”<span style="color: #000000;">);<br></span><span style="color: #008080;">139</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">140</span>             curObj =<span style="color: #000000;"> list.get(i);<br></span><span style="color: #008080;">141</span>             jsonSubSubBuild(curObj, list); <span style="color: #008000;">//</span><span style="color: #008000;"> 子数据递归</span><br><span style="color: #008080;">142</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">143</span><br><span style="color: #008080;">144</span>         result.append(“]”); <span style="color: #008000;">//</span><span style="color: #008000;"> 根标签结束</span><br><span style="color: #008080;">145</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">146</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">147</span> <span style="color: #008000;">      生成json可递归部分的子子数据（根据某个对象来生成属性json文件）<br></span><span style="color: #008080;">148</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">149</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> curObj 要生成json文件的那个对象<br></span><span style="color: #008080;">150</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> list curObj参数属于的那个List<br></span><span style="color: #008080;">151</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">152</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> jsonSubSubBuild(Object curObj, List&lt;?&gt;<span style="color: #000000;"> list){<br></span><span style="color: #008080;">153</span>         String fieldName = “”; <span style="color: #008000;">//</span><span style="color: #008000;"> 每次要调用的属性名</span><br><span style="color: #008080;">154</span>         String methodName = “”; <span style="color: #008000;">//</span><span style="color: #008000;"> 每次要调用的方法名</span><br><span style="color: #008080;">155</span>         Method method = <span style="color: #0000ff;">null</span>;; <span style="color: #008000;">//</span><span style="color: #008000;"> 每次要调用的方法</span><br><span style="color: #008080;">156</span>         Object value = “”; <span style="color: #008000;">//</span><span style="color: #008000;"> 每次要获得的属性值（子标签）</span><br><span style="color: #008080;">157</span><br><span style="color: #008080;">158</span>         Class&lt;?&gt; clazz =<span style="color: #000000;"> curObj.getClass();<br></span><span style="color: #008080;">159</span>         Field[] fields = getFields(clazz); <span style="color: #008000;">//</span><span style="color: #008000;"> 获得对应类型的所有变量</span><br><span style="color: #008080;">160</span>         <span style="color: #0000ff;">int</span> fieldsLength = fields.length; <span style="color: #008000;">//</span><span style="color: #008000;"> 类对象的属性数量</span><br><span style="color: #008080;">161</span><br><span style="color: #008080;">162</span>         result.append(“{“<span style="color: #000000;">);<br></span><span style="color: #008080;">163</span>         <span style="color: #0000ff;">int</span> offset = 0; <span style="color: #008000;">//</span><span style="color: #008000;"> 包含的第一个属性偏移量</span><br><span style="color: #008080;">164</span>         <span style="color: #0000ff;">int</span> temp = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">165</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> j = 0; j &lt; fieldsLength; j++<span style="color: #000000;">){<br></span><span style="color: #008080;">166</span>             fieldName = fields[j].getName(); <span style="color: #008000;">//</span><span style="color: #008000;"> 获取对应属性名</span><br><span style="color: #008080;">167</span><br><span style="color: #008080;">168</span>             <span style="color: #0000ff;">if</span>(list == <span style="color: #0000ff;">this</span>.list){ <span style="color: #008000;">//</span><span style="color: #008000;"> 只在最外层的类的属性中进行排除包含<br></span><span style="color: #008080;">169</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 使用includes，不使用excludes：只生成在includes中的信息</span><br><span style="color: #008080;">170</span>                 <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> != includes &amp;&amp; <span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> excludes){<br></span><span style="color: #008080;">171</span>                     <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">includes.contains(fieldName)){<br></span><span style="color: #008080;">172</span>                         <span style="color: #0000ff;">continue</span><span style="color: #000000;">;<br></span><span style="color: #008080;">173</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">174</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">175</span><br><span style="color: #008080;">176</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">不使用includes，使用excludes：只生成不在excludes中的信息</span><br><span style="color: #008080;">177</span>                 <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> == includes &amp;&amp; <span style="color: #0000ff;">null</span> != excludes){ <span style="color: #008000;">//</span><span style="color: #008000;"> 只使用了不包含</span><br><span style="color: #008080;">178</span>                     <span style="color: #0000ff;">if</span><span style="color: #000000;">(excludes.contains(fieldName)){<br></span><span style="color: #008080;">179</span>                         <span style="color: #0000ff;">continue</span><span style="color: #000000;">;<br></span><span style="color: #008080;">180</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">181</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">182</span><br><span style="color: #008080;">183</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">既使用includes，又使用exclude(不建议)：<br></span><span style="color: #008080;">184</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">- 如果includes中和excludes中的信息不冲突，则生成不在excludes中的信息<br></span><span style="color: #008080;">185</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">- 如果includes中和excludes中的信息冲突(某个属性都出现在这两个数组中)，则冲突部分的信息还是会生成</span><br><span style="color: #008080;">186</span>                 <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> != includes &amp;&amp; <span style="color: #0000ff;">null</span> != excludes){ <span style="color: #008000;">//</span><span style="color: #008000;"> 既使用了包含，又使用了不包含</span><br><span style="color: #008080;">187</span>                     <span style="color: #0000ff;">if</span>(!includes.contains(fieldName) &amp;&amp;<span style="color: #000000;"> excludes.contains(fieldName)){<br></span><span style="color: #008080;">188</span>                         <span style="color: #0000ff;">continue</span><span style="color: #000000;">;<br></span><span style="color: #008080;">189</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">190</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">191</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 记录第一个包含的属性的索引</span><br><span style="color: #008080;">192</span>                 <span style="color: #0000ff;">if</span>(0 ==<span style="color: #000000;"> temp){<br></span><span style="color: #008080;">193</span>                     offset =<span style="color: #000000;"> j;<br></span><span style="color: #008080;">194</span>                     temp++<span style="color: #000000;">;<br></span><span style="color: #008080;">195</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">196</span> <span style="color: #008000;">//</span><span style="color: #008000;">                offset = 0 == temp++ ? j : 0;</span><br><span style="color: #008080;">197</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">198</span><br><span style="color: #008080;">199</span>             methodName =<span style="color: #000000;"> getGetterMethodNameByFieldName(fields[j]);<br></span><span style="color: #008080;">200</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">201</span>                 method = clazz.getDeclaredMethod(methodName, <span style="color: #0000ff;">new</span><span style="color: #000000;"> Class[]{});<br></span><span style="color: #008080;">202</span>                 method.setAccessible(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">203</span>                 value = method.invoke(curObj, <span style="color: #0000ff;">new</span><span style="color: #000000;"> Object[]{});<br></span><span style="color: #008080;">204</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></span><br><span style="color: #008080;">205</span>                 <span style="color: #0000ff;">if</span>(j != offset){ <span style="color: #008000;">//</span><span style="color: #008000;"> 第一个属性前面不加”,”</span><br><span style="color: #008080;">206</span>                     result.append(“,”<span style="color: #000000;">);<br></span><span style="color: #008080;">207</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">208</span>                 result.append(“‘“ + fieldName + “‘:”<span style="color: #000000;">);<br></span><span style="color: #008080;">209</span>                 <span style="color: #0000ff;">if</span>(fields[j].getType() == List.<span style="color: #0000ff;">class</span>){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果属性是List类型</span><br><span style="color: #008080;">210</span>                     List&lt;?&gt; subList = (List&lt;?&gt;<span style="color: #000000;">)value;<br></span><span style="color: #008080;">211</span>                     jsonSubBuild(subList); <span style="color: #008000;">//</span><span style="color: #008000;"> 子数据递归</span><br><span style="color: #008080;">212</span>                 }<span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(fields[j].getType() == Set.<span style="color: #0000ff;">class</span>){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果属性是Set类型的</span><br><span style="color: #008080;">213</span>                     Set&lt;?&gt; subSet = (Set&lt;?&gt;<span style="color: #000000;">)value;<br></span><span style="color: #008080;">214</span>                     Iterator&lt;?&gt; iter =<span style="color: #000000;"> subSet.iterator();<br></span><span style="color: #008080;">215</span>                     List&lt;Object&gt; subList = <span style="color: #0000ff;">new</span> ArrayList&lt;Object&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">216</span>                     <span style="color: #0000ff;">while</span><span style="color: #000000;">(iter.hasNext()){<br></span><span style="color: #008080;">217</span> <span style="color: #000000;">                        subList.add(iter.next());<br></span><span style="color: #008080;">218</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">219</span>                     jsonSubBuild(subList); <span style="color: #008000;">//</span><span style="color: #008000;"> 子数据递归</span><br><span style="color: #008080;">220</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">221</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 如果ClassLoader不是null表示该类不是启动类加载器加载的，不是Java API的类，是自己写的java类</span><br><span style="color: #008080;">222</span>                 <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> fields[j].getType().getClassLoader()){<br></span><span style="color: #008080;">223</span>                     jsonSubSubBuild(value, <span style="color: #0000ff;">null</span>); <span style="color: #008000;">//</span><span style="color: #008000;"> 子子数据递归</span><br><span style="color: #008080;">224</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">225</span>                 <span style="color: #0000ff;">else</span>{ <span style="color: #008000;">//</span><span style="color: #008000;"> 其它类型都认为是普通文本类型<br></span><span style="color: #008080;">226</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 添加子元素（类属性）标签</span><br><span style="color: #008080;">227</span>                     <span style="color: #0000ff;">if</span>(value.getClass() == String.<span style="color: #0000ff;">class</span><span style="color: #000000;">){<br></span><span style="color: #008080;">228</span>                         result.append(“‘“ + value + “‘“<span style="color: #000000;">);<br></span><span style="color: #008080;">229</span>                     }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;">230</span> <span style="color: #000000;">                        result.append(value.toString());<br></span><span style="color: #008080;">231</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">232</span><br><span style="color: #008080;">233</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">234</span><br><span style="color: #008080;">235</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></span><br><span style="color: #008080;">236</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">237</span> <span style="color: #000000;">                e.printStackTrace();<br></span><span style="color: #008080;">238</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">239</span><br><span style="color: #008080;">240</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">241</span>         result.append(“}”<span style="color: #000000;">);<br></span><span style="color: #008080;">242</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">243</span><br><span style="color: #008080;">244</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">245</span> <span style="color: #008000;">     <em> &lt;ol&gt;通过属性Field对象来获取getter方法的方法名。&lt;br&gt;<br></em></span><span style="color: #008080;">246</span> <span style="color: #008000;">      如果是boolean或Boolean类型(正则表达式来判断):isBorrow–&gt;isBorrow();isborrow–&gt;isIsborrow();&lt;br&gt;<br></span><span style="color: #008080;">247</span> <span style="color: #008000;">     <em> 否则:borrow–&gt;getBorrow();<br></em></span><span style="color: #008080;">248</span> <span style="color: #008000;">      &lt;/ol&gt;<br></span><span style="color: #008080;">249</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">250</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> field 要生成getter方法的对应属性对象。<br></span><span style="color: #008080;">251</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回getter方法的方法名。<br></span><span style="color: #008080;">252</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">253</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String getGetterMethodNameByFieldName(Field field){<br></span><span style="color: #008080;">254</span>         String methodName = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">255</span>         String fieldName =<span style="color: #000000;"> field.getName();<br></span><span style="color: #008080;">256</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 解析属性对应的getter方法名<br></span><span style="color: #008080;">257</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 判断是否是boolean或Boolean类型:isBorrow–&gt;isBorrow();isborrow–&gt;isIsborrow()</span><br><span style="color: #008080;">258</span>         <span style="color: #0000ff;">if</span>(field.getType() == <span style="color: #0000ff;">boolean</span>.<span style="color: #0000ff;">class</span> || field.getType() == Boolean.<span style="color: #0000ff;">class</span><span style="color: #000000;">){<br></span><span style="color: #008080;">259</span>             <span style="color: #0000ff;">if</span>(fieldName.matches(“^is[A-Z].*”<span style="color: #000000;">)){<br></span><span style="color: #008080;">260</span>                 methodName =<span style="color: #000000;"> fieldName;<br></span><span style="color: #008080;">261</span>             }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;">262</span>                 methodName = “is” + fieldName.substring(0, 1).toUpperCase() + fieldName.substring(1<span style="color: #000000;">);<br></span><span style="color: #008080;">263</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">264</span>         }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;">265</span>             methodName = “get” + fieldName.substring(0, 1).toUpperCase() + fieldName.substring(1<span style="color: #000000;">);<br></span><span style="color: #008080;">266</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">267</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> methodName;<br></span><span style="color: #008080;">268</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">269</span><br><span style="color: #008080;">270</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">271</span> <span style="color: #008000;">     <em> 检验传入的List的合法性（List是不是为null、长度是不是为0、是不是每项都是同一个类型）<br></em></span><span style="color: #008080;">272</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">273</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@throws</span><span style="color: #008000;"> Exception 如果List为null, 或者长度为, 或者每项不是同一个类型, 抛出异常<br></span><span style="color: #008080;">274</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">275</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> checkValidityList() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception{<br></span><span style="color: #008080;">276</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> list){<br></span><span style="color: #008080;">277</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(“请保证传入的List不为null”<span style="color: #000000;">);<br></span><span style="color: #008080;">278</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">279</span>         <span style="color: #0000ff;">int</span> size =<span style="color: #000000;"> list.size();<br></span><span style="color: #008080;">280</span>         <span style="color: #0000ff;">if</span>(list.size() == 0<span style="color: #000000;">){<br></span><span style="color: #008080;">281</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(“请保证传入的List长度不为0”<span style="color: #000000;">);<br></span><span style="color: #008080;">282</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">283</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 1; i &lt; size; i++<span style="color: #000000;">){<br></span><span style="color: #008080;">284</span>             <span style="color: #0000ff;">if</span>(list.get(0).getClass() !=<span style="color: #000000;"> list.get(i).getClass()){<br></span><span style="color: #008080;">285</span>                 <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(“请保证传入的List每项都是同一个类型”<span style="color: #000000;">);<br></span><span style="color: #008080;">286</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">287</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">288</span><br><span style="color: #008080;">289</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">290</span><br><span style="color: #008080;">291</span><br><span style="color: #008080;">292</span><br><span style="color: #008080;">293</span> }</pre><br></div><br></div>

<p>&nbsp;</p>
<p><strong>使用方法如下：</strong></p>
<p>例如:<br><strong>Student类</strong>(该类有属性name，age，isBoy，books等属性；其中books属性是一个List，存放Book对象)：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">private</span><span style="color: #000000;"> String name;<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> age;<br></span><span style="color: #008080;">3</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isBoy;<br></span><span style="color: #008080;">4</span> <span style="color: #0000ff;">private</span> List&lt;Book&gt;<span style="color: #000000;"> books;<br></span><span style="color: #008080;">5</span> <span style="color: #008000;">//</span><span style="color: #008000;">并实现getter和setter方法；</span></pre><br></div>

<p>&nbsp;</p>
<p><strong>Book类</strong>(该类有属性name，author，number，length，width，isBorrowed等属性)：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">private</span><span style="color: #000000;"> String name;<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">private</span><span style="color: #000000;"> String author;<br></span><span style="color: #008080;">3</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> number;<br></span><span style="color: #008080;">4</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">float</span><span style="color: #000000;"> length;<br></span><span style="color: #008080;">5</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">float</span><span style="color: #000000;"> width;<br></span><span style="color: #008080;">6</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isBorrowed;<br></span><span style="color: #008080;">7</span> <span style="color: #008000;">//</span><span style="color: #008000;">并实现getter和setter方法；</span></pre><br></div>

<p>&nbsp;</p>
<p>现在有一个List&lt;Student&gt;类型的数据，通过以下代码把该List转换为Json：</p>
<div class="cnblogs_code"><br><pre>List&lt;Student&gt; list = <span style="color: #0000ff;">new</span> ArrayList&lt;Student&gt;<span style="color: #000000;">();<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;">构建几个Student对象，放入list中<br></span><span style="color: #008000;">//</span><span style="color: #008000;">&hellip;&hellip;<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;">完整数据版（不使用includes和excludes）</span><br>JOJSONBuilder jsonBuilder = <span style="color: #0000ff;">new</span><span style="color: #000000;"> JOJSONBuilder(list);<br>String content </span>=<span style="color: #000000;"> jsonBuilder.jsonBuild().toString();<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;">或者使用包括/排除：</span><br>JOJSONBuilder jsonBuilder = <span style="color: #0000ff;">new</span> JOJSONBuilder(list, <span style="color: #0000ff;">new</span> String[]{“name”, “age”}, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br>jsonBuilder.jsonBuild().toString();<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;">或者使用方法链风格：</span><br><span style="color: #0000ff;">new</span> JOJSONBuilder().setExcludes(“name”, “age”).jsonBuild().toString();</pre><br></div>

<p>&nbsp;</p>
<p><span>转换之后的Json（完整数据版（不使用includes和excludes））：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">[<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">        {<br></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">                ‘name’:’hello’,<br></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">                ‘age’:23,<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">                ‘isBoy’:true,<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">                ‘books’:[<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">                                        {<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">                                                ‘name’:’book1’,<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">                                                ‘author’:’author1’,<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">                                                ‘number’:123,<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">                                                ‘length’:23.5,<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">                                                ‘width’:18.0,<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">                                                ‘isBorrowed’:true<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">                                        },<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">                                        {<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">                                                ‘name’:’book2’,<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">                                                ‘author’:’author2’,<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">                                                ‘number’:43,<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">                                                ‘length’:42.23,<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">                                                ‘width’:30.57,<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">                                                ‘isBorrowed’:false<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">                                        }<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">                                ]<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">        },<br></span><span style="color: #008080;">25</span><br><span style="color: #008080;">26</span> <span style="color: #000000;">        {<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">                ‘name’:’world’,<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">                ‘age’:22,<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">                ‘isBoy’:false,<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">                ‘books’:[<br></span><span style="color: #008080;">31</span> <span style="color: #000000;">                                        {<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">                                                ‘name’:’book1’,<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">                                                ‘author’:’author1’,<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">                                                ‘number’:123,<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">                                                ‘length’:23.5,<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">                                                ‘width’:18.0,<br></span><span style="color: #008080;">37</span> <span style="color: #000000;">                                                ‘isBorrowed’:true<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">                                        },<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">                                        {<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">                                                ‘name’:’book3’,<br></span><span style="color: #008080;">41</span> <span style="color: #000000;">                                                ‘author’:’author3’,<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">                                                ‘number’:875,<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">                                                ‘length’:20.59,<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">                                                ‘width’:15.08,<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">                                                ‘isBorrowed’:false<br></span><span style="color: #008080;">46</span> <span style="color: #000000;">                                        },<br></span><span style="color: #008080;">47</span> <span style="color: #000000;">                                        {<br></span><span style="color: #008080;">48</span> <span style="color: #000000;">                                                ‘name’:’book4’,<br></span><span style="color: #008080;">49</span> <span style="color: #000000;">                                                ‘author’:’author4’,<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">                                                ‘number’:165,<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">                                                ‘length’:22.75,<br></span><span style="color: #008080;">52</span> <span style="color: #000000;">                                                ‘width’:19.61,<br></span><span style="color: #008080;">53</span> <span style="color: #000000;">                                                ‘isBorrowed’:true<br></span><span style="color: #008080;">54</span> <span style="color: #000000;">                                        }<br></span><span style="color: #008080;">55</span> <span style="color: #000000;">                                ]<br></span><span style="color: #008080;">56</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">57</span> ]</pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[[工具库]JOXMLBuilder工具类——一键把多个bean对象数据转换为XML格式数据]]></title>
      <url>/2013/02/19/%E5%B7%A5%E5%85%B7%E5%BA%93-JOXMLBuilder%E5%B7%A5%E5%85%B7%E7%B1%BB%E2%80%94%E2%80%94%E4%B8%80%E9%94%AE%E6%8A%8A%E5%A4%9A%E4%B8%AAbean%E5%AF%B9%E8%B1%A1%E6%95%B0%E6%8D%AE%E8%BD%AC%E6%8D%A2%E4%B8%BAXML%E6%A0%BC%E5%BC%8F%E6%95%B0%E6%8D%AE/</url>
      <content type="html"><![CDATA[<p>本人大四即将毕业的准程序员（JavaSE、JavaEE、android等）一枚，小项目也做过一点，于是乎一时兴起就写了一些工具。</p>
<p>我会在本博客中陆续发布一些平时可能会用到的工具。</p>
<p>代码质量可能不是很好，大家多担待！</p>
<p>代码或者思路有不妥之处，还希望大牛们能不吝赐教哈！</p>
<p>&nbsp;</p>
<p><span style="color: #993300;">以下代码为本人原创，转载请注明：</span></p>
<p><span style="color: #993300;">本文转载，来自：<a href="http://www.cnblogs.com/tiantianbyconan/archive/2013/02/19/2917398.html" target="_blank" rel="noopener"><span style="color: #993300;">http://www.cnblogs.com/tiantianbyconan/archive/2013/02/19/2917398.html</span></a></span></p>
<p>&nbsp;</p>
<p>JOXMLBuilder工具类：一键把多个域对象数据转换为XML格式数据，方便用于数据的传输和交互。功能类似于通过Gson来生成Json数据。</p>
<p><strong>源码如下：</strong></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('4af7ec8c-18bf-4351-8053-b1c90a923182')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_4af7ec8c-18bf-4351-8053-b1c90a923182" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.extrautil.joxmlbuilder;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Field;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Method;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Arrays;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Iterator;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Set;<br></span><span style="color: #008080;"> 10</span><br><span style="color: #008080;"> 11</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 12</span> <span style="color: #008000;"> <em><br></em></span><span style="color: #008080;"> 13</span> <span style="color: #008000;">  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 14</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2013-2-3 下午3:49:59<br></span><span style="color: #008080;"> 15</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> JOXMLBuilder {<br></span><span style="color: #008080;"> 17</span>     <span style="color: #0000ff;">private</span> List&lt;?&gt; list; <span style="color: #008000;">//</span><span style="color: #008000;"> 传入的List数据</span><br><span style="color: #008080;"> 18</span>     <span style="color: #0000ff;">private</span> StringBuilder result = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 19</span>     <span style="color: #0000ff;">private</span> List&lt;String&gt; includes = <span style="color: #0000ff;">null</span>; <span style="color: #008000;">//</span><span style="color: #008000;"> 要包含的属性列表</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">private</span> List&lt;String&gt; excludes = <span style="color: #0000ff;">null</span>; <span style="color: #008000;">//</span><span style="color: #008000;"> 要排除的属性列表</span><br><span style="color: #008080;"> 21</span><br><span style="color: #008080;"> 22</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 23</span> <span style="color: #008000;">     <em> 默认构造方法。&lt;br&gt;<br></em></span><span style="color: #008080;"> 24</span> <span style="color: #008000;">      使用此默认的构造方法之后必须要调用setList()传入List<br></span><span style="color: #008080;"> 25</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 26</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> JOXMLBuilder() {<br></span><span style="color: #008080;"> 27</span><br><span style="color: #008080;"> 28</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 29</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 30</span> <span style="color: #008000;">      此构造方法会把list中每项的所有属性信息都会生成在xml中。<br></span><span style="color: #008080;"> 31</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> list 所要生成xml的List数据源。<br></span><span style="color: #008080;"> 32</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 33</span>     <span style="color: #0000ff;">public</span> JOXMLBuilder(List&lt;?&gt;<span style="color: #000000;"> list) {<br></span><span style="color: #008080;"> 34</span>         <span style="color: #0000ff;">this</span>.list =<span style="color: #000000;"> list;<br></span><span style="color: #008080;"> 35</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 36</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 37</span> <span style="color: #008000;">     <em> 此构造方法提供list中每项属性信息的&lt;b&gt;包含&lt;/b&gt;和&lt;b&gt;排除&lt;/b&gt;。&lt;br&gt;<br></em></span><span style="color: #008080;"> 38</span> <span style="color: #008000;">      &lt;ol&gt;<br></span><span style="color: #008080;"> 39</span> <span style="color: #008000;">     <em> &lt;li&gt;使用includes，不使用excludes：只生成在includes中的信息&lt;br&gt;<br></em></span><span style="color: #008080;"> 40</span> <span style="color: #008000;">      &lt;li&gt;不使用includes，使用excludes：只生成不在excludes中的信息&lt;br&gt;<br></span><span style="color: #008080;"> 41</span> <span style="color: #008000;">     <em> &lt;li&gt;既使用includes，又使用exclude(不建议)：&lt;br&gt;<br></em></span><span style="color: #008080;"> 42</span> <span style="color: #008000;">       - 如果includes中和excludes中的信息不冲突，则生成不在excludes中的信息&lt;br&gt;<br></span><span style="color: #008080;"> 43</span> <span style="color: #008000;">     <em>  - 如果includes中和excludes中的信息冲突(某个属性都出现在这两个数组中)，则冲突部分的信息还是会生成&lt;br&gt;<br></em></span><span style="color: #008080;"> 44</span> <span style="color: #008000;">      &lt;li&gt;includes和excludes都不使用，则会把list中每项的所有属性信息都会生成在xml中<br></span><span style="color: #008080;"> 45</span> <span style="color: #008000;">     <em> &lt;/ol&gt;<br></em></span><span style="color: #008080;"> 46</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> list 所要生成Json的List数据源。<br></span><span style="color: #008080;"> 47</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> includes 所要包含的属性名称数组。<br></span><span style="color: #008080;"> 48</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> excludes 所要排除的属性名称数组。<br></span><span style="color: #008080;"> 49</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 50</span>     <span style="color: #0000ff;">public</span> JOXMLBuilder(List&lt;?&gt;<span style="color: #000000;"> list, String[] includes, String[] excludes) {<br></span><span style="color: #008080;"> 51</span>         <span style="color: #0000ff;">this</span>.list =<span style="color: #000000;"> list;<br></span><span style="color: #008080;"> 52</span>         <span style="color: #0000ff;">this</span>.includes = <span style="color: #0000ff;">null</span> == includes || includes.length == 0 ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : Arrays.asList(includes);<br></span><span style="color: #008080;"> 53</span>         <span style="color: #0000ff;">this</span>.excludes = <span style="color: #0000ff;">null</span> == excludes || excludes.length == 0 ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : Arrays.asList(excludes);<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 55</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 56</span> <span style="color: #008000;">     <em> 返回正在进行生成xml文件的信息来源List。<br></em></span><span style="color: #008080;"> 57</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 58</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回正在进行生成xml文件的信息来源List。<br></span><span style="color: #008080;"> 59</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 60</span>     <span style="color: #0000ff;">public</span> List&lt;?&gt;<span style="color: #000000;"> getList() {<br></span><span style="color: #008080;"> 61</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> list;<br></span><span style="color: #008080;"> 62</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 63</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 64</span> <span style="color: #008000;">     <em> 可使用此方法来传入、替换JOXMLBuilder对象中的List对象。<br></em></span><span style="color: #008080;"> 65</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 66</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> list 所要生成xml的List数据源。<br></span><span style="color: #008080;"> 67</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回当前JOXMLBuilder对象<br></span><span style="color: #008080;"> 68</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 69</span>     <span style="color: #0000ff;">public</span> JOXMLBuilder setList(List&lt;?&gt;<span style="color: #000000;"> list) {<br></span><span style="color: #008080;"> 70</span>         <span style="color: #0000ff;">this</span>.list =<span style="color: #000000;"> list;<br></span><span style="color: #008080;"> 71</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 72</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 73</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 74</span> <span style="color: #008000;">     <em> 设置包含的属性信息。<br></em></span><span style="color: #008080;"> 75</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 76</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> incFieldName 要包含的属性名<br></span><span style="color: #008080;"> 77</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回当前JOXMLBuilder对象<br></span><span style="color: #008080;"> 78</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 79</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> JOXMLBuilder setIncludes(String… incFieldName) {<br></span><span style="color: #008080;"> 80</span>         <span style="color: #0000ff;">this</span>.includes = <span style="color: #0000ff;">null</span> == incFieldName || incFieldName.length == 0 ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : Arrays.asList(incFieldName);<br></span><span style="color: #008080;"> 81</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 82</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 83</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 84</span> <span style="color: #008000;">      设置排除的属性信息。<br></span><span style="color: #008080;"> 85</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 86</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> excFieldName 要排除的属性名<br></span><span style="color: #008080;"> 87</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回当前JOXMLBuilder对象<br></span><span style="color: #008080;"> 88</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 89</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> JOXMLBuilder setExcludes(String… excFieldName) {<br></span><span style="color: #008080;"> 90</span>         <span style="color: #0000ff;">this</span>.excludes = <span style="color: #0000ff;">null</span> == excFieldName || excFieldName.length == 0 ? <span style="color: #0000ff;">null</span><span style="color: #000000;"> : Arrays.asList(excFieldName);<br></span><span style="color: #008080;"> 91</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 92</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 93</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 94</span> <span style="color: #008000;">     <em> 获得指定Class类型的所有属性，并打印在控制台上。<br></em></span><span style="color: #008080;"> 95</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;"> 96</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 97</span>     <span style="color: #0000ff;">public</span> Field[] getFields(Class&lt;?&gt;<span style="color: #000000;"> clazz) {<br></span><span style="color: #008080;"> 98</span>         Field[] fields =<span style="color: #000000;"> clazz.getDeclaredFields();<br></span><span style="color: #008080;"> 99</span>         System.out.print(“fields of the class that named “ + clazz.getName() + “: “<span style="color: #000000;">);<br></span><span style="color: #008080;">100</span>         <span style="color: #0000ff;">for</span><span style="color: #000000;">(Field field : fields){<br></span><span style="color: #008080;">101</span>             System.out.print(field.getName() + “, “<span style="color: #000000;">);<br></span><span style="color: #008080;">102</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">103</span> <span style="color: #000000;">        System.out.println();<br></span><span style="color: #008080;">104</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> fields;<br></span><span style="color: #008080;">105</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">106</span><br><span style="color: #008080;">107</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">108</span> <span style="color: #008000;">     <em> 根据list中的对象来生成对应的xml文件。<br></em></span><span style="color: #008080;">109</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">110</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回生成的xml字符串。<br></span><span style="color: #008080;">111</span> <span style="color: #008000;">      </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> Exception 如果List检验不通过，则抛出异常<br></span><span style="color: #008080;">112</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">113</span>     <span style="color: #0000ff;">public</span> StringBuilder xmlBuild() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception{<br></span><span style="color: #008080;">114</span>         <span style="color: #008000;">//</span><span style="color: #008000;">检验传入的List是否有效</span><br><span style="color: #008080;">115</span> <span style="color: #000000;">        checkValidityList();<br></span><span style="color: #008080;">116</span>         <span style="color: #008000;">//</span><span style="color: #008000;">XML文件开始生成————————-</span><br><span style="color: #008080;">117</span>         result = <span style="color: #0000ff;">new</span> StringBuilder(“&lt;?xml version=\”1.0\” encoding=\”utf-8\”?&gt;”<span style="color: #000000;">);<br></span><span style="color: #008080;">118</span>         xmlSubBuild(list); <span style="color: #008000;">//</span><span style="color: #008000;"> 递归生成</span><br><span style="color: #008080;">119</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> result;<br></span><span style="color: #008080;">120</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">121</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">122</span> <span style="color: #008000;">      生成xml可递归部分的子数据（根据某些对象组成的List来生成属性xml文件）。<br></span><span style="color: #008080;">123</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">124</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> list<br></span><span style="color: #008080;">125</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">126</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> xmlSubBuild(List&lt;?&gt;<span style="color: #000000;"> list){<br></span><span style="color: #008080;">127</span>         Class&lt;?&gt; clazz = list.get(0).getClass(); <span style="color: #008000;">//</span><span style="color: #008000;"> 获取对应的Class对象</span><br><span style="color: #008080;">128</span>         Object curObj = <span style="color: #0000ff;">null</span>; <span style="color: #008000;">//</span><span style="color: #008000;"> 每次循环当前的类对象（资源）</span><br><span style="color: #008080;">129</span>         <span style="color: #0000ff;">int</span> listLength = list.size(); <span style="color: #008000;">//</span><span style="color: #008000;"> 类对象个数</span><br><span style="color: #008080;">130</span>         String simpleName = clazz.getSimpleName(); <span style="color: #008000;">//</span><span style="color: #008000;"> 获取类名（不含包名）</span><br><span style="color: #008080;">131</span><br><span style="color: #008080;">132</span>         result.append(“&lt;” + simpleName + “All&gt;”); <span style="color: #008000;">//</span><span style="color: #008000;"> 根标签开始</span><br><span style="color: #008080;">133</span><br><span style="color: #008080;">134</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; listLength; i++<span style="color: #000000;">){<br></span><span style="color: #008080;">135</span>             curObj =<span style="color: #000000;"> list.get(i);<br></span><span style="color: #008080;">136</span>             xmlSubSubBuild(curObj, list); <span style="color: #008000;">//</span><span style="color: #008000;"> 子数据递归</span><br><span style="color: #008080;">137</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">138</span><br><span style="color: #008080;">139</span>         result.append(“&lt;/“ + simpleName + “All&gt;”); <span style="color: #008000;">//</span><span style="color: #008000;"> 根标签结束</span><br><span style="color: #008080;">140</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">141</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">142</span> <span style="color: #008000;">      生成xml可递归部分的子子数据（根据某个对象来生成属性xml文件）。<br></span><span style="color: #008080;">143</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">144</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> curObj 要生成xml文件的那个对象<br></span><span style="color: #008080;">145</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> list curObj参数属于的那个List<br></span><span style="color: #008080;">146</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">147</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> xmlSubSubBuild(Object curObj, List&lt;?&gt;<span style="color: #000000;"> list){<br></span><span style="color: #008080;">148</span>         String fieldName = “”; <span style="color: #008000;">//</span><span style="color: #008000;"> 每次要调用的属性名</span><br><span style="color: #008080;">149</span>         String methodName = “”; <span style="color: #008000;">//</span><span style="color: #008000;"> 每次要调用的方法名</span><br><span style="color: #008080;">150</span>         Method method = <span style="color: #0000ff;">null</span>;; <span style="color: #008000;">//</span><span style="color: #008000;"> 每次要调用的方法</span><br><span style="color: #008080;">151</span>         Object value = “”; <span style="color: #008000;">//</span><span style="color: #008000;"> 每次要获得的属性值（子标签）</span><br><span style="color: #008080;">152</span><br><span style="color: #008080;">153</span>         Class&lt;?&gt; clazz =<span style="color: #000000;"> curObj.getClass();<br></span><span style="color: #008080;">154</span>         Field[] fields = getFields(clazz); <span style="color: #008000;">//</span><span style="color: #008000;"> 获得对应类型的所有变量</span><br><span style="color: #008080;">155</span>         <span style="color: #0000ff;">int</span> fieldsLength = fields.length; <span style="color: #008000;">//</span><span style="color: #008000;"> 类对象的属性数量</span><br><span style="color: #008080;">156</span><br><span style="color: #008080;">157</span>         String simpleName = clazz.getSimpleName(); <span style="color: #008000;">//</span><span style="color: #008000;"> 获取类名（不含包名）</span><br><span style="color: #008080;">158</span><br><span style="color: #008080;">159</span>         result.append(“&lt;” + simpleName + “&gt;”<span style="color: #000000;">);<br></span><span style="color: #008080;">160</span><br><span style="color: #008080;">161</span><br><span style="color: #008080;">162</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> j = 0; j &lt; fieldsLength; j++<span style="color: #000000;">){<br></span><span style="color: #008080;">163</span>             fieldName = fields[j].getName(); <span style="color: #008000;">//</span><span style="color: #008000;"> 获取对应属性名</span><br><span style="color: #008080;">164</span><br><span style="color: #008080;">165</span>             <span style="color: #0000ff;">if</span>(list == <span style="color: #0000ff;">this</span>.list){ <span style="color: #008000;">//</span><span style="color: #008000;"> 只在最外层的类的属性中进行排除包含<br></span><span style="color: #008080;">166</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 使用includes，不使用excludes：只生成在includes中的信息</span><br><span style="color: #008080;">167</span>                 <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> != includes &amp;&amp; <span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> excludes){<br></span><span style="color: #008080;">168</span>                     <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">includes.contains(fieldName)){<br></span><span style="color: #008080;">169</span>                         <span style="color: #0000ff;">continue</span><span style="color: #000000;">;<br></span><span style="color: #008080;">170</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">171</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">172</span><br><span style="color: #008080;">173</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">不使用includes，使用excludes：只生成不在excludes中的信息</span><br><span style="color: #008080;">174</span>                 <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> == includes &amp;&amp; <span style="color: #0000ff;">null</span> != excludes){ <span style="color: #008000;">//</span><span style="color: #008000;"> 只使用了不包含</span><br><span style="color: #008080;">175</span>                     <span style="color: #0000ff;">if</span><span style="color: #000000;">(excludes.contains(fieldName)){<br></span><span style="color: #008080;">176</span>                         <span style="color: #0000ff;">continue</span><span style="color: #000000;">;<br></span><span style="color: #008080;">177</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">178</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">179</span><br><span style="color: #008080;">180</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">既使用includes，又使用exclude(不建议)：<br></span><span style="color: #008080;">181</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">- 如果includes中和excludes中的信息不冲突，则生成不在excludes中的信息<br></span><span style="color: #008080;">182</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">- 如果includes中和excludes中的信息冲突(某个属性都出现在这两个数组中)，则冲突部分的信息还是会生成</span><br><span style="color: #008080;">183</span>                 <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> != includes &amp;&amp; <span style="color: #0000ff;">null</span> != excludes){ <span style="color: #008000;">//</span><span style="color: #008000;"> 既使用了包含，又使用了不包含</span><br><span style="color: #008080;">184</span>                     <span style="color: #0000ff;">if</span>(!includes.contains(fieldName) &amp;&amp;<span style="color: #000000;"> excludes.contains(fieldName)){<br></span><span style="color: #008080;">185</span>                         <span style="color: #0000ff;">continue</span><span style="color: #000000;">;<br></span><span style="color: #008080;">186</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">187</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">188</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">189</span><br><span style="color: #008080;">190</span>             methodName =<span style="color: #000000;"> getGetterMethodNameByFieldName(fields[j]);<br></span><span style="color: #008080;">191</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">192</span>                 method = clazz.getDeclaredMethod(methodName, <span style="color: #0000ff;">new</span><span style="color: #000000;"> Class[]{});<br></span><span style="color: #008080;">193</span>                 method.setAccessible(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">194</span>                 value = method.invoke(curObj, <span style="color: #0000ff;">new</span><span style="color: #000000;"> Object[]{});<br></span><span style="color: #008080;">195</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></span><br><span style="color: #008080;">196</span>                 <span style="color: #0000ff;">if</span>(fields[j].getType() == List.<span style="color: #0000ff;">class</span>){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果属性是List类型</span><br><span style="color: #008080;">197</span>                     List&lt;?&gt; subList = (List&lt;?&gt;<span style="color: #000000;">)value;<br></span><span style="color: #008080;">198</span>                     xmlSubBuild(subList); <span style="color: #008000;">//</span><span style="color: #008000;"> 子数据递归</span><br><span style="color: #008080;">199</span>                 }<span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(fields[j].getType() == Set.<span style="color: #0000ff;">class</span>){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果属性是Set类型的</span><br><span style="color: #008080;">200</span>                     Set&lt;?&gt; subSet = (Set&lt;?&gt;<span style="color: #000000;">)value;<br></span><span style="color: #008080;">201</span>                     Iterator&lt;?&gt; iter =<span style="color: #000000;"> subSet.iterator();<br></span><span style="color: #008080;">202</span>                     List&lt;Object&gt; subList = <span style="color: #0000ff;">new</span> ArrayList&lt;Object&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">203</span>                     <span style="color: #0000ff;">while</span><span style="color: #000000;">(iter.hasNext()){<br></span><span style="color: #008080;">204</span> <span style="color: #000000;">                        subList.add(iter.next());<br></span><span style="color: #008080;">205</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">206</span>                     xmlSubBuild(subList); <span style="color: #008000;">//</span><span style="color: #008000;"> 子数据递归</span><br><span style="color: #008080;">207</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">208</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 如果ClassLoader不是null表示该类不是启动类加载器加载的，不是Java API的类，是自己写的java类</span><br><span style="color: #008080;">209</span>                 <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> fields[j].getType().getClassLoader()){<br></span><span style="color: #008080;">210</span>                     xmlSubSubBuild(value, <span style="color: #0000ff;">null</span>); <span style="color: #008000;">//</span><span style="color: #008000;"> 子子数据递归</span><br><span style="color: #008080;">211</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">212</span>                 <span style="color: #0000ff;">else</span>{ <span style="color: #008000;">//</span><span style="color: #008000;"> 其它类型都认为是普通文本类型</span><br><span style="color: #008080;">213</span>                     value =<span style="color: #000000;"> value.toString();<br></span><span style="color: #008080;">214</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 添加子元素（类属性）标签</span><br><span style="color: #008080;">215</span>                     result.append(“&lt;” + fieldName + “&gt;”<span style="color: #000000;">)<br></span><span style="color: #008080;">216</span> <span style="color: #000000;">                            .append(value)<br></span><span style="color: #008080;">217</span>                             .append(“&lt;/“ + fieldName + “&gt;”<span style="color: #000000;">);<br></span><span style="color: #008080;">218</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">219</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></span><br><span style="color: #008080;">220</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">221</span> <span style="color: #000000;">                e.printStackTrace();<br></span><span style="color: #008080;">222</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">223</span><br><span style="color: #008080;">224</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">225</span>         result.append(“&lt;/“ + simpleName + “&gt;”<span style="color: #000000;">);<br></span><span style="color: #008080;">226</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">227</span><br><span style="color: #008080;">228</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">229</span> <span style="color: #008000;">     <em> &lt;ol&gt;通过属性Field对象来获取getter方法的方法名。&lt;br&gt;<br></em></span><span style="color: #008080;">230</span> <span style="color: #008000;">      如果是boolean或Boolean类型(正则表达式来判断):isBorrow–&gt;isBorrow();isborrow–&gt;isIsborrow();&lt;br&gt;<br></span><span style="color: #008080;">231</span> <span style="color: #008000;">     <em> 否则:borrow–&gt;getBorrow();<br></em></span><span style="color: #008080;">232</span> <span style="color: #008000;">      &lt;/ol&gt;<br></span><span style="color: #008080;">233</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">234</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> field 要生成getter方法的对应属性对象。<br></span><span style="color: #008080;">235</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><span style="color: #008000;"> 返回getter方法的方法名。<br></span><span style="color: #008080;">236</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">237</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String getGetterMethodNameByFieldName(Field field){<br></span><span style="color: #008080;">238</span>         String methodName = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">239</span>         String fieldName =<span style="color: #000000;"> field.getName();<br></span><span style="color: #008080;">240</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 解析属性对应的getter方法名<br></span><span style="color: #008080;">241</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 判断是否是boolean或Boolean类型:isBorrow–&gt;isBorrow();isborrow–&gt;isIsborrow()</span><br><span style="color: #008080;">242</span>         <span style="color: #0000ff;">if</span>(field.getType() == <span style="color: #0000ff;">boolean</span>.<span style="color: #0000ff;">class</span> || field.getType() == Boolean.<span style="color: #0000ff;">class</span><span style="color: #000000;">){<br></span><span style="color: #008080;">243</span>             <span style="color: #0000ff;">if</span>(fieldName.matches(“^is[A-Z].*”<span style="color: #000000;">)){<br></span><span style="color: #008080;">244</span>                 methodName =<span style="color: #000000;"> fieldName;<br></span><span style="color: #008080;">245</span>             }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;">246</span>                 methodName = “is” + fieldName.substring(0, 1).toUpperCase() + fieldName.substring(1<span style="color: #000000;">);<br></span><span style="color: #008080;">247</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">248</span>         }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;">249</span>             methodName = “get” + fieldName.substring(0, 1).toUpperCase() + fieldName.substring(1<span style="color: #000000;">);<br></span><span style="color: #008080;">250</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">251</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> methodName;<br></span><span style="color: #008080;">252</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">253</span><br><span style="color: #008080;">254</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">255</span> <span style="color: #008000;">     <em> 检验传入的List的合法性（List是不是为null、长度是不是为0、是不是每项都是同一个类型）。<br></em></span><span style="color: #008080;">256</span> <span style="color: #008000;">      </span><span style="color: #808080;">@author</span><span style="color: #008000;"> wangjie<br></span><span style="color: #008080;">257</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@throws</span><span style="color: #008000;"> Exception 如果List为null, 或者长度为, 或者每项不是同一个类型, 抛出异常<br></span><span style="color: #008080;">258</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">259</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> checkValidityList() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception{<br></span><span style="color: #008080;">260</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> list){<br></span><span style="color: #008080;">261</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(“请保证传入的List不为null”<span style="color: #000000;">);<br></span><span style="color: #008080;">262</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">263</span>         <span style="color: #0000ff;">int</span> size =<span style="color: #000000;"> list.size();<br></span><span style="color: #008080;">264</span>         <span style="color: #0000ff;">if</span>(list.size() == 0<span style="color: #000000;">){<br></span><span style="color: #008080;">265</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(“请保证传入的List长度不为0”<span style="color: #000000;">);<br></span><span style="color: #008080;">266</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">267</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 1; i &lt; size; i++<span style="color: #000000;">){<br></span><span style="color: #008080;">268</span>             <span style="color: #0000ff;">if</span>(list.get(0).getClass() !=<span style="color: #000000;"> list.get(i).getClass()){<br></span><span style="color: #008080;">269</span>                 <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(“请保证传入的List每项都是同一个类型”<span style="color: #000000;">);<br></span><span style="color: #008080;">270</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">271</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">272</span><br><span style="color: #008080;">273</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">274</span><br><span style="color: #008080;">275</span><br><span style="color: #008080;">276</span> }</pre><br></div><br></div>

<p>&nbsp;</p>
<p><strong>使用方法如下：</strong><br><span>例如:</span><br><strong>Student类</strong><span>(该类有属性name，age，isBoy，books等属性；其中books属性是一个List，存放Book对象)：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">private</span><span style="color: #000000;"> String name;<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> age;<br></span><span style="color: #008080;">3</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isBoy;<br></span><span style="color: #008080;">4</span> <span style="color: #0000ff;">private</span> List&lt;Book&gt;<span style="color: #000000;"> books;<br></span><span style="color: #008080;">5</span> <span style="color: #008000;">//</span><span style="color: #008000;">并实现getter和setter方法；</span></pre><br></div>

<p>&nbsp;</p>
<p><strong>Book类</strong><span>(该类有属性name，author，number，length，width，isBorrowed等属性)：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">private</span><span style="color: #000000;"> String name;<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">private</span><span style="color: #000000;"> String author;<br></span><span style="color: #008080;">3</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> number;<br></span><span style="color: #008080;">4</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">float</span><span style="color: #000000;"> length;<br></span><span style="color: #008080;">5</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">float</span><span style="color: #000000;"> width;<br></span><span style="color: #008080;">6</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isBorrowed;<br></span><span style="color: #008080;">7</span> <span style="color: #008000;">//</span><span style="color: #008000;">并实现getter和setter方法；</span></pre><br></div>

<p>&nbsp;</p>
<p><span>现在有一个List&lt;Student&gt;类型的数据，通过以下代码把该List转换为xml：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> List&lt;Student&gt; list = <span style="color: #0000ff;">new</span> ArrayList&lt;Student&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #008000;">//</span><span style="color: #008000;">构建几个Student对象，放入list中<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">//</span><span style="color: #008000;">&hellip;&hellip;<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span> <span style="color: #008000;">//</span><span style="color: #008000;">完整数据版（不使用includes和excludes）</span><br><span style="color: #008080;"> 7</span> JOXMLBuilder jOXMLBuilder = <span style="color: #0000ff;">new</span><span style="color: #000000;"> JOXMLBuilder(list);<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">jOXMLBuilder.xmlBuild().toString();<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #008000;">//</span><span style="color: #008000;">或者使用包括/排除：</span><br><span style="color: #008080;">11</span> JOXMLBuilder jOXMLBuilder = <span style="color: #0000ff;">new</span> JOXMLBuilder(list, <span style="color: #0000ff;">new</span> String[]{“name”, “age”}, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">jOXMLBuilder.xmlBuild().toString();<br></span><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span> <span style="color: #008000;">//</span><span style="color: #008000;">或者使用方法链风格：</span><br><span style="color: #008080;">15</span> <span style="color: #0000ff;">new</span> JOXMLBuilder().setExcludes(“name”, “age”).xmlBuild().toString();</pre><br></div>

<p>&nbsp;</p>
<p><span style="line-height: 1.5;">转换之后的xml（完整数据版（不使用includes和excludes））：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">StudentAll</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Student</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 4</span>                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span>hello<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 5</span>                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">age</span><span style="color: #0000ff;">&gt;</span>23<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">age</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 6</span>                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">isBoy</span><span style="color: #0000ff;">&gt;</span>true<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">isBoy</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 7</span>                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">BookAll</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 8</span>                         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Book</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 9</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span>book1<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">10</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">author</span><span style="color: #0000ff;">&gt;</span>author1<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">author</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">11</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">number</span><span style="color: #0000ff;">&gt;</span>123<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">number</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">12</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">length</span><span style="color: #0000ff;">&gt;</span>23.5<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">length</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">13</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">width</span><span style="color: #0000ff;">&gt;</span>18.0<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">width</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">14</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">isBorrowed</span><span style="color: #0000ff;">&gt;</span>true<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">isBorrowed</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">15</span>                         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Book</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">16</span>                         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Book</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">17</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span>book2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">18</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">author</span><span style="color: #0000ff;">&gt;</span>author2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">author</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">19</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">number</span><span style="color: #0000ff;">&gt;</span>43<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">number</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">20</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">length</span><span style="color: #0000ff;">&gt;</span>42.23<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">length</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">21</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">width</span><span style="color: #0000ff;">&gt;</span>30.57<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">width</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">22</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">isBorrowed</span><span style="color: #0000ff;">&gt;</span>false<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">isBorrowed</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">23</span>                         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Book</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">24</span>                 <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">BookAll</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">25</span>         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Student</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Student</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">28</span>                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;world</span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">29</span>                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">age</span><span style="color: #0000ff;">&gt;</span>22<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">age</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">30</span>                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">isBoy</span><span style="color: #0000ff;">&gt;</span>false<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">isBoy</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">31</span>                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">BookAll</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">32</span>                          <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Book</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">33</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span>book1<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">34</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">author</span><span style="color: #0000ff;">&gt;</span>author1<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">author</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">35</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">number</span><span style="color: #0000ff;">&gt;</span>123<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">number</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">36</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">length</span><span style="color: #0000ff;">&gt;</span>23.5<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">length</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">37</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">width</span><span style="color: #0000ff;">&gt;</span>18.0<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">width</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">38</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">isBorrowed</span><span style="color: #0000ff;">&gt;</span>true<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">isBorrowed</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">39</span>                         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Book</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">40</span>                         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Book</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">41</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span>book3<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">42</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">author</span><span style="color: #0000ff;">&gt;</span>author3<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">author</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">43</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">number</span><span style="color: #0000ff;">&gt;</span>875<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">number</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">44</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">length</span><span style="color: #0000ff;">&gt;</span>20.59<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">length</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">45</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">width</span><span style="color: #0000ff;">&gt;</span>15.08<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">width</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">46</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">isBorrowed</span><span style="color: #0000ff;">&gt;</span>false<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">isBorrowed</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">47</span>                         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Book</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">48</span>                         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Book</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">49</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span>book4<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">name</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">50</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">author</span><span style="color: #0000ff;">&gt;</span>author4<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">author</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">51</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">number</span><span style="color: #0000ff;">&gt;</span>165<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">number</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">52</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">length</span><span style="color: #0000ff;">&gt;</span>22.75<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">length</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">53</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">width</span><span style="color: #0000ff;">&gt;</span>19.61<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">width</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">54</span>                                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">isBorrowed</span><span style="color: #0000ff;">&gt;</span>true<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">isBorrowed</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">55</span>                         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Book</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">56</span>                 <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">BookAll</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">57</span>         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Student</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">58</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">StudentAll</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[[java]二、八、十、十六进制之间的转换]]></title>
      <url>/2013/01/29/java-%E4%BA%8C%E3%80%81%E5%85%AB%E3%80%81%E5%8D%81%E3%80%81%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E4%B9%8B%E9%97%B4%E7%9A%84%E8%BD%AC%E6%8D%A2/</url>
      <content type="html"><![CDATA[<p>int n1 = 14;<br>    //十进制转成十六进制：<br>    Integer.toHexString(n1);<br>    //十进制转成八进制<br>    Integer.toOctalString(n1);<br>    //十进制转成二进制<br>    Integer.toBinaryString(12);</p>
<pre><code>//十六进制转成十进制
Integer.valueOf(&quot;FFFF&quot;,16).toString();
//十六进制转成二进制
Integer.toBinaryString(Integer.valueOf(&quot;FFFF&quot;,16));
//十六进制转成八进制
Integer.toOctalString(Integer.valueOf(&quot;FFFF&quot;,16));

//八进制转成十进制
Integer.valueOf(&quot;576&quot;,8).toString();
//八进制转成二进制
Integer.toBinaryString(Integer.valueOf(&quot;23&quot;,8));
//八进制转成十六进制
Integer.toHexString(Integer.valueOf(&quot;23&quot;,8));

//二进制转十进制
Integer.valueOf(&quot;0101&quot;,2).toString();
//二进制转八进制
Integer.toOctalString(Integer.parseInt(&quot;0101&quot;, 2));
//二进制转十六进制
Integer.toHexString(Integer.parseInt(&quot;0101&quot;, 2));
</code></pre>]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java垃圾回收器工作原理]]></title>
      <url>/2013/01/07/Java%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<p>垃圾回收器是如何工作的？我现在就简单的介绍一下</p>
<p>首先要明确几点：</p>
<p>Java是在堆上为对象分配空间的</p>
<p>垃圾回收器只跟内存有关，什么IO啊，网络连接啊，管它P事</p>
<p>当可用内存数量较低时，Sun版本的垃圾回收器才会被激活</p>
<p>在垃圾回收器回收垃圾之前，我们先来了解一下Java分配对象的方式，Java的堆更像一个传送带，每分配一个新对象，它就往前移动一格。这意味着对象存储空间的分配速度相当快。Java的&ldquo;堆指针&rdquo;只是简单地移动到尚未分配的领域。也就是说，分配空间的时候，&ldquo;堆指针&rdquo;只管依次往前移动而不管后面的对象是否还要被释放掉。如果可用内存耗尽之前程序就退出就再好不过了，这样的话垃圾回收器压根就不会被激活。</p>
<p>但是由于&ldquo;堆指针&rdquo;只管依次往前移动，那么你肯定会想，总有一天内存会被耗尽，垃圾回收器就开始释放内存。这里有人肯定会问：怎么判断某个对象该被回收呢？答案就是当堆栈或静态存储区没有对这个对象的引用时，就表示程序（员）对这个对象没有兴趣了，它就应该被回收了。有两种方法来知道这个对象有没有被引用：第一种是遍历堆上的对象找引用；第二种是遍历堆栈或静态存储区的引用找对象。前者的实现叫做&ldquo;引用计数法&rdquo;，意思就是当有引用连接至对象时，引用计数加1，当引用离开作用域或被置为null时，引用计数减1，这种方法有个缺陷，如果对象之间存在循环引用，可能会出现&ldquo;对象应该被回收，但引用计数却不为零&rdquo;的情况。</p>
<p>Java采用的是后者，在这种方式下，Java虚拟机采用一种&ldquo;自适应&rdquo;的垃圾回收技术，如何处理找到的存活对象（也就是说不是垃圾），Java有两种方式：</p>
<p>一种是&ldquo;停止-复制&rdquo;：理论上是先暂停程序的运行（所以它不属于后台回收模式），然后将所有存活的对象从当前堆复制到另一个堆，没有被复制的全是垃圾。当对象被复制到新堆上时，它们是一个挨着一个的，所以新堆保持紧凑排列（这也是为什么分配对象的时候&ldquo;堆指针&rdquo;只管依次往前移动）。然后就可以按前述方法简单、直接地分配内存了。这将导致大量内存复制行为，内存分配是以较大的&ldquo;块&rdquo;为单位的。有了块之后，垃圾回收器就可以不往堆里拷贝对象了，直接就可以往废弃的块里拷贝对象了。</p>
<p>另一种是&ldquo;标记-清扫&rdquo;：它的思路同样是从堆栈和静态存储区出发，遍历所有的引用，进而找出所有存活的对象。每当它找到一个存活对象，就会给对象一个标记。这个过程中不会回收任何对象。只有全部标记完成时，没有标记的对象将被释放，不会发生任何复制工作，所以剩下的堆空间是不连续的，然后垃圾回收器重新整理剩余的对象，使它们是连续排列的。</p>
<p>当垃圾回收器第一次启动时，它执行的是&ldquo;停止-复制&rdquo;，因为这个时刻内存有太多的垃圾。然后Java虚拟机会进行监视，如果所有对象都很稳定，垃圾回收器的效率降低的话，就切换到&ldquo;标记-清扫&rdquo;方式；同样，Java虚拟机会跟踪&ldquo;标记-清扫&rdquo;效果，要是堆空间出现很多碎片，就会切换到&ldquo;停止-复制&rdquo;方式。这就是所谓的&ldquo;自适应&rdquo;技术。</p>
<p>其实仔细想一下，&ldquo;停止-复制&rdquo;和&ldquo;标记-清扫&rdquo;无非就是：&ldquo;在大量的垃圾中找干净的东西和在大量干净的东西里找垃圾&rdquo;。不同的环境用不同的方式，这样做完全是为了提高效率，要知道，无论哪种方式，Java都会先暂停程序的运行，所以，垃圾回收器的效率其实是很低的。Java用效率换回了C++没有的垃圾回收器和运行时的灵活，我认为这是明智的选择（虽然它只跟内存有关），随着硬件的飞速发展，我相信，开发时间要比运行效率重要得多！</p>
<p>引用：<a href="http://fhz1980.blog.163.com/blog/" target="_blank" rel="noopener">http://fhz1980.blog.163.com/blog/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> gc </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[一刻钟精通正则表达式]]></title>
      <url>/2012/12/27/%E4%B8%80%E5%88%BB%E9%92%9F%E7%B2%BE%E9%80%9A%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
      <content type="html"><![CDATA[<p><span>作者:&nbsp;maXiaoKe,&nbsp;　出处:javaresearch</span></p>
<p><span>&nbsp;&nbsp;&nbsp;&nbsp;想必很多人都对正则表达式都头疼。今天，我以我的认识，加上网上一些文章，希望用常人都可以理解的表达方式来和大家分享学习经验。&nbsp;</span><br><span>　　开篇,还是得说说&nbsp;^&nbsp;和&nbsp;$&nbsp;他们是分别用来匹配字符串的开始和结束，以下分别举例说明：</span></p>
<p><span>　　“^The”:&nbsp;开头一定要有”The”字符串;</span></p>
<p><span>　　“of&nbsp;despair$”:&nbsp;结尾一定要有”of&nbsp;despair”&nbsp;的字符串;</span></p>
<p><span>　　那么,</span></p>
<p><span>　　“^abc$”:&nbsp;就是要求以abc开头和以abc结尾的字符串，实际上是只有abc匹配。</span></p>
<p><span>　　“notice”:&nbsp;匹配包含notice的字符串。</span></p>
<p><span>　　你可以看见如果你没有用我们提到的两个字符(最后一个例子)，就是说&nbsp;模式(正则表达式)&nbsp;可以出现在被检验字符串的任何地方，你没有把他锁定到两边。</span></p>
<p><span>　　接着,说说&nbsp;’*’,&nbsp;’+’,和&nbsp;’?’,</span></p>
<p><span>　　他们用来表示一个字符可以出现的次数或者顺序.&nbsp;他们分别表示：</span></p>
<p><span>　　“zero&nbsp;or&nbsp;more”相当于{0,},&nbsp;</span><br><span>　　“one&nbsp;or&nbsp;more”相当于{1,},&nbsp;</span><br><span>　　“zero&nbsp;or&nbsp;one.”相当于{0,1},&nbsp;这里是一些例子:&nbsp;</span><br><span>　　“ab<em>“:&nbsp;和ab{0,}同义,匹配以a开头,后面可以接0个或者N个b组成的字符串(“a”,&nbsp;”ab”,&nbsp;”abbb”,&nbsp;等);&nbsp;</em></span><br><span>　　“ab+”:&nbsp;和ab{1,}同义,同上条一样，但最少要有一个b存在&nbsp;(“ab”,&nbsp;”abbb”,&nbsp;等.);&nbsp;</span><br><span>　　“ab?”:和ab{0,1}同义,可以没有或者只有一个b;&nbsp;</span><br><span>　　“a?b+$”:&nbsp;匹配以一个或者0个a再加上一个以上的b结尾的字符串.</span><br><span>　　要点,&nbsp;’‘,&nbsp;’+’,和&nbsp;’?’只管它前面那个字符.</span></p>
<p><span>　　你也可以在大括号里面限制字符出现的个数，比如</span></p>
<p><span>　　“ab{2}”:&nbsp;要求a后面一定要跟两个b(一个也不能少)(“abb”);&nbsp;</span><br><span>　　“ab{2,}”:&nbsp;要求a后面一定要有两个或者两个以上b(如”abb”,&nbsp;”abbbb”,&nbsp;等.);&nbsp;</span><br><span>　　“ab{3,5}”:&nbsp;要求a后面可以有2-5个b(“abbb”,&nbsp;”abbbb”,&nbsp;or&nbsp;”abbbbb”).</span><br><span>　　现在我们把一定几个字符放到小括号里，比如：</span></p>
<p><span>　　“a(bc)*”:&nbsp;匹配&nbsp;a&nbsp;后面跟0个或者一个”bc”;&nbsp;</span><br><span>　　“a(bc){1,5}”:&nbsp;一个到5个&nbsp;”bc.”</span><br><span>　　还有一个字符&nbsp;’│’,&nbsp;相当于OR&nbsp;操作:</span></p>
<p><span>　　“hi│hello”:&nbsp;匹配含有”hi”&nbsp;或者&nbsp;”hello”&nbsp;的&nbsp;字符串;</span></p>
<p><span>　　“(b│cd)ef”:&nbsp;匹配含有&nbsp;”bef”&nbsp;或者&nbsp;”cdef”的字符串;</span></p>
<p><span>　　“(a│b)*c”:&nbsp;匹配含有这样多个(包括0个)a或b，后面跟一个c的字符串;</span></p>
<p><span>　　一个点(‘.’)可以代表所有的单一字符,不包括”\n”</span></p>
<p><span>　　如果,要匹配包括”\n”在内的所有单个字符,怎么办?</span></p>
<p><span>　　对了,用’[\n.]’这种模式.</span></p>
<p><span>　　“a.[0-9]”:&nbsp;一个a加一个字符再加一个0到9的数字</span></p>
<p><span>　　“^.{3}$”:&nbsp;三个任意字符结尾&nbsp;.</span></p>
<p><span>　　中括号括住的内容只匹配一个单一的字符</span></p>
<p><span>　　“[ab]”:&nbsp;匹配单个的&nbsp;a&nbsp;或者&nbsp;b&nbsp;(&nbsp;和&nbsp;”a│b”&nbsp;一样);</span></p>
<p><span>　　“[a-d]”:&nbsp;匹配’a’&nbsp;到’d’的单个字符&nbsp;(和”a│b│c│d”&nbsp;还有&nbsp;”[abcd]”效果一样);&nbsp;一般我们都用[a-zA-Z]来指定字符为一个大小写英文</span></p>
<p><span>　　“^[a-zA-Z]”:&nbsp;匹配以大小写字母开头的字符串</span></p>
<p><span>　　“[0-9]%”:&nbsp;匹配含有&nbsp;形如&nbsp;x%&nbsp;的字符串</span></p>
<p><span>　　“,[a-zA-Z0-9]$”:&nbsp;匹配以逗号再加一个数字或字母结尾的字符串</span></p>
<p><span>　　你也可以把你不想要得字符列在中括号里，你只需要在总括号里面使用’^’&nbsp;作为开头&nbsp;”%[^a-zA-Z]%”&nbsp;匹配含有两个百分号里面有一个非字母的字符串.</span></p>
<p><span>　　要点:^用在中括号开头的时候,就表示排除括号里的字符。为了PHP能够解释，你必须在这些字符面前后加’’,并且将一些字符转义.</span></p>
<p><span>　　不要忘记在中括号里面的字符是这条规路的例外?在中括号里面,&nbsp;所有的特殊字符，包括(‘’),&nbsp;都将失去他们的特殊性质&nbsp;”[*+?{}.]”匹配含有这些字符的字符串.</span></p>
<p><span>　　还有,正如regx的手册告诉我们:&nbsp;”如果列表里含有&nbsp;’]’,&nbsp;最好把它作为列表里的第一个字符(可能跟在’^’后面).&nbsp;如果含有’-‘,&nbsp;最好把它放在最前面或者最后面,&nbsp;or&nbsp;或者一个范围的第二个结束点[a-d-0-9]中间的&lsquo;-&rsquo;将有效.</span></p>
<p><span>　　看了上面的例子,你对{n,m}应该理解了吧.要注意的是,n和m都不能为负整数,而且n总是小于m.&nbsp;这样,才能&nbsp;最少匹配n次且最多匹配m次.&nbsp;如”p{1,5}”将匹配&nbsp;”pvpppppp”中的前五个p.</span></p>
<p><span>　　下面说说以\开头的</span></p>
<p><span>　　\b&nbsp;书上说他是用来匹配一个单词边界,就是…比如’ve\b’,可以匹配love里的ve而不匹配very里有ve</span></p>
<p><span>　　\B&nbsp;正好和上面的\b相反.例子我就不举了</span></p>
<p><span>　　…..突然想起来….可以到<a href="http://www.phpv.net/article.php/251&nbsp;看看其它用\&nbsp;开头的语法" target="_blank" rel="noopener">http://www.phpv.net/article.php/251&nbsp;看看其它用\&nbsp;开头的语法</a></span></p>
<p><span>　　好,我们来做个应用:</span></p>
<p><span>　　如何构建一个模式来匹配&nbsp;货币数量&nbsp;的输入</span></p>
<p><span>　　构建一个匹配模式去检查输入的信息是否为一个表示money的数字。我们认为一个表示money的数量有四种方式：&nbsp;”10000.00”&nbsp;和&nbsp;”10,000.00”,或者没有小数部分,&nbsp;”10000”&nbsp;and&nbsp;”10,000”.&nbsp;现在让我们开始构建这个匹配模式:</span></p>
<p><span>^[1-9][0-9]*$&nbsp;</span></p>
<p><span>这是所变量必须以非0的数字开头.但这也意味着&nbsp;单一的&nbsp;”0”&nbsp;也不能通过测试.&nbsp;以下是解决的方法:&nbsp;</span><br><span>^(0│[1-9][0-9]*)$&nbsp;</span></p>
<p><span>　　“只有0和不以0开头的数字与之匹配”，我们也可以允许一个负号在数字之前:</span></p>
<p><span>^(0│-?[1-9][0-9]*)$&nbsp;</span></p>
<p><span>　　这就是:&nbsp;”0&nbsp;或者&nbsp;一个以0开头&nbsp;且可能&nbsp;有一个负号在前面的数字.”&nbsp;好了,现在让我们别那么严谨，允许以0开头.现在让我们放弃&nbsp;负号&nbsp;,&nbsp;因为我们在表示钱币的时候并不需要用到.&nbsp;我们现在指定&nbsp;模式&nbsp;用来匹配小数部分:</span></p>
<p><span>^[0-9]+(.[0-9]+)?$&nbsp;</span></p>
<p><span>　　这暗示匹配的字符串必须最少以一个阿拉伯数字开头.&nbsp;但是注意，在上面模式中&nbsp;”10.”&nbsp;是不匹配的,&nbsp;只有&nbsp;”10”&nbsp;和&nbsp;”10.2”&nbsp;才可以.&nbsp;(你知道为什么吗)</span></p>
<p><span>^[0-9]+(.[0-9]{2})?$&nbsp;</span></p>
<p><span>　　我们上面指定小数点后面必须有两位小数.如果你认为这样太苛刻,你可以改成:</span></p>
<p><span>^[0-9]+(.[0-9]{1,2})?$&nbsp;</span></p>
<p><span>　　这将允许小数点后面有一到两个字符.&nbsp;现在我们加上用来增加可读性的逗号(每隔三位),&nbsp;我们可以这样表示:</span></p>
<p><span>^[0-9]{1,3}(,[0-9]{3})*(.[0-9]{1,2})?$&nbsp;</span></p>
<p><span>　　不要忘记&nbsp;’+’&nbsp;可以被&nbsp;’*’&nbsp;替代&nbsp;如果你想允许空白字符串被输入话&nbsp;(为什么?).&nbsp;也不要忘记反斜杆&nbsp;&rsquo;\&rsquo;&nbsp;在php字符串中可能会出现错误&nbsp;(很普遍的错误).</span></p>
<p><span>　　现在，我们已经可以确认字符串了,&nbsp;我们现在把所有逗号都去掉&nbsp;str_replace(“,”,&nbsp;””,&nbsp;$money)&nbsp;然后在把类型看成&nbsp;double然后我们就可以通过他做数学计算了.</span></p>
<p><span>　　再来一个:</span></p>
<p><span>　　构造检查email的正则表达式</span></p>
<p><span>　　在一个完整的email地址中有三个部分:</span></p>
<p><span>　　1.&nbsp;用户名&nbsp;(在&nbsp;’@’&nbsp;左边的一切),</span></p>
<p><span>　　2.’@’,</span></p>
<p><span>　　3.&nbsp;服务器名(就是剩下那部分).</span></p>
<p><span>　　用户名可以含有大小写字母阿拉伯数字,句号&nbsp;(‘.’),&nbsp;减号(‘-‘),&nbsp;and&nbsp;下划线&nbsp;(‘_’).&nbsp;服务器名字也是符合这个规则,当然下划线除外.</span></p>
<p><span>　　现在,&nbsp;用户名的开始和结束都不能是句点.&nbsp;服务器也是这样.&nbsp;还有你不能有两个连续的句点他们之间至少存在一个字符，好现在我们来看一下怎么为用户名写一个匹配模式:</span></p>
<p><span>^[_a-zA-Z0-9-]+$&nbsp;</span></p>
<p><span>　　现在还不能允许句号的存在.&nbsp;我们把它加上:</span></p>
<p><span>^[_a-zA-Z0-9-]+(.[_a-zA-Z0-9-]+)*$&nbsp;</span></p>
<p><span>　　上面的意思就是说:&nbsp;”以至少一个规范字符(除了.)开头,后面跟着0个或者多个以点开始的字符串.”</span></p>
<p><span>　　简单化一点,&nbsp;我们可以用&nbsp;eregi()取代&nbsp;ereg().eregi()对大小写不敏感,&nbsp;我们就不需要指定两个范围&nbsp;”a-z”&nbsp;和&nbsp;”A-Z”&nbsp;?&nbsp;只需要指定一个就可以了:</span></p>
<p><span>^[_a-z0-9-]+(.[_a-z0-9-]+)*$&nbsp;</span></p>
<p><span>　　后面的服务器名字也是一样,但要去掉下划线:</span></p>
<p><span>^[a-z0-9-]+(.[a-z0-9-]+)*$&nbsp;</span></p>
<p><span>　　好.&nbsp;现在只需要用&rdquo;@&rdquo;把两部分连接:</span></p>
<p><span>^[_a-z0-9-]+(.[_a-z0-9-]+)<em>@[a-z0-9-]+(.[a-z0-9-]+)</em>$&nbsp;</span></p>
<p><span>　　这就是完整的email认证匹配模式了,只需要调用</span></p>
<p><span>eregi(&lsquo;^[_a-z0-9-]+(.[_a-z0-9-]+)<em>@[a-z0-9-]+(.[a-z0-9-]+)</em>$&nbsp;&rsquo;,$eamil)&nbsp;</span></p>
<p><span>　　就可以得到是否为email了.</span></p>
<p><span>　　正则表达式的其他用法</span></p>
<p><span>　　提取字符串</span></p>
<p><span>　　ereg()&nbsp;and&nbsp;eregi()&nbsp;有一个特性是允许用户通过正则表达式去提取字符串的一部分(具体用法你可以阅读手册).&nbsp;比如说,我们想从&nbsp;path/URL&nbsp;提取文件名&nbsp;?&nbsp;下面的代码就是你需要:</span></p>
<p><span>ereg(“([^\/]*)$”,&nbsp;$pathOrUrl,&nbsp;$regs);&nbsp;</span><br><span>echo&nbsp;$regs[1];&nbsp;</span></p>
<p><span>　　高级的代换</span></p>
<p><span>　　ereg_replace()&nbsp;和&nbsp;eregi_replace()也是非常有用的:&nbsp;假如我们想把所有的间隔负号都替换成逗号:</span></p>
<p><span>ereg_replace(“[&nbsp;\n\r\t]+”,&nbsp;”,”,&nbsp;trim($str));&nbsp;</span></p>
<p><span>　　最后,我把另一串检查EMAIL的正则表达式让看文章的你来分析一下.</span></p>
<p><span>“^[-!#$%&amp;\’<em>+\./0-9=?A-Z^_`a-z{|}~]+’.’@’.’[-!#$%&amp;\’</em>+\/0-9=?A-Z^<em>`a-z{|}~]+.‘.’[-!#$%&amp;\’*+\./0-9=?A-Z^</em>`a-z{|}~]+$”&nbsp;</span></p>
<p><span>　　如果能方便的读懂,那这篇文章的目的就达到了.</span></p>
]]></content>
      
        
        <tags>
            
            <tag> reg </tag>
            
            <tag> 正则表达式 </tag>
            
            <tag> regular expression </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[JVM原理]]></title>
      <url>/2012/12/26/JVM%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<p><strong>JVM 原理解释</strong></p>
<p><span data-mce-mark="1"><img src="data:image/png;base64,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" alt=""></span></p>
<p>　　JVM 全称是 Java Virtual Machine ，Java 虚拟机，这个 JVM 你是看不到的，它存在内存中。我们知道计算机的基本构成是：运算器、控制器、存储器、输入和输出设备，那这个 JVM 也是有这成套的元素，运算器是当然是交给硬件 CPU 还处理了，只是为了适应&ldquo;一次编译，随处运行&rdquo;的情况，需要做一个翻译动作，于是就用了JVM 自己的命令集，JVM 的命令集则是可以到处运行的，因为 JVM 做了翻译，根据不同的CPU ，翻译成不同的机器语言。</p>
<p>　　JVM 是一个内存中的虚拟机，那它的存储就是内存了，我们写的所有类、常量、变量、方法都在内存中。</p>
<p><strong>　　JVM 的组成部分</strong></p>
<p><span data-mce-mark="1"><span data-mce-mark="1"><img src="data:image/png;base64,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" alt=""></span><br></span></p>
<p><strong><span data-mce-mark="1">　　Class Loader 类加载器</span></strong></p>
<p>　　类加载器的作用是加载类文件(.class)到内存，Class Loader 加载的 class 文件是有格式要求的。</p>
<p><span data-mce-mark="1">　　类加载的最终产品是位于运行时数据区的堆区的Class对象。</span></p>
<p>　　Class对象封装了类在方法区内部的数据结构。&nbsp;</p>
<p><span data-mce-mark="1">　　并且向JAVA程序提供了访问类在方法区内的数据结构。</span></p>
<p><span data-mce-mark="1"><img src="data:image/png;base64,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" alt=""></span></p>
<p><strong>　　JVM加载class文件的原理机制</strong></p>
<p><span data-mce-mark="1">　　1. Java 中的所有类，必须被装载到 JMV 中才能运行，这个装载工作是由 JVM 中的类装载器完成的，类装载器所做的工作实质是把类文件从硬盘读取到内存中。</span></p>
<p><span data-mce-mark="1">　　2. Java中的类大致分为三种：</span></p>
<p><span data-mce-mark="1">　　a) 系统类</span></p>
<p><span data-mce-mark="1">　　b) 扩展类</span></p>
<p><span data-mce-mark="1">　　c) 由程序员自定义的类</span></p>
<p><span data-mce-mark="1">　　3. 类装载方式，有两种：</span></p>
<p><span data-mce-mark="1">　　a) 隐式装载，程序在运行过程中当碰到通过 new 等方式生成对象时，隐式调用类装载器加载对应的类到jvm中。</span></p>
<p><span data-mce-mark="1">　　b)&nbsp;显式装载，通过 class.forname() 等方法，显式加载需要的类。</span>　　</p>
<p><span data-mce-mark="1">　　4. 类加载的动态性体现</span></p>
<p><span data-mce-mark="1">　　一个应用程序总是由n多个类组成，Java 程序启动时，并不是一次把所有的类全部加载后再运行，它总是先把保证程序运行的基础类一次性加载到 JVM 中，其它类等到 JVM 用到的时候再加载，这样的好处是节省了内存的开销。因为java最早就是为嵌入式系统而设计的，内存宝贵，这是一种可以理解的机制，而用到时再加载这也是 Java 动态性的一种体现。</span></p>
<p><span data-mce-mark="1">　　5．Java 类装载器</span></p>
<p><span data-mce-mark="1">　　Java 中的类装载器实质上也是类，功能是把类载入 JVM 中，值得注意的是 JVM 的类装载器并不是一个，而是三个，层次结构如下：</span></p>
<p><span data-mce-mark="1">&nbsp; &nbsp; &nbsp; Bootstrap Loader&nbsp; - 负责加载系统类&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - - ExtClassLoader&nbsp; - 负责加载扩展类&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - - AppClassLoader&nbsp; - 负责加载应用类</span></p>
<p><span data-mce-mark="1">　　为什么要有三个类加载器，一方面是分工，各自负责各自的区块，另一方面为了实现委托模型。</span></p>
<p><span data-mce-mark="1">　　6. 类加载器之间是如何协调工作的</span></p>
<p><span data-mce-mark="1">　　前面说了，Java中有三个类加载器，问题就来了，碰到一个类需要加载时，它们之间是如何协调工作的，即 Java 是如何区分一个类该由哪个类加载器来完成呢。</span></p>
<p><span data-mce-mark="1">　　在这里Java采用了委托模型机制，这个机制简单来讲，就是&ldquo;类装载器有载入类的需求时，会先请示其Parent使用其搜索路径帮忙载入，如果 Parent 找不到，那么才由自己依照自己的搜索路径搜索类&rdquo;，注意喔，这句话具有递归性。</span></p>
<p><strong>　　=================================
</strong></p>
<p>　　资料参考:</p>
<p>　　多谢&nbsp;<a href="http://samuschen.iteye.com/" target="_blank" rel="noopener">samuschen</a>&nbsp;的资料贡献，<a href="http://samuschen.iteye.com/blog/1119539" target="_blank" rel="noopener">http://samuschen.iteye.com/blog/1119539</a></p>
<p>　　转自：<a href="http://kb.cnblogs.com/page/167539/" target="_blank" rel="noopener">http://kb.cnblogs.com/page/167539/</a></p>
<p><strong>　　=================================</strong></p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> JVM </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[[Java]Stack栈和Heap堆的区别（终结篇）[转]]]></title>
      <url>/2012/12/26/Java-Stack%E6%A0%88%E5%92%8CHeap%E5%A0%86%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%88%E7%BB%88%E7%BB%93%E7%AF%87%EF%BC%89-%E8%BD%AC/</url>
      <content type="html"><![CDATA[<div>首先分清楚Stack，Heap的中文翻译：Stack&mdash;栈，Heap&mdash;堆。</div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在中文里，Stack可以翻译为&ldquo;堆栈&rdquo;，所以我直接查找了计算机术语里面堆和栈开头的词语：</div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>堆存储： heapstorage&nbsp;&nbsp;&nbsp; 堆存储分配： heapstorage allocation&nbsp; 堆存储管理： heap storage management</strong></div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>&nbsp;栈编址： stack addressing&nbsp; &nbsp;栈变换：stack transformation&nbsp; 栈存储器：stack memory&nbsp; 栈单元： stack cell</strong></div><br><div>&nbsp;</div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接着，总结在Java里面Heap和Stack分别存储数据的不同。</div><br><div>&nbsp;</div><br><div><br><table border="1" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><br><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Heap(堆)</td><br><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Stack(栈)</td><br></tr><br><tr><br><td>&nbsp;JVM中的功能</td><br><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;内存数据区&nbsp;&nbsp;&nbsp;&nbsp;</td><br><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 内存指令区</td><br></tr><br><tr><br><td>&nbsp;存储数据</td><br><td>&nbsp;&nbsp;&nbsp;&nbsp; 对象实例(1)</td><br><td>&nbsp;基本数据类型, 指令代码,常量,对象的引用地址(2)</td><br></tr><br></tbody><br></table><br></div><br><div>1. 保存对象实例，实际上是保存对象实例的属性值，属性的类型和对象本身的类型标记等，并不保存对象的方法（方法是指令，保存在stack中）。<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp; 对象实例在heap中分配好以后，需要在stack中保存一个4字节的heap内存地址，用来定位该对象实例在heap中的位置，便于找到该对象实例。</div><br><div>&nbsp;</div><br><div>2. 基本数据类型包括byte、int、char、long、float、double、boolean和short。<br>&nbsp;&nbsp;&nbsp; 函数方法属于指令.</div><br><div>&nbsp;</div><br><div>&nbsp;=======================&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><br><div>&nbsp; 引用网上广泛流传的&ldquo;Java堆和栈的区别&rdquo;里面对堆和栈的介绍；</div><br><div><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; “Java 的堆是一个运行时数据区,类的(对象从中分配空间。这些对象通过new、newarray、anewarray和multianewarray等指令建立，它们不需要程序代码来显式的释放。堆是由垃圾回收来负责的，堆的优势是可以动态地分配内存大小，生存期也不必事先告诉编译器，因为它是在运行时动态分配内存的，Java的垃圾收集器会自动收走这些不再使用的数据。但缺点是，由于要在运行时动态分配内存，存取速度较慢。”</strong></div><br><div><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &ldquo;栈的优势是，存取速度比堆要快，仅次于寄存器，栈数据可以共享。但缺点是，存在栈中的数据大小与生存期必须是确定的，缺乏灵活性。栈中主要存放一些基本类型的变量（,int, short, long, byte, float, double, boolean, char）和对象句柄。</strong>&nbsp;<strong>&rdquo;</strong></div><br><div><strong>&nbsp;&nbsp;&nbsp;</strong></div><br><div><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;</strong>可见，垃圾回收GC是针对堆Heap的，而栈因为本身是FILO - first in, last out. 先进后出，能够自动释放。 这样就能明白到new创建的，都是放到堆Heap！</div>

<p>本文出自 &ldquo;<a href="http://android.blog.51cto.com/" target="_blank" rel="noopener">学习Android</a>&rdquo; 博客，请务必保留此出处<a href="http://android.blog.51cto.com/268543/50100" target="_blank" rel="noopener">http://android.blog.51cto.com/268543/50100</a></p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> stack </tag>
            
            <tag> heap </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[WEB项目的分层结构]]></title>
      <url>/2012/11/30/WEB%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%88%86%E5%B1%82%E7%BB%93%E6%9E%84/</url>
      <content type="html"><![CDATA[<p><strong>WEB**</strong>项目的分层结构**</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;大部分的WEB应用在职责上至少被分成四层：表示层、持久层、业务层和域模块层。</p>
<p><strong>一、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**</strong>表示层**</p>
<p>一般来讲，一个典型的WEB应用的前端应该是表示层，可以使用Struts框架。</p>
<p>下面是Struts所负责的：</p>
<p>1、&nbsp;&nbsp;管理用户的请求，做出相应的响应。</p>
<p>2、&nbsp;&nbsp;提供一个流程控制，委派调用业务逻辑和其他上层处理。</p>
<p>3、&nbsp;&nbsp;处理异常。</p>
<p>4、&nbsp;&nbsp;为显示提供一个数据模型（即把数据对象设置到某一个范围内，用于前台获取数据）。</p>
<p>5、&nbsp;&nbsp;用户界面的验证。</p>
<p>以下内容，不该在Struts表示层的编码中经常出现，它们与表示层无关的。</p>
<p>1、&nbsp;&nbsp;与数据库直接通信。</p>
<p>2、&nbsp;&nbsp;与应用程序相关联的业务逻辑有校验</p>
<p>3、&nbsp;&nbsp;事务处理。</p>
<p><strong>二、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**</strong>持久层**</p>
<p>典型的WEB应用的后端是持久层。可以用Hibernate实现。Hibernate的持久对象是基于POJO（Plain Old Java Object）和Java集合的。</p>
<p>下面是Hibernate所负责的内容：</p>
<p>1、&nbsp;&nbsp;如何查询对象的相关信息。</p>
<p>Hibernate是通过一个面向对象查询语言（HQL）或正则表达的API来完成查询的。HQL非常类似于SQL，只是把SQL里的table和columns用Object和它的fields代替。</p>
<p>2、&nbsp;&nbsp;如何存储、更新、删除数据库记录。</p>
<p>3、&nbsp;&nbsp;Hibernate这类高级ORM框架支持大部分主流数据库，并且支持父表/子表关系、事务处理、继承和多态。</p>
<p><strong>三、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**</strong>业务层**</p>
<p>一个典型WEB应用的中间部分是业务层或服务层。可以用Spring来实现。</p>
<p>下面是业务层所负责的：</p>
<p>1、&nbsp;&nbsp;处理应用程序的业务逻辑和业务校验。</p>
<p>2、&nbsp;&nbsp;管理事务。</p>
<p>3、&nbsp;&nbsp;提供与其他层相互作用的接口。</p>
<p>4、&nbsp;&nbsp;管理业务层级别的对象的依赖。</p>
<p>5、&nbsp;&nbsp;在表示层和持久层之间增加一个灵活的机制，使得他们不直接联系在一起。</p>
<p>6、&nbsp;&nbsp;通过揭示从表示层到业务层之间的上下文来得到业务逻辑。</p>
<p>7、&nbsp;&nbsp;管理程序的执行（从业务层到持久层）。</p>
<p><strong>四、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**</strong>域模块层**</p>
<p>既然我们致力于一个WEB的应用，我们就需要一个对象集合，让它在不同层之间移动。域模块层由实际需求中业务对象组成，比如订单明细、产品、等。开发者在这层不用管哪些数据传输对象，而关注域对象即可。例如，Hibernate允许你将数据库中的信息存入域对象，这样你可以在连接断开的情况下把这些数据显示到用户界面层，而那些对象也可以返回给持久层，从而在数据库里更新。而且，你不必把对象转化成DTO（这可能导致它在不同层之间传输过程中丢失）。这个模型使得Java开发者能很自然运用面向编程，而不需要附加编码。</p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> j2ee </tag>
            
            <tag> java web </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[java 适配器模式]]></title>
      <url>/2012/11/21/java-%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<p>适配器:基于现有类所提供的服务，向客户提供接口，以满足客户的期望</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;《Java设计模式》</p>
<p>一、类适配器：</p>
<p>OtherOperation（已存在所需功能的类）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-21 下午4:39:18<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> OtherOperation {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> add(<span style="color: #0000ff;">int</span> a, <span style="color: #0000ff;">int</span><span style="color: #000000;"> b){<br>        </span><span style="color: #0000ff;">return</span> a +<span style="color: #000000;"> b;<br>    }<br>}</span></pre><br></div>

<p>Operation（为所要实现的功能定义接口）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-21 下午4:40:12<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> Operation {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> add(<span style="color: #0000ff;">int</span> a, <span style="color: #0000ff;">int</span><span style="color: #000000;"> b);<br>}</span></pre><br></div>

<p>OperationAdapter（适配器）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-21 下午4:40:41
  对象适配器<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> OperationAdapter <span style="color: #0000ff;">extends</span> OtherOperation <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Operation{<br><br>}</span></pre><br></div>

<hr>
<p>二、对象适配器：</p>
<p>假如客户接口期望的功能不止一个，而是多个。<br>由于java是不能实现多继承的，所以我们不能通过构建一个适配器，让他来继承所有原以完成我们的期望，这时候怎么办呢?只能用适配器的另一种实现–对象适配器：<br>符合java提倡的编程思想之一，即尽量使用聚合不要使用继承。</p>
<p>OtherAdd和OtherMinus（已存在功能的两个类）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<strong></strong></span><span style="color: #008000;"><br> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian
  </span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-21 下午4:50:14<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> OtherAdd {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> add(<span style="color: #0000ff;">int</span> a, <span style="color: #0000ff;">int</span><span style="color: #000000;"> b){<br>        </span><span style="color: #0000ff;">return</span> a +<span style="color: #000000;"> b;<br>    }<br>}</span></pre><br></div><br><div class="cnblogs_code"><br><pre><span style="color: #008000;">/</span><span style="color: #008000;"><br> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian
  </span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-21 下午4:50:46<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> OtherMinus {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> minus(<span style="color: #0000ff;">int</span> a, <span style="color: #0000ff;">int</span><span style="color: #000000;"> b){<br>        </span><span style="color: #0000ff;">return</span> a -<span style="color: #000000;"> b;<br>    }<br>}</span></pre><br></div>

<p>Operation（为所要实现的功能定义接口）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-21 下午4:51:59<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> Operation {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> add(<span style="color: #0000ff;">int</span> a, <span style="color: #0000ff;">int</span><span style="color: #000000;"> b);<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> minus(<span style="color: #0000ff;">int</span> a, <span style="color: #0000ff;">int</span><span style="color: #000000;"> b);<br>}</span></pre><br></div>

<p>OperationAdapter（<span>通过</span><span>适配类</span><span>的对象来</span><span>获取</span>）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-21 下午4:52:36<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> OperationAdapter <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Operation{<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> OtherAdd otherAdd;<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> OtherMinus otherMinus;<br><br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> OtherAdd getOtherAdd() {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> otherAdd;<br>    }<br><br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOtherAdd(OtherAdd otherAdd) {<br>        </span><span style="color: #0000ff;">this</span>.otherAdd =<span style="color: #000000;"> otherAdd;<br>    }<br><br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> OtherMinus getOtherMinus() {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> otherMinus;<br>    }<br><br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOtherMinus(OtherMinus otherMinus) {<br>        </span><span style="color: #0000ff;">this</span>.otherMinus =<span style="color: #000000;"> otherMinus;<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> add(<span style="color: #0000ff;">int</span> a, <span style="color: #0000ff;">int</span><span style="color: #000000;"> b) {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> otherAdd.add(a, b);<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> minus(<span style="color: #0000ff;">int</span> a, <span style="color: #0000ff;">int</span><span style="color: #000000;"> b) {<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> otherMinus.minus(a, b);<br>    }<br><br>}</span></pre><br></div>

]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> adapter </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[java 观察者模式]]></title>
      <url>/2012/11/20/java-%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<p>IWatched：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午4:58:25<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> IWatched {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> addWatcher(IWatcher watcher);<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> removeWatcher(IWatcher watcher);<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> notifyWatchers(String msg);<br>}</span></pre><br></div>

<p>IWatcher：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午4:55:23<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> IWatcher {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> update(String msg);<br>}</span></pre><br></div>

<p>Watched：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午5:01:05<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Watched <span style="color: #0000ff;">implements</span><span style="color: #000000;"> IWatched{<br>    </span><span style="color: #0000ff;">private</span> List&lt;IWatcher&gt; watchers = <span style="color: #0000ff;">new</span> ArrayList&lt;IWatcher&gt;<span style="color: #000000;">();<br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> addWatcher(IWatcher watcher) {<br>        watchers.add(watcher);<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> removeWatcher(IWatcher watcher) {<br>        watchers.remove(watcher);<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> notifyWatchers(String msg) {<br>        </span><span style="color: #0000ff;">for</span><span style="color: #000000;">(IWatcher watcher : watchers){<br>            watcher.update(msg);<br>        }<br>    }<br>}</span></pre><br></div>

<p>Watcher：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午5:04:56<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Watcher <span style="color: #0000ff;">implements</span><span style="color: #000000;"> IWatcher{<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> update(String msg) {<br>        System.out.println(msg);<br>    }<br>}</span></pre><br></div>

<p>Test：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午5:05:26<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Test {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br>        IWatched watched </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Watched();<br>        IWatcher watcher1 </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Watcher();<br>        IWatcher watcher2 </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Watcher();<br>        IWatcher watcher3 </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Watcher();<br>        watched.addWatcher(watcher1);<br>        watched.addWatcher(watcher2);<br>        watched.addWatcher(watcher3);<br>        watched.notifyWatchers(</span>“I have been clicked!”<span style="color: #000000;">);<br><br>        watched.removeWatcher(watcher1);<br>        watched.notifyWatchers(</span>“what’s up”<span style="color: #000000;">);<br>    }<br>}</span></pre><br></div>

]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> pattern </tag>
            
            <tag> observer </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[java 装饰者模式]]></title>
      <url>/2012/11/20/java-%E8%A3%85%E9%A5%B0%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<p>IPerson：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午3:43:04<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> IPerson {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> canDo();<br>}</span></pre><br></div>

<p>Person：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午3:44:04<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Person <span style="color: #0000ff;">implements</span><span style="color: #000000;"> IPerson{<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> canDo() {<br>        System.out.println(</span>“I can code”<span style="color: #000000;">);<br>    }<br>}</span></pre><br></div>

<p>Decorator（所有Person装饰者的父类）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午3:44:55<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Decorator <span style="color: #0000ff;">implements</span><span style="color: #000000;"> IPerson{<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> IPerson person;<br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Decorator(IPerson person) {<br>        </span><span style="color: #0000ff;">this</span>.person =<span style="color: #000000;"> person;<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> canDo() {<br>        person.canDo();<br>    }<br>}</span></pre><br></div>

<p>DecoratorSwim（Swim装饰–为Peron添加&ldquo;Swim&rdquo;功能）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午3:48:54<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> DecoratorSwim <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Decorator{<br><br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> DecoratorSwim(IPerson person) {<br>        </span><span style="color: #0000ff;">super</span><span style="color: #000000;">(person);<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> canDo() {<br>        </span><span style="color: #0000ff;">super</span><span style="color: #000000;">.canDo();<br>        System.out.println(</span>“I also can swim”<span style="color: #000000;">);<br>    }<br>}</span></pre><br></div>

<p>DecoratorDraw（Draw装饰–为Peron添加&ldquo;Draw&rdquo;功能）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午3:47:29<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> DecoratorDraw <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Decorator{<br><br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> DecoratorDraw(IPerson person) {<br>        </span><span style="color: #0000ff;">super</span><span style="color: #000000;">(person);<br>    }<br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> canDo() {<br>        </span><span style="color: #0000ff;">super</span><span style="color: #000000;">.canDo();<br>        System.out.println(</span>“I also can draw”<span style="color: #000000;">);<br>    }<br>}</span></pre><br></div>

<p>Test：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午3:49:35<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Test {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {</span><span style="color: #000000;"><br>        Decorator decorator </span>= <span style="color: #0000ff;">new</span> DecoratorDraw(<span style="color: #0000ff;">new</span> DecoratorSwim(<span style="color: #0000ff;">new</span><span style="color: #000000;"> Person()));<br>        decorator.canDo();<br>    }<br>}</span></pre><br></div>

]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> pattern </tag>
            
            <tag> decorator </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[java 代理模式（静态代理+动态代理）]]></title>
      <url>/2012/11/20/java-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F%EF%BC%88%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>静态代理：</p>
<p>ISubject：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午1:49:29<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> ISubject {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> request();<br>}</span></pre><br></div>

<p>RealSubject（真实角色）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午1:51:37<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> RealSubject <span style="color: #0000ff;">implements</span><span style="color: #000000;"> ISubject{<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> request() {<br>        System.out.println(</span>“realSubject requesting”<span style="color: #000000;">);<br>    }<br>}</span></pre><br></div>

<p>ProxySubject（代理类）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午1:52:22<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> ProxySubject <span style="color: #0000ff;">implements</span><span style="color: #000000;"> ISubject{<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> RealSubject realSubject;<br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> ProxySubject() {<br>        realSubject </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> RealSubject();<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> request() {<br>        System.out.println(</span>“do something before”<span style="color: #000000;">);<br>        realSubject.request();<br>        System.out.println(</span>“do something after”<span style="color: #000000;">);<br>    }<br>}</span></pre><br></div>

<p>Test（客户端测试）:</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午1:54:47<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Test {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br>        ISubject proxySubject </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> ProxySubject();<br>        proxySubject.request();<br>    }<br>}</span></pre><br></div>

<hr>
<p>动态代理：</p>
<p>ISubject：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午2:51:31<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> ISubject {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> request();<br>}</span></pre><br></div>

<p>RealSubject：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午2:52:00<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> RealSubject <span style="color: #0000ff;">implements</span><span style="color: #000000;"> ISubject{<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> request() {<br>        System.out.println(</span>“realSubject requesting”<span style="color: #000000;">);<br>    }<br>}</span></pre><br></div>

<p>SubjectInvocationHandler（调用处理类）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<strong></strong></span><span style="color: #008000;"><br> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian
  </span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午2:54:38<br> <em> 调用处理类<br> </em></span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> SubjectInvocationHandler <span style="color: #0000ff;">implements</span><span style="color: #000000;"> InvocationHandler{<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Object obj;<br><br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> SubjectInvocationHandler(Object obj) {<br>        </span><span style="color: #0000ff;">this</span>.obj =<span style="color: #000000;"> obj;<br>    }<br><br>    </span><span style="color: #008000;">/</span><span style="color: #008000;"><br>     <em> 生成代理类工厂
     </em> </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br>     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> realObj
      </span><span style="color: #808080;">@return 返回生成的代理类</span><br>     <span style="color: #008000;">*/</span><br>    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> Object getProxyInstanceFactory(Object realObj){<br>        Class</span>&lt;?&gt; classType =<span style="color: #000000;"> realObj.getClass();<br>        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> Proxy.newProxyInstance(classType.getClassLoader(),<br>                classType.getInterfaces(), </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> SubjectInvocationHandler(realObj));<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> Object invoke(Object proxy, Method method, Object[] args)<br>            </span><span style="color: #0000ff;">throws</span><span style="color: #000000;"> Throwable {<br>        System.out.println(</span>“before”<span style="color: #000000;">);<br><br>        method.invoke(obj, args);<br><br>        System.out.println(</span>“after”<span style="color: #000000;">);<br><br>        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>    }<br>}</span></pre><br></div>

<p>Test：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br> <em> </em></span><span style="color: #808080;">@version</span><span style="color: #008000;"> 创建时间：2012-11-20 下午2:56:25<br> </span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Test {<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br>        RealSubject realSubject </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> RealSubject();<br></span><span style="color: #008000;">//</span><span style="color: #008000;">        InvocationHandler handler = new SubjectInvocationHandler(realSubject);<br></span><span style="color: #008000;">//</span><span style="color: #008000;">        ISubject subject = (ISubject)Proxy.newProxyInstance(realSubject.getClass().getClassLoader(),<br></span><span style="color: #008000;">//</span><span style="color: #008000;">                realSubject.getClass().getInterfaces(), handler);</span><br>        ISubject subject =<span style="color: #000000;"> (ISubject)SubjectInvocationHandler.getProxyInstanceFactory(realSubject);<br>        subject.request();<br><br>    }<br>}</span></pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> proxy </tag>
            
            <tag> pattern </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java 单例模式]]></title>
      <url>/2012/11/20/Java-%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<p>Singleton模式主要作用是保证在Java<a href="http://baike.baidu.com/view/330120.htm" target="_blank" rel="noopener">应用程序</a>中，一个类Class只有一个实例存在。</p>
<p>好处：</p>
<p>&nbsp;&nbsp; &nbsp; 和全局变量相比，它对于系统性能的优化更好，因为它是属于什么时候用，什么时候实例化的。</p>
<p>　　一般Singleton模式通常有两种形式:</p>
<p>第一种形式: 也是常用的形式。</p>
<div class="cnblogs_code"><br><pre>　<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Singleton {<br>　　</span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> Singleton instance = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br>　　</span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Singleton(){<br>　　　　</span><span style="color: #008000;">//</span><span style="color: #008000;">do something</span><br><span style="color: #000000;">　　　　}<br>　　</span><span style="color: #008000;">//</span><span style="color: #008000;">这个方法比下面的有所改进，不用每次都进行生成对象，只是第一次使用时生成实例，提高了效率</span><br>　　<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> Singleton getInstance(){<br>　　　　</span><span style="color: #0000ff;">if</span>(instance==<span style="color: #0000ff;">null</span><span style="color: #000000;">){<br>　　　　　　instance </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Singleton();<br>　　　　}<br>　　　　</span><span style="color: #0000ff;">return</span><span style="color: #000000;"> instance;<br>　　　　}<br>　　}</span></pre><br></div>

<p><span>第二种形式:</span></p>
<div class="cnblogs_code"><br><pre>　<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Singleton {<br>　　　</span><span style="color: #008000;">//</span><span style="color: #008000;">在自己内部定义自己的一个实例，只供内部调用</span><br>　　　<span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> Singleton instance = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Singleton();<br>　　　</span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Singleton(){<br>　　　　　</span><span style="color: #008000;">//</span><span style="color: #008000;">do something</span><br><span style="color: #000000;">　　　}<br>　　　</span><span style="color: #008000;">//</span><span style="color: #008000;">这里提供了一个供外部访问本class的静态方法，可以直接访问</span><br>　　　<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> Singleton getInstance(){<br>　　　　　</span><span style="color: #0000ff;">return</span><span style="color: #000000;"> instance;<br>　　　}<br>　}</span></pre><br></div>

<p>ps：在静态初始化器中创建单件，这段代码就保证了线程安全。</p>
<p>对于多线程的访问，我们多半采用第二种&ldquo;急切&rdquo;的方式，而不用第一种延迟处理的方式，这样就会解决多线程对单一访问点访问造成顺序执行出错的问题。</p>
<p>&nbsp;</p>
<p>还有一种方式：用双重检查枷锁，在getInstance（）中减少使用同步</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Singleton{<br>  </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">volatile</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> Singleton instance;<br>  </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Singleton(){}<br>  </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> Singleton getInstance(){<br>    </span><span style="color: #0000ff;">if</span>(instance==<span style="color: #0000ff;">null</span><span style="color: #000000;">){<br>      </span><span style="color: #0000ff;">synchronized</span>(Singletion.<span style="color: #0000ff;">class</span><span style="color: #000000;">){<br>        </span><span style="color: #0000ff;">if</span>(instance == <span style="color: #0000ff;">null</span><span style="color: #000000;">){<br>          instance </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> Singleton();<br>        }<br>      }<br>    }<br>    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> instance;<br>  }<br>}</span></pre><br></div>

<p><span>volatile关键词确保：当instance变量被初始化成Singletion实例时，多个线程正确地处理instance变量，因为它会强制变量去对应内存中共享的变量</span></p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> pattern </tag>
            
            <tag> singleton </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[java 工厂模式]]></title>
      <url>/2012/11/19/java-%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<p><span>工厂模式细分有三种，分别为：简单工厂模式、工厂方法模式、抽象工厂模</span><span>式</span></p>
<p><span>现单个的讲，最后再讲这三个的区别</span><br><span>这篇文章主要通过一个农场的实例来讲解，这也是java与模式书中的例</span><span>子，只不过我对一些部分进行了简化，一些部分进行了扩充，以帮助理解例</span><span>子如下：</span><br><span>有一个农场公司，专门向市场销售各类水果有如下水果：</span><br><span>葡萄（grape）</span><br><span>草莓（strawberry）</span><br><span>苹果（apple）</span></p>
<p><span><strong>简单工厂模式：</strong></span></p>
<p><span><span>这个比较简单，写一下源代码源代码中给出了必须的注释代码比书上的要</span><span>简单一些，排版也好看一些，只是为了让新手更好的理解</span></span></p>
<p><span><span><span>Fruit.java:</span></span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> Fruit<br>{<br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
 水果与其它植物相比有一些专门的属性，以便与农场的<br><em> 其它植物区分开这里的水果假设它必须具备的方法：
</em> 生长grow()收获harvest()种植plant()<br></span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">void</span><span style="color: #000000;"> grow();<br></span><span style="color: #0000ff;">void</span><span style="color: #000000;"> harvest();<br></span><span style="color: #0000ff;">void</span><span style="color: #000000;"> plant();<br>}</span></pre><br></div>

<p><span>下面是Apple类的函数Apple.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Apple <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Fruit<br>{<br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> 
 苹果是水果类的一种，因此它必须实现水果接口的所有方法即<br><em> grow()harvest()plant()三个函数另外，由于苹果是多年生植物，
</em> 所以多出一个treeAge性质，描述苹果的树龄<br></span><span style="color: #008000;">*/</span><br><br><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> treeAge;<br><br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> grow() { <span style="color: #008000;">//</span><span style="color: #008000;">苹果的生长函数代码 }</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> harvest() { <span style="color: #008000;">//</span><span style="color: #008000;">苹果的收获函数代码 }</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> plant() { <span style="color: #008000;">//</span><span style="color: #008000;">苹果的种植函数代码 }</span><br><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> getTreeAge() { <span style="color: #0000ff;">return</span><span style="color: #000000;"> treeAge; }<br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setTreeAge(<span style="color: #0000ff;">int</span> treeAge) { <span style="color: #0000ff;">this</span>.treeAge =<span style="color: #000000;"> treeAge; }<br>}</span></pre><br></div>

<p><span>下面是Grape类的函数Grape.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Grape <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Fruit<br>{<br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> 
 葡萄是水果类的一种，因此它必须实现水果接口的所有方法即<br><em> grow()harvest()plant()三个函数另外，由于葡萄分为有籽和无籽
</em> 两种，因此多出一个seedless性质，描述葡萄有籽还是无籽<br></span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> seedless;<br><br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> grow() { <span style="color: #008000;">//</span><span style="color: #008000;">葡萄的生长函数代码 }</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> harvest() { <span style="color: #008000;">//</span><span style="color: #008000;">葡萄的收获函数代码 }</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> plant() { <span style="color: #008000;">//</span><span style="color: #008000;">葡萄的种植函数代码 }</span><br><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span> getSeedless() { <span style="color: #0000ff;">return</span><span style="color: #000000;"> seedless; }<br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setSeedless(<span style="color: #0000ff;">boolean</span> seedless) { <span style="color: #0000ff;">this</span>.seedless =<span style="color: #000000;"> seedless; }<br><br>}</span></pre><br></div>

<p><span>下面是Strawberry类的函数Strawberry.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Strawberry <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Fruit<br>{<br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> 
 草莓是水果类的一种，因此它必须实现水果接口的所有方法即<br><em> grow()harvest()plant()三个函数另外，这里假设草莓分为大棚草莓和一般
</em> 草莓（即没有棚的草莓）因此草莓比一般水果多出一个性质coteless，描述草莓<br><em> 是大棚草莓还是没有大棚的草莓<br></em></span><span style="color: #008000;">/</span><br><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> coteless;<br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> grow() { <span style="color: #008000;">//</span><span style="color: #008000;">草莓的生长函数代码 }</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> harvest() { <span style="color: #008000;">//</span><span style="color: #008000;">草莓的收获函数代码 }</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> plant() { <span style="color: #008000;">//</span><span style="color: #008000;">草莓的种植函数代码 }</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span> getCoteless() { <span style="color: #0000ff;">return</span><span style="color: #000000;"> coteless; }<br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setCoteless(<span style="color: #0000ff;">boolean</span> coteless) { <span style="color: #0000ff;">this</span>. coteless =<span style="color: #000000;"> coteless; }<br>}</span></pre><br></div>

<p><span>农场的园丁也是系统的一部分，自然要有一个合适的类来代表，我们用FruitGardener类</span><br><span>来表示FruitGardener类会根据客户端的要求，创建出不同的水果对象，比如苹果（apple）,</span><br><span>葡萄（grape）或草莓（strawberry）的实例代码如下所示：</span><br><span>FruitGardener.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> FruitGardener<br>{<br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
 通过下面的表态工厂方法，可以根据客户的需要，创建出不同的水果对象<br><em> 如果提供的参数是apple则通过return new Apple()创建出苹果实例
</em> 如果是提供的参数是grape则创建葡萄实例，这正是简单工厂方法之精髓<br></span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> Fruit factory(String which) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> BadFruitException<br>{<br>　　</span><span style="color: #0000ff;">if</span> (which.equalsIgnoreCase(“apple”)) { <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Apple(); }<br>　　</span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (which.equalsIgnoreCase(“strawberry”)) { <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Strawberry(); }<br>　　</span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (which.equalsIgnoreCase(“grape”)) { <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Grape(); }<br>　　</span><span style="color: #0000ff;">else</span> { <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> BadFruitException(“Bad fruit request”<span style="color: #000000;">); }<br>　　}<br>}</span></pre><br></div>

<p><span>简单工厂方法的优点是当在系统中引入新产品时不必修改客户端，但需要个修改工厂</span><span>类，将必要的逻辑加入到工厂类中工厂方法模式就克服了以上缺点，下面谈谈工厂</span><span>方法模式</span></p>
<p><span>————————————————————————————————————————————-</span></p>
<p><span><strong>工厂方法模式:</strong></span></p>
<p><span><span>由于水果接口以及grape类strawberry类apple类的代码都和上面的一样，所以下</span><span>面相关的源码去掉了注释</span><br><span>Fruit.java:</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> Fruit<br>{<br>　　</span><span style="color: #0000ff;">void</span><span style="color: #000000;"> grow();<br>　　</span><span style="color: #0000ff;">void</span><span style="color: #000000;"> harvest();<br>　　</span><span style="color: #0000ff;">void</span><span style="color: #000000;"> plant();<br>}</span></pre><br></div>

<p><span>Apple.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Apple <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Fruit<br>{<br>　　</span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> treeAge;<br>　　</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> grow() { <span style="color: #008000;">//</span><span style="color: #008000;">苹果的生长函数代码 }</span><br>　　<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> harvest() { <span style="color: #008000;">//</span><span style="color: #008000;">苹果的收获函数代码 }</span><br>　　<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> plant() { <span style="color: #008000;">//</span><span style="color: #008000;">苹果的种植函数代码 }</span><br>　　<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> getTreeAge() { <span style="color: #0000ff;">return</span><span style="color: #000000;"> treeAge; }<br>　　</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setTreeAge(<span style="color: #0000ff;">int</span> treeAge) { <span style="color: #0000ff;">this</span>.treeAge =<span style="color: #000000;"> treeAge; }<br>}</span></pre><br></div>

<p><span>Grape.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Grape <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Fruit<br>{<br>　　</span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> seedless;<br>　　</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> grow() { <span style="color: #008000;">//</span><span style="color: #008000;">葡萄的生长函数代码 }</span><br>　　<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> harvest() { <span style="color: #008000;">//</span><span style="color: #008000;">葡萄的收获函数代码 }</span><br>　　<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> plant() { <span style="color: #008000;">//</span><span style="color: #008000;">葡萄的种植函数代码 }</span><br><br>　　<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span> getSeedless() { <span style="color: #0000ff;">return</span><span style="color: #000000;"> seedless; }<br>　　</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setSeedless(<span style="color: #0000ff;">boolean</span> seedless) { <span style="color: #0000ff;">this</span>.seedless =<span style="color: #000000;"> seedless; }<br>}</span></pre><br></div>

<p><span>Strawberry.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Strawberry <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Fruit<br>{<br>　　</span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> coteless;<br>　　</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> grow() { <span style="color: #008000;">//</span><span style="color: #008000;">草莓的生长函数代码 }</span><br>　　<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> harvest() { <span style="color: #008000;">//</span><span style="color: #008000;">草莓的收获函数代码 }</span><br>　　<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> plant() { <span style="color: #008000;">//</span><span style="color: #008000;">草莓的种植函数代码 }</span><br>　　<span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span> getCoteless() { <span style="color: #0000ff;">return</span><span style="color: #000000;"> coteless; }<br>　　</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setCoteless(<span style="color: #0000ff;">boolean</span> coteless) { <span style="color: #0000ff;">this</span>. coteless =<span style="color: #000000;"> coteless; }<br>}</span></pre><br></div>

<p><span>下面的源码就是工厂方法模式的重点了，在简单工厂模式中，将这里将FruitGardener定</span><span>义为一个类，即园丁要管理园里的所有水果，如果园丁哪天病了，水果都不能管理了</span><span>在工厂方法模式中将FruitGardener定义为一个接口，而将管理水果的角色划分得更细，</span><span>比如有</span><span>葡萄园丁、草莓园丁、苹果园丁等等具体角色，实现FruitGardener接口的工厂</span><span>方法源码如下所示：</span><br><span>接口FruitGardener的源码：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> FruitGardener<br>{<br>　　Fruit factory();<br>}</span></pre><br></div>

<p><span>苹果园丁类AppleGardener.java的源码：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> AppleGardener <span style="color: #0000ff;">implements</span><span style="color: #000000;"> FruitGardener<br>{<br>　　</span><span style="color: #0000ff;">public</span> Fruit factory() { <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Apple(); }<br>}</span></pre><br></div>

<p><span>葡萄园丁类GrapeGardener.java的源码：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> GrapeGardener <span style="color: #0000ff;">implements</span><span style="color: #000000;"> FruitGardener<br>{<br>　　</span><span style="color: #0000ff;">public</span> Fruit factory() { <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Grape(); }<br>}</span></pre><br></div>

<p><span>草莓园丁类StrawberryGardener.java的源码：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> StrawberryGardener <span style="color: #0000ff;">implements</span><span style="color: #000000;"> FruitGardener<br>{<br>　　</span><span style="color: #0000ff;">public</span> Fruit factory() { <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Strawberry(); }<br>}</span></pre><br></div>

<p><span>由以上源码可以看出，使用工厂方法模式保持了简单工厂模式的优点，克服了其缺点，</span><span>当在系统中引入新产品时，既不必修改客户端，又不必修改具体工厂角色可以较好</span><span>的对系统进行扩展</span></p>
<p><span>——————————————————————————————————————————–</span></p>
<p><span><strong>抽象工厂模式：</strong><br><span>现在工厂再次大发展，要引进塑料大棚技术，在大棚里种植热带（Tropical）和亚热带的</span><span>水果和蔬菜（Veggie）其中水果分为TropicalFruit和NorthernFruit，蔬菜分为TropicalVeggie</span><span>和NorthernVeggie园丁包括TropicalGardener和NorthernGardener也就是说，</span><span>TropicalGardener专门管理TropicalFruit和TropicalGardener，NorthernGardener专门</span><span>管理NorthernFruit和NorthernVeggie抽象工厂模式在这个例子中的源码如下所示：</span><br><span>Fruit.java:</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span> Fruit { }</pre><br></div>

<p><span>NorthernFruit.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> NorthernFruit <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Fruit<br>{<br>　　</span><span style="color: #0000ff;">private</span><span style="color: #000000;"> String name;<br>　　</span><span style="color: #0000ff;">public</span><span style="color: #000000;"> NorthernFruit(String name) { }<br>　　</span><span style="color: #0000ff;">public</span> String getName() { <span style="color: #0000ff;">return</span><span style="color: #000000;"> name; }<br>　　</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setName(String name) { <span style="color: #0000ff;">this</span>.name =<span style="color: #000000;"> name; }<br>}</span></pre><br></div>

<p><span>TropicalFruit.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TropicalFruit <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Fruit<br>{<br>　　</span><span style="color: #0000ff;">private</span><span style="color: #000000;"> String name;<br>　　</span><span style="color: #0000ff;">public</span><span style="color: #000000;"> TropicalFruit(String name) { }<br>　　</span><span style="color: #0000ff;">public</span> String getName() { <span style="color: #0000ff;">return</span><span style="color: #000000;"> name; }<br>　　</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setName(String name) { <span style="color: #0000ff;">this</span>.name =<span style="color: #000000;"> name; }<br>}</span></pre><br></div>

<p><span>Veggie.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span> Veggie { }</pre><br></div>

<p><span>TropicalVeggie.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TropicalVeggie <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Veggie<br>{<br>　　</span><span style="color: #0000ff;">private</span><span style="color: #000000;"> String name;<br>　　</span><span style="color: #0000ff;">public</span><span style="color: #000000;"> TropicalVeggie(String name) { }<br>　　</span><span style="color: #0000ff;">public</span> String getName() { <span style="color: #0000ff;">return</span><span style="color: #000000;"> name; }<br>　　</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setName(String name) { <span style="color: #0000ff;">this</span>.name =<span style="color: #000000;"> name; }<br>}</span></pre><br></div>

<p><span>NorthernVeggie.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> NorthernVeggie <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Veggie<br>{<br>　　</span><span style="color: #0000ff;">private</span><span style="color: #000000;"> String name;<br>　　</span><span style="color: #0000ff;">public</span><span style="color: #000000;"> NorthernVeggie(String name) { }<br>　　</span><span style="color: #0000ff;">public</span> String getName() { <span style="color: #0000ff;">return</span><span style="color: #000000;"> name; }<br>　　</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setName(String name) { <span style="color: #0000ff;">this</span>.name =<span style="color: #000000;"> name; }<br>}</span></pre><br></div>

<p><span>Gardener.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> Gardener<br>{<br>　　Fruit createFruit(String name);<br>　　Veggie createVeggie(String name);<br>}</span></pre><br></div>

<p><span>TropicalGardener.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TropicalGardener <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Gardener<br>{<br>　　</span><span style="color: #0000ff;">public</span> Fruit createFruit(String name) { <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> TropicalFruit(name); }<br>　　</span><span style="color: #0000ff;">public</span> Veggie createVeggie(String name) { <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> TropicalVeggie(name); }<br>}</span></pre><br></div>

<p><span>NorthernGardener.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> NorthernGardener <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Gardener<br>{<br>　　</span><span style="color: #0000ff;">public</span> Fruit createFruit(String name) { <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> NorthernFruit(name); }<br>　　</span><span style="color: #0000ff;">public</span> Veggie createVeggie(String name) { <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> NorthernVeggie(name); }<br>}</span></pre><br></div>

<p><span>为了简单起见，这里只讲一下增加新产品（族）时该系统如何扩展（关于产品族相关</span><span>知识，请看此书的相关章节，不过不懂产品族也没有关系，这里写得很简单，肯定能</span><span>看懂）比如现在要增加南方水果（SouthFruit）和南方蔬菜（SouthVeggie）那</span><span>么只要增加如下代码即可很容易的扩展：</span><br><span>SouthFruit.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> SouthFruit <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Fruit<br>{<br>　　</span><span style="color: #0000ff;">private</span><span style="color: #000000;"> String name;<br>　　</span><span style="color: #0000ff;">public</span><span style="color: #000000;"> SouthFruit (String name) { }<br>　　</span><span style="color: #0000ff;">public</span> String getName() { <span style="color: #0000ff;">return</span><span style="color: #000000;"> name; }<br>　　</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setName(String name) { <span style="color: #0000ff;">this</span>.name =<span style="color: #000000;"> name; }<br>}</span></pre><br></div>

<p><span>SouthVeggie.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> SouthVeggie <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Veggie<br>{<br>　　</span><span style="color: #0000ff;">private</span><span style="color: #000000;"> String name;<br>　　</span><span style="color: #0000ff;">public</span><span style="color: #000000;"> SouthVeggie (String name) { }<br>　　</span><span style="color: #0000ff;">public</span> String getName() { <span style="color: #0000ff;">return</span><span style="color: #000000;"> name; }<br>　　</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setName(String name) { <span style="color: #0000ff;">this</span>.name =<span style="color: #000000;"> name; }<br>}</span></pre><br></div>

<p><span>SouthGardener.java:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> SouthGardener <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Gardener<br>{<br>　　</span><span style="color: #0000ff;">public</span> Fruit createFruit(String name) { <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> SouthFruit(name); }<br>　　</span><span style="color: #0000ff;">public</span> Veggie createVeggie(String name) { <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> SouthVeggie(name); }<br>}</span></pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> pattern </tag>
            
            <tag> factory </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[java 策略模式]]></title>
      <url>/2012/11/19/java-%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<p><strong>定义：</strong>定义一组算法，将每个算法都封装起来，并且使他们之间可以互换。</p>
<p><strong>类型：</strong>行为类模式</p>
<p><strong>类图：</strong></p>
<p><img src="http://my.csdn.net/uploads/201205/28/1338191755_7367.jpg" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 策略模式是对算法的封装，把一系列的算法分别封装到对应的类中，并且这些类实现相同的接口，相互之间可以替换。在前面说过的行为类模式中，有一种模式也是关注对算法的封装&mdash;&mdash;模版方法模式，对照类图可以看到，策略模式与模版方法模式的区别仅仅是多了一个单独的封装类Context，它与模版方法模式的区别在于：在模版方法模式中，调用算法的主体在抽象的父类中，而在策略模式中，调用算法的主体则是封装到了封装类Context中，抽象策略Strategy一般是一个接口，目的只是为了定义规范，里面一般不包含逻辑。其实，这只是通用实现，而在实际编程中，因为各个具体策略实现类之间难免存在一些相同的逻辑，为了避免重复的代码，我们常常使用抽象类来担任Strategy的角色，在里面封装公共的代码，因此，在很多应用的场景中，在策略模式中一般会看到模版方法模式的影子。</p>
<p>&nbsp;</p>
<p><strong>策略模式的结构</strong></p>
<ul>
<li><strong>封装类：</strong>也叫上下文，对策略进行二次封装，目的是避免高层模块对策略的直接调用。</li>
<li><strong>抽象策略：</strong>通常情况下为一个接口，当各个实现类中存在着重复的逻辑时，则使用抽象类来封装这部分公共的代码，此时，策略模式看上去更像是模版方法模式。</li>
<li><strong>具体策略：</strong>具体策略角色通常由一组封装了算法的类来担任，这些类之间可以根据需要自由替换。</li>
</ul>
<p><span>&nbsp;</span></p>
<p><strong>策略模式的优缺点</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 策略模式的主要优点有：</p>
<ul>
<li>策略类之间可以自由切换，由于策略类实现自同一个抽象，所以他们之间可以自由切换。</li>
<li>易于扩展，增加一个新的策略对策略模式来说非常容易，基本上可以在不改变原有代码的基础上进行扩展。</li>
<li>避免使用多重条件，如果不使用策略模式，对于所有的算法，必须使用条件语句进行连接，通过条件判断来决定使用哪一种算法，在上一篇文章中我们已经提到，使用多重条件判断是非常不容易维护的。</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 策略模式的缺点主要有两个：</p>
<ul>
<li>维护各个策略类会给开发带来额外开销，可能大家在这方面都有经验：一般来说，策略类的数量超过5个，就比较令人头疼了。</li>
<li>必须对客户端（调用者）暴露所有的策略类，因为使用哪种策略是由客户端来决定的，因此，客户端应该知道有什么策略，并且了解各种策略之间的区别，否则，后果很严重。例如，有一个排序算法的策略模式，提供了快速排序、冒泡排序、选择排序这三种算法，客户端在使用这些算法之前，是不是先要明白这三种算法的适用情况？再比如，客户端要使用一个容器，有链表实现的，也有数组实现的，客户端是不是也要明白链表和数组有什么区别？就这一点来说是有悖于迪米特法则的。</li>
</ul>
<p>&nbsp;</p>
<p><strong>适用场景</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 做面向对象设计的，对策略模式一定很熟悉，因为它实质上就是面向对象中的继承和多态，在看完策略模式的通用代码后，我想，即使之前从来没有听说过策略模式，在开发过程中也一定使用过它吧？至少在在以下两种情况下，大家可以考虑使用策略模式，</p>
<ul>
<li>几个类的主要逻辑相同，只在部分逻辑的算法和行为上稍有区别的情况。</li>
<li>有几种相似的行为，或者说算法，客户端需要动态地决定使用哪一种，那么可以使用策略模式，将这些算法封装起来供客户端调用。</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 策略模式是一种简单常用的模式，我们在进行开发的时候，会经常有意无意地使用它，一般来说，策略模式不会单独使用，跟模版方法模式、工厂模式等混合使用的情况比较多。</p>
<p>&nbsp;</p>
<p>应用场景举例：</p>
<p>刘备要到江东娶老婆了，走之前诸葛亮给赵云（伴郎）三个锦囊妙计，说是按天机拆开能解决棘手问题，嘿，还别说，真解决了大问题，搞到最后是周瑜陪了夫人又折兵，那咱们先看看这个场景是什么样子的。</p>
<p>先说说这个场景中的要素：三个妙计，一个锦囊，一个赵云，妙计是亮哥给的，妙计放在锦囊里，俗称就是锦囊妙计嘛，那赵云就是一个干活的人，从锦囊取出妙计，执行，然后获胜。用java程序怎么表现这些呢？</p>
<p><span>&nbsp;</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.yangguangfu.strategy;<br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> 
 <br> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> trygf521@126.com:阿福 
  首先定义一个策略接口，这是诸葛亮老人家给赵云的三个锦囊妙计的接口。<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> IStrategy {<br>    </span><span style="color: #008000;">//</span><span style="color: #008000;">每个锦囊妙计都是一个可执行的算法。  </span><br>    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> operate();<br><br>}  </span></pre><br></div>

<p><span>然后再写三个实现类，有三个妙计嘛：</span></p>
<p><span><span>妙计一：初到吴国：</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.yangguangfu.strategy;<br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> 
 <br> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> trygf521@126.com:阿福 
  找乔国老帮忙，使孙权不能杀刘备。<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> BackDoor <span style="color: #0000ff;">implements</span><span style="color: #000000;"> IStrategy {<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> operate() {<br>        System.out.println(</span>“找乔国老帮忙，让吴国太给孙权施加压力，使孙权不能杀刘备…”<span style="color: #000000;">);<br>    }<br><br>}  </span></pre><br></div>

<p>&nbsp;</p>
<p><span>妙计二：求吴国太开个绿灯，放行：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.yangguangfu.strategy;<br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> 
 <br> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> trygf521@126.com:阿福 
  求吴国太开个绿灯。<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> GivenGreenLight <span style="color: #0000ff;">implements</span><span style="color: #000000;"> IStrategy {<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> operate() {<br>        System.out.println(</span>“求吴国太开个绿灯，放行！”<span style="color: #000000;">);<br><br>    }<br><br>}  </span></pre><br></div>

<p><span>妙计三：孙夫人断后，挡住追兵：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.yangguangfu.strategy;<br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> 
 <br> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> trygf521@126.com:阿福 
  孙夫人断后，挡住追兵。<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> BlackEnemy <span style="color: #0000ff;">implements</span><span style="color: #000000;"> IStrategy {<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> operate() {<br>        System.out.println(</span>“孙夫人断后，挡住追兵…”<span style="color: #000000;">);<br><br>    }<br><br>}  </span></pre><br></div>

<p><span>好了，大家看看，三个妙计是有了，那需要有个地方放妙计啊，放锦囊里：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.yangguangfu.strategy;<br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> 
 <br> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> trygf521@126.com:阿福 
 <br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Context {<br><br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> IStrategy strategy;<br>    </span><span style="color: #008000;">//</span><span style="color: #008000;">构造函数，要你使用哪个妙计  </span><br>    <span style="color: #0000ff;">public</span><span style="color: #000000;"> Context(IStrategy strategy){<br>        </span><span style="color: #0000ff;">this</span>.strategy =<span style="color: #000000;"> strategy;<br>    }<br><br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> operate(){<br>        </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.strategy.operate();<br>    }<br><br>}  </span></pre><br></div>

<p><span>然后就是赵云雄赳赳的揣着三个锦囊，拉着已步入老年行列，还想着娶纯情少女的，色咪咪的刘备老爷子去入赘了，嗨，还别说，亮哥的三个妙计还真不错，瞧瞧：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.yangguangfu.strategy;<br><br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ZhaoYun {<br><br>    </span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> 
      赵云出场了，他根据诸葛亮给他的交代，依次拆开妙计<br>     </span><span style="color: #008000;">*/</span><br>    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br>        Context context;<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">刚到吴国的时候拆开第一个  </span><br>        System.out.println(“———-刚刚到吴国的时候拆开第一个—————“<span style="color: #000000;">);<br>        context </span>= <span style="color: #0000ff;">new</span> Context(<span style="color: #0000ff;">new</span><span style="color: #000000;"> BackDoor());<br>        context.operate();</span><span style="color: #008000;">//</span><span style="color: #008000;">拆开执行  </span><br>        System.out.println(“\n\n\n\n\n\n\n\n\n\n\n\n\n”<span style="color: #000000;">);<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">当刘备乐不思蜀时，拆开第二个  </span><br>        System.out.println(“———-刘备乐不思蜀，拆第二个了—————“<span style="color: #000000;">);<br>        context </span>= <span style="color: #0000ff;">new</span> Context(<span style="color: #0000ff;">new</span><span style="color: #000000;"> GivenGreenLight());<br>        context.operate();</span><span style="color: #008000;">//</span><span style="color: #008000;">拆开执行  </span><br>        System.out.println(“\n\n\n\n\n\n\n\n\n\n\n\n\n”<span style="color: #000000;">);<br><br>        </span><span style="color: #008000;">//</span><span style="color: #008000;">孙权的小追兵了，咋办？拆开第三个锦囊  </span><br>        System.out.println(“———-孙权的小追兵了，咋办？拆开第三个锦囊—————“<span style="color: #000000;">);<br>        context </span>= <span style="color: #0000ff;">new</span> Context(<span style="color: #0000ff;">new</span><span style="color: #000000;"> BlackEnemy());<br>        context.operate();</span><span style="color: #008000;">//</span><span style="color: #008000;">拆开执行  </span><br>        System.out.println(“\n\n\n\n\n\n\n\n\n\n\n\n\n”<span style="color: #000000;">);<br>    }<br><br>}  </span></pre><br></div>

<p><span>后话：就这三招，搞得的周郎是&ldquo;赔了夫人又折兵&rdquo;呀！这就是策略模式，高内聚低耦合的特点也表现出来了，还有一个就是扩展性，也就是OCP原则，策略类可以继续添加下去气，只是修改Context.java就可以了，这个不多说了，自己领会吧。</span></p>
<p>转自&nbsp;<a href="http://yangguangfu.iteye.com/blog/815107" target="_blank" rel="noopener">http://yangguangfu.iteye.com/blog/815107</a>&nbsp;和&nbsp;<a href="http://blog.csdn.net/zhengzhb/article/details/7609670" target="_blank" rel="noopener">http://blog.csdn.net/zhengzhb/article/details/7609670</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> pattern </tag>
            
            <tag> strategy </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Zxing android 解析流程]]></title>
      <url>/2012/10/23/Zxing-android-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B/</url>
      <content type="html"><![CDATA[<p>&nbsp;对于刚开始学习android开发的童鞋们来说，若有一个简单而又全面的android工程能来剖析，那就是再好不过了，zxing就是不错得例子。</p>
<div>&nbsp;&nbsp;&nbsp;&nbsp;zxing的源码可以到google code上下载，整个源码check out 下来，里面有各个平台的源码，ios的，android的。当然我们需要的就是android代码。</div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;将android的工程导入到eclipse中，导入完成后，eclipse会显示各种错误，这是缺少core文件夹里面的核心库文件所致，在project中创建文件夹core，再将zxing源码中得core文件夹下得代码导入进来，这样就可以了。</div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;如果遇到unable resolved target-X，则是你的avd版本问题，可以在project.propertities修改target值。clean下就ok。</div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;如上的都是zxing android代码分析的准备，下面的则是正式开始。</div><br><div><br><br><img src="http://pic4.xihuan.me/dr/680__90/t02110ad14c2cdda9e7.png" alt=""><br><br></div><br><div>&nbsp;&nbsp;&nbsp;&nbsp;如上图：为整个android工程的代码，android入门就重这些代码着手。其中主要关注的是android，camera，encode，result文件夹。</div><br><div>&nbsp;&nbsp;&nbsp;程序启动的流程：加载main activity，在此类中创建CaptureActivityHandler对象，该对象启动相机，实现自动聚焦，创建DecodeThread线程，DecodeThread创建Decodehandler，这个对象就获取从相机得到的原始byte数据，开始解码的第一步工作，从获取的byte中解析qr图来，并解析出qr图中的字符，将这块没有分析的字符抛送到CaptureActivityHandler中handle，该类调用main activity的decode函数完成对字符的分析，最后显示在界面上（刷新UI，最好在UI线程里完成）。这样一个解析qr图的过程并完成。</div><br><div>&nbsp;&nbsp;&nbsp;下面具体分析整个过程。重点之处有main activity,camera.</div><br><div>&nbsp;&nbsp;&nbsp;程序启动的第一个activity便是：CaptureActivity,有点类似于c中的main函数，在此是main activity。这个acitvity做的主要的事便是：加载扫描各种条形码，二维码的一个界面，启动一个处理获取一维码二维码信息的线程，完成对于获取的图像信息进行解码，最后再将解码的信息显示在界面上。</div><br><div>&nbsp;&nbsp;&nbsp;</div><br><div>&nbsp;&nbsp;&nbsp;完成界面的加载主要在于onCreate，和onResume函数中，这涉及到了一个activity的生命周期，以后再具体分析。首先调用onCreate，再调用onResume，在onResume中会判断这个activity是由什么启动的，可能是其他的app触发了，也可能是用户直接启动的。这样就初始化了三个变量，一是source，便是启动activity的源，一是decodeFormats，指出解码的方式，是qr，还是其他的等等，最后一个是：charactreset，即是对于这些生成qr图的字符的编码方式。若没有对core中得代码修改，用该程序解析GB2312编码的字符则会乱码。乱码的解决后面将提到。</div><br><div>&nbsp;&nbsp;&nbsp;界面的加载中有两个很关键的类。surfaceview 和 ViewFinderView，前面的是用来加载从底层硬件获取的相机取景的图像，后面的是自定义的view，实现了扫描时的界面，不停的刷新，并将识别的一些数据，如定位的点回调显示在界面上。</div>

]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> zxing </tag>
            
            <tag> qr </tag>
            
            <tag> qrcode </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[EditText的属性介绍]]></title>
      <url>/2012/10/15/EditText%E7%9A%84%E5%B1%9E%E6%80%A7%E4%BB%8B%E7%BB%8D/</url>
      <content type="html"><![CDATA[<p>EditText继承TextView，所以EditText具有TextView的属性特点，下面主要介绍一些EditText的特有的输入法的属性特点</p>
<p>android:layout_gravity=”center_vertical”<span>：设置控件显示的位置：默认</span>top<span>，这里居中显示，还有</span>bottom</p>
<div>android:hin<span>：Text为空时显示的文字提示信息，可通过textColorHint设置提示信息的颜色。</span></div><br><div>android:singleLine<span>：设置单行输入，一旦设置为</span>true<span>，则文字不会自动换行。</span></div><br><div>android:gray=”top”&nbsp;<span>：多行中指针在第一行第一位置</span>et.setSelection(et.length());<span>：调整光标到最后一行</span></div><br><div>android:autoText&nbsp;<span>：自动拼写帮助。这里单独设置是没有效果的，可能需要其他输入法辅助才行</span></div><br><div>android:capitalize&nbsp;<span>：设置英文字母大写类型。设置如下值：sentences仅第一个字母大写；words每一个单词首字母大小，用空格区分单词；characters每一个英文字母都大写。</span></div><br><div>android:digits&nbsp;<span>：设置允许输入哪些字符。如&ldquo;1234567890.+-*/%\n()&rdquo;</span></div><br><div>android:singleLine&nbsp;<span>：是否单行或者多行，回车是离开文本框还是文本框增加新行</span>android:numeric&nbsp;<span>：如果被设置，该TextView接收数字输入。有如下值设置：integer正整数、signed带符号整数、decimal带小数点浮点数。</span></div><br><div>android:inputType:设置文本的类型</div><br><div>android:password&nbsp;<span>：密码，以小点&rdquo;.&rdquo;显示文本</span></div><br><div>android:phoneNumber&nbsp;<span>：设置为电话号码的输入方式。</span></div><br><div>android:editable&nbsp;<span>：设置是否可编辑。仍然可以获取光标，但是无法输入。</span></div><br><div>android:autoLink=&rdquo;all&rdquo;&nbsp;<span>：设置文本超链接样式当点击网址时，跳向该网址</span></div><br><div>android:textColor = “#ff8c00”<span>：字体颜色</span></div><br><div>android:textStyle=”bold”<span>：字体，</span>bold, italic, bolditalic</div><br><div>android:textAlign=”center”<span>：</span>EditText<span>没有这个属性，但</span>TextView<span>有</span></div><br><div>android:textColorHighlight=”#cccccc”<span>：被选中文字的底色，默认为蓝色</span></div><br><div>android:textColorHint=”#ffff00”<span>：设置提示信息文字的颜色，默认为灰色</span></div><br><div>android:textScaleX=”1.5”<span>：控制字与字之间的间距</span></div><br><div>android:typeface=”monospace”<span>：字型，</span>normal, sans, serif, monospace</div><br><div>android:background=”@null”<span>：空间背景，这里没有，指透明</span></div><br><div>android:layout_weight=”1”<span>：权重在控制控件显示的大小时蛮有用的。</span></div><br><div>android:textAppearance=”?android:attr/textAppearanceLargeInverse”<span>：文字外观，这里引用的是系统自带的一个外观，？表示系统是否有这种外观，否则使用默认的外观。</span></div><br><div><span>&nbsp;</span></div><br><div><span>&nbsp;</span></div><br><div><span>来源:<a href="http://liangruijun.blog.51cto.com/3061169/627350" target="_blank" rel="noopener">http://liangruijun.blog.51cto.com/3061169/627350</a></span></div>

]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> EditText </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[TextView的属性详解]]></title>
      <url>/2012/10/15/TextView%E7%9A%84%E5%B1%9E%E6%80%A7%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<div align="left">android:autoLink ：设置是否当文本为URL链接/email/电话号码/map时，文本显示为可点击的链接。可选值(none/web /email/phone/map/all)<br>android:autoText ：如果设置，将自动执行输入值的拼写纠正。此处无效果，在显示输入法并输入的时候起作用。<br>android:bufferType ： 指定getText()方式取得的文本类别。选项editable 类似于StringBuilder ：可追加字符，也就是说getText后可调用append方法设置文本内容。spannable ：则可在给定的字符区域使用样式，参见这里1、这里2。<br>android:capitalize ：设置英文字母大写类型。此处无效果，需要弹出输入法才能看得到，参见EditView此属性说明。<br>android:cursorVisible：设定光标为显示/隐藏，默认显示。<br>android:digits：设置允许输入哪些字符。如&ldquo;1234567890.+-*/% ()&rdquo;<br>android:drawableBottom：在text的下方输出一个drawable，如图片。如果指定一个颜色的话会把text的背景设为该颜色，并且同时和background使用时覆盖后者。<br>android:drawableLeft：在text的左边输出一个drawable，如图片。<br>android:drawablePadding：设置text与drawable(图片)的间隔，与drawableLeft、 drawableRight、drawableTop、drawableBottom一起使用，可设置为负数，单独使用没有效果。<br>android:drawableRight：在text的右边输出一个drawable。<br>android:drawableTop：在text的正上方输出一个drawable。<br>android:editable：设置是否可编辑。<br>android:editorExtras：设置文本的额外的输入数据。<br>android:ellipsize：设置当文字过长时,该控件该如何显示。有如下值设置：&rdquo;start&rdquo;&mdash;?省略号显示在开头;&rdquo;end&rdquo; &mdash;&mdash;省略号显示在结尾;&rdquo;middle&rdquo;&mdash;-省略号显示在中间;&rdquo;marquee&rdquo; &mdash;&mdash;以跑马灯的方式显示(动画横向移动)<br>android:freezesText：设置保存文本的内容以及光标的位置。<br>android:gravity：设置文本位置，如设置成&ldquo;center&rdquo;，文本将居中显示。<br>android:hintText：为空时显示的文字提示信息，可通过textColorHint设置提示信息的颜色。此属性在 EditView中使用，但是这里也可以用。<br>android:imeOptions：附加功能，设置右下角IME动作与编辑框相关的动作，如actionDone右下角将显示一个&ldquo;完成&rdquo;，而不设置默认是一个回车符号。这个在EditView中再详细说明，此处无用。<br>android:imeActionId：设置IME动作ID。<br>android:imeActionLabel：设置IME动作标签。<br>android:includeFontPadding：设置文本是否包含顶部和底部额外空白，默认为true。<br>android:inputMethod：为文本指定输入法，需要完全限定名(完整的包名)。例如：com.google.android.inputmethod.pinyin，但是这里报错找不到。<br>android:inputType：设置文本的类型，用于帮助输入法显示合适的键盘类型。在EditView中再详细说明，这里无效果。<br>android:linksClickable：设置链接是否点击连接，即使设置了autoLink。<br>android:marqueeRepeatLimit：在ellipsize指定marquee的情况下，设置重复滚动的次数，当设置为 marquee_forever时表示无限次。<br>android:ems：设置TextView的宽度为N个字符的宽度。这里测试为一个汉字字符宽度<br>android:maxEms：设置TextView的宽度为最长为N个字符的宽度。与ems同时使用时覆盖ems选项。<br>android:minEms：设置TextView的宽度为最短为N个字符的宽度。与ems同时使用时覆盖ems选项。<br>android:maxLength：限制显示的文本长度，超出部分不显示。<br>android:lines：设置文本的行数，设置两行就显示两行，即使第二行没有数据。<br>android:maxLines：设置文本的最大显示行数，与width或者layout_width结合使用，超出部分自动换行，超出行数将不显示。<br>android:minLines：设置文本的最小行数，与lines类似。<br>android:lineSpacingExtra：设置行间距。<br>android:lineSpacingMultiplier：设置行间距的倍数。如&rdquo;1.2&rdquo;<br>android:numeric：如果被设置，该TextView有一个数字输入法。此处无用，设置后唯一效果是TextView有点击效果，此属性在EdtiView将详细说明。<br>android:password：以小点&rdquo;.&rdquo;显示文本<br>android:phoneNumber：设置为电话号码的输入方式。<br>android:privateImeOptions：设置输入法选项，此处无用，在EditText将进一步讨论。<br>android:scrollHorizontally：设置文本超出TextView的宽度的情况下，是否出现横拉条。<br>android:selectAllOnFocus：如果文本是可选择的，让他获取焦点而不是将光标移动为文本的开始位置或者末尾位置。 TextView中设置后无效果。<br>android:shadowColor：指定文本阴影的颜色，需要与shadowRadius一起使用。<br>android:shadowDx：设置阴影横向坐标开始位置。<br>android:shadowDy：设置阴影纵向坐标开始位置。<br>android:shadowRadius：设置阴影的半径。设置为0.1就变成字体的颜色了，一般设置为3.0的效果比较好。<br>android:singleLine：设置单行显示。如果和layout<em>width一起使用，当文本不能全部显示时，后面用&ldquo;&hellip;&rdquo;来表示。如android:text=”test</em> singleLine “<br>android:singleLine=”true” android:layout_width=”20dp”将只显示&ldquo;t&hellip;&rdquo;。如果不设置singleLine或者设置为false，文本将自动换行<br>android:text：设置显示文本.<br>android:textAppearance：设置文字外观。如 &ldquo;?android:attr/textAppearanceLargeInverse&rdquo;这里引用的是系统自带的一个外观，?表示系统是否有这种外观，否则使用默认的外观。可设置的值如下：textAppearanceButton/textAppearanceInverse/textAppearanceLarge/textAppearanceLargeInverse/textAppearanceMedium/textAppearanceMediumInverse/textAppearanceSmall/textAppearanceSmallInverse<br>android:textColor：设置文本颜色<br>android:textColorHighlight：被选中文字的底色，默认为蓝色<br>android:textColorHint：设置提示信息文字的颜色，默认为灰色。与hint一起使用。<br>android:textColorLink：文字链接的颜色.<br>android:textScaleX：设置文字之间间隔，默认为1.0f。<br>android:textSize：设置文字大小，推荐度量单位&rdquo;sp&rdquo;，如&rdquo;15sp&rdquo;<br>android:textStyle：设置字形[bold(粗体) 0, italic(斜体) 1, bolditalic(又粗又斜) 2] 可以设置一个或多个，用&ldquo;|&rdquo;隔开<br>android:typeface：设置文本字体，必须是以下常量值之一：normal 0, sans 1, serif 2, monospace(等宽字体) 3]<br>android:height：设置文本区域的高度，支持度量单位：px(像素)/dp/sp/in/mm(毫米)<br>android:maxHeight：设置文本区域的最大高度<br>android:minHeight：设置文本区域的最小高度<br>android:width：设置文本区域的宽度，支持度量单位：px(像素)/dp/sp/in/mm(毫米)，与layout_width 的区别看这里。<br>android:maxWidth：设置文本区域的最大宽度<br>android:minWidth：设置文本区域的最小宽度</div><br><div>&nbsp;</div>

<p>附件：Android中的长度单位详解</p>
<p>Android中的长度单位详解（dp、sp、px、in、pt、mm）有很多人不太理解dp、sp 和px 的区别：现在这里介绍一下dp 和sp。dp 也就是dip。这个和sp 基本类似。如果设置表示长度、高度等属性时可以使用dp 或sp。但如果设置字体，需要使用sp。dp 是与密度无关，sp 除了与密度无关外，还与scale 无关。如果屏幕密度为160，这时dp 和sp 和px 是一样的。1dp=1sp=1px，但如果使用px 作单位，如果屏幕大小不变（假设还是3.2 寸），而屏幕密度变成了320。那么原来TextView 的宽度设成160px，在密度为320 的3.2 寸屏幕里看要比在密度为160 的3.2 寸屏幕上看短了一半。但如果设置成160dp 或160sp 的话。系统会自动将width 属性值设置成320px 的。也就是160 * 320 / 160。其中320 / 160 可称为密度比例因子。也就是说，如果使用dp 和sp，系统会根据屏幕密度的变化自动进行转换。</p>
<p>其他单位的含义<br>px：表示屏幕实际的象素。例如，320<em>480 的屏幕在横向有320个象素，在纵向有480 个象素。<br>in：表示英寸，是屏幕的物理尺寸。每英寸等于2.54 厘米。例如，形容手机屏幕大小，经常说，3.2（英）寸、3.5（英）寸、4（英）寸就是指这个单位。这些尺寸是屏幕的对角线长度。如果手机的屏幕是3.2 英寸，表示手机的屏幕（可视区域）对角线长度是3.2</em>2.54 = 8.128 厘米。读者可以去量一量自己的手机屏幕，看和实际的尺寸是否一致。<br>mm：表示毫米，是屏幕的物理尺寸。<br>pt：表示一个点，是屏幕的物理尺寸。大小为1 英寸的1/72。</p>
<p>&nbsp;</p>
<p>&nbsp;<br>来源：<a href="http://liangruijun.blog.51cto.com/3061169/627123" target="_blank" rel="noopener">http://liangruijun.blog.51cto.com/3061169/627123</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> TextView </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android使用ListView应该注意的地方]]></title>
      <url>/2012/06/19/Android%E4%BD%BF%E7%94%A8ListView%E5%BA%94%E8%AF%A5%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9/</url>
      <content type="html"><![CDATA[<p><span>在ListView中设置Selector为null会报空指针？</span>&nbsp;<br>mListView.setSelector(null);//空指针&nbsp;<br>试试下面这种：&nbsp;<br>mListView.setSelector(new ColorDrawable(Color.TRANSPARENT));&nbsp;</p>
<p><span>如何让ListView初始化的时候就选中一项?</span>&nbsp;<br>ListView需要在初始化好数据后,其中一项需要呈选中状态。所谓”选中状态”就是该项底色与其它项不同,setSelection(position)只能定位到某个item，但是无法改变底色呈高亮。setSelection(position)只能让某个item显示在可见Item的最上面(如果Item超过一屏的话)! 就是所谓的firstVisibleItem啦！&nbsp;<br>如果想要实现效果可以在listview所绑定的adapter里的getView函数里去完成一些具体的工作。可以记下你要高亮的那个item的index，在getView函数里判断index（也就是position），如果满足条件则加载不同的背景。&nbsp;</p>
<p><span>ListView的右边滚动滑块启用方法？</span>&nbsp;<br>&nbsp;&nbsp;&nbsp; 很多开发者不知道ListView列表控件的快速滚动滑块是如何启用的，其实辅助滚动滑块只需要一行代码就可以搞定，如果你使用XML布局只需要在ListView节点中加入&nbsp; android:fastScrollEnabled=”true” 这个属性即可，而对于Java代码可以通过myListView.setFastScrollEnabled(true); 来控制启用，参数false为隐藏。&nbsp;<br>&nbsp;&nbsp;&nbsp; 还有一点就是当你的滚动内容较小，不到当前ListView的3个屏幕高度时则不会出现这个快速滚动滑块，该方法是AbsListView的基础方法，可以在ListView或GridView等子类中使用快速滚动辅助。&nbsp;</p>
<p><img src="http://dl.iteye.com/upload/attachment/463627/bb15bcb0-3d45-33fc-9460-8ca9f90bb29d.jpg" alt="">&nbsp;</p>
<p>1. 更新ListView中的數據,通過調用BaseAdapter對象的notifyDataSetChanged()方法：&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mAdapter.notifyDataSetChanged();&nbsp;</p>
<p>2. 每個listview都有無效的位置,如第一行的前一行,最後一行的後一行,這個無效的位置是一個常量.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; ListView.INVALID_POSITION&nbsp;</p>
<p>3. 有時我們需要在程序中通過點擊按鈕來控制ListView行的選中,這就用到了在程序中如何使用代碼來選擇ListView項.&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mListView.requestFocusFromTouch();&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mListView.setSelection(int index);&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 第一條語句並不是必須的,但是若你ListView項中含有Button,RadioButton,CheckBox等比ListView取得 焦點優先級高的控件時,那麼第一條語句是你必須加的.&nbsp;</p>
<p><span>4.&nbsp; 同樣的,若你ListView項中含有Button,RadioButton,CheckBox等比ListView取得 焦點優先級高的控件時,ListView的setOnItemClickListener是不被執行的,這時你需要在你的xml文件中對這些控件添加&nbsp;&nbsp;<span>android:focusable=”false” 注意這條語句要放在xml文件中修改,在代碼中使用是無效的.</span>&nbsp;</span></p>
<p>5. 如何保持ListView的滾動條一直顯示,不隱藏呢:&nbsp; xml文件中做如下修改&nbsp;&nbsp;&nbsp; android:fadeScrollbars=”false”&nbsp;</p>
<p>6. ListView本身有自己的按鍵事件，即你不需要設置方向鍵的標識，按下方向鍵ListView就會有默認的動作，那如何進行控制，編寫自己的onKey呢，你需要在Activity中重寫dispatchKeyEvent(KeyEvent event)；方法，在這裡面定義你自己的動作就可以了&nbsp;</p>
<p><span>ListView 自定义滚动条样式：</span>&nbsp;<br>&lt;ListView android:id=”@android:id/list”&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:layout_width=”match_parent”&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:layout_height=”0dip”&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:layout_weight=”1”&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:stackFromBottom=”true”//从下开始显示条目&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:transcriptMode=”normal”&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:fastScrollEnabled=”true”&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:focusable=”true”&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:scrollbarTrackVertical=”@drawable/scrollbar_vertical_track”&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:scrollbarThumbVertical=”@drawable/scrollbar_vertical_thumb”&nbsp;<br>/&gt;&nbsp;<br>//scrollbar_vertical_track，crollbar_vertical_thumb自定义的xml文件，放在Drawable中，track是指长条，thumb是指短条&nbsp;<br><span>去掉ListView Selector选种时黄色底纹一闪的效果：</span>&nbsp;</p>
<div class="dp-highlighter"><br><div class="bar"><br><div class="tools">Xml代码&nbsp; &nbsp;<a href="http://gundumw100.iteye.com/blog/1169065" title="收藏这段代码" target="_blank" rel="noopener"><img src="http://gundumw100.iteye.com/images/icon_star.png" alt="收藏代码"></a></div>

<p></p></div><p></p>
<ol>
<li><span><span class="tag">&lt;?</span><span class="tag-name">xml</span>&nbsp;<span class="attribute">version</span>=<span class="attribute-value">“1.0”</span>&nbsp;<span class="attribute">encoding</span>=<span class="attribute-value">“utf-8”</span><span class="tag">?&gt;</span>&nbsp;&nbsp;</span></li>
<li><span><span class="tag">&lt;</span><span class="tag-name">shape</span>&nbsp;<span class="attribute">xmlns:android</span>=<span class="attribute-value">“<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><span class="tag">&gt;</span>&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;</span><span class="tag-name">solid</span>&nbsp;<span class="attribute">android:color</span>=<span class="attribute-value">“@android:color/transparent”</span><span class="tag">/&gt;</span>&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;</span><span class="tag-name">corners</span>&nbsp;<span class="attribute">android:radius</span>=<span class="attribute-value">“0dip”</span>&nbsp;<span class="tag">/&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li>
<li><span><span class="tag">&lt;/</span><span class="tag-name">shape</span><span class="tag">&gt;</span>&nbsp;&nbsp;</span></li>
<li><span>//listview.setSelector(R.drawable.thisShape);&nbsp;&nbsp;</span></li></ol></div>

<p>或者还有一种办法：&nbsp;<br>在Adapter中重写public boolean isEnabled(int position)方法，将其返回false就可以了，推荐采用此种办法,具体见<a href="http://gundumw100.iteye.com/admin/blogs/850654" target="_blank" rel="noopener">http://gundumw100.iteye.com/admin/blogs/850654</a>&nbsp;</p>
<div class="dp-highlighter"><br><div class="bar"><br><div class="tools">Java代码&nbsp; &nbsp;<a href="http://gundumw100.iteye.com/blog/1169065" title="收藏这段代码" target="_blank" rel="noopener"><img src="http://gundumw100.iteye.com/images/icon_star.png" alt="收藏代码"></a></div>

<p></p></div><p></p>
<ol>
<li><span><span class="keyword">public</span>&nbsp;<span class="keyword">boolean</span>&nbsp;isEnabled(<span class="keyword">int</span>&nbsp;position)&nbsp;{&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;TODO&nbsp;Auto-generated&nbsp;method&nbsp;stub</span>&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>&nbsp;<span class="keyword">false</span>;&nbsp;&nbsp;</span></li>
<li><span>}&nbsp;&nbsp;</span></li></ol></div>

<p><span>ListView几个比较特别的属性</span>&nbsp;<br>首先是stackFromBottom属性，这只该属性之后你做好的列表就会显示你列表的最下面，值为true和false&nbsp;<br>android:stackFromBottom=”true”&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>第二是transciptMode属性，需要用ListView或者其它显示大量Items的控件实时跟踪或者查看信息，并且希望最新的条目可以自动滚动到可视范围内。通过设置的控件transcriptMode属性可以将Android平台的控件（支持ScrollBar）自动滑动到最底部。&nbsp;<br>android:transcriptMode=”alwaysScroll”&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>第三cacheColorHint属性，很多人希望能够改变一下它的背景，使他能够符合整体的UI设计，改变背景背很简单只需要准备一张图片然后指定属性 android:background=”@drawable/bg”，不过不要高兴地太早，当你这么做以后，发现背景是变了，但是当你拖动，或者点击list空白位置的时候发现ListItem都变成黑色的了，破坏了整体效果。&nbsp;<br>如果你只是换背景的颜色的话，可以直接指定android:cacheColorHint为你所要的颜色，如果你是用图片做背景的话，那也只要将android:cacheColorHint指定为透明（#00000000）就可以了&nbsp;</p>
<p>第四divider属性，该属性作用是每一项之间需要设置一个图片做为间隔，或是去掉item之间的分割线android:divider=”@drawable/list_driver”&nbsp; 其中&nbsp; @drawable/list_driver 是一个图片资源，如果不想显示分割线则只要设置为android:divider=”@drawable/@null” 就可以了&nbsp;</p>
<p>第五fadingEdge属性，上边和下边有黑色的阴影android:fadingEdge=”none” 设置后没有阴影了~&nbsp;</p>
<p>第五scrollbars属性，作用是隐藏listView的滚动条，android:scrollbars=”none”与setVerticalScrollBarEnabled(true);的效果是一样的，不活动的时候隐藏，活动的时候也隐藏&nbsp;</p>
<p>第六fadeScrollbars属性，android:fadeScrollbars=”true”&nbsp; 配置ListView布局的时候，设置这个属性为true就可以实现滚动条的自动隐藏和显示。&nbsp;</p>
<p><span>如何在使用gallery在flinging拖动时候不出现选择的情况？&nbsp;</span><br>这时候需要注意使用&nbsp;<br>gallery.setCallbackDuringFling(false)&nbsp;</p>
<p><span>如何让ListView自动滚动？&nbsp;</span><br>注意stackFromBottom以及transcriptMode这两个属性。类似Market客户端的低端不断滚动。&nbsp;<br>&lt;ListView android:id=”listCWJ”&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; android:layout_width=”fill_parent”&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; android:layout_height=”fill_parent”&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; android:stackFromBottom=”true”&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; android:transcriptMode=”alwaysScroll”&nbsp;&nbsp;<br>/&gt;&nbsp;<br><span>如何遍历listView 的的单选框？</span>&nbsp;</p>
<div class="dp-highlighter"><br><div class="bar"><br><div class="tools">Java代码&nbsp; &nbsp;<a href="http://gundumw100.iteye.com/blog/1169065" title="收藏这段代码" target="_blank" rel="noopener"><img src="http://gundumw100.iteye.com/images/icon_star.png" alt="收藏代码"></a></div>

<p></p></div><p></p>
<ol>
<li><span>ListView&nbsp;listView&nbsp;=&nbsp;(ListView)findViewById(R.id.配置文件中ListView的ID);&nbsp;&nbsp;</span></li>
<li><span><span class="comment">//全选遍历ListView的选项，每个选项就相当于布局配置文件中的RelativeLayout</span>&nbsp;&nbsp;</span></li>
<li><span><span class="keyword">for</span>(<span class="keyword">int</span>&nbsp;i&nbsp;=&nbsp;<span class="number">0</span>;&nbsp;i&nbsp;&lt;&nbsp;listView.getChildCount();&nbsp;i++){&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;View&nbsp;view&nbsp;=&nbsp;listView.getChildAt(i);&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CheckBox&nbsp;cb&nbsp;=&nbsp;(CheckBox)view.findViewById(R.id.CheckBoxID);&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb.setChecked(<span class="keyword">true</span>);&nbsp;&nbsp;</span></li>
<li><span>}&nbsp;&nbsp;</span></li></ol></div>

<p><span>如何让ListView中TextView的字体颜色跟随焦点的变化？&nbsp;</span><br>我们通常需要ListView中某一项选中时，他的字体颜色和原来的不一样。 如何设置字体的颜色呢？ 在布局文件中TextColor一项来设置颜色，但是不是只设置一种颜色，而是在不同的条件下设置不同的颜色： 下面是个例子：&nbsp;</p>
<div class="dp-highlighter"><br><div class="bar"><br><div class="tools">Xml代码&nbsp; &nbsp;<a href="http://gundumw100.iteye.com/blog/1169065" title="收藏这段代码" target="_blank" rel="noopener"><img src="http://gundumw100.iteye.com/images/icon_star.png" alt="收藏代码"></a></div>

<p></p></div><p></p>
<ol>
<li><span><span class="tag">&lt;?</span><span class="tag-name">xml</span>&nbsp;<span class="attribute">version</span>=<span class="attribute-value">“1.0”</span>&nbsp;<span class="attribute">encoding</span>=<span class="attribute-value">“utf-8”</span>&nbsp;<span class="tag">?&gt;</span>&nbsp;&nbsp;</span></li>
<li><span><span class="tag">&lt;</span><span class="tag-name">selector</span>&nbsp;<span class="attribute">xmlns:android</span>=<span class="attribute-value">“<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><span class="tag">&gt;</span>&nbsp;&nbsp;</span></li>
<li><span><span class="tag">&lt;</span><span class="tag-name">item</span>&nbsp;<span class="attribute">android:state_enabled</span>=<span class="attribute-value">“false”</span>&nbsp;<span class="attribute">android:color</span>=<span class="attribute-value">“@color/orange”</span><span class="tag">&gt;</span><span class="tag">&lt;/</span><span class="tag-name">item</span><span class="tag">&gt;</span>&nbsp;&nbsp;</span></li>
<li><span><span class="tag">&lt;</span><span class="tag-name">item</span>&nbsp;<span class="attribute">android:state_window_focused</span>=<span class="attribute-value">“false”</span>&nbsp;<span class="attribute">android:color</span>=<span class="attribute-value">“@color/orange”</span><span class="tag">&gt;</span><span class="tag">&lt;/</span><span class="tag-name">item</span><span class="tag">&gt;</span>&nbsp;&nbsp;</span></li>
<li><span><span class="tag">&lt;</span><span class="tag-name">item</span>&nbsp;<span class="attribute">android:state_pressed</span>=<span class="attribute-value">“true”</span>&nbsp;<span class="attribute">android:color</span>=<span class="attribute-value">“@color/white”</span><span class="tag">&gt;</span><span class="tag">&lt;/</span><span class="tag-name">item</span><span class="tag">&gt;</span>&nbsp;&nbsp;</span></li>
<li><span><span class="tag">&lt;</span><span class="tag-name">item</span>&nbsp;<span class="attribute">android:state_selected</span>=<span class="attribute-value">“true”</span>&nbsp;<span class="attribute">android:color</span>=<span class="attribute-value">“@color/white”</span><span class="tag">&gt;</span><span class="tag">&lt;/</span><span class="tag-name">item</span><span class="tag">&gt;</span>&nbsp;&nbsp;</span></li>
<li><span><span class="tag">&lt;</span><span class="tag-name">item</span>&nbsp;<span class="attribute">android:color</span>=<span class="attribute-value">“@color/orange”</span><span class="tag">&gt;</span><span class="tag">&lt;/</span><span class="tag-name">item</span><span class="tag">&gt;</span>&nbsp;&nbsp;</span></li>
<li><span><span class="tag">&lt;/</span><span class="tag-name">selector</span><span class="tag">&gt;</span>&nbsp;&nbsp;&nbsp;</span></li>
<li><span>在获取焦点或者选中的情况下设置为白色，其他情况设置为橘黄色。&nbsp;&nbsp;</span></li></ol></div>

<p><span>如何自定义ListView行间的分割线？</span>&nbsp;<br>所有基于ListView或者说AbsListView实现的widget控件均可以通过下面的方法设置行间距的分割线，分割线可以自定义颜色、或图片。&nbsp;<br>在ListView中我们使用属性android:divider=”#FF0000” 定义分隔符为红色，当然这里值可以指向一个drawable图片对象，如果使用了图片可能高度大于系统默认的像素，可以自己设置高度比如6个像素android:dividerHeight=”6px” ，当然在Java中ListView也有相关方法可以设置。&nbsp;</p>
<p><span>ListView不通过notifyDataSetChanged()更新指定的Item</span>&nbsp;<br>Listview一般大都是通过notifyDataSetChanged()來更新listview,但通过notifyDataSetChanged()会把界面上现实的的item都重绘一次，这样会影响ui性能。&nbsp;<br>可以通过更新指定的Item提高效率，伪代码如下：&nbsp;</p>
<div class="dp-highlighter"><br><div class="bar"><br><div class="tools">Java代码&nbsp; &nbsp;<a href="http://gundumw100.iteye.com/blog/1169065" title="收藏这段代码" target="_blank" rel="noopener"><img src="http://gundumw100.iteye.com/images/icon_star.png" alt="收藏代码"></a></div>

<p></p></div><p></p>
<ol>
<li><span><span class="keyword">private</span>&nbsp;<span class="keyword">void</span>&nbsp;updateView(<span class="keyword">int</span>&nbsp;itemIndex){&nbsp;&nbsp;&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;<span class="keyword">int</span>&nbsp;visiblePosition&nbsp;=&nbsp;yourListView.getFirstVisiblePosition();&nbsp;&nbsp;&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;View&nbsp;v&nbsp;=&nbsp;yourListView.getChildAt(itemIndex&nbsp;-&nbsp;visiblePosition);<span class="comment">//Do&nbsp;something&nbsp;fancy&nbsp;with&nbsp;your&nbsp;listitem&nbsp;view&nbsp;&nbsp;</span>&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;TextView&nbsp;tv&nbsp;=&nbsp;(TextView)v.findViewById(R.id.sometextview);&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;tv.setText(<span class="string">“Hi!&nbsp;I&nbsp;updated&nbsp;you&nbsp;manually”</span>);&nbsp;&nbsp;</span></li>
<li><span>}&nbsp;&nbsp;</span></li></ol></div>

<p><span>让ListView中长按某些Item时能弹出contextMenu，有些不能</span>&nbsp;<br>定义了一个listView，并为他设置了setOnCreateContextMenuListener的监听，但这样做只能使这个listView中的所有项在长按的时候弹出contextMenu 。&nbsp;<br>有时希望的是有些长按时能弹出contextMenu，有些不能。解决这个问题的办法是为这个listView设置setOnItemLongClickListener监听，然后实现&nbsp;</p>
<div class="dp-highlighter"><br><div class="bar"><br><div class="tools">Java代码&nbsp; &nbsp;<a href="http://gundumw100.iteye.com/blog/1169065" title="收藏这段代码" target="_blank" rel="noopener"><img src="http://gundumw100.iteye.com/images/icon_star.png" alt="收藏代码"></a></div>

<p></p></div><p></p>
<ol>
<li><span><span class="keyword">public</span>&nbsp;<span class="keyword">boolean</span>&nbsp;onItemLongClick(AdapterView&lt;?&gt;&nbsp;parent,&nbsp;View&nbsp;view,&nbsp;&nbsp;&nbsp;</span></li>
<li><span><span class="keyword">int</span>&nbsp;position,&nbsp;<span class="keyword">long</span>&nbsp;id)&nbsp;{&nbsp;&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;<span class="keyword">if</span>(id&nbsp;==&nbsp;<span class="number">1</span>){&nbsp;&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>&nbsp;<span class="keyword">true</span>;&nbsp;&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;</span></li>
<li><span>&nbsp;&nbsp;<span class="keyword">return</span>&nbsp;<span class="keyword">false</span>;&nbsp;&nbsp;&nbsp;</span></li>
<li><span>}&nbsp;&nbsp;&nbsp;</span></li></ol></div>

<p>如果这一项的id=1,就不能长按。 这样就可以了&nbsp;</p>
<p><span>ListView底部分隔线的问题</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在工作中遇到了一个难题，就是一个listView在最下面的一个item下面没有分割线，要求是必须得有这条分割线。经过一通研究发现了这个奇怪的现象：&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1. ListActivity有这条底部分割线。&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2.在Activity中只有listview，没有别的控件的话也会有。&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 其实ListActivity也是一个Activity，只不过在其中使用了SetContentView(listView)方法设置了一个listView作为其显示的View而已。所以结论就是只要这个activity调用了SetContentView(listView)就会有这条底部分割线。&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 那么什么情况下才不会有这条分割线呢？在Activity中如果调用setContentView(View)而ListView只是内嵌入到这个View的话有可能会没有这条分割线。&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 分析其原因：通过加断点调试发现在listView中，所有的分割线都是通过画一个很窄的矩形来实现的，但是在画分割线前都会都会判断目前的位置A和listView的长度B，如果A=B了，那么就不会画这条分割线了。但是将Listview嵌入到一个View中，一般会设置为高度为wrap_content,这种情况下，最后那条分割线的位置刚好等于listView的高度，所以系统不会画上这条分割线。那要怎么样才会画上呢？很简单，将ListView的高度设置为fill_partent就可以了。&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp; 当然以上所说的都是item很少的情况下，如果item很多以至于必须显示滚动条的话，那最后一个item下面是肯定不会有分割线了。<span>&lt;!–[endif]–&gt;&nbsp;&lt;!–[endif]–&gt;</span></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ListView </tag>
            
            <tag> view </tag>
            
            <tag> tips </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[设置EditText是否可编辑]]></title>
      <url>/2012/06/15/%E8%AE%BE%E7%BD%AEEditText%E6%98%AF%E5%90%A6%E5%8F%AF%E7%BC%96%E8%BE%91/</url>
      <content type="html"><![CDATA[<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">      设置EditText是否可编辑<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> com.tiantian<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> editText 要设置的EditText<br></span><span style="color: #008080;"> 5</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> value 可编辑:true 不可编辑:false<br></span><span style="color: #008080;"> 6</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> setEditTextEditable(EditText editText, <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> value){<br></span><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(value){<br></span><span style="color: #008080;"> 9</span>             editText.setFocusableInTouchMode(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">            editText.requestFocus();<br></span><span style="color: #008080;">11</span>         }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;">12</span>             editText.setFocusableInTouchMode(<span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">            editText.clearFocus();<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">15</span>     }</pre><br></div>]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[Android中Application设置全局变量以及传值]]></title>
      <url>/2012/06/14/Android%E4%B8%ADApplication%E8%AE%BE%E7%BD%AE%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E4%BB%A5%E5%8F%8A%E4%BC%A0%E5%80%BC/</url>
      <content type="html"><![CDATA[<p><span>Application设置全局变量以及传值&nbsp;</span></p>
<ol>
<li>/**</li>
<li><ul>
<li>重写Application，主要重写里面的onCreate方法，就是创建的时候，</li>
</ul>
</li>
<li><ul>
<li>我们让它初始化一些值，前段时间在javaeye里面看到过一个例子，与此相似，</li>
</ul>
</li>
<li><ul>
<li>我做了些改进。听说外国开发者习惯用此初始化一些全局变量，好像在Activity</li>
</ul>
</li>
<li><ul>
<li>一些类里面初始化全局变量的化，会遇到一些空指针的异常，当然，我没有遇到过。</li>
</ul>
</li>
<li><ul>
<li>如果用此方法初始化的话，那么就可以避免那些有可能出现的错误。</li>
</ul>
</li>
<li>*&nbsp;</li>
<li><ul>
<li>启动Application，他就会创建一个PID，就是进程ID，所有的Activity就会在此进程上运行。</li>
</ul>
</li>
<li><ul>
<li>那么我们在Application创建的时候初始化全局变量，那么是不是所有的Activity都可以拿到这些</li>
</ul>
</li>
<li><ul>
<li>全局变量，再进一步说，我们在某一个Activity中改变了这些全局变量的值，那么在别的Activity中</li>
</ul>
</li>
<li><ul>
<li>是不是值就改变了呢，这个算不算传值呢？</li>
</ul>
</li>
<li><ul>
<li>OK，那么下面的例子我们测试下。。。</li>
</ul>
</li>
<li><ul>
<li>@author yong.wang</li>
</ul>
</li>
<li>*</li>
<li>*/</li>
<li>public class MyApplication extends Application {<br>17.18.  &nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;private String name;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;@Override</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;public void onCreate() {</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; super.onCreate();</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; setName(NAME); //初始化全局变量</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;}<br>25.26.  &nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;public String getName() {</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; return name;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;}<br>29.30.  &nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;public void setName(String name) {</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; this.name = name;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;}</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;private static final String NAME = “MyApplication”;</li>
<li>}</li>
</ol>
<p><span>//Ok,应用程序创建好了，不过我们应该在配置文件ApplicationManifest.xml中将要运行的应用程序MyApplication加进去，修改下:</span></p>
<ol>
<li>&lt;?xml version=”1.0” encoding=”utf-8”?&gt;</li>
<li>&lt;manifest xmlns:android=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;package=”com.hisoft.app”</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;android:versionCode=”1”</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;android:versionName=”1.0”&gt;</li>
<li>&nbsp; &nbsp; &lt;application android:icon=”@drawable/icon” android:label=”@string/app_name”</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;android:name=”.MyApplication”&gt;&nbsp;&nbsp;就是这儿，将我们以前一直用的默认Application给他设置成我们自己做的MyApplication</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&lt;activity&nbsp;android:name=”.MyFirstActivity”</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;android:label=”@string/app_name”&gt;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&lt;intent-filter&gt;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; &lt;action android:name=”android.intent.action.MAIN” /&gt;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; &lt;category android:name=”android.intent.category.LAUNCHER” /&gt;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&lt;/intent-filter&gt;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&lt;/activity&gt;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&lt;activity android:name=”.MySecondActivity”&gt;&lt;/activity&gt;</li>
<li>&nbsp; &nbsp; &lt;/application&gt;</li>
<li>&nbsp; &nbsp; &lt;uses-sdk&nbsp;android:minSdkVersion=”8” /&gt;<br>18.19.  &lt;/manifest&gt;</li>
</ol>
<p><span>当xml配置文件运行完android:name=”.MyApplication”&gt;，在此那么就分配好了进程ID，再下面，我们就要运行我们的Activity了</span></p>
<ol>
<li>public class MyFirstActivity extends Activity {</li>
<li>&nbsp; &nbsp;&nbsp;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;private MyApplication app;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;</li>
<li>&nbsp; &nbsp; @Override</li>
<li>&nbsp; &nbsp; public void onCreate(Bundle savedInstanceState) {</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;super.onCreate(savedInstanceState);</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;setContentView(R.layout.main);</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;app = (MyApplication) getApplication(); //获得我们的应用程序MyApplication</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Log.e(“MyFirstActivityOriginal”, app.getName());&nbsp; &nbsp;//将我们放到进程中的全局变量拿出来，看是不是我们曾经设置的值</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;app.setName(“is cool”);&nbsp;&nbsp;//OK，现在我们开始修改了</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Log.e(“MyFirstActivityChanged”, app.getName()); //再看下，这个值改变了没有</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Intent&nbsp;intent = new Intent();&nbsp;&nbsp;//更重要的是我们可以看在别的Activity中是拿到初始化的值，还是修改后的</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;intent.setClass(this, MySecondActivity.class);</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;startActivity(intent);</li>
<li>&nbsp; &nbsp; }</li>
<li>}</li>
</ol>
<p><span>上面运行完了，就要跳到这个Activity了</span></p>
<ol>
<li>public class MySecondActivity extends Activity {<br>2.3.  &nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;private MyApplication app;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;@Override</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;protected void onCreate(Bundle savedInstanceState) {</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; super.onCreate(savedInstanceState);</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; setContentView(R.layout.main);</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; app = (MyApplication) getApplication();&nbsp;&nbsp;//获取应用程序</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; Log.e(“MySecondActivity”, app.getName()); //获取全局值</li>
<li>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;}&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;</li>
<li>}</li>
</ol>
<p><em>复制代码</em></p>
<p><span>OK，看下值：当然我已经运行过了，</span><br><span>MyFirstActivityOriginal&nbsp; &nbsp;&nbsp; &nbsp; MyApplication&nbsp;</span><br><span>MyFirstActivityChanged&nbsp; &nbsp;&nbsp;&nbsp;is cool</span><br><span>MySecondActivity&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; is cool</span><br><span>看看，是不是特别令人兴奋,当然有可能你退出之后再运行的时候，就第2、3。。。次，有可能会3个输出全是 is cool，那是你没杀掉进程的问题。</span></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> application </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android自定义属性，format详解]]></title>
      <url>/2012/06/06/Android%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B1%9E%E6%80%A7%EF%BC%8Cformat%E8%AF%A6%E8%A7%A3/</url>
      <content type="html"><![CDATA[<p><strong>1. reference：参考某一资源ID。</strong></p>
<p>&nbsp;&nbsp;&nbsp; （1）属性定义：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;declare-styleable name = “名称”&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “<span>background</span>“ format = “<span>reference</span>“ /&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/declare-styleable&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;（2）属性使用：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ImageView</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:layout_width = “42dip”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;android:layout_height = “42dip”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span>background</span>&nbsp;= “<span>@drawable/图片ID</span>“</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&gt;</p>
<p><strong>2. color：颜色值。</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;（1）属性定义：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;declare-styleable name = “名称”&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “<span>textColor</span>“ format = “<span>color</span>“ /&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/declare-styleable&gt;</p>
<p>&nbsp;&nbsp;&nbsp; （2）属性使用：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;TextView</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:layout_width = “42dip”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;android:layout_height = “42dip”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span><span>textColor</span></span>&nbsp;= “<span>#00FF00</span>“</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&gt;</p>
<p><strong>3. boolean：布尔值。</strong></p>
<p>&nbsp;&nbsp;&nbsp; （1）属性定义：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;declare-styleable name = “名称”&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “<span>focusable</span>“ format = “<span>boolean</span>“ /&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/declare-styleable&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;（2）属性使用：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;Button</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:layout_width = “42dip”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:layout_height = “42dip”</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span>focusable</span>&nbsp;= “<span>true</span>“</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&gt;</p>
<p><strong>4. dimension：尺寸值。</strong></p>
<p>&nbsp;&nbsp;&nbsp; （1）属性定义：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;declare-styleable name = “名称”&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “<span>layout_width</span>“ format = “<span>dimension</span>“ /&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/declare-styleable&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;（2）属性使用：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;Button</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span>layout_width</span>&nbsp;= “<span>42dip</span>“<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span>layout_height</span>&nbsp;= “<span>42dip</span>“</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&gt;</p>
<p><strong>5. float：浮点值。</strong></p>
<p>&nbsp;&nbsp;&nbsp; （1）属性定义：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;declare-styleable name = “AlphaAnimation”&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “<span>fromAlpha</span>“ format = “<span>float</span>“ /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “<span>toAlpha</span>“ format = “<span>float</span>“ /&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/declare-styleable&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;（2）属性使用：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;alpha<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span>fromAlpha</span>&nbsp;= “<span>1.0</span>“<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span>toAlpha</span>&nbsp;= “<span>0.7</span>“</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&gt;</p>
<p><strong>6. integer：整型值。</strong></p>
<p>&nbsp;&nbsp;&nbsp; （1）属性定义：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;declare-styleable name = “AnimatedRotateDrawable”&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “visible” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “<span>frameDuration</span>“ format=”<span>integer</span>“ /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “<span>framesCount</span>“ format=”<span>integer</span>“ /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “pivotX” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “pivotY” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “drawable” /&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/declare-styleable&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;（2）属性使用：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;animated-rotate</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xmlns:android = “<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:drawable = “@drawable/图片ID”&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; android:pivotX = “50%”&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:pivotY = “50%”&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span>framesCount</span>&nbsp;= “<span>12</span>“&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span>frameDuration</span>&nbsp;= “<span>100</span>“</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&gt;</p>
<p><strong>7. string：字符串。</strong></p>
<p>&nbsp;&nbsp;&nbsp; （1）属性定义：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;declare-styleable name = “MapView”&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “<span>apiKey</span>“ format = “<span>string</span>“ /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/declare-styleable&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;（2）属性使用：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;com.google.android.maps.MapView<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:layout_width = “fill_parent”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;android:layout_height = “fill_parent”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;android:<span>apiKey</span>&nbsp;= “<span>0jOkQ80oD1JL9C6HAja99uGXCRiS2CGjKO_bc_g</span>“</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&gt;</p>
<p><strong>8. fraction：百分数。</strong></p>
<p>&nbsp;&nbsp;&nbsp; （1）属性定义：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;declare-styleable name=”RotateDrawable”&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “visible” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “fromDegrees” format = “float” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “toDegrees” format = “float” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “<span>pivotX</span>“ format = “<span>fraction</span>“ /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “<span>pivotY</span>“ format = “<span>fraction</span>“ /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “drawable” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/declare-styleable&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;（2）属性使用：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;rotate</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xmlns:android = “<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“&nbsp;<br>　　&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:interpolator = “@anim/动画ID”</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:fromDegrees = “0”&nbsp;<br>　　&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:toDegrees = “360”</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span>pivotX</span>&nbsp;= “<span>200%</span>“</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span>pivotY</span>&nbsp;= “<span>300%</span>“&nbsp;<br>　　&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:duration = “5000”</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:repeatMode = “restart”</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;android:repeatCount = “infinite”</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&gt;</p>
<p><strong>9. enum：枚举值。</strong></p>
<p>&nbsp;&nbsp;&nbsp; （1）属性定义：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;declare-styleable name=”名称”&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name=”<span>orientation</span>“&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&lt;<span>enum&nbsp;</span>name=”<span>horizontal</span>“ value=”0” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span>enum</span>&nbsp;name=”<span>vertical</span>“ value=”1” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/attr&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/declare-styleable&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;（2）属性使用：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;LinearLayout</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xmlns:android = “<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span>orientation</span>&nbsp;= “<span>vertical</span>“<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:layout_width = “fill_parent”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:layout_height = “fill_parent”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/LinearLayout&gt;</p>
<p><strong>10. flag：位或运算。</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; （1）属性定义：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;declare-styleable name=”名称”&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name=”<span>windowSoftInputMode</span>“&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<span>flag&nbsp;</span>name = “<span>stateUnspecified</span>“ value = “0” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<span>flag</span>&nbsp;name = “<span>stateUnchanged</span>“ value = “1” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<span>flag&nbsp;</span>name = “<span>stateHidden</span>“ value = “2” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<span>flag</span>&nbsp;name =&nbsp;”<span>stateAlwaysHidden</span>“ value = “3” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<span>flag</span>&nbsp;name = “<span>stateVisible</span>“ value = “4” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<span>flag</span>&nbsp;name = “<span>stateAlwaysVisible</span>“ value = “5” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<span>flag&nbsp;</span>name = “<span>adjustUnspecified</span>“ value = “0x00” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<span>flag</span>&nbsp;name = “<span>adjustResize</span>“ value = “0x10” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<span>flag</span>&nbsp;name = “<span>adjustPan</span>“ value = “0x20” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;<span>flag</span>&nbsp;name = “<span>adjustNothing</span>“ value = “0x30” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/attr&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/declare-styleable&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; （2）属性使用：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;activity</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:name = “.StyleAndThemeActivity”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:label = “@string/app_name”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span>windowSoftInputMode&nbsp;</span>= “<span>stateUnspecified | stateUnchanged　|　stateHidden</span>“&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;intent-filter&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;action android:name = “android.intent.action.MAIN” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;category android:name = “android.intent.category.LAUNCHER” /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/intent-filter&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/activity&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>注意：</span></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;属性定义时可以指定多种类型值。</p>
<p>&nbsp;&nbsp;&nbsp; （1）属性定义：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;declare-styleable name = “名称”&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;attr name = “<span>background</span>“ format = “<span>reference|color</span>“ /&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/declare-styleable&gt;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;（2）属性使用：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;ImageView</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:layout_width = “42dip”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;android:layout_height = “42dip”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:<span>background</span>&nbsp;= “<span>@drawable/图片ID|#00FF00</span>“</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /&gt;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> attr </tag>
            
            <tag> attrubite </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[问题Re-installation failed due to different application signatures.解决]]></title>
      <url>/2012/05/28/%E9%97%AE%E9%A2%98Re-installation-failed-due-to-different-application-signatures-%E8%A7%A3%E5%86%B3/</url>
      <content type="html"><![CDATA[<p>进入SDK的<span>tools目录：</span></p>
<p><span><span>adb uninstall com.xxx.xxx(包名)</span></span></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> exception </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[android:ellipsize属性的含义]]></title>
      <url>/2012/05/22/android-ellipsize%E5%B1%9E%E6%80%A7%E7%9A%84%E5%90%AB%E4%B9%89/</url>
      <content type="html"><![CDATA[<p><span>TextView及其子类，当字符内容太长显示不下时可以省略号代替未显示的字符；省略号可以在显示区域的起始，中间，结束位置，或者以跑马灯的方式显示文字(textview的状态为被选中)。&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 其实现只需在xml中对textview的ellipsize属性做相应的设置即可。</span></p>
<p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:ellipsize=”start”&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 省略号在开头&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:ellipsize=”middle”&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 省略号在中间&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:ellipsize=”end”&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 省略号在结尾&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; android:ellipsize=”marquee”&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 跑马灯显示</span></p>
<p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 或者在程序中可通过setEillpsize显式设置。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 注: EditText不支持marquee这种模式。</span></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> view </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[android 异常：ScrollView can host only one direct child]]></title>
      <url>/2012/05/22/android-%E5%BC%82%E5%B8%B8%EF%BC%9AScrollView-can-host-only-one-direct-child/</url>
      <content type="html"><![CDATA[<p>android 采用ScrollView布局时出现异常：<span>ScrollView can host only one direct child</span>。</p>
<p>主要是<span>ScrollView内部只能有一个子元素，即不能并列两个子元素</span>，所以需要把所有的子元素放到一个LinearLayout内部或RelativeLayout等其他布局方式。</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> ScrollView </tag>
            
            <tag> exception </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[android真机调试时无法显示logcat信息的解决办法]]></title>
      <url>/2012/05/09/android%E7%9C%9F%E6%9C%BA%E8%B0%83%E8%AF%95%E6%97%B6%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BAlogcat%E4%BF%A1%E6%81%AF%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/</url>
      <content type="html"><![CDATA[<p><strong>android真机调试时无法显示logcat信息的解决办法：</strong></p>
<p><span>window–&gt;show view–&gt;android-&gt;devices，</span></p>
<p><span>打开devices，点击右边的截屏图片的按钮。等到出现截图的时候，logcat就出来信息了！</span></p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[Java中的强引用、软引用、弱引用和虚引用]]></title>
      <url>/2012/05/03/Java%E4%B8%AD%E7%9A%84%E5%BC%BA%E5%BC%95%E7%94%A8%E3%80%81%E8%BD%AF%E5%BC%95%E7%94%A8%E3%80%81%E5%BC%B1%E5%BC%95%E7%94%A8%E5%92%8C%E8%99%9A%E5%BC%95%E7%94%A8/</url>
      <content type="html"><![CDATA[<h2 id="Java中的强引用、软引用、弱引用和虚引用-nbsp"><a href="#Java中的强引用、软引用、弱引用和虚引用-nbsp" class="headerlink" title="Java中的强引用、软引用、弱引用和虚引用&nbsp;"></a>Java中的强引用、软引用、弱引用和虚引用&nbsp;</h2><div><span>原文链接</span><span>:</span><span><a href="http://aaronfu.net/?p=9995" target="_blank" rel="noopener">http://aaronfu.net/?p=9995</a></span></div>

<p>从JDK1.2版本开始，把对象的引用分为四种级别，从而使程序能更加灵活的控制对象的生命周期。这四种级别由高到低依次为：强引用、软引用、弱引用和虚引用。</p>
<p><strong>1．强引用</strong><br>本章前文介绍的引用实际上都是强引用，这是使用最普遍的引用。如果一个对象具有强引用，那就类似于必不可少的生活用品，垃圾回收器绝不会回收它。当内存空 间不足，Java虚拟机宁愿抛出OutOfMemoryError错误，使程序异常终止，也不会靠随意回收具有强引用的对象来解决内存不足问题。</p>
<p><strong>2．软引用（SoftReference）</strong></p>
<p>如果一个对象只具有软引用，那就类似于可有可物的生活用品。如果内存空间足够，垃圾回收器就不会回收它，如果内存空间不足了，就会回收这些对象的内存。只要垃圾回收器没有回收它，该对象就可以被程序使用。软引用可用来实现内存敏感的高速缓存。<br>软引用可以和一个引用队列（ReferenceQueue）联合使用，如果软引用所引用的对象被垃圾回收，Java虚拟机就会把这个软引用加入到与之关联的引用队列中。</p>
<p><strong>3．弱引用（WeakReference）</strong><br>如果一个对象只具有弱引用，那就类似于可有可物的生活用品。弱引用与软引用的区别在于：只具有弱引用的对象拥有更短暂的生命周期。在垃圾回收器线程扫描它 所管辖的内存区域的过程中，一旦发现了只具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存。不过，由于垃圾回收器是一个优先级很低的线程， 因此不一定会很快发现那些只具有弱引用的对象。<br>弱引用可以和一个引用队列（ReferenceQueue）联合使用，如果弱引用所引用的对象被垃圾回收，Java虚拟机就会把这个弱引用加入到与之关联的引用队列中。</p>
<p><strong>4．虚引用（PhantomReference）</strong><br>“虚引用”顾名思义，就是形同虚设，与其他几种引用都不同，虚引用并不会决定对象的生命周期。如果一个对象仅持有虚引用，那么它就和没有任何引用一样，在任何时候都可能被垃圾回收。<br>虚引用主要用来跟踪对象被垃圾回收的活动。虚引用与软引用和弱引用的一个区别在于：虚引用必须和引用队列（ReferenceQueue）联合使用。当垃 圾回收器准备回收一个对象时，如果发现它还有虚引用，就会在回收对象的内存之前，把这个虚引用加入到与之关联的引用队列中。程序可以通过判断引用队列中是 否已经加入了虚引用，来了解</p>
<p>被引用的对象是否将要被垃圾回收。程序如果发现某个虚引用已经被加入到引用队列，那么就可以在所引用的对象的内存被回收之前采取必要的行动。</p>
<p>在本书中，”引用”既可以作为动词，也可以作为名词，读者应该根据上下文来区分”引用”的含义。</p>
<p>在java.lang.ref包中提供了三个类：SoftReference类、WeakReference类和PhantomReference类，它 们分别代表软引用、弱引用和虚引用。ReferenceQueue类表示引用队列，它可以和这三种引用类联合使用，以便跟踪Java虚拟机回收所引用的对 象的活动。以下程序创建了一个String对象、ReferenceQueue对象和WeakReference对象：</p>
<p>//创建一个强引用<br>String str = new String(“hello”);</p>
<p>//创建引用队列, &lt;String&gt;为范型标记，表明队列中存放String对象的引用<br>ReferenceQueue&lt;String&gt; rq = new ReferenceQueue&lt;String&gt;();</p>
<p>//创建一个弱引用，它引用”hello”对象，并且与rq引用队列关联<br>//&lt;String&gt;为范型标记，表明WeakReference会弱引用String对象<br>WeakReference&lt;String&gt; wf = new WeakReference&lt;String&gt;(str, rq);</p>
<p>以上程序代码执行完毕，内存中引用与对象的关系如图11-10所示。</p>
<p><img src="http://www.javathinker.org/java/ref_1.gif" alt=""></p>
<p>图11-10 “hello”对象同时具有强引用和弱引用</p>
<p>在图11-10中，带实线的箭头表示强引用，带虚线的箭头表示弱引用。从图中可以看出，此时”hello”对象被str强引用，并且被一个WeakReference对象弱引用，因此”hello”对象不会被垃圾回收。<br>在以下程序代码中，把引用”hello”对象的str变量置为null，然后再通过WeakReference弱引用的get()方法获得”hello”对象的引用：</p>
<p>String str = new String(“hello”); //①<br>ReferenceQueue&lt;String&gt; rq = new ReferenceQueue&lt;String&gt;(); //②<br>WeakReference&lt;String&gt; wf = new WeakReference&lt;String&gt;(str, rq); //③</p>
<p>str=null; //④取消”hello”对象的强引用<br>String str1=wf.get(); //⑤假如”hello”对象没有被回收，str1引用”hello”对象</p>
<p>//假如”hello”对象没有被回收，rq.poll()返回null<br>Reference&lt;? extends String&gt; ref=rq.poll(); //⑥</p>
<p>执行完以上第④行后，内存中引用与对象的关系如图11-11所示，此 时”hello”对象仅仅具有弱引用，因此它有可能被垃圾回收。假如它还没有被垃圾回收，那么接下来在第⑤行执行wf.get()方法会返 回”hello”对象的引用，并且使得这个对象被str1强引用。再接下来在第⑥行执行rq.poll()方法会返回null，因为此时引用队列中没有任 何引用。ReferenceQueue的poll()方法用于返回队列中的引用，如果没有则返回null。</p>
<p><img src="http://www.javathinker.org/java/ref_2.gif" alt=""><br>图11-11 “hello”对象只具有弱引用</p>
<p>在以下程序代码中，执行完第④行后，”hello”对象仅仅具有弱引用。接下来两次调用System.gc()方法，催促垃圾回收器工作，从而提 高”hello”对象被回收的可能性。假如”hello”对象被回收，那么WeakReference对象的引用被加入到ReferenceQueue 中，接下来wf.get()方法返回null，并且rq.poll()方法返回WeakReference对象的引用。图11-12显示了执行完第⑧行后 内存中引用与对象的关系。</p>
<p>String str = new String(“hello”); //①<br>ReferenceQueue&lt;String&gt; rq = new ReferenceQueue&lt;String&gt;(); //②<br>WeakReference&lt;String&gt; wf = new WeakReference&lt;String&gt;(str, rq); //③<br>str=null; //④</p>
<p>//两次催促垃圾回收器工作，提高”hello”对象被回收的可能性<br>System.gc(); //⑤<br>System.gc(); //⑥<br>String str1=wf.get(); //⑦ 假如”hello”对象被回收，str1为null<br>Reference&lt;? extends String&gt; ref=rq.poll(); //⑧</p>
<p><img src="http://www.javathinker.org/java/ref_3.gif" alt=""><br>图11-12 “hello”对象被垃圾回收，弱引用被加入到引用队列</p>
<p>The important part about strong references &mdash; the part that makes them “strong” &mdash; is how they interact with the garbage collector. Specifically, if an object is reachable via a chain of strong references (strongly reachable), it is not eligible for garbage collection. As you don&rsquo;t want the garbage collector destroying objects you&rsquo;re working on, this is normally exactly what you want.</p>
]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
            <tag> reference </tag>
            
            <tag> StrongReference </tag>
            
            <tag> SoftReference </tag>
            
            <tag> WeakReference </tag>
            
            <tag> PhantomReference </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Java集合框架List，Map，Set等全面介绍]]></title>
      <url>/2012/04/18/Java%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6List%EF%BC%8CMap%EF%BC%8CSet%E7%AD%89%E5%85%A8%E9%9D%A2%E4%BB%8B%E7%BB%8D/</url>
      <content type="html"><![CDATA[<div>Java Collections Framework是Java提供的对集合进行定义，操作，和管理的包含一组接口，类的体系结构。</div><br><div>&nbsp;</div><br><div>Java集合框架的基本接口/类层次结构：</div><br><div><br>java.util.Collection [I]<br>+–java.util.List [I]<br>&nbsp;&nbsp; +–java.util.ArrayList [C]<br>&nbsp;&nbsp; +–java.util.LinkedList [C]<br>&nbsp;&nbsp; +–java.util.Vector [C]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +–java.util.Stack [C]<br>+–java.util.Set [I]<br>&nbsp;&nbsp; +–java.util.HashSet [C]<br>&nbsp;&nbsp; +–java.util.SortedSet [I]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +–java.util.TreeSet [C]</div><br><div><br>java.util.Map [I]<br>+–java.util.SortedMap [I]<br>&nbsp;&nbsp; +–java.util.TreeMap [C]<br>+–java.util.Hashtable [C]<br>+–java.util.HashMap [C]<br>+–java.util.LinkedHashMap [C]<br>+–java.util.WeakHashMap [C]</div><br><div>&nbsp;</div><br><div>[I]：接口</div><br><div>[C]：类</div><br><div>&nbsp;</div><br><div><span><strong>Collection接口</strong></span><br>&nbsp;&nbsp; &nbsp;Collection是最基本的集合接口，一个Collection代表一组Object的集合，这些Object被称作Collection的元素。</div><br><div>&nbsp;&nbsp; &nbsp;所有实现Collection接口的类都必须提供两个标准的构造函数：无参数的构造函数用于创建一个空的Collection，有一个Collection参数的构造函数用于创建一个新的Collection，这 个新的Collection与传入的Collection有相同的元素。后一个构造函数允许用户复制一个Collection。<br><div>&nbsp;&nbsp; &nbsp;如何遍历Collection中的每一个元素？不论Collection的实际类型如何，它都支持一个iterator()的方法，该方法返回一个迭代子，使用该迭代子即可逐一访问Collection中每一个元素。典型的用法如下：</div>

<ol>
<li><span><span>Iterator&nbsp;it&nbsp;=&nbsp;collection.iterator();&nbsp;</span><span class="comment">//&nbsp;获得一个迭代子</span><span>&nbsp;</span></span></li>
<li><span><span class="keyword">while</span><span>(it.hasNext())&nbsp;{&nbsp;</span></span></li>
<li><span>　　Object&nbsp;obj&nbsp;=&nbsp;it.next();&nbsp;<span class="comment">//&nbsp;得到下一个元素</span><span>&nbsp;</span></span></li>
<li><p><span>}&nbsp;</span></p>
<div>&nbsp;&nbsp; &nbsp;根据用途的不同，Collection又划分为List与Set。</div><br><div>&nbsp;</div><br><div><span><strong>List接口</strong></span></div><br><div>&nbsp;&nbsp; &nbsp;List继承自Collection接口。List是有序的Collection，使用此接口能够精确的控制每个元素插入的位置。用户能够使用索引（元素在List中的位置，类似于数组下标）来访问List中的元素，这类似于Java的数组。</div><br><div>&nbsp;&nbsp; &nbsp;跟Set集合不同的是，List允许有重复元素。对于满足e1.equals(e2)条件的e1与e2对象元素，可以同时存在于List集合中。当然，也有List的实现类不允许重复元素的存在。</div><br><div>&nbsp;&nbsp; &nbsp;除了具有Collection接口必备的iterator()方法外，List还提供一个listIterator()方法，返回一个 ListIterator接口，和标准的Iterator接口相比，ListIterator多了一些add()之类的方法，允许添加，删除，设定元素， 还能向前或向后遍历。</div><br><div>&nbsp;&nbsp; &nbsp;实现List接口的常用类有LinkedList，ArrayList，Vector和Stack。</div><br><div>&nbsp;</div><br><div><span><strong>LinkedList类</strong></span></div><br><div>&nbsp;&nbsp; &nbsp;LinkedList实现了List接口，允许null元素。此外LinkedList提供额外的get，remove，insert方法在 LinkedList的首部或尾部。这些操作使LinkedList可被用作堆栈（stack），队列（queue）或双向队列（deque）。</div><br><div>&nbsp;&nbsp; &nbsp;注意LinkedList没有同步方法。如果多个线程同时访问一个List，则必须自己实现访问同步。一种解决方法是在创建List时构造一个同步的List：</div>
</li>
<li><p><span><span>List&nbsp;list&nbsp;=&nbsp;Collections.synchronizedList(</span><span class="keyword">new</span><span>&nbsp;LinkedList(…));&nbsp;</span></span></p>
<div>&nbsp;</div><br><div><span><strong>ArrayList类</strong></span></div><br><div>&nbsp;&nbsp; &nbsp;ArrayList实现了可变大小的数组。它允许所有元素，包括null。ArrayList没有同步。</div><br><div>size，isEmpty，get，set方法运行时间为常数。但是add方法开销为分摊的常数，添加n个元素需要O(n)的时间。其他的方法运行时间为线性。</div><br><div>&nbsp;&nbsp; &nbsp;每个ArrayList实例都有一个容量（Capacity），即用于存储元素的数组的大小。这个容量可随着不断添加新元素而自动增加，但是增长算法并 没有定义。当需要插入大量元素时，在插入前可以调用ensureCapacity方法来增加ArrayList的容量以提高插入效率。</div><br><div>&nbsp;&nbsp; &nbsp;和LinkedList一样，ArrayList也是非同步的（unsynchronized）。</div><br><div>&nbsp;</div><br><div><span><strong>Vector类</strong></span></div><br><div>&nbsp;&nbsp; &nbsp;Vector非常类似ArrayList，但是Vector是同步的。由Vector创建的Iterator，虽然和ArrayList创建的 Iterator是同一接口，但是，因为Vector是同步的，当一个Iterator被创建而且正在被使用，另一个线程改变了Vector的状态（例如，添加或删除了一些元素），这时调用Iterator的方法时将抛出ConcurrentModificationException，因此必须捕获该异常。</div><br><div>&nbsp;</div><br><div><span><strong>Stack 类</strong></span></div><br><div>&nbsp;&nbsp; &nbsp;Stack继承自Vector，实现一个后进先出的堆栈。Stack提供5个额外的方法使得Vector得以被当作堆栈使用。基本的push和pop方 法，还有peek方法得到栈顶的元素，empty方法测试堆栈是否为空，search方法检测一个元素在堆栈中的位置。Stack刚创建后是空栈。</div><br><div>&nbsp;</div><br><div><span><strong>Set接口</strong></span></div><br><div>&nbsp;&nbsp; &nbsp;Set继承自Collection接口。Set是一种不能包含有重复元素的集合，即对于满足e1.equals(e2)条件的e1与e2对象元素，不能同时存在于同一个Set集合里，换句话说，Set集合里任意两个元素e1和e2都满足e1.equals(e2)==false条件，Set最多有一个null元素。</div><br><div>&nbsp;&nbsp; &nbsp; 因为Set的这个制约，在使用Set集合的时候，应该注意：</div><br><div>&nbsp;&nbsp; &nbsp;1，为Set集合里的元素的实现类实现一个有效的equals(Object)方法。</div><br><div>&nbsp;&nbsp; &nbsp;2，对Set的构造函数，传入的Collection参数不能包含重复的元素。</div><br><div>&nbsp;</div><br><div>&nbsp;&nbsp; &nbsp;请注意：必须小心操作可变对象（Mutable Object）。如果一个Set中的可变元素改变了自身状态导致Object.equals(Object)=true将导致一些问题。</div><br><div>&nbsp;</div><br><div><span><strong>HashSet类</strong></span></div><br><div>&nbsp;&nbsp;&nbsp; 此类实现 Set 接口，由哈希表（实际上是一个 HashMap 实例）支持。它不保证集合的迭代顺序；特别是它不保证该顺序恒久不变。此类允许使用 null 元素。</div><br><div>&nbsp;&nbsp;&nbsp; HashSet不是同步的，需要用以下语句来进行S同步转换：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;Set s = Collections.synchronizedSet(new HashSet(…));<br>&nbsp;</div><br><div><span><strong>Map接口</strong></span></div><br><div>&nbsp;&nbsp; &nbsp;Map没有继承Collection接口。也就是说Map和Collection是2种不同的集合。Collection可以看作是（value）的集合，而Map可以看作是（key，value）的集合。</div><br><div>&nbsp;&nbsp; &nbsp;Map接口由Map的内容提供3种类型的集合视图，一组key集合，一组value集合，或者一组key-value映射关系的集合。</div><br><div>&nbsp;</div><br><div><span><strong>Hashtable类</strong></span></div><br><div>&nbsp;&nbsp; &nbsp;Hashtable继承Map接口，实现一个key-value映射的哈希表。任何非空（non-null）的对象都可作为key或者value。</div><br><div>&nbsp;&nbsp; &nbsp;添加数据使用put(key, value)，取出数据使用get(key)，这两个基本操作的时间开销为常数。</div><br><div>Hashtable 通过initial capacity和load factor两个参数调整性能。通常缺省的load factor 0.75较好地实现了时间和空间的均衡。增大load factor可以节省空间但相应的查找时间将增大，这会影响像get和put这样的操作。</div><br><div>使用Hashtable的简单示例如下，将1，2，3放到Hashtable中，他们的key分别是&rdquo;one&rdquo;，&rdquo;two&rdquo;，&rdquo;three&rdquo;：</div>
</li>
<li><p><span><span>Hashtable&nbsp;numbers&nbsp;=&nbsp;</span><span class="keyword">new</span><span>&nbsp;Hashtable();&nbsp;</span></span></p>
</li>
<li><span>numbers.put(“one”,&nbsp;<span class="keyword">new</span><span>&nbsp;Integer(</span><span class="number">1</span><span>));&nbsp;</span></span></li>
<li><span>numbers.put(“two”,&nbsp;<span class="keyword">new</span><span>&nbsp;Integer(</span><span class="number">2</span><span>));&nbsp;</span></span></li>
<li><p><span>numbers.put(“three”,&nbsp;<span class="keyword">new</span><span>&nbsp;Integer(</span><span class="number">3</span><span>));&nbsp;</span></span></p>
<div>要取出一个数，比如2，用相应的key：</div>
</li>
<li><p><span><span>Integer&nbsp;n&nbsp;=&nbsp;(Integer)numbers.get(</span><span class="string">“two”</span><span>);&nbsp;</span></span></p>
</li>
<li><span>System.out.println(<span class="string">“two&nbsp;=”</span><span>&nbsp;+&nbsp;n);&nbsp;</span></span></li></ol></div><div>&nbsp;&nbsp; &nbsp;由于作为key的对象将通过计算其散列函数来确定与之对应的value的位置，因此任何作为key的对象都必须实现hashCode和equals方 法。hashCode和equals方法继承自根类Object，如果你用自定义的类当作key的话，要相当小心，按照散列函数的定义，如果两个对象相 同，即obj1.equals(obj2)=true，则它们的hashCode必须相同，但如果两个对象不同，则它们的hashCode不一定不同，如 果两个不同对象的hashCode相同，这种现象称为冲突，冲突会导致操作哈希表的时间开销增大，所以尽量定义好的hashCode()方法，能加快哈希 表的操作。</div><br><div>&nbsp;&nbsp; &nbsp;如果相同的对象有不同的hashCode，对哈希表的操作会出现意想不到的结果（期待的get方法返回null），要避免这种问题，只需要牢记一条：要同时复写equals方法和hashCode方法，而不要只写其中一个。</div><br><div>&nbsp;&nbsp; &nbsp;Hashtable是同步的。</div><br><div>&nbsp;</div><br><div><span><strong>HashMap类</strong></span></div><br><div>&nbsp;&nbsp; &nbsp;HashMap和Hashtable类似，不同之处在于HashMap是非同步的，并且允许null，即null value和null key。，但是将HashMap视为Collection时（values()方法可返回Collection），其迭代子操作时间开销和HashMap 的容量成比例。因此，如果迭代操作的性能相当重要的话，不要将HashMap的初始化容量设得过高，或者load factor过低。</div><br><div>&nbsp;</div><br><div><span><strong>WeakHashMap类</strong></span></div><br><div>&nbsp;&nbsp; &nbsp;WeakHashMap是一种改进的HashMap，它对key实行&ldquo;弱引用&rdquo;，如果一个key不再被外部所引用，那么该key可以被GC回收。</div><br><div>&nbsp;</div><br><div><span><strong>对集合操作的工具类</strong></span></div><br><div>&nbsp;&nbsp; &nbsp;Java提供了java.util.Collections，以及java.util.Arrays类简化对集合的操作<br><div>&nbsp;&nbsp; &nbsp;java.util.Collections主要提供一些static方法用来操作或创建Collection，Map等集合。</div><br>&nbsp;&nbsp; &nbsp;java.util.Arrays主要提供static方法对数组进行操作。。</div><br><div>&nbsp;</div><br><div><span><strong>总结</strong></span></div><br><div>&nbsp;&nbsp; &nbsp;如果涉及到堆栈，队列等操作，应该考虑用List，对于需要快速插入，删除元素，应该使用LinkedList，如果需要快速随机访问元素，应该使用ArrayList。</div><br><div>&nbsp;&nbsp; &nbsp;如果程序在单线程环境中，或者访问仅仅在一个线程中进行，考虑非同步的类，其效率较高，如果多个线程可能同时操作一个类，应该使用同步的类。</div><br><div>&nbsp;&nbsp; &nbsp;在除需要排序时使用TreeSet,TreeMap外,都应使用HashSet,HashMap,因为他们 的效率更高。</div><br><div>&nbsp;&nbsp; &nbsp;要特别注意对哈希表的操作，作为key的对象要正确复写equals和hashCode方法。</div><br><div>&nbsp;</div><br><div>&nbsp;&nbsp; &nbsp;容器类仅能持有对象引用（指向对象的指针），而不是将对象信息copy一份至数列某位置。一旦将对象置入容器内，便损失了该对象的型别信息。</div><br><div>&nbsp;&nbsp; &nbsp;尽量返回接口而非实际的类型，如返回List而非ArrayList，这样如果以后需要将ArrayList换成LinkedList时，客户端代码不用改变。这就是针对抽象编程。</div><br><div>&nbsp;</div><br><div><strong><span>注意：</span></strong></div><br><div>1、Collection没有get()方法来取得某个元素。只能通过iterator()遍历元素。</div><br><div>2、Set和Collection拥有一模一样的接口。</div><br><div>3、List，可以通过get()方法来一次取出一个元素。使用数字来选择一堆对象中的一个，get(0)…。(add/get)</div><br><div>4、一般使用ArrayList。用LinkedList构造堆栈stack、队列queue。</div><br><div>5、Map用 put(k,v) / get(k)，还可以使用containsKey()/containsValue()来检查其中是否含有某个key/value。</div><br><div>&nbsp;&nbsp; &nbsp; &nbsp;HashMap会利用对象的hashCode来快速找到key。</div><br><div>&nbsp;</div><br><div><br><div>6、Map中元素，可以将key序列、value序列单独抽取出来。</div><br><div>使用keySet()抽取key序列，将map中的所有keys生成一个Set。</div><br><div>使用values()抽取value序列，将map中的所有values生成一个Collection。</div><br><div>为什么一个生成Set，一个生成Collection？那是因为，key总是独一无二的，value允许重复。</div><br><div>&nbsp;</div><br><div>————————</div><br><div>本文结合了几篇网上文章并摘录而成的：</div><br><div>1.&nbsp;<a href="http://jonsion.javaeye.com/blog/421993" target="_blank" rel="noopener">Java Collections Framework - Java集合框架List,Map,Set等全面介绍</a></div><br><div>2.&nbsp;<a href="http://blog.csdn.net/Fitzwilliam/archive/2006/02/10/596384.aspx" target="_blank" rel="noopener">细说Java之util类</a></div><br><div>3.&nbsp;<a href="http://billy-lee.javaeye.com/blog/356398" target="_blank" rel="noopener">Java基本概念：集合类 List/Set/Map… 的区别和联系</a></div><br></div>



]]></content>
      
        
        <tags>
            
            <tag> java </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[android屏蔽返回键和home键]]></title>
      <url>/2012/03/08/android%E5%B1%8F%E8%94%BD%E8%BF%94%E5%9B%9E%E9%94%AE%E5%92%8Chome%E9%94%AE/</url>
      <content type="html"><![CDATA[<div class="dp-highlighter"><br><br>1.  屏蔽返回键的代码:<br>public boolean onKeyDown(int keyCode,KeyEvent event){<br>switch(keyCode){<br>case KeyEvent.KEYCODE_HOME:return true;<br>case KeyEvent.KEYCODE_BACK:return true;<br>case KeyEvent.KEYCODE_CALL:return true;<br>case KeyEvent.KEYCODE_SYM: return true;<br>case KeyEvent.KEYCODE_VOLUME_DOWN: return true;<br>case KeyEvent.KEYCODE_VOLUME_UP: return true;<br>case KeyEvent.KEYCODE_STAR: return true;<br>}<br>return super.onKeyDown(keyCode, event);<br>}<br><br>屏蔽home键的代码:<br>public void onAttachedToWindow() {<br>this.getWindow().setType(WindowManager.LayoutParams.TYPE_KEYGUARD);<br>super.onAttachedToWindow();<br>}</div>

]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> key </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android的单位及屏幕分辨率]]></title>
      <url>/2012/03/08/Android%E7%9A%84%E5%8D%95%E4%BD%8D%E5%8F%8A%E5%B1%8F%E5%B9%95%E5%88%86%E8%BE%A8%E7%8E%87/</url>
      <content type="html"><![CDATA[<p>一、常用的单位：相对单位主要有：px、sp、dp</p>
<p>绝对单位主要有：pt、in、mm</p>
<p>二、单位应用总结：一般用相对单位，而不是绝对单位</p>
<p>1、字体的大小一般使用SP，用此单位的字体能够根据用户设置字体的大小而自动缩放</p>
<p>2、空间等相对距离一般使用dp（dip）,随着密度变化，对应的像素数量也变化，但并没有直接的相对比例的变化。</p>
<p>3、px与实际像素有关，及与密度有关！dp和sp和实际像素没有关系，对于一定分辨率但不同密度的屏幕，px单位的应用可能会导致长度的相对比例的变化。</p>
<p>三、密度与分辨率：</p>
<p>密度值表示每英寸有多少个显示点，与分辨率是两个概念。</p>
<p>其屏幕密度标准是：HVGA屏density=160；QVGA屏density=120；WVGA屏density=240；WQVGA屏density=120</p>
<p>具体的应用运算关系：假设分辨率是 x<em>y， 密度为 d， 屏幕实际大小为 a</em>b那么关系为 x<em>y = d </em> a * b (约等于)</p>
<p>不同density下屏幕分辨率信息，以480dip<em>800dip的 WVGA(density=240)为例density=120时 屏幕实际分辨率为240px</em>400px （两个点对应一个分辨率）</p>
<p>四、对比总结：</p>
<p>1、在相同密度（即同一实体屏幕）不同分辨率的情况下，与实体密度无关的相对单位sp和dp显示正常</p>
<p>2、在相同分辨率不同密度的情况下，因为一般情况下，都用的标准密度，所以分析的意义不是很大</p>
<p><strong>其他资料：</strong><br>px：是屏幕的像素点<br>in：英寸<br>mm：毫米<br>pt：磅，1/72 英寸<br>dp：一个基于density的抽象单位，如果一个160dpi的屏幕，1dp=1px<br>dip：等同于dp<br>sp：同dp相似，但还会根据用户的字体大小偏好来缩放。<br>建议使用sp作为文本的单位，其它用dip<br>针对dip和px 的关系，做以下概述：<br>HVGA屏density=160；QVGA屏density=120；WVGA屏density=240；WQVGA屏density=120<br>density值表示每英寸有多少个显示点，与分辨率是两个概念。<br>不同density下屏幕分辨率信息，以480dip*800dip的 WVGA(density=240)为例</p>
<p>density=120时 屏幕实际分辨率为240px*400px （两个点对应一个分辨率）<br>状态栏和标题栏高各19px或者25dip<br>横屏是屏幕宽度400px 或者800dip,工作区域高度211px或者480dip<br>竖屏时屏幕宽度240px或者480dip,工作区域高度381px或者775dip</p>
<p>density=160时 屏幕实际分辨率为320px*533px （3个点对应两个分辨率）<br>状态栏和标题栏高个25px或者25dip<br>横屏是屏幕宽度533px 或者800dip,工作区域高度295px或者480dip<br>竖屏时屏幕宽度320px或者480dip,工作区域高度508px或者775dip</p>
<p>density=240时 屏幕实际分辨率为480px*800px （一个点对于一个分辨率）<br>状态栏和标题栏高个38px或者25dip<br>横屏是屏幕宽度800px 或者800dip,工作区域高度442px或者480dip<br>竖屏时屏幕宽度480px或者480dip,工作区域高度762px或者775dip</p>
<p>apk的资源包中，当屏幕density=240时使用hdpi 标签的资源<br>当屏幕density=160时，使用mdpi标签的资源<br>当屏幕density=120时，使用ldpi标签的资源。<br>不加任何标签的资源是各种分辨率情况下共用的。<br>布局时尽量使用单位dip，少使用px</p>
<p>&nbsp;</p>
<p>下面是几种不同单位的相互转换.</p>
<p>public&nbsp;static&nbsp;int&nbsp;dip2px(Context context, float dipValue){<br>final float scale&nbsp;=&nbsp;context.getResources().getDisplayMetrics().density;<br>return (int)(dipValue&nbsp;<em>&nbsp;scale&nbsp;+&nbsp;0.5f);<br>}<br>public&nbsp;static&nbsp;int&nbsp;px2dip(Context context, float pxValue){<br>final float scale&nbsp;=&nbsp;context.getResource().getDisplayMetrics().density;<br>return (int)(pxValue&nbsp;/&nbsp;scale&nbsp;+&nbsp;0.5f);<br>}<br>public&nbsp;static&nbsp;int&nbsp;dip2px(Context context, float dipValue){<br>final float scale&nbsp;=&nbsp;context.getResources().getDisplayMetrics().density;<br>return (int)(dipValue&nbsp;</em>&nbsp;scale&nbsp;+&nbsp;0.5f);<br>}<br>public&nbsp;static&nbsp;int&nbsp;px2dip(Context context, float pxValue){<br>final float scale&nbsp;=&nbsp;context.getResource().getDisplayMetrics().density;<br>return (int)(pxValue&nbsp;/&nbsp;scale&nbsp;+&nbsp;0.5f);<br>}</p>
<p>下面说下如何获取分辨率:</p>
<p>在一个Activity的onCreate方法中，写入如下代码：<br>DisplayMetrics metric = new DisplayMetrics();<br>getWindowManager().getDefaultDisplay().getMetrics(metric);<br>int width = metric.widthPixels;&nbsp;&nbsp;// 屏幕宽度（像素）<br>int height = metric.heightPixels;&nbsp;&nbsp;// 屏幕高度（像素）<br>float density&nbsp;= metric.density;&nbsp;&nbsp;// 屏幕密度（0.75 / 1.0 / 1.5）<br>int densityDpi = metric.densityDpi;&nbsp;&nbsp;// 屏幕密度DPI（120 / 160 / 240）<br>这还是挺简单的, 可是你有没有在800*480的机器上试过, 是不是得到的宽度是533 ? 因为android刚开始时默认的density是1.0 , 此时你可以再manifest.xml中加入</p>
<p>1.uses-sdk节点,&nbsp;&lt;uses-sdk android:minSdkVersion=”4” /&gt; , 表示不sdk1.6以下的机器不能安装你的apk了.</p>
<p>2.supports-screens 节点.</p>
<p>&lt;supports-screens<br>android:smallScreens=”true”<br>android:normalScreens=”true”<br>android:largeScreens=”true”<br>android:resizeable=”true”<br>android:anyDensity=”true” /&gt;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> tips </tag>
            
            <tag> UI </tag>
            
            <tag> unit </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android读取用户号码，手机串号，SIM卡序列号]]></title>
      <url>/2012/03/08/Android%E8%AF%BB%E5%8F%96%E7%94%A8%E6%88%B7%E5%8F%B7%E7%A0%81%EF%BC%8C%E6%89%8B%E6%9C%BA%E4%B8%B2%E5%8F%B7%EF%BC%8CSIM%E5%8D%A1%E5%BA%8F%E5%88%97%E5%8F%B7/</url>
      <content type="html"><![CDATA[<p>1、使用TelephonyManager提供的方法，核心代码:</p>
<p>TelephonyManager tm = (TelephonyManager) this.getSystemService(TELEPHONY_SERVICE);<br>String imei = tm.getDeviceId();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //取出IMEI<br>Log.d(TAG, “IMEI:”+imei);<br>String tel = tm.getLine1Number();&nbsp;&nbsp;&nbsp;&nbsp; //取出MSISDN，很可能为空<br>Log.d(TAG, “MSISDN:”+tel);<br>String iccid =tm.getSimSerialNumber();&nbsp; //取出ICCID<br>Log.d(TAG, “ICCID:”+iccid);<br>String imsi =tm.getSubscriberId();&nbsp;&nbsp;&nbsp;&nbsp; //取出IMSI<br>Log.d(TAG, “IMSI:”+imsi);</p>
<p>2、加入权限</p>
<p>在manifest.xml文件中要添加 &lt;uses-permission android:name=”android.permission.READ_PHONE_STATE” /&gt;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> phone number </tag>
            
            <tag> SIM </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android退出程序的若干方法]]></title>
      <url>/2012/03/08/Android%E9%80%80%E5%87%BA%E7%A8%8B%E5%BA%8F%E7%9A%84%E8%8B%A5%E5%B9%B2%E6%96%B9%E6%B3%95/</url>
      <content type="html"><![CDATA[<p>Android程序有很多Activity，比如说主窗口A，调用了子窗口B，如果在B中直接finish(), 接下里显示的是A。在B中如何关闭整个Android应用程序呢?本人总结了几种比较简单的实现方法。</p>
<p>1. Dalvik VM的本地方法</p>
<p>android.os.Process.killProcess(android.os.Process.myPid()) //获取PID</p>
<p>System.exit(0); //常规java、c#的标准退出法，返回值为0代表正常退出</p>
<p>2. 任务管理器方法</p>
<p>首先要说明该方法运行在Android 1.5 API Level为3以上才可以，同时需要权限</p>
<p>ActivityManager am = (ActivityManager)getSystemService (Context.ACTIVITY_SERVICE);</p>
<p>am.restartPackage(getPackageName());</p>
<p>系统会将，该包下的 ，所有进程，服务，全部杀掉，就可以杀干净了，要注意加上权限 android.permission.RESTART_PACKAGES</p>
<p>3. 根据Activity的声明周期</p>
<p>3. 我们知道Android的窗口类提供了历史栈，我们可以通过stack的原理来巧妙的实现，这里我们在A窗口打开B窗口时在Intent中直接加入标志 Intent.FLAG_ACTIVITY_CLEAR_TOP，这样开启B时将会清除该进程空间的所有Activity。</p>
<p>在A窗口中使用下面的代码调用B窗口</p>
<p>Intent intent = new Intent();</p>
<p>intent.setClass(Android123.this, CWJ.class);</p>
<p>intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP); //注意本行的FLAG设置</p>
<p>startActivity(intent);</p>
<p>接下来在B窗口中需要退出时直接使用finish方法即可全部退出。</p>
<p>4.自定义一个Actiivty 栈，道理同上，不过利用一个单例模式的Activity栈来管理所有Activity。并提供退出所有Activity的方法。代码如下：</p>
<p>public class ScreenManager {</p>
<p>private static Stack activityStack;</p>
<p>private static ScreenManager instance;</p>
<p>private ScreenManager(){</p>
<p>}</p>
<p>public static ScreenManager getScreenManager(){</p>
<p>instance=new ScreenManager();</p>
<p>}</p>
<p>return instance;</p>
<p>}</p>
<p>//退出栈顶Activity</p>
<p>public void popActivity(Activity activity){</p>
<p>activity.finish();</p>
<p>activityStack.remove(activity);</p>
<p>activity=null;</p>
<p>}</p>
<p>}</p>
<p>//获得当前栈顶Activity</p>
<p>public Activity currentActivity(){</p>
<p>Activity activity=activityStack.lastElement();</p>
<p>return activity;</p>
<p>}</p>
<p>//将当前Activity推入栈中</p>
<p>public void pushActivity(Activity activity){</p>
<p>activityStack=new Stack();</p>
<p>}</p>
<p>activityStack.add(activity);</p>
<p>}</p>
<p>//退出栈中所有Activity</p>
<p>public void popAllActivityExceptOne(Class cls){</p>
<p>while(true){</p>
<p>Activity activity=currentActivity();</p>
<p>break;</p>
<p>}</p>
<p>break;</p>
<p>}</p>
<p>popActivity(activity);</p>
<p>}</p>
<p>}</p>
<p>}</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> exit </tag>
            
            <tag> kill </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Activity与Service之间交互并播放歌曲]]></title>
      <url>/2012/03/07/Activity%E4%B8%8EService%E4%B9%8B%E9%97%B4%E4%BA%A4%E4%BA%92%E5%B9%B6%E6%92%AD%E6%94%BE%E6%AD%8C%E6%9B%B2/</url>
      <content type="html"><![CDATA[<p>Activity与Service之间交互并播放歌曲，为了方便，我把要播放的歌曲定死了，大家可以灵活改进<br>&nbsp;</p>
<p><img src="http://pic002.cnblogs.com/images/2012/378300/2012030714015935.jpg" alt=""></p>
<p>MService：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('ab9dded1-5f97-48dc-8388-a9ca9960b61c')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_ab9dded1-5f97-48dc-8388-a9ca9960b61c" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span> com.tiantian.test;<br><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span> android.app.Service;<br><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span> android.content.Intent;<br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span> android.media.MediaPlayer;<br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span> android.os.Binder;<br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span> android.os.Environment;<br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span> android.os.IBinder;<br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span> android.util.Log;<br><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MService <span style="color: #0000ff;">extends</span> Service{<br><span style="color: #008080;">12</span>     MyBinder myBinder = <span style="color: #0000ff;">new</span> MyBinder();<br><span style="color: #008080;">13</span>     <span style="color: #0000ff;">private</span> MediaPlayer mediaPlayer;<br><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MyBinder <span style="color: #0000ff;">extends</span> Binder{<br><span style="color: #008080;">16</span>         MService getService(){<br><span style="color: #008080;">17</span>             <span style="color: #0000ff;">return</span> MService.<span style="color: #0000ff;">this</span>;<br><span style="color: #008080;">18</span>         }<br><span style="color: #008080;">19</span>     }<br><span style="color: #008080;">20</span>     @Override<br><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span> IBinder onBind(Intent intent) {<br><span style="color: #008080;">22</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">23</span>         Log.v(“CAT”, “onBind”);<br><span style="color: #008080;">24</span>         <span style="color: #0000ff;">return</span> myBinder;<br><span style="color: #008080;">25</span>     }<br><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span>     @Override<br><span style="color: #008080;">28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCreate() {<br><span style="color: #008080;">29</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">30</span>         <span style="color: #0000ff;">super</span>.onCreate();<br><span style="color: #008080;">31</span>         Log.v(“CAT”, “onCreate”);<br><span style="color: #008080;">32</span>         <span style="color: #0000ff;">try</span> {<br><span style="color: #008080;">33</span>             mediaPlayer = <span style="color: #0000ff;">new</span> MediaPlayer();<br><span style="color: #008080;">34</span>             mediaPlayer.setDataSource(Environment.getExternalStorageDirectory() + “/mp3/trhxn.mp3”);<br><span style="color: #008080;">35</span>             mediaPlayer.prepare();<br><span style="color: #008080;">36</span>         } <span style="color: #0000ff;">catch</span> (Exception e) {<br><span style="color: #008080;">37</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated catch block</span><span style="color: #008000;"><br></span><span style="color: #008080;">38</span>             Log.v(“CAT”, “fail”);<br><span style="color: #008080;">39</span>             e.printStackTrace();<br><span style="color: #008080;">40</span>         }<br><span style="color: #008080;">41</span>     }<br><span style="color: #008080;">42</span><br><span style="color: #008080;">43</span>     @Override<br><span style="color: #008080;">44</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onDestroy() {<br><span style="color: #008080;">45</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">46</span>         <span style="color: #0000ff;">super</span>.onDestroy();<br><span style="color: #008080;">47</span>         Log.v(“CAT”, “onDestroy”);<br><span style="color: #008080;">48</span>     }<br><span style="color: #008080;">49</span><br><span style="color: #008080;">50</span>     @Override<br><span style="color: #008080;">51</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> onStartCommand(Intent intent, <span style="color: #0000ff;">int</span> flags, <span style="color: #0000ff;">int</span> startId) {<br><span style="color: #008080;">52</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">53</span>         Log.v(“CAT”, “onStartCommand”);<br><span style="color: #008080;">54</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">super</span>.onStartCommand(intent, flags, startId);<br><span style="color: #008080;">55</span>     }<br><span style="color: #008080;">56</span><br><span style="color: #008080;">57</span>     @Override<br><span style="color: #008080;">58</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span> onUnbind(Intent intent) {<br><span style="color: #008080;">59</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">60</span>         Log.v(“CAT”, “onUnbind”);<br><span style="color: #008080;">61</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span>;<br><span style="color: #008080;">62</span>     }<br><span style="color: #008080;">63</span><br><span style="color: #008080;">64</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> start(){<br><span style="color: #008080;">65</span>         mediaPlayer.start();<br><span style="color: #008080;">66</span>     }<br><span style="color: #008080;">67</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> pause(){<br><span style="color: #008080;">68</span>         mediaPlayer.pause();<br><span style="color: #008080;">69</span>     }<br><span style="color: #008080;">70</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> stop(){<br><span style="color: #008080;">71</span>         mediaPlayer.stop();<br><span style="color: #008080;">72</span>         mediaPlayer.release();<br><span style="color: #008080;">73</span>     }<br><span style="color: #008080;">74</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> getDuration(){<br><span style="color: #008080;">75</span>         <span style="color: #0000ff;">return</span> mediaPlayer.getDuration();<br><span style="color: #008080;">76</span>     }<br><span style="color: #008080;">77</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> getCurrentPosition(){<br><span style="color: #008080;">78</span>         <span style="color: #0000ff;">return</span> mediaPlayer.getCurrentPosition();<br><span style="color: #008080;">79</span>     }<br><span style="color: #008080;">80</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> seekTo(<span style="color: #0000ff;">int</span> position){<br><span style="color: #008080;">81</span>         mediaPlayer.seekTo(position);<br><span style="color: #008080;">82</span>     }<br><span style="color: #008080;">83</span> }</pre><br></div><br></div>

<p>MusicPlayActivity：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('d0b7bbe9-af89-4993-8d87-e320ceb1ece0')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_d0b7bbe9-af89-4993-8d87-e320ceb1ece0" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span> com.tiantian.test;<br><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span> android.app.Activity;<br><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span> android.content.ComponentName;<br><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span> android.content.Intent;<br><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span> android.content.ServiceConnection;<br><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span> android.os.Bundle;<br><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span> android.os.Handler;<br><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span> android.os.IBinder;<br><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span> android.util.Log;<br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span> android.view.View;<br><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span> android.view.View.OnClickListener;<br><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span> android.widget.Button;<br><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span> android.widget.SeekBar;<br><span style="color: #008080;"> 15</span><br><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MusicPlayActivity <span style="color: #0000ff;">extends</span> Activity {<br><span style="color: #008080;"> 17</span>     <span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> Called when the activity is first created. </span><span style="color: #008000;">/</span><br><span style="color: #008080;"> 18</span>     MService mService;<br><span style="color: #008080;"> 19</span>     <span style="color: #0000ff;">private</span> ServiceConnection conn = <span style="color: #0000ff;">new</span> ServiceConnection(){<br><span style="color: #008080;"> 20</span><br><span style="color: #008080;"> 21</span>         @Override<br><span style="color: #008080;"> 22</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onServiceConnected(ComponentName arg0, IBinder arg1) {<br><span style="color: #008080;"> 23</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 24</span>             mService = ((MService.MyBinder)arg1).getService();<br><span style="color: #008080;"> 25</span>             Log.v(“CAT”, “getServiced”);<br><span style="color: #008080;"> 26</span>         }<br><span style="color: #008080;"> 27</span><br><span style="color: #008080;"> 28</span>         @Override<br><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onServiceDisconnected(ComponentName name) {<br><span style="color: #008080;"> 30</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 31</span>             mService = <span style="color: #0000ff;">null</span>;<br><span style="color: #008080;"> 32</span>         }<br><span style="color: #008080;"> 33</span><br><span style="color: #008080;"> 34</span>     };<br><span style="color: #008080;"> 35</span><br><span style="color: #008080;"> 36</span>     <span style="color: #0000ff;">private</span> SeekBar seekBar;<br><span style="color: #008080;"> 37</span>     <span style="color: #0000ff;">private</span> Button playBT;<br><span style="color: #008080;"> 38</span><br><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isPlaying = <span style="color: #0000ff;">false</span>;<br><span style="color: #008080;"> 40</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isBinded = <span style="color: #0000ff;">false</span>;<br><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">private</span> Handler mHandler;<br><span style="color: #008080;"> 43</span>     @Override<br><span style="color: #008080;"> 44</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCreate(Bundle savedInstanceState) {<br><span style="color: #008080;"> 45</span>         <span style="color: #0000ff;">super</span>.onCreate(savedInstanceState);<br><span style="color: #008080;"> 46</span>         setContentView(R.layout.main);<br><span style="color: #008080;"> 47</span>         Intent intent = <span style="color: #0000ff;">new</span> Intent(MusicPlayActivity.<span style="color: #0000ff;">this</span>, MService.<span style="color: #0000ff;">class</span>);<br><span style="color: #008080;"> 48</span>         <span style="color: #0000ff;">if</span>(!isBinded){<br><span style="color: #008080;"> 49</span>             bindService(intent, conn, BIND_AUTO_CREATE);<br><span style="color: #008080;"> 50</span>             isBinded = <span style="color: #0000ff;">true</span>;<br><span style="color: #008080;"> 51</span>         }<br><span style="color: #008080;"> 52</span>         seekBar = (SeekBar) findViewById(R.id.seekBar);<br><span style="color: #008080;"> 53</span>         playBT = (Button) findViewById(R.id.startBT);<br><span style="color: #008080;"> 54</span>         mHandler = <span style="color: #0000ff;">new</span> Handler();<br><span style="color: #008080;"> 55</span>         seekBar.setOnSeekBarChangeListener(<span style="color: #0000ff;">new</span> SeekBar.OnSeekBarChangeListener() {<br><span style="color: #008080;"> 56</span><br><span style="color: #008080;"> 57</span>             @Override<br><span style="color: #008080;"> 58</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onStopTrackingTouch(SeekBar seekBar) {}<br><span style="color: #008080;"> 59</span><br><span style="color: #008080;"> 60</span>             @Override<br><span style="color: #008080;"> 61</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onStartTrackingTouch(SeekBar seekBar) {}<br><span style="color: #008080;"> 62</span><br><span style="color: #008080;"> 63</span>             @Override<br><span style="color: #008080;"> 64</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onProgressChanged(SeekBar seekBar, <span style="color: #0000ff;">int</span> progress,<br><span style="color: #008080;"> 65</span>                     <span style="color: #0000ff;">boolean</span> fromUser) {<br><span style="color: #008080;"> 66</span>                 <span style="color: #0000ff;">if</span>(fromUser){<br><span style="color: #008080;"> 67</span>                     mService.seekTo((progress<em>mService.getDuration())/100);<br><span style="color: #008080;"> 68</span>                 }<br><span style="color: #008080;"> 69</span>             }<br><span style="color: #008080;"> 70</span>         });<br><span style="color: #008080;"> 71</span>         playBT.setOnClickListener(<span style="color: #0000ff;">new</span> OnClickListener() {<br><span style="color: #008080;"> 72</span><br><span style="color: #008080;"> 73</span>             @Override<br><span style="color: #008080;"> 74</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onClick(View v) {<br><span style="color: #008080;"> 75</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 76</span>                 <span style="color: #0000ff;">if</span>(!isPlaying){<br><span style="color: #008080;"> 77</span>                     mService.start();<br><span style="color: #008080;"> 78</span>                     isPlaying = <span style="color: #0000ff;">true</span>;<br><span style="color: #008080;"> 79</span>                     playBT.setText(“暂停”);<br><span style="color: #008080;"> 80</span>                     mHandler.post(seekBarThread);<br><span style="color: #008080;"> 81</span>                 }<span style="color: #0000ff;">else</span>{<br><span style="color: #008080;"> 82</span>                     mService.pause();<br><span style="color: #008080;"> 83</span>                     isPlaying = <span style="color: #0000ff;">false</span>;<br><span style="color: #008080;"> 84</span>                     playBT.setText(“播放”);<br><span style="color: #008080;"> 85</span>                     mHandler.removeCallbacks(seekBarThread);<br><span style="color: #008080;"> 86</span>                 }<br><span style="color: #008080;"> 87</span>             }<br><span style="color: #008080;"> 88</span>         });<br><span style="color: #008080;"> 89</span><br><span style="color: #008080;"> 90</span>     }<br><span style="color: #008080;"> 91</span><br><span style="color: #008080;"> 92</span>     Runnable seekBarThread = <span style="color: #0000ff;">new</span> Runnable() {<br><span style="color: #008080;"> 93</span><br><span style="color: #008080;"> 94</span>         @Override<br><span style="color: #008080;"> 95</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> run() {<br><span style="color: #008080;"> 96</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 97</span>             seekBar.setProgress((mService.getCurrentPosition()</em>100)/mService.getDuration());<br><span style="color: #008080;"> 98</span>             mHandler.postDelayed(seekBarThread, 200);<br><span style="color: #008080;"> 99</span>         }<br><span style="color: #008080;">100</span>     };<br><span style="color: #008080;">101</span><br><span style="color: #008080;">102</span> }</pre><br></div><br></div>

<p>&nbsp;</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> activity </tag>
            
            <tag> service </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android应用签名详解 Eclipse+ADT]]></title>
      <url>/2012/03/03/Android%E5%BA%94%E7%94%A8%E7%AD%BE%E5%90%8D%E8%AF%A6%E8%A7%A3-Eclipse-ADT/</url>
      <content type="html"><![CDATA[<p>很多开辟人员不熟悉打听apk文件为什么必须签名才干公布，其实签名并非从android平台开端，在畴昔从symbian os就开端须要签名才干公布，如许可以包管每个应用法度开辟商合法id，因为android平台没有uid3的限制，项目组开放商可能经由过程应用雷同的package name来混合调换已经安装的法度。不过今朝斗劲好的是android中所有的permission应用都是免费的，但从今朝git项目中呈现的certinstaller.git包不知道是不是和证书有关，而近几年symbian os从v9.0开端若是应用法度涉及敏感操纵须要capability才干使其真机顺利安装，同时项目组高等权限须要购买和symbian signed测试才干公布，包管体系的安然靠得住性，而这点android平台较为宽松。常规景象下从adb比如eclipse的adt插件安装到模仿器或真机的测试法度经过debug标识表记标帜签名，所以我们签名是都须要先创建key公钥经由过程rsa运算才实现加密。下面具体申明：</p>
<p>&nbsp;</p>
<p><strong>一、为什么要签名：</strong>&nbsp;</p>
<p>&nbsp;</p>
<p>1、发送者的身份认证，因为开辟商可能经由过程应用雷同的Package Name来混合调换已经安装的法度，以此包管签名不合的包不被调换<br>2、包管信息传输的完全性，签名对于包中的每个文件进行处理惩罚，以此确保包中内容不被调换，防止交易中的狡赖产生，Market对软件的请求</p>
<p>&nbsp;</p>
<p><strong>二、签名的申明：</strong><br>1、所有的应用法度都必须稀有字证书，Android体系不会安装一个没稀有字证书的应用法度<br>2、Android法度包应用的数字证书可所以自签名的，不须要一个权势巨子的数字证书机构签名认证<br>3、若是要正式公布一个Android应用，必须应用一个合适的私钥生成的数字证书来给法度签名，而不克不及应用adt插件或者ant对象生成的调试证书来公布<br>4、&nbsp;数字证书都是有有效期的，Android只是在应用法度安装的时辰才会搜检证书的有效期。若是法度已经安装在体系中，即使证书过期也不会影响法度的正常功能<br>5、签名后需应用zipalign优化法度<br>6、Android将数字证书用来标识应用法度的作者和在应用法度之间建树信赖关系，而不是用来决意终极用户可以安装哪些应用法度</p>
<p><strong>1.Eclipse工程中右键工程，弹出选项中选择 android对象-生成签名应用包：</strong>&nbsp;</p>
<p><img src="http://pic-server2.byywee.com/M0/S580/580495-0.jpg" alt="">&nbsp;</p>
<p><strong>2.选择须要打包的android项目工程：</strong>&nbsp;</p>
<p><img src="http://pic-server2.byywee.com/M0/S580/580495-1.jpg" alt="">&nbsp;</p>
<p><strong>3.若是已有私钥文件，选择私钥文件 输入暗码，若是没有私钥文件见 第6和7步创建私钥文件：</strong>&nbsp;</p>
<p><img src="http://pic-server2.byywee.com/M0/S580/580495-2.jpg" alt="">&nbsp;</p>
<p><strong>4.输入私钥别号和暗码：</strong>&nbsp;</p>
<p><img src="http://pic-server2.byywee.com/M0/S580/580495-3.jpg" alt="">&nbsp;</p>
<p><strong>5.选择APK存储的地位，并完成设置 开端生成：</strong>&nbsp;</p>
<p><img src="http://pic-server2.byywee.com/M0/S580/580495-4.jpg" alt="">&nbsp;</p>
<p><strong>6.没有私钥文件的景象，创建私钥文件：</strong>&nbsp;</p>
<p><img src="http://pic-server2.byywee.com/M0/S580/580495-5.jpg" alt="">&nbsp;</p>
<p><strong>7.输入私钥文件所需信息，并创建：</strong>&nbsp;</p>
<p><img src="http://pic-server2.byywee.com/M0/S580/580495-6.jpg" alt=""></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> apk </tag>
            
            <tag> signature </tag>
            
            <tag> eclipse </tag>
            
            <tag> ADT </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android读写文件汇总]]></title>
      <url>/2012/03/03/Android%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6%E6%B1%87%E6%80%BB/</url>
      <content type="html"><![CDATA[<h3 id="一、-从resource中的raw文件夹中获取文件并读取数据（资源文件只能读不能写）"><a href="#一、-从resource中的raw文件夹中获取文件并读取数据（资源文件只能读不能写）" class="headerlink" title="一、 从resource中的raw文件夹中获取文件并读取数据（资源文件只能读不能写）"></a>一、 从resource中的raw文件夹中获取文件并读取数据（资源文件只能读不能写）</h3><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> String res = “”;<br><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">try</span>{<br><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> InputStream in = getResources().openRawResource(R.raw.bbi);<br><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> <span style="color: #008000;">//</span><span style="color: #008000;">在\Test\res\raw\bbi.txt,</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">int</span> length = in.available();<br><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">byte</span> [] buffer = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">byte</span>[length];<br><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> in.read(buffer);<br><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> <span style="color: #008000;">//</span><span style="color: #008000;">res = EncodingUtils.getString(buffer, “UTF-8”);<br></span><span style="color: #008080;">16</span> <span style="color: #008000;"><br></span><span style="color: #008080;">17</span> <span style="color: #008000;">//</span><span style="color: #008000;">res = EncodingUtils.getString(buffer, “UNICODE”);</span><span style="color: #008000;"><br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> res = EncodingUtils.getString(buffer, “BIG5”);<br><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> <span style="color: #008000;">//</span><span style="color: #008000;">依bbi.txt的编码类型选择合适的编码，如果不调整会乱码</span><span style="color: #008000;"><br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> in.close();<br><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span> }<span style="color: #0000ff;">catch</span>(Exception e){<br><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span> e.printStackTrace();<br><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> }</pre><br></div>

<p><span>myTextView.setText(res);//把得到的内容显示在TextView上</span></p>
<p>&nbsp;</p>
<h3 id="二、-从asset中获取文件并读取数据（资源文件只能读不能写）"><a href="#二、-从asset中获取文件并读取数据（资源文件只能读不能写）" class="headerlink" title="二、 从asset中获取文件并读取数据（资源文件只能读不能写）"></a>二、 从asset中获取文件并读取数据（资源文件只能读不能写）</h3><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> String fileName = “yan.txt”; <span style="color: #008000;">//</span><span style="color: #008000;">文件名字</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> String res=””;<br><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">try</span>{<br><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> InputStream in = getResources().getAssets().open(fileName);<br><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #008000;">//</span><span style="color: #008000;"> \Test\assets\yan.txt这里有这样的文件存在</span><span style="color: #008000;"><br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">int</span> length = in.available();<br><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">byte</span> [] buffer = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">byte</span>[length];<br><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> in.read(buffer);<br><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span> res = EncodingUtils.getString(buffer, “UTF-8”);<br><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> }<span style="color: #0000ff;">catch</span>(Exception e){<br><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> e.printStackTrace();<br><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> }</pre><br></div>

<h3 id="三、-从sdcard中去读文件，首先要把文件通过-android-sdk-windows-tools-adb-exe把本地计算机上的文件copy到sdcard上去，adb-exe-push-e-Y-txt-sdcard-不可以用adb-exe-push-e-Y-txt-sdcard-同样：-把仿真器上的文件copy到本地计算机上用：-adb-pull-data-data-com-tt-files-Test-txt-e"><a href="#三、-从sdcard中去读文件，首先要把文件通过-android-sdk-windows-tools-adb-exe把本地计算机上的文件copy到sdcard上去，adb-exe-push-e-Y-txt-sdcard-不可以用adb-exe-push-e-Y-txt-sdcard-同样：-把仿真器上的文件copy到本地计算机上用：-adb-pull-data-data-com-tt-files-Test-txt-e" class="headerlink" title="三、 从sdcard中去读文件，首先要把文件通过\android-sdk-windows\tools\adb.exe把本地计算机上的文件copy到sdcard上去，adb.exe push e:/Y.txt /sdcard/, 不可以用adb.exe push e:\Y.txt \sdcard\ 同样： 把仿真器上的文件copy到本地计算机上用： adb pull ./data/data/com.tt/files/Test.txt e:/"></a>三、 从sdcard中去读文件，首先要把文件通过\android-sdk-windows\tools\adb.exe把本地计算机上的文件copy到sdcard上去，adb.exe push e:/Y.txt /sdcard/, 不可以用adb.exe push e:\Y.txt \sdcard\ 同样： 把仿真器上的文件copy到本地计算机上用： adb pull ./data/data/com.tt/files/Test.txt e:/</h3><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> String fileName = “/sdcard/Y.txt”;<br><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #008000;">//</span><span style="color: #008000;">也可以用String fileName = “mnt/sdcard/Y.txt”;</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> String res=””;<br><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">try</span>{<br><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> FileInputStream fin = <span style="color: #0000ff;">new</span> FileInputStream(fileName);<br><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #008000;">//</span><span style="color: #008000;">FileInputStream fin = openFileInput(fileName);<br></span><span style="color: #008080;">12</span> <span style="color: #008000;"><br></span><span style="color: #008080;">13</span> <span style="color: #008000;">//</span><span style="color: #008000;">用这个就不行了，必须用FileInputStream</span><span style="color: #008000;"><br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> <span style="color: #0000ff;">int</span> length = fin.available();<br><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span> <span style="color: #0000ff;">byte</span> [] buffer = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">byte</span>[length];<br><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> fin.read(buffer);<br><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> res = EncodingUtils.getString(buffer, “UTF-8”);<br><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> fin.close();<br><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span> }<span style="color: #0000ff;">catch</span>(Exception e){<br><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span> e.printStackTrace();<br><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> }<br><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span> myTextView.setText(res);</pre><br></div>

<p>&nbsp;</p>
<h3 id="四、-写文件，-一般写在-data-data-com-test-files-里面，打开DDMS查看file-explorer是可以看到仿真器文件存放目录的结构的"><a href="#四、-写文件，-一般写在-data-data-com-test-files-里面，打开DDMS查看file-explorer是可以看到仿真器文件存放目录的结构的" class="headerlink" title="四、 写文件， 一般写在\data\data\com.test\files\里面，打开DDMS查看file explorer是可以看到仿真器文件存放目录的结构的"></a>四、 写文件， 一般写在\data\data\com.test\files\里面，打开DDMS查看file explorer是可以看到仿真器文件存放目录的结构的</h3><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> String fileName = “TEST.txt”;<br><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> String message = “FFFFFFF11111FFFFF” ;<br><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> writeFileData(fileName, message);<br><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">public</span> voidwriteFileData(String fileName,String message){<br><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">try</span>{<br><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> FileOutputStream fout =openFileOutput(fileName, MODE_PRIVATE);<br><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">byte</span> [] bytes = message.getBytes();<br><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> fout.write(bytes);<br><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span> fout.close();<br><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> }<br><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> <span style="color: #0000ff;">catch</span>(Exception e){<br><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> e.printStackTrace();<br><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span> }<br><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span> }</pre><br></div>

<h3 id="五、-写，-读data-data-目录-相当AP工作目录-上的文件，用openFileOutput"><a href="#五、-写，-读data-data-目录-相当AP工作目录-上的文件，用openFileOutput" class="headerlink" title="五、 写， 读data/data/目录(相当AP工作目录)上的文件，用openFileOutput"></a>五、 写， 读data/data/目录(相当AP工作目录)上的文件，用openFileOutput</h3><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">//</span><span style="color: #008000;">写文件在./data/data/com.tt/files/下面</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">public</span> voidwriteFileData(String fileName,String message){<br><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">try</span>{<br><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> FileOutputStream fout =openFileOutput(fileName, MODE_PRIVATE);<br><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">byte</span> [] bytes = message.getBytes();<br><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> fout.write(bytes);<br><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> fout.close();<br><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> }<br><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span> <span style="color: #0000ff;">catch</span>(Exception e){<br><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> e.printStackTrace();<br><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> }<br><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> }<br><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span> <span style="color: #008000;">//</span><span style="color: #008000;">——————————————————-<br></span><span style="color: #008080;">26</span> <span style="color: #008000;"><br></span><span style="color: #008080;">27</span> <span style="color: #008000;">//</span><span style="color: #008000;">读文件在./data/data/com.tt/files/下面</span><span style="color: #008000;"><br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> <span style="color: #0000ff;">public</span> String readFileData(String fileName){<br><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span> String res=””;<br><span style="color: #008080;">32</span><br><span style="color: #008080;">33</span> <span style="color: #0000ff;">try</span>{<br><span style="color: #008080;">34</span><br><span style="color: #008080;">35</span> FileInputStream fin = openFileInput(fileName);<br><span style="color: #008080;">36</span><br><span style="color: #008080;">37</span> <span style="color: #0000ff;">int</span> length = fin.available();<br><span style="color: #008080;">38</span><br><span style="color: #008080;">39</span> <span style="color: #0000ff;">byte</span> [] buffer = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">byte</span>[length];<br><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span> fin.read(buffer);<br><span style="color: #008080;">42</span><br><span style="color: #008080;">43</span> res = EncodingUtils.getString(buffer, “UTF-8”);<br><span style="color: #008080;">44</span><br><span style="color: #008080;">45</span> fin.close();<br><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span> }<br><span style="color: #008080;">48</span><br><span style="color: #008080;">49</span> <span style="color: #0000ff;">catch</span>(Exception e){<br><span style="color: #008080;">50</span><br><span style="color: #008080;">51</span> e.printStackTrace();<br><span style="color: #008080;">52</span><br><span style="color: #008080;">53</span> }<br><span style="color: #008080;">54</span><br><span style="color: #008080;">55</span> <span style="color: #0000ff;">return</span> res;<br><span style="color: #008080;">56</span><br><span style="color: #008080;">57</span> }</pre><br></div>

<h3 id="六、-写，-读sdcard目录上的文件，要用FileOutputStream，-不能用openFileOutput"><a href="#六、-写，-读sdcard目录上的文件，要用FileOutputStream，-不能用openFileOutput" class="headerlink" title="六、 写， 读sdcard目录上的文件，要用FileOutputStream， 不能用openFileOutput"></a>六、 写， 读sdcard目录上的文件，要用FileOutputStream， 不能用openFileOutput</h3><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">//</span><span style="color: #008000;">写在/mnt/sdcard/目录下面的文件</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">public</span> voidwriteFileSdcard(String fileName,String message){<br><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">try</span>{<br><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> <span style="color: #008000;">//</span><span style="color: #008000;">FileOutputStream fout = openFileOutput(fileName, MODE_PRIVATE);</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> FileOutputStream fout = newFileOutputStream(fileName);<br><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">byte</span> [] bytes = message.getBytes();<br><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> fout.write(bytes);<br><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> fout.close();<br><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span> }<br><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> <span style="color: #0000ff;">catch</span>(Exception e){<br><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> e.printStackTrace();<br><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> }<br><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span> }<br><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span> <span style="color: #008000;">//</span><span style="color: #008000;">读在/mnt/sdcard/目录下面的文件</span><span style="color: #008000;"><br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> <span style="color: #0000ff;">public</span> String readFileSdcard(String fileName){<br><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span> String res=””;<br><span style="color: #008080;">32</span><br><span style="color: #008080;">33</span> <span style="color: #0000ff;">try</span>{<br><span style="color: #008080;">34</span><br><span style="color: #008080;">35</span> FileInputStream fin = <span style="color: #0000ff;">new</span> FileInputStream(fileName);<br><span style="color: #008080;">36</span><br><span style="color: #008080;">37</span> <span style="color: #0000ff;">int</span> length = fin.available();<br><span style="color: #008080;">38</span><br><span style="color: #008080;">39</span> <span style="color: #0000ff;">byte</span> [] buffer = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">byte</span>[length];<br><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span> fin.read(buffer);<br><span style="color: #008080;">42</span><br><span style="color: #008080;">43</span> res = EncodingUtils.getString(buffer, “UTF-8”);<br><span style="color: #008080;">44</span><br><span style="color: #008080;">45</span> fin.close();<br><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span> }<br><span style="color: #008080;">48</span><br><span style="color: #008080;">49</span> <span style="color: #0000ff;">catch</span>(Exception e){<br><span style="color: #008080;">50</span><br><span style="color: #008080;">51</span> e.printStackTrace();<br><span style="color: #008080;">52</span><br><span style="color: #008080;">53</span> }<br><span style="color: #008080;">54</span><br><span style="color: #008080;">55</span> <span style="color: #0000ff;">return</span> res;<br><span style="color: #008080;">56</span><br><span style="color: #008080;">57</span> }</pre><br></div>

<p><strong>注：</strong><span>&nbsp;</span><strong>openFileOutput**</strong>是在<strong><strong>raw</strong></strong>里编译过的，<strong><strong>FileOutputStream</strong></strong>是任何文件都可以**<br><span><span>Android读写文件汇总</span>&nbsp;</span><a href="http://www.ziyouku.com/archives/android-to-read-and-write-file-summary.html" target="_blank" rel="noopener">http://www.ziyouku.com/archives/android-to-read-and-write-file-summary.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> raw </tag>
            
            <tag> resource </tag>
            
            <tag> IO </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android绘图操作onDraw]]></title>
      <url>/2012/03/03/Android%E7%BB%98%E5%9B%BE%E6%93%8D%E4%BD%9ConDraw/</url>
      <content type="html"><![CDATA[<p><span>做java的都知道，绘图肯定首先需要一个Canvas，然后在用Graphics在上面绘制自己想要图案。不错，Android上面也类似，你可以从一个Bitmap得到它的Canvas，进行绘制，也可以自定义一个View，用它的 Canvas。不同的时，Android里没有Graphics，而用 Paint代之，当然用法也稍有不同。以下是自定义View的一段代码：&nbsp;</span><br><span>@Override&nbsp;</span><br><span>public void onDraw(Canvas canvas) {&nbsp;</span><br><span>// 首先定义一个paint&nbsp;</span><br><span>Paint paint = new Paint();&nbsp;</span><br><span>// 绘制矩形区域-实心矩形&nbsp;</span><br><span>// 设置颜色&nbsp;</span><br><span>paint.setColor(Color.WHITE);&nbsp;</span><br><span>// 设置样式-填充&nbsp;</span><br><span>paint.setStyle(Style.FILL);&nbsp;</span><br><span>// 绘制一个矩形&nbsp;</span><br><span>canvas.drawRect(new Rect(0, 0, getWidth(), getHeight()), paint);&nbsp;</span><br><span>// 绘空心矩形&nbsp;</span><br><span>// 设置颜色&nbsp;</span><br><span>paint.setColor(Color.RED);&nbsp;</span><br><span>// 设置样式-空心矩形&nbsp;</span><br><span>paint.setStyle(Style.STROKE);&nbsp;</span><br><span>// 绘制一个矩形&nbsp;</span><br><span>canvas.drawRect(new Rect(10, 10, 50, 20), paint);&nbsp;</span><br><span>// 绘文字&nbsp;</span><br><span>// 设置颜色&nbsp;</span><br><span>paint.setColor(Color.GREEN);&nbsp;</span><br><span>// 绘文字&nbsp;</span><br><span>canvas.drawText(str, 30, 30, paint);&nbsp;</span><br><span>// 绘图&nbsp;</span><br><span>// 从资源文件中生成位图&nbsp;</span><br><span>Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.drawable.icon);&nbsp;</span><br><span>// 绘图&nbsp;</span><br><span>canvas.drawBitmap(bitmap, 10, 10, paint);&nbsp;</span><br><span>}&nbsp;</span><br><span>以上需要注意的有三点：&nbsp;</span><br><span>1、Android中的Rect和java中的可能稍有区别，前两个参数是左上角的坐标，后两个参数是右下角的坐标（不是宽度和高度）；&nbsp;</span><br><span>2、Style.STROKE和Style.FILL外边的像素数是有区别的，这点和java里一样；&nbsp;</span><br><span>3、绘文字时，设置的坐标点为(30,30)，但绘出来后你会发现，文字的左上角坐标要比你设置的偏上，不知道是android设置的bug，还是我们有理解到坐标点的意义。</span></p>
<p>Android绘图操作onDraw | 自由库&nbsp;<a href="http://www.ziyouku.com/archives/android-operating-ondraw-drawing.html" target="_blank" rel="noopener">http://www.ziyouku.com/archives/android-operating-ondraw-drawing.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> onDraw </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[TimePicker,SharedPreferences实现android小闹钟]]></title>
      <url>/2012/03/03/TimePicker-SharedPreferences%E5%AE%9E%E7%8E%B0android%E5%B0%8F%E9%97%B9%E9%92%9F/</url>
      <content type="html"><![CDATA[<p><img src="http://pic002.cnblogs.com/images/2012/378300/2012030313175433.jpg" alt=""></p>
<p><img src="http://pic002.cnblogs.com/images/2012/378300/2012030313182297.jpg" alt=""></p>
<p><img src="http://pic002.cnblogs.com/images/2012/378300/2012030313183586.jpg" alt=""></p>
<p>简述：</p>
<p>使用TimePickerDialog来实现设置闹钟</p>
<p>分为一次性闹钟和周期性闹钟</p>
<p>使用SharedPreferences来储存闹钟的设置信息</p>
<p>&nbsp;</p>
<p>AlarmClockActivity布局：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('e85b0aeb-2755-4966-96ab-92b2ce96e0f6')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_e85b0aeb-2755-4966-96ab-92b2ce96e0f6" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> &lt;?xml version=”1.0” encoding=”utf-8”?&gt;<br><span style="color: #008080;">  2</span> &lt;LinearLayout xmlns:android=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“<br><span style="color: #008080;">  3</span>     android:layout_width=”fill_parent”<br><span style="color: #008080;">  4</span>     android:layout_height=”fill_parent”<br><span style="color: #008080;">  5</span>     android:orientation=”vertical”&gt;<br><span style="color: #008080;">  6</span><br><span style="color: #008080;">  7</span>     &lt;TextView<br><span style="color: #008080;">  8</span>         android:id=”@+id/timeId”<br><span style="color: #008080;">  9</span>         android:layout_width=”fill_parent”<br><span style="color: #008080;"> 10</span>         android:layout_height=”wrap_content”<br><span style="color: #008080;"> 11</span>         android:textSize=”33dp”<br><span style="color: #008080;"> 12</span>         android:gravity=”center_horizontal”<br><span style="color: #008080;"> 13</span>         android:layout_marginTop=”10dp”<br><span style="color: #008080;"> 14</span>         android:text=”00:00  AM” /&gt;<br><span style="color: #008080;"> 15</span><br><span style="color: #008080;"> 16</span>     &lt;TableLayout<br><span style="color: #008080;"> 17</span>         android:id=”@+id/tableLayout1”<br><span style="color: #008080;"> 18</span>         android:layout_width=”match_parent”<br><span style="color: #008080;"> 19</span>         android:layout_height=”wrap_content”<br><span style="color: #008080;"> 20</span>         android:layout_marginTop=”10dp”&gt;<br><span style="color: #008080;"> 21</span><br><span style="color: #008080;"> 22</span>         &lt;TableRow<br><span style="color: #008080;"> 23</span>             android:id=”@+id/tableRow1”<br><span style="color: #008080;"> 24</span>             android:layout_width=”wrap_content”<br><span style="color: #008080;"> 25</span>             android:layout_height=”wrap_content” &gt;<br><span style="color: #008080;"> 26</span><br><span style="color: #008080;"> 27</span>             &lt;TextView<br><span style="color: #008080;"> 28</span>                 android:layout_width=”wrap_content”<br><span style="color: #008080;"> 29</span>                 android:layout_height=”wrap_content”<br><span style="color: #008080;"> 30</span>                 android:layout_marginLeft=”15dp”<br><span style="color: #008080;"> 31</span>                 android:layout_weight=”1.0”<br><span style="color: #008080;"> 32</span>                 android:textSize=”20sp”<br><span style="color: #008080;"> 33</span>                 android:text=”只响一次的闹钟” /&gt;<br><span style="color: #008080;"> 34</span><br><span style="color: #008080;"> 35</span>             &lt;Button<br><span style="color: #008080;"> 36</span>                 android:id=”@+id/onceSetId”<br><span style="color: #008080;"> 37</span>                 android:layout_width=”wrap_content”<br><span style="color: #008080;"> 38</span>                 android:layout_height=”wrap_content”<br><span style="color: #008080;"> 39</span>                 android:layout_marginRight=”10dp”<br><span style="color: #008080;"> 40</span>                 android:layout_weight=”1.0”<br><span style="color: #008080;"> 41</span>                 android:text=”设置闹钟” /&gt;<br><span style="color: #008080;"> 42</span>         &lt;/TableRow&gt;<br><span style="color: #008080;"> 43</span><br><span style="color: #008080;"> 44</span>         &lt;TableRow<br><span style="color: #008080;"> 45</span>             android:id=”@+id/tableRow2”<br><span style="color: #008080;"> 46</span>             android:layout_width=”wrap_content”<br><span style="color: #008080;"> 47</span>             android:layout_height=”wrap_content” &gt;<br><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span>             &lt;TextView<br><span style="color: #008080;"> 50</span>                 android:id=”@+id/onceTextId”<br><span style="color: #008080;"> 51</span>                 android:layout_width=”wrap_content”<br><span style="color: #008080;"> 52</span>                 android:layout_height=”wrap_content”<br><span style="color: #008080;"> 53</span>                 android:layout_marginLeft=”15dp”<br><span style="color: #008080;"> 54</span>                 android:layout_weight=”1.0”<br><span style="color: #008080;"> 55</span>                 android:textSize=”20sp”<br><span style="color: #008080;"> 56</span>                 android:text=”暂无设置” /&gt;<br><span style="color: #008080;"> 57</span><br><span style="color: #008080;"> 58</span>             &lt;Button<br><span style="color: #008080;"> 59</span>                 android:id=”@+id/onceDeleId”<br><span style="color: #008080;"> 60</span>                 android:layout_width=”wrap_content”<br><span style="color: #008080;"> 61</span>                 android:layout_height=”wrap_content”<br><span style="color: #008080;"> 62</span>                 android:layout_marginRight=”10dp”<br><span style="color: #008080;"> 63</span>                 android:layout_weight=”1.0”<br><span style="color: #008080;"> 64</span>                 android:text=”删除闹钟” /&gt;<br><span style="color: #008080;"> 65</span>         &lt;/TableRow&gt;<br><span style="color: #008080;"> 66</span><br><span style="color: #008080;"> 67</span>         &lt;TableRow<br><span style="color: #008080;"> 68</span>             android:id=”@+id/tableRow3”<br><span style="color: #008080;"> 69</span>             android:layout_width=”wrap_content”<br><span style="color: #008080;"> 70</span>             android:layout_height=”wrap_content”<br><span style="color: #008080;"> 71</span>             android:layout_marginTop=”25dp”&gt;<br><span style="color: #008080;"> 72</span><br><span style="color: #008080;"> 73</span>             &lt;TextView<br><span style="color: #008080;"> 74</span>                 android:layout_width=”wrap_content”<br><span style="color: #008080;"> 75</span>                 android:layout_height=”wrap_content”<br><span style="color: #008080;"> 76</span>                 android:layout_marginLeft=”15dp”<br><span style="color: #008080;"> 77</span>                 android:layout_weight=”1.0”<br><span style="color: #008080;"> 78</span>                 android:textSize=”20sp”<br><span style="color: #008080;"> 79</span>                 android:text=”重复响起的闹钟” /&gt;<br><span style="color: #008080;"> 80</span><br><span style="color: #008080;"> 81</span>             &lt;Button<br><span style="color: #008080;"> 82</span>                 android:id=”@+id/timesSetId”<br><span style="color: #008080;"> 83</span>                 android:layout_width=”wrap_content”<br><span style="color: #008080;"> 84</span>                 android:layout_height=”wrap_content”<br><span style="color: #008080;"> 85</span>                 android:layout_marginRight=”10dp”<br><span style="color: #008080;"> 86</span>                 android:layout_weight=”1.0”<br><span style="color: #008080;"> 87</span>                 android:text=”设置闹钟” /&gt;<br><span style="color: #008080;"> 88</span>         &lt;/TableRow&gt;<br><span style="color: #008080;"> 89</span><br><span style="color: #008080;"> 90</span>         &lt;TableRow<br><span style="color: #008080;"> 91</span>             android:id=”@+id/tableRow4”<br><span style="color: #008080;"> 92</span>             android:layout_width=”wrap_content”<br><span style="color: #008080;"> 93</span>             android:layout_height=”wrap_content” &gt;<br><span style="color: #008080;"> 94</span><br><span style="color: #008080;"> 95</span>             &lt;TextView<br><span style="color: #008080;"> 96</span>                 android:id=”@+id/timesTextId”<br><span style="color: #008080;"> 97</span>                 android:layout_width=”wrap_content”<br><span style="color: #008080;"> 98</span>                 android:layout_height=”wrap_content”<br><span style="color: #008080;"> 99</span>                 android:layout_marginLeft=”15dp”<br><span style="color: #008080;">100</span>                 android:layout_weight=”1.0”<br><span style="color: #008080;">101</span>                 android:textSize=”20sp”<br><span style="color: #008080;">102</span>                 android:text=”暂无设置” /&gt;<br><span style="color: #008080;">103</span><br><span style="color: #008080;">104</span>             &lt;Button<br><span style="color: #008080;">105</span>                 android:id=”@+id/timesDeleId”<br><span style="color: #008080;">106</span>                 android:layout_width=”wrap_content”<br><span style="color: #008080;">107</span>                 android:layout_height=”wrap_content”<br><span style="color: #008080;">108</span>                 android:layout_marginRight=”10dp”<br><span style="color: #008080;">109</span>                 android:layout_weight=”1.0”<br><span style="color: #008080;">110</span>                 android:text=”删除闹钟” /&gt;<br><span style="color: #008080;">111</span>         &lt;/TableRow&gt;<br><span style="color: #008080;">112</span>     &lt;/TableLayout&gt;<br><span style="color: #008080;">113</span><br><span style="color: #008080;">114</span> &lt;/LinearLayout&gt;</pre><br></div><br></div>

<p>&nbsp;</p>
<p>AlarmClockActivity.java：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('a0a29346-6f57-40d1-a0e1-349296dc9b15')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_a0a29346-6f57-40d1-a0e1-349296dc9b15" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span> com.tiantian.test;<br><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span> java.util.Calendar;<br><span style="color: #008080;">  4</span><br><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span> android.app.Activity;<br><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span> android.app.AlarmManager;<br><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span> android.app.PendingIntent;<br><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span> android.app.TimePickerDialog;<br><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span> android.app.TimePickerDialog.OnTimeSetListener;<br><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span> android.content.Intent;<br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span> android.content.SharedPreferences;<br><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span> android.content.SharedPreferences.Editor;<br><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span> android.os.Bundle;<br><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span> android.os.Handler;<br><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">import</span> android.text.format.Time;<br><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">import</span> android.util.Log;<br><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">import</span> android.view.View;<br><span style="color: #008080;"> 18</span> <span style="color: #0000ff;">import</span> android.view.View.OnClickListener;<br><span style="color: #008080;"> 19</span> <span style="color: #0000ff;">import</span> android.widget.Button;<br><span style="color: #008080;"> 20</span> <span style="color: #0000ff;">import</span> android.widget.TextView;<br><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">import</span> android.widget.TimePicker;<br><span style="color: #008080;"> 22</span><br><span style="color: #008080;"> 23</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> AlarmClockActivity <span style="color: #0000ff;">extends</span> Activity {<br><span style="color: #008080;"> 24</span>     <span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> Called when the activity is first created. </span><span style="color: #008000;">/</span><br><span style="color: #008080;"> 25</span>     <span style="color: #0000ff;">private</span> TextView timeTV;<br><span style="color: #008080;"> 26</span>     <span style="color: #0000ff;">static</span> TextView onceTV;<br><span style="color: #008080;"> 27</span>     <span style="color: #0000ff;">private</span> TextView timesTV;<br><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">private</span> Button onceSetBT;<br><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">private</span> Button onceDeleBT;<br><span style="color: #008080;"> 30</span>     <span style="color: #0000ff;">private</span> Button timesSetBT;<br><span style="color: #008080;"> 31</span>     <span style="color: #0000ff;">private</span> Button timesDelBT;<br><span style="color: #008080;"> 32</span>     <span style="color: #0000ff;">private</span> Calendar c;<br><span style="color: #008080;"> 33</span><br><span style="color: #008080;"> 34</span>     <span style="color: #0000ff;">private</span> Handler mHandler;<br><span style="color: #008080;"> 35</span>     <span style="color: #0000ff;">private</span> SharedPreferences prefs;<br><span style="color: #008080;"> 36</span>     <span style="color: #0000ff;">private</span> Editor editor;<br><span style="color: #008080;"> 37</span><br><span style="color: #008080;"> 38</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> String ONCE_ALARM = “com.tiantian.action.ONCE_ALARM”;<br><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> String TIMES_ALARM = “com.tiantian.action.TIMES_ALARM”;<br><span style="color: #008080;"> 40</span>     @Override<br><span style="color: #008080;"> 41</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCreate(Bundle savedInstanceState) {<br><span style="color: #008080;"> 42</span>         <span style="color: #0000ff;">super</span>.onCreate(savedInstanceState);<br><span style="color: #008080;"> 43</span>         setContentView(R.layout.main);<br><span style="color: #008080;"> 44</span>         timeTV = (TextView) findViewById(R.id.timeId);<br><span style="color: #008080;"> 45</span>         onceTV = (TextView) findViewById(R.id.onceTextId);<br><span style="color: #008080;"> 46</span>         timesTV = (TextView) findViewById(R.id.timesTextId);<br><span style="color: #008080;"> 47</span>         mHandler = <span style="color: #0000ff;">new</span> Handler();<br><span style="color: #008080;"> 48</span>         mHandler.post(timeThread);<br><span style="color: #008080;"> 49</span><br><span style="color: #008080;"> 50</span>         prefs = getSharedPreferences(“alarmClock”, MODE_PRIVATE);<br><span style="color: #008080;"> 51</span>         editor = prefs.edit();<br><span style="color: #008080;"> 52</span>         <span style="color: #0000ff;">if</span>(prefs != <span style="color: #0000ff;">null</span>){<br><span style="color: #008080;"> 53</span>             onceTV.setText(prefs.getString(“_onceTV”, “暂无设置”));<br><span style="color: #008080;"> 54</span>             timesTV.setText(prefs.getString(“_timesTV”, “暂无设置”));<br><span style="color: #008080;"> 55</span>         }<br><span style="color: #008080;"> 56</span><br><span style="color: #008080;"> 57</span>         onceSetBT = (Button) findViewById(R.id.onceSetId);<br><span style="color: #008080;"> 58</span>         onceSetBT.setOnClickListener(<span style="color: #0000ff;">new</span> ButtonListener());<br><span style="color: #008080;"> 59</span>         onceDeleBT = (Button) findViewById(R.id.onceDeleId);<br><span style="color: #008080;"> 60</span>         onceDeleBT.setOnClickListener(<span style="color: #0000ff;">new</span> ButtonListener());<br><span style="color: #008080;"> 61</span>         timesSetBT = (Button) findViewById(R.id.timesSetId);<br><span style="color: #008080;"> 62</span>         timesSetBT.setOnClickListener(<span style="color: #0000ff;">new</span> ButtonListener());<br><span style="color: #008080;"> 63</span>         timesDelBT = (Button) findViewById(R.id.timesDeleId);<br><span style="color: #008080;"> 64</span>         timesDelBT.setOnClickListener(<span style="color: #0000ff;">new</span> ButtonListener());<br><span style="color: #008080;"> 65</span><br><span style="color: #008080;"> 66</span>     }<br><span style="color: #008080;"> 67</span><br><span style="color: #008080;"> 68</span>     <span style="color: #0000ff;">class</span> ButtonListener <span style="color: #0000ff;">implements</span> OnClickListener{<br><span style="color: #008080;"> 69</span><br><span style="color: #008080;"> 70</span>         @Override<br><span style="color: #008080;"> 71</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onClick(View v) {<br><span style="color: #008080;"> 72</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 73</span>             <span style="color: #0000ff;">switch</span>(v.getId()){<br><span style="color: #008080;"> 74</span>             <span style="color: #0000ff;">case</span> R.id.onceSetId:<br><span style="color: #008080;"> 75</span>                 c = Calendar.getInstance();<br><span style="color: #008080;"> 76</span>                 <span style="color: #0000ff;">int</span> hour = c.get(Calendar.HOUR_OF_DAY);<br><span style="color: #008080;"> 77</span>                 <span style="color: #0000ff;">int</span> minute = c.get(Calendar.MINUTE);<br><span style="color: #008080;"> 78</span>                 <span style="color: #0000ff;">new</span> TimePickerDialog(AlarmClockActivity.<span style="color: #0000ff;">this</span>, <span style="color: #0000ff;">new</span> OnTimeSetListener() {<br><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span>                     @Override<br><span style="color: #008080;"> 81</span>                     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onTimeSet(TimePicker view, <span style="color: #0000ff;">int</span> hourOfDay, <span style="color: #0000ff;">int</span> minute) {<br><span style="color: #008080;"> 82</span>                         <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 83</span>                         onceTV.setText(“已设置为：” + changeTime(hourOfDay) + “:” + changeTime(minute));<br><span style="color: #008080;"> 84</span>                         c = timePicker(hourOfDay, minute);<br><span style="color: #008080;"> 85</span>                         AlarmManager am = (AlarmManager) getSystemService(ALARM_SERVICE);<br><span style="color: #008080;"> 86</span>                         Intent intent = <span style="color: #0000ff;">new</span> Intent(AlarmClockActivity.<span style="color: #0000ff;">this</span>, CallAlarm.<span style="color: #0000ff;">class</span>);<br><span style="color: #008080;"> 87</span>                         intent.setAction(ONCE_ALARM);<br><span style="color: #008080;"> 88</span>                         PendingIntent senderPI = PendingIntent.getBroadcast(AlarmClockActivity.<span style="color: #0000ff;">this</span>, 0, intent, 0);<br><span style="color: #008080;"> 89</span>                         am.set(AlarmManager.RTC_WAKEUP, c.getTimeInMillis(), senderPI);<br><span style="color: #008080;"> 90</span>                     }<br><span style="color: #008080;"> 91</span>                 }, hour, minute, <span style="color: #0000ff;">true</span>).show();<br><span style="color: #008080;"> 92</span>                 <span style="color: #0000ff;">break</span>;<br><span style="color: #008080;"> 93</span>             <span style="color: #0000ff;">case</span> R.id.onceDeleId:<br><span style="color: #008080;"> 94</span>                 AlarmManager am = (AlarmManager) getSystemService(ALARM_SERVICE);<br><span style="color: #008080;"> 95</span>                 Intent intent = <span style="color: #0000ff;">new</span> Intent(AlarmClockActivity.<span style="color: #0000ff;">this</span>, CallAlarm.<span style="color: #0000ff;">class</span>);<br><span style="color: #008080;"> 96</span>                 PendingIntent senderPI = PendingIntent.getBroadcast(AlarmClockActivity.<span style="color: #0000ff;">this</span>, 0, intent, 0);<br><span style="color: #008080;"> 97</span>                 am.cancel(senderPI);<br><span style="color: #008080;"> 98</span>                 onceTV.setText(“暂无设置”);<br><span style="color: #008080;"> 99</span>                 <span style="color: #0000ff;">break</span>;<br><span style="color: #008080;">100</span>             <span style="color: #0000ff;">case</span> R.id.timesSetId:<br><span style="color: #008080;">101</span>                 c = Calendar.getInstance();<br><span style="color: #008080;">102</span>                 <span style="color: #0000ff;">int</span> hour1 = c.get(Calendar.HOUR_OF_DAY);<br><span style="color: #008080;">103</span>                 <span style="color: #0000ff;">int</span> minute1 = c.get(Calendar.MINUTE);<br><span style="color: #008080;">104</span>                 <span style="color: #0000ff;">new</span> TimePickerDialog(AlarmClockActivity.<span style="color: #0000ff;">this</span>, <span style="color: #0000ff;">new</span> OnTimeSetListener() {<br><span style="color: #008080;">105</span><br><span style="color: #008080;">106</span>                     @Override<br><span style="color: #008080;">107</span>                     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onTimeSet(TimePicker view, <span style="color: #0000ff;">int</span> hourOfDay, <span style="color: #0000ff;">int</span> minute) {<br><span style="color: #008080;">108</span>                         <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">109</span>                         timesTV.setText(“已设置为：” + changeTime(hourOfDay) + “:” + changeTime(minute));<br><span style="color: #008080;">110</span>                         c = timePicker(hourOfDay, minute);<br><span style="color: #008080;">111</span>                         AlarmManager am = (AlarmManager) getSystemService(ALARM_SERVICE);<br><span style="color: #008080;">112</span>                         Intent intent = <span style="color: #0000ff;">new</span> Intent(AlarmClockActivity.<span style="color: #0000ff;">this</span>, CallAlarm.<span style="color: #0000ff;">class</span>);<br><span style="color: #008080;">113</span>                         intent.setAction(TIMES_ALARM);<br><span style="color: #008080;">114</span>                         PendingIntent senderPI = PendingIntent.getBroadcast(AlarmClockActivity.<span style="color: #0000ff;">this</span>, 1, intent, 0);<br><span style="color: #008080;">115</span>                         am.setRepeating(AlarmManager.RTC_WAKEUP, c.getTimeInMillis(), 24<em>60</em>60*1000, senderPI);<br><span style="color: #008080;">116</span>                     }<br><span style="color: #008080;">117</span>                 }, hour1, minute1, <span style="color: #0000ff;">true</span>).show();<br><span style="color: #008080;">118</span>                 <span style="color: #0000ff;">break</span>;<br><span style="color: #008080;">119</span>             <span style="color: #0000ff;">case</span> R.id.timesDeleId:<br><span style="color: #008080;">120</span>                 AlarmManager am1 = (AlarmManager) getSystemService(ALARM_SERVICE);<br><span style="color: #008080;">121</span>                 Intent intent1 = <span style="color: #0000ff;">new</span> Intent(AlarmClockActivity.<span style="color: #0000ff;">this</span>, CallAlarm.<span style="color: #0000ff;">class</span>);<br><span style="color: #008080;">122</span>                 PendingIntent senderPI1 = PendingIntent.getBroadcast(AlarmClockActivity.<span style="color: #0000ff;">this</span>, 1, intent1, 0);<br><span style="color: #008080;">123</span>                 am1.cancel(senderPI1);<br><span style="color: #008080;">124</span>                 timesTV.setText(“暂无设置”);<br><span style="color: #008080;">125</span>                 <span style="color: #0000ff;">break</span>;<br><span style="color: #008080;">126</span>             }<br><span style="color: #008080;">127</span><br><span style="color: #008080;">128</span>         }<br><span style="color: #008080;">129</span><br><span style="color: #008080;">130</span>     }<br><span style="color: #008080;">131</span><br><span style="color: #008080;">132</span>     <span style="color: #0000ff;">private</span> Calendar timePicker(<span style="color: #0000ff;">int</span> hourOfDay, <span style="color: #0000ff;">int</span> minute){<br><span style="color: #008080;">133</span>         c.setTimeInMillis(System.currentTimeMillis());<br><span style="color: #008080;">134</span>         c.set(Calendar.HOUR_OF_DAY, hourOfDay);<br><span style="color: #008080;">135</span>         c.set(Calendar.MINUTE, minute);<br><span style="color: #008080;">136</span>         c.set(Calendar.SECOND, 0);<br><span style="color: #008080;">137</span>         c.set(Calendar.MILLISECOND, 0);<br><span style="color: #008080;">138</span>         <span style="color: #008000;">//</span><span style="color: #008000;">避免设置时间比当前时间小时 马上响应的情况发生</span><span style="color: #008000;"><br></span><span style="color: #008080;">139</span>         <span style="color: #0000ff;">if</span>(c.getTimeInMillis() &lt; Calendar.getInstance().getTimeInMillis()){<br><span style="color: #008080;">140</span>             c.set(Calendar.DAY_OF_MONTH, Calendar.DAY_OF_MONTH + 1);<br><span style="color: #008080;">141</span>         }<br><span style="color: #008080;">142</span>         <span style="color: #0000ff;">return</span> c;<br><span style="color: #008080;">143</span>     }<br><span style="color: #008080;">144</span><br><span style="color: #008080;">145</span><br><span style="color: #008080;">146</span>     @Override<br><span style="color: #008080;">147</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> onDestroy() {<br><span style="color: #008080;">148</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">149</span>         <span style="color: #0000ff;">super</span>.onDestroy();<br><span style="color: #008080;">150</span>         editor.putString(“_onceTV”, onceTV.getText().toString());<br><span style="color: #008080;">151</span>         editor.putString(“_timesTV”, timesTV.getText().toString());<br><span style="color: #008080;">152</span>         editor.commit();<br><span style="color: #008080;">153</span>     }<br><span style="color: #008080;">154</span><br><span style="color: #008080;">155</span><br><span style="color: #008080;">156</span>     Runnable timeThread = <span style="color: #0000ff;">new</span> Runnable() {<br><span style="color: #008080;">157</span><br><span style="color: #008080;">158</span>         @Override<br><span style="color: #008080;">159</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> run() {<br><span style="color: #008080;">160</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">161</span>             timeTV.setText(changeTime(Calendar.getInstance().get(Calendar.HOUR))<br><span style="color: #008080;">162</span>                     + “:” +changeTime(Calendar.getInstance().get(Calendar.MINUTE))<br><span style="color: #008080;">163</span>                     + “  “ + changeAMPM(Calendar.getInstance().get(Calendar.AM_PM)));<br><span style="color: #008080;">164</span>             mHandler.postDelayed(timeThread, 100);<br><span style="color: #008080;">165</span>         }<br><span style="color: #008080;">166</span>     };<br><span style="color: #008080;">167</span><br><span style="color: #008080;">168</span>     <span style="color: #0000ff;">private</span> String changeTime(<span style="color: #0000ff;">int</span> a){<br><span style="color: #008080;">169</span>         String num = <span style="color: #0000ff;">null</span>;<br><span style="color: #008080;">170</span>         <span style="color: #0000ff;">if</span>(a &lt; 10){<br><span style="color: #008080;">171</span>             num = “0” + a;<br><span style="color: #008080;">172</span>         }<span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(a &gt; 9){<br><span style="color: #008080;">173</span>             num = “” + a;<br><span style="color: #008080;">174</span>         }<br><span style="color: #008080;">175</span>         <span style="color: #0000ff;">return</span> num;<br><span style="color: #008080;">176</span>     }<br><span style="color: #008080;">177</span>     <span style="color: #0000ff;">private</span> String changeAMPM(<span style="color: #0000ff;">int</span> ap){<br><span style="color: #008080;">178</span>         String apStr = <span style="color: #0000ff;">null</span>;<br><span style="color: #008080;">179</span>         <span style="color: #0000ff;">if</span>(ap == 0){<br><span style="color: #008080;">180</span>             apStr = “AM”;<br><span style="color: #008080;">181</span>         }<span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(ap == 1){<br><span style="color: #008080;">182</span>             apStr = “PM”;<br><span style="color: #008080;">183</span>         }<br><span style="color: #008080;">184</span>         <span style="color: #0000ff;">return</span> apStr;<br><span style="color: #008080;">185</span>     }<br><span style="color: #008080;">186</span><br><span style="color: #008080;">187</span> }</pre><br></div><br></div>

<p>CallAlarm.java：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('c5bf7d4e-03e7-4260-9ace-1b63849d1153')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_c5bf7d4e-03e7-4260-9ace-1b63849d1153" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span> com.tiantian.test;<br><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span> android.content.BroadcastReceiver;<br><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span> android.content.Context;<br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span> android.content.Intent;<br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span> android.util.Log;<br><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> CallAlarm <span style="color: #0000ff;">extends</span> BroadcastReceiver{<br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> String ONCE_ALARM = “com.tiantian.action.ONCE_ALARM”;<br><span style="color: #008080;">10</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> String TIMES_ALARM = “com.tiantian.action.TIMES_ALARM”;<br><span style="color: #008080;">11</span>     @Override<br><span style="color: #008080;">12</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onReceive(Context context, Intent intent) {<br><span style="color: #008080;">13</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">14</span>         Log.v(“CAT”, “I’m in BroadcastReceiver”);<br><span style="color: #008080;">15</span>         Intent wakeUpIntent = <span style="color: #0000ff;">new</span> Intent(context, WakeUp.<span style="color: #0000ff;">class</span>);<br><span style="color: #008080;">16</span>         wakeUpIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);<br><span style="color: #008080;">17</span>         <span style="color: #0000ff;">if</span>(intent.getAction().equals(ONCE_ALARM)){<br><span style="color: #008080;">18</span>             wakeUpIntent.setAction(ONCE_ALARM);<br><span style="color: #008080;">19</span>         }<span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(intent.getAction().endsWith(TIMES_ALARM)){<br><span style="color: #008080;">20</span>             wakeUpIntent.setAction(TIMES_ALARM);<br><span style="color: #008080;">21</span>         }<br><span style="color: #008080;">22</span>         context.startActivity(wakeUpIntent);<br><span style="color: #008080;">23</span>     }<br><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span> }</pre><br></div><br></div>

<p>&nbsp;</p>
<p>WakeUp.java</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('5a640f02-d1eb-4506-b25e-73dd110e947e')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_5a640f02-d1eb-4506-b25e-73dd110e947e" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span> com.tiantian.test;<br><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span> android.app.Activity;<br><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span> android.app.AlertDialog;<br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span> android.content.DialogInterface;<br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span> android.content.DialogInterface.OnClickListener;<br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span> android.content.SharedPreferences;<br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span> android.content.SharedPreferences.Editor;<br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span> android.media.MediaPlayer;<br><span style="color: #008080;">10</span> <span style="color: #0000ff;">import</span> android.os.Bundle;<br><span style="color: #008080;">11</span> <span style="color: #0000ff;">import</span> android.os.Environment;<br><span style="color: #008080;">12</span> <span style="color: #0000ff;">import</span> android.view.View;<br><span style="color: #008080;">13</span> <span style="color: #0000ff;">import</span> android.widget.Button;<br><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> WakeUp <span style="color: #0000ff;">extends</span> Activity{<br><span style="color: #008080;">16</span>     <span style="color: #0000ff;">private</span> Button okButton;<br><span style="color: #008080;">17</span>     <span style="color: #0000ff;">private</span> SharedPreferences prefs;<br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">private</span> Editor editor;<br><span style="color: #008080;">19</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> String ONCE_ALARM = “com.tiantian.action.ONCE_ALARM”;<br><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>     <span style="color: #0000ff;">private</span> MediaPlayer mediaPlayer;<br><span style="color: #008080;">22</span>     @Override<br><span style="color: #008080;">23</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> onCreate(Bundle savedInstanceState) {<br><span style="color: #008080;">24</span>         <span style="color: #0000ff;">super</span>.onCreate(savedInstanceState);<br><span style="color: #008080;">25</span>         setContentView(R.layout.wake_up);<br><span style="color: #008080;">26</span>         prefs = getSharedPreferences(“alarmClock”, MODE_PRIVATE);<br><span style="color: #008080;">27</span>         mediaPlayer = <span style="color: #0000ff;">new</span> MediaPlayer();<br><span style="color: #008080;">28</span>         <span style="color: #0000ff;">try</span> {<br><span style="color: #008080;">29</span>             <span style="color: #008000;">//</span><span style="color: #008000;">mediaPlayer.setDataSource(Environment.getExternalStorageDirectory() + “/mp3/trhxn.mp3”);</span><span style="color: #008000;"><br></span><span style="color: #008080;">30</span>             mediaPlayer = MediaPlayer.create(<span style="color: #0000ff;">this</span>, R.raw.conan);<br><span style="color: #008080;">31</span>             <span style="color: #008000;">//</span><span style="color: #008000;">mediaPlayer.prepare();</span><span style="color: #008000;"><br></span><span style="color: #008080;">32</span>             mediaPlayer.setLooping(<span style="color: #0000ff;">true</span>);<br><span style="color: #008080;">33</span>             mediaPlayer.start();<br><span style="color: #008080;">34</span>         } <span style="color: #0000ff;">catch</span> (Exception e) {<br><span style="color: #008080;">35</span>             e.printStackTrace();<br><span style="color: #008080;">36</span>         }<br><span style="color: #008080;">37</span><br><span style="color: #008080;">38</span>         okButton = (Button) findViewById(R.id.okButtonId);<br><span style="color: #008080;">39</span>         okButton.setOnClickListener(<span style="color: #0000ff;">new</span> View.OnClickListener() {<br><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span>             @Override<br><span style="color: #008080;">42</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onClick(View v) {<br><span style="color: #008080;">43</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">44</span>                 <span style="color: #0000ff;">if</span>(getIntent().getAction().equals(ONCE_ALARM)){<br><span style="color: #008080;">45</span>                     editor = prefs.edit();<br><span style="color: #008080;">46</span>                     editor.putString(“_onceTV”, “暂无设置”);<br><span style="color: #008080;">47</span>                     editor.commit();<br><span style="color: #008080;">48</span>                     AlarmClockActivity.onceTV.setText(“暂无设置”);<br><span style="color: #008080;">49</span>                 }<br><span style="color: #008080;">50</span>                 mediaPlayer.stop();<br><span style="color: #008080;">51</span>                 mediaPlayer.release();<br><span style="color: #008080;">52</span>                 finish();<br><span style="color: #008080;">53</span>             }<br><span style="color: #008080;">54</span>         });<br><span style="color: #008080;">55</span><br><span style="color: #008080;">56</span><br><span style="color: #008080;">57</span><br><span style="color: #008080;">58</span>     }<br><span style="color: #008080;">59</span><br><span style="color: #008080;">60</span><br><span style="color: #008080;">61</span> }</pre><br></div><br></div>

]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[android中DatePicker&TimePicker的应用]]></title>
      <url>/2012/03/01/android%E4%B8%ADDatePicker-TimePicker%E7%9A%84%E5%BA%94%E7%94%A8/</url>
      <content type="html"><![CDATA[<p><img src="http://pic002.cnblogs.com/images/2012/378300/2012030118412226.jpg" alt=""></p>
<p>布局：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('210ec2ed-ef8a-41d7-b9e4-93fa5b27d84f')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_210ec2ed-ef8a-41d7-b9e4-93fa5b27d84f" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> &lt;?xml version=”1.0” encoding=”utf-8”?&gt;<br><span style="color: #008080;"> 2</span> &lt;LinearLayout xmlns:android=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“<br><span style="color: #008080;"> 3</span>     android:layout_width=”fill_parent”<br><span style="color: #008080;"> 4</span>     android:layout_height=”fill_parent”<br><span style="color: #008080;"> 5</span>     android:orientation=”vertical” &gt;<br><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>     &lt;TextView<br><span style="color: #008080;"> 8</span>         android:id=”@+id/dateText”<br><span style="color: #008080;"> 9</span>         android:layout_width=”wrap_content”<br><span style="color: #008080;">10</span>         android:layout_height=”wrap_content”<br><span style="color: #008080;">11</span>         /&gt;<br><span style="color: #008080;">12</span>     &lt;Button<br><span style="color: #008080;">13</span>         android:id=”@+id/dateButton”<br><span style="color: #008080;">14</span>         android:layout_width=”fill_parent”<br><span style="color: #008080;">15</span>         android:layout_height=”wrap_content”<br><span style="color: #008080;">16</span>         android:text=”设置日期”<br><span style="color: #008080;">17</span>         /&gt;<br><span style="color: #008080;">18</span>     &lt;TextView<br><span style="color: #008080;">19</span>         android:id=”@+id/timeText”<br><span style="color: #008080;">20</span>         android:layout_width=”wrap_content”<br><span style="color: #008080;">21</span>         android:layout_height=”wrap_content”<br><span style="color: #008080;">22</span>         /&gt;<br><span style="color: #008080;">23</span>     &lt;Button<br><span style="color: #008080;">24</span>         android:id=”@+id/timeButton”<br><span style="color: #008080;">25</span>         android:layout_width=”fill_parent”<br><span style="color: #008080;">26</span>         android:layout_height=”wrap_content”<br><span style="color: #008080;">27</span>         android:text=”设置时间”<br><span style="color: #008080;">28</span>         /&gt;<br><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span> &lt;/LinearLayout&gt;</pre><br></div><br></div>

<p>代码：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('f6d9b226-be27-40a2-a3c2-424286c96fac')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_f6d9b226-be27-40a2-a3c2-424286c96fac" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span> com.tiantian.test;<br><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span> java.util.Calendar;<br><span style="color: #008080;">  4</span><br><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span> android.app.Activity;<br><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span> android.app.DatePickerDialog;<br><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span> android.app.DatePickerDialog.OnDateSetListener;<br><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span> android.app.Dialog;<br><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span> android.app.TimePickerDialog;<br><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span> android.app.TimePickerDialog.OnTimeSetListener;<br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span> android.content.Intent;<br><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span> android.graphics.Bitmap;<br><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span> android.graphics.BitmapFactory;<br><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span> android.graphics.Matrix;<br><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">import</span> android.net.Uri;<br><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">import</span> android.os.Bundle;<br><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">import</span> android.os.SystemClock;<br><span style="color: #008080;"> 18</span> <span style="color: #0000ff;">import</span> android.util.DisplayMetrics;<br><span style="color: #008080;"> 19</span> <span style="color: #0000ff;">import</span> android.view.View;<br><span style="color: #008080;"> 20</span> <span style="color: #0000ff;">import</span> android.view.View.OnClickListener;<br><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">import</span> android.widget.Button;<br><span style="color: #008080;"> 22</span> <span style="color: #0000ff;">import</span> android.widget.Chronometer;<br><span style="color: #008080;"> 23</span> <span style="color: #0000ff;">import</span> android.widget.DatePicker;<br><span style="color: #008080;"> 24</span> <span style="color: #0000ff;">import</span> android.widget.DatePicker.OnDateChangedListener;<br><span style="color: #008080;"> 25</span> <span style="color: #0000ff;">import</span> android.widget.ImageView;<br><span style="color: #008080;"> 26</span> <span style="color: #0000ff;">import</span> android.widget.TextView;<br><span style="color: #008080;"> 27</span> <span style="color: #0000ff;">import</span> android.widget.TimePicker;<br><span style="color: #008080;"> 28</span> <span style="color: #0000ff;">import</span> android.widget.TimePicker.OnTimeChangedListener;<br><span style="color: #008080;"> 29</span> <span style="color: #0000ff;">import</span> android.widget.ZoomControls;<br><span style="color: #008080;"> 30</span><br><span style="color: #008080;"> 31</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TextAndridActivity <span style="color: #0000ff;">extends</span> Activity {<br><span style="color: #008080;"> 32</span>     <span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> Called when the activity is first created. </span><span style="color: #008000;">/</span><br><span style="color: #008080;"> 33</span>     <span style="color: #0000ff;">private</span> TextView dateText;<br><span style="color: #008080;"> 34</span>     <span style="color: #0000ff;">private</span> TextView timeText;<br><span style="color: #008080;"> 35</span>     <span style="color: #0000ff;">private</span> Button dateButton;<br><span style="color: #008080;"> 36</span>     <span style="color: #0000ff;">private</span> Button timeButton;<br><span style="color: #008080;"> 37</span><br><span style="color: #008080;"> 38</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> year;<br><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> monthOfYear;<br><span style="color: #008080;"> 40</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> dayOfMonth;<br><span style="color: #008080;"> 41</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> hour;<br><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> minute;<br><span style="color: #008080;"> 43</span>     <span style="color: #008000;">//</span><span style="color: #008000;">声明一个独一无二的标识，来作为要显示DatePicker的Dialog的ID</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 44</span>     <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> DATE_DIALOG_ID = 1;<br><span style="color: #008080;"> 45</span>     <span style="color: #008000;">//</span><span style="color: #008000;">声明一个独一无二的标识，来作为要显示TimePicker的Dialog的ID</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 46</span>     <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> TIME_DIALOG_ID = 2;<br><span style="color: #008080;"> 47</span>     @Override<br><span style="color: #008080;"> 48</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCreate(Bundle savedInstanceState) {<br><span style="color: #008080;"> 49</span>         <span style="color: #0000ff;">super</span>.onCreate(savedInstanceState);<br><span style="color: #008080;"> 50</span>         setContentView(R.layout.main);<br><span style="color: #008080;"> 51</span><br><span style="color: #008080;"> 52</span>         dateText = (TextView) findViewById(R.id.dateText);<br><span style="color: #008080;"> 53</span>         timeText = (TextView) findViewById(R.id.timeText);<br><span style="color: #008080;"> 54</span>         dateButton = (Button) findViewById(R.id.dateButton);<br><span style="color: #008080;"> 55</span>         dateButton.setOnClickListener(<span style="color: #0000ff;">new</span> OnClickListener() {<br><span style="color: #008080;"> 56</span><br><span style="color: #008080;"> 57</span>             @Override<br><span style="color: #008080;"> 58</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onClick(View v) {<br><span style="color: #008080;"> 59</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">调用Activity类的方法来显示Dialog:调用这个方法会允许Activity管理该Dialog的生命周期，<br></span><span style="color: #008080;"> 60</span> <span style="color: #008000;">//</span><span style="color: #008000;">并会调用 onCreateDialog(int)回调函数来请求一个Dialog</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 61</span>                 showDialog(DATE_DIALOG_ID);<br><span style="color: #008080;"> 62</span>             }<br><span style="color: #008080;"> 63</span>         });<br><span style="color: #008080;"> 64</span>         timeButton = (Button) findViewById(R.id.timeButton);<br><span style="color: #008080;"> 65</span>         timeButton.setOnClickListener(<span style="color: #0000ff;">new</span> OnClickListener() {<br><span style="color: #008080;"> 66</span><br><span style="color: #008080;"> 67</span>             @Override<br><span style="color: #008080;"> 68</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onClick(View v) {<br><span style="color: #008080;"> 69</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">调用Activity类的方法来显示Dialog:调用这个方法会允许Activity管理该Dialog的生命周期，<br></span><span style="color: #008080;"> 70</span> <span style="color: #008000;">//</span><span style="color: #008000;">并会调用 onCreateDialog(int)回调函数来请求一个Dialog</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 71</span>                 showDialog(TIME_DIALOG_ID);<br><span style="color: #008080;"> 72</span>             }<br><span style="color: #008080;"> 73</span>         });<br><span style="color: #008080;"> 74</span>         <span style="color: #008000;">//</span><span style="color: #008000;">得到当前日期和时间(作为初始值)</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 75</span>         Calendar calendar = Calendar.getInstance();<br><span style="color: #008080;"> 76</span>         year = calendar.get(Calendar.YEAR);<br><span style="color: #008080;"> 77</span>         monthOfYear = calendar.get(Calendar.MONTH);<br><span style="color: #008080;"> 78</span>         dayOfMonth = calendar.get(Calendar.DAY_OF_MONTH);<br><span style="color: #008080;"> 79</span>         hour = calendar.get(Calendar.HOUR_OF_DAY);<br><span style="color: #008080;"> 80</span>         minute = calendar.get(Calendar.MINUTE);<br><span style="color: #008080;"> 81</span><br><span style="color: #008080;"> 82</span>     }<br><span style="color: #008080;"> 83</span><br><span style="color: #008080;"> 84</span>     <span style="color: #008000;">//</span><span style="color: #008000;">当Activity调用showDialog函数时会触发该函数的调用：</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 85</span>     @Override<br><span style="color: #008080;"> 86</span>     <span style="color: #0000ff;">protected</span> Dialog onCreateDialog(<span style="color: #0000ff;">int</span> id) {<br><span style="color: #008080;"> 87</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 88</span>         <span style="color: #0000ff;">switch</span>(id){<br><span style="color: #008080;"> 89</span>         <span style="color: #0000ff;">case</span> DATE_DIALOG_ID:<br><span style="color: #008080;"> 90</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> DatePickerDialog(<span style="color: #0000ff;">this</span>, <span style="color: #0000ff;">new</span> OnDateSetListener() {<br><span style="color: #008080;"> 91</span><br><span style="color: #008080;"> 92</span>                 @Override<br><span style="color: #008080;"> 93</span>                 <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onDateSet(DatePicker view, <span style="color: #0000ff;">int</span> year, <span style="color: #0000ff;">int</span> monthOfYear,<br><span style="color: #008080;"> 94</span>                         <span style="color: #0000ff;">int</span> dayOfMonth) {<br><span style="color: #008080;"> 95</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 96</span>                     dateText.setText(year + “年” + (monthOfYear + 1) + “月” + dayOfMonth + “日”);<br><span style="color: #008080;"> 97</span>                 }<br><span style="color: #008080;"> 98</span>             }, year, monthOfYear, dayOfMonth);<br><span style="color: #008080;"> 99</span>         <span style="color: #0000ff;">case</span> TIME_DIALOG_ID:<br><span style="color: #008080;">100</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> TimePickerDialog(<span style="color: #0000ff;">this</span>, <span style="color: #0000ff;">new</span> OnTimeSetListener() {<br><span style="color: #008080;">101</span><br><span style="color: #008080;">102</span>                 @Override<br><span style="color: #008080;">103</span>                 <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onTimeSet(TimePicker view, <span style="color: #0000ff;">int</span> hourOfDay, <span style="color: #0000ff;">int</span> minute) {<br><span style="color: #008080;">104</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">105</span>                     timeText.setText(hourOfDay + “时” + minute + “分”);<br><span style="color: #008080;">106</span>                 }<br><span style="color: #008080;">107</span>             }, hour, minute, <span style="color: #0000ff;">true</span>);<br><span style="color: #008080;">108</span>         }<br><span style="color: #008080;">109</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span>;<br><span style="color: #008080;">110</span>     }<br><span style="color: #008080;">111</span><br><span style="color: #008080;">112</span><br><span style="color: #008080;">113</span><br><span style="color: #008080;">114</span> }</pre><br></div><br></div>

]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> DatePicker </tag>
            
            <tag> TimePicker </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Android通过VideoView实现视频播放]]></title>
      <url>/2012/03/01/Android%E9%80%9A%E8%BF%87VideoView%E5%AE%9E%E7%8E%B0%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE/</url>
      <content type="html"><![CDATA[<p>在Android系统中，是通过MediaPalyer类播放媒体文件的（包括视频和音频）。虽然这个类已经比较简单了，但是还需要控制各种状态，对于视频还需要设置输出窗口，还是需要仔细研究的。为了避免这些麻烦事儿，Android框架提供了VideoView类来封装MediaPalyer，这个VideoView类非常好用。Android自带的程序Gallery也是用VideoView实现的。本文以实例介绍怎样用VideoView来实现VideoPlayer，本文也参考了Android自带程序Gallery的实现。</p>
<p><span>创建一个VideoPlayer的工程。main.xml文件如下：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 3</span> <span style="color: #ff0000;">    android:orientation</span><span style="color: #0000ff;">=”vertical”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">    android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">    android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">VideoView </span><span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/video_view”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 8</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 9</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">10</span> <span style="color: #ff0000;">            android:layout_centerInParent</span><span style="color: #0000ff;">=”true”</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p><span><span>VideoPlayer.java文件如下：</span></span></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('2921b33f-64c6-4bde-a0dd-3a775ab970fa')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_2921b33f-64c6-4bde-a0dd-3a775ab970fa" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span> com.simon;<br><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span> android.app.Activity;<br><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span> android.media.MediaPlayer;<br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span> android.net.Uri;<br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span> android.os.Bundle;<br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span> android.os.Environment;<br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span> android.util.Log;<br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span> android.widget.MediaController;<br><span style="color: #008080;">10</span> <span style="color: #0000ff;">import</span> android.widget.VideoView;<br><span style="color: #008080;">11</span> <span style="color: #0000ff;">import</span> android.content.pm.ActivityInfo;<br><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> VideoPlayer <span style="color: #0000ff;">extends</span> Activity <span style="color: #0000ff;">implements</span> MediaPlayer.OnErrorListener,<br><span style="color: #008080;">14</span>         MediaPlayer.OnCompletionListener {<br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “VideoPlayer”;<br><span style="color: #008080;">16</span>     <span style="color: #0000ff;">private</span> VideoView mVideoView;<br><span style="color: #008080;">17</span>     <span style="color: #0000ff;">private</span> Uri mUri;<br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> mPositionWhenPaused = -1;<br><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>     <span style="color: #0000ff;">private</span> MediaController mMediaController;<br><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span>     <span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> Called when the activity is first created. </span><span style="color: #008000;">/</span><br><span style="color: #008080;">23</span>     @Override<br><span style="color: #008080;">24</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCreate(Bundle savedInstanceState) {<br><span style="color: #008080;">25</span>         <span style="color: #0000ff;">super</span>.onCreate(savedInstanceState);<br><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span>         setContentView(R.layout.main);<br><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span>         <span style="color: #008000;">//</span><span style="color: #008000;">Set the screen to landscape.</span><span style="color: #008000;"><br></span><span style="color: #008080;">30</span>         <span style="color: #0000ff;">this</span>.setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE);<br><span style="color: #008080;">31</span><br><span style="color: #008080;">32</span>         mVideoView = (VideoView)findViewById(R.id.video_view);<br><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span>         <span style="color: #008000;">//</span><span style="color: #008000;">Video file</span><span style="color: #008000;"><br></span><span style="color: #008080;">35</span>         mUri = Uri.parse(Environment.getExternalStorageDirectory() + “/1.3gp”);<br><span style="color: #008080;">36</span><br><span style="color: #008080;">37</span>         <span style="color: #008000;">//</span><span style="color: #008000;">Create media controller</span><span style="color: #008000;"><br></span><span style="color: #008080;">38</span>         mMediaController = <span style="color: #0000ff;">new</span> MediaController(<span style="color: #0000ff;">this</span>);<br><span style="color: #008080;">39</span>         mVideoView.setMediaController(mMediaController);<br><span style="color: #008080;">40</span>     }<br><span style="color: #008080;">41</span><br><span style="color: #008080;">42</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onStart() {<br><span style="color: #008080;">43</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> Play Video</span><span style="color: #008000;"><br></span><span style="color: #008080;">44</span>         mVideoView.setVideoURI(mUri);<br><span style="color: #008080;">45</span>         mVideoView.start();<br><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span>         <span style="color: #0000ff;">super</span>.onStart();<br><span style="color: #008080;">48</span>     }<br><span style="color: #008080;">49</span><br><span style="color: #008080;">50</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onPause() {<br><span style="color: #008080;">51</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> Stop video when the activity is pause.</span><span style="color: #008000;"><br></span><span style="color: #008080;">52</span>         mPositionWhenPaused = mVideoView.getCurrentPosition();<br><span style="color: #008080;">53</span>         mVideoView.stopPlayback();<br><span style="color: #008080;">54</span>         Log.d(TAG, “OnStop: mPositionWhenPaused = “ + mPositionWhenPaused);<br><span style="color: #008080;">55</span>         Log.d(TAG, “OnStop: getDuration  = “ + mVideoView.getDuration());<br><span style="color: #008080;">56</span><br><span style="color: #008080;">57</span>         <span style="color: #0000ff;">super</span>.onPause();<br><span style="color: #008080;">58</span>     }<br><span style="color: #008080;">59</span><br><span style="color: #008080;">60</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onResume() {<br><span style="color: #008080;">61</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> Resume video player</span><span style="color: #008000;"><br></span><span style="color: #008080;">62</span>         <span style="color: #0000ff;">if</span>(mPositionWhenPaused &gt;= 0) {<br><span style="color: #008080;">63</span>             mVideoView.seekTo(mPositionWhenPaused);<br><span style="color: #008080;">64</span>             mPositionWhenPaused = -1;<br><span style="color: #008080;">65</span>         }<br><span style="color: #008080;">66</span><br><span style="color: #008080;">67</span>         <span style="color: #0000ff;">super</span>.onResume();<br><span style="color: #008080;">68</span>     }<br><span style="color: #008080;">69</span><br><span style="color: #008080;">70</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span> onError(MediaPlayer player, <span style="color: #0000ff;">int</span> arg1, <span style="color: #0000ff;">int</span> arg2) {<br><span style="color: #008080;">71</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span>;<br><span style="color: #008080;">72</span>     }<br><span style="color: #008080;">73</span><br><span style="color: #008080;">74</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCompletion(MediaPlayer mp) {<br><span style="color: #008080;">75</span>         <span style="color: #0000ff;">this</span>.finish();<br><span style="color: #008080;">76</span>     }<br><span style="color: #008080;">77</span> }</pre><br></div><br></div>

<p><span><span><span>本例中只是播放外存储器（一般是sd卡）上的1.3gp文件。在onCreate方法中创建了Media control，这个组件可以控制视频的播放，暂停，回复，seek等操作，不需要你实现。</span></span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> mMediaController = <span style="color: #0000ff;">new</span> MediaController(<span style="color: #0000ff;">this</span>);<br><span style="color: #008080;">2</span> mVideoView.setMediaController(mMediaController);</pre><br></div>

<p>然后只需要调用VideoView类的setVideoURI设置播放文件，start方法开始播放即可。 为了节省系统资源，一般需要在Activity的onPause方法中，暂停视频的播放。因为Activity已经不在前台了。在Activity的onResume中恢复视频的播放，因为这是Activity又变成前台程序了。不清楚的朋友可以去查看Activity lifecycle。 你可以通过实现MediaPlayer.OnErrorListener来监听MediaPlayer上报的错误信息。实现MediaPlayer.OnCompletionListener接口，将会在Video播完的时候得到通知，本例只是简单的结束程序。 你可能注意到，我们没有管理MediaPalyer的各种状态，这些状态都让VideoView给封装了，并且，当VideoView创建的时候，MediaPalyer对象将会创建，当VideoView对象销毁的时候，MediaPlayer对象将会释放。这样基本可以傻瓜式的实现媒体播放器了，太Easy了吧。</p>
<p><span><br></span></p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> VideoView </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[android通过BroadcastReceiver拦截短信转发]]></title>
      <url>/2012/03/01/android%E9%80%9A%E8%BF%87BroadcastReceiver%E6%8B%A6%E6%88%AA%E7%9F%AD%E4%BF%A1%E8%BD%AC%E5%8F%91/</url>
      <content type="html"><![CDATA[<p>通过BroadcastReceiver拦截短信转发，技术讨论 大家不要做坏事哦</p>
<p>先看布局：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('0e52c0a9-f753-4488-a738-51d5f1571488')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_0e52c0a9-f753-4488-a738-51d5f1571488" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 3</span> <span style="color: #ff0000;">    android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">    android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">    android:orientation</span><span style="color: #0000ff;">=”vertical”</span> <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">EditText<br></span><span style="color: #008080;"> 8</span> <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/sendToId”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 9</span> <span style="color: #ff0000;">        android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">10</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">11</span> <span style="color: #ff0000;">        android:paddingLeft</span><span style="color: #0000ff;">=”5dp”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">12</span> <span style="color: #ff0000;">        android:layout_marginLeft</span><span style="color: #0000ff;">=”10dp”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">13</span> <span style="color: #ff0000;">        android:layout_marginRight</span><span style="color: #0000ff;">=”10dp”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">14</span> <span style="color: #ff0000;">        android:layout_marginTop</span><span style="color: #0000ff;">=”5dp”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">15</span> <span style="color: #ff0000;">        android:inputType</span><span style="color: #0000ff;">=”phone”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">16</span> <span style="color: #ff0000;">        android:hint</span><span style="color: #0000ff;">=”填写需要转发到的号码”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">17</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RelativeLayout<br></span><span style="color: #008080;">19</span> <span style="color: #ff0000;">android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">20</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">21</span> <span style="color: #ff0000;">        android:orientation</span><span style="color: #0000ff;">=”horizontal”</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">22</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextView<br></span><span style="color: #008080;">23</span> <span style="color: #ff0000;">android:layout_width</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">24</span> <span style="color: #ff0000;">                android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">25</span> <span style="color: #ff0000;">                android:layout_marginTop</span><span style="color: #0000ff;">=”10dp”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">26</span> <span style="color: #ff0000;">                android:layout_marginLeft</span><span style="color: #0000ff;">=”10dp”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">27</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”是否开启本机接收:”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">28</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">29</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">ToggleButton<br></span><span style="color: #008080;">30</span> <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/togId”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">31</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">32</span> <span style="color: #ff0000;">                android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">33</span> <span style="color: #ff0000;">                android:layout_alignParentRight</span><span style="color: #0000ff;">=”true”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">34</span> <span style="color: #ff0000;">                android:layout_marginRight</span><span style="color: #0000ff;">=”20dp”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">35</span> <span style="color: #ff0000;">                android:textOn</span><span style="color: #0000ff;">=”ON”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">36</span> <span style="color: #ff0000;">                android:textOff</span><span style="color: #0000ff;">=”OFF”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">37</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">38</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">RelativeLayout</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">39</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Button<br></span><span style="color: #008080;">40</span> <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/saveBtId”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">41</span> <span style="color: #ff0000;">        android:layout_width</span><span style="color: #0000ff;">=”100dp”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">42</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">43</span> <span style="color: #ff0000;">        android:layout_gravity</span><span style="color: #0000ff;">=”center_horizontal”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">44</span> <span style="color: #ff0000;">        android:text</span><span style="color: #0000ff;">=”确定”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">45</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div><br></div>

<p>主Activity：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('50ceaf4e-8e39-40b5-a1e8-7b6899c22f11')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_50ceaf4e-8e39-40b5-a1e8-7b6899c22f11" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span> tiantian.Package;<br><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span> android.app.Activity;<br><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span> android.content.Intent;<br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span> android.os.Bundle;<br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span> android.view.View;<br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span> android.widget.Button;<br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span> android.widget.CompoundButton;<br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span> android.widget.CompoundButton.OnCheckedChangeListener;<br><span style="color: #008080;">10</span> <span style="color: #0000ff;">import</span> android.widget.EditText;<br><span style="color: #008080;">11</span> <span style="color: #0000ff;">import</span> android.widget.Toast;<br><span style="color: #008080;">12</span> <span style="color: #0000ff;">import</span> android.widget.ToggleButton;<br><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> SMSReceiverActivity <span style="color: #0000ff;">extends</span> Activity {<br><span style="color: #008080;">15</span>     <span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> Called when the activity is first created. </span><span style="color: #008000;">/</span><br><span style="color: #008080;">16</span>     <span style="color: #0000ff;">private</span> EditText et;<br><span style="color: #008080;">17</span>     <span style="color: #0000ff;">private</span> Button saveBt;<br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">private</span> ToggleButton toBt;<br><span style="color: #008080;">19</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isChecked = <span style="color: #0000ff;">false</span>;<br><span style="color: #008080;">20</span>     @Override<br><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCreate(Bundle savedInstanceState) {<br><span style="color: #008080;">22</span>         <span style="color: #0000ff;">super</span>.onCreate(savedInstanceState);<br><span style="color: #008080;">23</span>         setContentView(R.layout.main);<br><span style="color: #008080;">24</span>         et = (EditText) findViewById(R.id.sendToId);<br><span style="color: #008080;">25</span>         toBt = (ToggleButton) findViewById(R.id.togId);<br><span style="color: #008080;">26</span>         toBt.setOnCheckedChangeListener(<span style="color: #0000ff;">new</span> OnCheckedChangeListener() {<br><span style="color: #008080;">27</span><br><span style="color: #008080;">28</span>             @Override<br><span style="color: #008080;">29</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCheckedChanged(CompoundButton buttonView, <span style="color: #0000ff;">boolean</span> isChecked) {<br><span style="color: #008080;">30</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">31</span>                 <span style="color: #0000ff;">if</span>(isChecked){<br><span style="color: #008080;">32</span>                     SMSReceiverActivity.<span style="color: #0000ff;">this</span>.isChecked = isChecked;<br><span style="color: #008080;">33</span>                 }<br><span style="color: #008080;">34</span>             }<br><span style="color: #008080;">35</span>         });<br><span style="color: #008080;">36</span>         saveBt = (Button) findViewById(R.id.saveBtId);<br><span style="color: #008080;">37</span>         saveBt.setOnClickListener(<span style="color: #0000ff;">new</span> View.OnClickListener() {<br><span style="color: #008080;">38</span><br><span style="color: #008080;">39</span>             @Override<br><span style="color: #008080;">40</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onClick(View v) {<br><span style="color: #008080;">41</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">42</span>                 Intent intent = <span style="color: #0000ff;">new</span> Intent();<br><span style="color: #008080;">43</span>                 intent.setAction(“com.tiantian.SEND_TO”);<br><span style="color: #008080;">44</span>                 intent.putExtra(“_sendTo”, et.getText().toString());<br><span style="color: #008080;">45</span>                 intent.putExtra(“_isChecked”, isChecked);<br><span style="color: #008080;">46</span>                 sendBroadcast(intent);<br><span style="color: #008080;">47</span>                 Toast.makeText(SMSReceiverActivity.<span style="color: #0000ff;">this</span>, “已成功绑定”, Toast.LENGTH_SHORT).show();<br><span style="color: #008080;">48</span>             }<br><span style="color: #008080;">49</span>         });<br><span style="color: #008080;">50</span><br><span style="color: #008080;">51</span>     }<br><span style="color: #008080;">52</span><br><span style="color: #008080;">53</span><br><span style="color: #008080;">54</span> }</pre><br></div><br></div>

<p>&nbsp;</p>
<p>BroadcastReceiver类继承BroadcastReceiver：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('3532e2e5-486d-456b-b0c5-8f3218d89fcf')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_3532e2e5-486d-456b-b0c5-8f3218d89fcf" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span> tiantian.Package;<br><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span> java.sql.Date;<br><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span> java.text.SimpleDateFormat;<br><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span> android.content.BroadcastReceiver;<br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span> android.content.Context;<br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span> android.content.Intent;<br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span> android.telephony.SmsManager;<br><span style="color: #008080;">10</span> <span style="color: #0000ff;">import</span> android.telephony.SmsMessage;<br><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> SMSReceiverSend <span style="color: #0000ff;">extends</span> BroadcastReceiver{<br><span style="color: #008080;">13</span>     <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String SMS_ACTION = “android.provider.Telephony.SMS_RECEIVED”;<br><span style="color: #008080;">14</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> String sendToNum = “1234”;<br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">boolean</span> isChecked = <span style="color: #0000ff;">false</span>;<br><span style="color: #008080;">16</span>     @Override<br><span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onReceive(Context content, Intent intent) {<br><span style="color: #008080;">18</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">19</span>         <span style="color: #0000ff;">if</span>(intent.getAction().equals(“com.tiantian.SEND_TO”)){<br><span style="color: #008080;">20</span>             sendToNum = intent.getStringExtra(“_sendTo”);<br><span style="color: #008080;">21</span>             isChecked = intent.getBooleanExtra(“_isChecked”, isChecked);<br><span style="color: #008080;">22</span>         }<span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(intent.getAction().equals(SMS_ACTION)){<br><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span>         Object[] pdus = (Object[])intent.getExtras().get(“pdus”);<br><span style="color: #008080;">25</span>         <span style="color: #0000ff;">if</span>(pdus != <span style="color: #0000ff;">null</span> &amp;&amp; pdus.length != 0){<br><span style="color: #008080;">26</span>             SmsMessage[] messages = <span style="color: #0000ff;">new</span> SmsMessage[pdus.length];<br><span style="color: #008080;">27</span>             <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i=0;i&lt;pdus.length;i++){<br><span style="color: #008080;">28</span>                 <span style="color: #0000ff;">byte</span>[] pdu = (<span style="color: #0000ff;">byte</span>[])pdus[i];<br><span style="color: #008080;">29</span>                 messages[i] = SmsMessage.createFromPdu(pdu);<br><span style="color: #008080;">30</span>             }<br><span style="color: #008080;">31</span>             <span style="color: #0000ff;">for</span>(SmsMessage message : messages){<br><span style="color: #008080;">32</span>                 String messageBody = message.getMessageBody();<br><span style="color: #008080;">33</span>                 String sender = message.getOriginatingAddress();<br><span style="color: #008080;">34</span>                 <span style="color: #0000ff;">if</span>(isChecked == <span style="color: #0000ff;">false</span>){<br><span style="color: #008080;">35</span>                     abortBroadcast();<span style="color: #008000;">//</span><span style="color: #008000;"> 中止发送</span><span style="color: #008000;"><br></span><span style="color: #008080;">36</span>                 }<br><span style="color: #008080;">37</span>                     Date date = <span style="color: #0000ff;">new</span> Date(message.getTimestampMillis());<br><span style="color: #008080;">38</span>                     SimpleDateFormat format = <span style="color: #0000ff;">new</span> SimpleDateFormat(“yyyy-MM-dd HH:mm:ss”);<br><span style="color: #008080;">39</span>                     String sendContent = “date:” + format.format(date) + “\n”<br><span style="color: #008080;">40</span>                             + “sender:” + sender + “\n” + “messageBody:”  + messageBody;<br><span style="color: #008080;">41</span>                     SmsManager smsManager = SmsManager.getDefault();<br><span style="color: #008080;">42</span>                     smsManager.sendTextMessage(sendToNum, <span style="color: #0000ff;">null</span>, sendContent, <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span>);<br><span style="color: #008080;">43</span>             }<br><span style="color: #008080;">44</span>         }<br><span style="color: #008080;">45</span><br><span style="color: #008080;">46</span>     }<br><span style="color: #008080;">47</span>     }<br><span style="color: #008080;">48</span><br><span style="color: #008080;">49</span> }</pre><br></div><br></div>

<p>&nbsp;</p>
<p>AndroidManifest.xml:</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('c79663a9-77ae-40ba-ab43-4c3a21ccaf22')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><span class="cnblogs_code_collapse">View Code </span><br><div id="cnblogs_code_open_c79663a9-77ae-40ba-ab43-4c3a21ccaf22" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">manifest </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 3</span> <span style="color: #ff0000;">    package</span><span style="color: #0000ff;">=”tiantian.Package”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">    android:versionCode</span><span style="color: #0000ff;">=”1”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">    android:versionName</span><span style="color: #0000ff;">=”1.0”</span> <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">uses-sdk </span><span style="color: #ff0000;">android:minSdkVersion</span><span style="color: #0000ff;">=”8”</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">application<br></span><span style="color: #008080;">10</span> <span style="color: #ff0000;">android:icon</span><span style="color: #0000ff;">=”@drawable/ic_launcher”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">11</span> <span style="color: #ff0000;">        android:label</span><span style="color: #0000ff;">=”@string/app_name”</span> <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">12</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">activity<br></span><span style="color: #008080;">13</span> <span style="color: #ff0000;">android:label</span><span style="color: #0000ff;">=”@string/app_name”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">14</span> <span style="color: #ff0000;">            android:name</span><span style="color: #0000ff;">=”.SMSReceiverActivity”</span> <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">15</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">intent-filter </span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">16</span>                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">action </span><span style="color: #ff0000;">android:name</span><span style="color: #0000ff;">=”android.intent.action.MAIN”</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">category </span><span style="color: #ff0000;">android:name</span><span style="color: #0000ff;">=”android.intent.category.LAUNCHER”</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">19</span>             <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">intent-filter</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">20</span>         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">activity</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">receiver </span><span style="color: #ff0000;">android:label</span><span style="color: #0000ff;">=”@string/app_name”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">23</span> <span style="color: #ff0000;">                  android:name</span><span style="color: #0000ff;">=”.SMSReceiverSend”</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">24</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">intent-filter </span><span style="color: #ff0000;">android:priority</span><span style="color: #0000ff;">=”1000”</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">25</span>                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">action </span><span style="color: #ff0000;">android:name</span><span style="color: #0000ff;">=”android.provider.Telephony.SMS_RECEIVED”</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">26</span>                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">action </span><span style="color: #ff0000;">android:name</span><span style="color: #0000ff;">=”com.tiantian.SEND_TO”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">27</span>                 <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">category </span><span style="color: #ff0000;">android:name</span><span style="color: #0000ff;">=”android.intent.category.DEFAULT”</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">28</span>             <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">intent-filter</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">29</span>         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">receiver</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">application</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">32</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">uses-permission </span><span style="color: #ff0000;">android:name</span><span style="color: #0000ff;">=”android.permission.RECEIVE_SMS”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">33</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">uses-permission </span><span style="color: #ff0000;">android:name</span><span style="color: #0000ff;">=”android.permission.SEND_SMS”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">34</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">uses-permission </span><span style="color: #ff0000;">android:name</span><span style="color: #0000ff;">=”android.permission.RECEIVE_BOOT_COMPLETED”</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">35</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">manifest</span><span style="color: #0000ff;">&gt;</span></pre><br></div><br></div>

]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> BroadcastReceiver </tag>
            
            <tag> SMS </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[用RadioGroup来自定义TabHost+Gallery应用]]></title>
      <url>/2012/02/24/%E7%94%A8RadioGroup%E6%9D%A5%E8%87%AA%E5%AE%9A%E4%B9%89TabHost-Gallery%E5%BA%94%E7%94%A8/</url>
      <content type="html"><![CDATA[<p><strong>效果图：</strong></p>
<p><img src="http://pic002.cnblogs.com/images/2012/378300/2012022410541464.jpg" alt=""></p>
<p>&nbsp;</p>
<p><strong>思路：**</strong>用RadioGroup来自定义Tab（当然用其他的ImageButton等也可以实现）**</p>
<p>mainActivity代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span> com.tiantian.test;<br><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span> android.app.TabActivity;<br><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span> android.content.Context;<br><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span> android.content.Intent;<br><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span> android.content.res.TypedArray;<br><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span> android.os.Bundle;<br><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span> android.os.Handler;<br><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span> android.os.Message;<br><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span> android.view.View;<br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span> android.view.ViewGroup;<br><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span> android.widget.BaseAdapter;<br><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span> android.widget.Gallery;<br><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span> android.widget.ImageView;<br><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">import</span> android.widget.RadioButton;<br><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">import</span> android.widget.RadioGroup;<br><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">import</span> android.widget.TabHost;<br><span style="color: #008080;"> 18</span><br><span style="color: #008080;"> 19</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TabDemoActivity <span style="color: #0000ff;">extends</span> TabActivity {<br><span style="color: #008080;"> 20</span>     <span style="color: #008000;">/<em>*</em></span><span style="color: #008000;"> Called when the activity is first created. </span><span style="color: #008000;">/</span><br><span style="color: #008080;"> 21</span>     TabHost tab;<br><span style="color: #008080;"> 22</span>     RadioGroup tab_radioGroup;<br><span style="color: #008080;"> 23</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span>[] images = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">int</span>[]{<br><span style="color: #008080;"> 24</span>             R.drawable.g1,R.drawable.g2,R.drawable.g3,<br><span style="color: #008080;"> 25</span>             R.drawable.g4,R.drawable.g5,R.drawable.g6<br><span style="color: #008080;"> 26</span>     };<br><span style="color: #008080;"> 27</span>     @Override<br><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCreate(Bundle savedInstanceState) {<br><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">super</span>.onCreate(savedInstanceState);<br><span style="color: #008080;"> 30</span>         setContentView(R.layout.main);<br><span style="color: #008080;"> 31</span>         Gallery gallery = (Gallery)findViewById(R.id.gallery);<br><span style="color: #008080;"> 32</span>         gallery.setAdapter(<span style="color: #0000ff;">new</span> ImageAdapter(<span style="color: #0000ff;">this</span>));<br><span style="color: #008080;"> 33</span><br><span style="color: #008080;"> 34</span>         tab = getTabHost();<br><span style="color: #008080;"> 35</span>         tab.addTab(tab.newTabSpec(“Spec-TabList”)<br><span style="color: #008080;"> 36</span>                 .setIndicator(“Ind-TabList”)<br><span style="color: #008080;"> 37</span>                 .setContent(<span style="color: #0000ff;">new</span> Intent(<span style="color: #0000ff;">this</span>, TabList.<span style="color: #0000ff;">class</span>)));<br><span style="color: #008080;"> 38</span>         tab.addTab(tab.newTabSpec(“Spec-secondDemo”)<br><span style="color: #008080;"> 39</span>                 .setIndicator(“Ind-secondDemo”)<br><span style="color: #008080;"> 40</span>                 .setContent(<span style="color: #0000ff;">new</span> Intent(<span style="color: #0000ff;">this</span>, secondDemo.<span style="color: #0000ff;">class</span>)));<br><span style="color: #008080;"> 41</span>         tab.addTab(tab.newTabSpec(“Spec-thirdDemo”)<br><span style="color: #008080;"> 42</span>                 .setIndicator(“Ind-thirdDemo”)<br><span style="color: #008080;"> 43</span>                 .setContent(<span style="color: #0000ff;">new</span> Intent(<span style="color: #0000ff;">this</span>, thirdDemo.<span style="color: #0000ff;">class</span>)));<br><span style="color: #008080;"> 44</span>         tab.addTab(tab.newTabSpec(“Spec-fourthDemo”)<br><span style="color: #008080;"> 45</span>                 .setIndicator(“Ind-fourthDemo”)<br><span style="color: #008080;"> 46</span>                 .setContent(<span style="color: #0000ff;">new</span> Intent(<span style="color: #0000ff;">this</span>, fourthDemo.<span style="color: #0000ff;">class</span>)));<br><span style="color: #008080;"> 47</span>         tab.addTab(tab.newTabSpec(“Spec-fifthDemo”)<br><span style="color: #008080;"> 48</span>                 .setIndicator(“Ind-fifthDemo”)<br><span style="color: #008080;"> 49</span>                 .setContent(<span style="color: #0000ff;">new</span> Intent(<span style="color: #0000ff;">this</span>, fifthDemo.<span style="color: #0000ff;">class</span>)));<br><span style="color: #008080;"> 50</span><br><span style="color: #008080;"> 51</span>         tab_radioGroup = (RadioGroup)findViewById(R.id.tab_radiogroup);<br><span style="color: #008080;"> 52</span>         tab_radioGroup.setOnCheckedChangeListener(<span style="color: #0000ff;">new</span> RadioGroup.OnCheckedChangeListener() {<br><span style="color: #008080;"> 53</span><br><span style="color: #008080;"> 54</span>             @Override<br><span style="color: #008080;"> 55</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCheckedChanged(RadioGroup group, <span style="color: #0000ff;">int</span> checkedId) {<br><span style="color: #008080;"> 56</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 57</span>                 <span style="color: #0000ff;">switch</span>(checkedId){<br><span style="color: #008080;"> 58</span>                 <span style="color: #0000ff;">case</span> R.id.radioButton0:<br><span style="color: #008080;"> 59</span>                     tab.setCurrentTabByTag(“Spec-TabList”);<br><span style="color: #008080;"> 60</span>                     <span style="color: #0000ff;">break</span>;<br><span style="color: #008080;"> 61</span>                 <span style="color: #0000ff;">case</span> R.id.radioButton1:<br><span style="color: #008080;"> 62</span>                     tab.setCurrentTabByTag(“Spec-secondDemo”);<br><span style="color: #008080;"> 63</span>                     <span style="color: #0000ff;">break</span>;<br><span style="color: #008080;"> 64</span>                 <span style="color: #0000ff;">case</span> R.id.radioButton2:<br><span style="color: #008080;"> 65</span>                     tab.setCurrentTabByTag(“Spec-thirdDemo”);<br><span style="color: #008080;"> 66</span>                     <span style="color: #0000ff;">break</span>;<br><span style="color: #008080;"> 67</span>                 <span style="color: #0000ff;">case</span> R.id.radioButton3:<br><span style="color: #008080;"> 68</span>                     tab.setCurrentTabByTag(“Spec-fourthDemo”);<br><span style="color: #008080;"> 69</span>                     <span style="color: #0000ff;">break</span>;<br><span style="color: #008080;"> 70</span>                 <span style="color: #0000ff;">case</span> R.id.radioButton4:<br><span style="color: #008080;"> 71</span>                     tab.setCurrentTabByTag(“Spec-fifthDemo”);<br><span style="color: #008080;"> 72</span>                     <span style="color: #0000ff;">break</span>;<br><span style="color: #008080;"> 73</span>                 }<br><span style="color: #008080;"> 74</span>             }<br><span style="color: #008080;"> 75</span>         });<br><span style="color: #008080;"> 76</span>         <span style="color: #008000;">//</span><span style="color: #008000;">使他初始化后聚焦在第一个RadioGroup对象</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 77</span>         ((RadioButton) tab_radioGroup.getChildAt(0)).toggle();<br><span style="color: #008080;"> 78</span><br><span style="color: #008080;"> 79</span>     }<br><span style="color: #008080;"> 80</span><br><span style="color: #008080;"> 81</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> ImageAdapter <span style="color: #0000ff;">extends</span> BaseAdapter{<br><span style="color: #008080;"> 82</span>         <span style="color: #0000ff;">private</span> Context context;<br><span style="color: #008080;"> 83</span> <span style="color: #008000;">//</span><span style="color: #008000;">        private int[] images = new int[]{<br></span><span style="color: #008080;"> 84</span> <span style="color: #008000;">//</span><span style="color: #008000;">                R.drawable.g1,R.drawable.g2,R.drawable.g3,<br></span><span style="color: #008080;"> 85</span> <span style="color: #008000;">//</span><span style="color: #008000;">                R.drawable.g4,R.drawable.g5,R.drawable.g6<br></span><span style="color: #008080;"> 86</span> <span style="color: #008000;">//</span><span style="color: #008000;">        };</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 87</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> mGalleryItemBackground;<br><span style="color: #008080;"> 88</span>         <span style="color: #0000ff;">public</span> ImageAdapter(Context context) {<br><span style="color: #008080;"> 89</span>             <span style="color: #0000ff;">super</span>();<br><span style="color: #008080;"> 90</span>             <span style="color: #0000ff;">this</span>.context = context;<br><span style="color: #008080;"> 91</span>             TypedArray a = obtainStyledAttributes(R.styleable.Gallery);<br><span style="color: #008080;"> 92</span>             mGalleryItemBackground = a.getResourceId(R.styleable.Gallery_android_galleryItemBackground, 0);<br><span style="color: #008080;"> 93</span>             a.recycle();<br><span style="color: #008080;"> 94</span>         }<br><span style="color: #008080;"> 95</span><br><span style="color: #008080;"> 96</span>         @Override<br><span style="color: #008080;"> 97</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> getCount() {<br><span style="color: #008080;"> 98</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;"> 99</span>             <span style="color: #0000ff;">return</span> images.length;<br><span style="color: #008080;">100</span>         }<br><span style="color: #008080;">101</span><br><span style="color: #008080;">102</span>         @Override<br><span style="color: #008080;">103</span>         <span style="color: #0000ff;">public</span> Object getItem(<span style="color: #0000ff;">int</span> arg0) {<br><span style="color: #008080;">104</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">105</span>             <span style="color: #0000ff;">return</span> images[arg0];<br><span style="color: #008080;">106</span>         }<br><span style="color: #008080;">107</span><br><span style="color: #008080;">108</span>         @Override<br><span style="color: #008080;">109</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">long</span> getItemId(<span style="color: #0000ff;">int</span> position) {<br><span style="color: #008080;">110</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">111</span>             <span style="color: #0000ff;">return</span> position;<br><span style="color: #008080;">112</span>         }<br><span style="color: #008080;">113</span><br><span style="color: #008080;">114</span>         @Override<br><span style="color: #008080;">115</span>         <span style="color: #0000ff;">public</span> View getView(<span style="color: #0000ff;">int</span> position, View convertView, ViewGroup parent) {<br><span style="color: #008080;">116</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub</span><span style="color: #008000;"><br></span><span style="color: #008080;">117</span>             ImageView image = <span style="color: #0000ff;">new</span> ImageView(context);<br><span style="color: #008080;">118</span>             image.setImageResource(images[position]);<br><span style="color: #008080;">119</span>             image.setScaleType(ImageView.ScaleType.FIT_XY);<br><span style="color: #008080;">120</span>             image.setLayoutParams(<span style="color: #0000ff;">new</span> Gallery.LayoutParams(120, 100));<br><span style="color: #008080;">121</span>             image.setBackgroundResource(mGalleryItemBackground);<br><span style="color: #008080;">122</span>             <span style="color: #0000ff;">return</span> image;<br><span style="color: #008080;">123</span>         }<br><span style="color: #008080;">124</span><br><span style="color: #008080;">125</span>     }<br><span style="color: #008080;">126</span><br><span style="color: #008080;">127</span> }</pre><br></div>

<p>对应的布局文件：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TabHost<br></span><span style="color: #008080;"> 3</span> 　　　<span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@android:id/tabhost”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">    android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">    android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;"> 6</span> <span style="color: #ff0000;">    xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout<br></span><span style="color: #008080;"> 9　　　</span> <span style="color: #ff0000;">android:orientation</span><span style="color: #0000ff;">=”vertical”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">10</span> <span style="color: #ff0000;">    android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">11</span> <span style="color: #ff0000;">    android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">12</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Gallery<br></span><span style="color: #008080;">13</span> 　　　　　　<span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/gallery”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">14</span> <span style="color: #ff0000;">        android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">15</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">16</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TabWidget<br></span><span style="color: #008080;">19　　　　</span> <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@android:id/tabs”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">20</span> <span style="color: #ff0000;">        android:visibility</span><span style="color: #0000ff;">=”gone”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">21</span> <span style="color: #ff0000;">        android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">22</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">23</span> <span style="color: #ff0000;">        android:layout_weight</span><span style="color: #0000ff;">=”0.0”</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">24</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">FrameLayout<br></span><span style="color: #008080;">25</span> 　　　　　　　　<span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@android:id/tabcontent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">26</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">27</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”0.0dp”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">28</span> <span style="color: #ff0000;">            android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioGroup<br></span><span style="color: #008080;">31</span> 　　　　　　　　<span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tab_radiogroup”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">32</span> <span style="color: #ff0000;">            android:orientation</span><span style="color: #0000ff;">=”horizontal”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">33</span> <span style="color: #ff0000;">            android:background</span><span style="color: #0000ff;">=”@drawable/tab_widget_background”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">34</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">35</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">36</span> <span style="color: #ff0000;">            android:padding</span><span style="color: #0000ff;">=”2dp”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">37</span> <span style="color: #ff0000;">            android:gravity</span><span style="color: #0000ff;">=”center_vertical”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">38</span> <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">39</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;">40</span> 　　　　　　　　　　<span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/radioButton0”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">41</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”评分”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">42</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tab_icon1”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">43</span> <span style="color: #ff0000;">                style</span><span style="color: #0000ff;">=”@style/tab_item_background”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">44</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">45</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;">46　　　　　　　　　　</span> <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/radioButton1”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">47</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”紫色”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">48</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tab_icon2”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">49</span> <span style="color: #ff0000;">                style</span><span style="color: #0000ff;">=”@style/tab_item_background”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">50</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">51</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;">52</span> 　　　　　　　　　　<span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/radioButton2”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">53</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”红色”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">54</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tab_icon3”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">55</span> <span style="color: #ff0000;">                style</span><span style="color: #0000ff;">=”@style/tab_item_background”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">56</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">57</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;">58　　　　　　　　　　</span> <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/radioButton3”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">59</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”蓝色”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">60</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tab_icon4”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">61</span> <span style="color: #ff0000;">                style</span><span style="color: #0000ff;">=”@style/tab_item_background”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">62</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">63</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;">64</span> 　　　　　　　　　<span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/radioButton4”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">65</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”绿色”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">66</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tab_icon5”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">67</span> <span style="color: #ff0000;">                style</span><span style="color: #0000ff;">=”@style/tab_item_background”</span><span style="color: #ff0000;"><br></span><span style="color: #008080;">68</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">69</span>         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">RadioGroup</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">70</span><br><span style="color: #008080;">71</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">72</span><br><span style="color: #008080;">73</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">TabHost</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> TabHost </tag>
            
            <tag> RadioGroup </tag>
            
            <tag> Gallery </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Activity的四种加载模式]]></title>
      <url>/2012/02/24/Activity%E7%9A%84%E5%9B%9B%E7%A7%8D%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%BC%8F/</url>
      <content type="html"><![CDATA[<p>1、standard ：系统的默认模式，一次跳转即会生成一个新的实例。假设有一个activity命名为Act1，执行语句：<br> startActivity(new Intent(Act1.this, Act1.class));<br>后Act1将跳转到另外一个Act1，也就是现在的栈里面有 Act1 的两个实例。按返回键后你会发现仍然是在Act1（第一个）里面。</p>
<p>2、singleTop：singleTop 跟standard 模式比较类似。唯一的区别就是，当跳转的对象是位于栈顶的activity（应该可以理解为用户眼前所 看到的activity）时，程序将不会生成一个新的activity实例，而是直接跳到现存于栈顶的那个activity实例。拿上面的例子来说，当Act1 为 singleTop 模式时，执行跳转后栈里面依旧只有一个实例，如果现在按返回键程序将直接退出。这个貌似用得比较少。</p>
<p>3、singleTask： singleTask模式和后面的singleInstance模式都是只创建一个实例的。在这种模式下，无论跳转的对象是不是位于栈顶的activity，程序都不会生成一个新的实例（当然前提是栈里面已经有这个实例）。这种模式相当有用，在以后的多activity开发中， 经常会因为跳转的关系导致同个页面生成多个实例，这个在用户体验上始终有点不好，而如果你将对应的activity声明为 singleTask 模式，这种问题将不复存在。不过前阵子好像又看过有人说一般不要将除开始页面的其他页面设置为 singleTask 模式，原因暂时不明，哪位知道的可以请教下。</p>
<p>4、singleInstance: 设置为 singleInstance 模式的 activity 将独占一个task（感觉task可以理解为进程），独占一个task的activity与其说是activity，倒不如说是一个应用，这个应用与其他activity是独立的，它有自己的上下文activity。拿一个例子来说明吧：<br>现在有以下三个activity: Act1、Act2、Act3，其中Acti2 为 singleInstance 模式。它们之间的跳转关系为： Act1 – Act2 – Act3 ，现在在Act3中按下返回键，由于Act2位于一个独立的task中，它不属于Act3的上下文activity，所以此时将直接返回到Act1。这就是singleInstance模式。</p>
]]></content>
      
        
        <tags>
            
            <tag> android </tag>
            
            <tag> activity </tag>
            
            <tag> launch mode </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>

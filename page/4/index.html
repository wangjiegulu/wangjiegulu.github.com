<!DOCTYPE html>




<html class="theme-next muse" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="WAND JIE" type="application/atom+xml" />






<meta name="description" content="Wang Jie&apos;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="WAND JIE">
<meta property="og:url" content="http://blog.wangjiegulu.com/page/4/index.html">
<meta property="og:site_name" content="WAND JIE">
<meta property="og:description" content="Wang Jie&apos;s blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WAND JIE">
<meta name="twitter:description" content="Wang Jie&apos;s blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.wangjiegulu.com/page/4/"/>





  <title>WAND JIE</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-111189680-2', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WAND JIE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">TO BE AN ARTIST-ENGINNER</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/12/15/Android-官网《UI-Application-Exerciser-Monkey》中文翻译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/12/15/Android-官网《UI-Application-Exerciser-Monkey》中文翻译/" itemprop="url">[Android]官网《UI/Application Exerciser Monkey》中文翻译</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-15T18:11:00+08:00">
                2015-12-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/12/15/Android-官网《UI-Application-Exerciser-Monkey》中文翻译/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/12/15/Android-官网《UI-Application-Exerciser-Monkey》中文翻译/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5049041.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5049041.html</a>
</strong></font>

<p>翻译自 Android Developer 官网：<a href="http://developer.android.com/tools/help/monkey.html" target="_blank" rel="noopener">http://developer.android.com/tools/help/monkey.html</a></p>
<h1 id="UI-Application-Exerciser-Monkey"><a href="#UI-Application-Exerciser-Monkey" class="headerlink" title="UI/Application Exerciser Monkey"></a>UI/Application Exerciser Monkey</h1><p>Monkey是一个程序，它会运行在你的<a href="http://developer.android.com/tools/help/emulator.html" target="_blank" rel="noopener">模拟器</a>或者设备上并且会产生伪随机的用户事件流，比如点击、触摸或手势，以及大量的系统级的事件。你可以使用Monkey来对你开发的应用程序以随机和重复的方式来进行压力测试。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Monkey是一个命令行工具，你可以在模拟器或者设备上运行它。它发送伪随机的用户事件流到系统，它可以作为你开发的应用程序的压力测试。</p>
<p>Monkey包含很多的选项，但是总结成四种主要的种类：</p>
<ul>
<li><p>基础配置选项，比如设置试图尝试的事件数量。</p>
</li>
<li><p>操作限制，比如限制在单个包中测试。</p>
</li>
<li><p>事件类型和频率。</p>
</li>
<li><p>debugging选项。</p>
</li>
</ul>
<p>当Monkey运行时，它会产生事件并把它们发送到系统。它也需要在测试下观察系统并寻找需要它特别处理的三种情况：</p>
<ul>
<li><p>如果你限制Monkey运行在一个或者多个指定的包下，它会观察导航到其他包的事件，并且拦截它们。</p>
</li>
<li><p>如果你的应用程序崩溃或者接收到了任何形式的未处理的异常，Monkey会停止并且报告错误。</p>
</li>
<li><p>如果你的应用程序产生了applicaiton not responding（ANR）错误，Monkey会停止并且报告错误。</p>
</li>
</ul>
<p>根据你所选择的详细程度，你还可以看到Monkey的进度报告和正在生成的事件。</p>
<h2 id="Monkey的基本使用"><a href="#Monkey的基本使用" class="headerlink" title="Monkey的基本使用"></a>Monkey的基本使用</h2><p>你可以使用你开发机器上的命令行或者选择一个脚本来启动Monkey。因为Monkey运行在模拟器/设备环境，你必须通过这个环境的shell来启动它。你可以在每句命令前加上<code>adb shell</code>，或者进入shell并直接使用Monkey命令。</p>
<p>基本的语法是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell monkey [options] &lt;event-count&gt;</span><br></pre></td></tr></table></figure>
<p>不使用任何选项指定，Monkey会以一种安静的模式启动，然后发送事件到任何（所有）你目标设备上安装的包中。这里有一个更加典型的命令行，它会启动你的应用程序，然后发送500个伪随机的事件给它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell monkey -p your.package.name -v 500</span><br></pre></td></tr></table></figure>
<h2 id="命令选项参考"><a href="#命令选项参考" class="headerlink" title="命令选项参考"></a>命令选项参考</h2><table>
<thead>
<tr>
<th>分类</th>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>普通</td>
<td><code>--help</code></td>
<td>打印出一个简单的使用指南</td>
</tr>
<tr>
<td></td>
<td><code>-v</code></td>
<td>命令行中的每一个-v都会增加详细程度。Level 0（默认）会在启动通知、测试完成、最后结果时提供少量的信息。Level 1提供更多测试运行时的细节，比如每个发送到你activities的事件。Level 2提供更详细的设置信息，比如测试时activitues选择的或者未选择的。</td>
</tr>
<tr>
<td>事件</td>
<td><code>-s &lt;seed&gt;</code></td>
<td>伪随机数字生成器种子。如果你使用相同的seed值重新运行Monkey，它会产生相同序列的事件</td>
</tr>
<tr>
<td></td>
<td><code>--throttle &lt;milliseconds&gt;</code></td>
<td>在事件之间插入一个固定的延迟。你可以使用这个选项来让Monkey减速。如果没有指定，事件就没有任何延迟，事件会尽可能快地生成。</td>
</tr>
<tr>
<td></td>
<td><code>--pct-touch &lt;percent&gt;</code></td>
<td>调整触摸事件的百分比。（触摸事件是一个在屏幕单个位置的down-up事件。）</td>
</tr>
<tr>
<td></td>
<td><code>--pct-motion &lt;percent&gt;</code></td>
<td>调整移动事件的百分比。（移动事件组成：屏幕上的一个down事件，一系列的伪随机移动事件，和一个up事件。）</td>
</tr>
<tr>
<td></td>
<td><code>--pct-trackball &lt;percent&gt;</code></td>
<td>调整轨迹球事件的百分比。（轨迹球事件组成：一个或者多个随机移动，有时跟随一个点击事件。）</td>
</tr>
<tr>
<td></td>
<td><code>--pct-nav &lt;percent&gt;</code></td>
<td>调整“basic”导航事件的百分比。（导航事件组成：up/down/left/right，作为一个方向输入设备输入。）</td>
</tr>
<tr>
<td></td>
<td><code>--pct-majornav &lt;percent&gt;</code></td>
<td>调整“major”导航事件的百分比。（这些导航事件比较典型的是由你的UI引发的行为，比如5-way pad中间按钮、返回键或者菜单键。）</td>
</tr>
<tr>
<td></td>
<td><code>--pct-syskeys &lt;percent&gt;</code></td>
<td>调整“system”按键事件的百分比。（这些按键一般都是被系统保留的，比如Home、返回、拨打电话、挂电话、音量控制。）</td>
</tr>
<tr>
<td></td>
<td><code>--pct-appswitch &lt;percent&gt;</code></td>
<td>调整Activity启动的百分比。在一个随机的间隔，Monkey会调用startActivity()方法，最大限度地覆盖到你包里的所有Activity。</td>
</tr>
<tr>
<td></td>
<td><code>--pct-anyevent &lt;percent&gt;</code></td>
<td>调整其它事件类型的百分比。它会包含所有类型的事件，比如按键，其它很少使用的设备按钮等等。</td>
</tr>
<tr>
<td>限制</td>
<td><code>-p &lt;allowed-package-name&gt;</code></td>
<td>如果你使用这个方式指定了一个或者多个包，Monkey将会只允许系统访问这些包中的Activities，如果你的应用程序需要访问其它包（比如，选择一个联系人），你也同样需要指定这些包。如果你不指定任何包，Monkey会允许系统启动所有包中的activities。要指定多个包，就多次使用<code>-p</code>—— 每一个包使用一个<code>-p</code>。</td>
</tr>
<tr>
<td></td>
<td><code>-c &lt;main-category&gt;</code></td>
<td>如果使用这个方式指定了一个或者多个<code>categories</code>，Monkey会只允许系统访问指定<code>categories</code>列表中任意一个<code>category</code>的Activities。如果你没有指定任何<code>categories</code>，Monkey会查询<code>Intent.CATEGORY_LAUNCHER</code>或者<code>Intent.CATEGORY_MONKEY</code>。要指定多个<code>category</code>，就多次使用<code>-c</code>—— 每一个<code>category</code>使用一个<code>-c</code>。</td>
</tr>
<tr>
<td>调试</td>
<td><code>--dbg-no-events</code></td>
<td>当这个被指定时，Monkey会执行初始化启动一个测试activity，但是不会再进一步产生任何事件了。最好的方式是结合<code>-v</code>，一个或者多个包限制和非零的间隔来保持Monkey运行30秒或者更高。这样它就提供了一个可以监视应用程序调用包之间的转换过程的环境。</td>
</tr>
<tr>
<td></td>
<td><code>--hprof</code></td>
<td>如果设置，这个选择会在Monkey事件序列之前和之后都会生成分析报告。这个会生成一个大文件（~5Mb）在<code>/data/misc</code>目录下，所以需要小心使用。更多追踪文件信息见<a href="http://developer.android.com/tools/debugging/debugging-tracing.html" target="_blank" rel="noopener">Traceview</a>。</td>
</tr>
<tr>
<td></td>
<td><code>--ignore-crashes</code></td>
<td>通常情况下，Monkey会在应用程序崩溃或者遭遇到未处理的异常时停止运行。如果你设置了设个选项，Monkey将会继续发送事件到系统，直到完成所有。</td>
</tr>
<tr>
<td></td>
<td><code>--ignore-timeouts</code></td>
<td>通常情况下，Monkey会在应用程序崩溃或者遭遇到类型为超时的异常如”Application Not Responding”对话框时停止运行。如果你指定了这个选项，Monkey将会继续发送事件到系统，直到完成所有。</td>
</tr>
<tr>
<td></td>
<td><code>--ignore-security-exceptions</code></td>
<td>通常情况下，Monkey会在应用程序崩溃或者遭遇到类型为权限错误的异常时停止运行，如试图去启动一个需要确定权限的Activity时。如果你指定了这个选项，Monkey将会继续发送事件到系统，直到完成所有。</td>
</tr>
<tr>
<td></td>
<td><code>--kill-process-after-error</code></td>
<td>通常情况下，当Monkey由于一个错误而停止运行，出错的应用程序还会继续运行，如果你指定了这个选项，它会发一个信号来停止这个发生错误的进程。注意，在正常（成功）完成时，启动了的进程不会被关闭，设备只是在事件完成后简单地保持最后的状态。</td>
</tr>
<tr>
<td></td>
<td><code>--monitor-native-crashes</code></td>
<td>观察和报告Android系统native代码引发的崩溃。如果<code>If --kill-process-after-error</code>被设置了，则整个系统就会被停止。</td>
</tr>
<tr>
<td></td>
<td><code>--wait-dbg</code></td>
<td>停止Monkey的执行，直到有调试器跟它连接到。</td>
</tr>
</tbody>
</table>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/12/15/Android-官网《Testing-Support-Library》中文翻译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/12/15/Android-官网《Testing-Support-Library》中文翻译/" itemprop="url">[Android]官网《Testing Support Library》中文翻译</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-15T15:44:00+08:00">
                2015-12-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/12/15/Android-官网《Testing-Support-Library》中文翻译/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/12/15/Android-官网《Testing-Support-Library》中文翻译/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5048524.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5048524.html</a>
</strong></font>

<p>翻译自 Android Developer 官网：<a href="http://developer.android.com/tools/testing-support-library/index.html" target="_blank" rel="noopener">http://developer.android.com/tools/testing-support-library/index.html</a></p>
<h1 id="Testing-Support-Library"><a href="#Testing-Support-Library" class="headerlink" title="Testing Support Library"></a>Testing Support Library</h1><p><code>Android Testing Support Library</code>为Android app的测试提供了一个广泛的框架。 这个库提供了一系列的API可以让你快速build和run你app的代码，它包括了<code>JUnit 4</code>和功能性的用户界面（UI）测试。你可以通过<a href="http://developer.android.com/tools/studio/index.html" target="_blank" rel="noopener">Android Studio IDE</a>或者命令行的方式运行你使用这些API创建的测试。</p>
<p><code>Android Testing Support Library</code>已经可以通过<code>Android SDK Manager</code>下载使用了。详情可见<a href="http://developer.android.com/tools/testing-support-library/index.html#setup" target="_blank" rel="noopener">Testing Support Library Setup</a></p>
<p>这页中会提供一些关于<code>Android Testing Support Library</code>中所提供的工具的信息，怎样在你的测试环境中使用它们，还有库发布的相关信息。</p>
<h2 id="Testing-Support-Library的特性"><a href="#Testing-Support-Library的特性" class="headerlink" title="Testing Support Library的特性"></a>Testing Support Library的特性</h2><p><code>Android Testing Support Library</code>提供包括了以下自动化测试工具：</p>
<ul>
<li><p><a href="http://developer.android.com/reference/android/support/test/runner/AndroidJUnitRunner.html" target="_blank" rel="noopener">AndroidJUnitRunner</a>：兼容Android的JUnit 4。</p>
</li>
<li><p><a href="http://developer.android.com/tools/testing-support-library/index.html#Espresso" target="_blank" rel="noopener">Espresso</a>：UI测试框架，适用于app内的功能性UI测试。</p>
</li>
<li><p><a href="http://developer.android.com/tools/testing-support-library/index.html#UIAutomator" target="_blank" rel="noopener">UI Automator</a>：UI测试框架，适用于系统和安装app间跨app的功能性UI测试。</p>
</li>
</ul>
<h3 id="AndroidJUnitRunner"><a href="#AndroidJUnitRunner" class="headerlink" title="AndroidJUnitRunner"></a>AndroidJUnitRunner</h3><p><a href="http://developer.android.com/reference/android/support/test/runner/AndroidJUnitRunner.html" target="_blank" rel="noopener">AndroidJUnitRunner</a> 类是一个 <a href="http://junit.org/" target="_blank" rel="noopener">JUnit</a> 测试runner，它可以让你在Android设备上运行<code>JUnit 3</code>或者<code>JUnit 4-style</code>的测试类，包括使用了 <a href="http://developer.android.com/tools/testing-support-library/index.html#Espresso" target="_blank" rel="noopener">Espresso</a> 和 <a href="http://developer.android.com/tools/testing-support-library/index.html#UIAutomator" target="_blank" rel="noopener">UI Automator</a> 测试框架的。<code>test runner</code>处理的事情有 加载你的测试package和需要在设备上测试的app，运行你的测试，还有报告测试结果。这个类会替换掉只支持<code>JUnit 3</code>测试的<a href="http://developer.android.com/reference/android/test/InstrumentationTestRunner.html" target="_blank" rel="noopener">InstrumentationTestRunner</a>类。</p>
<p>这个<code>test runner</code>的关键特性包括：</p>
<ul>
<li><p><a href="http://developer.android.com/tools/testing-support-library/index.html#ajur-junit" target="_blank" rel="noopener">JUnit的支持</a></p>
</li>
<li><p><a href="http://developer.android.com/tools/testing-support-library/index.html#ajur-instrumentation" target="_blank" rel="noopener">访问instrumentation信息</a></p>
</li>
<li><p><a href="http://developer.android.com/tools/testing-support-library/index.html#ajur-filtering" target="_blank" rel="noopener">测试过滤</a></p>
</li>
<li><p><a href="http://developer.android.com/tools/testing-support-library/index.html#ajur-sharding" target="_blank" rel="noopener">测试拆分</a></p>
</li>
</ul>
<p>需要 Android2.2(API level 8) 或者更高。</p>
<h4 id="JUnit的支持"><a href="#JUnit的支持" class="headerlink" title="JUnit的支持"></a>JUnit的支持</h4><p><code>Rest runner</code>兼容<code>JUnit 3</code>和<code>JUnit 4</code>（最高到<code>JUnit 4.10</code>）的测试。不管怎样，你应该避免在一个package中混合使用JUnit 3和 JUnit 4的代码，因为这样做可能会引发一些预料之外的问题。如果你创建了一个JUnit 4的测试类在设备或者模拟器上运行时，你的测试类必须要加上<code>@RunWith(AndroidJUnit4.class)</code>注解作为前缀。</p>
<p>下面的代码片段展示了你应该怎么去编写一个JUnit 4测试来验证<code>CalculatorActivity</code>类中的<code>add</code>操作是正确执行的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.support.test.runner.AndroidJUnit4;</span><br><span class="line"><span class="keyword">import</span> android.support.test.runner.AndroidJUnitRunner;</span><br><span class="line"><span class="keyword">import</span> android.test.ActivityInstrumentationTestCase2;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(AndroidJUnit4.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalculatorInstrumentationTest</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">ActivityInstrumentationTestCase2</span>&lt;<span class="title">CalculatorActivity</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setUp();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当你使用`AndroidJUnitRunner`运行测试时，</span></span><br><span class="line">        <span class="comment">// 注入Instrumentation实例是必要的。</span></span><br><span class="line">        injectInstrumentation(InstrumentationRegistry.getInstrumentation());</span><br><span class="line">        mActivity = getActivity();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">typeOperandsAndPerformAddOperation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 调用CalculatorActivity add()方法并传入一些操作数据，</span></span><br><span class="line">        <span class="comment">// 然后检查返回值是否是期望值</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.tearDown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="访问instrumentation信息"><a href="#访问instrumentation信息" class="headerlink" title="访问instrumentation信息"></a>访问instrumentation信息</h4><p>你可以使用 <a href="http://developer.android.com/reference/android/support/test/InstrumentationRegistry.html" target="_blank" rel="noopener"><code>InstrumentationRegistry</code></a> 类来访问你测试的app的相关信息。这个类包含一个 <a href="http://developer.android.com/reference/android/app/Instrumentation.html" target="_blank" rel="noopener"><code>Instrumentation</code></a> 对象，目标app的 <a href="http://developer.android.com/reference/android/content/Context.html" target="_blank" rel="noopener"><code>Context</code></a> 对象，还有你通过命令行传入到该测试的参数。这个数据在你使用UI Automator框架编写测试或者编写一些依赖 <a href="http://developer.android.com/reference/android/app/Instrumentation.html" target="_blank" rel="noopener"><code>Instrumentation</code></a> 或者 <a href="http://developer.android.com/reference/android/content/Context.html" target="_blank" rel="noopener"><code>Context</code></a> 对象的测试的时候是很有用的。</p>
<h4 id="测试过滤"><a href="#测试过滤" class="headerlink" title="测试过滤"></a>测试过滤</h4><p>在你的 JUnit 4 测试中， 你可以使用注解来配置你的测试的运行。这会最大限度地减少你测试中需要的模版代码和有条件的代码。除了 JUnit 4 支持的标准注解，<code>test runner</code>也支持一些针对Android的特殊的注解，包括：</p>
<ul>
<li><p><a href="http://developer.android.com/reference/android/support/test/filters/RequiresDevice.html" target="_blank" rel="noopener"><code>@RequiresDevice</code></a>：指明这个测试只能运行的物理设备上面，而不是模拟器上面。</p>
</li>
<li><p><a href="http://developer.android.com/reference/android/support/test/filters/SdkSuppress.html" target="_blank" rel="noopener"><code>@SdkSupress</code></a>：限制这个测试运行在低于给定的Android API level。举个例子，限制测试运行在API level低于18的环境下，使用注解 <code>@SDKSupress(minSdkVersion=18)</code>。</p>
</li>
<li><p><a href="http://developer.android.com/reference/android/test/suitebuilder/annotation/SmallTest.html" target="_blank" rel="noopener"><code>@SmallTest</code></a>，<a href="http://developer.android.com/reference/android/test/suitebuilder/annotation/MediumTest.html" target="_blank" rel="noopener"><code>@MediumTest</code></a>，和<a href="http://developer.android.com/reference/android/test/suitebuilder/annotation/LargeTest.html" target="_blank" rel="noopener"><code>@LargeTest</code></a>：对测试需要的时间运行来分类，因此，可以决定是否可以经常运行该测试。</p>
</li>
</ul>
<h4 id="测试拆分"><a href="#测试拆分" class="headerlink" title="测试拆分"></a>测试拆分</h4><p><code>Test runner</code> 支持把一个测试套件分割成多个碎片，所以你可以很简单地运行属于通过碎片分组的所有测试，并且它们使用同一个 <a href="http://developer.android.com/reference/android/app/Instrumentation.html" target="_blank" rel="noopener"><code>Instrumentation</code></a> 实例。每一个碎片都有一个索引编号（index number）作为它的唯一识别。当运行测试时，使用 <code>-e numShards</code> 选项来指定要创建的碎片的数量和 <code>-e shardIndex</code> 选项来指定哪些碎片运行。</p>
<p>举个例子，把一个测试套件分割成10个碎片，并且只运行被分组的测试中的第二个碎片，使用以下的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am instrument -w -e numShards 10 -e shardIndex 2</span><br></pre></td></tr></table></figure>
<p>这个 <code>test runner</code> 的更多相关学习，见 <a href="http://developer.android.com/reference/android/support/test/package-summary.html" target="_blank" rel="noopener">API reference</a>。</p>
<h3 id="Espresso"><a href="#Espresso" class="headerlink" title="Espresso"></a>Espresso</h3><p>Espresso 测试框架提供了一系列的API用于构建UI测试来测试app内用户流操作。这些API让你可以编写简洁可靠的自动化UI测试。<strong>Espresso非常适合用来编写白盒测试</strong>，其中测试代码的编写是利用了被测试app中程序代码实现细节。</p>
<p>Espresso测试框架的关键特性包括：</p>
<ul>
<li><p>提供了灵活的API用于匹配目标app中<code>view</code>和<code>adapter</code>。更多的信息，见 <a href="http://developer.android.com/tools/testing-support-library/index.html#espresso-matching" target="_blank" rel="noopener">View 匹配</a></p>
</li>
<li><p>大而全的 <code>行为 api</code>（action APIs） 用于自动化UI交互。更多的信息，见 <a href="http://developer.android.com/tools/testing-support-library/index.html#espresso-actions" target="_blank" rel="noopener">行为 APIs</a></p>
</li>
<li><p>UI线程同步来提高测试可靠性。更多信息，见 <a href="http://developer.android.com/tools/testing-support-library/index.html#espresso-thread-sync" target="_blank" rel="noopener">UI 线程同步</a></p>
</li>
</ul>
<p>需要 Android2.2(API level 8) 或者更高。</p>
<h4 id="View-匹配"><a href="#View-匹配" class="headerlink" title="View 匹配"></a>View 匹配</h4><p><a href="http://developer.android.com/reference/android/support/test/espresso/Espresso.html#onView" target="_blank" rel="noopener"><code>Espresso.onView()</code></a> 方法可以让你访问目标app中的一个UI组件并与它交互。这个方法接收一个 <a href="http://hamcrest.org/JavaHamcrest/javadoc/1.3/org/hamcrest/Matcher.html" target="_blank" rel="noopener"><code>Matcher</code></a> 作为参数，然后根据我们给定的条件在view的层次结构中搜索出对应相符的<a href="http://developer.android.com/reference/android/view/View.html" target="_blank" rel="noopener"><code>View</code></a>实例。你可以使用如下的条件来优化你的搜索结果：</p>
<ul>
<li>View的类名</li>
<li>View内容的描述（<code>content description</code>）</li>
<li>View的<code>R.id</code></li>
<li>View显示的文本</li>
</ul>
<p>举个例子，寻找一个ID为<code>my_button</code>的目标button，你可以如以下一样指定一个matcher：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onView(withId(R.id.my_button));</span><br></pre></td></tr></table></figure>
<p>如果搜索是成功的，<a href="http://developer.android.com/reference/android/support/test/espresso/Espresso.html#onView" target="_blank" rel="noopener"><code>onView()</code></a> 方法会返回一个可以让你执行用户行为和测试目标中对view断言的引用。</p>
<h4 id="Adapter-匹配"><a href="#Adapter-匹配" class="headerlink" title="Adapter 匹配"></a>Adapter 匹配</h4><p>在一个 <a href="http://developer.android.com/reference/android/widget/AdapterView.html" target="_blank" rel="noopener"><code>AdapterView</code></a> 的布局中，布局是在运行时根据children动态填充的。如果目标view是在 <a href="http://developer.android.com/reference/android/widget/AdapterView.html" target="_blank" rel="noopener"><code>AdapterView</code></a> 子类（比如<a href="http://developer.android.com/reference/android/widget/ListView.html" target="_blank" rel="noopener"><code>ListView</code></a> 或者 <a href="http://developer.android.com/reference/android/widget/GridView.html" target="_blank" rel="noopener"><code>GridView</code></a>）的布局中的，<a href="http://developer.android.com/reference/android/support/test/espresso/Espresso.html#onView" target="_blank" rel="noopener"><code>onView()</code></a> 方法可能就不起作用了，因为当前加载的view层次结构可能只是layout的一个子集。</p>
<p>替代方案是使用 <a href="http://developer.android.com/reference/android/support/test/espresso/Espresso.html#onData)" target="_blank" rel="noopener"><code>Espresso.onData()</code></a> 方法去访问一个目标view元素。<a href="http://developer.android.com/reference/android/support/test/espresso/Espresso.html#onData)" target="_blank" rel="noopener"><code>Espresso.onData()</code></a> 方法返回一个可以让你执行用户行为和测试目标 <a href="http://developer.android.com/reference/android/widget/AdapterView.html" target="_blank" rel="noopener"><code>AdapterView</code></a> 中对元素断言的引用。</p>
<h4 id="行为-APIs"><a href="#行为-APIs" class="headerlink" title="行为 APIs"></a>行为 APIs</h4><p>典型的，你可以通过对app的用户界面执行一些用户交互来测试app。在你的测试中使用 <a href="http://developer.android.com/reference/android/support/test/espresso/action/ViewActions.html" target="_blank" rel="noopener"><code>ViewActions</code></a> API 可以让你很容易地自动化这些行为。你可以通过以下方式执行这些UI交互：</p>
<ul>
<li><p>View的点击</p>
</li>
<li><p>滑动</p>
</li>
<li><p>按键和按钮的按下</p>
</li>
<li><p>输入文本</p>
</li>
<li><p>打开一个链接</p>
</li>
</ul>
<p>举个例子，模拟输入一个字符串数据并按下按钮来提交这个值，你可以像这样编写一个自动化测试脚本。 <a href="http://developer.android.com/reference/android/support/test/espresso/ViewInteraction.html#perform(android.support.test.espresso.ViewAction..." target="_blank" rel="noopener"><code>ViewInteraction.preform()</code></a>) 和 <a href="http://developer.android.com/reference/android/support/test/espresso/DataInteraction.html#perform(android.support.test.espresso.ViewAction..." target="_blank" rel="noopener"><code>DataInteraction.perform()</code></a>) 方法接收一个或者多个<a href="http://developer.android.com/reference/android/support/test/espresso/ViewAction.html" target="_blank" rel="noopener"><code>ViewAction</code></a> 参数并且按照提供的顺序执行这些<code>actions</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在一个EditText中输入文本信息，然后关闭软键盘</span></span><br><span class="line">onView(withId(R.id.editTextUserInput))</span><br><span class="line">    .perform(typeText(STRING_TO_BE_TYPED), closeSoftKeyboard());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 按下按钮来提交改变的文本</span></span><br><span class="line">onView(withId(R.id.changeTextBt)).perform(click());</span><br></pre></td></tr></table></figure>
<h4 id="UI线程同步"><a href="#UI线程同步" class="headerlink" title="UI线程同步"></a>UI线程同步</h4><p>在Android设备上测试可能由于时间的关系会随机性地失败。这个测试问题称为test flakiness（测试片状）。在Espresso之前，变通的办法是在测试中插入足够长的睡眠或者一段时间后超时，或者增加在操作失败之后保持重试的代码。Espresso测试框架会在<a href="http://developer.android.com/reference/android/app/Instrumentation.html" target="_blank" rel="noopener"><code>Instrumentation</code></a>和UI线程之间保持同步；这样就可以去掉之前因为时间问题使用的变通的方法，并且确保你测试的行为和断言运行更加可靠。</p>
<p>更多Espresso的相关学习，见 <a href="http://developer.android.com/reference/android/support/test/package-summary.html" target="_blank" rel="noopener">API reference</a> 和 <a href="http://developer.android.com/training/testing/ui-testing/espresso-testing.html" target="_blank" rel="noopener">针对单个App的UI测试</a> 练习。</p>
<h3 id="UI-Automator"><a href="#UI-Automator" class="headerlink" title="UI Automator"></a>UI Automator</h3><p>UI Automator测试框架提供了一系列的API来构建在用户app和系统app之间的UI测试。UI Automator APIs  允许你在测试设备中执行例如打开设置菜单或者launcher等操作。<strong>UI Automator 测试框架非常适合用来写黑盒测试</strong>，其中测试代码的编写不需要依赖于目标app的内部实现细节。</p>
<p>UI Automator测试框架的关键特性包括：</p>
<ul>
<li><p>检查layout层次结构的Viewer。更多信息，见 <a href="http://developer.android.com/tools/testing-support-library/index.html#uia-viewer" target="_blank" rel="noopener"><code>UI Automator Viewer</code></a>。</p>
</li>
<li><p>一个用于在目标设备上获取状态信息和执行操作的API。更多信息，见 <a href="http://developer.android.com/tools/testing-support-library/index.html#uia-device-state" target="_blank" rel="noopener"><code>访问设备状态</code></a></p>
</li>
<li><p>跨app的UI测试APIs。更多信息，见 <a href="http://developer.android.com/tools/testing-support-library/index.html#uia-apis" target="_blank" rel="noopener"><code>UI automator APIS</code></a></p>
</li>
</ul>
<p>需要 Android4.3(API level 18) 或者更高。</p>
<h4 id="UI-Automator-Viewer"><a href="#UI-Automator-Viewer" class="headerlink" title="UI Automator Viewer"></a>UI Automator Viewer</h4><p><code>uiautomatorviewer</code> 工具提供了一个方便的GUI来扫描和分析当前在Android设备上显示的UI组件。你可以使用这些工具来检查layout层次结构和查看在设备前台可见的组件的属性。这个信息可以让你使用UI Automator创建更加细粒度的测试，比如创建一个匹配指定的可见性属性的UI选择器。</p>
<p><code>uiautomatorviewer</code> 工具在 <code>&lt;android-sdk&gt;/tools/</code> 目录下。</p>
<h4 id="访问设备状态"><a href="#访问设备状态" class="headerlink" title="访问设备状态"></a>访问设备状态</h4><p>UI Automator测试框架提供了一个 <a href="http://developer.android.com/reference/android/support/test/uiautomator/UiDevice.html" target="_blank" rel="noopener"><code>UIDevice</code></a> 类在目标app运行的设备上访问和执行操作。你可以调用它的方法来访问如当前的设备定向活着显示尺寸等设备属性。 <a href="http://developer.android.com/reference/android/support/test/uiautomator/UiDevice.html" target="_blank" rel="noopener"><code>UIDevice</code></a> 类也可以让你执行一些如下的行为：</p>
<ul>
<li><p>旋转设备</p>
</li>
<li><p>按下 <code>D-pad</code> 键</p>
</li>
<li><p>按下返回键、Home键、菜单键</p>
</li>
<li><p>打开通知栏</p>
</li>
<li><p>当前的窗口截图</p>
</li>
</ul>
<p>举个例子，模拟按下Home按钮，调用 <code>UiDevice.pressHome()</code> 方法。</p>
<h4 id="UI-Automator-APIs"><a href="#UI-Automator-APIs" class="headerlink" title="UI Automator APIs"></a>UI Automator APIs</h4><p>UI Automator APIs 允许你在不需要知道目标app实现细节的情况下去编写强大的测试。你可以使用这些APIs来捕获和操作跨越多个app的UI组件：</p>
<ul>
<li><p><a href="http://developer.android.com/reference/android/support/test/uiautomator/UiCollection.html" target="_blank" rel="noopener"><code>UiCollection</code></a>：枚举容器中的UI元素来计数，或者通过子元素的可见text或<code>content-description</code>属性来作为一个目标。</p>
</li>
<li><p><a href="http://developer.android.com/reference/android/support/test/uiautomator/UiObject.html" target="_blank" rel="noopener"><code>UiObject</code></a>：代表在设备上一个可见的UI元素。</p>
</li>
<li><p><a href="http://developer.android.com/reference/android/support/test/uiautomator/UiScrollable.html" target="_blank" rel="noopener"><code>UiScrollable</code></a>：对可滚动的UI容器中搜索UI元素提供支持。</p>
</li>
<li><p><a href="http://developer.android.com/reference/android/support/test/uiautomator/UiSelector.html" target="_blank" rel="noopener"><code>UiSelector</code></a>：代表一个设备上对一个或者多个目标UI元素的查询。</p>
</li>
<li><p><a href="http://developer.android.com/reference/android/support/test/uiautomator/Configurator.html" target="_blank" rel="noopener"><code>Configurator</code></a>：允许你设置UI Automator测试的关键参数。</p>
</li>
</ul>
<p>举个例子，下面的代码展示了怎么样去编写一个测试脚本来获取默认的app launcher：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化 UiDevice 实例</span></span><br><span class="line">mDevice = UiDevice.getInstance(getInstrumentation());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 HOME 按钮上执行一个短暂的按压</span></span><br><span class="line">mDevice().pressHome();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过匹配启动按钮的content-description来搜索一个UI组件</span></span><br><span class="line"><span class="comment">// 得到默认的launcher</span></span><br><span class="line">UiObject allAppsButton = mDevice</span><br><span class="line">        .findObject(<span class="keyword">new</span> UiSelector().description(<span class="string">"Apps"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在得到的launcher 按钮上面执行一个点击</span></span><br><span class="line">allAppsButton.clickAndWaitForNewWindow();</span><br></pre></td></tr></table></figure>
<p>更多UI Automator相关学习，见 <a href="http://developer.android.com/reference/android/support/test/package-summary.html" target="_blank" rel="noopener">API reference</a> 和 <a href="http://developer.android.com/training/testing/ui-testing/uiautomator-testing.html" target="_blank" rel="noopener">多App的UI测试</a> 练习。</p>
<h2 id="Testing-Support-Library-Setup"><a href="#Testing-Support-Library-Setup" class="headerlink" title="Testing Support Library Setup"></a>Testing Support Library Setup</h2><p>Android Testing Support Library package已经包含在最新版本的作为补充库、可在SDK Manager中下载的Android Support Repository中。</p>
<p>通过SDK Manager下载Android Support Repository：</p>
<p>1. 启动 <a href="http://developer.android.com/tools/help/sdk-manager.html" target="_blank" rel="noopener">Android SDK Manager</a>。</p>
<p>2. 在SDK Manager窗口，滚动到Packages列表的最底部，找到<code>Extras</code>目录，如果需要，把它展开显示它的内容。</p>
<p>3. 找到 <strong>Android Support Repository</strong> 项。</p>
<p>4. 点击 <strong>Install packages…</strong> 按钮。</p>
<p>下载完之后，工具把Support Repository文件安装在存在的Android SDK目录。库文件会被放置在你SDK目录的子目录中：<code>&lt;sdk&gt;/extras/android/m2respository</code> 目录。</p>
<p>Android Testing Support Library 类被放置在<code>android.support.test</code>包下面。</p>
<p>为了在你的Gradle项目中使用Android Testing Support Library，在你的<code>build.gradle</code>文件中增加如下依赖：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">  androidTestCompile <span class="string">'com.android.support.test:runner:0.4'</span></span><br><span class="line">  <span class="comment">// Set this dependency to use JUnit 4 rules</span></span><br><span class="line">  androidTestCompile <span class="string">'com.android.support.test:rules:0.4'</span></span><br><span class="line">  <span class="comment">// Set this dependency to build and run Espresso tests</span></span><br><span class="line">  androidTestCompile <span class="string">'com.android.support.test.espresso:espresso-core:2.2.1'</span></span><br><span class="line">  <span class="comment">// Set this dependency to build and run UI Automator tests</span></span><br><span class="line">  androidTestCompile <span class="string">'com.android.support.test.uiautomator:uiautomator-v18:2.1.2'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了在你的Gradle项目中默认使用<a href="http://developer.android.com/reference/android/support/test/runner/AndroidJUnitRunner.html" target="_blank" rel="noopener">AndroidJUnitRunner</a>作为默认的instrumentation runner，在你的<code>build.gradle</code>文件中指定这个依赖：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        testInstrumentationRunner <span class="string">"android.support.test.runner.AndroidJUnitRunner"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>强烈推荐你与Android Studio IDE一起使用Android Testing Support Library。Android Studio提供了支持测试开发的功能，比如：</p>
<ul>
<li><p>灵活并基于Gradle构建系统，支持对你测试代码的依赖管理。</p>
</li>
<li><p>单元和instrumented测试代码与你的app的源代码放置在单个项目结构中。</p>
</li>
<li><p>支持从命令行或者GUI来部署和运行你的测试在虚拟或者物理设备中。</p>
</li>
</ul>
<p>更多Android Studio相关和下载，见 <a href="http://developer.android.com/sdk/index.html" target="_blank" rel="noopener">下载Android Studio和SDK Tools</a>。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/12/10/Android-对MVC和MVP的总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/12/10/Android-对MVC和MVP的总结/" itemprop="url">[Android]对MVC和MVP的总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-10T15:48:00+08:00">
                2015-12-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/12/10/Android-对MVC和MVP的总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/12/10/Android-对MVC和MVP的总结/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5036289.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5036289.html</a>
</strong></font>

<p>经历过的客户端的架构分为这么几个阶段：</p>
<h3 id="第一阶段"><a href="#第一阶段" class="headerlink" title="第一阶段"></a>第一阶段</h3><p>使用传统的MVC，其中的View，对应的是各种Layout布局文件，但是这些布局文件中并不像Web端那样强大，能做的事情非常有限；Controller对应的是Activity，而Activity中却又具有操作UI的功能，我们在实际的项目中也会有很多UI操作在这一层，也做了很多View中应该做的事情，当然Controller中也包含Controller应该做的事情，比如各种事件的派发回调，而且在一层中我们会根据事件再去调用Model层操作数据，所以这种MVC的方式在实际项目中，Activity所在的Controller是非常重的，各层次之间的耦合情况也比较严重，不方便单元测试。</p>
<h3 id="第二阶段"><a href="#第二阶段" class="headerlink" title="第二阶段"></a>第二阶段</h3><p>使用MVC的进化版——MVP，MVP中把Layout布局和Activity作为View层，增加了Presenter，Presenter层与Model层进行业务的交互，完成后再与View层交互（也就是Activity）进行回调来刷新UI。这样一来，所有业务逻辑的工作都交给了Presenter中进行，使得View层与Model层的耦合度降低，Activity中的工作也进行了简化。但是在实际项目中，随着逻辑的复杂度越来越大，Activity臃肿的缺点仍然体现出来了，因为Activity中还是充满了大量与View层无关的代码，比如各种事件的处理派发，就如MVC中的那样View层和Controller代码耦合在一起无法自拔。</p>
<h3 id="第三阶段"><a href="#第三阶段" class="headerlink" title="第三阶段"></a>第三阶段</h3><p>也是现在正在使用的架构，针对第二阶段进行优化，为了把View再次简化，想到两种方式：</p>
<p>1. 通过使用一个Presenter代理的方式，在PresenterProxy中处理各种事件机制，View中维护一个PresenterProxy对象当然Presenter中同样实现了真实对象Presnter所实现的接口，这样，我们同样在View中通过代理对象调用真实对象的代码，结构图如下：<br><img src="https://raw.githubusercontent.com/wangjiegulu/wangjiegulu.github.com/master/images/mvp/MVP_PresenterProxy.jpg" alt=""></p>
<p>2. 为MVP增加一层专门用于处理各种的事件派发Controller层，Controller的作用仅仅是处理事件并根据事件通过维护的Presenter对象派发到对应的业务中，也就是说View层只有一个Controller的对象，View层不会主动去调用Presenter层，但是Controller层和Presenter都可能会回调到View层来刷新UI，所以层次结构就变成了如下：<br><img src="https://raw.githubusercontent.com/wangjiegulu/wangjiegulu.github.com/master/images/mvp/MVP_Controller.jpg" alt=""></p>
<p>现在使用的是第2种方式，使用Controller来进行对Activity中事件代码的分离，下面使用登录的例子来讲解，其中代码使用的并不是Java，而是Kotlin。</p>
<p>在演示之前，先来看下实现MVP的几个基础的接口和类（<a href="https://github.com/wangjiegulu/AndroidKotlinBucket/blob/master/library/src/main/kotlin/com/wangjie/androidkotlinbucket/library/AKBMVPExt.kt" target="_blank" rel="noopener">点这里查看AKBMVPExt.kt</a>）：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MVP的View层，UI相关，Activity需要实现该interface</span></span><br><span class="line"><span class="comment"> * 它会包含一个Presenter的引用，当有事件发生（比如按钮点击后），会调用Presenter层的方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KViewer</span> </span>&#123;</span><br><span class="line">    <span class="comment">//    val onClickListener: ((view: View) -&gt; Unit)?</span></span><br><span class="line">    <span class="keyword">val</span> context: Context?;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">toast</span><span class="params">(message: <span class="type">String</span>, duration: <span class="type">Int</span> = Toast.LENGTH_SHORT)</span></span> &#123;</span><br><span class="line">        context?.lets &#123; Toast.makeText(<span class="keyword">this</span>, message, duration).show() &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">dialog</span><span class="params">(title: <span class="type">String</span>? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               message: <span class="type">String</span>?,</span></span></span><br><span class="line"><span class="function"><span class="params">               okText: <span class="type">String</span>? = <span class="string">"OK"</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               cancelText: <span class="type">String</span>? = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">               positiveClickListener: ((<span class="type">DialogInterface</span>, <span class="built_in">Int</span>)</span></span> -&gt; <span class="built_in">Unit</span>)? = <span class="literal">null</span>,</span><br><span class="line">               negativeClickListener: ((DialogInterface, <span class="built_in">Int</span>) -&gt; <span class="built_in">Unit</span>)? = <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        context?.lets &#123;</span><br><span class="line">            AlertDialog.Builder(<span class="keyword">this</span>)</span><br><span class="line">                    .setTitle(title)</span><br><span class="line">                    .setMessage(message)</span><br><span class="line">                    .setPositiveButton(okText, positiveClickListener)</span><br><span class="line">                    .setNegativeButton(cancelText, negativeClickListener)</span><br><span class="line">                    .show()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">showLoading</span><span class="params">(message: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        Log.w(KViewer::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>.<span class="title">simpleName</span>, <span class="type">"loadingDialog should impl by subclass")</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">cancelLoading</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.w(KViewer::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>.<span class="title">simpleName</span>, <span class="type">"cancelLoadingDialog should impl by subclass")</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : View&gt;</span> <span class="title">findView</span><span class="params">(resId: <span class="type">Int</span>)</span></span>: T;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有<code>View</code>层的Activity、Fragment或者View都要实现<code>KViewer</code>接口，该接口中有一个属性和一个函数需要被子类的Activity实现：</p>
<ul>
<li><p><code>context</code>属性：该属性需要被子类override，该属性用于一些接口公用的UI相关操作的方法，如<code>toast</code>、<code>dialog</code>、<code>cancelDialog</code>等。</p>
</li>
<li><p><code>fun &lt;T : View&gt; findView(resId: Int): T</code>函数：该函数需要被子类Activity、Fragment或者View实现，这个方法用于从当前View层中根据id获取到对应的View，该方法在Activity、Fragment或者View中并不一致。</p>
</li>
</ul>
<p>当然所有的重写都可以在BaseActivity、BaseFragment、BaseFrameLayout等中重写，之后使用它们的子类即可。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MVP的Presenter层，作为沟通View和Model的桥梁，它从Model层检索数据后，返回给View层，它也可以决定与View层的交互操作。</span></span><br><span class="line"><span class="comment"> * 它包含一个View层的引用和一个Model层的引用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">KPresenter</span>&lt;<span class="type">V : KViewer</span>&gt;</span>(<span class="keyword">var</span> viewer: V) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">closeAll</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.w(KViewer::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>.<span class="title">simpleName</span>, <span class="type">"closeAll in KPresenter should impl by subclass")</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>KPresenter</code>类是作为所有Presenter层的实现的基类的，它只有一个<code>closeAll</code>函数需要被重写，当Activity在被destory时，需要调用close函数停止到子线程的任务。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Controller，用于派发View中的事件，它在根据不同的事件调用Presenter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">KController</span>&lt;<span class="type">KV : KViewer, KP : KPresenter&lt;*</span>&gt;&gt;</span>(<span class="keyword">val</span> viewer: KV, presenterCreate: () -&gt; KP) &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">val</span> presenter: KP <span class="keyword">by</span> lazy &#123; presenterCreate() &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewCache: SparseArray&lt;View&gt; = SparseArray();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">bindEvents</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : View&gt;</span> <span class="title">getView</span><span class="params">(resId: <span class="type">Int</span>)</span></span>: T &#123;</span><br><span class="line">        <span class="keyword">val</span> view: View? = viewCache.<span class="keyword">get</span>(resId)</span><br><span class="line">        <span class="keyword">return</span> view <span class="keyword">as</span> T? ?: viewer.findView&lt;T&gt;(resId).apply &#123;</span><br><span class="line">            viewCache.put(resId, <span class="keyword">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">closeAll</span><span class="params">()</span></span> = presenter.closeAll()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样<code>KController</code>是所有<code>Controller</code>类的基类，需要子类实现<code>bindEvents()</code>函数，在这个函数中，可以绑定各种View的事件。还提供了<code>getView()</code>方法来从Viewer中获取到对应的控件，并且会缓存找到的控件。</p>
<h4 id="一、创建BaseActivity并实现KViewer"><a href="#一、创建BaseActivity并实现KViewer" class="headerlink" title="一、创建BaseActivity并实现KViewer"></a>一、创建<code>BaseActivity</code>并实现<code>KViewer</code></h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> : <span class="type">AppCompatActivity</span></span>(), KViewer &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : View&gt;</span> <span class="title">findView</span><span class="params">(resId: <span class="type">Int</span>)</span></span>: T = findViewById(resId) <span class="keyword">as</span> T</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> context: Context = <span class="keyword">this</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">val</span> controller: KController&lt;*, *&gt;? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> loadingDialog: ProgressDialog <span class="keyword">by</span> lazy &#123; ProgressDialog(<span class="keyword">this</span>) &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        <span class="comment">// 强制竖屏</span></span><br><span class="line">        requestedOrientation = ActivityInfo.SCREEN_ORIENTATION_PORTRAIT</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">showLoading</span><span class="params">(message: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        loadingDialog.setMessage(message)</span><br><span class="line">        loadingDialog.show()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">cancelLoading</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (loadingDialog.isShowing) &#123;</span><br><span class="line">            loadingDialog.cancel()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">        controller?.closeAll()</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我重写了<code>KViewer</code>中的<code>findView()</code>函数，函数实现是通过<code>Activity::findViewById()</code>的方式。</p>
<p>又实现了<code>controller</code>属性，设置为null，这个<code>controller</code>还需要子类再来重写。</p>
<p>然后重写了<code>showLoading</code>和<code>cancelLoading</code>，在<code>onDestory</code>中通过<code>controller</code>调用<code>presenter</code>中的<code>closeAll</code>函数。</p>
<h4 id="二、实现LoginActivity"><a href="#二、实现LoginActivity" class="headerlink" title="二、实现LoginActivity"></a>二、实现<code>LoginActivity</code></h4><p>新建<code>LoginViewer</code>接口，继承<code>KViewer</code>，并定义各种逻辑回调：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">LoginViewer</span> : <span class="type">KViewer &#123;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onLogin</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>里面所有的函数应该都是名字<code>onXXX</code>的函数，都是需要去操作UI的，这里定义的是一个<code>onLogin()</code>函数，表示登录成功后，我们现在是如果登录成功后，则跳转到主界面<code>MainActivity</code>。</p>
<p>然后创建<code>LoginActivity</code>，实现我们的<code>LoginViewer</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> : <span class="type">BaseActivity</span></span>(), LoginViewer &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> controller: LoginController <span class="keyword">by</span> lazy &#123; LoginController(<span class="keyword">this</span>) &#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_login)</span><br><span class="line"></span><br><span class="line">        controller.bindEvents()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLogin</span><span class="params">()</span></span> &#123;</span><br><span class="line">        toActivity&lt;MainActivity&gt; &#123; &#125;</span><br><span class="line">        finish()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们首先重写父类中的<code>controller</code>属性，通过<code>lazy</code>懒初始化<code>LoginController</code>，然后在<code>onCreate</code>中调用<code>controller</code>的<code>bindEvents()</code>，这样，我们在<code>controller</code>中的<code>bindEvents()</code>函数中就可以对各种View进行事件的绑定，甚至包括自定义的Dialog、PopupWindow等组件的回调。</p>
<p>然后实现<code>onLogin</code>函数，在这个函数中进行界面的跳转。</p>
<h4 id="三、实现LoginController"><a href="#三、实现LoginController" class="headerlink" title="三、实现LoginController"></a>三、实现LoginController</h4><p>创建<code>LoginController</code>，继承<code>KController</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginController</span></span>(viewer: LoginViewer) : KController&lt;LoginViewer, LoginPresenter&gt;(viewer, &#123; LoginPresenter(viewer) &#125;),</span><br><span class="line">        View.OnClickListener &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">bindEvents</span><span class="params">()</span></span> &#123;</span><br><span class="line">        getView&lt;Button&gt;(R.id.activity_login_submit_btn).setOnClickListener(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(v: <span class="type">View</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (v?.id) &#123;</span><br><span class="line">            R.id.activity_login_submit_btn -&gt; presenter.login(getView&lt;EditText&gt;(R.id.activity_login_username_et).text.toString(), getView&lt;EditText&gt;(R.id.activity_login_password_et).text.toString())</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现<code>KController</code>中的<code>bindEvents</code>函数，在<code>bindEvents</code>中我们通过<code>KController</code>中<code>getView()</code>函数获取到Id为<code>R.id.activity_login_submit_btn</code>的按钮，然后设置<code>OnClickListener</code>，在onClick回调方法中，<code>Controller</code>会根据事件派发到<code>Presenter</code>来进行真正的登录操作。</p>
<h4 id="四、实现Presenter"><a href="#四、实现Presenter" class="headerlink" title="四、实现Presenter"></a>四、实现Presenter</h4><p>创建<code>Presenter</code>，继承<code>KPresenter</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginPresenter</span></span>(viewer: LoginViewer) : KPresenter&lt;LoginViewer&gt;(viewer) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">login</span><span class="params">(username: <span class="type">String</span>, password: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        viewer.showLoading(_resString(R.string.xr_hint_logging_in))</span><br><span class="line"></span><br><span class="line">        HttpsUrl(HttpWebApi.System.LOGIN).rxRequest &#123;</span><br><span class="line">            it.posts(</span><br><span class="line">                    <span class="string">"username"</span> to username,</span><br><span class="line">                    <span class="string">"password"</span> to password</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">                .map &#123;</span><br><span class="line">                    _gson._fromJson&lt;LoginHttpResponse&gt;(it.body().string()) </span><br><span class="line">                &#125;</span><br><span class="line">                .observeOnMain()</span><br><span class="line">                .doOnNextOrError &#123; viewer.cancelLoading() &#125;</span><br><span class="line">                .subscribe (&#123;</span><br><span class="line">                    <span class="keyword">if</span> (it.success) &#123;</span><br><span class="line">                        viewer.onLogin()</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        showHint(it.msg)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;) &#123;</span><br><span class="line">                    Log.e(<span class="string">"Login"</span>, <span class="string">""</span>, it)</span><br><span class="line">                    viewer.toast(_resString(R.string.xr_error_default))</span><br><span class="line">                &#125;</span><br><span class="line">                .bindPresenter(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写<code>login()</code>函数，然后执行登录请求，登录成功后，通过<code>viewer</code>回调到<code>View</code>层的<code>onLogin()</code>函数。</p>
<p>如此一来，<code>View</code>层中只负责UI部分的工作，UI所产生的各种事件绑定、派发等职责放在<code>Controller</code>中，<code>Presenter</code>和<code>Model</code>还是与之前一样的职责。</p>
<p>关于<code>Presenter</code>的测试，只需mock一个<code>LoginViewer</code>实现类即可。</p>
<h3 id="第四阶段："><a href="#第四阶段：" class="headerlink" title="第四阶段："></a>第四阶段：</h3><p>MVVM，把<code>Presenter</code>改成<code>ViewModel</code>，它与<code>View</code>之间的交互可以使用<code>Data Binding</code>的方式双向进行，也就是说<code>View</code>和<code>ViewModel</code>任意一方的改变都会体现在另一方中，Google IO上提供的框架暂时还不成熟，只支持单向，所以暂时还没有在正式的项目中使用。</p>
<p>实质上MV*的思想都是一样的，解耦隔离视图（View）和模型（Model），在实际的应用中不需要给<code>MVC</code>、<code>MVP</code>和<code>MVVM</code>一个明确的界限，甚至可以把几者融合在一起。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/12/03/Android-从Launcher开始启动App流程源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/12/03/Android-从Launcher开始启动App流程源码分析/" itemprop="url">[Android]从Launcher开始启动App流程源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-03T17:45:00+08:00">
                2015-12-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/12/03/Android-从Launcher开始启动App流程源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/12/03/Android-从Launcher开始启动App流程源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5017056.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5017056.html</a>
</strong></font>

<h2 id="从Launcher开始启动App流程源码分析"><a href="#从Launcher开始启动App流程源码分析" class="headerlink" title="从Launcher开始启动App流程源码分析"></a>从Launcher开始启动App流程源码分析</h2><p><code>com.android.launcher.Launcher</code>就是我们的Launcher页面了，可以看到Launcher其实也是一个<code>Activity</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Launcher</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span>, <span class="title">OnLongClickListener</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然是<code>Activity</code>，那当然也会有<code>onCreate</code>、<code>onResume</code>等生命周期了，按照逻辑，应该会去加载所有App，以网格的布局显示在页面上，果然，在<code>onResume</code>看到了这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume();</span><br><span class="line">    <span class="keyword">if</span> (mRestoring) &#123;</span><br><span class="line">        startLoaders();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看方法名就可以猜到这个方法就是用来加载所有App信息的，进入这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startLoaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">boolean</span> loadApplications = sModel.loadApplications(<span class="keyword">true</span>, <span class="keyword">this</span>, mLocaleChanged);</span><br><span class="line">	sModel.loadUserItems(!mLocaleChanged, <span class="keyword">this</span>, mLocaleChanged, loadApplications);</span><br><span class="line">	mRestoring = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用<code>sModel</code>（<code>LauncherModel</code>类型）的<code>loadUserItems</code>方法去加载数据了，<code>sModel</code>明显属于<code>Model</code>层，进入<code>loadUserItems</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadUserItems</span><span class="params">(<span class="keyword">boolean</span> isLaunching, Launcher launcher, <span class="keyword">boolean</span> localeChanged,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> loadApplications)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">		mDesktopItemsLoaded = <span class="keyword">false</span>;</span><br><span class="line">        mDesktopItemsLoader = <span class="keyword">new</span> DesktopItemsLoader(launcher, localeChanged, loadApplications,</span><br><span class="line">                isLaunching);</span><br><span class="line">        mDesktopLoaderThread = <span class="keyword">new</span> Thread(mDesktopItemsLoader, <span class="string">"Desktop Items Loader"</span>);</span><br><span class="line">        mDesktopLoaderThread.start();</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后使用<code>DesktopItemsLoader</code>在<code>mDesktopLoaderThread</code>线程中加载，：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">DesktopItemsLoader</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">final</span> Cursor c = contentResolver.query(LauncherSettings.Favorites.CONTENT_URI, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> idIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites._ID);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> intentIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.INTENT);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> titleIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.TITLE);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> iconTypeIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.ICON_TYPE);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> iconIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.ICON);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> iconPackageIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.ICON_PACKAGE);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> iconResourceIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.ICON_RESOURCE);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> containerIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.CONTAINER);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> itemTypeIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.ITEM_TYPE);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> appWidgetIdIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.APPWIDGET_ID);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> screenIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.SCREEN);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> cellXIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.CELLX);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> cellYIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.CELLY);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> spanXIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.SPANX);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> spanYIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.SPANY);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> uriIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.URI);</span><br><span class="line">		<span class="keyword">final</span> <span class="keyword">int</span> displayModeIndex = c.getColumnIndexOrThrow(LauncherSettings.Favorites.DISPLAY_MODE);</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="comment">// 通过launcher回调返回数据</span></span><br><span class="line">		launcher.onDesktopItemsLoaded(uiDesktopItems, uiDesktopWidgets);</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们回到<code>Launcher</code>的<code>onDesktopItemsLoaded</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onDesktopItemsLoaded</span><span class="params">(ArrayList&lt;ItemInfo&gt; shortcuts, ArrayList&lt;LauncherAppWidgetInfo&gt; appWidgets)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	bindDesktopItems(shortcuts, appWidgets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续进入<code>bindDesktopItems</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindDesktopItems</span><span class="params">(ArrayList&lt;ItemInfo&gt; shortcuts, ArrayList&lt;LauncherAppWidgetInfo&gt; appWidgets)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	mBinder = <span class="keyword">new</span> DesktopBinder(<span class="keyword">this</span>, shortcuts, appWidgets, drawerAdapter);</span><br><span class="line">    mBinder.startBindingItems();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入<code>startBindingItems</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startBindingItems</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	obtainMessage(MESSAGE_BIND_ITEMS, <span class="number">0</span>, mShortcuts.size()).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用了<code>Handler</code>发送消息，进入<code>Handler</code>的<code>handleMessage</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">case</span> MESSAGE_BIND_ITEMS: &#123;</span><br><span class="line">			launcher.bindItems(<span class="keyword">this</span>, mShortcuts, msg.arg1, msg.arg2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接收到消息之后调用<code>bindItems</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindItems</span><span class="params">(Launcher.DesktopBinder binder, ArrayList&lt;ItemInfo&gt; shortcuts, <span class="keyword">int</span> start, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_APPLICATION:</span><br><span class="line">	<span class="keyword">case</span> LauncherSettings.Favorites.ITEM_TYPE_SHORTCUT:</span><br><span class="line">		<span class="keyword">final</span> View shortcut = createShortcut((ApplicationInfo) item);</span><br><span class="line">		workspace.addInScreen(shortcut, item.screen, item.cellX, item.cellY, <span class="number">1</span>, <span class="number">1</span>, !desktopLocked);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们只考虑app或者app快捷方式的情况，文件夹和widgets暂时不考虑。app或者app快捷方式实质上都是进入了这个逻辑中，调用<code>createShortcut</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重载方法，最终都会调用这个方法</span></span><br><span class="line"><span class="function">View <span class="title">createShortcut</span><span class="params">(<span class="keyword">int</span> layoutResId, ViewGroup parent, ApplicationInfo info)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	TextView favorite = (TextView) mInflater.inflate(layoutResId, parent, <span class="keyword">false</span>);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	favorite.setCompoundDrawablesWithIntrinsicBounds(<span class="keyword">null</span>, info.icon, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">	favorite.setText(info.title);</span><br><span class="line">	favorite.setTag(info);</span><br><span class="line">	favorite.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先inflater出item的布局，然后设置<code>text</code>和<code>OnClickListener</code>，还有tag，这个tag是<code>ApplicationInfo</code>，里面包含了各种App信息，是从App的<code>AndroidManifest.xml</code>的<code>&lt;application&gt;</code>标签中解析出来的。既然设置了点击事件，显然，点击后应该会打开对应的App才对。所以继续看<code>onClick</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">    Object tag = v.getTag();</span><br><span class="line">    <span class="keyword">if</span> (tag <span class="keyword">instanceof</span> ApplicationInfo) &#123;</span><br><span class="line">        <span class="comment">// Open shortcut</span></span><br><span class="line">        <span class="keyword">final</span> Intent intent = ((ApplicationInfo) tag).intent;</span><br><span class="line">        startActivitySafely(intent);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag <span class="keyword">instanceof</span> FolderInfo) &#123;</span><br><span class="line">        handleFolderClick((FolderInfo) tag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击App就会通过<code>startActivitySafely</code>方法使用刚才设置的tag，也就是<code>ApplicationInfo</code>中的intent进行跳转：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startActivitySafely</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">	intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	startActivity(intent);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们来看看打开某个app的时候整个流程是怎么走的。接着上面的的<code>startActivity()</code>方法走：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">		startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，不管你是调用了<code>startActivity</code>还是<code>startActivityForResult</code>方法，<code>startActivityForResult</code>方法，并且如果是调用的<code>startActivity</code>，则默认<code>requestCode</code>就是-1，所以如果你想调用<code>startActivityForResult</code>的时候，注意不能把<code>requestCode</code>设置为-1，否则它的效果就跟<code>startActivity</code>一样了，不会再回调<code>onActivityResult</code>！，再看看<code>startActivityForResult</code>的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">	Instrumentation.ActivityResult ar = mInstrumentation.execStartActivity(</span><br><span class="line">            <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">            intent, requestCode, options);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，Activity内部是使用<code>mInstrumentation</code>（<code>Instrumentation</code>类型）执行<code>execStartActivity</code>方法来实现<code>Activity</code>跳转的，执行完毕后会返回一个<code>Instrumentation.ActivityResult</code>。</p>
<p>然后查看<code>Instrumentation::execStartActivity</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	// ...</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span></span></span><br><span class="line"><span class="function">        .<span class="title">startActivity</span><span class="params">(whoThread, who.getBasePackageName()</span>, intent,</span></span><br><span class="line"><span class="function">                intent.<span class="title">resolveTypeIfNeeded</span><span class="params">(who.getContentResolver()</span>),</span></span><br><span class="line"><span class="function">                token, target !</span>= <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过<code>ActivityManagerNative.getDefault()</code>获得一个<code>IActivityManager</code>的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> gDefault.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 通过Binder IPC获取ActivityManager（IBinder）</span></span><br><span class="line">        IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        IActivityManager am = asInterface(b);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> am;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    IActivityManager in =</span><br><span class="line">        (IActivityManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">    <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先通过Binder IPC的方式从服务端获取一个<code>Activity Manager</code>，然后通过<code>ActivityManagernative</code>封装成一个代理<code>ActivityManagerProxy</code>对象，然后调用<code>startActivity</code>也是使用了Binder IPC进行与服务器端的通信，（整个Android系统的通信机制使用了大量的Binder IPC，这个以后再专门讨论这个吧），接着，我们进入到了<code>com.android.server.am.ActivityManagerService</code>的<code>startActivity</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo, resultWho, requestCode, startFlags, profilerInfo, options, UserHandle.getCallingUserId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来的调用链：</p>
<p>-&gt; <code>startActivityAsUser</code><br>-&gt; <code>startActivityMayWait</code><br>-&gt; <code>startActivityLocked</code><br>-&gt; <code>startActivityUncheckedLocked</code><br>-&gt; <code>targetStack.startActivityLocked(r, newTask, doResume, keepCurTransition, options)</code><br>-&gt; <code>mStackSupervisor.resumeTopActivitiesLocked(this, r, options)</code><br>-&gt; <code>resumeTopActivityInnerLocked(prev, options);</code><br>-&gt; <code>mStackSupervisor.startSpecificActivityLocked(next, true, true)</code></p>
<p><code>startSpecificActivityLocked</code>方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">    ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">            r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>, <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先从<code>mService</code>找出对应需要启动Activity的进程（通过进程名字和uid，进程名字可以在<code>AndroidManifest.xml</code>中配置）如果可以获取到，说明这个Activity所属的进程已经存在了，也就是说app已经在运行了，那就会调用<code>realStartActivityLocked</code>，否则，如果该Activity所在的App是第一次启动，则会调用<code>mService.startProcessLocked</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(<span class="comment">/*...*/</span>)</span></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	startProcessLocked(app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName, ApplicationInfo info, <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags, String hostingType, ComponentName hostingName, <span class="keyword">boolean</span> allowWhileBooting, <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid, <span class="keyword">boolean</span> keepIfLarge, String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	app = getProcessRecordLocked(processName, info.uid, keepIfLarge);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">		app = newProcessRecordLocked(info, processName, isolated, isolatedUid);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, String hostingType, String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// entryPoint表示一个类，它用来作为新创建的进程的主入口，会调用这个类的静态main方法，这个参数在startProcessLocked方法中会被检查重置，如果是null的话，就默认是android.app.ActivityThread。</span></span><br><span class="line">	<span class="keyword">if</span> (entryPoint == <span class="keyword">null</span>) entryPoint = <span class="string">"android.app.ActivityThread"</span>;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	Process.ProcessStartResult startResult = Process.start(entryPoint,</span><br><span class="line">            app.processName, uid, uid, gids, debugFlags, mountExternal,</span><br><span class="line">            app.info.targetSdkVersion, app.info.seinfo, requiredAbi, </span><br><span class="line">            instructionSet, app.info.dataDir, entryPointArgs);</span><br><span class="line">	<span class="comment">// ...	</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这3个重载方法做的事情就是，先根据进程名字调用<code>getProcessRecordLocked()</code>获取<code>ProcessRecord</code>，如果<code>ProcessRecord</code>不存在，则调用<code>newProcessRecordLocked()</code>方法建立一个<code>ProcessRecord</code>，并且新的<code>ProcessRecord</code>绑定了<code>ApplicationInfo</code>，<code>uid</code>等信息，但后进入第三个重载方法，执行新建、启动进程。</p>
<p>再看<code>Process::start</code>的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ProcessStartResult <span class="title">start</span><span class="params">(<span class="comment">/*...*/</span>)</span></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids,</span><br><span class="line">              debugFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class="line">              abi, instructionSet, appDataDir, zygoteArgs);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就是通过<code>Zygote</code>进程<code>fork</code>一个新的进程作为app的进程。这里要需要讲的一个参数是<code>processClass</code>，这个参数表示一个类，它用来作为新创建的进程的主入口，会调用这个类的静态<code>main</code>方法，这个参数在<code>startProcessLocked</code>方法中会被检查重置，如果是null的话，就默认是<code>android.app.ActivityThread</code>。</p>
<p>现在App的进程也创建成功了，就会进入<code>android.app.ActivityThread</code>的静态的<code>main</code>中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// 初始化主线程Looper</span></span><br><span class="line">	Looper.prepareMainLooper();</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>);	</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// 启动消息循环</span></span><br><span class="line">	Looper.loop()</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后创建了一个<code>ActivityThread</code>，说明每当一个新的app进程被创建，都会对应一个新的<code>ActivityThread</code>实例，然后调用它的<code>attach</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (!system) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">final</span> IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		mgr.attachApplication(mAppThread);</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再次通过Binder IPC调用<code>ActivityManagerProxy</code>的<code>attachApplication</code>，传入的<code>ApplicationThread</code>（Binder）参数用于在服务端进行回调通信。最后进入<code>ActivityManagerService::attachApplication</code>，再调用<code>attachApplicationLocked(thread, callingPid)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread, <span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	app = mPidsSelfLocked.get(pid);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	app.makeActive(thread, mProcessStats);</span><br><span class="line">    app.curAdj = app.setAdj= -<span class="number">100</span>;</span><br><span class="line">    app.curSchedGroup = app.setSchedGroup = Process.THREAD_GROUP_DEFAULT;</span><br><span class="line">    app.forcingToForeground = <span class="keyword">null</span>;</span><br><span class="line">    updateProcessForegroundLocked(app, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    app.hasShownUi = <span class="keyword">false</span>;</span><br><span class="line">    app.debugging = <span class="keyword">false</span>;</span><br><span class="line">    app.cached = <span class="keyword">false</span>;</span><br><span class="line">    app.killedByAm = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	thread.bindApplication(processName, appInfo, providers, app.instrumentationClass, profilerInfo, app.instrumentationArguments, app.instrumentationWatcher, app.instrumentationUiAutomationConnection, testMode, enableOpenGlTrace, enableTrackAllocation, isRestrictedBackupMode || !normalMode, app.persistent, <span class="keyword">new</span> Configuration(mConfiguration), app.compat, getCommonServicesLocked(app.isolated), mCoreSettingsObserver.getCoreSettingsLocked());</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (normalMode) &#123;</span><br><span class="line">	    <span class="keyword">try</span> &#123;</span><br><span class="line">	        <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</span><br><span class="line">	            didSomething = <span class="keyword">true</span>;</span><br><span class="line">	        &#125;</span><br><span class="line">	    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">	        Slog.wtf(TAG, <span class="string">"Exception thrown launching activities in "</span> + app, e);</span><br><span class="line">	        badApp = <span class="keyword">true</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，通过pid获取刚刚创建的进程，然后对app进行一些初始化工作，然后调用<code>bindApplication</code>远程调用客户端<code>ActivityThread::bindApplication</code>，再通过<code>Handler</code>调用到<code>ActivityThread::handleBindApplication</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindApplication</span><span class="params">(AppBindData data)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">final</span> ContextImpl appContext = ContextImpl.createAppContext(<span class="keyword">this</span>, data.info);</span><br><span class="line">	<span class="keyword">if</span> (data.instrumentationName != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		mInstrumentationPackageName = ii.packageName;</span><br><span class="line">        mInstrumentationAppDir = ii.sourceDir;</span><br><span class="line">        mInstrumentationSplitAppDirs = ii.splitSourceDirs;</span><br><span class="line">        mInstrumentationLibDir = ii.nativeLibraryDir;</span><br><span class="line">        mInstrumentedAppDir = data.info.getAppDir();</span><br><span class="line">        mInstrumentedSplitAppDirs = data.info.getSplitAppDirs();</span><br><span class="line">        mInstrumentedLibDir = data.info.getLibDir();</span><br><span class="line"></span><br><span class="line">        ApplicationInfo instrApp = <span class="keyword">new</span> ApplicationInfo();</span><br><span class="line">        instrApp.packageName = ii.packageName;</span><br><span class="line">        instrApp.sourceDir = ii.sourceDir;</span><br><span class="line">        instrApp.publicSourceDir = ii.publicSourceDir;</span><br><span class="line">        instrApp.splitSourceDirs = ii.splitSourceDirs;</span><br><span class="line">        instrApp.splitPublicSourceDirs = ii.splitPublicSourceDirs;</span><br><span class="line">        instrApp.dataDir = ii.dataDir;</span><br><span class="line">        instrApp.nativeLibraryDir = ii.nativeLibraryDir;</span><br><span class="line">        LoadedApk pi = getPackageInfo(instrApp, data.compatInfo,</span><br><span class="line">                appContext.getClassLoader(), <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        ContextImpl instrContext = ContextImpl.createAppContext(<span class="keyword">this</span>, pi);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">java.lang.ClassLoader cl = instrContext.getClassLoader();</span><br><span class="line">        mInstrumentation = (Instrumentation) cl.loadClass(data.instrumentationName.getClassName()).newInstance();</span><br><span class="line">        mInstrumentation.init(<span class="keyword">this</span>, instrContext, appContext, <span class="keyword">new</span> ComponentName(ii.packageName, ii.name), data.instrumentationWatcher, data.instrumentationUiAutomationConnection);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	Application app = data.info.makeApplication(data.restrictedBackupMode, <span class="keyword">null</span>);</span><br><span class="line">    mInitialApplication = app;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，创建一个当前App的<code>Context</code>，然后如果<code>data.instrumentationName != null</code>，则初始化<code>Instrumentation</code>相关的变量，并创建<code>Instrumentation</code>的<code>ApplicationInfo</code>等对象来创建<code>Instrumentation</code>的<code>Context</code>，然后创建<code>Instrumentation</code>对象，并调用它的<code>init</code>方法进行初始化。如果<code>data.instrumentationName == null</code>，则new一个<code>Instrumentation</code>（在一个进程中只会有一个<code>Instrumentation</code>实例）然后创建<code>Application</code>对象，并调用它的<code>onCreate</code>方法，这样<code>Application</code>就会被回调了。</p>
<p>然后我们回到<code>ActivityManagerService::attachApplicationLocked</code>方法，远程执行完<code>thread.bindApplication</code>方法之后，接下来会调用<code>mStackSupervisor.attachApplicationLocked(app)</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	ActivityRecord hr = stack.topRunningActivityLocked(<span class="keyword">null</span>);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	realStartActivityLocked(hr, app, <span class="keyword">true</span>, <span class="keyword">true</span>)</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先通过<code>topRunningActivityLocked</code>从堆栈顶端获取要启动的Activity，然后<code>realStartActivityLocked(hr, app, true, true)</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">            ProcessRecord app, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken, System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration), <span class="keyword">new</span> Configuration(stack.mOverrideConfig), r.compat, r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results, newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续通过Binder IPC远程调用<code>scheduleLaunchActivity</code>方法，然后进入<code>ActivityThread</code>的<code>scheduleLaunchActivity</code>方法中，然后通过<code>Handler</code>进入<code>handleLaunchActivity</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">	handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward, !r.activity.mFinished &amp;&amp; !r.startsNotResumed);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先调用<code>performLaunchActivity</code>方法返回一个<code>Activity</code>，然后调用<code>handleResumeActivity</code>方法让该<code>Activity</code>进入<code>onResume</code>状态。所以很显然在<code>performLaunchActivity</code>中肯定是生成了<code>Activity</code>实例，并调用了<code>onCreate</code>方法了，来看下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">	<span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">	    r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">	            Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">    activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token, r.ident, app, r.intent, r.activityInfo, title, r.parent, r.embeddedID, r.lastNonConfigurationInstances, config, r.referrer, r.voiceInteractor);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">     mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state, r.persistentState);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	mInstrumentation.callActivityOnPostCreate(activity, r.state, r.persistentState);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，初始化<code>LoadedApk</code>，然后通过<code>Instrumentation</code>来创建一个<code>Activity</code>实例，通过<code>createBaseContextForActivity</code>方法创建一个<code>Activity Context</code>，调用<code>activity</code>的<code>attach</code>方法，然后依次触发该<code>Activity</code>的<code>onCreate</code>、<code>onRestoreInstanceState</code>、<code>onPostCreate</code>等生命周期方法。</p>
<p><code>createBaseContextForActivity</code>方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Context <span class="title">createBaseContextForActivity</span><span class="params">(ActivityClientRecord r, <span class="keyword">final</span> Activity activity)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	ContextImpl appContext = ContextImpl.createActivityContext(<span class="keyword">this</span>, r.packageInfo, displayId, r.overrideConfig);</span><br><span class="line">    appContext.setOuterContext(activity);</span><br><span class="line">    Context baseContext = appContext;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>ContextImpl::createActivityContext</code>创建的<code>Context</code>对象，可以发现，不论是<code>System Context/App Context/Activity Context</code>，这些<code>Context</code>都是通过<code>ContextImpl</code>生成的，具体这里再挖个坑先。</p>
<p>再继续进入<code>Activity::attach</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">            Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">            NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration config, String referrer, IVoiceInteractor voiceInteractor)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	mMainThread = aThread;</span><br><span class="line">    mInstrumentation = instr;</span><br><span class="line">    mToken = token;</span><br><span class="line">    mIdent = ident;</span><br><span class="line">    mApplication = application;</span><br><span class="line">    mIntent = intent;</span><br><span class="line">    mReferrer = referrer;</span><br><span class="line">    mComponent = intent.getComponent();</span><br><span class="line">    mActivityInfo = info;</span><br><span class="line">    mTitle = title;</span><br><span class="line">    mParent = parent;</span><br><span class="line">    mEmbeddedID = id;</span><br><span class="line">    mLastNonConfigurationInstances = lastNonConfigurationInstances;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面对<code>Activity</code>与<code>ActivityThread</code>、<code>Instrumentation</code>等进行了绑定，所以说每个<code>Activity</code>都含有一个<code>ActivityThread</code>引用和一个<code>Instrumentation</code>引用，而<code>ActivityThread</code>实例和<code>Instrumentation</code>实例在一个进程中都只有一个实例，因为<code>ActivityThread</code>是在进程被创建成功后，进入<code>ActivityThread</code>的<code>static main()</code>时才会被创建，而<code>Instrumentation</code>则是在<code>ActivityThread</code>被创建后进行<code>attach</code>的之后被创建。</p>
<h3 id="启动应用流程所有方法链调用总结："><a href="#启动应用流程所有方法链调用总结：" class="headerlink" title="启动应用流程所有方法链调用总结："></a>启动应用流程所有方法链调用总结：</h3><ul>
<li><p><code>Activity::startActivity</code></p>
</li>
<li><p><code>Activity::startActivityForResult</code></p>
</li>
<li><p><code>Instrumentation::execStartActivity</code>：<br>携带参数：<br>1. <code>who</code>：from的Context<br>2. <code>contextThread</code>：from的<code>ActivityThread</code>的<code>ApplicationThread</code>，<code>ApplicationThread</code>中可以通过Binder IPC提供给服务端回调<code>Activity</code>生命周期等操作（from的主线程）。<br>3. <code>mToken</code>：<code>Binder</code>类型，用来标识from的Activity，可能为null。<br>4. <code>target</code>：from的Activity（所以是用来接收跳转结果的），如果不是从Activity跳转则为null。<br>5. <code>intent</code>：跳转Intent。<br>6. <code>requestCode</code>：如果是<code>startActivity</code>，则为-1。<br>7. <code>options</code>：额外Bundle数据。</p>
</li>
<li><p><code>ActivityManagerProxy::startActivity()</code>：<br>携带参数：<br>1. <code>caller</code>：上面的<code>contextThread</code>，from主线程。<br>2. <code>callingPackage</code>：from的Context包名。<br>3. <code>intent</code>：跳转Intent。<br>4. <code>resolvedType</code>：跳转Intent的MIME类型。<br>5. <code>resultTo</code>：上面的<code>token</code>，<code>Binder</code>类型，用来标识from的Activity。<br>6. <code>resultWho</code>：from的Activity的mEmbeddedID（唯一标示字符串）<br>7. <code>requestCode</code>：如果是<code>startActivity</code>，则为-1。<br>8. <code>startFlags</code>：默认传入为0。<br>9. <code>profilerInfo</code>：默认传入为null。<br>10. <code>options</code>：额外Bundle数据。</p>
</li>
<li><p><code>ActivityManagerService::startActivity()</code>（通过Binder IPC调用）：<br>携带参数跟上面一样。</p>
</li>
<li><p><code>ActivityManagerService::startActivityAsUser</code><br>携带参数包括<code>ActivityManagerService::startActivity()</code>所有的参数，最再加一个：<br>1. <code>userId</code>：userId，根据给当前进程分配的Linux UID（这个UID可以用来让上层系统服务进行身份识别和权限检查）得到一个userId（如果不是多用户，则直接返回0）。</p>
</li>
<li><p><code>ActivityStackSupervisor::startActivityMayWait()</code><br>参数：<br>1. <code>caller</code>：上面的<code>caller/contextThread</code>，from主线程。<br>2. <code>callingUid</code>：调用用户uid。<br>3. <code>callingPackage</code>：from的Context包名。<br>4. <code>intent</code>：跳转Intent。<br>5. <code>resolvedType</code>：跳转Intent的MIME类型。<br>6. <code>voiceSession</code>：传null。<br>7. <code>voiceInteractor</code>：传null。<br>8. <code>resultTo</code>：上面的<code>resultTo/token</code>，<code>Binder</code>类型，用来标识from的Activity。<br>9. <code>resultWho</code>：from的Activity的mEmbeddedID（唯一标示字符串）<br>10. <code>requestCode</code>：如果是<code>startActivity</code>，则为-1。<br>11. <code>startFlags</code>：传null。<br>12. <code>profilerInfo</code>：传null。<br>13. <code>outResult</code>：传null。<br>14. <code>config</code>：传null。<br>15. <code>options</code>：额外数据。<br>16. <code>ignoreTargetSecurity</code>：false。<br>17. <code>userId</code>：上面的<code>userId</code>，根据给当前进程分配的Linux UID（这个UID可以用来让上层系统服务进行身份识别和权限检查）得到一个userId（如果不是多用户，则直接返回0）。<br>18. <code>iContainer</code>：传null。<br>19. <code>inTask</code>：null。</p>
</li>
<li><p><code>ActivityStackSupervisor::startActivityLocked()</code>：<br>参数：<br>1. <code>caller</code>：上面的<code>caller/contextThread</code>，from主线程。<br>2. <code>intent</code>：跳转Intent。<br>3. <code>resolvedType</code>：跳转Intent的MIME类型。<br>4. <code>aInfo</code>：<code>ActivityInfo</code>类型，解析from的Activity的Intent信息。<br>5. <code>voiceSession</code>：传null。<br>6. <code>voiceInteractor</code>：传null。<br>7. <code>resultTo</code>：上面的<code>resultTo/token</code>，<code>Binder</code>类型，用来标识from的Activity。<br>8. <code>resultWho</code>：from的Activity的mEmbeddedID（唯一标示字符串）<br>9. <code>requestCode</code>：如果是<code>startActivity</code>，则为-1。<br>10. <code>callingPackage</code>：from的Context包名。<br>11. <code>startFlags</code>：传null。<br>12. <code>options</code>：额外数据。<br>13. <code>ignoreTargetSecurity</code>：false。<br>14. <code>componentSpecified</code>：是否显示指定了<code>component</code>。<br>15. <code>outActivity</code>：传null。<br>16. <code>container</code>：上面的<code>iContainer</code>，转型成了<code>ActivityContainer</code>，还是null。<br>17. <code>inTask</code>：null。<br>在这个方法中，通过<code>ProcessRecord callerApp = mService.getRecordForAppLocked(caller);</code>获取到之前创建的<code>ProcessRecord</code>，然后从<code>Activity</code>栈中根据<code>resultTo/token</code>获取到对应from Activity的<code>ActivityRecord</code>（sourceRecord），然后<strong>创建将要跳转的Activity的ActivityRecord对象</strong>（<code>Token</code>也是在这个时候生成的）。</p>
</li>
<li><p><code>ActivityStackSupervisor::startActivityUncheckedLocked()</code>：<br>参数：<br>1. <code>r</code>：<code>ActivityRecord</code>类型，就是<code>ActivityStackSupervisor::startActivityLocked()</code>中创建的将要跳转的Activity的ActivityRecord对象。<br>2. <code>sourceRecord</code>：就是<code>ActivityStackSupervisor::startActivityLocked()</code>方法获取的from Activity的<code>sourceRecord</code>。<br>3. <code>voiceSession</code>：传null。<br>4. <code>voiceInteractor</code>：传null。<br>5. <code>startFlags</code>：传null。<br>6. <code>doResume</code>：传true。<br>7. <code>options</code>：额外数据。<br>8. <code>inTask</code>：null。<br>这个方法中有大量的代码来处理<code>task/stack</code>等方面的逻辑，以后再仔细深入这个方法。</p>
</li>
<li><p><code>ActivityStrack::startActivityLocked()</code>：<br>方法调用者：<code>ActivityStack</code>类型，<br><code>targetStack</code>：在<code>ActivityStackSupervisor::startActivityUncheckedLocked()</code>中确定的需要添加到的<code>ActivityStack</code>。<br>参数：<br>1. <code>r</code>：<code>ActivityRecord</code>类型，就是<code>ActivityStackSupervisor::startActivityLocked()</code>中创建的跳转的Activity的ActivityRecord对象。<br>2. <code>newTask</code>：是否<code>Intent</code>是否设置了<code>Intent.FLAG_ACTIVITY_NEW_TASK</code>。<br>3. <code>doResume</code>：传true。<br>4. <code>keepCurTransition</code>：这个具体后面再研究，跟<code>Intent</code>的flag有关。<br>5. <code>options</code>：额外数据。<br>同样，这个方法中有大量的代码来处理<code>task/stack</code>等方面的逻辑，以后再仔细深入这个方法<strong>（执行完这个方法后，<code>ActivityRecord</code>就会被真正加入到<code>ActivityStack</code>中）</strong>。</p>
</li>
<li><p><code>ActivityStackSupervisor::resumeTopActivitiesLocked()</code>：<br>参数：<br>1. <code>targetStack</code>：在<code>ActivityStackSupervisor::startActivityUncheckedLocked()</code>中确定的需要添加到的<code>ActivityStack</code>。<br>2. <code>target</code>：<code>ActivityRecord</code>类型，就是<code>ActivityStackSupervisor::startActivityLocked()</code>中创建的跳转的Activity的ActivityRecord对象。<br>3. <code>targetOptions</code>：额外数据。</p>
</li>
<li><p><code>ActivityStack::resumeTopActivityLocked()</code>：<br>参数：<br>1. <code>prev</code>：<code>ActivityRecord</code>类型，就是<code>ActivityStackSupervisor::startActivityLocked()</code>中创建的跳转的Activity的ActivityRecord对象。<br>2. <code>options</code>：额外数据。</p>
</li>
<li><p><code>ActivityStack::resumeTopActivityInnerLocked()</code>：<br>参数：<br>1. <code>prev</code>：<code>ActivityRecord</code>类型，就是<code>ActivityStackSupervisor::startActivityLocked()</code>中创建的跳转的Activity的ActivityRecord对象。<br>2. <code>options</code>：额外数据。</p>
</li>
<li><p><code>ActivityStackSupervisor::startSpecificActivityLocked()</code>：<br>参数：<br>1. <code>r</code>：最顶部没有处于finishing的Activity，就是刚刚在<code>startActivityLocked</code>中加入的将要跳转的<code>ActivityRecord</code>，通过<code>topRunningActivityLocked(null)</code>查找<br>2. <code>andResume</code>：传true<br>3. <code>checkConfig</code>：传true</p>
</li>
<li><p><code>ActivityManagerService::startProcessLocked()</code>：<br>参数：<br>1. <code>processName</code>：创建进程的名称，就是<code>ActivityStack::startSpecificActivityLocked()</code>中的<code>r.processName</code><br>2. <code>info</code>：<code>ApplicationInfo</code>，也是<code>r.info.applicaitonInfo</code>，具体可以查看<code>ActivityStackSupervisor::startActivityLocked()</code>中创建<code>ActivityRecord</code>的代码。<br>3. <code>knownToBeDead</code>：传true。<br>4. <code>intentFlags</code>：传0。<br>5. <code>hostingType</code>：传字符串“activity”。<br>6. <code>hostingName</code>：<code>ComponentName</code>类型，<code>intent</code>中的<code>Componentname</code><br>7. <code>allowWhileBooting</code>：传false。<br>8. <code>isolated</code>：传false<br>9. <code>keepIfLarge</code>传true</p>
</li>
<li><p><code>ActivityManagerService::startProcessLocked()</code>（重载方法）：<br>参数包含上面所有，多了以下几个：<br>1. <code>isolatedUid</code>：传0<br>2. <code>abiOverride</code>：传null<br>3. <code>entryPoint</code>：传null<br>4. <code>entryPointArgs</code>传null<br>5. <code>crashHandler</code>传null<br>注意：在这个方法中，会创建新进程的<code>ProcessRecord</code>对象，并绑定<code>ApplicationInfo</code>等信息，这样，启动进程后进行<code>bindApplicaiton</code>的时候就可以根据进程PID获取到所有的<code>ApplicationInfo</code>信息了。</p>
</li>
<li><p><code>ActivityManagerService::startProcessLocked()</code>（重载方法）：<br>参数：<br>1. <code>app</code>：<code>ProcessRecord</code>类型，创建的进程。<br>2. <code>hostingType</code>：传字符串“activity”。<br>3. <code>hostingNameStr</code>：通过<code>hostingName</code>生成的字符串（包名 + “/“ + 类的简单类名）<br>4. <code>abiOverride</code>：传null<br>5. <code>entryPoint</code>：传null<br>6. <code>entryPointArgs</code>传null</p>
</li>
<li><p><code>Process.start()</code><br>参数（省略部分参数）：<br>1. <code>processClass</code>：上面的<code>entryPoint</code>，但是并不是null了，而是<code>android.app.ActivityThread</code>，因为在<code>ActivityManagerService::startProcessLocked()</code>中被设置默认值了，它表示一个类，用来作为新创建的进程的主入口，会调用这个类的静态main方法。所以启动完这个进程就会进入<code>ActivityThread</code>的<code>static main()</code>方法。<br>2. <code>zygoteArgs</code>：fork zygote进程时的参数。</p>
</li>
<li><p><code>ActivityThread::main()</code></p>
</li>
<li><p><code>ActivityThread::attach()</code></p>
</li>
<li><p><code>ActivityManagerProxy::attachApplication()</code>：<br>参数：<br>1. <code>mAppThread</code>：<code>ApplicationThread()</code>类型，Binder，用来提供给AMS调用。</p>
</li>
<li><p><code>ActivityManagerService::attachApplication()</code>：<br>参数：<br>1. <code>mAppThread</code>：<code>ApplicationThread()</code>类型，Binder，用来提供给AMS调用。</p>
</li>
<li><p><code>ActivityManagerService::attachApplicationLocked()</code>：<br>参数：<br>1. <code>thread</code>：<code>ApplicationThread()</code>类型，Binder，用来提供给AMS调用。上面的<code>mAppThread</code>。<br>2. <code>pid</code>：当前调用的进程PID。</p>
</li>
<li><p><code>IApplicationThread::bindApplication()</code>：<br>方法调用调用者：上面的<code>thread/mAppThread</code>，Binder，用来提供给AMS调用。<br>参数（省略部分参数）：<br>1. <code>packageName</code>：用的进程名字<code>processName</code><br>2. <code>info</code>：<code>ApplicationInfo</code>类型，从<code>ProcessRecord</code>中的<code>instrumentationInfo或者info</code>，这个<code>ApplicationInfo</code>是在建立<code>ProcessRecord</code>时就保存了。</p>
</li>
<li><p><code>ActivityThread::bindApplication()</code>：<br>参数：同上</p>
</li>
<li><p><code>ActivityThread::handleBindApplication()</code>：<br>通过Handler调用。<br>参数：<br>1. <code>data</code>：<code>AppBindData</code>类型，里面包含的类型<code>processName</code>，<code>providers</code>，<code>instrumentationName</code>，<code>instrumentationArgs</code>，<code>instrumentationWatcher</code>，<code>instrumentationUiAutomationConnection</code>，<code>config</code>等数据。</p>
</li>
<li><p><code>ActivityManagerService</code>中的<code>ActivityThread::bindApplication()</code>执行完毕之后</p>
</li>
<li><p><code>ActivityStackSupervisor::attachApplicationLocked()</code>：<br>参数：<br>1. <code>app</code>：新建的进程绑定的<code>ProcessRecord</code>。</p>
</li>
<li><p><code>ActivityStackSupervisor::realStartActivityLocked()</code>：<br>参数：<br>1. <code>r</code>：<code>ActivityRecord</code>类型，topRunningActivityLocked从堆栈顶端获取要启动的Activity。<br>2. <code>app</code>：新建的进程绑定的<code>ProcessRecord</code>。<br>3. <code>andResume</code>：传入true<br>4. <code>checkConfig</code>：传入true</p>
</li>
<li><p><code>IApplicationThread::scheduleLaunchActivity()</code>：<br>参数（部分）：<br>1. <code>intent</code>：将要启动的<code>ActivityRecord</code>中的<code>intent</code>。<br>2. <code>token</code>：将要启动的<code>ActivityRecord</code>中的<code>token</code>。<br>3. <code>info</code>：将要启动的<code>ActivityRecord</code>中的<code>ApplicationInfo</code>。</p>
</li>
<li><p><code>ActivityThread::scheduleLaunchActivity()</code>：<br>Binder IPC调用，参数与<code>IApplicationThread::scheduleLaunchActivity()</code>相同。</p>
</li>
<li><p><code>ActivityThread::handleLaunchActivity()</code>：<br>该方法通过Handler调用，参数同上。<br>1. <code>r</code>：<code>ActivityClientRecord</code>类型，在<code>ActivityThread::scheduleLaunchActivity()</code>中封装，包括的数据有<code>token</code>, <code>ident</code>, <code>intent</code>, <code>activityInfo</code>等等，但是<code>LoadedApk</code>是这时根据包名从<code>ActivityThread</code>中弱引用缓存中获取的的。<br>2. <code>customIntent</code>：null</p>
</li>
<li><p><code>ActivityThread::performLaunchActivity()</code>：<br>参数与<code>ActivityThread::handleLaunchActivity()</code>相同。</p>
</li>
<li><p><code>Activity::attach()</code>：<br>参数（部分）：<br>1. <code>context</code>：<code>ActivityThread::performLaunchActivity()</code>中创建的<code>Activity Context</code>。<br>2. <code>aThread</code>：<code>ActivityThread</code>类型，主线程，一个进程都共用一个。<br>3. <code>token</code>：构建<code>ActivityRecord</code>时生成的<code>token</code>。<br>4. <code>application</code>：<code>Application</code>第一次的时候创建一遍。<br>5. <code>intent</code>：将要启动的ActivityRecord中的intent。<br>6. <code>info</code>：<code>ActivityInfo</code>类型，将要启动的ActivityRecord中的<code>ActivityInfo</code>。</p>
</li>
<li><p><code>Instrumentation::callActivityOnCreate()</code>：<br>参数（部分）：<br>1. <code>activity</code>：<code>ActivityThread::performLaunchActivity()</code>中创建的<code>Activity</code>。</p>
</li>
<li><p><code>Activity::performCreate()</code></p>
</li>
<li><p><code>Activity::onCreate()</code></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/12/02/Android-Android系统启动流程源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/12/02/Android-Android系统启动流程源码分析/" itemprop="url">[Android]Android系统启动流程源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-02T18:58:00+08:00">
                2015-12-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/12/02/Android-Android系统启动流程源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/12/02/Android-Android系统启动流程源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5013863.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5013863.html</a>
</strong></font>

<h3 id="Android系统启动流程源码分析"><a href="#Android系统启动流程源码分析" class="headerlink" title="Android系统启动流程源码分析"></a>Android系统启动流程源码分析</h3><p>首先我们知道，<code>Android</code>是基于<code>Linux</code>的，当<code>Linux</code>内核加载完成时就会自动启动一个<code>init</code>的进程。<br>又因为我们每当我们启动一个App时，就会生成一个新的<code>dalvik</code>实例，并处于一个新的进程（当然一个App也可能是多进程的）。<br>当我们打开第一个App的时候，就会通过<code>init</code>进程fork出一个<code>zygote</code>进程。之后打开新的App的时候都会<code>fork</code>之前的<code>zygote</code>进程。</p>
<p>当<code>fork</code>一个<code>zygote</code>进程时，会进入<code>com.android.internal.os.ZygoteInit</code>的<code>main</code>方法进行初始化操作：</p>
<ul>
<li><p>预加载资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">preloadClasses();</span><br><span class="line">preloadResources();</span><br><span class="line">preloadOpenGL();</span><br><span class="line">preloadSharedLibraries();</span><br><span class="line">preloadTextResources();</span><br><span class="line"><span class="comment">// Ask the WebViewFactory to do any initialization that must run in the zygote process,</span></span><br><span class="line"><span class="comment">// for memory sharing purposes.</span></span><br><span class="line">WebViewFactory.prepareWebViewInZygote();</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>从第一个<code>zygote</code>进程<code>fork</code>出<code>SystemServer</code>进程，这个进程提供各种<code>ManagerService</code>。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">startSystemServer(abiList, socketName);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">(String abiList, String socketName)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> MethodAndArgsCaller, RuntimeException </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> pid;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	String args[] = &#123;</span><br><span class="line">            <span class="string">"--setuid=1000"</span>,</span><br><span class="line">            <span class="string">"--setgid=1000"</span>,</span><br><span class="line">            <span class="string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007"</span>,</span><br><span class="line">            <span class="string">"--capabilities="</span> + capabilities + <span class="string">","</span> + capabilities,</span><br><span class="line">            <span class="string">"--nice-name=system_server"</span>,</span><br><span class="line">            <span class="string">"--runtime-args"</span>,</span><br><span class="line">            <span class="string">"com.android.server.SystemServer"</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">    <span class="comment">/* Request to fork the system server process */</span></span><br><span class="line">    pid = Zygote.forkSystemServer(</span><br><span class="line">            parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">            parsedArgs.gids,</span><br><span class="line">            parsedArgs.debugFlags,</span><br><span class="line">            <span class="keyword">null</span>,</span><br><span class="line">            parsedArgs.permittedCapabilities,</span><br><span class="line">            parsedArgs.effectiveCapabilities);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Fork完<code>SystemServer</code>进程之后，继续接下来在<code>handleSystemServerProcess</code>方法中传入参数到<code>SystemServer</code>：</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>注意，这里传入的参数是fork<code>SystemServer</code>进程后剩下的参数（<code>parsedArgs.remainingArgs</code>），其实只剩下了<code>com.android.server.SystemServer</code>这个参数了。</p>
<p>接下来继续调用<code>applicationInit</code> ，传入参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">applicationInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> Arguments args;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	args = <span class="keyword">new</span> Arguments(argv);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析成<code>Arguments</code>后，得到了一个<code>startClass</code>对象，这个<code>startClass</code>其实就是刚刚的那个<code>com.android.server.SystemServer</code>。</p>
<p>接下来，继续调用 <code>invokeStaticMain</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeStaticMain</span><span class="params">(String className, String[] argv, ClassLoader classLoader)</span> <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">	Class&lt;?&gt; cl;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	cl = Class.forName(className, <span class="keyword">true</span>, classLoader);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	m = cl.getMethod(<span class="string">"main"</span>, <span class="keyword">new</span> Class[] &#123; String[].class &#125;);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> ZygoteInit.MethodAndArgsCaller(m, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是调用通过反射得到<code>com.android.server.SystemServer</code>（也就是上面的<code>startClass</code>）的<code>main(argv[])</code>方法，然后手动抛一个携带了这个<code>main(argv[])</code>方法的<code>MethodAndArgsCaller</code>异常，但是这个异常是在<code>ZygoteInit.main()</code>方法中被catch，然后去调用它的<code>run()</code>方法，当然这个<code>run()</code>方法中会再去通过反射调用携带的<code>main()</code>方法（这个绕法真是有点坑爹－－。）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodAndArgsCaller</span> <span class="keyword">extends</span> <span class="title">Exception</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	    mMethod.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[] &#123; mArgs &#125;);</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>绕了这么一大圈，终于通过<code>MethodAndArgsCaller</code>调用<code>SystemServer</code>的<code>main()</code>方法了，代码很简单，直接<code>new</code>了之后<code>run</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> SystemServer().run();</span><br></pre></td></tr></table></figure>
<p>接着，我们看<code>SystemServer</code>的<code>run</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... (省略初始化当前的language、locale、country、指纹、用户等信息的初始化准备工作)</span></span><br><span class="line"><span class="comment">// 设置当前进程设置优先级为THREAD_PRIORITY_FOREGROUND（-2）</span></span><br><span class="line">android.os.Process.setThreadPriority(</span><br><span class="line">    android.os.Process.THREAD_PRIORITY_FOREGROUND);</span><br><span class="line">android.os.Process.setCanSelfBackground(<span class="keyword">false</span>);</span><br><span class="line"><span class="comment">// 初始化主线程Looper</span></span><br><span class="line">Looper.prepareMainLooper();</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 启动消息循环</span></span><br><span class="line">Looper.loop()</span><br></pre></td></tr></table></figure>
<p>然后调用<code>createSystemContext()</code>方法创建初始化<code>system context</code>，这个待会再展开。</p>
<p>创建<code>SystemServiceManager</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);</span><br><span class="line">LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br></pre></td></tr></table></figure></p>
<p>使用<code>SystemServiceManager</code>去通过以下方法创建启动各个<code>Service</code>：<br>1. startBootstrapServices()：</p>
<ul>
<li><code>com.android.server.pm.Installer</code>：提供安装、卸载App等服务</li>
<li><code>com.android.server.am.ActivityServiceManager</code>：提供Activity等组件的管理的服务，这个比较复杂暂且再挖个坑。</li>
<li><code>com.android.server.power.PowerManagerService</code>：电源管理的服务。</li>
<li><code>com.android.server.lights.LightsService</code>：LED管理和背光显示的服务。</li>
<li><code>com.android.server.display.DisplayManagerService</code>：提供显示的生命周期管理，根据物理显示设备当前的情况决定显示配置，在状态改变时发送通知给系统和应用等服务。</li>
<li><code>com.android.server.pm.PackageManagerService</code>：管理所有的<code>.apk</code>。</li>
<li><code>com.android.server.pm.UserManagerService</code>：提供用户相关服务。</li>
<li>通过<code>startSensorService()</code>本地方法启动Sensor服务。</li>
</ul>
<p>2. startCoreServices();</p>
<ul>
<li><code>com.android.server.BatteryService</code>：电量服务，需要<code>LightService</code>。</li>
<li><code>com.android.server.usage.UsageStatsService</code>：提供收集统计应用程序数据使用状态的服务。</li>
<li><code>com.android.server.webkit.WebViewUpdateService</code>：私有的服务（@hide），用于<code>WebView</code>的更新。</li>
</ul>
<p>3. startOtherServices();</p>
<ul>
<li><code>com.android.server.accounts.AccountManagerService</code>：提供所有账号、密码、认证管理等等的服务。</li>
<li><code>com.android.server.content.ContentService</code>：用户数据同步的服务。</li>
<li><code>com.android.server.VibratorService</code>：震动服务。</li>
<li><code>IAlarmManager</code>：提醒服务。</li>
<li><code>android.os.storage.IMountService</code>：存储管理服务。</li>
<li><code>com.android.server.NetworkManagementService</code>：系统网络连接管理服务。</li>
<li><code>com.android.server.net.NetworkStatsService</code>：收集统计详细的网络数据服务。</li>
<li><code>com.android.server.net.NetworkPolicyManagerService</code>：提供低网络策略规则管理服务。</li>
<li><code>com.android.server.ConnectivityService</code>：提供数据连接服务。</li>
<li><code>com.android.server.NetworkScoreService</code>：<code>android.net.NetworkScoreManager</code>的备份服务。</li>
<li><code>com.android.server.NsdService</code>：网络发现服务（Network Service Discovery Service）。</li>
<li><code>com.android.server.wm.WindowManagerService</code>：窗口管理服务。</li>
<li><code>com.android.server.usb.UsbService</code>：USB服务。</li>
<li><code>com.android.server.SerialService</code>：串口服务。</li>
<li><code>com.android.server.NetworkTimeUpdateService</code>：网络时间同步服务。</li>
<li><code>com.android.server.CommonTimeManagementService</code>：管理本地常见的时间配置的服务，当网络配置变化时会重新配置本地服务。</li>
<li><code>com.android.server.input.InputManagerService</code>：事件传递分发服务。</li>
<li><code>com.android.server.TelephonyRegistry</code>：提供电话注册管理的服务。</li>
<li><code>com.android.server.ConsumerIrService</code>：远程控制服务。</li>
<li><code>com.android.server.audio.AudioService</code>：音量、铃声、声道等管理服务。</li>
<li><code>com.android.server.MmsServiceBroker</code>：<code>MmsService</code>的代理，因为<code>MmsService</code>运行在电话进程中，可能随时crash，它会通过一个<code>connection</code>与<code>MmsService</code>建立一个桥梁，<code>MmsService</code>实现了公开的<code>SMS/MMS</code>的API。</li>
<li><code>TelecomLoaderService</code></li>
<li><code>CameraService</code></li>
<li><code>AlarmManagerService</code></li>
<li><code>BluetoothService</code></li>
<li>还有其它很多很多Service，这方法竟然有近1000行……</li>
</ul>
<p>在<code>startOtherServices()</code>方法的最后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mActivityManagerService.systemReady(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 下面仍然是各种Service的启动...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用这个方法用来告诉<code>ActivityManagerService</code>，此时可以运行第三方的代码了（注意：这里的Home界面、Launcher等内置的App也算是第三方的App）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (mSystemReady) &#123;</span><br><span class="line">		<span class="comment">// 回调到SystemServer，继续启动各种Service</span></span><br><span class="line">		<span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">		    goingCallback.run();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	ResolveInfo ri = mContext.getPackageManager().resolveActivity(<span class="keyword">new</span> Intent(Intent.ACTION_FACTORY_TEST), STOCK_PM_FLAGS);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	ActivityInfo ai = ri.activityInfo;</span><br><span class="line">	ApplicationInfo app = ai.applicationInfo;</span><br><span class="line">	<span class="comment">// ...从PackageManager中获取要打开的HomeActivity</span></span><br><span class="line">	mTopComponent = <span class="keyword">new</span> ComponentName(app.packageName, ai.name);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// 启动第一个Home界面</span></span><br><span class="line">	startHomeActivityLocked(mCurrentUserId, <span class="string">"systemReady"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// 广播通知启动完成</span></span><br><span class="line">	broadcastIntentLocked(<span class="comment">/*...*/</span>, mCurrentUserId);</span><br><span class="line">	broadcastIntentLocked(<span class="comment">/*...*/</span>, UserHandle.USER_ALL);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动Home界面的<code>startHomeActivityLocked</code>方法，调用<code>mStackSupervisor</code>启动<code>HomeActivity</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startHomeActivityLocked</span><span class="params">(<span class="keyword">int</span> userId, String reason)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	Intent intent = getHomeIntent();</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	intent.setFlags(intent.getFlags() | Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">	mStackSupervisor.startHomeActivity(intent, aInfo, reason);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Intent <span class="title">getHomeIntent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Intent intent = <span class="keyword">new</span> Intent(mTopAction, mTopData != <span class="keyword">null</span> ? Uri.parse(mTopData) : <span class="keyword">null</span>);</span><br><span class="line">	<span class="comment">// 设置前面获取到的mTopComponent</span></span><br><span class="line">	intent.setComponent(mTopComponent);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	intent.addCategory(Intent.CATEGORY_HOME);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此为止，<code>SystemServer</code> start完毕，并且启动了Home界面。</p>
<p>然后我们再回过头去看看在我们前面创建系统级的<code>Context</code>（<code>createSystemContext</code>）的时候做了什么：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ActivityThread activityThread = ActivityThread.systemMain();</span><br><span class="line">mSystemContext = activityThread.getSystemContext();</span><br><span class="line">mSystemContext.setTheme(android.R.style.Theme_DeviceDefault_Light_DarkActionBar);</span><br></pre></td></tr></table></figure></p>
<p>首先调用了<code>ActivityThread</code>的静态方法<code>systemMain()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ActivityThread <span class="title">systemMain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> thread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建一个<code>ActivityThread</code>，然后调用它的<code>attach()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">thread.attach(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!system) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">        ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, getSystemContext().mPackageInfo);</span><br><span class="line">        mInitialApplication = context.mPackageInfo.makeApplication(<span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">        mInitialApplication.onCreate();</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数<code>system</code>表示，是否是系统级的线程，现在我们是启动整个Android系统，显然当前传入的参数为<code>true</code>。所以进入else，首先，创建一个<code>Instrumentation</code>，<code>Instrumentation</code>是什么？暂时先挖个坑。接着通过<code>System Context</code>创建一个<code>ContextImpl</code>，然后使用它的<code>LoadedApk::makeApplication</code>方法来创建整个应用的<code>Application</code>对象，然后调用<code>Application</code>的<code>onCreate</code>方法。</p>
<p>然后看下<code>LoadedApk::makeApplication</code>方法的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass,</span></span></span><br><span class="line"><span class="function"><span class="params">            Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 只有第一次调用makeApplication才会往下执行</span></span><br><span class="line">	<span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    <span class="keyword">return</span> mApplication;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化系统的Application，所以appClass是"android.app.Application"</span></span><br><span class="line">	String appClass = mApplicationInfo.className;</span><br><span class="line">    <span class="keyword">if</span> (forceDefaultAppClass || (appClass == <span class="keyword">null</span>)) &#123;</span><br><span class="line">        appClass = <span class="string">"android.app.Application"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>);</span><br><span class="line">    app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">            cl, appClass, appContext);</span><br><span class="line">    appContext.setOuterContext(app);</span><br><span class="line">	<span class="comment">// ...	</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建<code>appContext</code>，然后通过<code>Instrumentation</code>生成<code>Application</code>对象，并给<code>appContext</code>设置外部引用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/11/26/Android小技巧/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/11/26/Android小技巧/" itemprop="url">Android小技巧</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-11-26T12:01:00+08:00">
                2015-11-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/11/26/Android小技巧/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/11/26/Android小技巧/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Activity.startActivities()) 常用于在应用程序中间启动其他的Activity.<br>TextUtils.isEmpty()) 简单的工具类,用于检测是否为空<br>Html.fromHtml()) 用于生成一个Html,参数可以是一个字符串.个人认为它不是很快,所以我不怎么经常去用.（我说不经常用它是为了重点突出这句话：请多手动构建 Spannable 来替换 Html.fromHtml），但是它对渲染从 web 上获取的文字还是很不错的。<br>TextView.setError() 在验证用户输入的时候很棒<br>Build.VERSION_CODES 这个标明了当前的版本号,在处理兼容性问题的时候经常会用到.点进去可以看到各个版本的不同特性<br>Log.getStackTraceString()) 方便的日志类工具,方法Log.v()、Log.d()、Log.i()、Log.w()和Log.e()都是将信息打印到LogCat中，有时候需要将出错的信息插入到数据库或一个自定义的日志文件中，那么这种情况就需要将出错的信息以字符串的形式返回来，也就是使用static String getStackTraceString(Throwable tr)方法的时候.<br>LayoutInflater.from() 顾名思义,用于Inflate一个layout,参数是layout的id.这个经常写Adapter的人会用的比较多.<br>ViewConfiguration.getScaledTouchSlop() 使用 ViewConfiguration 中提供的值以保证所有触摸的交互都是统一的。这个方法获取的值表示:用户的手滑动这个距离后,才判定为正在进行滑动.当然这个值也可以自己来决定.但是为了一致性,还是使用标准的值较好.<br>PhoneNumberUtils.convertKeypadLettersToDigits 顾名思义.将字母转换为数字,类似于T9输入法,<br>Context.getCacheDir() 获取缓存数据文件夹的路径,很简单但是知道的人不多,这个路径通常在SD卡上(这里的SD卡指的是广义上的SD卡,包括外部存储和内部存储)Adnroid/data/您的应用程序包名/cache/ 下面.测试的时候,可以去这里面看是否缓存成功.缓存在这里的好处是:不用自己再去手动创建文件夹,不用担心用户把自己创建的文件夹删掉,在应用程序卸载的时候,这里会被清空,使用第三方的清理工具的时候,这里也会被清空.<br>ArgbEvaluator 用于处理颜色的渐变。就像 Chris Banes 说的一样，这个类会进行很多自动装箱的操作，所以最好还是去掉它的逻辑自己去实现它。这个没用过,不明其所以然,回头再补充.<br>ContextThemeWrapper 方便在运行的时候修改主题.<br>Space space是Android 4.0中新增的一个控件，它实际上可以用来分隔不同的控件，其中形成一个空白的区域.这是一个轻量级的视图组件，它可以跳过Draw，对于需要占位符的任何场景来说都是很棒的。<br>ValueAnimator.reverse() 这个方法可以很顺利地取消正在运行的动画.我超喜欢.</p>
<p>DateUtils.formatDateTime() 用来进行区域格式化工作,输出格式化和本地化的时间或者日期.<br>AlarmManager.setInexactRepeating) 通过闹铃分组的方式省电,即使你只调用了一个闹钟,这也是一个好的选择,（可以确保在使用完毕时自动调用 AlarmManager.cancel ()。原文说的比较抽象,这里详细说一下:setInexactRepeating指的是设置非准确闹钟,使用方法:alarmManager.setInexactRepeating(AlarmManager.RTC, startTime,intervalL, pendingIntent),非准确闹钟只能保证大致的时间间隔，但是不一定准确，可能出现设置间隔为30分钟，但是实际上一次间隔20分钟，另一次间隔40分钟。它的最大的好处是可以合并闹钟事件，比如间隔设置每30分钟一次，不唤醒休眠，在休眠8小时后已经积累了16个闹钟事件，而在手机被唤醒的时候，非准时闹钟可以把16个事件合并为一个, 所以这么看来,非准时闹钟一般来说比较节约能源.<br>Formatter.formatFileSize()) 一个区域化的文件大小格式化工具。通俗来说就是把大小转换为MB,G,KB之类的字符串.<br>ActionBar.hide())/.show()) 顾名思义,隐藏和显示ActionBar,可以优雅地在全屏和带Actionbar之间转换.<br>Linkify.addLinks()) 在Text上添加链接.很实用.<br>StaticLayout 在自定义 View 中渲染文字的时候很实用。<br>Activity.onBackPressed()) 很方便的管理back键的方法,有时候需要自己控制返回键的事件的时候,可以重写一下.比如加入 “点两下back键退出” 功能.<br>GestureDetector 用来监听和相应对应的手势事件,比如点击,长按,慢滑动,快滑动,用起来很简单,比你自己实现要方便许多.<br>DrawFilter 可以让你在不调用onDrew方法的情况下,操作canvas,比了个如,你可以在创建自定义 View 的时候设置一个 DrawFilter，给父 View 里面的所有 View 设置反别名。<br>ActivityManager.getMemoryClass()) 告诉你你的机器还有多少内存,在计算缓存大小的时候会比较有用.<br>ViewStub 它是一个初始化不做任何事情的 View，但是之后可以载入一个布局文件。在慢加载 View 中很适合做占位符。唯一的缺点就是不支持标签，所以如果你不太小心的话，可能会在视图结构中加入不需要的嵌套。<br>SystemClock.sleep()) 这个方法在保证一定时间的 sleep 时很方便，通常我用来进行 debug 和模拟网络延时。<br>DisplayMetrics.density 这个方法你可以获取设备像素密度,大部分时候最好让系统来自动进行缩放资源之类的操作,但是有时候控制的效果会更好一些.(尤其是在自定义View的时候).<br>Pair.create()) 方便构建类和构造器的方法。</p>
<p>UrlQuerySanitizer——使用这个工具可以方便对 URL 进行检查。<br>Fragment.setArguments——因为在构建 Fragment 的时候不能加参数，所以这是个很好的东西，可以在创建 Fragment 之前设置参数（即使在 configuration 改变的时候仍然会导致销毁/重建）。<br>DialogFragment.setShowsDialog ()—— 这是一个很巧妙的方式，DialogFragment 可以作为正常的 Fragment 显示！这里可以让 Fragment 承担双重任务。我通常在创建 Fragment 的时候把 onCreateView ()和 onCreateDialog ()都加上，就可以创建一个具有双重目的的 Fragment。<br>FragmentManager.enableDebugLogging ()——在需要观察 Fragment 状态的时候会有帮助。<br>LocalBroadcastManager——这个会比全局的 broadcast 更加安全，简单，快速。像 otto 这样的 Event buses 机制对你的应用场景更加有用。<br>PhoneNumberUtils.formatNumber ()——顾名思义，这是对数字进行格式化操作的时候用的。<br>Region.op()——我发现在对比两个渲染之前的区域的时候很实用，如果你有两条路径，那么怎么知道它们是不是会重叠呢？使用这个方法就可以做到。<br>Application.registerActivityLifecycleCallbacks——虽然缺少官方文档解释，不过我想它就是注册 Activity 的生命周期的一些回调方法（顾名思义），就是一个方便的工具。<br>versionNameSuffix——这个 gradle 设置可以让你在基于不同构建类型的 manifest 中修改版本名这个属性，例如，如果需要在在 debug 版本中以”-SNAPSHOT”结尾，那么就可以轻松的看出当前是 debug 版还是 release 版。<br>CursorJoiner——如果你是只使用一个数据库的话，使用 SQL 中的 join 就可以了，但是如果收到的数据是来自两个独立的 ContentProvider，那么 CursorJoiner 就很实用了。<br>Genymotion——一个非常快的 Android 模拟器，本人一直在用。<br>-nodpi——在没有特别定义的情况下，很多修饰符(-mdpi,-hdpi,-xdpi等等)都会默认自动缩放 assets/dimensions，有时候我们需要保持显示一致，这种情况下就可以使用 -nodpi。<br>BroadcastRecevier.setDebugUnregister ()——又一个方便的调试工具。<br>Activity.recreate ()——强制让 Activity 重建。<br>PackageManager.checkSignatures ()——如果同时安装了两个 app 的话，可以用这个方法检查。如果不进行签名检查的话，其他人可以轻易通过使用一样的包名来模仿你的 app。</p>
<p>Activity.isChangingConfigurations ()——如果在 Activity 中 configuration 会经常改变的话，使用这个方法就可以不用手动做保存状态的工作了。<br>SearchRecentSuggestionsProvider——可以创建最近提示效果的 provider，是一个简单快速的方法。<br>ViewTreeObserver——这是一个很棒的工具。可以进入到 VIew 里面，并监控 View 结构的各种状态，通常我都用来做 View 的测量操作（自定义视图中经常用到）。<br>org.gradle.daemon=true——这句话可以帮助减少 Gradle 构建的时间，仅在命令行编译的时候用到，因为 Android Studio 已经这样使用了。<br>DatabaseUtils——一个包含各种数据库操作的使用工具。<br>android:weightSum (LinearLayout)——如果想使用 layout weights，但是却不想填充整个 LinearLayout 的话，就可以用 weightSum 来定义总的 weight 大小。<br>android:duplicateParentState (View)——此方法可以使得子 View 可以复制父 View 的状态。比如如果一个 ViewGroup 是可点击的，那么可以用这个方法在它被点击的时候让它的子 View 都改变状态。<br>android:clipChildren (ViewGroup)——如果此属性设置为不可用，那么 ViewGroup 的子 View 在绘制的时候会超出它的范围，在做动画的时候需要用到。<br>android:fillViewport (ScrollView)——在这片文章中有详细介绍文章链接，可以解决在 ScrollView 中当内容不足的时候填不满屏幕的问题。<br>android:tileMode (BitmapDrawable)——可以指定图片使用重复填充的模式。<br>android:enterFadeDuration/android:exitFadeDuration (Drawables)——此属性在 Drawable 具有多种状态的时候，可以定义它展示前的淡入淡出效果。<br>android:scaleType (ImageView)——定义在 ImageView 中怎么缩放/剪裁图片，一般用的比较多的是“centerCrop”和“centerInside”。<br>Merge——此标签可以在另一个布局文件中包含别的布局文件，而不用再新建一个 ViewGroup，对于自定义 ViewGroup 的时候也需要用到；可以通过载入一个带有标签的布局文件来自动定义它的子部件。<br>AtomicFile——通过使用备份文件进行文件的原子化操作。这个知识点之前我也写过，不过最好还是有出一个官方的版本比较好。</p>
<p>ViewDragHelper ——视图拖动是一个比较复杂的问题。这个类可以帮助解决不少问题。如果你需要一个例子，DrawerLayout就是利用它实现扫滑。Flavient Laurent 还写了一些关于这方面的优秀文章。<br>PopupWindow——Android到处都在使用PopupWindow ，甚至你都没有意识到（标题导航条ActionBar，自动补全AutoComplete，编辑框错误提醒Edittext Errors）。这个类是创建浮层内容的主要方法。<br>Actionbar.getThemrContext()——导航栏的主题化是很复杂的（不同于Activity其他部分的主题化）。你可以得到一个上下文（Context），用这个上下文创建的自定义组件可以得到正确的主题。<br>ThumbnailUtils——帮助创建缩略图。通常我都是用现有的图片加载库（比如，Picasso 或者 Volley），不过这个ThumbnaiUtils可以创建视频缩略图。译者注：该API从V8才开始支持。<br>Context.getExternalFilesDir()———— 申请了SD卡写权限后，你可以在SD的任何地方写数据，把你的数据写在设计好的合适位置会更加有礼貌。这样数据可以及时被清理，也会有更好的用户体验。此外，Android 4.0 Kitkat中在这个文件夹下写数据是不需要权限的，每个用户有自己的独立的数据存储路径。译者注：该API从V8才开始支持。<br>SparseArray——Map的高效优化版本。推荐了解姐妹类SparseBooleanArray、SparseIntArray和SparseLongArray。<br>PackageManager.setComponentEnabledSetting()——可以用来启动或者禁用程序清单中的组件。对于关闭不需要的功能组件是非常赞的，比如关掉一个当前不用的广播接收器。<br>SQLiteDatabase.yieldIfContendedSafely()——让你暂时停止一个数据库事务， 这样你可以就不会占用太多的系统资源。<br>Environment.getExternalStoragePublicDirectory()——还是那句话，用户期望在SD卡上得到统一的用户体验。用这个方法可以获得在用户设备上放置指定类型文件（音乐、图片等）的正确目录。<br>View.generateViewId()——每次我都想要推荐动态生成控件的ID。需要注意的是，不要和已经存在的控件ID或者其他已经生成的控件ID重复。<br>ActivityManager.clearApplicationUserData()—— 一键清理你的app产生的用户数据，可能是做用户退出登录功能，有史以来最简单的方式了。<br>Context.createConfigurationContext() ——自定义你的配置环境信息。我通常会遇到这样的问题：强制让一部分显示在某个特定的环境下（倒不是我一直这样瞎整，说来话长，你很难理解）。用这个实现起来可以稍微简单一点。<br>ActivityOptions ——方便的定义两个Activity切换的动画。 使用ActivityOptionsCompat 可以很好解决旧版本的兼容问题。<br>AdapterViewFlipper.fyiWillBeAdvancedByHostKThx()——仅仅因为很好玩，没有其他原因。在整个安卓开源项目中（AOSP the Android ——pen Source Project Android开放源代码项目）中还有其他很有意思的东西（比如<br>GRAVITY_DEATH_STAR_I）。不过，都不像这个这样，这个确实有用<br>ViewParent.requestDisallowInterceptTouchEvent() ——Android系统触摸事件机制大多时候能够默认处理，不过有时候你需要使用这个方法来剥夺父级控件的控制权（顺便说一下，如果你想对Android触摸机制了解更多，这个演讲会令你惊叹不已。）</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/11/10/Android-Activity启动过程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/11/10/Android-Activity启动过程/" itemprop="url">[Android]Activity启动过程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-11-10T13:25:00+08:00">
                2015-11-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/11/10/Android-Activity启动过程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/11/10/Android-Activity启动过程/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Android系统启动加载流程："><a href="#Android系统启动加载流程：" class="headerlink" title="Android系统启动加载流程："></a>Android系统启动加载流程：</h3><p><a href="http://i11.tietuku.com/0582844414810f38.png" target="_blank" rel="noopener">参考图</a></p>
<ul>
<li>Linux内核加载完毕 </li>
<li>启动<code>init</code>进程 </li>
<li><code>init</code>进程fork出<code>zygote</code>进程</li>
<li><code>zygote</code>进程在<code>ZygoteInit.main()</code>中进行初始化的时候fork出<code>SystemServer</code>进程</li>
<li><code>SystemServer</code>进程开启的时候初始化<code>ActivityThread</code>和<code>ActivityManagerService</code>（其它还有<code>PowerManagerService</code>，<code>DisplayManagerService</code>，<code>PackageManagerService</code>）</li>
<li>启动<code>Launcher</code>，<code>Launcher</code>本质上也是一个App，继承自<code>Activity</code></li>
</ul>
<h3 id="App与AMS通过Binder进行IPC通信"><a href="#App与AMS通过Binder进行IPC通信" class="headerlink" title="App与AMS通过Binder进行IPC通信"></a>App与AMS通过Binder进行IPC通信</h3><h4 id="启动一个Activity"><a href="#启动一个Activity" class="headerlink" title="启动一个Activity"></a>启动一个Activity</h4><blockquote>
<p>客户端：ActivityManagerProxy –&gt; Binder驱动 –&gt; ActivityManagerService：服务器</p>
</blockquote>
<ul>
<li><strong>ActivityThread</strong><br>老板，虽然说家里的事自己说了算，但是需要听从AMS的指挥</li>
<li><strong>Instrumentation</strong><br>老板娘，负责家里的大事小事，但是一般不抛头露面，听一家之主ActivityThread的安排，每个Activity都有一个<code>Instrumentation</code>引用，整个进程只有一个<code>Instrumentation</code>实例</li>
<li><strong>ActivityManagerProxy</strong><br>ActivityManagerNative.getDefault().startActivity获取<code>ActivityManagerProxy</code>对象通过Binder IPC与AMS通信</li>
<li><strong>AMS</strong><br>真正启动一个Ativity（<code>ActivityStackSupervisor</code>, <code>ActivityStack</code>）</li>
</ul>
<h4 id="Resume一个Activity"><a href="#Resume一个Activity" class="headerlink" title="Resume一个Activity"></a>Resume一个Activity</h4><blockquote>
<p>客户端：ApplicationThread &lt;– Binder驱动 &lt;– ApplicationThreadProxy：服务器</p>
</blockquote>
<ul>
<li><strong>AMS</strong></li>
<li><strong>ApplicationThreadProxy</strong><br><code>ApplicationThreadProxy</code>对象通过Binder IPC与客户端通信。</li>
<li><strong>ApplicationThread</strong></li>
<li><strong>Handler</strong></li>
<li><strong>ActivityThread</strong></li>
<li><strong>Activity</strong><br>调用onResume方法</li>
</ul>
<h3 id="AMS-SystemServer进程-与zygote通过Socket进行IPC通信"><a href="#AMS-SystemServer进程-与zygote通过Socket进行IPC通信" class="headerlink" title="AMS(SystemServer进程)与zygote通过Socket进行IPC通信"></a>AMS(SystemServer进程)与zygote通过Socket进行IPC通信</h3><p>参考：<a href="http://blog.csdn.net/zhaokaiqiang1992/article/details/49428287" target="_blank" rel="noopener">http://blog.csdn.net/zhaokaiqiang1992/article/details/49428287</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/11/05/《Kotli­n-for-­androi­d-Deve­lopers­》中文翻译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/11/05/《Kotli­n-for-­androi­d-Deve­lopers­》中文翻译/" itemprop="url">《Kotli­n for ­androi­d Deve­lopers­》中文翻译</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-11-05T12:32:00+08:00">
                2015-11-05
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/11/05/《Kotli­n-for-­androi­d-Deve­lopers­》中文翻译/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/11/05/《Kotli­n-for-­androi­d-Deve­lopers­》中文翻译/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/4939080.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4939080.html</a>
</strong></font>

<p>之前一直在关注Kotlin和Android相关的开发，写过两篇关于Kotlin的文章，不了解Kotlin的可以看下：</p>
<ul>
<li>[Android]使用Kotlin+Anko开发Android（一）：<a href="http://www.cnblogs.com/tiantianbyconan/p/4800656.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4800656.html</a></li>
<li>[Android]使用Kotlin开发Android（二）：<a href="http://www.cnblogs.com/tiantianbyconan/p/4829007.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4829007.html</a></li>
</ul>
<p>后来在<a href="https://kotlinlang.org/docs/reference/" target="_blank" rel="noopener">Kotlin官网</a>上面看到了这本书《Kotlin for android developers》：<br><img src="https://s3.amazonaws.com/titlepages.leanpub.com/kotlin-for-android-developers/large?1445802287]" alt=""></p>
<p>这本书发布在<a href="https://leanpub.com/kotlin-for-android-developers" target="_blank" rel="noopener">leanpub</a>，前两周作者完成本书后，我就购买看了一遍，里面通过一个天气预报的App例子讲解了基本上Kotlin所有的语法和特性，解决了几个困扰我很久的问题。</p>
<p>后来打算把它翻译成中文版贡献给大家，已经翻译完成：</p>
<p><strong>Gitbook在线阅读或下载</strong>：<a href="https://www.gitbook.com/book/wangjiegulu/kotlin-for-android-developers-zh/details" target="_blank" rel="noopener">https://www.gitbook.com/book/wangjiegulu/kotlin-for-android-developers-zh/details</a><br><strong>Github地址</strong>：<a href="https://github.com/wangjiegulu/kotlin-for-android-developers-zh" target="_blank" rel="noopener">https://github.com/wangjiegulu/kotlin-for-android-developers-zh</a></p>
<p>本人水平有限，大家遇到错别字、病句、翻译错误等问题<a href="https://github.com/wangjiegulu/kotlin-for-android-developers-zh/issues" target="_blank" rel="noopener">可以在Github上提issues</a>。不过请说明错误原因。</p>
<p>希望大家支持购买原版：<a href="https://leanpub.com/kotlin-for-android-developers" target="_blank" rel="noopener">https://leanpub.com/kotlin-for-android-developers</a></p>
<h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><ul>
<li><a href="README.md">Introduction</a></li>
<li><a href="xie_zai_qian_mian.md">写在前面</a></li>
<li><a href="guan_yu_ben_shu.md">关于本书</a></li>
<li><a href="zhe_ben_shu_shi_he_ni_ma_ff1f.md">这本书适合你吗？</a></li>
<li><a href="guan_yu_zuo_zhe.md">关于作者</a></li>
<li><a href="jie_shao.md">介绍</a><ul>
<li><a href="shi_yao_shi_kotlin.md">什么是Kotlin？</a></li>
<li><a href="wo_men_tong_guo_kotlin_de_dao_shi_yao.md">我们通过Kotlin得到什么</a></li>
</ul>
</li>
<li><a href="zhun_bei_gong_zuo.md">准备工作</a><ul>
<li><a href="android_studio.md">Android Studio</a></li>
<li><a href="an_zhuang_kotlin_cha_jian.md">安装Kotlin插件</a></li>
</ul>
</li>
<li><a href="chuang_jian_yi_ge_xin_de_xiang_mu.md">创建一个新的项目</a><ul>
<li><a href="zai_android_studio_zhong_chuang_jian_yi_ge_xiang_mu.md">在Android Studio中创建一个项目</a></li>
<li><a href="pei_zhi_gradle.md">配置Gradle</a></li>
<li><a href="ba_mainactivity_zhuan_huan_cheng_kotlin_dai_ma.md">把MainActivity转换成Kotlin代码</a></li>
<li><a href="ce_shi_shi_fou_yi_qie_jiu_xu.md">测试是否一切就绪</a></li>
</ul>
</li>
<li><a href="lei_he_han_shu.md">类和函数</a><ul>
<li><a href="zen_yao_ding_yi_yi_ge_lei.md">怎么定义一个类</a></li>
<li><a href="lei_ji_cheng.md">类继承</a></li>
<li><a href="han_shu.md">函数</a></li>
<li><a href="gou_zao_fang_fa_he_han_shu_can_shu.md">构造方法和函数参数</a></li>
</ul>
</li>
<li><a href="bian_xie_ni_de_di_yi_ge_lei.md">编写你的第一个类</a><ul>
<li><a href="chuang_jian_yi_ge_layout.md">创建一个layout</a></li>
<li><a href="the_recycler_adapter.md">The Recycler Adapter</a></li>
</ul>
</li>
<li><a href="bian_liang_he_shu_xing.md">变量和属性</a><ul>
<li><a href="ji_ben_lei_xing.md">基本类型</a></li>
<li><a href="bian_liang.md">变量</a></li>
<li><a href="shu_xing.md">属性</a></li>
</ul>
</li>
<li>Anko和扩展的函数<ul>
<li><a href="ankoshi_shi_yao_ff1f.md">Anko是什么？</a></li>
<li><a href="kai_shi_shi_yong_anko.md">开始使用Anko</a></li>
<li><a href="kuo_zhan_han_shu.md">扩展函数</a></li>
</ul>
</li>
<li>从API中获取数据<ul>
<li><a href="zhi_xing_yi_ge_qing_qiu.md">执行一个请求</a></li>
<li><a href="zai_zhu_xian_cheng_yi_wai_zhi_xing_qing_qiu.md">在主线程以外执行请求</a></li>
</ul>
</li>
<li><a href="shu_ju_lei.md">数据类</a><ul>
<li><a href="e_wai_de_han_shu.md">额外的函数</a></li>
<li><a href="fu_zhi_yi_ge_shu_ju_lei.md">复制一个数据类</a></li>
<li><a href="ying_she_dui_xiang_dao_bian_liang_zhong.md">映射对象到变量中</a></li>
<li><a href="zhuan_huan_json_dao_shu_ju_lei.md">转换json到数据类</a></li>
<li><a href="gou_jiandomain_ceng.md">构建domain层</a></li>
<li><a href="zaiui_zhong_hui_zhi_shu_ju.md">在UI中绘制数据</a></li>
</ul>
</li>
<li><a href="cao_zuo_fu_zhong_zai.md">操作符重载</a><ul>
<li><a href="cao_zuo_fu_biao.md">操作符表</a></li>
<li><a href="li_zi.md">例子</a></li>
<li><a href="kuo_zhan_han_shu_zhong_de_cao_zuo_fu.md">扩展函数中的操作符</a></li>
</ul>
</li>
<li><a href="shi_forecast_list_ke_dian_ji.md">使Forecast list可点击</a></li>
<li><a href="lambdas.md">Lambdas</a><ul>
<li><a href="jian_hua_setonclicklistener.md">简化setOnClickListener()</a></li>
<li><a href="forecastlistadapterde_click_listener.md">ForecastListAdapter的click listener</a></li>
<li><a href="kuo_zhan_yu_yan.md">扩展语言</a></li>
</ul>
</li>
<li><a href="ke_jian_xing_xiu_shi_fu.md">可见性修饰符</a><ul>
<li><a href="xiu_shi_fu.md">修饰符</a></li>
<li><a href="gou_zao_qi.md">构造器</a></li>
<li><a href="zhong_gou_dai_ma.md">重构代码</a></li>
</ul>
</li>
<li><a href="kotlin_android_extensions.md">Kotlin Android Extensions</a><ul>
<li><a href="zen_yaoqu_shi_yong_kotlinandroid_extensions.md">怎么去使用Kotlin Android Extensions</a></li>
<li><a href="zhong_gou_wo_men_de_dai_ma.md">重构我们的代码</a></li>
</ul>
</li>
<li><a href="applicationdan_li_hua_he_shu_xing_de_delegated.md">Application单例化和属性的Delegated</a><ul>
<li><a href="applicatondan_li_hua.md">Applicaton单例化</a></li>
<li><a href="wei_tuo_shu_xing.md">委托属性</a></li>
<li><a href="biao_zhun_wei_tuo.md">标准委托</a></li>
<li><a href="zen_yao_qu_chuang_jian_yi_ge_zi_ding_yi_de_wei_tuo.md">怎么去创建一个自定义的委托</a></li>
<li><a href="zhong_xin_shixian_application_dan_li_hua.md">重新实现Application单例化</a></li>
</ul>
</li>
<li><a href="chuang_jian_yi_ge_sqliteopenhelper.md">创建一个SQLiteOpenHelper</a><ul>
<li><a href="managedsqliteopenhelper.md">ManagedSqliteOpenHelper</a></li>
<li><a href="ding_yi_biao.md">定义表</a></li>
<li><a href="shi_xian_sqliteopenhelper.md">实现SqliteOpenHelper</a></li>
<li><a href="yi_lai_zhu_ru.md">依赖注入</a></li>
</ul>
</li>
<li><a href="ji_he_he_han_shu_cao_zuo_fu.md">集合和函数操作符</a><ul>
<li><a href="zong_shu_cao_zuo_fu.md">总数操作符</a></li>
<li><a href="guo_lv_cao_zuo_fu.md">过滤操作符</a></li>
<li><a href="ying_she_cao_zuo_fu.md">映射操作符</a></li>
<li><a href="yuan_su_cao_zuo_fu.md">元素操作符</a></li>
<li><a href="sheng_chan_cao_zuo_fu.md">生产操作符</a></li>
<li><a href="shun_xu_cao_zuo_fu.md">顺序操作符</a></li>
</ul>
</li>
<li><a href="cong_shu_ju_ku_zhong_bao_cun_huo_cha_xun_shu_ju.md">从数据库中保存或查询数据</a><ul>
<li><a href="chuang_jian_shu_ju_ku_model_lei.md">创建数据库model类</a></li>
<li><a href="xie_ru_he_cha_xun_shu_ju_ku.md">写入和查询数据库</a></li>
</ul>
</li>
<li><a href="kotlinzhong_de_null_an_quan.md">Kotlin中的null安全</a><ul>
<li><a href="ke_null_lei_xing_zen_yao_gong_zuo.md">可null类型怎么工作</a></li>
<li><a href="ke_null_xing_he_java_ku.md">可null性和Java库</a></li>
</ul>
</li>
<li><a href="chuang_jian_ye_wu_luo_ji_lai_fang_wen_shu_ju.md">创建业务逻辑来访问数据</a></li>
<li><a href="flow_controlhe_ranges.md">Flow control和ranges</a><ul>
<li><a href="ifbiao_da_shi.md">If表达式</a></li>
<li><a href="whenbiao_da_shi.md">When表达式</a></li>
<li><a href="forxun_huan.md">For循环</a></li>
<li><a href="whilehe_do__while_xun_huan.md">While和do/while循环</a></li>
<li><a href="ranges.md">Ranges</a></li>
</ul>
</li>
<li><a href="chuang_jian_yi_ge_xiang_qing_jie_mian.md">创建一个详情界面</a><ul>
<li><a href="zhun_bei_qing_qiu.md">准备请求</a></li>
<li><a href="ti_gong_yige_xin_de_activity.md">提供一个新的activity</a></li>
<li><a href="qi_dong_yige_activity__reified_han_shu.md">启动一个activity：reified函数</a></li>
</ul>
</li>
<li>接口和委托<ul>
<li><a href="jie_kou.md">接口</a></li>
<li><a href="wei_tuo.md">委托</a></li>
<li><a href="zai_wo_men_de_app_zhong_shi_xian_yi_ge_li_zi.md">在我们的App中实现一个例子</a></li>
</ul>
</li>
<li><a href="fan_xing.md">范型</a><ul>
<li><a href="ji_chu.md">基础</a></li>
<li><a href="bian_ti.md">变体</a></li>
<li><a href="fan_xing_li_zi.md">范型例子</a></li>
</ul>
</li>
<li><a href="she_zhi_jie_mian.md">设置界面</a><ul>
<li><a href="chuang_jian_yi_ge_she_zhi_activity.md">创建一个设置activity</a></li>
<li><a href="fang_wen_shared_preferences.md">访问Shared Preferences</a></li>
<li><a href="fan_xing_preference_wei_tuo.md">范型preference委托</a></li>
</ul>
</li>
<li><a href="ce_shi_ni_de_app.md">测试你的App</a><ul>
<li><a href="unit_testing.md">Unit testing</a></li>
<li><a href="instrumentation_tests.md">Instrumentation tests</a></li>
</ul>
</li>
<li><a href="qi_ta_de_gai_nian.md">其它的概念</a><ul>
<li><a href="nei_bu_lei.md">内部类</a></li>
<li><a href="mei_ju.md">枚举</a></li>
<li><a href="mi_feng_lei.md">密封（Sealed）类</a></li>
<li><a href="yi_chang_ff08_exceptions.md">异常（Exceptions）</a></li>
</ul>
</li>
<li><a href="jie_wei.md">结尾</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/09/22/Android-使用Kotlin开发Android（二）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/09/22/Android-使用Kotlin开发Android（二）/" itemprop="url">[Android]使用Kotlin开发Android（二）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-09-22T15:08:00+08:00">
                2015-09-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/09/22/Android-使用Kotlin开发Android（二）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/09/22/Android-使用Kotlin开发Android（二）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/4829007.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4829007.html</a>
</strong></font>

<p>[TOC]</p>
<h2 id="使用Kotlin＋OkHttp＋RxJava进行网络请求"><a href="#使用Kotlin＋OkHttp＋RxJava进行网络请求" class="headerlink" title="使用Kotlin＋OkHttp＋RxJava进行网络请求"></a>使用Kotlin＋OkHttp＋RxJava进行网络请求</h2><p>代码：<a href="https://github.com/wangjiegulu/KotlinAndroidSample" target="_blank" rel="noopener">https://github.com/wangjiegulu/KotlinAndroidSample</a></p>
<h3 id="1-需要"><a href="#1-需要" class="headerlink" title="1. 需要"></a>1. 需要</h3><ul>
<li>对<a href="http://kotlinlang.org/" target="_blank" rel="noopener">Kotlin</a>语法有基本的掌握</li>
<li>对<a href="https://github.com/square/okhttp" target="_blank" rel="noopener">OkHttp</a>有基本的了解</li>
<li>对<a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="noopener">RxJava</a> / <a href="https://github.com/ReactiveX/RxAndroid" target="_blank" rel="noopener">RxAndroid</a>有基本的了解</li>
</ul>
<h3 id="2-Kotlin搭建环境"><a href="#2-Kotlin搭建环境" class="headerlink" title="2. Kotlin搭建环境"></a>2. Kotlin搭建环境</h3><p>见之前的文章：<a href="http://www.cnblogs.com/tiantianbyconan/p/4800656.html" target="_blank" rel="noopener">[Android]使用Kotlin+Anko开发Android（一）</a></p>
<h3 id="3-Gradle添加相关依赖包："><a href="#3-Gradle添加相关依赖包：" class="headerlink" title="3. Gradle添加相关依赖包："></a>3. Gradle添加相关依赖包：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">compile &quot;org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version&quot;</span><br><span class="line">compile &quot;org.jetbrains.kotlin:kotlin-reflect:$kotlin_version&quot;</span><br><span class="line">compile &apos;com.squareup.okhttp:okhttp:2.4.0&apos;</span><br><span class="line">compile &apos;io.reactivex:rxjava:1.0.12&apos;</span><br><span class="line">compile &apos;io.reactivex:rxandroid:0.24.0&apos;</span><br></pre></td></tr></table></figure>
<h3 id="4-请求"><a href="#4-请求" class="headerlink" title="4. 请求"></a>4. 请求</h3><p>一般的写法如下：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Observable.defer(&#123; -&gt;</span><br><span class="line">                Observable.just(OkHttpClient().newCall(</span><br><span class="line">                        Request.Builder()</span><br><span class="line">                                .url(<span class="string">"https://github.com/wangjiegulu"</span>)</span><br><span class="line">                                .<span class="keyword">get</span>()</span><br><span class="line">                                .build()</span><br><span class="line">                ).execute())</span><br><span class="line">            &#125;).subscribeOn(Schedulers.newThread())</span><br><span class="line">                    .map(&#123;r -&gt; r.body().string()&#125;)</span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">            .subscribe(&#123; result -&gt; Log.d(TAG, <span class="string">"request result: <span class="variable">$result</span>"</span>); resultTv.setText(<span class="string">"Http request succeed, see log"</span>) &#125;, &#123;throwable -&gt; Log.e(TAG, <span class="string">""</span>, throwable)&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="5-使用Kotlin语法糖进行简化"><a href="#5-使用Kotlin语法糖进行简化" class="headerlink" title="5. 使用Kotlin语法糖进行简化"></a>5. 使用Kotlin语法糖进行简化</h3><h4 id="1-在String类中扩展http请求方法"><a href="#1-在String类中扩展http请求方法" class="headerlink" title="1) 在String类中扩展http请求方法"></a>1) 在String类中扩展http请求方法</h4><p>我们希望在url（String）中增加一个方法，直接调用后构建一个http请求：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> String.<span class="title">request</span><span class="params">()</span></span>: Request.Builder = Request.Builder().url(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure></p>
<p>如上代码，在String类中定义了一个request()方法，返回一个OkHttp的Request.Builder对象，并设置url为当前的String对象，即当前的url。</p>
<h4 id="2-在Request-Builder类中扩展执行http请求方法"><a href="#2-在Request-Builder类中扩展执行http请求方法" class="headerlink" title="2) 在Request.Builder类中扩展执行http请求方法"></a>2) 在Request.Builder类中扩展执行http请求方法</h4><p>调用String方法的request()方法之后，获得了一个构建的Request.Builder对象，然后希望通过这个对象调用某个方法来执行http请求，于是继续扩展：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> Request.Builder.<span class="title">rxExecute</span><span class="params">()</span></span>: Observable&lt;Response&gt; = Observable.defer(&#123; Observable.just(OkHttpClient().newCall(<span class="keyword">this</span>.build()).execute()) &#125;).subscribeOn(Schedulers.newThread());</span><br></pre></td></tr></table></figure></p>
<p>我们在Request.Builder类中定义了一个rxExecute()方法，这个方法中，会通过RxJava构建一个Obserable对象，Obserable对象中排出给观察者的数据就是http执行完毕后的结果Response。并且指定了执行http请求所在的线程。</p>
<h4 id="3-优化后的调用方式"><a href="#3-优化后的调用方式" class="headerlink" title="3) 优化后的调用方式"></a>3) 优化后的调用方式</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"https://github.com/wangjiegulu"</span>.request().<span class="keyword">get</span>().rxExecute()</span><br><span class="line">                    .map(&#123; r -&gt; r.body().string() &#125;)</span><br><span class="line">                    .observeOnMain()</span><br><span class="line">                    .subscribeSafeNext &#123; result -&gt; Log.d(TAG, <span class="string">"request result: <span class="variable">$result</span>"</span>); resultTv.setText(<span class="string">"Http request succeed, see log"</span>) &#125;</span><br></pre></td></tr></table></figure>
<p>如上：通过url构建Request.Builder，然后通过RequestBuilder构建一个Obserable，然后订阅获得排出的请求结果。</p>
<p>为了方便调用，又在Obserable中扩展了几个方法：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Observable<span class="type">&lt;T&gt;</span>.<span class="title">observeOnMain</span><span class="params">()</span></span>: Observable&lt;T&gt; = <span class="keyword">this</span>.observeOn(AndroidSchedulers.mainThread())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Observable<span class="type">&lt;T&gt;</span>.<span class="title">subscribeSafeNext</span><span class="params">(onNext: (<span class="type">T</span>)</span></span> -&gt; <span class="built_in">Unit</span>): Subscription = <span class="keyword">this</span>.subscribe(onNext, &#123; t -&gt; Log.e(TAG, <span class="string">""</span>, t) &#125;, &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> Observable<span class="type">&lt;T&gt;</span>.<span class="title">subscribeSafeCompleted</span><span class="params">(onCompleted: ()</span></span> -&gt; <span class="built_in">Unit</span>): Subscription = <span class="keyword">this</span>.subscribe(&#123;&#125;, &#123; t -&gt; Log.e(TAG, <span class="string">""</span>, t) &#125;, onCompleted);</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/09/13/Kotlin语法（其他）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/09/13/Kotlin语法（其他）/" itemprop="url">Kotlin语法（其他）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-09-13T17:08:00+08:00">
                2015-09-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/09/13/Kotlin语法（其他）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/09/13/Kotlin语法（其他）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#三、其他<br>[TOC]</p>
<p>##1. 多重声明<br>有时候可以通过给对象插入多个成员函数做区别是很方便的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val (name, age) = person</span><br></pre></td></tr></table></figure></p>
<p>多重声明一次创建了多个变量。我们声明了俩个新变量：name age 并且可以独立使用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">println(name)</span><br><span class="line">println(age)</span><br></pre></td></tr></table></figure></p>
<p>也可以在 for 循环中用:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for ((a, b) in collection) &#123; ... &#125;</span><br></pre></td></tr></table></figure></p>
<p>map:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for ((key, value) in map) &#123; ... &#125;</span><br></pre></td></tr></table></figure></p>
<p>##2. Ranges<br>函数操作符是<code>:</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (i in 1..10)&#123; ... &#125;</span><br><span class="line">if (x !in 1.0..3.0) println(x)</span><br><span class="line">if (str in &quot;island&quot;..&quot;isle&quot;) println(str)</span><br><span class="line">for (i in 4 downTo 1) print(i) // prints &apos;4321&apos;</span><br><span class="line">for (i in 1..4 step 2) print(i) // prints &quot;13&quot;</span><br><span class="line">for (i in 4 downTo 1 step 2) print(i) // prints &quot;42&quot;</span><br><span class="line">for (i in 1.0..2.0 step 0.3) print(&quot;$i &quot;) // prints &quot;1.0 1.3 1.6 1.9 &quot;</span><br><span class="line">for (i in (1..4).reversed()) print(i) // prints &quot;4321&quot;</span><br><span class="line">for (i in (1..4).reversed() step 2) print(i) // prints &quot;42&quot;</span><br></pre></td></tr></table></figure></p>
<p>##3. 类型检查和转换<br>is !is 表达式: 类似Java的instanceof</p>
<p>“不安全”的转换符，如下的x不能为空，否则抛异常:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val x: String = y as String</span><br></pre></td></tr></table></figure></p>
<p>“安全”转换符，如下不管 as? 右边的是不是一个非空 String 结果都会转换为可空的:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val x: String ?= y as? String</span><br></pre></td></tr></table></figure></p>
<p>##4. This 表达式<br>如果 this 没有应用者，则指向的是最内层的闭合范围。为了在其它范围中返回 this ，需要使用标签:<code>this@lable</code></p>
<p>##5. 等式<br>在 kotlin 中有两种相等：</p>
<ul>
<li><p>参照相等: <code>===</code>，参照相等是通过 === 操作符判断的(不等是!== ) a===b 只有 a b 指向同一个对象是判别才成立。另外，你可以使用内联函数<code>identityEquals()</code> 判断参照相等。</p>
</li>
<li><p>结构相等: <code>==</code>，结构相等是通过 == 判断的。像<code>a == b</code>将会翻译成：<code>a?.equals(b) ?: b === null</code>，如果 a 不是 null 则调用 equals(Any?) 函数，否则检查 b 是否参照等于 null。</p>
</li>
</ul>
<p>##6. 运算符重载<br><a href="http://kotlinlang.org/docs/reference/operator-overloading.html" target="_blank" rel="noopener">http://kotlinlang.org/docs/reference/operator-overloading.html</a></p>
<p>##7. 空安全<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var a: String =&quot;abc&quot;</span><br><span class="line">a = null // 编译错误</span><br><span class="line">val l = a.length() // 因为a不能为null，所以不会报错</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var b: String? = &quot;abc&quot;</span><br><span class="line">b = null</span><br><span class="line">val l = b.length() // 错误：b为空</span><br><span class="line">val l = if (b != null) b.length() else -1 // 不会报错</span><br><span class="line">b?.length() // 安全调用不会报错</span><br></pre></td></tr></table></figure>
<p>安全调用在链式调用是是很有用的。比如，如果 Bob 是一个雇员可能分配部门(也可能不分配)，如果我们想获取 Bob 的部门名作为名字的前缀，就可以这样做：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bob?.department?.head?.name //</span><br></pre></td></tr></table></figure></p>
<p><strong>Elvis 操作符:</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val l: Int = if (b != null) b.length() else -1</span><br></pre></td></tr></table></figure></p>
<p>也可以使用　Elvis 操作符<code>?:</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val l = b.length()?: -1</span><br></pre></td></tr></table></figure></p>
<p>如果 ?: 左边表达式不为空则返回，否则返回右边的表达式。注意右边的表带式只有在左边表达式为空是才会执行。</p>
<p><strong>!!操作符:</strong><br>第三个选择是 NPE-lovers。我们可以用 b!! ，这会返回一个非空的 b 或者抛出一个 b 为空的 NPE:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val l = b !!.length()</span><br></pre></td></tr></table></figure></p>
<p><strong>安全转换:</strong><br>普通的转换可能产生 ClassCastException 异常。另一个选择就是使用安全转换，如果不成功就返回空：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val aInt: Int? = a as? Int</span><br></pre></td></tr></table></figure></p>
<p>##8.异常<br>所有的异常类都是 Exception 的子类。使用方式与Java类似。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">  // some code</span><br><span class="line">&#125;</span><br><span class="line">catch (e: SomeException) &#123;</span><br><span class="line">  // handler</span><br><span class="line">&#125;</span><br><span class="line">finally &#123;</span><br><span class="line">  // optional finally block</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##9.注解<br>注解是一种将元数据附加到代码中的方法。声明注解需要在类前面使用 annotation 关键字：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">annotation class fancy</span><br></pre></td></tr></table></figure></p>
<p>用法：在多数情形中 @ 标识是可选的。只有在注解表达式或本地声明中才必须<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@fancy class Foo &#123;</span><br><span class="line">    @fancy fun baz(@fancy foo: Int): Int &#123;</span><br><span class="line">        return (@fancy 1)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 可省略@</span><br><span class="line">fancy class Foo &#123;</span><br><span class="line">    fancy fun baz(fancy foo: Int): Int &#123;</span><br><span class="line">        @fancy fun bar() &#123; ... &#125;</span><br><span class="line">        return (@fancy 1)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果要给构造函数注解，就需要在构造函数声明时添加 constructor 关键字，并且需要在前面添加注解：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class Foo @inject constructor (dependency: MyDependency)</span><br></pre></td></tr></table></figure></p>
<p>注解可以有带参数的构造函数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">annotation class special(val why: String)</span><br><span class="line">special(&quot;example&quot;) class Foo &#123;&#125;</span><br></pre></td></tr></table></figure></p>
<p>注解也可以用在 Lambda 中。这将会应用到 lambda 生成的 invoke() 方法:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">annotation class Suspendable</span><br><span class="line">val f = @Suspendable &#123; Fiber.sleep(10) &#125;</span><br></pre></td></tr></table></figure></p>
<p>java 注解在 kotlin 中是完全兼容的。<br>如果java 中的 value 参数有数组类型，则在 kotlin 中变成 vararg 参数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// Java</span><br><span class="line">public @interface AnnWithArrayValue &#123;</span><br><span class="line">    String[] value();</span><br><span class="line">&#125;</span><br><span class="line">// Kotlin</span><br><span class="line">AnnWithArrayValue(&quot;abc&quot;, &quot;foo&quot;, &quot;bar&quot;) class C</span><br></pre></td></tr></table></figure></p>
<p>注解实例的值在 kotlin 代码中是暴露属性。</p>
<p>##10.反射<br>得到运行时的类引用:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val c = MyClass::class</span><br></pre></td></tr></table></figure></p>
<p>引用是一种 KClass类型的值。你可以使用<code>KClass.properties</code> 和<code>KClass.extensionProperties</code>获取类和父类的所有属性引用的列表。</p>
<p><strong>函数引用</strong><br>使用<code>::</code>操作符:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fun isOdd(x: Int) =x % 2 !=0</span><br><span class="line">val numbers = listOf(1, 2, 3)</span><br><span class="line">println(numbers.filter( ::isOdd) ) //prints [1, 3]</span><br></pre></td></tr></table></figure></p>
<p>这里<code>::isOdd</code>是是一个函数类型的值<code>(Int) -&gt; Boolean</code> </p>
<p>下面是返回一个由两个传递进去的函数的组合。现在你可以把它用在可调用的引用上了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fun compose&lt;A, B, C&gt;(f: (B) -&gt; C, g: (A) -&gt; B): (A) -&gt; C &#123;</span><br><span class="line">    return &#123;x -&gt; f(g(x))&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fun length(s: String) = s.size</span><br><span class="line">val oddLength = compose(::isOdd, ::length)</span><br><span class="line">val strings = listOf(&quot;a&quot;, &quot;ab&quot;, &quot;abc&quot;)</span><br><span class="line">println(strings.filter(oddLength)) // Prints &quot;[a, abc]&quot;</span><br></pre></td></tr></table></figure></p>
<p><strong>属性引用</strong><br>访问顶级类的属性，我们也可以使用<code>::</code>操作符：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var x = 1</span><br><span class="line">fun main(args: Array&lt;String&gt;) &#123;</span><br><span class="line">    println(::x.get())</span><br><span class="line">    ::x.set(2)</span><br><span class="line">    println(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>::x</code>表达式评估为<code>KProperty&lt;Int&gt;</code>类型的属性，它允许我们使用<code>get()</code>读它的值或者使用名字取回它的属性。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class A(val p: Int)</span><br><span class="line"></span><br><span class="line">fun main(args: Array&lt;String&gt;) &#123;</span><br><span class="line">    val prop = A::p</span><br><span class="line">    println(prop.get(A(1))) // prints &quot;1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于扩展属性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">val String.lastChar: Char</span><br><span class="line">  get() = this[size - 1]</span><br><span class="line"></span><br><span class="line">fun main(args: Array&lt;String&gt;) &#123;</span><br><span class="line">  println(String::lastChar.get(&quot;abc&quot;)) // prints &quot;c&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>与 java 反射调用</strong><br>想找到一个备用字段或者 java getter 方法:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import kotlin.reflect.jvm.*</span><br><span class="line"></span><br><span class="line">class A(val p: Int)</span><br><span class="line"></span><br><span class="line">fun main(args: Array&lt;String&gt;) &#123;</span><br><span class="line">    println(A::p.javaGetter) // prints &quot;public final int A.getP()&quot;</span><br><span class="line">    println(A::p.javaField)  // prints &quot;private final int A.p&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>构造函数引用</strong><br>只需要使用<code>::</code>操作符并加上类名。下面的函数是一个没有参数并且返回类型是<code>Foo</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">calss Foo</span><br><span class="line">fun function(factory : () -&gt; Foo) &#123;</span><br><span class="line">    val x: Foo = factory()</span><br><span class="line">&#125;</span><br><span class="line">function(:: Foo)</span><br></pre></td></tr></table></figure></p>
<p>##11. 动态类型<br>为了方便使用，<code>dynamic</code>应而生：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val dyn: dynamic = ...</span><br></pre></td></tr></table></figure></p>
<p><code>dynamic</code>类型关闭了 kotlin 的类型检查：</p>
<blockquote>
<p>这样的类型可以分配任意变量或者在任意的地方作为参数传递 任何值都可以分配为dynamic 类型，或者作为参数传递给任何接受 dynamic 类型参数的函数 这样的类型不做 null 检查</p>
</blockquote>
<p><code>dynamic</code>最奇特的特性就是可以在<code>dynamic</code>变量上调用任何属性或任何方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dyn.whatever(1, &quot;foo&quot;, dyn) // &apos;whatever&apos; is not defined anywhere</span><br><span class="line">dyn.whatever(*array(1, 2, 3))</span><br></pre></td></tr></table></figure></p>
<p>动态调用可以返回<code>dynamic</code>作为结果，因此我们可以轻松实现链式调用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dyn.foo().bar.bat()</span><br></pre></td></tr></table></figure></p>
<p>当给动态调用传递一个 lambda 表达式时，所有的参数默认都是<code>dynamic</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dyn.foo &#123;</span><br><span class="line">  x -&gt; x.bar() // x is dynamic</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>参考：</strong><br>1. <a href="http://kotlinlang.org/docs/reference/basic-syntax.html" target="_blank" rel="noopener">http://kotlinlang.org/docs/reference/basic-syntax.html</a><br>2. <a href="http://huanglizhuo.gitbooks.io/kotlin-in-chinese" target="_blank" rel="noopener">http://huanglizhuo.gitbooks.io/kotlin-in-chinese</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/my_avatar.jpg"
                alt="Wang Jie" />
            
              <p class="site-author-name" itemprop="name">Wang Jie</p>
              <p class="site-description motion-element" itemprop="description">Wang Jie's blog</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">144</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wangjiegulu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:tiantian.china.2@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/+%E5%A4%A9%E5%A4%A9wangjie" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/wangjiegulu" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/users/2124006/wangjie" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/wangjiegulu" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i></a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.cnblogs.com/tiantianbyconan/" title="cnblog" target="_blank">cnblog</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Jie</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>








        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://blog-wangjiegulu-com.disqus.com/count.js" async></script>
    

    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "default";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "GooglePlus,Evernote,Twitter,Facebook,Douban,Weibo";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  

  

  

</body>
</html>

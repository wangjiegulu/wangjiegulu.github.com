<!DOCTYPE html>




<html class="theme-next muse" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="WAND JIE" type="application/atom+xml" />






<meta name="description" content="Wang Jie&apos;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="WAND JIE">
<meta property="og:url" content="http://blog.wangjiegulu.com/page/2/index.html">
<meta property="og:site_name" content="WAND JIE">
<meta property="og:description" content="Wang Jie&apos;s blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WAND JIE">
<meta name="twitter:description" content="Wang Jie&apos;s blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.wangjiegulu.com/page/2/"/>





  <title>WAND JIE</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-111189680-2', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WAND JIE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">TO BE AN ARTIST-ENGINNER</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/" itemprop="url">[Android]使用Dagger 2来构建UserScope（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-30T17:23:00+08:00">
                2016-12-30
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a>
</strong></font>

<h1 id="使用Dagger-2来构建UserScope"><a href="#使用Dagger-2来构建UserScope" class="headerlink" title="使用Dagger 2来构建UserScope"></a>使用Dagger 2来构建UserScope</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/building-userscope-with-dagger2/" target="_blank" rel="noopener">http://frogermcs.github.io/building-userscope-with-dagger2/</a></p>
</blockquote>
<p>在Dagger 2中自定义scopes可以在不寻常存活时间（与Application和界面生命周期不同的）的依赖上给我带来更好的控制。但是在Android app中正确地实现它需要记住几个事情：scope不能存活比application进程更长的周期，进程可以被系统杀死并且在更多的对象实例的用户流中恢复过来。今天我们将介绍所有这些，并尝试实现可用于生产的UserScope。</p>
<p>在我的其中一篇博客中<a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-custom-scopes/" target="_blank" rel="noopener">写了</a>关于<strong>自定义scopes</strong>和<strong>Subcomponents</strong>。作为一个例子，我使用了<code>UserScope</code>，只要用户是登录状态就应该存活。一个scopes生命周期的例子：</p>
<p><img src="http://frogermcs.github.io/images/15/scopes-lifecycle.png" alt=""></p>
<p>虽然它看起来非常简单，它的实现在那篇文章中已经展示，但是它的代码是脱离与生产环境的。这就是为什么我想要又一次深入这个话题 - 但是会有更多实现的上下文细节。</p>
<h2 id="Example-app"><a href="#Example-app" class="headerlink" title="Example app"></a>Example app</h2><p>我们将构建3个界面的应用，它可以从<a href="https://developer.github.com/v3/" target="_blank" rel="noopener">Github API</a>获取用户详情（让我们假设这在生产环境app中作为一个认证的事件）。</p>
<p>App将会有3个scopes：</p>
<ul>
<li>(Application scope, <strong>@Singleton</strong>) - 只要application存活依赖就存活。</li>
<li><strong>@UserScope</strong> - 只要用户会话是激活状态依赖就存活（在单个应用程序中启动）。<strong>重要的是：</strong>这个scope存活时间不会超过application本身。每一个新的app实例都会创建一个新的@UserScope（甚至app不同的启动间用户会话没有关闭）。</li>
<li><strong>@ActivityScope</strong> - 只要Activity界面存活依赖就存活。</li>
</ul>
<h3 id="它怎么工作的呢？"><a href="#它怎么工作的呢？" class="headerlink" title="它怎么工作的呢？"></a>它怎么工作的呢？</h3><p>当app从Github API得到特定用户名的数据，新的界面会被打开（UserDetails）。在内部，<code>LoginActivityPresenter</code>访问<code>UserManager</code>来开启一个会话（从Github API获取数据）。当操作成功，用户保存到<code>UserDataStore</code>，并且<code>UserManager</code>创建<code>UserComponent</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UserManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Observable&lt;User&gt; <span class="title">startSessionForUser</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> githubApiService.getUser(username)</span><br><span class="line">            .map(User.UserResponseToUser())</span><br><span class="line">            .doOnNext(<span class="keyword">new</span> Action1&lt;User&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">                    userDataStore.createUser(user);</span><br><span class="line">                    startUserSession();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .subscribeOn(Schedulers.io())</span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">startUserSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user = userDataStore.getUser();</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Timber.i(<span class="string">"Session started, user: %s"</span>, user);</span><br><span class="line">        userComponent = userComponentBuilder.sessionModule(<span class="keyword">new</span> UserModule(user)).build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>UserManager</strong>是一个单例，所以它的存活时间与Applicaiton一致，而且它对生命周期与用户会话一样的<code>UserComponet</code>负责。当用户决定去关闭会话，component会被移除，这样所有<code>@UserScope</code>注解了的对象应该准备被GC回收。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UserManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeUserSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Timber.i(<span class="string">"Close session for user: %s"</span>, userDataStore.getUser());</span><br><span class="line">    userComponent.logoutManager().startLogoutProcess();</span><br><span class="line">    userDataStore.clearUser();</span><br><span class="line">    userComponent = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Components的层次结构"><a href="#Components的层次结构" class="headerlink" title="Components的层次结构"></a>Components的层次结构</h3><p>在我们的app中所有的subcomponents使用了一个<code>AppComponent</code>作为一个根component。显示用户相关内容的Subcomponents使用保持了带<code>@Userscope</code>注解的对象（一个用户会话一个实例）的<code>UserComponent</code>。</p>
<p><img src="http://frogermcs.github.io/images/28/scopes.png" alt=""></p>
<p><code>UserDetailsActivityComponent</code>组件层次结构示例如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AppComponent.java </span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component</span>(modules = &#123;</span><br><span class="line">        AppModule.class,</span><br><span class="line">        GithubApiModule.class</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">    UserComponent.<span class="function">Builder <span class="title">userComponentBuilder</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserComponent.java </span></span><br><span class="line"></span><br><span class="line"><span class="meta">@UserScope</span></span><br><span class="line"><span class="meta">@Subcomponent</span>(modules = UserModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subcomponent</span>.Builder</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">        UserComponent.<span class="function">Builder <span class="title">sessionModule</span><span class="params">(UserModule userModule)</span></span>;</span><br><span class="line">        <span class="function">UserComponent <span class="title">build</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">UserDetailsActivityComponent <span class="title">plus</span><span class="params">(UserDetailsActivityComponent.UserDetailsActivityModule <span class="keyword">module</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserDetailsActivityComponent.java </span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ActivityScope</span></span><br><span class="line"><span class="meta">@Subcomponent</span>(modules = UserDetailsActivityComponent.UserDetailsActivityModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailsActivityComponent</span> </span>&#123;</span><br><span class="line">    <span class="function">UserDetailsActivity <span class="title">inject</span><span class="params">(UserDetailsActivity activity)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于<code>UserComponent</code>，我们使用<a href="http://google.github.io/dagger/subcomponents.html#subcomponent-builders" target="_blank" rel="noopener">Subcomponent builder</a>模式来让我们的代码更加整洁，有可能注入这个Builder到<code>UserModule</code>（<code>UserComponent.Builder</code>用于创建组件<code>UserModule.startUserSession</code>方法如上所示）。</p>
<h3 id="在app的多次启动中恢复UserScope"><a href="#在app的多次启动中恢复UserScope" class="headerlink" title="在app的多次启动中恢复UserScope"></a>在app的多次启动中恢复UserScope</h3><p>就像我之前提到的UserScope的存活时间不能超过application进程。所以如果我们假设用户会话可以在app的多次启动之间保存，我们需要为我们的<code>UserScope</code>去处理状态恢复操作。有两种场景我们需要记住：</p>
<h4 id="用户从头开始启动程序"><a href="#用户从头开始启动程序" class="headerlink" title="用户从头开始启动程序"></a>用户从头开始启动程序</h4><p>这是最常见的情况，应该很简单地去处理。用户从头开始启动app（比如，通过点击app icon）。<code>Application</code>对象被创建，然后第一个<code>Activity</code>（<strong>LAUNCHER</strong>）被启动。我们需要提供简单的逻辑检查我们是否有保存的用户在我们的数据存储中。如果是则将用户传送到UserComponent自动创建的正确的界面（在我们案例中是<code>UserDetailsActivity</code>）。</p>
<h4 id="用户进程被系统kill"><a href="#用户进程被系统kill" class="headerlink" title="用户进程被系统kill"></a>用户进程被系统kill</h4><p>但是还有一种情况我们经常会忘记。Application进程可以被系统杀死（比如，因为内存不足）。这意味着所有application数据被销毁（application，activities，static fields）。不幸的是这不能被很好的处理 - 我们在Applicaiton生命周期中没有任何回调。令它更复杂的是，android保存了activity栈。也就是说，当用户决定启动之前被杀死于流中间的应用程序时，系统将试图带用户回到此界面。</p>
<p>对于我们而言我们需要准备在任何被使用的屏幕中去恢复<code>UserComponent</code>。</p>
<p>让我们考虑这个例子：</p>
<p>1. 用户在<code>UserDetailsActivity</code>界面最小化app。<br>2. 整个app被系统杀死（稍后我会展示如何模拟它）<br>3. 用户打开任务切换栏，点击我们的app界面。<br>4. 系统创建了一个新的<code>Application</code>实例。也就是说有一个新的<code>AppComponent</code>被创建。然后系统并不会打开<code>LoginActivity</code>（我们的启动activity），而是立即打开<code>UserDetailsActivity</code>。</p>
<p>对于我们而言，<code>UserComponent</code>被恢复回来（新的实例被创建）。然后这是我们的责任。例子的解决方案看起来如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseUserActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    UserManager userManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupActivityComponent</span><span class="params">(AppComponent appComponent)</span> </span>&#123;</span><br><span class="line">        appComponent.inject(<span class="keyword">this</span>);</span><br><span class="line">        setupUserComponent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupUserComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    isUserSessionStarted = userManager.isUserSessionStartedOrStartSessionIfPossible();</span><br><span class="line">    onUserComponentSetup(userManager.getUserComponent());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//This screen cannot work when user session is not started.</span></span><br><span class="line">    <span class="keyword">if</span> (!isUserSessionStarted) &#123;</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onUserComponentSetup</span><span class="params">(UserComponent userComponent)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每一个使用了UserComponent的Activity都继承了我们的<code>BaseUserActivity</code>类（<code>setupActivityComponent()</code>方法在<code>BaseActivity</code>的<code>onCreate()</code>方法中调用）。</p>
<p><code>UserManager</code>从Application创建的<code>AppComponent</code>中被注入。会话通过这种方式开启：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isUserSessionStartedOrStartSessionIfPossible</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userComponent != <span class="keyword">null</span> || startUserSession();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">startUserSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//This method was described earlier</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="如果用户不再存在怎么办？"><a href="#如果用户不再存在怎么办？" class="headerlink" title="如果用户不再存在怎么办？"></a>如果用户不再存在怎么办？</h4><p>这里有另外一种方式来处理 - 如果用户登出（比如，通过<code>SyncAdapter</code>），然后<code>UserComponent</code>不能被创建怎么办？这就是为什么在我们的<code>BaseUserActivity</code>中有这几行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupUserComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//This screen cannot work when user session is not started.</span></span><br><span class="line">    <span class="keyword">if</span> (!isUserSessionStarted) &#123;</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是这里有一个情况时当UserComponent不能被创建时我们必须要记住依赖注入将不会发生。这就是为什么我每次需要在<code>onCreate()</code>方法中检查来防止来自依赖注入的NullPointerExceptions。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UserDetailsActivity</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_user_details);</span><br><span class="line">    tvUser = (TextView) findViewById(R.id.tvUser);</span><br><span class="line">    tvUserUrl = (TextView) findViewById(R.id.tvUserUrl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//This check has to be called. Otherwise, when user is not logged in, presenter won't be injected and this line will cause NPE</span></span><br><span class="line">    <span class="keyword">if</span> (isUserSessionStarted()) &#123;</span><br><span class="line">        presenter.onCreate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="怎么去模拟应用进程被系统杀死"><a href="#怎么去模拟应用进程被系统杀死" class="headerlink" title="怎么去模拟应用进程被系统杀死"></a>怎么去模拟应用进程被系统杀死</h3><p>1. 打开你想测试的用户界面<br>2. 通过系统Home键最小化app。<br>3. 在Android Studio，Android Monitor 选中你的应用，然后点击Terminate<br>4. 现在在你的设备上打开任务切换栏，找到你的app（你应该仍然能在最后一个可见的界面上预览到）。<br>5. 你的app被启动，新的Application实例被创建，并且Activity被恢复。</p>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>例子中展示怎么样去创建和使用<code>UserComponent</code>的可用的源码已经在Github上：<a href="https://github.com/frogermcs/Dagger2Recipes-UserScope" target="_blank" rel="noopener">Dagger 2 recipes - UserScope</a>。</p>
<p>感谢阅读！</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/12/30/Android-在Dagger-2中使用RxJava来进行异步注入（翻译）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/30/Android-在Dagger-2中使用RxJava来进行异步注入（翻译）/" itemprop="url">[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-30T13:53:00+08:00">
                2016-12-30
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/12/30/Android-在Dagger-2中使用RxJava来进行异步注入（翻译）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/12/30/Android-在Dagger-2中使用RxJava来进行异步注入（翻译）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a>
</strong></font>

<h1 id="在Dagger-2中使用RxJava来进行异步注入"><a href="#在Dagger-2中使用RxJava来进行异步注入" class="headerlink" title="在Dagger 2中使用RxJava来进行异步注入"></a>在Dagger 2中使用RxJava来进行异步注入</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/async-injection-in-dagger-2-with-rxjava" target="_blank" rel="noopener">http://frogermcs.github.io/async-injection-in-dagger-2-with-rxjava</a></p>
</blockquote>
<p>几星期前我写了一篇关于在Dagger 2中使用<em>Producers</em>进行异步注入的<a href="https://medium.com/@froger_mcs/dependency-injection-with-dagger-2-producers-c424ddc60ba3" target="_blank" rel="noopener">文章</a>。在后台线程中执行对象的初始化又一个很好的优势 - 它负责实时（<a href="https://www.youtube.com/watch?v=CaMTIgxCSqU" target="_blank" rel="noopener">每秒60帧</a>可以保持界面流畅）绘制UI时不会在主线程中阻塞。</p>
<p>值得一提的是，缓慢的初始化过程并不是每个人都会觉得是个问题。但是如果你真的关心这个，所有外部库在构造以及在任何<code>init()</code>方法中进行磁盘/网络的操作会很常见。如果你不能确定这一点，我建议你尝试下<a href="https://github.com/frogermcs/AndroidDevMetrics" target="_blank" rel="noopener">AndroidDevMetrics</a> - 我的Android性能测量库。它会告诉你在app中需要花多少时间来显示特定的界面，还有（如果你使用了Dagger 2）在依赖图表中提供每个对象消耗了多少时间。</p>
<p>不幸的是Producers并不是为Android设计的，它有以下缺陷：</p>
<ul>
<li>依赖使用了Guava（会引起64k方法问题，增加build时间）</li>
<li>并不是非常快的（注入机制会阻塞主线程几毫秒到几十毫秒的世界，这取决于设备）</li>
<li>不能使用@Inject注解（代码会有一点混乱）</li>
</ul>
<p>虽然我们不能解决最后两个问题，但是第一个我们可以在Android Project中解决。</p>
<h2 id="使用RxJava进行异步注入"><a href="#使用RxJava进行异步注入" class="headerlink" title="使用RxJava进行异步注入"></a>使用RxJava进行异步注入</h2><p>幸运的是，有大量的Android开发者使用了RxJava（和<a href="https://github.com/ReactiveX/RxAndroid" target="_blank" rel="noopener">RxAndroid</a>）来在我们app中编写异步代码。让我们来尝试在Dagger 2中使用它来进行异步注入。</p>
<h3 id="异步-Singleton注入"><a href="#异步-Singleton注入" class="headerlink" title="异步@Singleton注入"></a>异步@Singleton注入</h3><p>这是我们繁重的对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="function">HeavyExternalLibrary <span class="title">provideHeavyExternalLibrary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HeavyExternalLibrary heavyExternalLibrary = <span class="keyword">new</span> HeavyExternalLibrary();</span><br><span class="line">    heavyExternalLibrary.init(); <span class="comment">//This method takes about 500ms</span></span><br><span class="line">    <span class="keyword">return</span> heavyExternalLibrary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在让我们来创建一个额外的<code>provide...()</code>方法，它返回一个<code>Observable&lt;HeavyExternalLibrary&gt;</code>对象，它会异步调用以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="function">Observable&lt;HeavyExternalLibrary&gt; <span class="title">provideHeavyExternalLibraryObservable</span><span class="params">(<span class="keyword">final</span> Lazy&lt;HeavyExternalLibrary&gt; heavyExternalLibraryLazy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> HeavyExternalLibrary&gt; subscriber)</span> </span>&#123;</span><br><span class="line">            subscriber.onNext(heavyExternalLibraryLazy.get());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让我们逐行来分析：</p>
<ul>
<li><code>@Singleton</code> - 记住这个很重要，<code>Observable</code>对象将会是一个单例，而不是<code>HeavyExternalLibrary</code>。Singleton也会阻止创建额外的Observable对象。</li>
<li><code>@Providers</code> - 因为这个方法是<code>@Module</code>注解了的类的一部分。你还记得<a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-the-api/" target="_blank" rel="noopener">Dagger 2 API</a>吗？</li>
<li><code>Lazy&lt;HeavyExternalLibrary&gt; heavyExternalLibraryLazy</code>对象阻止Dagger（否则，在调用<code>provideHeavyExternalLibraryObservable()</code>方法调用的瞬间对象就会被创建）内部对HeavyExternalLibrary对象的初始化。</li>
<li><code>Observable.create(...)</code>代码 - 它将在每次这个Observable被订阅时通过调用<code>heavyExternalLibraryLazy.get()</code>返回<code>heavyExternalLibrary</code>对象。</li>
<li><code>.subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread());</code> - 默认情况下RxJava代码会在Observable被创建的线程中执行。这就是为什么我们要把执行移动到后台线程（这里的<code>Schedulers.io()</code>），然后在主线程中（<code>AndroidSchedulers.mainThread()</code>）观察结果。</li>
</ul>
<p>我们的Observable像图表中其它对象一样被注入，但是<code>heavyExternalLibrary</code>对象本身将会延迟一点才可用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplashActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Inject</span></span><br><span class="line">	Observable&lt;HeavyExternalLibrary&gt; heavyExternalLibraryObservable;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//This will be injected asynchronously</span></span><br><span class="line">	HeavyExternalLibrary heavyExternalLibrary; </span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.onCreate();</span><br><span class="line">		<span class="comment">//...</span></span><br><span class="line">		heavyExternalLibraryObservable.subscribe(<span class="keyword">new</span> SimpleObserver&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(HeavyExternalLibrary heavyExternalLibrary)</span> </span>&#123;</span><br><span class="line">	            <span class="comment">//Our dependency will be available from this moment</span></span><br><span class="line">	            SplashActivity.<span class="keyword">this</span>.heavyExternalLibrary = heavyExternalLibrary;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="异步新实例的注入"><a href="#异步新实例的注入" class="headerlink" title="异步新实例的注入"></a>异步新实例的注入</h3><p>上面的代码展示了怎么去注入单例的对象。那如果我们想异步注入新的实例呢？</p>
<p>确认我们的对象不再使用了@Singleton注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="function">HeavyExternalLibrary <span class="title">provideHeavyExternalLibrary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HeavyExternalLibrary heavyExternalLibrary = <span class="keyword">new</span> HeavyExternalLibrary();</span><br><span class="line">    heavyExternalLibrary.init(); <span class="comment">//This method takes about 500ms</span></span><br><span class="line">    <span class="keyword">return</span> heavyExternalLibrary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们<code>Observable&lt;HeavyExternalLibrary&gt;</code> provider方法也会有一点改变。我们不能使用<code>Lazy&lt;HeavyExternalLibrary&gt;</code>因为它只会在第一次调用<code>get()</code>方法的时候（详见<a href="http://google.github.io/dagger/api/latest/dagger/Lazy.html" target="_blank" rel="noopener">Lazy文档</a>）才会创建新的实例。</p>
<p>这里是更新后的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="function">Observable&lt;HeavyExternalLibrary&gt; <span class="title">provideHeavyExternalLibraryObservable</span><span class="params">(<span class="keyword">final</span> Provider&lt;HeavyExternalLibrary&gt; heavyExternalLibraryProvider)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> HeavyExternalLibrary&gt; subscriber)</span> </span>&#123;</span><br><span class="line">            subscriber.onNext(heavyExternalLibraryProvider.get());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们的<code>Observable&lt;HeavyExternalLibrary&gt;</code>可以是一个单例，，但是每一次我们去调用它的subscribe()方法的时候，我们将会在onNext()方法中得到一个新的<code>HeavyExternalLibrary</code>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">heavyExternalLibraryObservable.subscribe(<span class="keyword">new</span> SimpleObserver&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(HeavyExternalLibrary heavyExternalLibrary)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//New instance of HeavyExternalLibrary</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="完全的异步注入"><a href="#完全的异步注入" class="headerlink" title="完全的异步注入"></a>完全的异步注入</h3><p>还有另一个方法是用RxJava在Dagger 2中进行异步注入。我们可以使用Observable简单封装整个注入过程。</p>
<p>我们注入的执行是这样的（代码摘自<a href="https://github.com/frogermcs/GithubClient/" target="_blank" rel="noopener">GithubClient</a>项目）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplashActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    SplashActivityPresenter presenter;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    AnalyticsManager analyticsManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//This method is called in super.onCreate() method</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupActivityComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> SplashActivityComponent splashActivityComponent = GithubClientApplication.get(SplashActivity.<span class="keyword">this</span>)</span><br><span class="line">                .getAppComponent()</span><br><span class="line">                .plus(<span class="keyword">new</span> SplashActivityModule(SplashActivity.<span class="keyword">this</span>));</span><br><span class="line">        splashActivityComponent.inject(SplashActivity.<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要让它变成异步我们只需要使用Observable封装<code>setupActivityComponent()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupActivityComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;Object&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Object&gt; subscriber)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> SplashActivityComponent splashActivityComponent = GithubClientApplication.get(SplashActivity.<span class="keyword">this</span>)</span><br><span class="line">                    .getAppComponent()</span><br><span class="line">                    .plus(<span class="keyword">new</span> SplashActivityModule(SplashActivity.<span class="keyword">this</span>));</span><br><span class="line">            splashActivityComponent.inject(SplashActivity.<span class="keyword">this</span>);</span><br><span class="line">            subscriber.onCompleted();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">            .subscribeOn(Schedulers.io())</span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">            .subscribe(<span class="keyword">new</span> SimpleObserver&lt;Object&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="comment">//Here is the moment when injection is done.</span></span><br><span class="line">                    analyticsManager.logScreenView(getClass().getName());</span><br><span class="line">                    presenter.callAnyMethod();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正如注释，所有<code>@Inject</code>注解了的对象将被未来某一时刻注入。在返回注入过程是异步的并且不会对主线程有很大的影响。</p>
<p>当然创建<code>Observable</code>对象和额外<code>subscribeOn()</code>线程并不是完全免费的 - 它将会花费一点时间。这类似于<strong>Producers</strong>代码所产生的影响。</p>
<p><img src="http://frogermcs.github.io/images/26/splash_metrics.png" alt=""></p>
<p>感谢阅读！</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/12/29/Android-使用Dagger-2进行依赖注入-Producers（翻译）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/29/Android-使用Dagger-2进行依赖注入-Producers（翻译）/" itemprop="url">[Android]使用Dagger 2进行依赖注入 - Producers（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-29T21:08:00+08:00">
                2016-12-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/12/29/Android-使用Dagger-2进行依赖注入-Producers（翻译）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/12/29/Android-使用Dagger-2进行依赖注入-Producers（翻译）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a>
</strong></font>

<h1 id="使用Dagger-2进行依赖注入-Producers"><a href="#使用Dagger-2进行依赖注入-Producers" class="headerlink" title="使用Dagger 2进行依赖注入 - Producers"></a>使用Dagger 2进行依赖注入 - Producers</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-producers/" target="_blank" rel="noopener">http://frogermcs.github.io/dependency-injection-with-dagger-2-producers/</a></p>
</blockquote>
<p>本文是在Android中使用Dagger 2框架进行依赖注入的系列文章中的一部分。今天我们将探索下Dagger Producers - 使用Java实现异步依赖注入的Dagger2的一个扩展。</p>
<h2 id="初始化性能问题"><a href="#初始化性能问题" class="headerlink" title="初始化性能问题"></a>初始化性能问题</h2><p>我们都知道Dagger 2是一个优化得很好的依赖注入框架。但是即使有这些全部的微优化，仍然在依赖注入的时候存在可能的性能问题 - “笨重”的第三方库和/或我们那些主线程阻塞的代码。</p>
<p>依赖注入是在尽可能短的时间内在正确的地方传递所请求的依赖的过程 - 这些都是Dagger 2做得很好的。但是DI也会去创建各种依赖。如果我们需要花费几百毫秒创建它们，那么以纳秒级的时间去提供依赖还有什么意义呢？</p>
<p>当我们的app创建了一系列繁重的单例并立即由Dagger2提供服务之后也许可能没有这么重要。但是在我们创建它们的时候仍然需要一个时间成本 - 大多数情况下决定了app启动的时间。</p>
<p>这问题（已经给了提示怎么去调适它）已经在我之前的一篇博客中描述地很详细了：<a href="http://frogermcs.github.io/dagger-graph-creation-performance/" target="_blank" rel="noopener">Dagger 2 - graph creation performance</a>。</p>
<p>在很短的时间内，让我们想象这么一个场景 - 你的app有一个初始化的界面（SplashScreen），需要在app启动后立即做一些需要的事情：</p>
<ul>
<li>初始化所有tracking libs（Goole Analytics, Crashlytics）然后发送第一份数据给它们。</li>
<li>创建用于API和/或数据库通信的整个栈。</li>
<li>我们试图的交互逻辑（MVP中的Presenters，MVVM中的ViewModels等等）。</li>
</ul>
<p>即使我们的代码是优化地非常好的，但是仍然有可能有些额外的库需要几十或者几百毫秒的时间来初始化。在我们启动界面之前将展示必须初始化和交付的所有请求的依赖（和它们的依赖）。这意味着启动时间将会是它们每一个初始化时间的总和。</p>
<p>由 <a href="https://github.com/frogermcs/androiddevmetrics" target="_blank" rel="noopener">AndroidDevMetrics</a> 测量的示例堆栈可能如下所示：</p>
<p><img src="http://frogermcs.github.io/images/24/example_dependencies.png" alt=""></p>
<p>用户将会在600ms（＋额外的系统work）内看到SplashActivity - 所有初始化时间的总和。</p>
<h2 id="Producers-异步依赖注入"><a href="#Producers-异步依赖注入" class="headerlink" title="Producers - 异步依赖注入"></a>Producers - 异步依赖注入</h2><p>Dagger 2 有一个名为 <strong>Producers</strong> 的扩展，或多或少能为我们解决这些问题。</p>
<p>思路很简单 - 整个初始化流程可以在一个或多个后台线程中被执行，然后延后再交付给app的主线程。</p>
<h4 id="ProducerModule"><a href="#ProducerModule" class="headerlink" title="@ProducerModule"></a>@ProducerModule</h4><p>类似于<code>@Module</code>，这个被用来标记用于传递依赖的类。多亏于它，Dagger将会知道去哪里找到被请求的依赖。</p>
<h4 id="Produces"><a href="#Produces" class="headerlink" title="@Produces"></a>@Produces</h4><p>类似于<code>@Provide</code>，这个注解用来标记带有<code>@ProducerModule</code>注解的类中的返回依赖的方法。<code>@Produces</code>注解的方法可以返回<code>ListenableFuture&lt;T&gt;</code>或者自身的对象（也会在所给的后台线程中进行初始化）。</p>
<h4 id="ProductionComponent"><a href="#ProductionComponent" class="headerlink" title="@ProductionComponent"></a>@ProductionComponent</h4><p>类似于<code>@Component</code>，它负责依赖的传递。它是我们代码与<code>@ProducerModule</code>之间的桥梁。唯一跟<code>@Component</code>的不同之处是我们不能决定依赖的scope。这意味着提供给 <em>component</em> 的每一个 <em>Produces 方法</em> 在 <em>每个component 实例</em> 中最多只会被调用一次，不管它作为一个 <em>依赖</em> 用于多少次绑定。</p>
<p>也就是说，每一个服务于<code>@ProductionComponent</code>的对象都是一个单例（只要我们从这个特殊的component中获取）。</p>
<hr>
<p>Producers的文档已经足够详细了，所以这里没有必要去拷贝到这里。直接看：<a href="http://google.github.io/dagger/producers.html" target="_blank" rel="noopener">Dagger 2 Producers docs</a>。</p>
<h3 id="Producers的代价"><a href="#Producers的代价" class="headerlink" title="Producers的代价"></a>Producers的代价</h3><p>在我们开始实践前，有一些值得提醒的事情。Producers相比Dagger 2本身有一点更复杂。它看起来手机端app不是他们它们主要使用的目标，而且知道这些事情很重要：</p>
<ul>
<li>Producers使用了Guava库，并且建立在ListenableFuture类之上。这意味着你不得不处理15k的额外方法在你的app中。这可能导致你不得不使用<em>Proguard</em>来处理并且需要一个更长的编译时间。</li>
<li>就如你将看到的，创建<code>ListenableFutures</code>并不是没有成本的。所以如果你指望Producers会帮你从10ms优化到0ms那你可能就错了。但是如果规模更大（100ms –&gt; 10ms），你就能有所发现。</li>
<li>现在无法使用<code>@Inject</code>注解，所以你必须要手动处理ProductionComponents。它会使得你的标准整洁的代码变得混乱。</li>
</ul>
<p><a href="http://stackoverflow.com/questions/35617378/injects-after-produces" target="_blank" rel="noopener">这里</a>你可以针对<code>@Inject</code>注解找到好的间接的解决方案的尝试。</p>
<h2 id="Example-app"><a href="#Example-app" class="headerlink" title="Example app"></a>Example app</h2><p>如果你仍然希望使用Producers来处理，那就让我们更新 <a href="https://github.com/frogermcs/GithubClient/" target="_blank" rel="noopener">GithubClient</a> 这个app使得它在注入过程使用Producers。在实现之前和之后我们将会使用 <a href="https://github.com/frogermcs/androiddevmetrics" target="_blank" rel="noopener">AndroidDevMetrics</a> 来测量启动时间和对比结果。</p>
<p><a href="https://github.com/frogermcs/GithubClient/tree/1c14683691e0e7af17b26055a0fd041d4a7df424" target="_blank" rel="noopener">这里</a>是一个在使用producers更新之前的 GithubClient app的版本。并且它测量的平均启动时间如下：</p>
<p><img src="http://frogermcs.github.io/images/24/before_update.png" alt=""></p>
<p>我们的计划是处理UserManager让它的所有的依赖来自Producers。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>我们将给一个Dagger v2.1的尝试（但是当前2.0版本的Producers也是可用的）。</p>
<p>让我们在项目中加入一个Dagger新的版本：</p>
<p><strong><em>app/build.gradle：</em></strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.neenbedankt.android-apt'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.frogermcs.androiddevmetrics'</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    maven &#123;</span><br><span class="line">        url <span class="string">"https://oss.sonatype.org/content/repositories/snapshots"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Dagger 2</span></span><br><span class="line">    compile <span class="string">'com.google.dagger:dagger:2.1-SNAPSHOT'</span></span><br><span class="line">    compile <span class="string">'com.google.dagger:dagger-producers:2.1-SNAPSHOT'</span></span><br><span class="line">    apt <span class="string">'com.google.dagger:dagger-compiler:2.1-SNAPSHOT'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如你所见，Producers 作为一个新的依赖，在dagger 2库的下面。还有值得一说的是Dagger v2.1终于不需要<code>org.glassfish:javax.annotation:10.0-b28</code>的依赖了。</p>
<h3 id="Producer-Module"><a href="#Producer-Module" class="headerlink" title="Producer Module"></a>Producer Module</h3><p>现在，让我们移动代码从<code>GithubApiModule</code>到新创建的<code>GithubApiProducerModule</code>中。原来的代码可以在这里找到：<a href="https://github.com/frogermcs/GithubClient/blob/1c14683691e0e7af17b26055a0fd041d4a7df424/app/src/main/java/frogermcs/io/githubclient/data/api/GithubApiModule.java" target="_blank" rel="noopener">GithubApiModule</a></p>
<p><strong><em>GithubApiProducerModule.java</em></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ProducerModule</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GithubApiProducerModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Produces</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> OkHttpClient <span class="title">produceOkHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> OkHttpClient.Builder builder = <span class="keyword">new</span> OkHttpClient.Builder();</span><br><span class="line">        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">            HttpLoggingInterceptor logging = <span class="keyword">new</span> HttpLoggingInterceptor();</span><br><span class="line">            logging.setLevel(HttpLoggingInterceptor.Level.BODY);</span><br><span class="line">            builder.addInterceptor(logging);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        builder.connectTimeout(<span class="number">60</span> * <span class="number">1000</span>, TimeUnit.MILLISECONDS)</span><br><span class="line">                .readTimeout(<span class="number">60</span> * <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Produces</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Retrofit <span class="title">produceRestAdapter</span><span class="params">(Application application, OkHttpClient okHttpClient)</span> </span>&#123;</span><br><span class="line">        Retrofit.Builder builder = <span class="keyword">new</span> Retrofit.Builder();</span><br><span class="line">        builder.client(okHttpClient)</span><br><span class="line">                .baseUrl(application.getString(R.string.endpoint))</span><br><span class="line">                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</span><br><span class="line">                .addConverterFactory(GsonConverterFactory.create());</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Produces</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GithubApiService <span class="title">produceGithubApiService</span><span class="params">(Retrofit restAdapter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restAdapter.create(GithubApiService.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Produces</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserManager <span class="title">produceUserManager</span><span class="params">(GithubApiService githubApiService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserManager(githubApiService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Produces</span></span><br><span class="line">    <span class="keyword">public</span> UserModule.<span class="function">Factory <span class="title">produceUserModuleFactory</span><span class="params">(GithubApiService githubApiService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserModule.Factory(githubApiService);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看起来很像？没错，我们只是修改了：</p>
<ul>
<li><code>@Module</code> 改为 <code>@ProducerModule</code></li>
<li><code>@Provides @Singleton</code> 改为 <code>@Produces</code>。<em>你还记得吗？在Producers中我们默认就有一个单例</em></li>
</ul>
<p><code>UserModule.Factory</code> 依赖只是因为app的逻辑原因而添加。</p>
<h2 id="Production-Component"><a href="#Production-Component" class="headerlink" title="Production Component"></a>Production Component</h2><p>现在让我们创建<code>@ProductionComponent</code>，它将会为<code>UserManager</code>实例提供服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ProductionComponent</span>(</span><br><span class="line">        dependencies = AppComponent.class,</span><br><span class="line">        modules = GithubApiProducerModule.class</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppProductionComponent</span> </span>&#123;</span><br><span class="line">    <span class="function">ListenableFuture&lt;UserManager&gt; <span class="title">userManager</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    ListenableFuture&lt;UserModule.Factory&gt; userModuleFactory();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又一次，非常类似原来的<a href="https://github.com/frogermcs/GithubClient/blob/master/app/src/main/java/frogermcs/io/githubclient/AppComponent.java" target="_blank" rel="noopener">Dagger’s @Component</a>。</p>
<p>ProductionComponent的构建也是与标准的Component非常相似：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AppProductionComponent appProductionComponent = DaggerAppProductionComponent.builder()</span><br><span class="line">    .executor(Executors.newSingleThreadExecutor())</span><br><span class="line">    .appComponent(appComponent)</span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure>
<p>额外附加的参数是<code>Executor</code>实例，它告诉ProductionComponent依赖应该在哪里（哪个线程）被创建。在我们的例子中我们使用了一个single-thread executor，但是当然增加并行级别并使用多线程执行不是一个问题。</p>
<h2 id="获取依赖"><a href="#获取依赖" class="headerlink" title="获取依赖"></a>获取依赖</h2><p>就像我说的，当前我们不能去使用<code>@Inject</code>注解。相反，我们必须直接询问ProductionComponent（你可以在<a href="https://github.com/frogermcs/GithubClient/blob/master/app/src/main/java/frogermcs/io/githubclient/ui/activity/presenter/SplashActivityPresenter.java" target="_blank" rel="noopener">SplashActivityPresenter</a>找到这些代码）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">appProductionComponent = splashActivity.getAppProductionComponent();</span><br><span class="line">Futures.addCallback(appProductionComponent.userManager(), <span class="keyword">new</span> FutureCallback&lt;UserManager&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(UserManager result)</span> </span>&#123;</span><br><span class="line">        SplashActivityPresenter.<span class="keyword">this</span>.userManager = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这里重要的是，对象初始化是在你第一次调用<code>appProductionComponent.userManager()</code>的时候开始的。在这之后<code>UserManager</code>对象将会被缓存。这表示每一个绑定都拥有跟component实例相同的生命周期。</p>
<p>以上几乎就是所有了。当然你应该知道在<code>Future.onSuccess()</code>方法被调用之前userManager实例会时<code>null</code>。</p>
<h2 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h2><p>在最后让我们来看下现在注入的性能是怎么样的：</p>
<p><img src="http://frogermcs.github.io/images/24/after_update.png" alt=""></p>
<p>是的，没错 - 这时平均值大约是15ms。它小于同步注入（平均. 25ms）但是并不如你期望的那样少。这时因为Producers并不像Dagger本身那样轻量。</p>
<p>所以现在取决于你了 - 是否值得使用Guava, Proguard和代码复杂度来做<strong>这种</strong>优化。</p>
<p>请记住，如果你觉得Producers并不是最适合你的app的，你可以在你的app中尝试使用RxJava或者其他异步代码来包装你的注入。</p>
<p>感谢阅读！</p>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3><p>以上描述的完整代码可见Github <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">repository</a>。</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/11/01/Android-Android端ORM框架——RapidORM-v2-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/01/Android-Android端ORM框架——RapidORM-v2-1/" itemprop="url">[Android]Android端ORM框架——RapidORM(v2.1)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-11-01T17:54:00+08:00">
                2016-11-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/11/01/Android-Android端ORM框架——RapidORM-v2-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/11/01/Android-Android端ORM框架——RapidORM-v2-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br><br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/6020412.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6020412.html</a>
</strong></font>

<h1 id="Android-Android端ORM框架——RapidORM-v2-1"><a href="#Android-Android端ORM框架——RapidORM-v2-1" class="headerlink" title="[Android]Android端ORM框架——RapidORM(v2.1)"></a>[Android]Android端ORM框架——RapidORM(v2.1)</h1><p><strong><a href="https://github.com/wangjiegulu/RapidORM" target="_blank" rel="noopener">RapidORM</a>：Android端轻量高性能的ORM框架</strong></p>
<p><strong>GitHub:</strong> <a href="https://github.com/wangjiegulu/RapidORM" target="_blank" rel="noopener">https://github.com/wangjiegulu/RapidORM</a></p>
<h2 id="RapidORM-v2-1-feature"><a href="#RapidORM-v2-1-feature" class="headerlink" title="RapidORM v2.1 feature"></a>RapidORM v2.1 feature</h2><p>1. 在执行SQL和创建表时提升性能。</p>
<p>2. 提升bind参数时的性能</p>
<p>3. Index支持。</p>
<p>4. 上传至Maven中心库。</p>
<h2 id="关于-RapidORM"><a href="#关于-RapidORM" class="headerlink" title="关于 RapidORM"></a>关于 RapidORM</h2><ul>
<li><p>主键支持任何类型，支持联合主键。</p>
</li>
<li><p>非反射执行SQL。</p>
</li>
<li><p>高性能。</p>
</li>
<li><p>兼容 <code>android.database.sqlite.SQLiteDatabase</code>、 <code>net.sqlcipher.database.SQLiteDatabase</code>以及更多加密实现。</p>
</li>
<li><p>友好的面向对象接口调用。</p>
</li>
<li><p>Index支持。</p>
</li>
<li><p>联表查询未支持。</p>
</li>
</ul>
<p><code>v2.0</code> blog: <a href="http://www.cnblogs.com/tiantianbyconan/p/5626716.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5626716.html</a></p>
<p><code>v1.0</code> blog: <a href="http://www.cnblogs.com/tiantianbyconan/p/4748077.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4748077.html</a></p>
<h2 id="怎么使用"><a href="#怎么使用" class="headerlink" title="怎么使用"></a>怎么使用</h2><h3 id="1-build-gradle-添加依赖"><a href="#1-build-gradle-添加依赖" class="headerlink" title="1. build.gradle 添加依赖"></a>1. <code>build.gradle</code> 添加依赖</h3><h3 id="Gadle-获取最新版本"><a href="#Gadle-获取最新版本" class="headerlink" title="Gadle(获取最新版本)"></a>Gadle(<a href="http://search.maven.org/#search%7Cga%7C1%7CRapidORM" target="_blank" rel="noopener">获取最新版本</a>)</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">"com.github.wangjiegulu:rapidorm:x.x.x"</span></span><br><span class="line"></span><br><span class="line">compile <span class="string">"com.github.wangjiegulu:rapidorm-api:x.x.x"</span></span><br><span class="line"></span><br><span class="line">apt <span class="string">"com.github.wangjiegulu:rapidorm-compiler:x.x.x"</span></span><br></pre></td></tr></table></figure>
<h3 id="Maven-获取最新版本"><a href="#Maven-获取最新版本" class="headerlink" title="Maven(获取最新版本)"></a>Maven(<a href="http://search.maven.org/#search%7Cga%7C1%7CRapidORM" target="_blank" rel="noopener">获取最新版本</a>)</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.wangjiegulu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rapidorm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>x.x.x<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>具体使用方式见：</p>
<blockquote>
<p><code>v2.0</code> blog: <a href="http://www.cnblogs.com/tiantianbyconan/p/5626716.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5626716.html</a></p>
<p><code>v1.0</code> blog: <a href="http://www.cnblogs.com/tiantianbyconan/p/4748077.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4748077.html</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/09/21/Android-使用MVP解决技术债务（翻译）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/21/Android-使用MVP解决技术债务（翻译）/" itemprop="url">[Android]使用MVP解决技术债务（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-21T15:03:00+08:00">
                2016-09-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/21/Android-使用MVP解决技术债务（翻译）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/09/21/Android-使用MVP解决技术债务（翻译）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5892671.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5892671.html</a>
</strong></font>

<h1 id="使用MVP解决技术债务"><a href="#使用MVP解决技术债务" class="headerlink" title="使用MVP解决技术债务"></a>使用MVP解决技术债务</h1><blockquote>
<p>原文：<a href="https://medium.com/picnic-engineering/tackling-technical-debt-with-mvp-67e805ed5103#.couu0d5i0" target="_blank" rel="noopener">https://medium.com/picnic-engineering/tackling-technical-debt-with-mvp-67e805ed5103#.couu0d5i0</a></p>
</blockquote>
<p>免责申明：这篇博客并不是讲关于怎么使用MVP的方式（上帝知道关于这些已经太多了）去写Android代码。而仅仅是我的个人经验，关于怎么转换我们的表现层到MVP架构来帮助我们解决一些累积的技术债务，而且在这个过程中也会帮助我们的app从一个原型转变成一个更具维护性的产品。</p>
<p>任何从事Android工作足够久、项目足够大的开发者最有可能达到一个点，他们面对他们的代码库，觉得应该有更好的实现方案。我们在Picnic也是一样，在Android app开发开始后大约八个月，我们到达了的那一刻，就在我们向公众发布第一个版本的时候。</p>
<p>这一刻正好是在我们app推出的时候这也并不意外。直到那时，我们以一个非常快的速度在前进，不断敲打我们的键盘，从零开始构建一个完整的产品，尝试新的东西，结合用户反馈到我们的app中，在每天的基础上增加和丢弃特性。</p>
<p>为了跟上公司的速度我们砍掉了这里那里的边边角角。这样的工作对我们来说很好，这也是我们能够在这么短的时间内构建这个app的原因之一。但是正如预期那样，最后这些决定的影响开始以技术债务的形式显示出来。幸运的是这些技术债务是在数月之内建立的，在app的性能和稳定性上面并没有任何真正的影响。反而我们是在其它领域开始注意到它：</p>
<ul>
<li>新功能迭代时间的增加。</li>
<li>新入职的开发者遇到困难</li>
<li>它被证实难以实现自动化测试</li>
<li>整体功能的复杂性在增加</li>
</ul>
<p>我们已经有了一个很好的想法和一个易于理解的架构，用于网络层、错误处理和app内部模块通信。但是像大多数Android开发者，我们会对把太多的逻辑放进Activity和Fragment中会产生内疚。</p>
<p>旁注：这是Android开发者的共同的问题，而作为开发者需要在黑暗中摸索，因为Google对这个话题保持沉默。我们从它们那里得到的第一个（算是）官方回复是来自Android团队的一个开发者在 <a href="https://plus.google.com/+DianneHackborn/posts/FXCCYxepsDU" target="_blank" rel="noopener">Google+ post</a>，说明我们应该把核心的Android API作为一个‘系统框架’，意味着他们会带我们手把手地到达Android核心的组件（Activity, BroadcastReceiver, Service 和 ContentProvider）。之后我们做什么都是看我们自己了。而且就在最近，Google终于提供了一系列的例子用来解决关于怎么构建一个Android app的共同问题，它着重于MVP。尽管只是beta，但是它可以在这里查看：<a href="https://github.com/googlesamples/android-architecture" target="_blank" rel="noopener">Android Architecture Blueprints</a>。</p>
<p>无论如何，这其实是一件好事，因为这意味着我们可以自由地去实验任何我们喜欢的方式，而不是被强制在一个平台遵循一个特定的模式。</p>
<p>现在讲回我们的故事… 除非你处在Android开发世界的远古时期，你应该会注意到表现层架构是现在的热门。关于最好的方式是什么，每个人甚至连他妈妈似乎都有自己的观点。工作中标准的Android方式（类似MVC），到MVP，到通过data-binding的MVVM，所有的方式都沿用了 Uncle Bob 的 <em>clean architecture</em>。每一种方式围绕赞成或者反对的意见都有一些有趣的讨论，但是有一件事我们要明确知道，那就是我们应该避免喝Kool-Aid<em>（译者注：这里是比喻，表示非常愚昧地接受信奉某种观点或者思想）</em>和期望其中一种是银色子弹<em>（译者注：这里是比喻为具有极端有效性的解决方法）</em>然后永远解决所有问题。</p>
<p>当在考虑怎么去重构我们的表现层时，我们已经有近一年的代码库的积累，我们很清楚我们的缺陷在哪里，然后我们需要使用一个新的实现（以上主要表示一些能够解决我们的技术债务的点）来达到我们的目标。我们在虚拟的项目中试玩了一些，体验了各种方法的不同之处，然后最终决定使用MVP。从它的核心来说，MVP本身仅仅是一个概念，而Android框架，根据设计，并不强制任何模式，我们可以自由地选择实际的实现细节。</p>
<p>在Android团队中，首先我们是不过度工程的信徒，让代码随着时间的推移自然地发展，而不是过早地在试图为自己不可预知的未来做准备的抽象之上增加抽象。正因为这个原因，我们选择另一风味的MVP，使得可以最低限度地保持我们的抽象层次。在代码级别，这意味着有一个单独的接口来表示View。所有其它的组件都是具体的类。你可能会问自己，怎么会只有View使用接口？考虑到我们迫切的需要，这是真正受益于这样的接口的唯一的组件，因为我们实际上有不同的具体的Views来共享相同的接口。所以在我们的案例中，这里的一个接口将被允许我们去重用Presenters。一些MVP实现建议给所有组件（M，V和P）设置接口。尽管这样会工作得很完美，但是我们在较早的阶段并不提倡，因为添加之后的成本是代码可读性和维护性，尤其是当我们考虑到新入职对MVP陌生的初级开发者的时候，好处超过面向接口编程的方式。</p>
<p>相比其他，MVP实现是非常标准的。View（Activity，Fragment或者一个自定义View）负责创造和维护Presenter，而Presenter处理各种业务相关的逻辑（数据获取，存储，格式化等等），然后根据需要通过更新UI回调到View。在我们的案例中，数据层已经是相当模块化了，构造用于表示数据模型的POJOs，以及一个预先存在的控制层用于处理网络通信。</p>
<p>这是一个非常标准的MVP设置，也因为它很简单，我们可以在几周的时间内替换几乎我们的所有的UI代码。因为我们已经存在独立的数据层来处理所有与后端的API交互，所以真正需要重构的只是Views和Presenters的交互。</p>
<p>在重构的过程中，我们也学习了一些可能会派得上用场的东西：</p>
<ul>
<li><p><strong>生命周期：</strong>因为Presenter是View创建的，我们需要确保完全地理解View的生命周期，特别是因为它将最有可能去处理状态更新和异步数据。举个例子，每一个Presenter应该在View destroyed的情况下有一个取消异步任务的方式，或者应该在用户暂停或者恢复视图事件时重置到原始状态等等。最后但同样重要的是，当View已经被销毁，试图从Presenter去更新View元素，始终需要注意可怕的NPEs。</p>
</li>
<li><p><strong>保持Views尽可能地愚蠢：</strong>我们的Views应该不再包含任何业务相关的逻辑。它应该只包含Android框架inflate和设置View的这些最低限度的东西。任何用户交互应该派发到Presenter。根据经验，如果你的views有任何其它方法去更新UI元素或者响应用户触发的事件，那么你可能应该去检查它们的实现。</p>
</li>
<li><p><strong>保持Presenter尽可能地纯粹：</strong>这一点，我们的意思时你应该尽可能地避免有Android相关的代码在你的presenters中。为这些组件编写纯粹的单元测试，而不需要使用其它如Robolectric等测试框架，这明显地得到了简化。这明显说起来比做起来容易得多，因为你终归会在某些地方遇到这种情况，举个例子，你将需要有一个Context的引用用来比如数据加载、访问strings文件等等。</p>
</li>
</ul>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>那么，说了那么多，最终的结论是什么呢？总的来说，我很高兴使用了MVP。它一定程度上帮我们解决了我们快速开发所累积的技术债务，然后，我们准备了更多来针对第二阶段的开发。</p>
<p>一些值得一提的事情：</p>
<ul>
<li><p><strong>测试数：</strong>在重构之前，测试的数量用两只手都可以数得过来。这是一个巨大的任务来针对包含了所有逻辑如执行数据解析、格式化、网络请求、错误处理和管理自己的生命周期的Activity编写测试。仅思考如果在这些条件下编写测试就足以让我们去寻找其它的方式了。一旦转换我们的第一份代码到MVP，对此编写测试就变得碎片化了。通过一个清晰的合同明确什么View能够处理，我们可以把自己的代码与Android UI框架隔离开，然后仅仅测试实际调用的是否是正确的方法，并给出每个测试场景。现在实际的业务相关逻辑被放置在Presenters中，因为它们绝大多数都不需要有Android OS相关的认知（或者小部分相关的可以被mocked），我们也可以针对它们编写非常有效率的单元测试，因此，在过去几个月里，我们的测试用例从原来的10增加到900，而且还在增长中。</p>
</li>
<li><p><strong>可预见性：</strong>这个是有一点软度量，但是非常强大的一点。针对UI，我们选择并坚持一个通用的模式，我可以在代码库中获得可预见的好处。这意味着，无论是哪种开发者眼里的UI元素（Activity，Dialog，Fragment等等），如果理解其中一个怎么工作，那也就能理解所有怎么工作。打开一个就算不是你写的文件也不再会遇到让你觉得惊喜的东西了。明确规定职责，每一单个的UI组件都遵循相同的明确的模式。让新入职的新开发者从第一天起就是高效的，这是非常宝贵的。</p>
</li>
</ul>
<p>我们别忘记MVP并不只是用于表现层，但是作为前端开发人员，这里花费了我们太多的时间。所以努力去寻找一个解决方案来给我们带来更好的可预见性和在新的开发者加入我们的时候也能让我们快速迭代是值得的。经过全面的考虑，我们可以有把握地说MVP是可以帮助我们达到这个目标的一个重要的里程碑。</p>
<p>P.S. 如果你仍然渴望看到一些源代码，这里有一个我们MVP实现‘忘记密码’用例的剥离下来的版本，展示MVP组件与用户的交互，用户点击‘重置密码’按钮进入他们的邮件地址（为保持代码的简洁，Android模版代码已经移除）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BasePresenter.java (Base class for all our Presenters)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePresenter</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> WeakReference&lt;V&gt; mView;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindView</span><span class="params">(@NonNull V view)</span> </span>&#123;</span><br><span class="line">    mView = <span class="keyword">new</span> WeakReference&lt;&gt;(view);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbindView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mView = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> V <span class="title">getView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> mView.get();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isViewAttached</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mView != <span class="keyword">null</span> &amp;&amp; mView.get() != <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IForgotPasswordView.java (view interface)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IForgotPasswordView</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">showLoading</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">hideLoading</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setEmailText</span><span class="params">(String email)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">showEmailNotValidError</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">showPasswordRequestOk</span><span class="params">(String message)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">showPasswordRequestFail</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ForgotPasswordFragment.java (view implementation)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForgotPasswordFragment</span> <span class="keyword">implements</span> <span class="title">IForgotPasswordView</span>,</span></span><br><span class="line"><span class="class">        <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Triggered by the user clicking a button</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResetPasswordClick</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String email = mEmailEditText.getText().toString();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Forward all logic to the Presenter</span></span><br><span class="line">    mPresenter.requestPasswordChange(email);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ForgotPasswordPresenter.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForgotPasswordPresenter</span> <span class="keyword">extends</span> <span class="title">BasePresenter</span>&lt;<span class="title">IForgotPasswordView</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestPasswordChange</span><span class="params">(String email)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Utils.isEmailValid(email)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Make sure the view is still alive before trying to access it</span></span><br><span class="line">      <span class="keyword">if</span>(isViewAttached()) &#123;</span><br><span class="line">        getView().showEmailNotValidError();    </span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      requestPasswordChangeAsync(email);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">requestPasswordChangeAsync</span><span class="params">(String email)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update the view's UI elements</span></span><br><span class="line">    <span class="keyword">if</span>(isViewAttached()) &#123;</span><br><span class="line">      getView().hideKeyboard();</span><br><span class="line">      getView().showLoading();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Call our API (results are posted back on an EventBus)</span></span><br><span class="line">      api.forgotPassword(email);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Subscription to the event bus</span></span><br><span class="line">  <span class="meta">@Subscribe</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(<span class="keyword">final</span> Event event)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isViewAttached()) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update the view's UI elements</span></span><br><span class="line">      getView().hideLoading();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">switch</span> (event.getType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> FORGOT_PASSWORD_OK:</span><br><span class="line">          getView().showPasswordRequestOk((String) event.getData());</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> FORGOT_PASSWORD_FAILED:</span><br><span class="line">          getView().showPasswordRequestFail();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/09/01/Android-异步-layout-inflation（翻译）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/01/Android-异步-layout-inflation（翻译）/" itemprop="url">[Android]异步 layout inflation（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-01T14:42:00+08:00">
                2016-09-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/01/Android-异步-layout-inflation（翻译）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/09/01/Android-异步-layout-inflation（翻译）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5829809.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5829809.html</a>
</strong></font>

<h1 id="异步-layout-inflation"><a href="#异步-layout-inflation" class="headerlink" title="异步 layout inflation"></a>异步 layout inflation</h1><blockquote>
<p>原文：<a href="&#109;&#97;&#x69;&#108;&#x74;&#x6f;&#58;&#104;&#x74;&#116;&#112;&#115;&#x3a;&#47;&#47;&#109;&#x65;&#100;&#x69;&#117;&#109;&#x2e;&#99;&#111;&#x6d;&#47;&#64;&#108;&#117;&#112;&#x61;&#106;&#122;&#x2f;&#97;&#115;&#x79;&#x6e;&#99;&#x68;&#114;&#x6f;&#x6e;&#x6f;&#x75;&#x73;&#45;&#x6c;&#97;&#121;&#111;&#117;&#116;&#x2d;&#105;&#110;&#x66;&#108;&#x61;&#116;&#x69;&#x6f;&#x6e;&#45;&#x37;&#x63;&#x62;&#99;&#x61;&#x32;&#54;&#x35;&#x33;&#98;&#102;&#x23;&#x2e;&#x71;&#x32;&#50;&#x76;&#x70;&#x65;&#x7a;&#x67;&#52;">&#104;&#x74;&#116;&#112;&#115;&#x3a;&#47;&#47;&#109;&#x65;&#100;&#x69;&#117;&#109;&#x2e;&#99;&#111;&#x6d;&#47;&#64;&#108;&#117;&#112;&#x61;&#106;&#122;&#x2f;&#97;&#115;&#x79;&#x6e;&#99;&#x68;&#114;&#x6f;&#x6e;&#x6f;&#x75;&#x73;&#45;&#x6c;&#97;&#121;&#111;&#117;&#116;&#x2d;&#105;&#110;&#x66;&#108;&#x61;&#116;&#x69;&#x6f;&#x6e;&#45;&#x37;&#x63;&#x62;&#99;&#x61;&#x32;&#54;&#x35;&#x33;&#98;&#102;&#x23;&#x2e;&#x71;&#x32;&#50;&#x76;&#x70;&#x65;&#x7a;&#x67;&#52;</a></p>
</blockquote>
<p>随着最近发布的<a href="https://developer.android.com/topic/libraries/support-library/revisions.html" target="_blank" rel="noopener">Android Support Library, revision 24</a>，Google开发者在v4包中增加了一个用来异步inflate layouts的帮助类。</p>
<h2 id="进入-AsyncLayoutInflater"><a href="#进入-AsyncLayoutInflater" class="headerlink" title="进入 AsyncLayoutInflater"></a>进入 AsyncLayoutInflater</h2><p>你会发现AsyncLayoutInflater可以使用在当你想要去懒加载你应用中部分UI或者用户行为的响应。这个帮助类将会允许你的UI线程在执行繁重的inflate时继续保持响应。</p>
<p>使用AsyncLayoutInflater你需要在你应用的<strong>UI线程</strong>创建一个它的实例。</p>
<p>假设下面部分代码是你Activity代码中的一部分（我将在这里使用Kotlin语法）：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> inflater = AsyncLayoutInflater(<span class="keyword">this</span>)</span><br></pre></td></tr></table></figure>
<p>然后现在可以通过这个实例inflate你的layout文件：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inflater.inflate(resId: <span class="built_in">Int</span>, parent: ViewGroup)</span><br></pre></td></tr></table></figure>
<p>如你所见，inflate函数接收3个参数。第一个是你layout资源，第二个是可选的view作为预期inflated层次结构的parent，然后第三个是一个<code>OnInflateFinishedListener</code>，是一个回调，一旦layout被inflate完毕它就会被回调（例子中被lambda函数代替）。</p>
<p>比较基本的LayoutInflater的inflate函数，一般使用一个boolean作为第三个参数，它表示是否inflate层次结构应该附属岛一个root参数上面。在我们的inflate函数的异步版本中并没有这样一个参数，大多数情况下你会使用这种方式调用：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">inflater.inflate(resId: <span class="built_in">Int</span>, parent: ViewGroup) </span><br><span class="line">    &#123; view, resid, parent -&gt; parent.addView(view) &#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用AsyncLayoutInflater的缺点"><a href="#使用AsyncLayoutInflater的缺点" class="headerlink" title="使用AsyncLayoutInflater的缺点"></a>使用AsyncLayoutInflater的缺点</h2><p>当然它有如下一些缺点：</p>
<ul>
<li><p>parent的 <code>generateLayoutParams()</code> 函数必须是线程安全的。</p>
</li>
<li><p>所有正在构建的views一定不能创建任何 <code>Handlers</code> 或者调用 <code>Looper.myLooper</code> 函数。</p>
</li>
<li><p>不支持设置<code>LayoutInflater.Factory</code>也不支持<code>LayoutInflater.Factory2</code></p>
</li>
<li><p>不支持包含Fragments的inflating layouts</p>
</li>
</ul>
<p>如果我们尝试异步的方式去inflate的layout不支持这种方式，那么inflation处理将会自动回退到主线程中。</p>
<h2 id="使用Kotlin-Android-Extensions-的-Kotlin的小例子"><a href="#使用Kotlin-Android-Extensions-的-Kotlin的小例子" class="headerlink" title="使用Kotlin Android Extensions 的 Kotlin的小例子"></a>使用Kotlin Android Extensions 的 Kotlin的小例子</h2><p>MainActivity</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">        loadFirst.setOnClickListener &#123; </span><br><span class="line">           loadAsync(R.layout.async) &#123; </span><br><span class="line">             second.text = <span class="string">"I am second TextView"</span> </span><br><span class="line">           &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> MainActivity.<span class="title">loadAsync</span><span class="params">(<span class="meta">@LayoutRes</span> res: <span class="type">Int</span>, </span></span></span><br><span class="line"><span class="function"><span class="params">                           action: <span class="type">View</span>.()</span></span> -&gt; <span class="built_in">Unit</span>) =</span><br><span class="line">    AsyncLayoutInflater(<span class="keyword">this</span>).inflate(res, frame) </span><br><span class="line">    &#123; view, resid, parent -&gt;</span><br><span class="line">        with(parent) &#123;</span><br><span class="line">            addView(view)</span><br><span class="line">            action(view)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>activity_main.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/frame"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:padding</span>=<span class="string">"@dimen/activity_vertical_margin"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">"com.cartoon.player.MainActivity"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/loadFirst"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"48dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginBottom</span>=<span class="string">"16dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"Load f async"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>async.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/first"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginBottom</span>=<span class="string">"16dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"1"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/second"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginBottom</span>=<span class="string">"16dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"2"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/08/29/HTTP协议详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/29/HTTP协议详解/" itemprop="url">HTTP协议详解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-29T14:13:00+08:00">
                2016-08-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/29/HTTP协议详解/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/08/29/HTTP协议详解/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div id="editor-reader-full" class="editor-reader-full-shown"><br><div class="reader-full-topInfo-shown">来自:&nbsp;<a href="https://www.zybuluo.com/yangfch3/note/167490" target="_blank" rel="noopener">https://www.zybuluo.com/yangfch3/note/167490</a></div><br><div class="reader-full-topInfo-shown">&nbsp;</div><br><div id="reader-full-topInfo" class="reader-full-topInfo-shown">HTTP协议详解</div><br><div id="wmd-preview" class="wmd-preview wmd-preview-full-reader" data-medium-element="true"><br><br><code>http</code><br><br><em> </em> *<br><br><div class="md-section-divider">&nbsp;</div>

<h3 id="http？"><a href="#http？" class="headerlink" title="http？"></a><code>http</code>？</h3><ul>
<li>全称：超文本传输协议<code>(HyperText Transfer Protocol)</code></li>
<li>作用：设计之初是为了将超文本标记语言<code>(HTML)</code>文档从Web服务器传送到客户端的浏览器。现在<code>http</code>的作用已不局限于<code>HTML</code>的传输。</li>
<li>版本：<code>http/1.0</code>&nbsp;<code>http/1.1*</code>&nbsp;<code>http/2.0</code></li>
</ul>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="两篇佳文"><a href="#两篇佳文" class="headerlink" title="两篇佳文"></a>两篇佳文</h3><p><a href="https://www.zybuluo.com/yangfch3/note/113028" target="_blank" rel="noopener">输入网址之后发生了什么</a>&nbsp;<br><a href="http://rapheal.sinaapp.com/" target="_blank" rel="noopener">Web开发新人培训系列</a></p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="URL详解"><a href="#URL详解" class="headerlink" title="URL详解"></a>URL详解</h3><p>一个示例URL</p>
<pre><code>http://www.mywebsite.com/sj/test;id=8079?name=sviergn&amp;amp;x=true#stuff

Schema: http
host: www.mywebsite.com
path: /sj/test
URL params: id=8079
Query String: name=sviergn&amp;amp;x=true
Anchor: stuff
</code></pre><ul>
<li><code>scheme</code>：指定低层使用的协议(例如：<code>http</code>,&nbsp;<code>https</code>,&nbsp;<code>ftp</code>)</li>
<li><code>host</code>：<code>HTTP</code>服务器的<code>IP</code>地址或者域名</li>
<li><code>port#</code>：<code>HTTP</code>服务器的默认端口是<code>80</code>，这种情况下端口号可以省略。如果使用了别的端口，必须指明，例如<code>http://www.mywebsite.com:8080/</code></li>
<li><code>path</code>：访问资源的路径</li>
<li><code>url-params</code></li>
<li><code>query-string</code>：发送给<code>http</code>服务器的数据</li>
<li><code>anchor</code>：锚</li>
</ul>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="无状态的协议"><a href="#无状态的协议" class="headerlink" title="无状态的协议"></a>无状态的协议</h3><p><code>http</code>协议是无状态的：</p>
<blockquote>
<p>同一个客户端的这次请求和上次请求是没有对应关系，对http服务器来说，它并不知道这两个请求来自同一个客户端。</p>
</blockquote>
<p>解决方法：<code>Cookie</code>机制来维护状态</p>
<p>既然Http协议是无状态的，那么<code>Connection:keep-alive</code>&nbsp;又是怎样一回事？</p>
<blockquote>
<p>无状态是指协议对于事务处理没有记忆能力，服务器不知道客户端是什么状态。从另一方面讲，打开一个服务器上的网页和你之前打开这个服务器上的网页之间没有任何联系。</p>
</blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="http消息结构"><a href="#http消息结构" class="headerlink" title="http消息结构"></a><code>http</code>消息结构</h3><ol>
<li><code>Request</code>&nbsp;消息的结构：三部分</li>
</ol>
<blockquote>
<p>第一部分叫<code>Request line</code>（请求行）， 第二部分叫<code>http header</code>, 第三部分是<code>body</code></p>
<pre><code>*   请求行：包括`http`请求的种类，请求资源的路径，`http`协议版本
*   `http header`：`http`头部信息
*   `body`：发送给服务器的`query`信息&amp;nbsp;
</code></pre><p>当使用的是”<code>GET</code>“ 方法的时候，<code>body</code>是为空的（<code>GET</code>只能读取服务器上的信息，<code>post</code>能写入）&nbsp;</p>
<pre><code>    1.  `&lt;span class=&quot;pln&quot;&gt;GET &lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;pln&quot;&gt;hope&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;pln&quot;&gt; HTTP&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;1.1&lt;span class=&quot;pln&quot;&gt;   &lt;span class=&quot;com&quot;&gt;//---请求行&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
2.  `&lt;span class=&quot;typ&quot;&gt;Host&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; ce&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;sysu&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;edu&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;cn&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
3.  `&lt;span class=&quot;typ&quot;&gt;Accept&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;pun&quot;&gt;*&lt;span class=&quot;com&quot;&gt;/*&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
4.  `&lt;span class=&quot;com&quot;&gt;Accept-Encoding: gzip, deflate, sdch&lt;/span&gt;`
5.  `&lt;span class=&quot;com&quot;&gt;Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.6&lt;/span&gt;`
6.  `&lt;span class=&quot;com&quot;&gt;Cache-Control: max-age=0&lt;/span&gt;`
7.  `&lt;span class=&quot;com&quot;&gt;Cookie:.........&lt;/span&gt;`
8.  `&lt;span class=&quot;com&quot;&gt;Referer: http://ce.sysu.edu.cn/hope/&lt;/span&gt;`
9.  `&lt;span class=&quot;com&quot;&gt;User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.130 Safari/537.36&lt;/span&gt;`
</code></pre><p>10.11.  <code>&lt;span class=&quot;com&quot;&gt;---分割线---&lt;/span&gt;</code><br>12.13.  <code>&lt;span class=&quot;com&quot;&gt;POST /hope/ HTTP/1.1   //---请求行&lt;/span&gt;</code></p>
<pre><code>14.  `&lt;span class=&quot;com&quot;&gt;Host: ce.sysu.edu.cn&lt;/span&gt;`
15.  `&lt;span class=&quot;com&quot;&gt;Accept: */&lt;span class=&quot;pun&quot;&gt;*&lt;/span&gt;&lt;/span&gt;`
16.  `&lt;span class=&quot;typ&quot;&gt;Accept&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Encoding&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; gzip&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt; deflate&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt; sdch&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
17.  `&lt;span class=&quot;typ&quot;&gt;Accept&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Language&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; zh&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;pln&quot;&gt;CN&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt;zh&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt;q&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;lit&quot;&gt;0.8&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt;zh&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;pln&quot;&gt;TW&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt;q&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;lit&quot;&gt;0.6&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
18.  `&lt;span class=&quot;typ&quot;&gt;Cache&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Control&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; max&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;pln&quot;&gt;age&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;lit&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
19.  `&lt;span class=&quot;typ&quot;&gt;Cookie&lt;span class=&quot;pun&quot;&gt;:.........&lt;/span&gt;&lt;/span&gt;`
20.  `&lt;span class=&quot;typ&quot;&gt;Referer&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; http&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;com&quot;&gt;//ce.sysu.edu.cn/hope/&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
21.  `&lt;span class=&quot;typ&quot;&gt;User&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Agent&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Mozilla&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;5.0&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;pun&quot;&gt;(&lt;span class=&quot;typ&quot;&gt;Windows&lt;span class=&quot;pln&quot;&gt; NT &lt;span class=&quot;lit&quot;&gt;10.0&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt; WOW64&lt;span class=&quot;pun&quot;&gt;)&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;AppleWebKit&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;537.36&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;pun&quot;&gt;(&lt;span class=&quot;pln&quot;&gt;KHTML&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt; like &lt;span class=&quot;typ&quot;&gt;Gecko&lt;span class=&quot;pun&quot;&gt;)&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Chrome&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;44.0&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;lit&quot;&gt;2403.130&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Safari&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;537.36&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
</code></pre><p>22.23.  <code>&lt;span class=&quot;pun&quot;&gt;...&lt;span class=&quot;pln&quot;&gt;body&lt;span class=&quot;pun&quot;&gt;...&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;</code></p>
</blockquote>
<ol>
<li>Response消息的结构</li>
</ol>
<blockquote>
<p>也分为三部分，第一部分叫request line, 第二部分叫request header，第三部分是body</p>
<pre><code>*   `request line`：协议版本、状态码、`message`
*   `request header`：`request`头信息
*   `body`：返回的请求资源主体&amp;nbsp;

    1.  `&lt;span class=&quot;pln&quot;&gt;HTTP&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;1.1&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;200&lt;span class=&quot;pln&quot;&gt; OK&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    2.  `&lt;span class=&quot;typ&quot;&gt;Accept&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Ranges&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; bytes&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    3.  `&lt;span class=&quot;typ&quot;&gt;Content&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Encoding&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; gzip&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    4.  `&lt;span class=&quot;typ&quot;&gt;Content&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Length&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;4533&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    5.  `&lt;span class=&quot;typ&quot;&gt;Content&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Type&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; text&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;pln&quot;&gt;html&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    6.  `&lt;span class=&quot;typ&quot;&gt;Date&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Sun&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;06&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Sep&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;2015&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;07&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;lit&quot;&gt;56&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;lit&quot;&gt;07&lt;span class=&quot;pln&quot;&gt; GMT&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    7.  `&lt;span class=&quot;typ&quot;&gt;ETag&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;str&quot;&gt;&quot;2788e6e716e7d01:0&quot;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    8.  `&lt;span class=&quot;typ&quot;&gt;Last&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Modified&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Fri&lt;span class=&quot;pun&quot;&gt;,&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;04&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Sep&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;2015&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;lit&quot;&gt;13&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;lit&quot;&gt;37&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;lit&quot;&gt;55&lt;span class=&quot;pln&quot;&gt; GMT&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    9.  `&lt;span class=&quot;typ&quot;&gt;Server&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Microsoft&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;pln&quot;&gt;IIS&lt;span class=&quot;pun&quot;&gt;/&lt;span class=&quot;lit&quot;&gt;7.5&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    10.  `&lt;span class=&quot;typ&quot;&gt;Vary&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; &lt;span class=&quot;typ&quot;&gt;Accept&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Encoding&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
    11.  `&lt;span class=&quot;pln&quot;&gt;X&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;Powered&lt;span class=&quot;pun&quot;&gt;-&lt;span class=&quot;typ&quot;&gt;By&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; ASP&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;NET&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
</code></pre><p>12.13.  <code>&lt;span class=&quot;pun&quot;&gt;&amp;lt;!&lt;span class=&quot;pln&quot;&gt;DOCTYPE html&lt;span class=&quot;pun&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;</code></p>
<pre><code>14.  `&lt;span class=&quot;pun&quot;&gt;...&lt;/span&gt;`
15.  `&lt;span class=&quot;pun&quot;&gt;&amp;lt;&amp;gt;&lt;/span&gt;`
16.  `&lt;span class=&quot;pun&quot;&gt;...&lt;/span&gt;`
</code></pre></blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="get-nbsp-和-nbsp-post-nbsp-区别"><a href="#get-nbsp-和-nbsp-post-nbsp-区别" class="headerlink" title="get&nbsp;和&nbsp;post&nbsp;区别"></a><code>get</code>&nbsp;和&nbsp;<code>post</code>&nbsp;区别</h3><p><code>http</code>协议定义了很多与服务器交互的方法，最基本的有4种，分别是<code>GET</code>,<code>POST</code>,<code>PUT</code>,<code>DELETE</code>。 一个<code>URL</code>地址用于描述一个网络上的资源，而<code>HTTP</code>中的<code>GET</code>,&nbsp;<code>POST</code>,&nbsp;<code>PUT</code>,&nbsp;<code>DELETE</code>&nbsp;就对应着对这个资源的查，改，增，删4个操作。 我们最常见的就是<code>GET</code>和<code>POST</code>了。<code>GET</code>一般用于获取/查询资源信息，而POST一般用于更新资源信息.</p>
<ol>
<li><p><code>GET</code>&nbsp;提交的数据会放在<code>URL</code>之后，以<code>?</code>分割<code>URL</code>和传输数据，参数之间以<code>&amp;amp;</code>相连，如<code>EditPosts.aspx?name=test1&amp;amp;id=123456</code>。<code>POST</code>&nbsp;方法是把提交的数据放在<code>HTTP</code>包的<code>Body</code>中。</p>
</li>
<li><p><code>GET</code>&nbsp;提交的数据大小有限制（因为浏览器对<code>URL</code>的长度有限制），而<code>POST</code>方法提交的数据没有限制.</p>
</li>
<li><p><code>GET</code>&nbsp;方式需要使用<code>Request.QueryString</code>&nbsp;来取得变量的值，而<code>POST</code>方式通过<code>Request.Form</code>来获取变量的值。</p>
</li>
<li><p><code>GET</code>&nbsp;方式提交数据，会带来安全问题，比如一个登录页面，通过<code>GET</code>方式提交数据时，用户名和密码将出现在<code>URL</code>上，如果页面可以被缓存或者其他人可以访问这台机器，就可以从历史记录获得该用户的账号和密码.&nbsp;</p>
<p><a href="https://www.zybuluo.com/yangfch3/note/123476" target="_blank" rel="noopener">HTTP请求的Get与Post</a></p>
</li>
</ol>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h3><p><code>Response</code>&nbsp;消息中的第一行叫做状态行，由<code>HTTP</code>协议版本号，&nbsp;状态码，&nbsp;状态消息&nbsp;三部分组成。</p>
<p>状态码用来告诉<code>HTTP</code>客户端，<code>HTTP</code>服务器是否产生了预期的<code>Response</code>.</p>
<p><code>HTTP/1.1</code>中定义了 5 类状态码。</p>
<p>状态码由三位数字组成，第一个数字定义了响应的类别</p>
<ul>
<li><code>1XX</code>&nbsp;提示信息 - 表示请求已被成功接收，继续处理</li>
<li><code>2XX</code>&nbsp;成功 - 表示请求已被成功接收，理解，接受</li>
<li><code>3XX</code>&nbsp;重定向 - 要完成请求必须进行更进一步的处理</li>
<li><code>4XX</code>&nbsp;客户端错误 - 请求有语法错误或请求无法实现</li>
<li><p><code>5XX</code>&nbsp;服务器端错误 - 服务器未能实现合法的请求</p>
<ol>
<li><code>200 OK</code>&nbsp;<br>请求被成功地完成，所请求的资源发送回客户端</li>
<li><code>302 Found</code>&nbsp;<br>重定向，新的<code>URL</code>会在<code>response</code>中的<code>Location</code>中返回，浏览器将会使用新的<code>URL</code>发出新的<code>Request</code></li>
<li><code>304 Not Modified</code>&nbsp;<br>文档已经被缓存，直接从缓存调用</li>
<li><code>400 Bad Request</code>&nbsp;<br>客户端请求与语法错误，不能被服务器所理解&nbsp;<br><code>403 Forbidden</code>&nbsp;<br>服务器收到请求，但是拒绝提供服务&nbsp;<br><code>404 Not Found</code>&nbsp;<br>请求资源不存在</li>
<li><code>500 Internal Server Error</code>&nbsp;<br>服务器发生了不可预期的错误&nbsp;<br><code>503 Server Unavailable</code>&nbsp;<br>服务器当前不能处理客户端的请求，一段时间后可能恢复正常</li>
</ol>
</li>
</ul>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="http-reauest-header"><a href="#http-reauest-header" class="headerlink" title="http reauest header"></a>http reauest header</h3><p><code>http</code>&nbsp;请求头包括很多键值对，这些键值对有什么意义与作用？如何根据功能为他们分一下组呢？</p>
<ol>
<li><p><code>cache</code>&nbsp;头域</p>
<ul>
<li><code>If-Modified-Since</code>&nbsp;<br>用法：<code>If-Modified-Since: Thu, 09 Feb 2012 09:07:57 GMT</code></li>
</ul>
<p>把浏览器端缓存页面的最后修改时间发送到服务器去，服务器会把这个时间与服务器上实际文件的最后修改时间进行对比。如果时间一致，那么返回304，客户端就直接使用本地缓存文件。如果时间不一致，就会返回200和新的文件内容。客户端接到之后，会丢弃旧文件，把新文件缓存起来，并显示在浏览器中。&nbsp;</p>
<pre><code>*   `If-None-Match`&amp;nbsp;
</code></pre><p>用法：<code>If-None-Match: &quot;03f2b33c0bfcc1:0&quot;</code></p>
<p><code>If-None-Match</code>和<code>ETag</code>一起工作，工作原理是在<code>HTTP Response</code>中添加<code>ETag</code>信息。 当用户再次请求该资源时，将在<code>HTTP Request</code>&nbsp;中加入<code>If-None-Match</code>信息(<code>ETag</code>的值)。如果服务器验证资源的<code>ETag</code>没有改变（该资源没有更新），将返回一个<code>304</code>状态告诉客户端使用本地缓存文件。否则将返回<code>200</code>状态和新的资源和<code>Etag</code>. 使用这样的机制将提高网站的性能&nbsp;</p>
<pre><code>*   `Pragma`：`Pragma: no-cache`&amp;nbsp;
</code></pre><p><code>Pargma</code>只有一个用法， 例如：&nbsp;<code>Pragma: no-cache</code></p>
<p>作用： 防止页面被缓存， 在<code>HTTP/1.1</code>版本中，它和<code>Cache-Control:no-cache</code>作用一模一样&nbsp;</p>
<pre><code>*   `Cache-Control`&amp;nbsp;
</code></pre><p>用法：</p>
<pre><code>    *   `Cache-Control:Public`&amp;nbsp;可以被任何缓存所缓存（）
*   `Cache-Control:Private`&amp;nbsp;内容只缓存到私有缓存中
*   `Cache-Control:no-cache`&amp;nbsp;所有内容都不会被缓存
</code></pre><p>作用：用来指定<code>Response-Request</code>遵循的缓存机制</p>
</li>
<li><p><code>Client</code>&nbsp;头域</p>
<ul>
<li><code>Accept</code>&nbsp;<br>用法：<code>Accept: */*</code>，<code>Accept: text/html</code></li>
</ul>
<p>作用： 浏览器端可以接受的媒体类型；&nbsp;<br><code>Accept: */*</code>&nbsp;代表浏览器可以处理所有回发的类型，(一般浏览器发给服务器都是发这个）&nbsp;<br><code>Accept: text/html</code>&nbsp;代表浏览器可以接受服务器回发的类型为&nbsp;<code>text/html</code>&nbsp;；如果服务器无法返回<code>text/html</code>类型的数据，服务器应该返回一个<code>406</code>错误(<code>non acceptable</code>)&nbsp;</p>
<pre><code>*   `Accept-Encoding`&amp;nbsp;
</code></pre><p>用法：<code>Accept-Encoding: gzip, deflate</code></p>
<p>作用： 浏览器申明自己接收的文件编码方法，通常指定压缩方法，是否支持压缩，支持什么压缩方法（<code>gzip</code>，<code>deflate</code>），（注意：这不是指字符编码）&nbsp;</p>
<pre><code>*   `Accept-Language`&amp;nbsp;
</code></pre><p>用法：<code>Accept-Language: en-us</code></p>
<p>作用： 浏览器申明自己接收的语言。&nbsp;</p>
<pre><code>语言跟字符集的区别：中文是语言，中文有多种字符集，比如`big5`，`gb2312`，`gbk`等等；&amp;nbsp;

*   `User-Agent`&amp;nbsp;
</code></pre><p>用法：&nbsp;<code>User-Agent: Mozilla/4.0......</code></p>
<p>作用：告诉<code>HTTP</code>服务器， 客户端使用的操作系统和浏览器的名称和版本.&nbsp;</p>
<pre><code>*   `Accept-Charset`&amp;nbsp;
</code></pre><p>用法：<code>Accept-Charset：utf-8</code></p>
<p>作用：浏览器申明自己接收的字符集，这就是本文前面介绍的各种字符集和字符编码，如gb2312，utf-8（通常我们说Charset包括了相应的字符编码方案）&nbsp;</p>
</li>
<li><p><code>Cookie/Login</code>&nbsp;头域</p>
<ul>
<li><p><code>Cookie</code></p>
<pre><code>1.  `&lt;span class=&quot;typ&quot;&gt;Cookie&lt;span class=&quot;pun&quot;&gt;:&lt;span class=&quot;pln&quot;&gt; bdshare_firstime&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;lit&quot;&gt;1439081296143&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt; ASP&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;NET_SessionId&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;pln&quot;&gt;rcqayd4ufldcke0wkbm1vhxb&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt; pgv_pvi&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;lit&quot;&gt;7361416192&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt; pgv_si&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;pln&quot;&gt;s6686106624&lt;span class=&quot;pun&quot;&gt;;&lt;span class=&quot;pln&quot;&gt; ce&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;sysu&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;edu&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;cn80&lt;span class=&quot;pun&quot;&gt;.&lt;span class=&quot;pln&quot;&gt;ASPXAUTH&lt;span class=&quot;pun&quot;&gt;=&lt;span class=&quot;lit&quot;&gt;9E099592DD5A414BEECD8CF43CFC71664&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;`
</code></pre></li>
</ul>
<p>作用：&nbsp;最重要的header, 将<code>cookie</code>的值发送给<code>HTTP</code>&nbsp;服务器</p>
</li>
<li><p><code>Entity</code>&nbsp;头域</p>
<ul>
<li><code>Content-Length</code>&nbsp;<br>用法：<code>Content-Length: 38</code></li>
</ul>
<p>作用：发送给HTTP服务器数据的长度。&nbsp;</p>
<pre><code>*   `Content-Type`&amp;nbsp;
</code></pre><p>用法：<code>Content-Type: application/x-www-form-urlencoded</code></p>
<p>不常出现，一般出现在<code>response</code>头部，用于指定数据文件类型&nbsp;</p>
</li>
<li><p><code>Miscellaneous</code>&nbsp;头域</p>
<ul>
<li><code>Referer</code>&nbsp;<br>用法：<code>Referer: http://ce.sysu.edu.cn/hope/</code></li>
</ul>
<p>作用：提供了<code>Request</code>的上下文信息的服务器，告诉服务器我是从哪个链接过来的，比如从我主页上链接到一个朋友那里，他的服务器就能够从<code>HTTP Referer</code>中统计出每天有多少用户点击我主页上的链接访问他的网站。&nbsp;</p>
</li>
<li><p><code>Transport</code>&nbsp;头域</p>
<ul>
<li><code>Connection</code>&nbsp;<br><code>Connection: keep-alive</code>： 当一个网页打开完成后，客户端和服务器之间用于传输HTTP数据的TCP连接不会关闭，如果客户端再次访问这个服务器上的网页，会继续使用这一条已经建立的连接</li>
</ul>
<p><code>Connection: close</code>： 代表一个<code>Request</code>完成后，客户端和服务器之间用于传输<code>HTTP</code>数据的<code>TCP</code>连接会关闭， 当客户端再次发送<code>Request</code>，需要重新建立<code>TCP</code>连接&nbsp;</p>
<pre><code>*   `Host`&amp;nbsp;
</code></pre><p>用法：<code>Host: ce.sysu.edu.cn</code></p>
<p>作用: 请求报头域主要用于指定被请求资源的<code>Internet</code>主机和端口号（默认80），它通常从<code>HTTP URL</code>中提取出来的</p>
<div class="md-section-divider">&nbsp;</div>

</li>
</ol>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="HTTP-Response-header"><a href="#HTTP-Response-header" class="headerlink" title="HTTP Response header"></a>HTTP Response header</h3><ol>
<li><p><code>Cache</code>&nbsp;头域</p>
<ul>
<li><code>Date</code>&nbsp;<br>用法：<code>Date: Sat, 11 Feb 2012 11:35:14 GMT</code></li>
</ul>
<p>作用: 生成消息的具体时间和日期&nbsp;</p>
<pre><code>*   `Expires`&amp;nbsp;
</code></pre><p>用法：<code>Expires: Tue, 08 Feb 2022 11:35:14 GMT</code>&nbsp;<br>作用: 浏览器会在指定过期时间内使用本地缓存&nbsp;</p>
<pre><code>*   `Vary`&amp;nbsp;
</code></pre><p>用法：Vary: Accept-Encoding&nbsp;</p>
</li>
<li><p><code>Cookie/Login</code>&nbsp;头域</p>
<ul>
<li><code>P3P</code>&nbsp;<br>用法：&nbsp;<br><code>P3P: CP=CURa ADMa DEVa PSAo PSDo OUR BUS UNI PUR INT DEM STA PRE COM NAV OTC NOI DSP COR</code></li>
</ul>
<p>作用: 用于跨域设置Cookie, 这样可以解决<code>iframe</code>跨域访问<code>cookie</code>的问题&nbsp;</p>
<pre><code>*   `Set-Cookie`&amp;nbsp;
</code></pre><p>用法：&nbsp;<br><code>Set-Cookie: sc=4c31523a; path=/; domain=.acookie.taobao.com</code></p>
<p>作用：非常重要的<code>header</code>, 用于把<code>cookie</code>&nbsp;发送到客户端浏览器， 每一个写入<code>cookie</code>都会生成一个<code>Set-Cookie</code>.</p>
</li>
<li><p><code>Entity</code>&nbsp;头域</p>
<ul>
<li><code>ETag</code>&nbsp;<br>用法：<code>ETag: &quot;03f2b33c0bfcc1:0&quot;</code></li>
</ul>
<p>作用: 和<code>request header</code>的<code>If-None-Match</code>&nbsp;配合使用&nbsp;</p>
<pre><code>*   `Last-Modified`&amp;nbsp;
</code></pre><p>用法：<code>Last-Modified: Wed, 21 Dec 2011 09:09:10 GMT</code></p>
<p>作用：用于指示资源的最后修改日期和时间。（实例请看上节的<code>If-Modified-Since</code>的实例）&nbsp;</p>
<pre><code>*   `Content-Type`&amp;nbsp;
</code></pre><p>用法：</p>
<pre><code>    *   Content-Type: text/html; charset=utf-8
*   Content-Type:text/html;charset=GB2312
*   Content-Type: image/jpeg
</code></pre><p>作用：WEB服务器告诉浏览器自己响应的对象的类型和字符集&nbsp;</p>
<pre><code>*   Content-Encoding&amp;nbsp;
</code></pre><p>用法：<code>Content-Encoding：gzip</code></p>
<p>作用：WEB服务器表明自己使用了什么压缩方法（<code>gzip</code>，<code>deflate</code>）压缩响应中的对象。&nbsp;</p>
<pre><code>*   `Content-Language`&amp;nbsp;
</code></pre><p>用法：&nbsp;<code>Content-Language:da</code></p>
<p>WEB服务器告诉浏览器自己响应的对象的语言</p>
</li>
<li><p><code>Miscellaneous</code>&nbsp;头域</p>
<ul>
<li><code>Server</code>&nbsp;<br>用法：<code>Server: Microsoft-IIS/7.5</code></li>
</ul>
<p>作用：指明HTTP服务器的软件信息&nbsp;</p>
<pre><code>*   `X-AspNet-Version`&amp;nbsp;
</code></pre><p>用法：<code>X-AspNet-Version: 4.0.30319</code></p>
<p>作用：如果网站是用<code>ASP.NET</code>开发的，这个<code>header</code>用来表示<code>ASP.NET</code>的版本&nbsp;</p>
<pre><code>*   X-Powered-By&amp;nbsp;
</code></pre><p>用法：<code>X-Powered-By: ASP.NET</code></p>
<p>作用：表示网站是用什么技术开发的&nbsp;</p>
</li>
<li><p><code>Transport</code>头域</p>
<ul>
<li><p><code>Connection</code>&nbsp;<br>用法与作用：&nbsp;</p>
<pre><code>*   `Connection: keep-alive`：当一个网页打开完成后，客户端和服务器之间用于传输HTTP数据的TCP连接不会关闭，如果客户端再次访问这个服务器上的网页，会继续使用这一条已经建立的连接
</code></pre><ul>
<li><code>Connection: close</code>：代表一个Request完成后，客户端和服务器之间用于传输HTTP数据的TCP连接会关闭， 当客户端再次发送Request，需要重新建立TCP连接</li>
</ul>
</li>
</ul>
</li>
<li><p>Location头域</p>
<ul>
<li>Location&nbsp;<br>用法：<code>Location：http://ce.sysu.edu.cn/hope/</code>&nbsp;<br>作用： 用于重定向一个新的位置， 包含新的<code>URL</code>地址</li></ul></li></ol></div><div class="remark-icons"><br><div class="remark-icon unselectable remark-icon-empty" data-anchor-id="1xa3"><span class="icon-stack"><span class="glyph-comment"><span class="remark-count">+</span></span></span></div>





<p></p></div><p></p>
<p></p></div><p></p>
<div class="in-page-preview-buttons in-page-preview-buttons-full-reader">&nbsp;</div><br><div id="reader-full-toolbar" class="reader-full-toolbar-shown">&nbsp;</div>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/08/29/网络基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/29/网络基础/" itemprop="url">网络基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-29T14:10:00+08:00">
                2016-08-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/29/网络基础/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/08/29/网络基础/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <div id="editor-reader-full" class="editor-reader-full-shown"><br><div class="reader-full-topInfo-shown"><span style="font-size: 14px; font-family: verdana, Arial, Helvetica, sans-serif; line-height: 1.5;">来自：<a href="https://www.zybuluo.com/yangfch3/note/140188" target="_blank" rel="noopener">https://www.zybuluo.com/yangfch3/note/140188</a></span></div><br><div class="reader-full-topInfo-shown">&nbsp;</div><br><div id="reader-full-topInfo" class="reader-full-topInfo-shown"><code>&lt;span style=&quot;font-size: 2em; font-family: verdana, Arial, Helvetica, sans-serif; line-height: 1.5;&quot;&gt;网络基础&lt;/span&gt;</code></div><br><div id="wmd-preview" class="wmd-preview wmd-preview-full-reader" data-medium-element="true"><br><br><em> </em> *<br><br><div class="md-section-divider">&nbsp;</div>

<h2 id="一次完整的HTTP请求"><a href="#一次完整的HTTP请求" class="headerlink" title="一次完整的HTTP请求"></a>一次完整的HTTP请求</h2><ol>
<li>域名DNS解析，获取对方IP，运算判断是否同一子网&nbsp;<br>hosts –&gt; DNS缓存 –&gt; DNS递归</li>
<li>发起TCP的3次握手，建立TCP连接&nbsp;<br>构建连接请求报文，封装成数据包，路由、ARP到达（不在同一子网时路由+ARP，在同一子网时ARP）</li>
<li>发起http请求&nbsp;<br>构建 HTTP/TCP/IP数据包，路由、ARP到达（同上）</li>
<li>服务器响应http请求，返回数据包&nbsp;<br>构建 HTTP/TCP/IP数据包，路由、ARP到达（同上）</li>
<li>浏览器得到html代码</li>
<li>浏览器解析html代码并再次发起HTTP请求，请求html代码中的资源（如js、css、图片等</li>
<li>浏览器对页面进行渲染呈现给用户</li>
<li>发起TCP四次分手</li>
<li>断开连接</li>
</ol>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h2 id="从握手到分手"><a href="#从握手到分手" class="headerlink" title="从握手到分手"></a>从握手到分手</h2><hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h3><p>三次握手：建立连接前的&nbsp;<code>B/S</code>&nbsp;或&nbsp;<code>C/S</code>&nbsp;交流</p>
<blockquote>
<p>第一次握手：建立连接。客户端发送连接请求报文段，将<code>SYN</code>位置为<code>1</code>，<code>Sequence Number</code>为<code>&#39;xxx&#39;</code>；然后，客户端进入<code>SYN_SEND</code>状态，等待服务器的确认；</p>
<p>第二次握手：服务器收到<code>SYN</code>报文段。服务器收到客户端的<code>SYN</code>报文段，需要对这个<code>SYN</code>报文段进行确认，设置<code>Acknowledgment Number</code>为<code>xxx+1</code>(<code>Sequence Number</code>+1)；同时，自己自己还要发送<code>SYN</code>请求信息，将<code>SYN</code>位置为<code>1</code>，<code>Sequence Number</code>为<code>&#39;yyy&#39;</code>；服务器端将上述所有信息放到一个报文段（即SYN+ACK报文段）中，一并发送给客户端，此时服务器进入<code>SYN_RECV</code>状态；</p>
<p>第三次握手：客户端收到服务器的<code>SYN+ACK</code>报文段。然后将<code>Acknowledgment Number</code>设置为<code>yyy+1</code>(服务器<code>Sequence Number</code>+1)，向服务器发送<code>ACK</code>报文段，这个报文段发送完毕以后，客户端和服务器端都进入<code>ESTABLISHED</code>状态，完成<code>TCP</code>三次握手。连接建立成功。</p>
<p>完成三次握手，主机A与主机B开始传送数据。</p>
</blockquote>
<p>实例:</p>
<blockquote>
<p>IP 192.168.1.116.3337 &gt; 192.168.1.123.7788: S 3626544836:3626544836&nbsp;<br>IP 192.168.1.123.7788 &gt; 192.168.1.116.3337: S 1739326486:1739326486 ack 3626544837&nbsp;<br>IP 192.168.1.116.3337 &gt; 192.168.1.123.7788: ack 1739326487,ack 1</p>
<p>第一次握手：192.168.1.116发送位码<code>SYN</code>＝1,随机产生<code>Sequence number</code>=3626544836的数据包到192.168.1.123,192.168.1.123由<code>SYN</code>=1知道192.168.1.116要求建立联机;</p>
<p>第二次握手：192.168.1.123收到请求后要确认联机信息，向192.168.1.116发送<code>Acknowledgment Number</code>=3626544837,<code>SYN</code>=1,<code>ACK</code>=1,随机产生<code>Sequence Number</code>=1739326486的包;</p>
<p>第三次握手：192.168.1.116收到后检查<code>Acknowledgment Number</code>是否正确，即第一次发送的<code>Sequence Number+1</code>,以及位码<code>ACK</code>是否为1，若正确，192.168.1.116会再发送<code>Acknowledgment Number</code>=1739326487,<code>ACK</code>=1，192.168.1.123收到后确认<code>Sequence Number=Sequence Number+1</code>,<code>ACK</code>=1则连接建立成功。</p>
</blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="四次分手"><a href="#四次分手" class="headerlink" title="四次分手"></a>四次分手</h3><p>当客户端和服务器通过三次握手建立了TCP连接以后，当数据传送完毕，肯定是要断开TCP连接的啊。那对于TCP的断开连接，这里就有了神秘的&ldquo;四次分手&rdquo;。</p>
<blockquote>
<p>第一次分手：主机1（可以是客户端，也可以是服务器端），设置<code>Sequence Number</code>和<code>Acknowledgment Number</code>，向主机2发送一个<code>FIN</code>报文段；此时，主机1进入<code>FIN_WAIT_1</code>状态；这表示主机1没有数据要发送给主机2了；</p>
<p>第二次分手：主机2收到了主机1发送的<code>FIN</code>报文段，向主机1回一个<code>ACK</code>报文段，<code>Acknowledgment Number</code>为<code>Sequence Number</code>加1；主机1进入<code>FIN_WAIT_2</code>状态；主机2告诉主机1，我也没有数据要发送了，可以进行关闭连接了；</p>
<p>第三次分手：主机2向主机1发送<code>FIN</code>报文段，请求关闭连接，同时主机2进入<code>CLOSE_WAIT</code>状态；</p>
<p>第四次分手：主机1收到主机2发送的FIN报文段，向主机2发送<code>ACK</code>报文段，然后主机1进入<code>TIME_WAIT</code>状态；主机2收到主机1的<code>ACK</code>报文段以后，就关闭连接；此时，主机1等待<code>2MSL</code>后依然没有收到回复，则证明<code>Server</code>端已正常关闭，那好，主机1也可以关闭连接了。</p>
</blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="为什么要三次握手"><a href="#为什么要三次握手" class="headerlink" title="为什么要三次握手"></a>为什么要三次握手</h3><p>引自：谢希仁的《计算机网络》</p>
<blockquote>
<p>为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误。</p>
</blockquote>
<p>例子：</p>
<blockquote>
<p>&ldquo;已失效的连接请求报文段&rdquo;的产生在这样一种情况下：client发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间的滞留了，以致延误到连接释放以后的某个时间才到达server。本来这是一个早已失效的报文段。但server收到此失效的连接请求报文段后，就误认为是client再次发出的一个新的连接请求。于是就向client发出确认报文段，同意建立连接。假设不采用&ldquo;三次握手&rdquo;，那么只要server发出确认，新的连接就建立了。由于现在client并没有发出建立连接的请求，因此不会理睬server的确认，也不会向server发送数据。但server却以为新的运输连接已经建立，并一直等待client发来数据。这样，server的很多资源就白白浪费掉了。采用&ldquo;三次握手&rdquo;的办法可以防止上述现象发生。例如刚才那种情况，client不会向server的确认发出确认。server由于收不到确认，就知道client并没有要求建立连接。&rdquo;</p>
</blockquote>
<p>所以，三次握手的目的是：防止服务器端一直等待而浪费资源</p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="为什么要四次分手"><a href="#为什么要四次分手" class="headerlink" title="为什么要四次分手"></a>为什么要四次分手</h3><p>那四次分手又是为何呢？<code>TCP</code>协议是一种面向连接的、可靠的、基于字节流的运输层通信协议。<code>TCP</code>是全双工模式，这就意味着，当主机1发出<code>FIN</code>报文段时，只是表示主机1已经没有数据要发送了，主机1告诉主机2，它的数据已经全部发送完毕了；但是，这个时候主机1还是可以接受来自主机2的数据；当主机2返回<code>ACK</code>报文段时，表示它已经知道主机1没有数据发送了，但是主机2还是可以发送数据到主机1的；当主机2也发送了<code>FIN</code>报文段时，这个时候就表示主机2也没有数据要发送了，就会告诉主机1，我也没有数据要发送了，之后彼此就会愉快的中断这次<code>TCP</code>连接。如果要正确的理解四次分手的原理，就需要了解四次分手过程中的状态变化。</p>
<blockquote>
<ul>
<li><p><code>FIN_WAIT_1</code>: 这个状态要好好解释一下，其实<code>FIN_WAIT_1</code>和<code>FIN_WAIT_2</code>状态的真正含义都是表示等待对方的<code>FIN</code>报文。而这两种状态的区别是：<code>FIN_WAIT_1</code>状态实际上是当<code>SOCKET</code>在<code>ESTABLISHED</code>状态时，它想主动关闭连接，向对方发送了<code>FIN</code>报文，此时该<code>SOCKET</code>即进入到<code>FIN_WAIT_1</code>状态。而当对方回应<code>ACK</code>报文后，则进入到<code>FIN_WAIT_2</code>状态，当然在实际的正常情况下，无论对方何种情况下，都应该马上回应<code>ACK</code>报文，所以<code>FIN_WAIT_1</code>状态一般是比较难见到的，而<code>FIN_WAIT_2</code>状态还有时常常可以用<code>netstat</code>看到。（主动方）&nbsp;</p>
</li>
<li><p><code>FIN_WAIT_2</code>：上面已经详细解释了这种状态，实际上<code>FIN_WAIT_2</code>状态下的<code>SOCKET</code>，表示半连接，也即有一方要求<code>close</code>连接，但另外还告诉对方，我暂时还有点数据需要传送给你(<code>ACK</code>信息)，稍后再关闭连接。（主动方）&nbsp;</p>
</li>
<li><p><code>CLOSE_WAIT</code>：这种状态的含义其实是表示在等待关闭。怎么理解呢？当对方<code>close</code>一个<code>SOCKET</code>后发送<code>FIN</code>报文给自己，你系统毫无疑问地会回应一个<code>ACK</code>报文给对方，此时则进入到<code>CLOSE_WAIT</code>状态。接下来呢，实际上你真正需要考虑的事情是察看你是否还有数据发送给对方，如果没有的话，那么你也就可以&nbsp;<code>close</code>这个<code>SOCKET</code>，发送<code>FIN</code>报文给对方，也即关闭连接。所以你在<code>CLOSE_WAIT</code>状态下，需要完成的事情是等待你去关闭连接。（被动方）&nbsp;</p>
</li>
<li><p><code>LAST_ACK</code>: 这个状态还是比较容易好理解的，它是被动关闭一方在发送<code>FIN</code>报文后，最后等待对方的<code>ACK</code>报文。当收到<code>ACK</code>报文后，也即可以进入到<code>CLOSED</code>可用状态了。（被动方）&nbsp;</p>
</li>
<li><p><code>TIME_WAIT</code>: 表示收到了对方的<code>FIN</code>报文，并发送出了<code>ACK</code>报文，就等<code>2MSL</code>后即可回到<code>CLOSED</code>可用状态了。如果<code>FINWAIT1</code>状态下，收到了对方同时带<code>FIN</code>标志和<code>ACK</code>标志的报文时，可以直接进入到<code>TIME_WAIT</code>状态，而无须经过<code>FIN_WAIT_2</code>状态。（主动方）&nbsp;</p>
</li>
<li><p><code>CLOSED</code>: 表示连接中断。</p>
</li>
</ul>
</blockquote>
<p><a href="http://www.jellythink.com/archives/705" target="_blank" rel="noopener">简析TCP的三次握手与四次分手</a></p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h2 id="互联网协议入门（一）"><a href="#互联网协议入门（一）" class="headerlink" title="互联网协议入门（一）"></a>互联网协议入门（一）</h2><div class="md-section-divider">&nbsp;</div>

<h3 id="七层模型与五层模型"><a href="#七层模型与五层模型" class="headerlink" title="七层模型与五层模型"></a>七层模型与五层模型</h3><hr>
<div class="md-section-divider">&nbsp;</div>

<h4 id="七层模型"><a href="#七层模型" class="headerlink" title="七层模型"></a>七层模型</h4><p>七层模型，经典却不实用&nbsp;<br><img src="http://7xjv7y.com1.z0.glb.clouddn.com/OSI_seven.jpg" alt=""></p>
<p>各层的数据封装情况&nbsp;<br><img src="http://jellythink.u.qiniudn.com/jellythinkTCP1.jpg" alt=""></p>
<p>各层的功能与遵从协议&nbsp;<br><img src="http://jellythink.u.qiniudn.com/jellythinkTCP2.gif" alt=""></p>
<p><code>TCP</code>工作在网络<code>OSI</code>的七层模型中的第四层&mdash;&mdash;<code>Transport</code>层，<code>IP</code>在第三层&mdash;&mdash;<code>Network</code>层，<code>ARP</code>在第二层&mdash;&mdash;<code>Data Link</code>层。</p>
<p>在第二层上的数据，我们把它叫<code>Frame</code>，在第三层上的数据叫<code>Packet</code>，第四层的数据叫<code>Segment</code>。</p>
<p>我们需要简单的知道，数据从应用层发下来，会在每一层都会加上头部信息，进行封装，然后再发送到数据接收端。这个基本的流程你需要知道，就是每个数据都会经过数据的封装和解封装的过程。</p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h4 id="五层模型"><a href="#五层模型" class="headerlink" title="五层模型"></a>五层模型</h4><p>把应用层、表示层和会话层合并到应用层，简化为五层模型，原因是为了更加地通俗易懂。&nbsp;<br><img src="http://image.beekka.com/blog/201205/bg2012052902.png" alt=""></p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h5 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h5><p>由于互联网是开放架构，数据来源五花八门，必须事先规定好格式，否则根本无法解读。</p>
<p>“应用层”的作用，就是处理并规定应用程序的数据格式。所以在应用层规定了一系列我们最常用，也很容易看得见的协议，我们的普通用户也许不知道底层的协议情况，但是一定知道这些应用层的协议</p>
<ul>
<li><code>HTTP/HTTPS</code></li>
<li><code>FTP</code></li>
<li><code>SMTP</code></li>
<li><code>DNS</code></li>
</ul>
<p>有不同协议规定&nbsp;电子邮件、网页、FTP 数据&nbsp;的格式，这些应用程序协议就构成了&ldquo;应用层&rdquo;。</p>
<p>这是最高的一层，直接面对用户。它的数据一般包含规范的应用层协议头&nbsp;<br><img src="http://static.zybuluo.com/yangfch3/wv1xh5qhgg969odokvs9t94h/2016-03-27_140636.jpg" alt="2016-03-27_140636.jpg-7kB"></p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h5 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h5><ul>
<li><p>端口：一台主机上运行多个程序，每个需要网络服务的程序都会有自己的主机端口，用于决定到底哪个程序使用那个端口来发送和接收数据包？（不可能每个程序都接收数据包，性能和安全上都划不来）</p>
</li>
<li><p>网卡的不同端口对应不同程序的数据传递</p>
<ol>
<li>1-1023端口是系统占用</li>
<li>1024-65535端口会被应用程序随机分配（在程序没有明确要求用哪个端口的情况下）</li>
</ol>
</li>
<li><p>主机+端口=socket（套接字）</p>
</li>
<li><p>传输层协议：在数据包中加入传输层协议头（TCP/UDP 端口信息)</p>
<ol>
<li>UDP协议&nbsp;<br>在&nbsp;应用层数据&nbsp;中加入&nbsp;端口信息&nbsp;最简单的实现方式，如何个简单法：它的格式几乎就是在数据前面，加上端口号，封装成为&nbsp;<code>UDP</code>&nbsp;数据包。</li>
</ol>
<p>UDP 数据包&nbsp;的总长度不超过&nbsp;<code>65535</code>&nbsp;字节</p>
<pre><code>    *   标头（Head）：定义了发出端口和接收端口，长度只有8字节
*   数据（Data）：来自应用层的具体的数据
</code></pre><blockquote>
<p>缺点：可靠性较差，一旦数据包发出，无法知道对方是否收到，没有确认机制</p>
</blockquote>
<pre><code>2.  TCP 协议&amp;nbsp;
</code></pre><p>近似认为，它就是&nbsp;有确认机制&nbsp;的&nbsp;<code>UDP</code>&nbsp;协议，每发出一个数据包都&nbsp;要求确认。如果有一个数据包遗失，就收不到确认，发出方就知道有必要重发这个数据包。</p>
<p><code>TCP</code>&nbsp;协议能够确保数据不会遗失。它的缺点是过程复杂、实现困难、消耗较多的资源。</p>
<p><code>TCP</code>&nbsp;数据包和&nbsp;<code>UDP</code>&nbsp;数据包一样，但&nbsp;<code>TCP</code>&nbsp;数据包没有长度限制，理论上&nbsp;可以无限长。</p>
</li>
</ul>
<blockquote>
<p>但是为了保证网络的效率，通常&nbsp;<code>TCP</code>&nbsp;数据包的长度不会超过&nbsp;网络层&nbsp;<code>IP</code>&nbsp;数据包&nbsp;的长度，以确保单个&nbsp;<code>TCP</code>数据包不必在下一级的封装中被分割。</p>
</blockquote>
<p>就放在TCP数据包的”数据”部分。因此，现在的以太网的数据包就变成下面这样：</p>
<blockquote>
<p>TCP 数据头&nbsp;&gt;&gt;&nbsp;应用层数据包&nbsp;<br><img src="http://image.beekka.com/blog/201205/bg2012052904.png" alt=""></p>
</blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h5 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h5><ul>
<li><p>传输层已经为我们的数据区分了不同的端口（应用程序）</p>
</li>
<li><p>网络层引进一套新的网络地址协议（<code>Internet Protocol</code>），能区分不同计算机是否属于同一子网</p>
</li>
<li><p>路由：实现不同&nbsp;<code>IP</code>&nbsp;的主机（或服务器）之间的数据包传输</p>
</li>
<li><p><code>IP</code>&nbsp;数据包标头：</p>
<ol>
<li>包含协议版本、长度、<code>IP</code>&nbsp;地址等信息</li>
<li>长度：20-60 字节</li>
</ol>
</li>
<li><p><code>IP</code>&nbsp;数据包整体长度最长不超过&nbsp;<code>65515</code>&nbsp;字节，如果数据包超过了&nbsp;<code>65515</code>&nbsp;字节将会被分割为多个&nbsp;<code>IP</code>&nbsp;数据包发送</p>
</li>
<li><p>数据形式：</p>
</li>
</ul>
<blockquote>
<p>IP 协议头&nbsp;&gt;&gt;&nbsp;TCP 协议头&nbsp;&gt;&gt;&nbsp;应用层数据&nbsp;<br><img src="http://image.beekka.com/blog/201205/bg2012052910.png" alt=""></p>
</blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h5 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h5><ul>
<li><p>遵循协议：<code>以太网协议</code></p>
</li>
<li><p>数据帧：<code>IP</code>&nbsp;数据包&nbsp;到达&nbsp;数据链路层&nbsp;后会进行分割，变为多个小型的数据包，又叫做&nbsp;数据帧</p>
</li>
<li><p>单个数据帧最长为&nbsp;1518&nbsp;字节，最短为&nbsp;64&nbsp;字节</p>
</li>
<li><p><code>数据帧</code>分为两部分：</p>
<ul>
<li>标头（Head）</li>
<li>数据（Data）</li>
</ul>
</li>
<li><p>定位准确地址的方案：<code>MAC</code>&nbsp;地址</p>
</li>
<li><p>数据帧&nbsp;标头：</p>
<ol>
<li>固定&nbsp;<code>18</code>&nbsp;字节</li>
<li>包含数据帧说明项：发送者（MAC地址），接受者（MAC地址），数据类型</li>
</ol>
</li>
<li><p>数据帧&nbsp;最短&nbsp;<code>46</code>&nbsp;字节，最长&nbsp;<code>1500</code>&nbsp;字节</p>
</li>
<li><p>MAC 地址：每块网卡独一无二；48 个二进制&nbsp;===&gt;&nbsp;12 个十六进制&nbsp;===&gt;&nbsp;6 个厂商编码 +6 位网卡流水号</p>
</li>
<li><p><code>ARP</code>（<code>Address Resolution Protocol</code>）：网卡的&nbsp;<code>MAC</code>&nbsp;地址寻址依靠&nbsp;<code>ARP</code>&nbsp;协议 &mdash;&mdash; 同一子网，即数据帧&nbsp;<code>广播</code>，全部网卡接收，比对数据帧标头，符合者接收，不符者丢弃</p>
</li>
<li><p>数据链路层数据格式&nbsp;</p>
</li>
</ul>
<blockquote>
<p><img src="http://image.beekka.com/blog/201205/bg2012052913.png" alt=""></p>
</blockquote>
<p>&nbsp;</p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h5 id="实体层"><a href="#实体层" class="headerlink" title="实体层"></a>实体层</h5><ul>
<li><p>把电脑连接起来的物理手段</p>
</li>
<li><p>在这个层面里，数据帧转换为 传输 0 和 1 的电信号</p>
</li>
</ul>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h5 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h5><ul>
<li><p>上面的讲述了数据从上到下，层层&nbsp;分割，层层&nbsp;包装&nbsp;的过程</p>
</li>
<li><p>解包的过程与上面的过程刚好相反</p>
</li>
<li><p>路由协议用于不同 IP 之间传递数据</p>
</li>
<li><p>ARP 协议用于同一局域网下不同网卡接收数据</p>
</li>
</ul>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h2 id="互联网协议入门（二）"><a href="#互联网协议入门（二）" class="headerlink" title="互联网协议入门（二）"></a>互联网协议入门（二）</h2><p>从用户的角度从上至下看互联网协议</p>
<div class="md-section-divider">&nbsp;</div>

<h3 id="上节小结"><a href="#上节小结" class="headerlink" title="上节小结"></a>上节小结</h3><p>网络通信就是交换数据包。电脑A向电脑B发送一个数据包，后者收到了，回复一个数据包，从而实现两台电脑之间的通信。数据包的结构，基本上是下面这样：</p>
<p><img src="http://image.beekka.com/blog/201205/bg2012052913.png" alt=""></p>
<p>发送这个包，需要知道两个地址：</p>
<blockquote>
<ul>
<li>对方的MAC地址</li>
<li>对方的IP地址</li>
</ul>
</blockquote>
<p>有了这两个地址，数据包才能准确送到接收者手中。但是，前面说过，MAC地址有局限性，如果两台电脑不在同一个子网络，就无法知道对方的MAC地址，必须通过网关（gateway）转发。</p>
<p><img src="http://image.beekka.com/blog/201206/bg2012061101.jpg" alt=""></p>
<p>上图中，1号电脑要向4号电脑发送一个数据包。它先判断4号电脑是否在同一个子网络，结果发现不是（判断方法见下面），于是就把这个数据包发到网关A。网关A通过路由协议，发现4号电脑位于子网络B，又把数据包发给网关B，网关B再转发到4号电脑。</p>
<p>1号电脑把数据包发到网关A，必须知道网关A的MAC地址。所以，数据包的目标地址，实际上分成两种情况：</p>
<table class="table table-striped-white table-bordered" data-anchor-id="qtxz"><br><thead><br><tr><th>场景</th><th>数据包地址</th></tr><br><br></thead><br><tbody><br><tr><br><td>同一个子网络</td><br><td>对方的MAC地址（通过ARP获得），对方的IP地址</td><br><br></tr><br><tr><br><td>非同一个子网络</td><br><td>网关的MAC地址，对方的IP地址</td><br><br></tr><br><br></tbody><br><br></table>

<p>发送数据包之前，电脑必须判断对方是否在同一个子网络，然后选择相应的MAC地址：对方的MAC地址还是网关的MAC地址</p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="用户上网设置"><a href="#用户上网设置" class="headerlink" title="用户上网设置"></a>用户上网设置</h3><p>分为静态IP地址上网和动态IP地址上网&nbsp;</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="动态IP地址"><a href="#动态IP地址" class="headerlink" title="动态IP地址"></a>动态IP地址</h4><p>所谓”动态IP地址”，指计算机开机后，会自动分配到一个IP地址，不用人为设定。它使用的协议叫做DHCP协议。</p>
<p>这个协议规定，每一个子网络中，有一台计算机负责管理本网络的所有IP地址，它叫做”DHCP服务器”。新的计算机加入网络，必须向”DHCP服务器”发送一个”DHCP请求”数据包，申请IP地址和相关的网络参数。</p>
<p>如果两台计算机在同一个子网络，必须知道对方的MAC地址和IP地址，才能发送数据包。但是，新加入的计算机不知道这两个地址，怎么发送数据包呢？&nbsp;</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="DHCP-协议"><a href="#DHCP-协议" class="headerlink" title="DHCP 协议"></a>DHCP 协议</h4><p>DHCP（Dynamic Host Configuration Protocol）是一个局域网的网络协议，使用&nbsp;<code>UDP</code>&nbsp;协议工作.</p>
<p>首先，它是一种应用层协议，建立在&nbsp;<code>UDP</code>&nbsp;协议之上，所以整个数据包是这样的：&nbsp;<br><img src="http://image.beekka.com/blog/201206/bg2012061102.png" alt=""></p>
<p>（1）最前面的&nbsp;以太网标头，设置发出方（本机）的&nbsp;<code>MAC</code>&nbsp;地址和接收方（<code>DHCP</code>&nbsp;服务器）的&nbsp;<code>MAC</code>&nbsp;地址。前者就是本机网卡的&nbsp;<code>MAC</code>&nbsp;地址，后者&nbsp;这时不知道，就填入一个广播地址：<code>FF-FF-FF-FF-FF-FF</code>。</p>
<p>（2）后面的&nbsp;IP 标头，设置发出方的 IP 地址和接收方的 IP 地址。这时，对于这两者，本机都不知道。于是，发出方的 IP 地址就设为&nbsp;<code>0.0.0.0</code>，接收方的 IP 地址设为&nbsp;<code>255.255.255.255</code>。</p>
<p>（3）最后的&nbsp;UDP 标头，设置发出方的端口和接收方的端口。这一部分是&nbsp;<code>DHCP</code>&nbsp;协议规定好的，发出方是&nbsp;<code>68</code>&nbsp;端口，接收方是&nbsp;<code>67</code>&nbsp;端口。</p>
<p>这个数据包构造完成后，就可以发出了。</p>
<p>以太网是广播发送，同一个子网络的每台计算机都收到了这个包。因为接收方的MAC地址是FF-FF-FF-FF-FF-FF，看不出是发给谁的，所以每台收到这个包的计算机，还必须分析这个包的 IP 地址，才能确定是不是发给自己的。当看到发出方 IP 地址是&nbsp;<code>0.0.0.0</code>，接收方是&nbsp;<code>255.255.255.255</code>，于是DHCP服务器知道 这个包是发给我的，而其他计算机就可以丢弃这个包。</p>
<p>接下来，DHCP 服务器读出这个包的数据内容，分配好 IP 地址，发送回去一个&nbsp;”DHCP响应”数据包。这个响应包的结构也是类似的，以太网标头的 MAC 地址是双方的网卡地址，IP 标头的 IP 地址是 DHCP 服务器的 IP 地址（发出方）和<code>255.255.255.255</code>（接收方），UDP 标头的端口是 67（发出方）和 68（接收方），分配给请求端的IP地址和本网络的具体参数则包含在Data部分。</p>
<p>新加入的计算机收到这个响应包，于是就知道了自己的IP地址、子网掩码、网关地址、DNS服务器等等参数。</p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="实例：访问页面"><a href="#实例：访问页面" class="headerlink" title="实例：访问页面"></a>实例：访问页面</h3><p>假定用户已经动态设置好了自己的网络参数：</p>
<blockquote>
<ul>
<li>本机的IP地址：192.168.1.100</li>
<li>子网掩码：255.255.255.0</li>
<li>网关的IP地址：192.168.1.1</li>
<li>DNS的IP地址：8.8.8.8</li>
</ul>
</blockquote>
<p>打开浏览器，访问 Google，在地址栏输入了网址：www.google.com。</p>
<p>这意味着，浏览器要向 Google 发送一个&nbsp;网页请求&nbsp;的数据包。</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="DNS协议"><a href="#DNS协议" class="headerlink" title="DNS协议"></a>DNS协议</h4><p>DNS 协议可以帮助我们，将这个网址转换成 IP 地址。已知 DNS 服务器为 8.8.8.8，于是我们向这个地址发送一个DNS数据包（53 端口）。</p>
<p><img src="http://image.beekka.com/blog/201206/bg2012061105.png" alt=""></p>
<p>然后，DNS 服务器做出响应，告诉我们 Google 的IP地址是 172.194.72.105。于是，我们知道了对方的 IP 地址。</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="子网掩码"><a href="#子网掩码" class="headerlink" title="子网掩码"></a>子网掩码</h4><p>接下来，我们要判断，这个IP地址是不是在同一个子网络，这就要用到子网掩码。</p>
<p>已知子网掩码是 255.255.255.0，本机用它对自己的IP地址 192.168.1.100，做一个二进制的AND运算（两个数位都为 1，结果为 1，否则为 0），计算结果为 192.168.1.0；然后对 Google 的 IP 地址 172.194.72.105 也做一个 AND 运算，计算结果为 172.194.72.0。这两个结果不相等，所以结论是，Google 与本机不在同一个子网络。</p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h4 id="应用层协议"><a href="#应用层协议" class="headerlink" title="应用层协议"></a>应用层协议</h4><p>浏览网页的浏览器用的是HTTP协议，它的整个数据包构造是这样的：&nbsp;<br><img src="http://image.beekka.com/blog/201206/bg2012061106.png" alt=""></p>
<p>HTTP部分的内容，类似于下面这样：</p>
<pre><code>GET / HTTP/1.1
Host: www.google.com
Connection: keep-alive
User-Agent: Mozilla/5.0 (Windows NT 6.1) ......
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Encoding: gzip,deflate,sdch
Accept-Language: zh-CN,zh;q=0.8
Accept-Charset: GBK,utf-8;q=0.7,*;q=0.3
Cookie: ... ...
</code></pre><p>我们假定这个部分的长度为 4960 字节，它会被嵌在TCP数据包之中。</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="TCP协议"><a href="#TCP协议" class="headerlink" title="TCP协议"></a>TCP协议</h4><p>TCP 数据包需要设置端口，接收方（Google）的&nbsp;HTTP端口默认是80，发送方（本机）的端口是一个&nbsp;随机生成的1024-65535之间的整数，假定为 51775。</p>
<p>TCP 数据包的标头长度为 20 字节，加上嵌入 HTTP 的数据包，总长度变为4980字节。</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="IP协议"><a href="#IP协议" class="headerlink" title="IP协议"></a>IP协议</h4><p>然后，TCP 数据包再嵌入 IP 数据包。IP 数据包需要设置双方的 IP 地址，这是已知的，发送方是 192.168.1.100（本机），接收方是 172.194.72.105（Google）。</p>
<p>IP 数据包的标头长度为 20 字节，加上嵌入的 TCP 数据包，总长度变为 5000 字节。</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="以太网协议"><a href="#以太网协议" class="headerlink" title="以太网协议"></a>以太网协议</h4><p>最后，IP 数据包嵌入以太网数据包。以太网数据包需要设置双方的 MAC 地址，发送方为本机的网卡 MAC 地址，接收方为网关 192.168.1.1 的 MAC 地址（通过 ARP 协议得到）。</p>
<p>以太网数据包的数据部分，最大长度为 1500 字节，而现在的IP数据包长度为 5000 字节。因此，IP 数据包必须分割成四个包。因为每个包都有自己的 IP 标头（20 字节），所以四个包的 IP数据包的长度分别为 1500、1500、1500、560。</p>
<p><img src="http://image.beekka.com/blog/201206/bg2012061107.png" alt=""></p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="服务器响应"><a href="#服务器响应" class="headerlink" title="服务器响应"></a>服务器响应</h4><p>经过多个网关的转发，Google 的服务器 172.194.72.105，收到了这四个以太网数据包。</p>
<p>根据 IP 标头的序号，Google 将四个包拼起来，取出完整的 TCP 数据包，然后读出里面的”HTTP请求”，接着做出”HTTP响应”，再用TCP协议发回来。</p>
<p>本机收到HTTP响应以后，就可以将网页显示出来，完成一次网络通信。</p>
<p><img src="http://image.beekka.com/blog/201206/bg2012061104.jpg" alt=""></p>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h2 id="Web开发新人培训系列备忘"><a href="#Web开发新人培训系列备忘" class="headerlink" title="Web开发新人培训系列备忘"></a>Web开发新人培训系列备忘</h2><div class="md-section-divider">&nbsp;</div>

<h3 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h3><ul>
<li><p>进程a发送数据是通过socket发出去，socket需要绑定一个端口，用于区分计算机内的不同进程。进程a使用的socket绑定了2048端口，进程b使用的socket绑定了4096端口。</p>
</li>
<li><p>真正想要数据的进程才是最终应用层。</p>
</li>
<li><p>协议的目的就是让通信的双方知道当前这个数据包是怎么样一个组成格式，一般：包头就是双方约定好的一些信息，包体就是这次通信传输的数据。&nbsp;<br>协议 == 包头 + 包体。</p>
</li>
<li><p>HTTP协议</p>
</li>
</ul>
<blockquote>
<p>HTTP请求包的HTTP包头格式：</p>
<pre><code>*   GET / HTTP/1.1&amp;nbsp;
</code></pre><p>获取的路径以及HTTP版本</p>
<pre><code>*   Host: www.qq.com:8080&amp;nbsp;
</code></pre><p>服务器主机名字&amp;端口号</p>
<pre><code>*   Connection: keep-alive&amp;nbsp;
</code></pre><p>用于长连</p>
<pre><code>*   User-Agent: Chrome/35.0.1916.153&amp;nbsp;
</code></pre><p>浏览器基本信息</p>
<pre><code>*   Accept-Encoding: gzip,deflate,sdch&amp;nbsp;
</code></pre><p>告诉服务器支持的编码</p>
<pre><code>*   Accept-Language: zh-CN,zh;q=0.8,en;q=0.6,nl;q=0.4,zh-TW;q=0.2&amp;nbsp;
</code></pre><p>告诉服务器优先支持的语言</p>
<pre><code>*   Cookie: id=1;username=raphealguo;&amp;nbsp;
</code></pre><p>解决HTTP无状态重要的Cookie，里边是key=value对</p>
</blockquote>
<ul>
<li>服务器收到HTTP请求，经过&nbsp;CGI处理&nbsp;之后回复一个HTTP响应包</li>
</ul>
<blockquote>
<p>HTTP响应包包头常见格式</p>
<pre><code>*   HTTP/1.1 200 OK&amp;nbsp;
</code></pre><p>HTTP版本以及状态码</p>
<pre><code>*   Server: nginx/1.4.1&amp;nbsp;
</code></pre><p>服务器版本</p>
<pre><code>*   Date: Mon, 30 Jun 2014 09:44:10 GMT&amp;nbsp;
</code></pre><p>回包时间</p>
<pre><code>*   Content-Type: text/html; charset=UTF-8&amp;nbsp;
</code></pre><p>包里边的类型</p>
<pre><code>*   Content-Length: 14534&amp;nbsp;
</code></pre><p>包体的长度</p>
<pre><code>*   Connection: keep-alive&amp;nbsp;
</code></pre><p>用于长连</p>
<pre><code>*   Cache-Control: no-cache, must-revalidate&amp;nbsp;
</code></pre><p>用于缓存控制</p>
</blockquote>
<ul>
<li><p>HTTPS协议&nbsp;</p>
<ol>
<li>HTTPS=HTTP协议+SSL</li>
<li>HTTP传输是明文传输，易被劫持篡改</li>
<li>HTTPS采用非对称加密：两边的加密、解密不是完全一样的</li>
</ol>
<p>&nbsp;</p>
</li>
</ul>
<blockquote>
<p>非对称加密示例：</p>
<pre><code>Bob将衣服放到一个保险箱里边锁起来，他打了个电话告诉Alice保险箱开柜密码是1234，而黑客H不知道密码，所以他看不到保险箱里边的东西，Alice收到快递后用预先沟通好的密码就可以打开保险箱了。

    这里保护的手段就是Bob对物品进行加密，同时给了告诉Alice解密的方法！

    那如果现在要求Bob的密码只能通过快递传给Alice呢？如果Bob直接传密码给Alice，H如果嗅探到这个快递，那H也知道密码了，这就无法保护快递的安全性了。因此还需要有个方案，让Bob能够告诉Alice密码的同时，H又无法查看到Bob跟Alice通信的数据。

    非对称加密在这个时候就发挥作用了，来看看怎么回事：Bob拥有两把钥匙，一把叫做公钥，一把叫做私钥。公钥是公开让全社会都知道，没关系，Bob告诉所有人，你们要传递数据给我的时候请先用这个密钥去加密一下你们的数据，加密后的数据只能通过Bob私自藏着的私钥才能解密。

    回到刚刚例子，Bob先发给保险柜（Bob公钥）给Alice，接着Alice把自己的保险柜（Alice公钥）放到Bob的保险柜里边发还给Bob，接着Bob拿到Alice的回包后，用自己的私钥解开了外层保险柜，拿到了里边Alice保险柜。此时Alice跟Bob都有了各自的公钥，接着只要保证每次互相传递数据的时候，把数据放在对方的保险柜里边即可，这样无论如何，H都无法解开保险柜（因为只有各自的私钥才能解开各自的保险柜）。
</code></pre></blockquote>
<pre><code>4.  HTTPS隧道
</code></pre><blockquote>
<p>HTTPS通信会有如下的过程：</p>
<pre><code>    1.  客户端先跟服务器做一次SSL握手，也就是刚刚Bob跟Alice交换公钥的过程。
2.  此时客户端跟服务器都有了各自的公钥，这时他们中间相当于有了一条安全的HTTPS隧道。
3.  客户端要发送请求时，采用服务器给的公钥对请求包进行加密，然后发出去。
4.  服务器收到请求后，使用自己的私钥解开了这个请求包得到其内容。
5.  服务器响应的时候，采用客户端给的公钥进行加密，然后发还给客户端。
6.  客户端收到响应后，使用自己的私钥解开响应包得到其内容。
7.  结束的时候，双方关闭SSL隧道，丢掉上次交换的公钥。
</code></pre></blockquote>
<pre><code>5.  HTTPS也不安全的情况：&amp;nbsp;
</code></pre><blockquote>
<p>&nbsp;</p>
<pre><code>    1.  私钥被窃取；
2.  HTTPS是无法保证端内安全（HTTP就更不能了），电脑已经被病毒侵入，病毒可以监听到你开锁的时候，也可以知道你的私钥；
3.  HTTPS下的页面引用了HTTP下的资源，例如HTTPS下的页面引用了HTTP下的Javascript文件，此时如果这个Javascript文件被篡改了，那通过这个JS文件就可以在执行的时候获取到整个网页内容，在这种情况下，某些浏览器会阻止你去加载这些非HTTP资源，有些则会提示错误或者给出警告信息。
</code></pre><div class="md-section-divider">&nbsp;</div>

</blockquote>
<hr>
<div class="md-section-divider">&nbsp;</div>

<h3 id="经典的Web应用网络模型"><a href="#经典的Web应用网络模型" class="headerlink" title="经典的Web应用网络模型"></a>经典的Web应用网络模型</h3><p>总体模型概览：&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/%E6%A6%82%E8%A7%88.png" alt=""></p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h4><ul>
<li><p>浏览器会先询问本地Hosts，如果没有映射则再询问DNS缓存，如果没有记录过这个域名映射的IP，那就向本地的DNS网关询问，如果网关也不知道，就继续往上一层的DNS服务器询问，直到拿到这个IP地址。</p>
</li>
<li><p>一般来说，一台服务器处理的请求是有限的，因此大型的应用都会有多台<code>proxy</code>机器，我们可以让DNS服务器在第一个请求返回IP1，第二个请求返回IP2&hellip;&hellip;这样用户的请求就会均匀的落在这些机器上，这个就是<code>DNS</code>负载均衡。<code>CDN</code>就是通过智能<code>DNS</code>算出离用户最近的<code>CDN</code>节点的<code>IP</code>地址，这样用户可以访问一台离他最近的机器，大大节约连接时间。&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/DNS%E8%B4%9F%E8%BD%BD.png" alt=""></p>
<div class="md-section-divider">&nbsp;</div>

</li>
</ul>
<h4 id="代理与反向代理"><a href="#代理与反向代理" class="headerlink" title="代理与反向代理"></a>代理与反向代理</h4><ul>
<li>一般来说，浏览器跟真正提供Web服务的机器是没有直接连接的，他们中间都会有代理跟反向代理。</li>
<li>代理可以是公司内部的代理服务器、各级<code>ISP</code>转发服务器、VPN代理服务器&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86.png" alt=""></li>
<li><p>代理服务器的作用：恶意请求/响应的拦截、缓存内部网络所需的公共资源、GFW与反GFW&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86.png" alt=""></p>
</li>
<li><p>反向代理就是以代理服务器来接收网络连接请求，我们上下文称Proxy机器指的就是反向代理机器，Proxy机器收到请求后会经过一定的分析最后把请求内容转发给内网对应的Web服务器，Web服务器的HTTP响应包会先到Proxy机器，然后再到用户机器。</p>
</li>
</ul>
<p>反向代理的好处是可以负载均衡，在它后边可以有多台工作的Web服务器，这样分层次之后，很多职责就明确很多了：Proxy机器负责负载均衡、拦截恶意请求、维持长连接，还可以屏蔽不工作的Web服务器；而Web服务器就只要关心自己处理的Web业务逻辑即可。</p>
<p>往往Proxy服务器跟用户机器保持长连接，这样可以节省用户每次跟服务器建立连接的消耗，而Proxy服务器跟Web服务器采用短连接的方式，这样可以有效节约Web服务器的资源。&nbsp;</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="Web-server"><a href="#Web-server" class="headerlink" title="Web server"></a>Web server</h4><ul>
<li>Web server的职责就是根据用户的请求，返回其所需要的响应内容。往往Web server只涉及业务测逻辑的判断以及数据的组装，而真正的数据位于后端的存储Server。</li>
</ul>
<p>对于一般应用来说，Web server返回的是动态产生的内容（每个用户都不一致的动态内容或者经常编辑变动的内容），如页面的HTML内容、JSON数据、XML数据等。而Javascript文件、CSS文件、图片这些静态资源（不根据用户而变动的资源）往往存放在CDN中。&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/Web-server.png" alt="">&nbsp;</p>
<div class="md-section-divider">&nbsp;</div>

<h4 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h4><ul>
<li><p>对于动态的内容，请求总是到Web server去动态计算获取内容，但是对于不随用户状态变化的内容我们把内容推送到CDN节点上。</p>
</li>
<li><p>静态资源的域名跟页面HTML的域名一般来说是不一样的，因为静态资源的请求需要解析到CDN节点去。我们假设主请求是：www.qq.com/index.html；CDN请求是cdn.qq.com/index.css。&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/CDN.png" alt=""></p>
</li>
<li><p>一般Web应用把静态内容推到CDN有两种模式，一种是在上线前主动将内容推送到CDN节点，一种是CDN发现本地没有该文件时，回源到Web server机器取内容，然后缓存在他本地。&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2014/10/CDN%E6%8E%A8%E9%80%81%E5%86%85%E5%AE%B9.png" alt=""></p>
<div class="md-section-divider">&nbsp;</div>

</li>
</ul>
<h4 id="上线"><a href="#上线" class="headerlink" title="上线"></a>上线</h4><ul>
<li><p>像JS文件、CSS文件这些资源对于所有用户来说都是一样的，我们把它们归类到静态资源。对于不同用户，它们看到的网页其实是不一致的（例如页面里边有他们各自的昵称，id等信息），这是通过CGI程序实时计算，为不同用户生成不同的HTML产生，我们把这样的HTML资源归类为动态资源。</p>
</li>
<li><p>由于动态资源是需要实时获取的，因此请求最后都需要落到我们的CGI程序上。而对于静态资源来说，所有请求都是一样的，不需要通过CGI去实时获取文件内容做响应。</p>
</li>
<li><p>一般我们需要多台Web服务器，在它们上层的proxy机器把用户的请求平摊在这些机器上。我们现实的网络结构大多数是这样的：&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2015/01/%E4%B8%8A%E7%BA%BF%E2%80%94%E2%80%94proxy%E8%B7%AF%E7%94%B1.png" alt=""></p>
</li>
<li><p>刚刚我们在只有一台服务器的情况下，我们只需要把文件传输到这台服务器就算此次上线完毕。同样道理在多台服务器的网络结构下，我们把文件依次上传到这些服务器上，对于所有服务器都传输完毕后才算此次上线完毕。&nbsp;<br><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2015/01/%E4%B8%8A%E7%BA%BF%E2%80%94%E2%80%94%E5%A4%9A%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%BA%BF.png" alt=""></p>
</li>
<li><p>在上线的过程中，有一些服务器是新资源，有一些服务器是旧资源。问题就来了：</p>
</li>
</ul>
<blockquote>
<p>服务器1已经部署上新的资源，而服务器2上还是旧资源。假设这样一个场景，用户第一个HTML请求到了服务器1，然后返回一个新的HTML，接着用户第二个JS请求又跑到服务器2。&nbsp;</p>
<pre><code>在用户侧的表现就是一个旧的JS文件作用在一个新的HTML上，这样可能就引发了异常。&amp;nbsp;
</code></pre><p><img src="http://rapheal-wordpress.stor.sinaapp.com/uploads/2015/01/%E4%B8%8A%E7%BA%BF%E2%80%94%E2%80%94%E4%B8%8A%E7%BA%BF%E5%BC%82%E5%B8%B8.png" alt=""></p>
</blockquote>
<ul>
<li><p>没法做到资源的实时一致，多台服务器的网络结构下必然会存在某小段时间间隙存在资源不一致的现象。</p>
</li>
<li><p>解决方案：让同一个用户的多次请求永远都在同一台机器上，用户要么访问到的全部都是旧资源，要么全部都是新资源。（这样还能达到灰度测试的作用）</p>
</li>
<li><p>怎么让同一个用户的请求一直都落在同一台机器上?</p>
</li>
</ul>
<blockquote>
<p>通过proxy把同一个用户的请求转发到同一个Web服务器：</p>
<pre><code>1.  proxy反向代理机器收到用户请求
2.  proxy通过这个请求某些flagid标记得知当前这个请求是A用户的
3.  接着proxy定义一个hash算法getServer，通过计算svr = getServer(flag)得到最后这个请求要去到的Web服务器svr&amp;nbsp;

    只要保证getServer这个hash算法每次输出是唯一即可，这个很容易做到。问题：用户的请求带上的flagid是怎么带的？我们先不纠结这个怎么做，我们只要在用户登陆我们系统后，在cookies种上一个能标记出这个用户的id即可。
</code></pre><div class="md-section-divider">&nbsp;</div><br><div class="md-section-divider">&nbsp;</div>

</blockquote>
<p>&nbsp;</p>
<p></p></div><p></p>
<p></p></div><p></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/08/24/Git-Note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/24/Git-Note/" itemprop="url">Git Note</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-24T17:36:00+08:00">
                2016-08-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/24/Git-Note/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/08/24/Git-Note/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><blockquote>
<p>参考 <a href="http://chengshiwen.com/article/head-first-git/" target="_blank" rel="noopener">http://chengshiwen.com/article/head-first-git/</a></p>
</blockquote>
<h2 id="文件状态"><a href="#文件状态" class="headerlink" title="文件状态"></a>文件状态</h2><ul>
<li><p><strong>Git目录</strong>: （git directory），亦即Git仓库，一般对应项目根目录下的.git目录。该目录非常重要，每次克隆镜像仓库的时候，实际拷贝的就是这个目录里面的数据。</p>
</li>
<li><p><strong>工作目录</strong>:（working directory）是项目某个版本的签出（The working directory is a single checkout of one version of the project） ，也就是本地项目目录，其包含该版本的所有文件（不包括Git目录）。这些文件都是从Git目录中取出的，我们可以在工作目录中修改它们(modify)、删除它们(remove)或添加新文件(add)——这些称之为改动（Changes）。</p>
</li>
<li><p><strong>暂存区域</strong>:（staging area）是工作目录和Git目录之间的临时中转区，存储着工作目录中部分改动文件的快照，该快照将在下次提交时被永久地保存到Git目录中。暂存区域也叫索引（index），实际是Git目录下的index文件（<code>.git/index</code>），其存放了与当前暂存内容相关的信息，包括暂存的文件名、文件内容的SHA-1哈希值和文件访问权限，使用<code>git ls-files --stage</code>命令可查看其内容。</p>
</li>
</ul>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><h3 id="查看配置信息"><a href="#查看配置信息" class="headerlink" title="查看配置信息"></a>查看配置信息</h3><p><code>git config --list</code></p>
<p><code>git config [--system/--global/--local] user.name</code></p>
<h3 id="初始化新仓库"><a href="#初始化新仓库" class="headerlink" title="初始化新仓库"></a>初始化新仓库</h3><p><code>git init</code></p>
<h3 id="从现有仓库克隆"><a href="#从现有仓库克隆" class="headerlink" title="从现有仓库克隆"></a>从现有仓库克隆</h3><p>从现有的项目仓库（如远程服务器上自己的项目，或者其它某个开源项目）克隆到本地，Git接收的是项目历史的所有数据（包括每一个文件的每一个版本）。</p>
<p><code>git clone &lt;repo&gt; [&lt;dir&gt;]</code></p>
<p>克隆时可以在上面的命令末尾指定新的名字，来定义要新建的项目目录名称（仅目录名称不同），例如：</p>
<p><code>git clone git@github.com:jquery/jquery.git myjquery</code></p>
<p>Git支持<code>git://</code>，<code>http(s)://</code>，<code>ssh://</code>等多种数据传输协议。</p>
<h2 id="Git的基本工作流程"><a href="#Git的基本工作流程" class="headerlink" title="Git的基本工作流程"></a>Git的基本工作流程</h2><ul>
<li><p>改动文件：在工作目录中修改、删除或添加某些文件</p>
</li>
<li><p>暂存文件：对改动后的文件进行快照，保存至暂存区域</p>
</li>
<li><p>提交快照：将保存在暂存区域的文件快照永久转储到Git目录中</p>
</li>
</ul>
<h3 id="查看工作目录下当前文件的状态"><a href="#查看工作目录下当前文件的状态" class="headerlink" title="查看工作目录下当前文件的状态"></a>查看工作目录下当前文件的状态</h3><p><code>git status</code></p>
<h3 id="暂存文件"><a href="#暂存文件" class="headerlink" title="暂存文件"></a>暂存文件</h3><p>其作用是把目标文件快照放入暂存区域（add file into staged area）。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>新文件</th>
<th>被修改文件</th>
<th>被删除文件</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>git add</code></td>
<td>Y</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td><code>git add -u</code></td>
<td>N</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td><code>git add -A</code></td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
</tbody>
</table>
<h4 id="取消已修改或已暂存文件"><a href="#取消已修改或已暂存文件" class="headerlink" title="取消已修改或已暂存文件"></a>取消已修改或已暂存文件</h4><p><code>git checkout [&lt;commit&gt;] [--] &lt;file&gt;...</code></p>
<ul>
<li><p>省略commit: 暂存区域 覆盖工作目录 的文件</p>
</li>
<li><p>指定commit: 指定commit 覆盖暂存区域和工作目录</p>
</li>
</ul>
<p>两者不会改变HEAD指针，其中–用于分隔指定文件，防止该文件与分支重名造成分支误操作。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -- grep.py   # 放弃grep.py文件未暂存的改动</span><br><span class="line">$ git checkout .            # 放弃所有未暂存的改动</span><br><span class="line">$ git checkout HEAD *.txt   # 放弃本次所有txt文件作的改动（包括工作目录和暂存区域）</span><br><span class="line">$ git checkout HEAD .       # 放弃所有已暂存改动和未暂存改动，即完全重置到最近的提交状态</span><br></pre></td></tr></table></figure>
<h4 id="文件重置为最近提交时的状态"><a href="#文件重置为最近提交时的状态" class="headerlink" title="文件重置为最近提交时的状态"></a>文件重置为最近提交时的状态</h4><p><code>git reset HEAD &lt;file&gt;</code></p>
<h4 id="从暂存区域移除文件"><a href="#从暂存区域移除文件" class="headerlink" title="从暂存区域移除文件"></a>从暂存区域移除文件</h4><p><code>git rm --cached &lt;file&gt;</code></p>
<h3 id="差异比较"><a href="#差异比较" class="headerlink" title="差异比较"></a>差异比较</h3><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>git diff</code></td>
<td>工作目录 / 暂存区域快照</td>
</tr>
<tr>
<td><code>git diff [--] &lt;path&gt;...</code></td>
<td>工作目录 / 暂存区域快照(指定文件或目录)</td>
</tr>
<tr>
<td><code>git diff --cached</code></td>
<td>暂存区域快照 / 上次提交</td>
</tr>
<tr>
<td><code>git diff --cached [--] &lt;path&gt;...</code></td>
<td>暂存区域快照 / 上次提交(指定文件或目录)</td>
</tr>
<tr>
<td><code>git diff HEAD</code></td>
<td>工作目录 / 上次提交</td>
</tr>
<tr>
<td><code>git diff &lt;commit&gt;</code></td>
<td>工作目录 / commit</td>
</tr>
<tr>
<td><code>git diff &lt;commit&gt; [--] &lt;path&gt;...</code></td>
<td>工作目录 / commit(指定文件或目录)</td>
</tr>
<tr>
<td><code>git diff --cached HEAD</code></td>
<td>暂存区域快照 / 上次提交</td>
</tr>
<tr>
<td><code>git diff --cached &lt;commit&gt;</code></td>
<td>暂存区域快照 / commit</td>
</tr>
<tr>
<td><code>git diff --cached &lt;commit&gt; [--] &lt;path&gt;...</code></td>
<td>暂存区域快照 / commit(指定文件或目录)</td>
</tr>
<tr>
<td><code>git diff &lt;commit1&gt; &lt;commit2&gt;</code></td>
<td>commit1 / commit2</td>
</tr>
<tr>
<td><code>git diff --check</code></td>
<td>列出所有的尾随空白符</td>
</tr>
</tbody>
</table>
<h3 id="提交快照"><a href="#提交快照" class="headerlink" title="提交快照"></a>提交快照</h3><p>把暂存区域内的文件快照提交至Git目录中:<br><code>git commit -m &quot;Fix Bug #182: Fix benchmarks for speed&quot;</code></p>
<p>把所有已经跟踪过的文件暂存起来一并提交:<br><code>git commit -a -m &quot;added new benchmarks&quot;</code></p>
<p>以新作者提交:<code>git commit --author wjhook&lt;wjhook@gmail.com&gt;</code></p>
<p>将指定文件和已暂存文件一并提交:<code>git commit -i &lt;file&gt;...</code></p>
<p>只提交指定文件:<code>git commit -o &lt;file&gt;...</code></p>
<p>修改最后一次提交:</p>
<ul>
<li>重新编辑提交说明: <code>git commit --amend -m &lt;message&gt;</code></li>
<li>重新编辑提交作者: <code>git commit --amend --author wjhook&lt;wjhook@gmail.com&gt;</code></li>
</ul>
<h3 id="Git的基本工作扩展"><a href="#Git的基本工作扩展" class="headerlink" title="Git的基本工作扩展"></a>Git的基本工作扩展</h3><h4 id="查看提交历史"><a href="#查看提交历史" class="headerlink" title="查看提交历史"></a>查看提交历史</h4><p><code>git log --pretty=format:&quot;%h [%an]&lt;%ae&gt;(%ad) message -&gt; %s&quot; --after=&quot;2016-08-12 15:26:00&quot; --before=&quot;2016-08-25&quot; --graph --author= wangjie -p -- *android/alibaba/member*FragmentMemberSignIn.java  -3</code></p>
<p>按照”hash [作者]&lt;邮箱&gt;(时间) message -&gt; 提交说明”的格式查看提交时间在2016-08-12 15:26:00 ~ 2016-08-25 之间的、作者为wangjie的关于<code>*android/alibaba/member*FragmentMemberSignIn.java</code>文件的log并显示提交差异。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%H	：提交对象（commit）的完整哈希字串</span><br><span class="line">%h	：提交对象的简短哈希字串</span><br><span class="line">%an：作者（author）的名字</span><br><span class="line">%ae：作者的电子邮件地址</span><br><span class="line">%ad：作者修订日期（可以用 -date= 选项定制格式）</span><br><span class="line">%ar：作者修订日期，按多久以前的方式显示</span><br><span class="line">%s：提交说明</span><br></pre></td></tr></table></figure>
<p><code>git log --diff-filter=[A/D] --summary</code>：<br>列出版本库中曾添加/删除过文件的提交</p>
<p><code>git log --diff-filter=[A/D] --summary | grep create</code>：<br>列出所有添加/删除过的历史文件</p>
<p><code>git log branch1..branch2</code>：属于branch2，不属于branch1的提交</p>
<h5 id="暂存栈"><a href="#暂存栈" class="headerlink" title="暂存栈"></a>暂存栈</h5><blockquote>
<p><stash> -&gt; stash@{0/1/2/3…}</stash></p>
</blockquote>
<p><code>git stash [save &lt;message&gt;]</code>: 当前工作保存到暂存栈中</p>
<p><code>git stash pop [&lt;stash&gt;]</code>: 恢复暂存栈中引用为<stash>的工作，并从暂存栈中删除</stash></p>
<p><code>git stash apply [&lt;stash&gt;]</code>: 恢复暂存栈中引用为<stash>的工作，暂存栈中不删除</stash></p>
<p><code>git stash drop [&lt;stash&gt;]</code>: 删除暂存栈中引用为<stash>的工作</stash></p>
<p><code>git stash list</code>: 列出暂存栈中的所有工作</p>
<p><code>git stash show [&lt;stash&gt;]</code>: 显示暂存栈中引用为<stash>的工作的改动记录</stash></p>
<p><code>git stash clear</code>: 清除暂存栈中所有保留的工作</p>
<p><code>git stash branch &lt;branchname&gt; [&lt;stash&gt;]</code>: 基于指定工作创建新分支，完全恢复该工作被保存前的状态（新建一个最新提交为<stash>创建时所在的提交、名为<branchname>的分支，同时切换到该分支，恢复暂存栈中引用为<stash>的工作，并将其从暂存栈中删除）</stash></branchname></stash></p>
<h5 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h5><p><code>rm &lt;file&gt;...</code>：从工作目录中删除指定文件，但不从暂存区域移除</p>
<p><code>git rm &lt;file&gt;...</code>：从工作目录中删除指定文件，同时将其从暂存区域移除</p>
<p><code>git rm --cached &lt;file&gt;...</code>：仅仅将文件从暂存区域中移除（其状态变为未跟踪），不对该文件进行其它操作</p>
<p><code>git rm -f &lt;file&gt;...</code>：强制删除</p>
<p><code>git rm -r &lt;file&gt;...</code>：递归删除（用于删除目录）</p>
<h5 id="移动或重命名文件"><a href="#移动或重命名文件" class="headerlink" title="移动或重命名文件"></a>移动或重命名文件</h5><p><code>git mv &lt;file_from&gt; &lt;file_to&gt;</code></p>
<p>其等价于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mv &lt;file_from&gt; &lt;file_to&gt;</span><br><span class="line">$ git rm &lt;file_from&gt;</span><br><span class="line">$ git add &lt;file_to</span><br></pre></td></tr></table></figure>
<h5 id="清除未跟踪文件"><a href="#清除未跟踪文件" class="headerlink" title="清除未跟踪文件"></a>清除未跟踪文件</h5><p><code>git clean -n</code>: 显示将要清除的文件和目录</p>
<p><code>git clean -f</code>：强制清除文件（不包括目录）</p>
<p><code>git clean -df</code>：强制清除所有文件和目录</p>
<p>若要同时再移除被忽略的文件或目录，加上-x参数；若只移除被忽略的文件或目录，加上-X参数。</p>
<h5 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h5><p><code>git merge -m &lt;msg&gt; &lt;commit&gt;</code>：如果产生新的合并提交，则附加msg说明</p>
<p><code>git merge --no-commit &lt;commit&gt;</code>：合并成功后不会自动产生新的提交，用户可以在下次提交前对这次的合并结果进行修改和调整</p>
<p><code>git merge --abort</code>：遇到合并冲突时，此命令将终止合并，并恢复未合并之前的状态</p>
<h5 id="分支挑捡"><a href="#分支挑捡" class="headerlink" title="分支挑捡"></a>分支挑捡</h5><p>如果不需要合并某个分支的全部提交,而只需要该分支的某个或某些提交,使用git cherry-pick命令，它会将指定的commit重新应用到当前分支，命令格式为：</p>
<p><code>$ git cherry-pick &lt;commit&gt;...</code></p>
<h3 id="远程交互"><a href="#远程交互" class="headerlink" title="远程交互"></a>远程交互</h3><h5 id="查看远程仓库"><a href="#查看远程仓库" class="headerlink" title="查看远程仓库"></a>查看远程仓库</h5><p><code>git remote</code></p>
<p>加上<code>-v</code>选项，显示对应的克隆地址：<code>git remote -v</code></p>
<h5 id="添加远程仓库"><a href="#添加远程仓库" class="headerlink" title="添加远程仓库"></a>添加远程仓库</h5><p><code>git remote add &lt;shortname&gt; &lt;url&gt;</code></p>
<p><code>git remote add upstream https://github.com/xgenvn/InputHelper.git</code></p>
<p>拉取所有xgenvn有的，但本地仓库没有的信息</p>
<p><code>git fetch upstream</code></p>
<p><code>git remote rename &lt;old&gt; &lt;new&gt;</code>：重命名远程仓库</p>
<p><code>git remote rm &lt;name&gt;</code>：删除名为name的远程仓库</p>
<p><code>git remote [-v] show &lt;name&gt;</code>：查看远程仓库信息</p>
<p><code>git remote prune &lt;name&gt;</code>：删除不存在对应远程分支的本地分支</p>
<h5 id="推送提交到远程仓库"><a href="#推送提交到远程仓库" class="headerlink" title="推送提交到远程仓库"></a>推送提交到远程仓库</h5><p><code>git push &lt;remote&gt; &lt;branch&gt;</code></p>
<p><code>git push &lt;remote&gt; &lt;lbranch&gt;:[&lt;rbranch&gt;]</code>：将本地lbranch分支推送到remote远程仓库的rbranch分支。若rbranch缺省则默认为lbranch，等同于git push <remote> <lbranch></lbranch></remote></p>
<p><code>git push &lt;remote&gt; :&lt;branch&gt;</code>：将空推送到remote远程仓库的branch分支，即删除remote远程仓库的branch分支</p>
<p><code>git push &lt;remote&gt; --delete &lt;branch&gt;</code>：删除remote远程仓库的branch分支</p>
<p><code>git push &lt;remote&gt; -f &lt;lbranch&gt;:[&lt;rbranch&gt;]</code>：将本地lbranch分支强制推送到remote远程仓库的rbranch分支</p>
<h5 id="从远程仓库拉取最新改动"><a href="#从远程仓库拉取最新改动" class="headerlink" title="从远程仓库拉取最新改动"></a>从远程仓库拉取最新改动</h5><p>基本命令为<code>git fetch</code>，其作用是到远程仓库中拉取所有本地仓库中还没有的最新改动，但不会自动将这些改动合并到当前工作分支</p>
<p><code>git fetch [&lt;remote&gt;]</code>：到remote远程仓库拉取所有本地仓库中还没有的最新改动，不指定remote则默认为origin</p>
<p><code>git fetch &lt;remote&gt; &lt;branch&gt;</code>：将remote远程仓库的branch分支拉取到本地，同时用FETCH_HEAD指针指向它</p>
<p><code>git fetch --all</code>：拉取所有远程仓库</p>
<p><code>git fetch -p</code>：删除不存在对应远程分支的本地分支</p>
<h5 id="从远程仓库拉取最新改动并合并"><a href="#从远程仓库拉取最新改动并合并" class="headerlink" title="从远程仓库拉取最新改动并合并"></a>从远程仓库拉取最新改动并合并</h5><p>基本命令为<code>git pull</code>，其作用是从远程仓库自动拉取最新改动到本地（Fetch），然后将远程分支自动合并到本地仓库中的当前分支(Merge)</p>
<p><code>git pull &lt;remote&gt; &lt;branch&gt;</code></p>
<p>其将remote远程仓库的branch分支拉取到本地，然后将其合并到本地当前分支。</p>
<p><code>git pull &lt;remote&gt; &lt;rbranch&gt;:&lt;lbranch&gt;</code>：将remote远程仓库的rbranch分支拉取到本地，然后将其合并到本地lbranch分支</p>
<h5 id="重置"><a href="#重置" class="headerlink" title="重置"></a>重置</h5><p>基本命令为git reset，其作用是将当前分支指针（HEAD指针）重置为指定状态</p>
<p><code>git reset [&lt;commit&gt;] [--] &lt;paths&gt;...</code></p>
<p>将暂存区域中指定路径的文件重置为指定commit（不指定则默认为HEAD）时的状态，但不会改变工作目录及当前分支，其相当于git add <paths>的反向操作。该命令执行后，自从commit以来指定文件的所有改动都显示在Changes not staged for commit中，而这些改动的反向改动会显示在Changes to be committed中。</paths></p>
<p><code>git reset (--soft|--mixed|--hard) [&lt;commit&gt;]</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/08/22/Android-使用自定义JUnit-Rules、annotations和Resources进行单元测试（翻译）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/22/Android-使用自定义JUnit-Rules、annotations和Resources进行单元测试（翻译）/" itemprop="url">[Android]使用自定义JUnit Rules、annotations和Resources进行单元测试（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-22T12:00:00+08:00">
                2016-08-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/22/Android-使用自定义JUnit-Rules、annotations和Resources进行单元测试（翻译）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/08/22/Android-使用自定义JUnit-Rules、annotations和Resources进行单元测试（翻译）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5795091.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5795091.html</a>
</strong></font>

<h1 id="使用自定义JUnit-Rules、annotations和Resources进行单元测试"><a href="#使用自定义JUnit-Rules、annotations和Resources进行单元测试" class="headerlink" title="使用自定义JUnit Rules、annotations和Resources进行单元测试"></a>使用自定义JUnit Rules、annotations和Resources进行单元测试</h1><blockquote>
<p>原文：<a href="http://www.thedroidsonroids.com/blog/android/unit-tests-rules-annotations-resources" target="_blank" rel="noopener">http://www.thedroidsonroids.com/blog/android/unit-tests-rules-annotations-resources</a></p>
</blockquote>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Unit Test并不只有断言和测试方法组成。它有一些可以用来提高质量和测试代码可读性的技术。在本文中我们将探索：</p>
<ul>
<li>annotations</li>
<li>JUnit rules</li>
<li>java resources</li>
</ul>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>很多或者大多数Android apps作为一个API Client，因此需要数据格式之间的转换（通常是JSON）和POJO（数据模型类）。我们不需要在自己的代码中实现一个转换引擎而是可以使用如 <a href="https://github.com/google/gson" target="_blank" rel="noopener">GSON</a> 或 <a href="https://github.com/square/moshi" target="_blank" rel="noopener">moshi</a> 等三方库来完成。</p>
<p>众所周知的库通常都是有很高的单元测试的覆盖率的，所以如下测试它们是没有意义的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGson</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="comment">//given</span></span><br><span class="line"> Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"> <span class="comment">//when</span></span><br><span class="line"> String result = gson.fromJson(<span class="string">"\"test\""</span>, String.class);</span><br><span class="line"> <span class="comment">//then</span></span><br><span class="line"> assertThat(result).isEqualTo(<span class="string">"test"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 1. 无用的GSON单元测试.</em></p>
<p>另一方面测试解析（JSON到POJO）和生成（POJO到JSON）逻辑相关的模型类可能是有用的。如下的POJO：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Contributor</span> </span>&#123;</span><br><span class="line"> <span class="keyword">public</span> String login;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">boolean</span> siteAdmin;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">long</span> id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 2. 简单POJO.</em></p>
<p>和相应的JSON：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"login"</span>: <span class="string">"koral--"</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">3340954</span>,</span><br><span class="line">    <span class="attr">"site_admin"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 3. 简单JSON.</em></p>
<p>如果属性映射都正确的话，我们希望去测试它。注意属性<code>siteAdmin</code>使用了不同的命名风格 － Java中的驼峰命名和JSON中的蛇底命名。</p>
<h2 id="简单方案"><a href="#简单方案" class="headerlink" title="简单方案"></a>简单方案</h2><p>最简单的一种unit test看起来如下：</p>
<p><span id="listing4"></span></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testParseHardcodedContributors</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> <span class="comment">//given</span></span><br><span class="line"> String json = <span class="string">"[\n"</span> +</span><br><span class="line"> <span class="string">"  &#123;\n"</span> +</span><br><span class="line"> <span class="string">"    \"login\": \"koral--\",\n"</span> +</span><br><span class="line"> <span class="string">"    \"id\": 3340954,\n"</span> +</span><br><span class="line"> <span class="string">"    \"site_admin\": true\n"</span> +</span><br><span class="line"> <span class="string">"  &#125;,\n"</span> +</span><br><span class="line"> <span class="string">"  &#123;\n"</span> +</span><br><span class="line"> <span class="string">"    \"login\": \"Wavesonics\",\n"</span> +</span><br><span class="line"> <span class="string">"    \"id\": 406473,\n"</span> +</span><br><span class="line"> <span class="string">"    \"site_admin\": false\n"</span> +</span><br><span class="line"> <span class="string">"  &#125;\n"</span> +</span><br><span class="line"> <span class="string">"]\n"</span>;</span><br><span class="line"></span><br><span class="line"> GsonBuilder gsonBuilder = <span class="keyword">new</span> GsonBuilder();</span><br><span class="line"> gsonBuilder.setFieldNamingPolicy(FieldNamingPolicy.LOWER_CASE_WITH_UNDERSCORES);</span><br><span class="line"> Gson gson = gsonBuilder.create();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//when</span></span><br><span class="line"> Contributor[] contributors;</span><br><span class="line"> <span class="keyword">try</span> (Reader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> StringReader(json))) &#123;</span><br><span class="line"> contributors = gson.fromJson(reader, Contributor[].class);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 4. 使用硬编码JSON的单元测试.</em></p>
<p>这种方法有几个弊端。最值得注意的就是比较差的JSON可读性，有大量的转义字符和没有语法高亮。此外有一点模版代码，如果有更多的JSON需要测试的话将会产生重复代码。让我们思考怎样可以用更加简便的方法来编写，提高可读性和消除代码重复率。</p>
<h2 id="改进"><a href="#改进" class="headerlink" title="改进"></a>改进</h2><p>首先<code>Gson</code>对象可以在测试方法外部实例化，比如使用一些像 [Dagger] (<a href="http://google.github.io/dagger" target="_blank" rel="noopener">http://google.github.io/dagger</a>) 的DI（依赖注入）机制或者使用一个简单的常量。DI已经超出了本文的范围所以我们在例子代码中使用后者。在代码提取后看起来如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Constants</span> </span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Gson GSON;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">static</span> &#123;</span><br><span class="line"> <span class="keyword">final</span> GsonBuilder gsonBuilder = <span class="keyword">new</span> GsonBuilder();</span><br><span class="line"> gsonBuilder.setFieldNamingPolicy(FieldNamingPolicy.LOWER_CASE_WITH_UNDERSCORES);</span><br><span class="line"> GSON = gsonBuilder.create();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 5. 把GSON实例作为一个全局变量.</em></p>
<p>接着，文本形式的JSON可以被置于一个resource file中。这会给我们带来语法的高亮和缩进（漂亮的打印），默认情况下Android Studio和Intellij IDEA内置了这些功能特性。不需要引号的转义，所以可读性也不再是问题。再者，文件中的行数和列数和GSON中的一致，所以将会更加容易地像这样debug异常：<code>MalformedJsonException: Unterminated array at line 4 column 5 path $[2]</code>。如果JSON被放置在一个单独的文件，行数是会被确切地匹配到的，跟上述硬编码JSON的例子矛盾的地方是，需要通过java源文件中的偏移进行调整。下面是这个示例中被使用的文件：</p>
<p><span id="listing6"><span></span></span></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"login"</span>: <span class="string">"koral--"</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">3340954</span>,</span><br><span class="line">    <span class="attr">"site_admin"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"login"</span>: <span class="string">"Wavesonics"</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">406473</span>,</span><br><span class="line">    <span class="attr">"site_admin"</span>: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><em>Listing 6. 包含JSON的Java resource文件.</em></p>
<p>最后，代码执行转换可以从测试方法中提取，所以广义说它会更容易在不同的测试用例上使用。它可以使用下章将会讨论的Java和JUnit特性来实现。</p>
<h2 id="Goodies"><a href="#Goodies" class="headerlink" title="Goodies"></a>Goodies</h2><h3 id="Java-resources"><a href="#Java-resources" class="headerlink" title="Java resources"></a>Java resources</h3><p>Java resources是程序需要的数据文件，它被放置在源代码外面。注意我们讨论的是 <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/lang/resources.html" target="_blank" rel="noopener">Java resources</a>，默认被放置在<code>src/&lt;source set&gt;/resources</code>，并不是 <a href="https://developer.android.com/guide/topics/resources/providing-resources.html" target="_blank" rel="noopener">Android App Resources</a>(drawables, layouts等)。这本例子中并没有Android特别的特性。所以一切都是可以像 <a href="http://robolectric.org/" target="_blank" rel="noopener">Robolectric</a> 那样脱离frameworks可单元测试的。</p>
<p>如果<a href="#listing6">listing 6</a>的JSON文件被保存于<code>src/test/resources/pl/droidsonroids/modeltesting/api/contributors.json</code>，它可以通过调用<code>TestClass.getResourceAsStream(&quot;contributors.json&quot;)</code>来被单元测试代码访问。相关的类需要被放置在对应的package中，在这个例子中是<code>pl.droidsonroids.modeltesting.api</code>。详情见<a href="https://developer.android.com/reference/java/lang/Class.html#getResourceAsStream(java.lang.String" target="_blank" rel="noopener"><strong><code>#getResourceAsStream()</code> javadoc</strong></a>)</p>
<h3 id="注解Annotation"><a href="#注解Annotation" class="headerlink" title="注解Annotation"></a>注解Annotation</h3><p><a href="http://docs.oracle.com/javase/8/docs/technotes/guides/language/annotations.html" target="_blank" rel="noopener">Annotation</a>是关联到源代码元素的元数据（eg. 方法或者类）。有众所周知的一些如<a href="https://developer.android.com/reference/java/lang/Override.html" target="_blank" rel="noopener">@Override</a>或<a href="https://developer.android.com/reference/java/lang/Deprecated.html" target="_blank" rel="noopener">@Deprecated</a>的内置注解。也可以自定义并使用它们把特定的resources绑定到测试方法中。</p>
<p>注解来起来与interface很类似：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> JsonFileResource &#123;</span><br><span class="line">	<span class="function">String <span class="title">fileName</span><span class="params">()</span></span>;</span><br><span class="line">	Class&lt;?&gt; clazz();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 7. 简单注解.</em></p>
<p>注意<code>interface</code>关键字前面的<code>@</code>符号。我们自定义的注解被2个元注解来注解。我们设置<a href="https://developer.android.com/reference/java/lang/annotation/Retention.html" target="_blank" rel="noopener">Retention</a>为<a href="https://developer.android.com/reference/java/lang/annotation/RetentionPolicy.html#RUNTIME" target="_blank" rel="noopener">RUNTIME</a>，因为注解需要在单元测试执行时（运行时）为可读，所以默认的retention（<a href="https://developer.android.com/reference/java/lang/annotation/RetentionPolicy.html#CLASS" target="_blank" rel="noopener">CLASS</a>）的并不满足。我们也需要设置<a href="https://developer.android.com/reference/java/lang/annotation/Target.html" target="_blank" rel="noopener">Target</a>为<a href="https://developer.android.com/reference/java/lang/annotation/ElementType.html#METHOD" target="_blank" rel="noopener">METHOD</a>因为我们只需要为方法进行注解（绑定特定的resource）。错位的注解会引发编译错误。没有指定一个target，注解会可以被用于任何地方。</p>
<h3 id="JUnit-Rules"><a href="#JUnit-Rules" class="headerlink" title="JUnit Rules"></a>JUnit Rules</h3><p>简单来说，<a href="https://github.com/junit-team/junit4/wiki/Rules" target="_blank" rel="noopener">rule</a>是在测试（方法）运行时触发的一个hook。我们将使用rule在测试方法执行之前增加一些额外的行为。即我们将从resources中解析JSON并提供给测试方法内部相应的POJO。我们的目标时像下面这样支持单元测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Rule</span> <span class="keyword">public</span> JsonParsingRule jsonParsingRule = <span class="keyword">new</span> JsonParsingRule(Constants.GSON);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@JsonFileResource</span>(fileName = <span class="string">"contributors.json"</span>, clazz = Contributor[].class)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetContributors</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> Contributor[] contributors = jsonParsingRule.getValue();</span><br><span class="line"> assertThat(contributors).hasSize(<span class="number">2</span>);</span><br><span class="line"> assertThat(contributors[<span class="number">0</span>].login).isEqualTo(<span class="string">"koral--"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 8. 使用自定义rule的简单测试方法.</em></p>
<p>如你所见，模版代码与<a href="#listing4">listing 4</a>相比明显地减少。只有必要的部分是类型明确的：</p>
<ul>
<li><p>GSON实例用来解析JSONs - <code>jsonParsingRule = new JsonParsingRule(Constants.GSON)</code></p>
</li>
<li><p>被放置JSON字符串的resource - <code>@JsonFileResource(fileName = &quot;contributors.json&quot;</code></p>
</li>
<li><p>POJO类 - <code>, clazz = Contributor[].class</code></p>
</li>
<li><p>POJO实例的接收 - <code>contributors = jsonParsingRule.getValue()</code></p>
</li>
</ul>
<p>注意对于测试类只需要一个<code>JsonParsingRule</code>实例。对于每个测试方法Rule会被独立计算并且在特定方法中<code>jsonParsingRule.getValue()</code>的结果不会影响到上一次测试。<strong>clazz</strong>并不是一个错字而是故意的，因为<code>class</code>是Java语言关键字并不能用做一个标识符。还有一个重要的是被<a href="http://junit.org/junit4/javadoc/latest/org/junit/Rule.html" target="_blank" rel="noopener">@Rule</a>注解的属性必须是public和非static的。</p>
<h4 id="Rule实现"><a href="#Rule实现" class="headerlink" title="Rule实现"></a>Rule实现</h4><p>看下rule实现的草案：</p>
<p><span id="listing9"></span></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonParsingRule</span> <span class="keyword">implements</span> <span class="title">TestRule</span> </span>&#123;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> Gson mGson;</span><br><span class="line"> <span class="keyword">private</span> Object mValue;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">JsonParsingRule</span><span class="params">(Gson gson)</span> </span>&#123;</span><br><span class="line"> mGson = gson;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"> <span class="function"><span class="keyword">public</span>  T <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> (T) mValue;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Statement <span class="title">apply</span><span class="params">(<span class="keyword">final</span> Statement base, <span class="keyword">final</span> Description description)</span> </span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> Statement() &#123;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evaluate</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"> <span class="comment">//TODO set mValue according to annotation</span></span><br><span class="line"> base.evaluate();</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 9. Rule骨架.</em></p>
<p>我们的rule实现了<a href="http://junit.org/junit4/javadoc/latest/org/junit/rules/TestRule.html" target="_blank" rel="noopener">TestRule</a>，因此可以使用被使用<code>@Rule</code>注解。我们使用了一个范型的getter，所以它的返回值可以被直接分配给特定类型的变量而不需要在测试方法中转型。在<code>apply()</code>方法中我们可以创建一个原始<a href="http://junit.org/junit4/javadoc/latest/org/junit/runners/model/Statement.html" target="_blank" rel="noopener">Statement</a>（测试方法）的包装。调用<code>base.evaluate()</code>被放置在最后（在注解处理之后），因此在测试方法执行过程中rule的效果是可见的。</p>
<p>现在更接近地观看statement包装的关键部分（<a href="#listing9">listing 9</a>中<code>TODO</code>的实现）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">JsonFileResource jsonFileResource = description.getAnnotation(JsonFileResource.class);</span><br><span class="line"><span class="keyword">if</span> (jsonFileResource != <span class="keyword">null</span>) &#123;</span><br><span class="line"> Class&lt;?&gt; clazz = jsonFileResource.clazz();</span><br><span class="line"> String resourceName = jsonFileResource.fileName();</span><br><span class="line"> Class&lt;?&gt; testClass = description.getTestClass();</span><br><span class="line"> InputStream in = testClass.getResourceAsStream(resourceName);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">assert</span> in != <span class="keyword">null</span> : <span class="string">"Failed to load resource: "</span> + resourceName + <span class="string">" from "</span> + testClass;</span><br><span class="line"> <span class="keyword">try</span> (Reader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in))) &#123;</span><br><span class="line"> mValue = mGson.fromJson(reader, clazz);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 10. Statement的实现.</em></p>
<p><code>description</code>参数在这里是必不可少的，它可以让我们访问测试方法包括注解在内的元数据。Rule适用于所有测试方法，包括没有注解的，这种情况下<a href="http://junit.org/junit4/javadoc/latest/org/junit/runner/Description.html#getAnnotation(java.lang.Class" target="_blank" rel="noopener">getAnnotation()</a>)会返回<code>null</code>，并且我们可以有条件地跳过定制的其余部分。所以测试方法没有<code>@JsonFileResource</code>注解的测试方法（比如，一些不涉及JSON的测试）可以放在使用了<code>JsonParsingRule</code>的测试类中。第8行是下面代码的一个<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/language/assert.html#intro" target="_blank" rel="noopener">简写等效</a>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line"> <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Failed to load resource: "</span> + resourceName + <span class="string">" from "</span> + testClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Listing 11. 断言语句判定.</em></p>
<p>最后我们传入使用被<a href="https://developer.android.com/reference/java/io/Reader.html" target="_blank" rel="noopener">Reader</a>包装的resource到GSON引擎。<a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html" target="_blank" rel="noopener">Try-with-resources</a>语句在这里被使用，所以Reader将会在读取甚至发生异常之后自动关闭。这里需要在<code>finally</code>块中明确类型。</p>
<p>注意try-with-resources从Android API 19（Kitkat）才可用。如果测试代码位于Android gradle module中，并且你的<code>minSdkVersion</code>低于19，那么你可能需要在<code>evaluate()</code>方法上增加<code>@TargetApi(Build.VERSION_CODES.KITKAT)</code>注解来避免<a href="http://tools.android.com/tips/lint-checks" target="_blank" rel="noopener">lint</a>错误。单元测试会在开发机器（Mac，PC等）上被执行而不是Android设备或者模拟器，所以这里只有<code>compileSdkVersion</code>才是关键。</p>
<p>这样的单元测试（不需要使用Android特定的API）也可以被放在java module中（<code>build.gradle</code>中<code>apply plugin: &#39;java&#39;</code>）。理论上这事最好的idea，但是在Android Studio/Intellij IDEA中有一个<a href="http://tools.android.com/knownissues#TOC-JUnit-tests-missing-resources-in-classpath-when-run-from-Studio" target="_blank" rel="noopener">问题</a>需要预防，那就是从IDE开箱即用地执行单元测试的配置工作。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/my_avatar.jpg"
                alt="Wang Jie" />
            
              <p class="site-author-name" itemprop="name">Wang Jie</p>
              <p class="site-description motion-element" itemprop="description">Wang Jie's blog</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">144</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wangjiegulu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:tiantian.china.2@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/+%E5%A4%A9%E5%A4%A9wangjie" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/wangjiegulu" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/users/2124006/wangjie" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/wangjiegulu" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i></a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.cnblogs.com/tiantianbyconan/" title="cnblog" target="_blank">cnblog</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Jie</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>








        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://blog-wangjiegulu-com.disqus.com/count.js" async></script>
    

    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "default";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "GooglePlus,Evernote,Twitter,Facebook,Douban,Weibo";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  

  

  

</body>
</html>

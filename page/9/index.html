<!DOCTYPE html>




<html class="theme-next muse" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="WAND JIE" type="application/atom+xml" />






<meta name="description" content="Wang Jie&apos;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="WAND JIE">
<meta property="og:url" content="http://blog.wangjiegulu.com/page/9/index.html">
<meta property="og:site_name" content="WAND JIE">
<meta property="og:description" content="Wang Jie&apos;s blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WAND JIE">
<meta name="twitter:description" content="Wang Jie&apos;s blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.wangjiegulu.com/page/9/"/>





  <title>WAND JIE</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-111189680-2', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WAND JIE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">TO BE AN ARTIST-ENGINNER</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2014/02/08/AndroidInject项目使用动态代理增加对网络请求的支持/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/02/08/AndroidInject项目使用动态代理增加对网络请求的支持/" itemprop="url">AndroidInject项目使用动态代理增加对网络请求的支持</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-02-08T14:32:00+08:00">
                2014-02-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/02/08/AndroidInject项目使用动态代理增加对网络请求的支持/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/02/08/AndroidInject项目使用动态代理增加对网络请求的支持/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="color: #ff0000;"><strong>以下内容为原创，欢迎转载，转载请注明</strong></span></p>
<p><span style="color: #ff0000;"><strong>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/3540427.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/3540427.html</a></strong></span></p>
<p>&nbsp;</p>
<p>AndroidInject项目是我写的一个使用注解注入来简化代码的开源项目</p>
<p><a href="https://github.com/wangjiegulu/androidInject" target="_blank" rel="noopener">https://github.com/wangjiegulu/androidInject</a></p>
<p>今天新增功能如下：</p>
<p>1. 增加@AIScreenSize注解，作用于属性，用于注入当前设备的屏幕大小（宽高）<br>2. 增加对网络请求的支持，使用动态代理实现：@AIGet注解，作用于接口方法，表示以GET来请求url；@AIPost注解，作用于接口方法，表示以POST来请求url；@AIParam，用于注入请求参数<br>3. 增加@AINetWorker注解，作用于属性，用于注入网络请求服务<br>4. 增加GET或POST请求时请求参数可使用Params类传入，简化代码</p>
<p>&nbsp;</p>
<p>主要执行代码如下：</p>
<p>用@AINetWorker注解注入NetWorker接口的子类代理（动态代理模式）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #000000;">@AINetWorker<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">private</span> PersonWorker personWorker;</pre><br></div>

<p><span style="line-height: 1.5;">然后启动线程，在线程中调用进行网络请求：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">new</span> Thread(<span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable() {<br></span><span style="color: #008080;">2</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">3</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;">4</span> <span style="color: #008000;">//</span><span style="color: #008000;">        RetMessage&lt;Person&gt; retMsg = personWorker.getPersonsForGet(“a1”, “b1”, “c1”);<br></span><span style="color: #008080;">5</span> <span style="color: #008000;">//</span><span style="color: #008000;">        RetMessage&lt;Person&gt; retMsg = personWorker.getPersonsForGet2(new Params().add(“aa”, “a1”).add(“bb”, “b1”).add(“cc”, “c1”));</span><br><span style="color: #008080;">6</span>         RetMessage&lt;Person&gt; retMsg = personWorker.getPersonsForPost2(<span style="color: #0000ff;">new</span> Params().add(“aa”, “a1”).add(“bb”, “b1”).add(“cc”, “c1”<span style="color: #000000;">));<br></span><span style="color: #008080;">7</span> <span style="color: #000000;">        System.out.println(retMsg.getList().toString());<br></span><span style="color: #008080;">8</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">9</span> }).start();</pre><br></div>

<p>请求的结果封装在RetMessage类中（AndroidInject框架所作的事就是执行Get或者Post请求，获得返回结果，然后json解析后封装在RetMessage中）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.core.net;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.google.gson.Gson;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br><br></span><span style="color: #008000;">/<em>*</em></span><span style="color: #008000;">
  Json响应结果包装类<br> <em> Created with IntelliJ IDEA.
 </em> Author: wangjie  email:tiantian.china.2@gmial.com<br> <em> Date: 14-2-7
 </em> Time: 下午4:25<br> </span><span style="color: #008000;">*/</span><br><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> RetMessage&lt;T&gt;<span style="color: #000000;"><br>{<br>    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> resultCode; <span style="color: #008000;">//</span><span style="color: #008000;"> 结果码，必须包含</span><br><br>    <span style="color: #0000ff;">private</span> List&lt;T&gt; list; <span style="color: #008000;">//</span><span style="color: #008000;"> 返回的数据</span><br><br>    <span style="color: #0000ff;">private</span> T obj; <span style="color: #008000;">//</span><span style="color: #008000;"> 返回的数据</span><br><br>    <span style="color: #0000ff;">private</span> Integer size; <span style="color: #008000;">//</span><span style="color: #008000;"> 返回数据长度</span><br><br>    <span style="color: #0000ff;">private</span> String errorMessage; <span style="color: #008000;">//</span><span style="color: #008000;"> 返回错误信息</span><br><br>    <span style="color: #0000ff;">public</span><span style="color: #000000;"> String toJson(){<br>        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span> Gson().toJson(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br>    }<br>    </span><span style="color: #008000;">//</span><span style="color: #008000;"> getter和setter方法省略…</span><span style="color: #000000;"><br>}</span></pre><br></div>

<p>接下来看下PersonWorker接口中所作的事情：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.androidinject;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.annotations.net.AIGet;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.annotations.net.AIParam;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.annotations.net.AIPost;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.core.net.RetMessage;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.util.Params;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.model.Person;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">11</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;">12</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">13</span> <span style="color: #008000;">  Date: 14-2-7<br></span><span style="color: #008080;">14</span> <span style="color: #008000;"> <em> Time: 下午1:44<br></em></span><span style="color: #008080;">15</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> PersonWorker {<br></span><span style="color: #008080;">17</span>     @AIGet(“<a href="http://192.168.2.198:8080/HelloSpringMVC/person/findPersons?aa=#{a3}&amp;bb=#{b3}&amp;cc=#{c3}" target="_blank" rel="noopener">http://192.168.2.198:8080/HelloSpringMVC/person/findPersons?aa=#{a3}&amp;bb=#{b3}&amp;cc=#{c3}</a>“<span style="color: #000000;">)<br></span><span style="color: #008080;">18</span>     <span style="color: #0000ff;">public</span> RetMessage&lt;Person&gt; getPersonsForGet(@AIParam(“a3”)String a2, @AIParam(“b3”) String b2, @AIParam(“c3”<span style="color: #000000;">) String c2);<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>     @AIPost(“<a href="http://192.168.2.198:8080/HelloSpringMVC/person/findPersons" target="_blank" rel="noopener">http://192.168.2.198:8080/HelloSpringMVC/person/findPersons</a>“<span style="color: #000000;">)<br></span><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span> RetMessage&lt;Person&gt; getPersonsForPost(@AIParam(“aa”)String a2, @AIParam(“bb”) String b2, @AIParam(“cc”<span style="color: #000000;">) String c2);<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span>     @AIGet(“<a href="http://192.168.2.198:8080/HelloSpringMVC/person/findPersons" target="_blank" rel="noopener">http://192.168.2.198:8080/HelloSpringMVC/person/findPersons</a>“<span style="color: #000000;">)<br></span><span style="color: #008080;">24</span>     <span style="color: #0000ff;">public</span> RetMessage&lt;Person&gt;<span style="color: #000000;"> getPersonsForGet2(Params params);<br></span><span style="color: #008080;">25</span><br><span style="color: #008080;">26</span>     @AIPost(“<a href="http://192.168.2.198:8080/HelloSpringMVC/person/findPersons" target="_blank" rel="noopener">http://192.168.2.198:8080/HelloSpringMVC/person/findPersons</a>“<span style="color: #000000;">)<br></span><span style="color: #008080;">27</span>     <span style="color: #0000ff;">public</span> RetMessage&lt;Person&gt;<span style="color: #000000;"> getPersonsForPost2(Params params);<br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span> }</pre><br></div>

<p>PersonWorker是自己写的一个接口（以后需要有新的网络请求，都可以类似编写Worker），声明了执行网络请求的各种方法，这些方法需要加上@AIGet或者@AIPost注解，用于声明请求方式，并在此注解中的value()值设置为所要请求的url（此注解的其他属性后续会陆续扩展）</p>
<p>方法的@AIParam注解是作用与mybatis的@Param注解类似，可以设置请求携带的参数</p>
<p>如果参数比较多，则推荐使用Params来存放参数，以此来简化代码，Params类实质上就是一个HashMap，存放参数的键值对即可。</p>
<p>&nbsp;</p>
<p>接下来分析下框架是怎么实现的，其实上面讲过，主要是用Annotaion和动态代理了</p>
<p>首先看看PersonWorker的注入，在AIActivity（AIActivity，AndroidInject开源项目中的Activity使用注解的话，你写的Activity必须继承AIActivity，另外如果要使用FragmentActivity，则需要继承AISupportFragmentActivity）启动时，首先会去解析添加的注解，这里讨论@AINetWorker注解，内部代码很简单：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">2</span> <span style="color: #008000;">  注入NetWorker<br></span><span style="color: #008080;">3</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> field<br></span><span style="color: #008080;">4</span> <span style="color: #008000;">  </span><span style="color: #808080;">@throws</span><span style="color: #008000;"> Exception<br></span><span style="color: #008080;">5</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;">6</span>  <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> netWorkerBind(Field field) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception{<br></span><span style="color: #008080;">7</span>         field.setAccessible(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">8</span> <span style="color: #000000;">        field.set(present, NetInvoHandler.getWorker(field.getType()));<br></span><span style="color: #008080;">9</span>  }</pre><br></div>

<p>通过代码可知，是使用反射来实现的，主要的代码是这句：</p>
<div class="cnblogs_code"><br><pre>NetInvoHandler.getWorker(field.getType());</pre><br></div>

<p>这句代码的作用是通过Class获得一个PersonWorker实现类的代理对象，这里很明显是使用了动态代理。</p>
<p>所以，最核心的类应该是NetInvoHandler这个类，这个类的代码如下（篇幅问题，所以就折叠了）：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('7d38bbca-82a1-429f-a5c2-68b2ebe85e58')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_7d38bbca-82a1-429f-a5c2-68b2ebe85e58" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.core.net;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.text.TextUtils;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.google.gson.Gson;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.annotations.net.AIGet;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.annotations.net.AIParam;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.annotations.net.AIPost;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.util.Params;<br></span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.util.StringUtil;<br></span><span style="color: #008080;"> 10</span><br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.annotation.Annotation;<br></span><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.InvocationHandler;<br></span><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Method;<br></span><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Proxy;<br></span><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashMap;<br></span><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;<br></span><span style="color: #008080;"> 17</span><br><span style="color: #008080;"> 18</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 19</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;"> 20</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;"> 21</span> <span style="color: #008000;">  Date: 14-2-7<br></span><span style="color: #008080;"> 22</span> <span style="color: #008000;"> <em> Time: 下午1:40<br></em></span><span style="color: #008080;"> 23</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 24</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> NetInvoHandler <span style="color: #0000ff;">implements</span><span style="color: #000000;"> InvocationHandler{<br></span><span style="color: #008080;"> 25</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> HashMap&lt;Class&lt;?&gt;, NetInvoHandler&gt; invoHandlers = <span style="color: #0000ff;">new</span> HashMap&lt;Class&lt;?&gt;, NetInvoHandler&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;"> 26</span><br><span style="color: #008080;"> 27</span>     <span style="color: #0000ff;">private</span> Object proxy; <span style="color: #008000;">//</span><span style="color: #008000;"> 代理对象</span><br><span style="color: #008080;"> 28</span><br><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">synchronized</span>  <span style="color: #0000ff;">static</span>&lt;T&gt; T getWorker(Class&lt;T&gt;<span style="color: #000000;"> clazz){<br></span><span style="color: #008080;"> 30</span>         NetInvoHandler netInvoHandler =<span style="color: #000000;"> invoHandlers.get(clazz);<br></span><span style="color: #008080;"> 31</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> netInvoHandler){<br></span><span style="color: #008080;"> 32</span>             netInvoHandler = <span style="color: #0000ff;">new</span><span style="color: #000000;"> NetInvoHandler();<br></span><span style="color: #008080;"> 33</span>             netInvoHandler.setProxy(Proxy.newProxyInstance(clazz.getClassLoader(), <span style="color: #0000ff;">new</span><span style="color: #000000;"> Class[]{clazz}, netInvoHandler));<br></span><span style="color: #008080;"> 34</span> <span style="color: #000000;">            invoHandlers.put(clazz, netInvoHandler);<br></span><span style="color: #008080;"> 35</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 36</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> (T)netInvoHandler.getProxy();<br></span><span style="color: #008080;"> 37</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 38</span><br><span style="color: #008080;"> 39</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 40</span>     <span style="color: #0000ff;">public</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Throwable {<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> get请求</span><br><span style="color: #008080;"> 43</span>         <span style="color: #0000ff;">if</span>(method.isAnnotationPresent(AIGet.<span style="color: #0000ff;">class</span><span style="color: #000000;">)){<br></span><span style="color: #008080;"> 44</span>             AIGet aiGet = method.getAnnotation(AIGet.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 45</span>             String url =<span style="color: #000000;"> aiGet.value();<br></span><span style="color: #008080;"> 46</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(url)){<br></span><span style="color: #008080;"> 47</span>                 <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(“net work [“ + method.getName() + “]@AIGet value()[url] is empty!!”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 48</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 49</span>             Annotation[][] annotaions =<span style="color: #000000;"> method.getParameterAnnotations();<br></span><span style="color: #008080;"> 50</span>             <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; args.length; i++<span style="color: #000000;">){<br></span><span style="color: #008080;"> 51</span>                 <span style="color: #0000ff;">if</span>(Params.<span style="color: #0000ff;">class</span>.isAssignableFrom(args[i].getClass())){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果属性为Params，则追加在后面</span><br><span style="color: #008080;"> 52</span>                     url =<span style="color: #000000;"> StringUtil.appendParamsAfterUrl(url, (Params)args[i]);<br></span><span style="color: #008080;"> 53</span>                 }<span style="color: #0000ff;">else</span>{ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果属性添加了@AIParam注解，则替换链接中#{xxx}</span><br><span style="color: #008080;"> 54</span>                     String repName = ((AIParam)annotaions[i][0<span style="color: #000000;">]).value();<br></span><span style="color: #008080;"> 55</span>                     url = url.replace(“#{“ + repName + “}”, args[i] + “”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 57</span><br><span style="color: #008080;"> 58</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 59</span>             StringBuilder sb =<span style="color: #000000;"> NetWork.getStringFromUrl(url);<br></span><span style="color: #008080;"> 60</span>             <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> sb){<br></span><span style="color: #008080;"> 61</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 62</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 63</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Gson().fromJson(sb.toString(), method.getReturnType());<br></span><span style="color: #008080;"> 64</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 65</span><br><span style="color: #008080;"> 66</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> post请求</span><br><span style="color: #008080;"> 67</span>         <span style="color: #0000ff;">if</span>(method.isAnnotationPresent(AIPost.<span style="color: #0000ff;">class</span><span style="color: #000000;">)){<br></span><span style="color: #008080;"> 68</span>             AIPost aiPost = method.getAnnotation(AIPost.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 69</span>             String url =<span style="color: #000000;"> aiPost.value();<br></span><span style="color: #008080;"> 70</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(url)){<br></span><span style="color: #008080;"> 71</span>                 <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Exception(“net work [“ + method.getName() + “]@AIPost value()[url] is empty!!”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 72</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 73</span>             Annotation[][] annotaions =<span style="color: #000000;"> method.getParameterAnnotations();<br></span><span style="color: #008080;"> 74</span>             Map&lt;String, String&gt; map = <span style="color: #0000ff;">new</span> HashMap&lt;String, String&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;"> 75</span>             <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; args.length; i++<span style="color: #000000;">){<br></span><span style="color: #008080;"> 76</span>                 <span style="color: #0000ff;">if</span>(Params.<span style="color: #0000ff;">class</span>.isAssignableFrom(args[i].getClass())){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果属性为Params，则追加在后面</span><br><span style="color: #008080;"> 77</span> <span style="color: #000000;">                    map.putAll((Params)args[i]);<br></span><span style="color: #008080;"> 78</span>                 }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 79</span>                     String repName = ((AIParam)annotaions[i][0<span style="color: #000000;">]).value();<br></span><span style="color: #008080;"> 80</span>                     map.put(repName, args[i] + “”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 81</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 82</span><br><span style="color: #008080;"> 83</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 84</span>             StringBuilder sb =<span style="color: #000000;"> NetWork.postStringFromUrl(url, map);<br></span><span style="color: #008080;"> 85</span>             <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> sb){<br></span><span style="color: #008080;"> 86</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 87</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 88</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Gson().fromJson(sb.toString(), method.getReturnType());<br></span><span style="color: #008080;"> 89</span><br><span style="color: #008080;"> 90</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 91</span><br><span style="color: #008080;"> 92</span><br><span style="color: #008080;"> 93</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 95</span><br><span style="color: #008080;"> 96</span><br><span style="color: #008080;"> 97</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Object getProxy() {<br></span><span style="color: #008080;"> 98</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> proxy;<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">100</span><br><span style="color: #008080;">101</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setProxy(Object proxy) {<br></span><span style="color: #008080;">102</span>         <span style="color: #0000ff;">this</span>.proxy =<span style="color: #000000;"> proxy;<br></span><span style="color: #008080;">103</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">104</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>里面的代码还没有好好的重构，所以，看起来会更直白，该类实现了InvocationHandler，很明显的动态代理。</p>
<p>我们通过NetInvoHandler的getWorker静态方法，来获取一个指定Class的Worker实现类的代理对象，由于实际应用时，Worker接口应该会很多，为了不重复生成相同Worker实现类的代理对象，所以这里在生成一个后，保存起来，确保一个Worker只生成一个代理对象，一个NetInvoHandler。</p>
<p>这里有个地方需要注意一下，以前使用的动态代理，需要一个RealSubject，也就是真实对象，是Worker的实现类。这样，在invoke方法中就可以调用真实对象的对应方法了，但是现在，进行网络请求，我们没有去写一个类然后实现PersonWorker接口，因为没有必要，我们完全可以在invoke方法中去执行相同的网络请求。</p>
<p>请想下，之所以需要框架的存在 不就是为了把一些模板的东西给简化掉么？现在的网络请求这些步骤就是一些模板话的东西，我们需要的就是调用方法，自动进行网络请求（框架做的事），然后返回给我结果。所以网络请求这一步，写在invoke方法中即可。</p>
<p>而不是所谓的编写一个类，实现PersonWorker接口，在这个实现类中进行网络请求，然后在invoke方法中调用真实对象的对应该方法。</p>
<p>因此，在Proxy.newProxyInstance的interfaces中填写需要实现的接口，也就是现在的PersonWorker。</p>
<p>&nbsp;</p>
<p>接下来看下invoke中做的事情，首先根据方法增加的注解来识别是GET请求还是POST请求。然后各自执行请求（因为我请求的执行，写在NetWork中了，这里直接返回了请求结果字符串StringBuilder sb）。</p>
<p>接下来，使用Gson这个霸气的工具，一键从json解析封装成RetMessage对象。（所以，这里是需要Gson库的支持，大家网上下载gson.jar，或者使用maven）</p>
<p>当然，要使用Gson一键解析封装的前提是服务器端的编写需要保存一致性，下面是我服务器端测试的代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> @RequestMapping(“/findPersons”<span style="color: #000000;">)<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> findPersons(HttpServletRequest request, HttpServletResponse response,<br></span><span style="color: #008080;"> 3</span>                                 @RequestParam(“aa”<span style="color: #000000;">) String aa,<br></span><span style="color: #008080;"> 4</span>                                 @RequestParam(“bb”<span style="color: #000000;">) String bb,<br></span><span style="color: #008080;"> 5</span>                                 @RequestParam(“cc”) String cc) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException{<br></span><span style="color: #008080;"> 6</span>         System.out.println(“aa: “ + aa + “, bb: “ + bb + “, cc: “ +<span style="color: #000000;"> cc);<br></span><span style="color: #008080;"> 7</span>         RetMessage&lt;Person&gt; rm = <span style="color: #0000ff;">new</span> RetMessage&lt;Person&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>         rm.setResultCode(0<span style="color: #000000;">);<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span>         List&lt;Person&gt; persons = <span style="color: #0000ff;">new</span> ArrayList&lt;Person&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; 5; i++<span style="color: #000000;">){<br></span><span style="color: #008080;">13</span>             Person p = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Person();<br></span><span style="color: #008080;">14</span>             p.setName(“wangjie_” +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">15</span>             p.setAge(20 +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">            persons.add(p);<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> <span style="color: #000000;">        rm.setList(persons);<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> <span style="color: #000000;">        ServletUtil.obtinUTF8JsonWriter(response).write(rm.toJson());<br></span><span style="color: #008080;">22</span>     }</pre><br></div>

<p>服务器端返回结果时，也是封装在RetMessage类中，这个类服务器端和客户端是保持一致的，所以可以一键转换。</p>
<p>如果你在开发的过程中，RetMessage类中封装的东西不能满足你的需求，可以自己编写结果类，当然在Worker中声明方法中返回值就应该是你写的结果类了。</p>
<p>&nbsp;</p>
<p>到此为止，讲解完毕</p>
<p>另：如果，你需要写一个查询User信息的网络请求，应该怎么写？</p>
<p>只需编写UserWorker接口，然后声明方法findUsers()，写上@AIGet或者@AIPost注解，写明url和请求参数。然后通过@AINetWorker注解注入userWorker，然后开启线程，调用userWorker的findUsers()方法即可。</p>
<p>当然UserWorker也可以不使用注解获得，而是调用&ldquo;NetInvoHandler.getWorker(UserWorker.class)&rdquo;获得！</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2013/12/05/android-AndroidInject框架——我的第一个android小型框架/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/12/05/android-AndroidInject框架——我的第一个android小型框架/" itemprop="url">[android]AndroidInject框架——我的第一个android小型框架</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-12-05T11:17:00+08:00">
                2013-12-05
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2013/12/05/android-AndroidInject框架——我的第一个android小型框架/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2013/12/05/android-AndroidInject框架——我的第一个android小型框架/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作为一个移动应用开发者，随着需求的日益增多，Android项目的越来越臃肿，代码量越来越大，</p>
<p>现在冷静下来回头看看我们的代码，有多少代码跟业务逻辑没什么关系的</p>
<p>&nbsp;</p>
<p>所以，本人自不量力，在github上建了个开源项目，希望能一定程度地简化我的代码-。-</p>
<p>现在第一个版本完成，希望有兴趣的朋友能加入一起完善。</p>
<p>本人才疏学浅，代码中有写得不妥的地方希望大家不吝赐教哈！</p>
<p><strong>github地址：</strong></p>
<p><a href="https://github.com/wangjiegulu/androidInject" target="_blank" rel="noopener">https://github.com/wangjiegulu/androidInject</a></p>
<p><strong>androidInject_1.0.jar：</strong></p>
<p><a href="http://pan.baidu.com/s/1rcSiy" target="_blank" rel="noopener">http://pan.baidu.com/s/1rcSiy</a></p>
<p>&nbsp;</p>
<p>主要的思想就是通过注解的方式，把我们要做的事情直接注入进来给我们，&ldquo;不是我去调用对象，而是对象自己来找我&rdquo;</p>
<p>现在刚写完了10个注解：</p>
<p>@AINoTitle， @AIFullScreen， @AILayout， @AIView， @AIBean， @AISystemService， @AIClick， @AIItemClick， @AILongClick， @AIItemLongClick</p>
<p>使用方法如下：</p>
<p>Activity中使用：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('519219a9-a150-4491-a51e-2962ccedc68e')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_519219a9-a150-4491-a51e-2962ccedc68e" class="cnblogs_code_hide"><br><pre><span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.androidinject;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.app.AlarmManager;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Intent;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.location.LocationManager;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.LayoutInflater;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #0000ff;">import</span> android.widget.<em><span style="color: #000000;">;<br></span><span style="color: #0000ff;">import</span> com.wangjie.androidinject.annotation.annotations.</em><span style="color: #000000;">;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.present.AIActivity;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.model.Person;<br><br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashMap;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;<br><br>@AIFullScreen<br>@AINoTitle<br>@AILayout(R.layout.main)<br></span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> AIActivity{<br><br>    @AIView(id </span>= R.id.btn1, clickMethod = “onClickCallback”, longClickMethod = “onLongClickCallback”<span style="color: #000000;">)<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Button btn1;<br><br>    @AIView(clickMethod </span>= “onClickCallback”, longClickMethod = “onLongClickCallback”<span style="color: #000000;">)<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Button btn2;<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;">    @AIView(id = R.id.btn3)<br></span><span style="color: #008000;">//</span><span style="color: #008000;">    private Button btn3;<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;">    @AIView(id = R.id.listView, itemClickMethod = “onItemClickCallback”, itemLongClickMethod = “onItemLongClickCallbackForListView”)</span><br>    @AIView(id =<span style="color: #000000;"> R.id.listView)<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> ListView listView;<br><br>    @AIBean<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Person person;<br><br>    @AISystemService<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> AlarmManager alarmManager;<br>    @AISystemService<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> LocationManager locationManager;<br>    @AISystemService<br>    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> LayoutInflater inflater;<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br>        </span><span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br><br>        List</span>&lt;Map&lt;String, String&gt;&gt; list = <span style="color: #0000ff;">new</span> ArrayList&lt;Map&lt;String, String&gt;&gt;<span style="color: #000000;">();<br>        Map</span>&lt;String, String&gt;<span style="color: #000000;"> map;<br>        </span><span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; 10; i++<span style="color: #000000;">){<br>            map </span>= <span style="color: #0000ff;">new</span> HashMap&lt;String, String&gt;<span style="color: #000000;">();<br>            map.put(</span>“title”, “item_” +<span style="color: #000000;"> i);<br>            list.add(map);<br>        }<br><br>        SimpleAdapter adapter </span>= <span style="color: #0000ff;">new</span> SimpleAdapter(context, list, R.layout.list_item, <span style="color: #0000ff;">new</span> String[]{“title”}, <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">int</span><span style="color: #000000;">[]{R.id.list_item_title_tv});<br>        listView.setAdapter(adapter);<br><br>        person.setName(</span>“wangjie”<span style="color: #000000;">);<br>        person.setAge(</span>23<span style="color: #000000;">);<br>        System.out.println(person.toString());<br><br>        System.out.println(</span>“alarmManager: “ + alarmManager + “, locationManager: “ + locationManager + “, inflater: “ +<span style="color: #000000;"> inflater);<br><br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClickCallback(View view){<br>        </span><span style="color: #0000ff;">if</span>(view <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> Button){<br>            Toast.makeText(context, </span>“onClickCallback: “ +<span style="color: #000000;"> ((Button)view).getText(), Toast.LENGTH_SHORT).show();<br>        }<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onLongClickCallback(View view){<br>        </span><span style="color: #0000ff;">if</span>(view <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> Button){<br>            Toast.makeText(context, </span>“onLongClickCallback: “ +<span style="color: #000000;"> ((Button)view).getText(), Toast.LENGTH_SHORT).show();<br>        }<br>    }<br><br>    @Override<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onItemClickCallback(AdapterView&lt;?&gt; adapterView, View view, <span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">long</span><span style="color: #000000;"> l) {<br>        Toast.makeText(context, </span>“onItemClickCallback: “ + ((Map&lt;String, String&gt;)adapterView.getAdapter().getItem(i)).get(“title”<span style="color: #000000;">), Toast.LENGTH_SHORT).show();<br>    }<br><br>    @AIClick({R.id.btn3, R.id.toFragmentBtn})<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClickCallbackForBtn3(View view){<br>        </span><span style="color: #0000ff;">if</span>(view <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> Button){<br>            Toast.makeText(context, </span>“onClickForBtn3: “ +<span style="color: #000000;"> ((Button)view).getText(), Toast.LENGTH_SHORT).show();<br>        }<br><br>        </span><span style="color: #0000ff;">if</span>(view.getId() ==<span style="color: #000000;"> R.id.toFragmentBtn){<br>            startActivity(</span><span style="color: #0000ff;">new</span> Intent(context, SecendActivity.<span style="color: #0000ff;">class</span><span style="color: #000000;">));<br>        }<br><br>    }<br><br>    @AILongClick({R.id.btn3})<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onLongClickCallbackForBtn3(View view){<br>        </span><span style="color: #0000ff;">if</span>(view <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> Button){<br>            Toast.makeText(context, </span>“onLongClickCallbackForBtn3: “ +<span style="color: #000000;"> ((Button)view).getText(), Toast.LENGTH_SHORT).show();<br>        }<br>    }<br><br>    @AIItemClick({R.id.listView})<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onItemClickCallbackForListView(AdapterView&lt;?&gt; adapterView, View view, <span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">long</span><span style="color: #000000;"> l){<br>        Toast.makeText(context, </span>“onItemClickCallbackForListView: “ + ((Map&lt;String, String&gt;)adapterView.getAdapter().getItem(i)).get(“title”<span style="color: #000000;">), Toast.LENGTH_SHORT).show();<br>    }<br><br>    @AIItemLongClick(R.id.listView)<br>    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span> onItemLongClickCallbackForListView(AdapterView&lt;?&gt; adapterView, View view, <span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">long</span><span style="color: #000000;"> l) {<br>        Toast.makeText(context, </span>“onItemLongClickCallbackForListView: “ + ((Map&lt;String, String&gt;)adapterView.getAdapter().getItem(i)).get(“title”<span style="color: #000000;">), Toast.LENGTH_SHORT).show();<br>        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br>    }<br><br>}</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>Fragment中使用：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('456512ad-1927-42c5-b337-ab7c6067fadc')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_456512ad-1927-42c5-b337-ab7c6067fadc" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.androidinject;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.app.AlarmManager;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span> android.widget.<em><span style="color: #000000;">;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span> com.wangjie.androidinject.annotation.annotations.</em><span style="color: #000000;">;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.annotation.present.AISupportFragment;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidinject.model.Person;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;">12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashMap;<br></span><span style="color: #008080;">13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;">14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">17</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;">18</span> <span style="color: #008000;"> <em> Author: wangjie  email:wangjie@cyyun.com<br></em></span><span style="color: #008080;">19</span> <span style="color: #008000;">  Date: 13-12-4<br></span><span style="color: #008080;">20</span> <span style="color: #008000;"> <em> Time: 下午4:37<br></em></span><span style="color: #008080;">21</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">22</span> <span style="color: #000000;">@AILayout(R.layout.fragment_a)<br></span><span style="color: #008080;">23</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> FragmentA <span style="color: #0000ff;">extends</span><span style="color: #000000;"> AISupportFragment{<br></span><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span> <span style="color: #000000;">    @AIView<br></span><span style="color: #008080;">26</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Button fragmentABtn1;<br></span><span style="color: #008080;">27</span><br><span style="color: #008080;">28</span> <span style="color: #000000;">    @AIView<br></span><span style="color: #008080;">29</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> GridView fragmentGv;<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span> <span style="color: #000000;">    @AIBean<br></span><span style="color: #008080;">32</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Person person;<br></span><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span> <span style="color: #000000;">    @AISystemService<br></span><span style="color: #008080;">35</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> AlarmManager alarmManager;<br></span><span style="color: #008080;">36</span><br><span style="color: #008080;">37</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">38</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onActivityCreated(Bundle savedInstanceState) {<br></span><span style="color: #008080;">39</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onActivityCreated(savedInstanceState);<br></span><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span>         List&lt;Map&lt;String, String&gt;&gt; list = <span style="color: #0000ff;">new</span> ArrayList&lt;Map&lt;String, String&gt;&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">42</span>         Map&lt;String, String&gt;<span style="color: #000000;"> map;<br></span><span style="color: #008080;">43</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; 10; i++<span style="color: #000000;">){<br></span><span style="color: #008080;">44</span>             map = <span style="color: #0000ff;">new</span> HashMap&lt;String, String&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">45</span>             map.put(“title”, “fragment<em>item</em>“ +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">46</span> <span style="color: #000000;">            list.add(map);<br></span><span style="color: #008080;">47</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">48</span><br><span style="color: #008080;">49</span>         SimpleAdapter adapter = <span style="color: #0000ff;">new</span> SimpleAdapter(context, list, R.layout.list_item, <span style="color: #0000ff;">new</span> String[]{“title”}, <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">int</span><span style="color: #000000;">[]{R.id.list_item_title_tv});<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">        fragmentGv.setAdapter(adapter);<br></span><span style="color: #008080;">51</span><br><span style="color: #008080;">52</span>         person.setName(“androidInject”<span style="color: #000000;">);<br></span><span style="color: #008080;">53</span>         person.setAge(1<span style="color: #000000;">);<br></span><span style="color: #008080;">54</span> <span style="color: #000000;">        System.out.println(person.toString());<br></span><span style="color: #008080;">55</span><br><span style="color: #008080;">56</span>         System.out.println(“alarmManager: “ +<span style="color: #000000;"> alarmManager);<br></span><span style="color: #008080;">57</span><br><span style="color: #008080;">58</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">59</span><br><span style="color: #008080;">60</span> <span style="color: #000000;">    @AIClick(R.id.fragmentABtn1)<br></span><span style="color: #008080;">61</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> btnOnclick(View view){<br></span><span style="color: #008080;">62</span>         <span style="color: #0000ff;">if</span>(view <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> Button){<br></span><span style="color: #008080;">63</span>             Toast.makeText(context, “btnOnclick: “ +<span style="color: #000000;"> ((Button)view).getText(), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">64</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">65</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">66</span><br><span style="color: #008080;">67</span> <span style="color: #000000;">    @AILongClick(R.id.fragmentABtn1)<br></span><span style="color: #008080;">68</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> btnOnLongClick(View view){<br></span><span style="color: #008080;">69</span>         <span style="color: #0000ff;">if</span>(view <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> Button){<br></span><span style="color: #008080;">70</span>             Toast.makeText(context, “btnOnLongClick: “ +<span style="color: #000000;"> ((Button)view).getText(), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">71</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">72</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">73</span><br><span style="color: #008080;">74</span> <span style="color: #000000;">    @AIItemClick(R.id.fragmentGv)<br></span><span style="color: #008080;">75</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> gvOnItemClick(AdapterView&lt;?&gt; adapterView, View view, <span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">long</span><span style="color: #000000;"> l){<br></span><span style="color: #008080;">76</span>         Toast.makeText(context, “gvOnItemClick: “ + ((Map&lt;String, String&gt;)adapterView.getAdapter().getItem(i)).get(“title”<span style="color: #000000;">), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">77</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">78</span><br><span style="color: #008080;">79</span> <span style="color: #000000;">    @AIItemLongClick(R.id.fragmentGv)<br></span><span style="color: #008080;">80</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> gvOnItemLongClick(AdapterView&lt;?&gt; adapterView, View view, <span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">long</span><span style="color: #000000;"> l){<br></span><span style="color: #008080;">81</span>         Toast.makeText(context, “gvOnItemLongClick: “ + ((Map&lt;String, String&gt;)adapterView.getAdapter().getItem(i)).get(“title”<span style="color: #000000;">), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">82</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">83</span><br><span style="color: #008080;">84</span><br><span style="color: #008080;">85</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>&nbsp;</p>
<p>具体注解如下：</p>
<p>@AINoTitle: 类注解, 只适用于Activity(需继承于AIActivity), 设置Activity不显示Title</p>
<p>@AIFullScreen: 类注解, 只适用于Activity(需继承于AIActivity), 设置Activity全屏</p>
<p> @AILayout: 类注解<br>            value[int]: 用于设置该Activity的布局 —- setContentView(resId);</p>
<pre><code>@AIView: 属性注解
    id[int]: 用于绑定控件 ---- findViewById(resId);(default identifier[R.id.{field name}] if did not set id)
    clickMethod[String]: 用于设置控件点击事件的回调方法, 可选, 方法名称任意, 参数必须为(View view)
    longClickMethod[String]: 用于设置控件长按的回调方法, 可选, 方法名任意, 参数必须为(View view)
    itemClickMethod[String]: 用于设置控件item点击的回调方法, 可选, 方法名任意, 参数必须为(AdapterView, View, int, long)
    itemLongClickMethod[String]: 用于设置控件item长按的回调方法, 可选, 方法名任意, 参数必须为(AdapterView, View, int, long)

@AIBean: 属性注解, 为该属性生成一个对象并注入, 该对象必须有个默认的不带参数的构造方法

@AISystemService: 属性注解，为该属性注入系统服务对象

@AIClick: 方法注解
    value[int[], 所要绑定控件的id]: 用于绑定控件点击事件的回调方法, 方法名称任意, 参数必须为(View view)

@AIItemClick: 方法注解
    value[int[], 所要绑定控件的id]: 用于绑定控件item点击事件的回调方法, 方法名称任意, 参数必须为(AdapterView, View, int, long)

@AILongClick: 方法注解
    value[int[], 所要绑定控件的id]: 用于绑定控件长按事件的回调方法, 方法名称任意, 参数必须为(View view)

@AIItemLongClick: 方法注解
    value[int[], 所要绑定控件的id]: 用于绑定控件item长按事件的回调方法, 方法名称任意, 参数必须为(AdapterView, View, int, long)
</code></pre><p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2013/11/08/ios7-tableview被navigationbar挡住/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/11/08/ios7-tableview被navigationbar挡住/" itemprop="url">ios7 tableview被navigationbar挡住</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-11-08T13:44:00+08:00">
                2013-11-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2013/11/08/ios7-tableview被navigationbar挡住/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2013/11/08/ios7-tableview被navigationbar挡住/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><pre class="lang-c prettyprint prettyprinted"><span>用ego下拉刷新的时候，每次在ios7时，tableview都会上移。。。导致被navagationbar挡住。<br>ios6是正常的，于是在init的时候添加如下代码。。。</span></pre></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> NSComparisonResult order = [[UIDevice currentDevice].systemVersion compare: <span style="color: #800000;">@”</span><span style="color: #800000;">7.0</span><span style="color: #800000;">“</span><span style="color: #000000;"> options: NSNumericSearch];<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">if</span> (order == NSOrderedSame || order ==<span style="color: #000000;"> NSOrderedDescending)<br></span><span style="color: #008080;">3</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">4</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> OS version &gt;= 7.0</span><br><span style="color: #008080;">5</span>     self.edgesForExtendedLayout =<span style="color: #000000;"> UIRectEdgeNone;<br></span><span style="color: #008080;">6</span> }</pre><br></div>

<p>&nbsp;</p>
<p>转自：<a href="http://www.cnblogs.com/x1957/archive/2013/09/29/3345264.html" target="_blank" rel="noopener">http://www.cnblogs.com/x1957/archive/2013/09/29/3345264.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2013/11/06/【ios】使用Block对POST异步操作的简单封装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/11/06/【ios】使用Block对POST异步操作的简单封装/" itemprop="url">【ios】使用Block对POST异步操作的简单封装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-11-06T06:35:00+08:00">
                2013-11-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2013/11/06/【ios】使用Block对POST异步操作的简单封装/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2013/11/06/【ios】使用Block对POST异步操作的简单封装/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="color: #ff0000;"><strong>以下内容为原创，欢迎转载，转载请注明</strong></span></p>
<p><span style="color: #ff0000;"><strong>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/3409721.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/3409721.html</a></strong></span></p>
<p>一般情况下的POST异步操作需要实现以下几步：</p>
<p>1. 在controller.h上实现&lt;NSURLConnectionDataDelegate&gt;协议</p>
<p>2. 实现协议的几个方法，</p>
<ul>
<li><p>(<span class="s1">void</span>)connection:(<span class="s2">NSURLConnection</span> <em>)connection didReceiveResponse:(<span class="s2">NSURLResponse</span> </em>)response</p>
</li>
<li><p>(<span class="s1">void</span>)connection:(<span class="s2">NSURLConnection</span> <em>)connection didReceiveData:(<span class="s2">NSData</span> </em>)data</p>
</li>
<li><p>(<span class="s1">void</span>)connectionDidFinishLoading:(<span class="s2">NSURLConnection</span> *)connection</p>
</li>
</ul>
<p>3. 编写执行post请求的代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> NSURL <em>url = [NSURL URLWithString:urlStr]; <span style="color: #008000;">//</span><span style="color: #008000;"> 生成NSURL对象<br></span><span style="color: #008080;">2</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 生成Request请求对象（并设置它的缓存协议、网络请求超时配置）</span><br><span style="color: #008080;">3</span>     NSMutableURLRequest </em>request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:<span style="color: #800080;">30</span><span style="color: #000000;">];<br></span><span style="color: #008080;">4</span><br><span style="color: #008080;">5</span>     [request setHTTPBody:[<span style="color: #0000ff;">params</span> dataUsingEncoding:NSUTF8StringEncoding]]; <span style="color: #008000;">//</span><span style="color: #008000;"> 设置请求参数<br></span><span style="color: #008080;">6</span><br><span style="color: #008080;">7</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 执行请求连接</span><br><span style="color: #008080;">8</span>     NSURLConnection *conn = [[NSURLConnection alloc] initWithRequest:request <span style="color: #0000ff;">delegate</span>:executorDelegate];</pre><br></div>

<p>&nbsp;</p>
<p>如果controller有很多异步操作，处理就会很麻烦，而且，很多时候我们只需要处理完成和异常（比如超时）的时候的反馈即可</p>
<p>所以，我需要编写一个post请求的封装类，只要传入请求的url、请求参数（字符串形式）、完成时的回调block</p>
<p>首先，新建类：HttpPostExecutor，.h如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">//</span><span style="color: #008000;">  HttpPostExecutor.h<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">//</span><span style="color: #008000;">  HttpTest<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 5</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Created by WANGJIE on 13-11-6.<br></span><span style="color: #008080;"> 6</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Copyright (c) 2013年 WANGJIE. All rights reserved.<br></span><span style="color: #008080;"> 7</span> <span style="color: #008000;">//<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">#import</span> &lt;Foundation/Foundation.h&gt;<br><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">@interface</span> HttpPostExecutor : NSObject&lt;NSURLConnectionDataDelegate&gt;<br><span style="color: #008080;">12</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">13</span>     NSMutableData <em>resultData; <span style="color: #008000;">//</span><span style="color: #008000;"> 存放请求结果</span><br><span style="color: #008080;">14</span>     <span style="color: #0000ff;">void</span> (^finishCallbackBlock)(NSString </em>); <span style="color: #008000;">//</span><span style="color: #008000;"> 执行完成后回调的block</span><br><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">17</span> @property NSMutableData <em><span style="color: #000000;">resultData;<br></span><span style="color: #008080;">18</span> @property(strong) <span style="color: #0000ff;">void</span> (^finishCallbackBlock)(NSString </em><span style="color: #000000;">);<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span> + (<span style="color: #0000ff;">void</span>)postExecuteWithUrlStr:(NSString <em>)urlStr Paramters:(NSString </em>)<span style="color: #0000ff;">params</span> FinishCallbackBlock:(<span style="color: #0000ff;">void</span> (^)(NSString *<span style="color: #000000;">))block;<br></span><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span> <span style="color: #0000ff;">@end</span></pre><br></div>

<p>&nbsp;</p>
<p>实现了&lt;NSURLConnectionDataDelegate&gt;协议，因为它要接收post请求的几个回调。</p>
<p>有一个NSMutableData对象，这个对象用于储存请求的结果。</p>
<p>一个finishCallbackBlock的block，这个block用于执行完成后的回调，这个block传入的参数就是返回的结果（这个结果已转成utf-8编码的字符串形式），我们可以在这个block中去处理请求完成后的逻辑</p>
<p>还有一个类方法，这个类方法暴露给外面，让外面进行调用</p>
<p>&nbsp;</p>
<p>接下来，我们看下实现的方法.m文件：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('5746940f-c0f2-458d-b9ae-6f828341562c')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_5746940f-c0f2-458d-b9ae-6f828341562c" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">//</span><br><span style="color: #008080;">  2</span> <span style="color: #008000;">//</span><span style="color: #008000;">  POST异步请求的封装<br></span><span style="color: #008080;">  3</span> <span style="color: #008000;">//</span><span style="color: #008000;">  使用方法，只需传入url，参数组成的字符串，执行完成后的回调block<br></span><span style="color: #008080;">  4</span> <span style="color: #008000;">//</span><span style="color: #008000;">  如下：<br></span><span style="color: #008080;">  5</span> <span style="color: #008000;">//</span><span style="color: #008000;">  [HttpPostExecutor postExecuteWithUrlStr:@”</span><span style="color: #008000; text-decoration: underline;"><a href="http://www.baidu.com" target="_blank" rel="noopener">http://www.baidu.com</a></span><span style="color: #008000;">“<br></span><span style="color: #008080;">  6</span> <span style="color: #008000;">//</span><span style="color: #008000;">                              Paramters:@””<br></span><span style="color: #008080;">  7</span> <span style="color: #008000;">//</span><span style="color: #008000;">                    FinishCallbackBlock:^(NSString <em>result){  </em></span><span style="color: #008000;">//</span><span style="color: #008000;"> 设置执行完成的回调block<br></span><span style="color: #008080;">  8</span> <span style="color: #008000;">//</span><span style="color: #008000;">                        NSLog(@”finish callback block, result: %@”, result);<br></span><span style="color: #008080;">  9</span> <span style="color: #008000;">//</span><span style="color: #008000;">                    }];<br></span><span style="color: #008080;"> 10</span> <span style="color: #008000;">//</span><span style="color: #008000;">  post提交的参数，格式如下：<br></span><span style="color: #008080;"> 11</span> <span style="color: #008000;">//</span><span style="color: #008000;">  参数1名字=参数1数据&amp;参数2名字＝参数2数据&amp;参数3名字＝参数3数据&amp;…<br></span><span style="color: #008080;"> 12</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 13</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 14</span> <span style="color: #008000;">//</span><span style="color: #008000;">  HttpPostExecutor.m<br></span><span style="color: #008080;"> 15</span> <span style="color: #008000;">//</span><span style="color: #008000;">  HttpTest<br></span><span style="color: #008080;"> 16</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 17</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Created by WANGJIE on 13-11-6.<br></span><span style="color: #008080;"> 18</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Copyright (c) 2013年 WANGJIE. All rights reserved.<br></span><span style="color: #008080;"> 19</span> <span style="color: #008000;">//<br></span><span style="color: #008080;"> 20</span><br><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">HttpPostExecutor.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 22</span><br><span style="color: #008080;"> 23</span> <span style="color: #0000ff;">@implementation</span><span style="color: #000000;"> HttpPostExecutor<br></span><span style="color: #008080;"> 24</span> <span style="color: #0000ff;">@synthesize</span><span style="color: #000000;"> resultData, finishCallbackBlock;<br></span><span style="color: #008080;"> 25</span><br><span style="color: #008080;"> 26</span> <span style="color: #008000;">/</span><span style="color: #008000;"><em><br></em></span><span style="color: #008080;"> 27</span> <span style="color: #008000;">  执行POST请求<br></span><span style="color: #008080;"> 28</span>  <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 29</span> + (<span style="color: #0000ff;">void</span>)postExecuteWithUrlStr:(NSString )urlStr Paramters:(NSString <em>)<span style="color: #0000ff;">params</span> FinishCallbackBlock:(<span style="color: #0000ff;">void</span> (^)(NSString </em><span style="color: #000000;">))block<br></span><span style="color: #008080;"> 30</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 31</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 生成一个post请求回调委托对象（实现了&lt;NSURLConnectionDataDelegate&gt;协议）</span><br><span style="color: #008080;"> 32</span>     HttpPostExecutor <em>executorDelegate =<span style="color: #000000;"> [[HttpPostExecutor alloc] init];<br></span><span style="color: #008080;"> 33</span>     executorDelegate.finishCallbackBlock = block; <span style="color: #008000;">//</span><span style="color: #008000;"> 绑定执行完成时的block</span><br><span style="color: #008080;"> 34</span><br><span style="color: #008080;"> 35</span><br><span style="color: #008080;"> 36</span>     NSURL </em>url = [NSURL URLWithString:urlStr]; <span style="color: #008000;">//</span><span style="color: #008000;"> 生成NSURL对象<br></span><span style="color: #008080;"> 37</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 生成Request请求对象（并设置它的缓存协议、网络请求超时配置）</span><br><span style="color: #008080;"> 38</span>     NSMutableURLRequest <em>request = [[NSMutableURLRequest alloc] initWithURL:url cachePolicy:NSURLRequestUseProtocolCachePolicy timeoutInterval:<span style="color: #800080;">30</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 39</span><br><span style="color: #008080;"> 40</span>     [request setHTTPBody:[<span style="color: #0000ff;">params</span> dataUsingEncoding:NSUTF8StringEncoding]]; <span style="color: #008000;">//</span><span style="color: #008000;"> 设置请求参数<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 执行请求连接</span><br><span style="color: #008080;"> 43</span>     NSURLConnection </em>conn = [[NSURLConnection alloc] initWithRequest:request <span style="color: #0000ff;">delegate</span><span style="color: #000000;">:executorDelegate];<br></span><span style="color: #008080;"> 44</span><br><span style="color: #008080;"> 45</span>     NSLog(conn ? <span style="color: #800000;">@”</span><span style="color: #800000;">连接创建成功</span><span style="color: #800000;">“</span> : <span style="color: #800000;">@”</span><span style="color: #800000;">连接创建失败</span><span style="color: #800000;">“</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 46</span><br><span style="color: #008080;"> 47</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span><br><span style="color: #008080;"> 50</span> <span style="color: #008000;">/<em></em></span><span style="color: #008000;"><br></span><span style="color: #008080;"> 51</span> <span style="color: #008000;"> <em> 接收到服务器回应的时回调<br></em></span><span style="color: #008080;"> 52</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 53</span> - (<span style="color: #0000ff;">void</span>)connection:(NSURLConnection <em>)connection didReceiveResponse:(NSURLResponse </em><span style="color: #000000;">)response<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 55</span>     NSHTTPURLResponse <em>resp = (NSHTTPURLResponse </em><span style="color: #000000;">)response;<br></span><span style="color: #008080;"> 56</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 初始化NSMutableData对象（用于保存执行结果）</span><br><span style="color: #008080;"> 57</span>     <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">resultData){<br></span><span style="color: #008080;"> 58</span>         resultData =<span style="color: #000000;"> [[NSMutableData alloc] init];<br></span><span style="color: #008080;"> 59</span>     }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 60</span>         [resultData setLength:<span style="color: #800080;">0</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 62</span><br><span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> ([response respondsToSelector:@selector(allHeaderFields)]) {<br></span><span style="color: #008080;"> 64</span><br><span style="color: #008080;"> 65</span>         NSDictionary <em>dictionary =<span style="color: #000000;"> [resp allHeaderFields];<br></span><span style="color: #008080;"> 66</span><br><span style="color: #008080;"> 67</span>         NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">[network]allHeaderFields:%@</span><span style="color: #800000;">“</span><span style="color: #000000;">,[dictionary description]);<br></span><span style="color: #008080;"> 68</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 69</span><br><span style="color: #008080;"> 70</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 71</span> <span style="color: #008000;">/</span></em><span style="color: #008000;"><em><br></em></span><span style="color: #008080;"> 72</span> <span style="color: #008000;">  接收到服务器传输数据的时候调用，此方法根据数据大小执行若干次<br></span><span style="color: #008080;"> 73</span>  <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 74</span> - (<span style="color: #0000ff;">void</span>)connection:(NSURLConnection )connection didReceiveData:(NSData <em><span style="color: #000000;">)data<br></span><span style="color: #008080;"> 75</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 76</span>     [resultData appendData:data]; <span style="color: #008000;">//</span><span style="color: #008000;"> 追加结果</span><br><span style="color: #008080;"> 77</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 78</span> <span style="color: #008000;">/</span></em><span style="color: #008000;"><em><br></em></span><span style="color: #008080;"> 79</span> <span style="color: #008000;">  数据传完之后调用此方法<br></span><span style="color: #008080;"> 80</span>  <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 81</span> - (<span style="color: #0000ff;">void</span>)connectionDidFinishLoading:(NSURLConnection <span style="color: #000000;">)connection<br></span><span style="color: #008080;"> 82</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 83</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 把请求结果以UTF-8编码转换成字符串</span><br><span style="color: #008080;"> 84</span>     NSString <em>resultStr =<span style="color: #000000;"> [[NSString alloc] initWithData:[self resultData] encoding:NSUTF8StringEncoding];<br></span><span style="color: #008080;"> 85</span><br><span style="color: #008080;"> 86</span>     <span style="color: #0000ff;">if</span> (finishCallbackBlock) { <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了回调的block，直接调用</span><br><span style="color: #008080;"> 87</span> <span style="color: #000000;">        finishCallbackBlock(resultStr);<br></span><span style="color: #008080;"> 88</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 89</span><br><span style="color: #008080;"> 90</span><br><span style="color: #008080;"> 91</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 92</span> <span style="color: #008000;">/</span></em><span style="color: #008000;"><em><br></em></span><span style="color: #008080;"> 93</span> <span style="color: #008000;">  网络请求过程中，出现任何错误（断网，连接超时等）会进入此方法<br></span><span style="color: #008080;"> 94</span>  <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 95</span> - (<span style="color: #0000ff;">void</span>)connection:(NSURLConnection )connection didFailWithError:(NSError *<span style="color: #000000;">)error<br></span><span style="color: #008080;"> 96</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 97</span>     NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">network error: %@</span><span style="color: #800000;">“</span><span style="color: #000000;">, [error localizedDescription]);<br></span><span style="color: #008080;"> 98</span><br><span style="color: #008080;"> 99</span>     <span style="color: #0000ff;">if</span> (finishCallbackBlock) { <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了回调的block，直接调用</span><br><span style="color: #008080;">100</span> <span style="color: #000000;">        finishCallbackBlock(nil);<br></span><span style="color: #008080;">101</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">102</span><br><span style="color: #008080;">103</span><br><span style="color: #008080;">104</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">105</span> <span style="color: #0000ff;">@end</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>在这个实现类中，我们在类方法中，先生成一个HttpPostExecutor对象，这个对象用于post请求的回调（因为实现了&lt;NSURLConnectionDataDelegate&gt;协议），然后去执行post连接。</p>
<p>接下来就等下面实现的回调方法被自动调用了，一旦调用</p>
<ul>
<li>(<span class="s1">void</span>)connection:(<span class="s2">NSURLConnection</span> <em>)connection didReceiveResponse:(<span class="s2">NSURLResponse</span> </em>)response</li>
</ul>
<p>这个方法，就对resultData（用于存储post请求结果）进行初始化或者清空，因为要开始真正存储数据了嘛；</p>
<p>&nbsp;</p>
<ul>
<li>(<span class="s1">void</span>)connection:(<span class="s2">NSURLConnection</span> <em>)connection didReceiveData:(<span class="s2">NSData</span> </em>)data</li>
</ul>
<p>这个方法进行回调的时候，把返回过来的这部分数据存储到resultData中，没什么好说的；</p>
<p>&nbsp;</p>
<p>一旦回调- (<span class="s1">void</span>)connectionDidFinishLoading:(<span class="s2">NSURLConnection</span> *)connection这个方法，说明数据传输完毕了，要做的逻辑就是把数据转成utf-8编码的字符串，然后回调我们设置的回调finishCallbackBlock，把转好的结果字符串传进去，这样我们在回调block方法中实现的逻辑就能正常执行了。</p>
<p>&nbsp;</p>
<p>一旦回调- (<span class="s1">void</span>)connection:(<span class="s2">NSURLConnection</span> <em>)connection didFailWithError:(<span class="s2">NSError</span> </em>)error这个方法，说明请求过程中出错了，比如断电、超时等，这时候，也回调我们设置的回调finishCallbackBlock，nil作为结果，这样我们在finishCallbackBlock中就能判断是正常的执行了post还是出了问题。</p>
<p>&nbsp;</p>
<p>好了，接下来，我们就可以在外面去调用了，如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> [HttpPostExecutor postExecuteWithUrlStr:<span style="color: #800000;">@”</span><span style="color: #800000;"><a href="http://www.baidu.com" target="_blank" rel="noopener">http://www.baidu.com</a></span><span style="color: #800000;">“</span><br><span style="color: #008080;">2</span>                                   Paramters:<span style="color: #800000;">@””</span><br><span style="color: #008080;">3</span>                         FinishCallbackBlock:^(NSString *<span style="color: #000000;">result){<br></span><span style="color: #008080;">4</span>                             <span style="color: #008000;">//</span><span style="color: #008000;"> 执行post请求完成后的逻辑</span><br><span style="color: #008080;">5</span>                             NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">finish callback block, result: %@</span><span style="color: #800000;">“</span><span style="color: #000000;">, result);<br></span><span style="color: #008080;">6</span>                         }];</pre><br></div>

<p>这样，以后post请求只需要去调用上面这个方法，在回调block中去处理结果</p>
<p>之后，在我们的代码编写中，就可以只关心业务逻辑，不需要去在意请求协议和回调了</p>
<p>&nbsp;</p>
<p><span style="color: #800000; font-size: 16px;"><strong><a href="http://pan.baidu.com/s/1uxVGh" target="_blank" rel="noopener"><span style="color: #800000;">测试demo下载</span></a></strong></span></p>
<p>&nbsp;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2013/11/03/【IOS】ios中NSUserDefault与android中的SharedPreference用法简单对比/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/11/03/【IOS】ios中NSUserDefault与android中的SharedPreference用法简单对比/" itemprop="url">【IOS】ios中NSUserDefault与android中的SharedPreference用法简单对比</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-11-03T19:37:00+08:00">
                2013-11-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2013/11/03/【IOS】ios中NSUserDefault与android中的SharedPreference用法简单对比/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2013/11/03/【IOS】ios中NSUserDefault与android中的SharedPreference用法简单对比/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="color: #ff0000;"><strong>以下内容为原创，欢迎转载，转载请注明</strong></span></p>
<p><span style="color: #ff0000;"><strong>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/3405308.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/3405308.html</a></strong></span></p>
<p>有Android开发经验的朋友对SharedPreference的用法应该比较亲切的吧，它一般用来保存和读取用户的设置参数，比如保存用户名、加密后的登录密码，是否选择了自动登录，应用选择了哪一套主题皮肤等用户配置信息，使用也非常简单，put/get就能保存/读取这个配置文件，这个文件是用xml形式保存在应用的目录下面</p>
<p>在ios中，也有这么一个类似的工具&mdash;&mdash;NSUserDefault，它支持的数据格式有：NSNumber（Integer、Float、Double），NSString，NSDate，NSArray，NSDictionary，BOOL类型。它是存储在/Library/Prefereces里面，有个plist文件。</p>
<p>下面，我们写一个demo来测试下：</p>
<p>界面很简单，两个button，一个label</p>
<p>点击第一个button用来保存数据，点击第二个button用来显示数据到label</p>
<p>代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> - (IBAction)buttonClicked:(<span style="color: #0000ff;">id</span><span style="color: #000000;">)sender {<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">switch</span><span style="color: #000000;"> ([sender tag]) {<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">1</span>: <span style="color: #008000;">//</span><span style="color: #008000;"> 保存数据</span><br><span style="color: #008080;"> 4</span> <span style="color: #000000;">            [self saveData];<br></span><span style="color: #008080;"> 5</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">2</span>: <span style="color: #008000;">//</span><span style="color: #008000;"> 显示数据</span><br><span style="color: #008080;"> 7</span> <span style="color: #000000;">            [self showData];<br></span><span style="color: #008080;"> 8</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>         <span style="color: #0000ff;">default</span><span style="color: #000000;">:<br></span><span style="color: #008080;">11</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)saveData<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">18</span>     NSUserDefaults <em>userDef =<span style="color: #000000;"> [NSUserDefaults standardUserDefaults];<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>     [userDef setObject:<span style="color: #800000;">@”</span><span style="color: #800000;">wangjie</span><span style="color: #800000;">“</span> forKey:<span style="color: #800000;">@”</span><span style="color: #800000;">name</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;">21</span>     [userDef setInteger:<span style="color: #800080;">23</span> forKey:<span style="color: #800000;">@”</span><span style="color: #800000;">age</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;">22</span>     [userDef setBool:YES forKey:<span style="color: #800000;">@”</span><span style="color: #800000;">isAutoLogin</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;">23</span>     [userDef setDouble:<span style="color: #800080;">115.0</span> forKey:<span style="color: #800000;">@”</span><span style="color: #800000;">weight</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;">24</span>     [userDef setFloat:<span style="color: #800080;">171.2</span> forKey:<span style="color: #800000;">@”</span><span style="color: #800000;">height</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;">25</span><br><span style="color: #008080;">26</span> <span style="color: #000000;">    [userDef synchronize];<br></span><span style="color: #008080;">27</span>     NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">save success!</span><span style="color: #800000;">“</span><span style="color: #000000;">);<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)showData<br></span><span style="color: #008080;">31</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">32</span>     NSUserDefaults </em>userDef =<span style="color: #000000;"> [NSUserDefaults standardUserDefaults];<br></span><span style="color: #008080;">33</span>     NSString *content = [NSString stringWithFormat:<span style="color: #800000;">@”</span><span style="color: #800000;">name: %@; age: %d; isAutoLogin: %hhd; weight: %f; height: %f</span><span style="color: #800000;">“</span><span style="color: #000000;">,<br></span><span style="color: #008080;">34</span>                          [userDef stringForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">name</span><span style="color: #800000;">“</span><span style="color: #000000;">],<br></span><span style="color: #008080;">35</span>                          [userDef integerForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">age</span><span style="color: #800000;">“</span><span style="color: #000000;">],<br></span><span style="color: #008080;">36</span>                          [userDef boolForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">isAutoLogin</span><span style="color: #800000;">“</span><span style="color: #000000;">],<br></span><span style="color: #008080;">37</span>                          [userDef doubleForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">weight</span><span style="color: #800000;">“</span><span style="color: #000000;">],<br></span><span style="color: #008080;">38</span>                          [userDef floatForKey:<span style="color: #800000;">@”</span><span style="color: #800000;">height</span><span style="color: #800000;">“</span><span style="color: #000000;">]<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">                         ];<br></span><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span> <span style="color: #000000;">    [[self showLb] setText:content];<br></span><span style="color: #008080;">42</span>     NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">%@</span><span style="color: #800000;">“</span><span style="color: #000000;">, [[self showLb] text]);<br></span><span style="color: #008080;">43</span> }</pre><br></div>

<p>一：启动应用程序后直接点击第二个button，因为数据之前没有被保存，所以显示的数据都是默认的数据：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/03193439-fb31db723c6f47598890193e5f312773.png" alt=""></p>
<p>二：点击第一个button（数据会被插入），再点击第二个button（已有数据可以显示），此时情况如下：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/03193549-8ad8294a8e8b46d49770631d4937e47f.png" alt=""></p>
<p>&nbsp;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2013/11/02/【IOS】从android角度来实现-理解-IOS的UITableView/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/11/02/【IOS】从android角度来实现-理解-IOS的UITableView/" itemprop="url">【IOS】从android角度来实现(理解)IOS的UITableView</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-11-02T02:58:00+08:00">
                2013-11-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2013/11/02/【IOS】从android角度来实现-理解-IOS的UITableView/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2013/11/02/【IOS】从android角度来实现-理解-IOS的UITableView/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="color: #ff0000;"><strong>以下内容为原创，欢迎转载，转载请注明</strong></span></p>
<p><span style="color: #ff0000;"><strong>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/3403124.html" target="_blank" rel="noopener"><span style="color: #ff0000;">http://www.cnblogs.com/tiantianbyconan/p/3403124.html</span></a></strong></span></p>
<p><strong><span style="color: #ff0000;">&nbsp;</span></strong></p>
<p>本人从在学校开始到现在上班（13年毕业）一直做web和android方面的开发，最近才开学习及ios的开发，所以ios学习中有不当之处，请大家留言赐教啦</p>
<p>以前从来没有接触过Objective-C这门语言，不过我想面向对象编程应该大体思想都差不多</p>
<p>在ios中的UITableView学习中，开发过android的朋友应该马上会联想到ListView和GridView这两个控件，接下来以ListView为例子，跟UITableView做个对比，看看它们实现的方式有什么相同之处。怎么样能让有android开发经验的朋友，马上掌握UITableView这个控件</p>
<p>先新建一个demo，取名TabViewTest（原谅我吧- -，本来要取名TableViewTest，谁知脑抽新建项目的时候写错了，诶。。。算了，将错就错吧- -）</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/02004946-2ab5264ce0bc47dfb40b97a3911a7079.png" alt=""></p>
<p>ios没有命名空间的概念，没有包概念（这也是为什么ios中的类都有前缀的原因，比如NS等），所以上面像&ldquo;包&rdquo;一样的文件夹都是我自己新建的&ldquo;group&rdquo;，只是为了看起来比较有分层的概念而已，打开finder，到项目文件里一看如下图，妈呀- -，所有的类都挤在一个文件夹里面。。。这是我觉得蛋疼的地方之一-。-</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/02005325-69347d3e30f24d08bfe4d313ca0895f0.png" alt=""></p>
<p>&nbsp;</p>
<p>再回来看看我们项目结构，我分的几个group，如果我把controller这个group的名字改成&ldquo;activity&rdquo;，android开发者肯定有种似曾相识的感觉了：</p>
<p>controller：控制层group，相当于android中的activity</p>
<p>layout：布局group，相当于android中res目录下的layout（xml布局文件）</p>
<p>model：这个不用说就知道放了什么东西了，经典的Person这个测试用的数据结构</p>
<p>adapter：为了还念android中的适配器，然后我就取了这么个group名字</p>
<p>&nbsp;</p>
<p>好了，现在正式开始代码的编写</p>
<p>打开MainAppDelegate.m，它实现了UIApplicationDelegate协议，所以可以在该类中实现应用状态的回调函数</p>
<p>在application:didFinishLaunchingWithOptions:方法（应用程序启动时回调该方法）中来设置它的RootController（根控制器，不知道这样翻译专不专业- -），我的实现是生成一个UINavigationController作为它的root controller，然后把自己新建的一个NaviRootController（在这个Controller中放入一个UITableView，具体下面会讲到）作为UINavigationController的root view，具体代码如下（这个不是我们本次的重点，所以一笔带过）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> - (BOOL)application:(UIApplication <em>)application didFinishLaunchingWithOptions:(NSDictionary </em><span style="color: #000000;">)launchOptions<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 3</span>     self.window =<span style="color: #000000;"> [[UIWindow alloc] initWithFrame:[[UIScreen mainScreen] bounds]];<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 生成UINavigationController对象，并设置它的RootController</span><br><span style="color: #008080;"> 6</span>     UINavigationController *naviController =<span style="color: #000000;"> [[UINavigationController alloc] initWithRootViewController:[[NaviRootController alloc] init]];<br></span><span style="color: #008080;"> 7</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 然后把NavigationController设置为window的RootViewController</span><br><span style="color: #008080;"> 8</span> <span style="color: #000000;">    [self.window setRootViewController:naviController];<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>     self.window.backgroundColor =<span style="color: #000000;"> [UIColor whiteColor];<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">    [self.window makeKeyAndVisible];<br></span><span style="color: #008080;">12</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> YES;<br></span><span style="color: #008080;">13</span> }</pre><br></div>

<p>然后，重点就是NaviRootController这个Controller了，</p>
<p>新建NaviRootController，继承UIViewController，在.h文件中：</p>
<p>声明一个NSMutableArray对象data作为tableView的数据源（<span style="color: #993366;"><strong>相当于在android中经常用到的ArrayList&lt;Person&gt; data。NSMutableArray是数组，ArrayList在java中的底层实现本来用的就是数组，所以很好理解</strong></span>）</p>
<p>声明一个用于适配和绑定tableView数据的适配器TableViewAdapter<span class="s1"> <em>adapter（这个类是我自己写的，下面会讲到。<em>*<span style="color: #993366;">java中要实现ListView中的数据绑定适配，也要通过一个继承于BaseAdapter的适配器进行数据的适配吧，也很好理解</span></em></em>）</span></p>
<p><span class="s1">声明一个UITableView对象（<strong><span style="color: #993366;">相当于android中，在activity中声明一个private ListView listView;</span></strong>）</span></p>
<p>具体代码如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('d9c08616-f985-42b7-8567-4e754559345f')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_d9c08616-f985-42b7-8567-4e754559345f" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">//</span><span style="color: #008000;">  NaviRootController.h<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">//</span><span style="color: #008000;">  TabViewTest<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 5</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Created by WANGJIE on 13-10-31.<br></span><span style="color: #008080;"> 6</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Copyright (c) 2013年 WANGJIE. All rights reserved.<br></span><span style="color: #008080;"> 7</span> <span style="color: #008000;">//<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">#import</span> &lt;UIKit/UIKit.h&gt;<br><span style="color: #008080;">10</span> <span style="color: #0000ff;">@class</span><span style="color: #000000;"> TableViewAdapter;<br></span><span style="color: #008080;">11</span> <span style="color: #0000ff;">@interface</span><span style="color: #000000;"> NaviRootController : UIViewController<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">13</span>     NSMutableArray <em><span style="color: #000000;">data;<br></span><span style="color: #008080;">14</span>     TableViewAdapter </em><span style="color: #000000;">adapter;<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span> @property (weak, nonatomic) IBOutlet UITableView <em><span style="color: #000000;">tableView;<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span> @property NSMutableArray </em><span style="color: #000000;">data;<br></span><span style="color: #008080;">21</span> @property(strong, nonatomic) TableViewAdapter *<span style="color: #000000;">adapter;<br></span><span style="color: #008080;">22</span> <span style="color: #0000ff;">@end</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>好了，声明部分到此为止，接下来看看实现部分</p>
<p><span class="s1">刚刚在</span>MainAppDelegate中，生成了一个NaviRootController对象，然后把这个对象加入到了UINavigationController对象的rootViewController。生成NaviRootController对象的时候，调用了init方法，我们应该在init方法里面去初始化布局，如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('a6fdcec3-37ba-4d77-9aef-f331f7e32fea')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_a6fdcec3-37ba-4d77-9aef-f331f7e32fea" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> - (<span style="color: #0000ff;">id</span><span style="color: #000000;">)init<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 3</span>     self = [self initWithNibName:<span style="color: #800000;">@”</span><span style="color: #800000;">navi_root</span><span style="color: #800000;">“</span><span style="color: #000000;"> bundle:nil];<br></span><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> self;<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> - (<span style="color: #0000ff;">id</span>)initWithNibName:(NSString <em>)nibNameOrNil bundle:(NSBundle </em><span style="color: #000000;">)nibBundleOrNil<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 9</span>     self =<span style="color: #000000;"> [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];<br></span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (self) {<br></span><span style="color: #008080;">11</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获得当前导航栏对象</span><br><span style="color: #008080;">12</span>         UINavigationItem <em>item =<span style="color: #000000;"> [self navigationItem];<br></span><span style="color: #008080;">13</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置导航栏左按钮</span><br><span style="color: #008080;">14</span>         UIBarButtonItem </em>leftButton = [[UIBarButtonItem alloc] initWithTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">leftButton</span><span style="color: #800000;">“</span><span style="color: #000000;"> style:UIBarButtonItemStylePlain target:self action:@selector(buttonClickedAction:)];<br></span><span style="color: #008080;">15</span>         [leftButton setTag:<span style="color: #800080;">0</span><span style="color: #000000;">];<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">        [item setLeftBarButtonItem:leftButton animated:YES];<br></span><span style="color: #008080;">17</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置导航栏右按钮</span><br><span style="color: #008080;">18</span>         UIBarButtonItem *rightButton = [[UIBarButtonItem alloc] initWithTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">rightButton</span><span style="color: #800000;">“</span><span style="color: #000000;"> style:UIBarButtonItemStyleDone target:self action:@selector(buttonClickedAction:)];<br></span><span style="color: #008080;">19</span>         [rightButton setTag:<span style="color: #800080;">1</span><span style="color: #000000;">];<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">        [item setRightBarButtonItem:rightButton animated:YES];<br></span><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">23</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> self;<br></span><span style="color: #008080;">24</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>我们在init方法中调用了initWithNibName:bundle:方法，传入了NibName这个字符串，这个是什么？<strong><span style="color: #993366;">Nib是ios里面的布局文件，也就是相当于android中类似main.xml这种布局文件吧，现在传进去的时nibname，也就是布局文件的名称。</span></strong>所以，没错，传入这个参数后，当前的controller（也就是NaviRootController就跟传入的这个布局文件绑定起来了，<strong><span style="color: #993366;">类似于android中activity中熟悉的setContentView(R.layout.main)一样！</span></strong>）</p>
<p>然后我们顺便看看navi_root.xib这个布局文件：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/02020218-ffb5db3c54c54a6184439f8ed617d17d.png" alt=""></p>
<p>整个界面就一个UITableView，对了，别忘了在File’s Owner中把custom class改成NaviRootController。键盘按住control，用鼠标拖动左边栏的&ldquo;Table View&rdquo;到NaviRootController.h中，会自动生成UITableView声明，并自动绑定。</p>
<p>接下来回到NaviRootController的初始化方法中。</p>
<p>initWithNibName:bundle:方法中后面的UINavigationItem相关的代码是用来设置导航栏左边和右边的按钮，既然是个demo，所以也没什么特别的功能，就是点击下，跳出一个UIAlertView提示下，所以一笔带过。</p>
<p>此时界面布局和controller已经绑定起来了，现在的任务应该是初始化UITableView的数据，也就是上面的data属性，但是在哪里初始化比较好呢？</p>
<p>刚开始，我是直接在init方法中直接去初始化数据，但是失败了，不管在init方法中初始化多少次（data调用多少次addObject方法），data的值永远都是nil（相当于在android中，不管调用多少次list.add(…)方法，list中一条数据也没有加入！），猜测是因为在init方法中的时候属性和控件都还没有被初始化。</p>
<p>最后我的解决办法就是在viewDidLoad方法中去加载数据。viewDidLoad这个回调方法是会在控件加载完毕后调用，所以，我认为在这里去加载数据和做控件的初始化操作是比较合理的。</p>
<p>viewDidLoad方法实现如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('c37254db-2ea2-4e96-a9e5-0ecddbd3c8cc')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_c37254db-2ea2-4e96-a9e5-0ecddbd3c8cc" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)viewDidLoad<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> Do any additional setup after loading the view.</span><br><span style="color: #008080;"> 5</span> <span style="color: #000000;">    [super viewDidLoad];<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">adapter) {<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">        [self initData];<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 生成适配器委托对象</span><br><span style="color: #008080;">11</span>         adapter =<span style="color: #000000;"> [[TableViewAdapter alloc] initWithSource:data Controller:self];<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置适配器委托对象</span><br><span style="color: #008080;">14</span> <span style="color: #000000;">        [[self tableView] setDelegate:adapter];<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        [[self tableView] setDataSource:adapter];<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">18</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>如上，在viewDidLoad中，我先去初始化数据（demo中的实现其实就是循环了14次，往data中加了14个Person对象），然后生成一个适配器委托对象，传入data（数据源）和self（当前controller对象），<strong><span style="color: #993366;">相当于android中的 adapter = new MyAdapter(list, this);有木有？？！！</span></strong></p>
<p>然后，setDelegate用来设置委托对象（<strong><span style="color: #993366;">相当于android中的listView.setAdapter(adapter)</span></strong>），setDataSource用来设置数据源。</p>
<p>这里，完整地列出NaviRootController的代码：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('2b006d06-4ce6-4ae1-bd35-7ec3abe88e1e')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_2b006d06-4ce6-4ae1-bd35-7ec3abe88e1e" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">//</span><br><span style="color: #008080;">  2</span> <span style="color: #008000;">//</span><span style="color: #008000;">  NaviRootController.m<br></span><span style="color: #008080;">  3</span> <span style="color: #008000;">//</span><span style="color: #008000;">  TabViewTest<br></span><span style="color: #008080;">  4</span> <span style="color: #008000;">//</span><br><span style="color: #008080;">  5</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Created by WANGJIE on 13-10-31.<br></span><span style="color: #008080;">  6</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Copyright (c) 2013年 WANGJIE. All rights reserved.<br></span><span style="color: #008080;">  7</span> <span style="color: #008000;">//<br></span><span style="color: #008080;">  8</span><br><span style="color: #008080;">  9</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">NaviRootController.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">Person.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">TableViewAdapter.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 12</span><br><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">@interface</span><span style="color: #000000;"> NaviRootController ()<br></span><span style="color: #008080;"> 14</span><br><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">@end</span><br><span style="color: #008080;"> 16</span><br><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">@implementation</span><span style="color: #000000;"> NaviRootController<br></span><span style="color: #008080;"> 18</span> <span style="color: #0000ff;">@synthesize</span><span style="color: #000000;"> data, adapter;<br></span><span style="color: #008080;"> 19</span><br><span style="color: #008080;"> 20</span> - (<span style="color: #0000ff;">id</span><span style="color: #000000;">)init<br></span><span style="color: #008080;"> 21</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 22</span>     self = [self initWithNibName:<span style="color: #800000;">@”</span><span style="color: #800000;">navi_root</span><span style="color: #800000;">“</span><span style="color: #000000;"> bundle:nil];<br></span><span style="color: #008080;"> 23</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> self;<br></span><span style="color: #008080;"> 24</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 25</span><br><span style="color: #008080;"> 26</span> - (<span style="color: #0000ff;">id</span>)initWithNibName:(NSString <em>)nibNameOrNil bundle:(NSBundle </em><span style="color: #000000;">)nibBundleOrNil<br></span><span style="color: #008080;"> 27</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 28</span>     self =<span style="color: #000000;"> [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];<br></span><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (self) {<br></span><span style="color: #008080;"> 30</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> Custom initialization<br></span><span style="color: #008080;"> 31</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获得当前导航栏对象</span><br><span style="color: #008080;"> 32</span>         UINavigationItem <em>item =<span style="color: #000000;"> [self navigationItem];<br></span><span style="color: #008080;"> 33</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置导航栏左按钮</span><br><span style="color: #008080;"> 34</span>         UIBarButtonItem </em>leftButton = [[UIBarButtonItem alloc] initWithTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">leftButton</span><span style="color: #800000;">“</span><span style="color: #000000;"> style:UIBarButtonItemStylePlain target:self action:@selector(buttonClickedAction:)];<br></span><span style="color: #008080;"> 35</span>         [leftButton setTag:<span style="color: #800080;">0</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 36</span> <span style="color: #000000;">        [item setLeftBarButtonItem:leftButton animated:YES];<br></span><span style="color: #008080;"> 37</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置导航栏右按钮</span><br><span style="color: #008080;"> 38</span>         UIBarButtonItem <em>rightButton = [[UIBarButtonItem alloc] initWithTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">rightButton</span><span style="color: #800000;">“</span><span style="color: #000000;"> style:UIBarButtonItemStyleDone target:self action:@selector(buttonClickedAction:)];<br></span><span style="color: #008080;"> 39</span>         [rightButton setTag:<span style="color: #800080;">1</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 40</span> <span style="color: #000000;">        [item setRightBarButtonItem:rightButton animated:YES];<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span><br><span style="color: #008080;"> 43</span><br><span style="color: #008080;"> 44</span><br><span style="color: #008080;"> 45</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 46</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> self;<br></span><span style="color: #008080;"> 47</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span> <span style="color: #008000;">/</span></em><span style="color: #008000;"><em><br></em></span><span style="color: #008080;"> 50</span> <span style="color: #008000;">  初始化列表数据<br></span><span style="color: #008080;"> 51</span>  <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 52</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)initData<br></span><span style="color: #008080;"> 53</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 54</span>     data =<span style="color: #000000;"> [[NSMutableArray alloc] init];<br></span><span style="color: #008080;"> 55</span>     NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">%@</span><span style="color: #800000;">“</span><span style="color: #000000;">, NSStringFromSelector(_cmd));<br></span><span style="color: #008080;"> 56</span>     Person <span style="color: #000000;">person;<br></span><span style="color: #008080;"> 57</span>     <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = <span style="color: #800080;">0</span>; i &lt; <span style="color: #800080;">14</span>; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;"> 58</span>         person =<span style="color: #000000;"> [[Person alloc] init];<br></span><span style="color: #008080;"> 59</span>         [person setName:[<span style="color: #800000;">@”</span><span style="color: #800000;">name</span><span style="color: #800000;">“</span><span style="color: #000000;"> stringByAppendingString:<br></span><span style="color: #008080;"> 60</span>                          [NSString stringWithFormat:<span style="color: #800000;">@”</span><span style="color: #800000;">%d</span><span style="color: #800000;">“</span><span style="color: #000000;">, i]<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">                         ]<br></span><span style="color: #008080;"> 62</span> <span style="color: #000000;">         ];<br></span><span style="color: #008080;"> 63</span><br><span style="color: #008080;"> 64</span>         [person setAge:i + <span style="color: #800080;">10</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 65</span><br><span style="color: #008080;"> 66</span>         [person setPic:[UIImage imageNamed:<span style="color: #800000;">@”</span><span style="color: #800000;">Hypno.png</span><span style="color: #800000;">“</span><span style="color: #000000;">]];<br></span><span style="color: #008080;"> 67</span><br><span style="color: #008080;"> 68</span> <span style="color: #000000;">        [data addObject:person];<br></span><span style="color: #008080;"> 69</span><br><span style="color: #008080;"> 70</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 71</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 72</span><br><span style="color: #008080;"> 73</span><br><span style="color: #008080;"> 74</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)viewDidLoad<br></span><span style="color: #008080;"> 75</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 76</span><br><span style="color: #008080;"> 77</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> Do any additional setup after loading the view.</span><br><span style="color: #008080;"> 78</span> <span style="color: #000000;">    [super viewDidLoad];<br></span><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">adapter) {<br></span><span style="color: #008080;"> 81</span> <span style="color: #000000;">        [self initData];<br></span><span style="color: #008080;"> 82</span><br><span style="color: #008080;"> 83</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 生成适配器委托对象</span><br><span style="color: #008080;"> 84</span>         adapter =<span style="color: #000000;"> [[TableViewAdapter alloc] initWithSource:data Controller:self];<br></span><span style="color: #008080;"> 85</span><br><span style="color: #008080;"> 86</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置适配器委托对象</span><br><span style="color: #008080;"> 87</span> <span style="color: #000000;">        [[self tableView] setDelegate:adapter];<br></span><span style="color: #008080;"> 88</span> <span style="color: #000000;">        [[self tableView] setDataSource:adapter];<br></span><span style="color: #008080;"> 89</span><br><span style="color: #008080;"> 90</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 91</span><br><span style="color: #008080;"> 92</span><br><span style="color: #008080;"> 93</span><br><span style="color: #008080;"> 94</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 95</span><br><span style="color: #008080;"> 96</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)viewWillAppear:(BOOL)animated<br></span><span style="color: #008080;"> 97</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 98</span> <span style="color: #000000;">    [super viewWillAppear:YES];<br></span><span style="color: #008080;"> 99</span><br><span style="color: #008080;">100</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">101</span><br><span style="color: #008080;">102</span> - (<span style="color: #0000ff;">void</span><span style="color: #000000;">)didReceiveMemoryWarning<br></span><span style="color: #008080;">103</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">    [super didReceiveMemoryWarning];<br></span><span style="color: #008080;">105</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> Dispose of any resources that can be recreated.</span><br><span style="color: #008080;">106</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">107</span><br><span style="color: #008080;">108</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 按钮点击事件回调</span><br><span style="color: #008080;">109</span> - (<span style="color: #0000ff;">void</span>)buttonClickedAction:(<span style="color: #0000ff;">id</span><span style="color: #000000;">)sender<br></span><span style="color: #008080;">110</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">111</span><br><span style="color: #008080;">112</span>     NSString <em><span style="color: #000000;">message;<br></span><span style="color: #008080;">113</span>     <span style="color: #0000ff;">switch</span><span style="color: #000000;"> ([sender tag]) {<br></span><span style="color: #008080;">114</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">0</span><span style="color: #000000;">:<br></span><span style="color: #008080;">115</span>             message = <span style="color: #800000;">@”</span><span style="color: #800000;">left button clicked!</span><span style="color: #800000;">“</span><span style="color: #000000;">;<br></span><span style="color: #008080;">116</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">117</span>         <span style="color: #0000ff;">case</span> <span style="color: #800080;">1</span><span style="color: #000000;">:<br></span><span style="color: #008080;">118</span>             message = <span style="color: #800000;">@”</span><span style="color: #800000;">right button clicked!</span><span style="color: #800000;">“</span><span style="color: #000000;">;<br></span><span style="color: #008080;">119</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">120</span>         <span style="color: #0000ff;">default</span><span style="color: #000000;">:<br></span><span style="color: #008080;">121</span>             message = <span style="color: #800000;">@”</span><span style="color: #800000;">unknow button clicked!</span><span style="color: #800000;">“</span><span style="color: #000000;">;<br></span><span style="color: #008080;">122</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">123</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">124</span><br><span style="color: #008080;">125</span>     UIAlertView </em>alert = [[UIAlertView alloc] initWithTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">alert view</span><span style="color: #800000;">“</span> message:message <span style="color: #0000ff;">delegate</span>:self cancelButtonTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">cancel</span><span style="color: #800000;">“</span><span style="color: #000000;"> otherButtonTitles:nil, nil];<br></span><span style="color: #008080;">126</span> <span style="color: #000000;">    [alert show];<br></span><span style="color: #008080;">127</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">128</span><br><span style="color: #008080;">129</span><br><span style="color: #008080;">130</span><br><span style="color: #008080;">131</span><br><span style="color: #008080;">132</span> <span style="color: #0000ff;">@end</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>&nbsp;</p>
<p>好了，UITableView的初始化准备工作到此就做完了，现在干嘛？</p>
<p>当然去编写TableViewAdapter这个类啊。数据源有了（并且初始化完毕），用以显示的控件（UITableView）有了（并且初始化完毕），而且两个还已经绑定起来了。但是还缺的就是一个角色，这个角色可以把数据源中的数据跟控件中某个相应的子控件适配起来。比如数据源中有4个数据，A、B、C、D，控件有one、two、three、four这4个控件，这个角色的任务就是告诉one：你要显示的数据是A；告诉two：你要显示的数据是B；告诉three：你要显示的数据是C；告诉four：你要显示的数据是D！</p>
<p>这个角色就是适配器！也就是下面要说的那个TableViewAdapter</p>
<p>新建TableViewAdapter，实现<span class="s1">&lt;</span>UITableViewDataSource<span class="s1">, </span>UITableViewDelegate<span class="s1">&gt;这两个协议（<strong><span style="color: #993366;">android中适配器不同的是要继承BaseAdapter类</span></strong>）。声明一个数据源data，这个数据源是从NaviRootController中传过来的已经初始化好了的数据源，还有一个声明是</span>NaviRootController对象传过来的self（需要什么，就让调用者传什么过来，这个应该都懂的-。-），另外还有一个自己写的初始化方法（自己写初始化方法init打头的方法就行，不像java中的构造方法，方法名要跟类名相同，不过这些都是换汤不换药）</p>
<p><span class="s1">然后看看TableViewAdapter的实现类（.m）</span></p>
<p><span class="s1">实现了这两个协议后，你就能覆写里面的一些UITableView的回调方法了，比如：</span></p>
<p>tableView:numberOfRowsInSection:方法，返回数据源的数量就行了（<strong><span style="color: #993366;">类似android的adapter中自己要实现的getCount()方法！</span></strong>）</p>
<p>tableView:cellForRowAtIndexPath:这个是方法是这里最关键的一个方法了，就是在这里进行数据的适配工作（<strong><span style="color: #993366;">类似android的adapter中自己要实现的getView()方法！</span></strong>），这里返回的UITableViewCell就是类表中的一项（<strong><span style="color: #993366;">类似android中listview的一个item</span></strong>），这个一项的布局，已经在table_cell.xib文件中布局完毕，如下：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/02023019-1ef72e95265e49d892e83e1a84ef423c.png" alt=""></p>
<p>设置File’s Owner为TableViewAdapter，设置Table View Cell的identifier设置为&ldquo;MyTableCell&rdquo;，这个可以任意取名，但是要跟后面的方法实现中统一（跟哪里统一？作用是神马？这些下面会讲到，别急-。-），接着设置ImageView的tag为1，nameLabel的tag为2，ageLabel的tag为3（tag的作用，下面也会讲到）。</p>
<p>接着，回到tableView:cellForRowAtIndexPath:这个方法，它的实现如下所示：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> - (UITableViewCell <em>)tableView:(UITableView </em>)tableView cellForRowAtIndexPath:(NSIndexPath <em><span style="color: #000000;">)indexPath<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{<br></span><span style="color: #008080;"> 3</span>     Person </em>p =<span style="color: #000000;"> [data objectAtIndex:[indexPath row]];<br></span><span style="color: #008080;"> 4</span>     UITableViewCell <em>cell = [tableView dequeueReusableCellWithIdentifier:<span style="color: #800000;">@”</span><span style="color: #800000;">MyTableCell</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">cell) {<br></span><span style="color: #008080;"> 6</span>         NSArray </em>nibViews = [[NSBundle mainBundle] loadNibNamed:<span style="color: #800000;">@”</span><span style="color: #800000;">table_cell</span><span style="color: #800000;">“</span><span style="color: #000000;"> owner:self options:nil];<br></span><span style="color: #008080;"> 7</span>         cell = [nibViews objectAtIndex:<span style="color: #800080;">0</span><span style="color: #000000;">];<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>     UIImageView <em>picIv = (UIImageView </em>)[cell viewWithTag:<span style="color: #800080;">1</span><span style="color: #000000;">];<br></span><span style="color: #008080;">11</span>     UILabel <em>nameLb = (UILabel </em>)[cell viewWithTag:<span style="color: #800080;">2</span><span style="color: #000000;">];<br></span><span style="color: #008080;">12</span>     UILabel <em>ageLb = (UILabel </em>)[cell viewWithTag:<span style="color: #800080;">3</span><span style="color: #000000;">];<br></span><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span> <span style="color: #000000;">    [nameLb setText:[p name]];<br></span><span style="color: #008080;">15</span>     [ageLb setText:[NSString stringWithFormat:<span style="color: #800000;">@”</span><span style="color: #800000;">%d</span><span style="color: #800000;">“</span><span style="color: #000000;">, [p age]]];<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">    [picIv setImage:[p pic]];<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> cell;<br></span><span style="color: #008080;">19</span> }</pre><br></div>

<p>如上图所示：</p>
<p>第3行，是用于获得所要显示的数据Person对象（<strong><span style="color: #993366;">这里的[indexPath row]相当于android的adapter的getView方法的position参数</span></strong>。indexPath中有两个参数，row和section，表示行和列，因为我们现在是要显示一个列表，所以只需要row这个参数就可以了）</p>
<p><span class="s1">第4行，是用于资源的重复利用，根据标示符&ldquo;MyTableCell&rdquo;去获得一个可再利用的UITableViewCell（这里的标示符就要跟前面在xib文件中设置的标示符要一致，这样才能被识别到，然后在这里被获取到），如果没有获得到，就去新创建一个UITableViewCell。</span></p>
<p><span class="s1">第6、7行，是创建新的UITableViewCell的代码，通过mianBundle的loadNibNamed:owner:options方法根据xib的名字去创建（<strong><span style="color: #993366;">跟</span></strong></span><strong><span style="color: #993366;">android<span class="s1">中的</span>LayoutInflater.inflate()</span></strong><span class="s1"><strong><span style="color: #993366;">方法通过R.layout.xxx的方法创建类似</span></strong>），loadNibNamed:owner:options返回的是一个数组，得到第一个就是UITableViewCell了。</span></p>
<p><span class="s1">第10、11、12行，是获取到或者新建的cell通过控件之前设置的tag来获得相应地子控件（现在知道之前为什么要设置xib文件中控件的tag了吧？<strong><span style="color: #993366;">这个跟</span></strong></span><strong><span style="color: #993366;">android<span class="s1">中的</span>findViewByTag/findViewById又是很类似的！</span></strong><span class="s1">）</span></p>
<p><span class="s1">第14、15、16行，是为刚刚获得的cell中的子控件适配数据，让它可以把数据显示出来。</span></p>
<p><span class="s1">第18行，把生成数据适配完毕的UITableViewCell返回出去（<strong><span style="color: #993366;">这跟android中的也是很类似</span></strong>）</span></p>
<p>TableViewAdapter代码如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('ec009a67-93fe-4bda-989e-4fcd65ed3131')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_ec009a67-93fe-4bda-989e-4fcd65ed3131" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">//</span><span style="color: #008000;">  TableViewAdapter.m<br></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">//</span><span style="color: #008000;">  TabViewTest<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;">//</span><br><span style="color: #008080;"> 5</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Created by WANGJIE on 13-10-31.<br></span><span style="color: #008080;"> 6</span> <span style="color: #008000;">//</span><span style="color: #008000;">  Copyright (c) 2013年 WANGJIE. All rights reserved.<br></span><span style="color: #008080;"> 7</span> <span style="color: #008000;">//<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">TableViewAdapter.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;">10</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">Person.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">#import</span> <span style="color: #800000;">“</span><span style="color: #800000;">NaviRootController.h</span><span style="color: #800000;">“</span><br><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">@implementation</span><span style="color: #000000;"> TableViewAdapter<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> - (<span style="color: #0000ff;">id</span>)initWithSource:(NSMutableArray <em>)source Controller:(NaviRootController </em><span style="color: #000000;">)context<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">17</span>     NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">initWithSource…</span><span style="color: #800000;">“</span><span style="color: #000000;">);<br></span><span style="color: #008080;">18</span>     self =<span style="color: #000000;"> [super init];<br></span><span style="color: #008080;">19</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (self) {<br></span><span style="color: #008080;">20</span>         data =<span style="color: #000000;"> source;<br></span><span style="color: #008080;">21</span>         controller =<span style="color: #000000;"> context;<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">23</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> self;<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">25</span><br><span style="color: #008080;">26</span> - (NSInteger)tableView:(UITableView <em><span style="color: #000000;">)tableView numberOfRowsInSection:(NSInteger)section<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> [data count];<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">31</span><br><span style="color: #008080;">32</span> - (UITableViewCell </em>)tableView:(UITableView <em>)tableView cellForRowAtIndexPath:(NSIndexPath </em><span style="color: #000000;">)indexPath<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">34</span>     NSLog(<span style="color: #800000;">@”</span><span style="color: #800000;">%@</span><span style="color: #800000;">“</span><span style="color: #000000;">, NSStringFromSelector(_cmd));<br></span><span style="color: #008080;">35</span> <span style="color: #008000;">//</span><span style="color: #008000;">    UITableViewCell <em>cell = [tableView dequeueReusableCellWithIdentifier:@”UITableViewCell”];<br></em></span><span style="color: #008080;">36</span> <span style="color: #008000;">//</span><span style="color: #008000;">    if (!cell) {<br></span><span style="color: #008080;">37</span> <span style="color: #008000;">//</span><span style="color: #008000;">        cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:@”UITableViewCell”];<br></span><span style="color: #008080;">38</span> <span style="color: #008000;">//</span><span style="color: #008000;">    }<br></span><span style="color: #008080;">39</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 获得当前要显示的数据</span><br><span style="color: #008080;">40</span>     Person p =<span style="color: #000000;"> [data objectAtIndex:[indexPath row]];<br></span><span style="color: #008080;">41</span> <span style="color: #008000;">//</span><br><span style="color: #008080;">42</span> <span style="color: #008000;">//</span><span style="color: #008000;">    [[cell textLabel] setText:[p name]];<br></span><span style="color: #008080;">43</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 记得在cell.xib文件中设置identifier以达到重用的目的</span><br><span style="color: #008080;">44</span>     UITableViewCell <em>cell = [tableView dequeueReusableCellWithIdentifier:<span style="color: #800000;">@”</span><span style="color: #800000;">MyTableCell</span><span style="color: #800000;">“</span><span style="color: #000000;">];<br></span><span style="color: #008080;">45</span>     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">cell) {<br></span><span style="color: #008080;">46</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 通过mainBundle的loadNibNamed方法去加载布局，类似android中的LayoutInflater.inflate()方法</span><br><span style="color: #008080;">47</span>         NSArray </em>nibViews = [[NSBundle mainBundle] loadNibNamed:<span style="color: #800000;">@”</span><span style="color: #800000;">table_cell</span><span style="color: #800000;">“</span><span style="color: #000000;"> owner:self options:nil];<br></span><span style="color: #008080;">48</span>         cell = [nibViews objectAtIndex:<span style="color: #800080;">0</span><span style="color: #000000;">];<br></span><span style="color: #008080;">49</span> <span style="color: #008000;">//</span><span style="color: #008000;">        cell.selectionStyle = UITableViewCellSelectionStyleNone;</span><br><span style="color: #008080;">50</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">51</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 通过在cell.xib中各控件设置的tag来获得控件，类似android中的findViewByTag/findViewById</span><br><span style="color: #008080;">52</span>     UIImageView <em>picIv = (UIImageView </em>)[cell viewWithTag:<span style="color: #800080;">1</span><span style="color: #000000;">];<br></span><span style="color: #008080;">53</span>     UILabel <em>nameLb = (UILabel </em>)[cell viewWithTag:<span style="color: #800080;">2</span><span style="color: #000000;">];<br></span><span style="color: #008080;">54</span>     UILabel <em>ageLb = (UILabel </em>)[cell viewWithTag:<span style="color: #800080;">3</span><span style="color: #000000;">];<br></span><span style="color: #008080;">55</span><br><span style="color: #008080;">56</span> <span style="color: #000000;">    [nameLb setText:[p name]];<br></span><span style="color: #008080;">57</span>     [ageLb setText:[NSString stringWithFormat:<span style="color: #800000;">@”</span><span style="color: #800000;">%d</span><span style="color: #800000;">“</span><span style="color: #000000;">, [p age]]];<br></span><span style="color: #008080;">58</span> <span style="color: #000000;">    [picIv setImage:[p pic]];<br></span><span style="color: #008080;">59</span><br><span style="color: #008080;">60</span><br><span style="color: #008080;">61</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> cell;<br></span><span style="color: #008080;">62</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">63</span><br><span style="color: #008080;">64</span><br><span style="color: #008080;">65</span> - (<span style="color: #0000ff;">void</span>)tableView:(UITableView <em>)tableView didSelectRowAtIndexPath:(NSIndexPath </em><span style="color: #000000;">)indexPath<br></span><span style="color: #008080;">66</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">67</span>     Person <em>person =<span style="color: #000000;"> [data objectAtIndex:[indexPath row]];<br></span><span style="color: #008080;">68</span>     UIAlertView </em>alert = [[UIAlertView alloc] initWithTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">cell clicked!</span><span style="color: #800000;">“</span> message:[NSString stringWithFormat:<span style="color: #800000;">@”</span><span style="color: #800000;">%@ clicked!</span><span style="color: #800000;">“</span>, [person name]]<span style="color: #0000ff;">delegate</span>:self cancelButtonTitle:<span style="color: #800000;">@”</span><span style="color: #800000;">cancel</span><span style="color: #800000;">“</span><span style="color: #000000;"> otherButtonTitles:nil, nil];<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">    [alert show];<br></span><span style="color: #008080;">70</span><br><span style="color: #008080;">71</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">72</span><br><span style="color: #008080;">73</span> - (CGFloat)tableView:(UITableView <em>)tableView heightForRowAtIndexPath:(NSIndexPath </em><span style="color: #000000;">)indexPath<br></span><span style="color: #008080;">74</span> <span style="color: #000000;">{<br></span><span style="color: #008080;">75</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> [self tableView:tableView cellForRowAtIndexPath:indexPath].frame.size.height;<br></span><span style="color: #008080;">76</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">77</span><br><span style="color: #008080;">78</span><br><span style="color: #008080;">79</span> <span style="color: #0000ff;">@end</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>&nbsp;</p>
<p>好了！到此为止整个UITableView实现的流程基本完成了，可以看出跟android的ListView和GridView的实现流程很相似，理解了其中一个，另一个也能很好的理解它的工作流程。</p>
<p>最后来一张效果图：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201311/02030600-2d2805ccefc04db9b4e0085845980d43.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2013/10/30/Android-NDK环境搭建及调用JNI的简单步骤/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/10/30/Android-NDK环境搭建及调用JNI的简单步骤/" itemprop="url">Android NDK环境搭建及调用JNI的简单步骤</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-10-30T14:06:00+08:00">
                2013-10-30
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2013/10/30/Android-NDK环境搭建及调用JNI的简单步骤/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2013/10/30/Android-NDK环境搭建及调用JNI的简单步骤/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><span style="color: #ff0000;">转载请注明：<a href="http://www.cnblogs.com/tiantianbyconan/p/3396595.html" target="_blank" rel="noopener"><span style="color: #ff0000;">http://www.cnblogs.com/tiantianbyconan/p/3396595.html</span></a></span></strong></p>
<p><span>Java Native Interface (JNI)标准是java平台的一部分，它允许Java代码和其他语言写的代码进行交互。JNI 是本地编程接口，它使得在 Java 虚拟机 (VM) 内部运行的 Java 代码能够与用其它编程语言(如 C、C++ 和汇编语言)编写的应用程序和库进行交互操作。</span></p>
<p>1. 下载NDK（<a href="http://developer.android.com/tools/sdk/ndk/index.html" target="_blank" rel="noopener">http://developer.android.com/tools/sdk/ndk/index.html</a>），并解压，配置Path路径</p>
<p>&nbsp;</p>
<p>2. 在项目中新建一个名为jni的文件夹，在jni中新增Android.mk文件，文件内容如下：</p>
<div class="cnblogs_Highlighter"><br><pre class="brush:html;gutter:false;">LOCAL_PATH := $(call my-dir)<br>include $(CLEAR_VARS)<br>LOCAL_MODULE    := PhotoUtil<br>LOCAL_SRC_FILES := PhotoUtil.c<br>LOCAL_LDLIBS    := -llog -ljnigraphics<br>include $(BUILD_SHARED_LIBRARY)<br></pre><br></div>

<p><span>LOCAL_MODULE：当前模块的名称</span></p>
<p><span><span>LOCAL_SHARED_LIBRARIES：当前模块需要依赖的共享库。&nbsp;</span></span></p>
<p><span><span>LOCAL_SRC_FILES：所要调用的C源码</span></span></p>
<p>&nbsp;</p>
<p><span><span>3. 把PhotoUtil.c文件复制到jni目录下</span></span></p>
<p><span><span>PhotoUtil.c，包含一个图片处理方法：</span></span></p>
<div class="cnblogs_code"><br><pre>JNIEXPORT <span style="color: #0000ff;">void</span> JNICALL Java_com_wangjie_customviews_PicturesDialog_functionToBlur(JNIEnv*<span style="color: #000000;"> env, jobject obj, jobject bitmapIn, jobject bitmapOut, jint radius) {<br>    &hellip;&hellip;<br>}</span></pre><br></div>

<p>方法Java_com_wangjie_customviews_PicturesDialog_functionToBlur的取名方式：</p>
<p>Java_：固定<br>com_wangjie_customviews：java包名<br>PicturesDialog：java类名<br>functionToBlur：java使用的方法名</p>
<p>&nbsp;</p>
<p>4. 编译C源码，生产so库文件</p>
<p>进入jni目录：</p>
<p>ndk-build 或者</p>
<p><span>ndk-build&nbsp;APP_PLATFORM=android-8</span></p>
<div class="cnblogs_Highlighter"><br><pre class="brush:html;gutter:true;">“Compile thumb : PhotoUtil &lt;= PhotoUtil.c<br>SharedLibrary  : libPhotoUtil.so<br>Install        : libPhotoUtil.so =&gt; libs/armeabi/libPhotoUtil.so</pre><br></div>

<p><span>执行完毕之后，android项目的libs目录下就会生成so文件：</span></p>
<p><span>\libs\armeabi\libPhotoUtil.so</span></p>
<p><span><span>5. 在android中java代码调用：</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">static</span><span style="color: #000000;">{<br>      System.loadLibrary(</span>“PhotoUtil”<span style="color: #000000;">);<br>}</span></pre><br></div>

<p>加载photoUtil库（libPhotoUtil.so）</p>
<p>并添加：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">native</span> <span style="color: #0000ff;">void</span> functionToBlur(Bitmap bitmapIn, Bitmap bitmapOut, <span style="color: #0000ff;">int</span> radius);</pre><br></div>

<p>然后在其他地方只需要调用该functionToBlur()方法即可：</p>
<div class="cnblogs_code"><br><pre>functionToBlur(bgBitmap, bitmapOut, 50);</pre><br></div>

<p>&nbsp;</p>
<p>参考：</p>
<p><a href="http://www.ibm.com/developerworks/opensource/tutorials/os-androidndk/section5.html" target="_blank" rel="noopener">http://www.ibm.com/developerworks/opensource/tutorials/os-androidndk/section5.html</a></p>
<p><a href="http://developer.android.com/tools/sdk/ndk/index.html#Installing" target="_blank" rel="noopener">http://developer.android.com/tools/sdk/ndk/index.html#Installing</a></p>
<p><a href="http://stackoverflow.com/questions/2067955/fast-bitmap-blur-for-android-sdk" target="_blank" rel="noopener">http://stackoverflow.com/questions/2067955/fast-bitmap-blur-for-android-sdk</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2013/10/12/Android使用Fragment来实现ViewPager的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/10/12/Android使用Fragment来实现ViewPager的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信/" itemprop="url">Android使用Fragment来实现ViewPager的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-10-12T09:57:00+08:00">
                2013-10-12
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2013/10/12/Android使用Fragment来实现ViewPager的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2013/10/12/Android使用Fragment来实现ViewPager的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><span><span style="color: #ff0000;">以下内容为原创，转载请注明：<a href="http://www.cnblogs.com/tiantianbyconan/p/3364728.html" target="_blank" rel="noopener"><span style="color: #ff0000;">http://www.cnblogs.com/tiantianbyconan/p/3364728.html</span></a></span><a href="http://www.cnblogs.com/tiantianbyconan/p/3360938.html" target="_blank" rel="noopener"><span><br></span></a></span></strong></p>
<p>我前两天写过一篇博客《Android使用Fragment来实现TabHost的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信》（<a href="http://www.cnblogs.com/tiantianbyconan/p/3360938.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/3360938.html</a>），实现了Tab切换时保留当前Fragment状态，并在切换前自动回调onPause()方法，在切换后自动调用onResume()，这样就做到了跟TahHost一样的功能。</p>
<p>今天来实现下ViewPager的功能，google提供了一个FragmentPagerAdapter这么一个适配器，蛋疼的是，碰到了跟上次类似的问题。比如ViewPager有5个page，刚打开的时候，会加载page1和page2，我们手动切换到page2的时候，会加载page3，切换到page3的时候，加载page4的同时会destory掉page1，所以，还是面临同样的问题，page的状态无法保存，于是，咱还是自己来实现下好了，自己动手，丰衣足食嘛！（同样&nbsp;<span>有朋友知道解决办法的话，希望联系我，赐教下哈</span>）</p>
<p>先来看下整个demo的结构，跟上次实现TabHost的例子差不多：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201310/12093410-5a0bb7a1077d4614898ce8b0fbb85d07.jpg" alt=""></p>
<p><span>TabAFm到TabEFm都是Fragment，并且每个Fragment对应一个布局文件。</span></p>
<p><span><span>TabAFm.java：</span></span></p>
<p>&nbsp;</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('9a8422d4-8368-43fb-ba86-2c66b20d04f0')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_9a8422d4-8368-43fb-ba86-2c66b20d04f0" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.fragmentviewpagertest;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.app.Activity;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.Fragment;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.LayoutInflater;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.ViewGroup;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">11</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;">12</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">13</span> <span style="color: #008000;">  Date: 13-6-14<br></span><span style="color: #008080;">14</span> <span style="color: #008000;"> <em> Time: 下午2:39<br></em></span><span style="color: #008080;">15</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TabAFm <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Fragment{<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">18</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onAttach(Activity activity) {<br></span><span style="color: #008080;">19</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onAttach(activity);<br></span><span style="color: #008080;">20</span>         System.out.println(“AAAAAAAAAA<strong><strong>onAttach”<span style="color: #000000;">);<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">24</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;">25</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;">26</span>         System.out.println(“AAAAAAAAAA</strong></strong>onCreate”<span style="color: #000000;">);<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">30</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {<br></span><span style="color: #008080;">31</span>         System.out.println(“AAAAAAAAAA<strong><strong>onCreateView”<span style="color: #000000;">);<br></span><span style="color: #008080;">32</span>         <span style="color: #0000ff;">return</span> inflater.inflate(R.layout.tab_a, container, <span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">34</span><br><span style="color: #008080;">35</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">36</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onActivityCreated(Bundle savedInstanceState) {<br></span><span style="color: #008080;">37</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onActivityCreated(savedInstanceState);<br></span><span style="color: #008080;">38</span>         System.out.println(“AAAAAAAAAA</strong></strong>onActivityCreated”<span style="color: #000000;">);<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">42</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onStart() {<br></span><span style="color: #008080;">43</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onStart();<br></span><span style="color: #008080;">44</span>         System.out.println(“AAAAAAAAAA<strong><strong>onStart”<span style="color: #000000;">);<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">48</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onResume() {<br></span><span style="color: #008080;">49</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onResume();<br></span><span style="color: #008080;">50</span>         System.out.println(“AAAAAAAAAA</strong></strong>onResume”<span style="color: #000000;">);<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">52</span><br><span style="color: #008080;">53</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">54</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPause() {<br></span><span style="color: #008080;">55</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPause();<br></span><span style="color: #008080;">56</span>         System.out.println(“AAAAAAAAAA<strong><strong>onPause”<span style="color: #000000;">);<br></span><span style="color: #008080;">57</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">58</span><br><span style="color: #008080;">59</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">60</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onStop() {<br></span><span style="color: #008080;">61</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onStop();<br></span><span style="color: #008080;">62</span>         System.out.println(“AAAAAAAAAA</strong></strong>onStop”<span style="color: #000000;">);<br></span><span style="color: #008080;">63</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">64</span><br><span style="color: #008080;">65</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">66</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDestroyView() {<br></span><span style="color: #008080;">67</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDestroyView();<br></span><span style="color: #008080;">68</span>         System.out.println(“AAAAAAAAAA<strong><strong>onDestroyView”<span style="color: #000000;">);<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">70</span><br><span style="color: #008080;">71</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">72</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDestroy() {<br></span><span style="color: #008080;">73</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDestroy();<br></span><span style="color: #008080;">74</span>         System.out.println(“AAAAAAAAAA</strong></strong>onDestroy”<span style="color: #000000;">);<br></span><span style="color: #008080;">75</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">76</span><br><span style="color: #008080;">77</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">78</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDetach() {<br></span><span style="color: #008080;">79</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDetach();<br></span><span style="color: #008080;">80</span>         System.out.println(“AAAAAAAAAA____onDetach”<span style="color: #000000;">);<br></span><span style="color: #008080;">81</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">82</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>如上述代码所示，TabAFm是一个Fragment，对应的布局文件是tab_a.xml，并实现了他的所有的生命周期回调函数并打印，便于调试</p>
<p>tab_a.xml布局中有个EditText</p>
<p>其他的Fragment大同小异，这里就不贴出代码了</p>
<p>&nbsp;</p>
<p><span>现在来看MainActivity：</span></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('dbc347d7-5a93-47e3-90cc-e45cae3803c7')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_dbc347d7-5a93-47e3-90cc-e45cae3803c7" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.fragmentviewpagertest;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.Fragment;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.FragmentActivity;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.view.ViewPager;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> FragmentActivity {<br></span><span style="color: #008080;">12</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> ViewPager viewPager;<br></span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">public</span> List&lt;Fragment&gt; fragments = <span style="color: #0000ff;">new</span> ArrayList&lt;Fragment&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">14</span>     <span style="color: #0000ff;">public</span> String hello = “hello “<span style="color: #000000;">;<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;">18</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">        setContentView(R.layout.main);<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabAFm());<br></span><span style="color: #008080;">22</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabBFm());<br></span><span style="color: #008080;">23</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabCFm());<br></span><span style="color: #008080;">24</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabDFm());<br></span><span style="color: #008080;">25</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabEFm());<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span>         viewPager =<span style="color: #000000;"> (ViewPager) findViewById(R.id.viewPager);<br></span><span style="color: #008080;">28</span>         FragmentViewPagerAdapter adapter = <span style="color: #0000ff;">new</span> FragmentViewPagerAdapter(<span style="color: #0000ff;">this</span><span style="color: #000000;">.getSupportFragmentManager(), viewPager,fragments);<br></span><span style="color: #008080;">29</span>         adapter.setOnExtraPageChangeListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> FragmentViewPagerAdapter.OnExtraPageChangeListener(){<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">31</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onExtraPageSelected(<span style="color: #0000ff;">int</span><span style="color: #000000;"> i) {<br></span><span style="color: #008080;">32</span>                 System.out.println(“Extra…i: “ +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">35</span><br><span style="color: #008080;">36</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">37</span><br><span style="color: #008080;">38</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>MainActivity上述代码所示</p>
<p>MainActivity是包含Fragment的Activity（也就是这里的5个Fragment）</p>
<p>他继承了FragmentActivity（因为我这里用的是android-support-v4.jar）</p>
<p>用一个List&lt;Fragment&gt;去维护5个Fragment，也就是5个page。</p>
<p>MainActivity的布局很简单，就一个ViewPager，main.xml如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('0e611c66-2fd1-4dc0-9690-f0b0cbcacee6')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_0e611c66-2fd1-4dc0-9690-f0b0cbcacee6" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><br><span style="color: #008080;"> 3</span> <span style="color: #ff0000;">              android:orientation</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">              android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">              android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">android.support.v4.view.ViewPager<br></span><span style="color: #008080;"> 8</span>         <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/viewPager”</span><br><span style="color: #008080;"> 9</span> <span style="color: #ff0000;">        android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">10</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">11</span>         <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>&nbsp;</p>
<p><span>现在回到MainActivity中，下面这个FragmentViewPagerAdapter类是关键，是我自己编写的用于绑定和处理fragments和ViewPager之间的逻辑关系</span></p>
<div class="cnblogs_code"><br><pre>FragmentViewPagerAdapter adapter = <span style="color: #0000ff;">new</span> FragmentViewPagerAdapter(<span style="color: #0000ff;">this</span>.getSupportFragmentManager(), viewPager,fragments);</pre><br></div>

<p>&nbsp;</p>
<p><span>现在看下FragmentViewPagerAdapter：</span></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('f1a422a5-1bf1-44e2-9205-f1cf67fe1843')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_f1a422a5-1bf1-44e2-9205-f1cf67fe1843" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.fragmentviewpagertest;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.Fragment;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.FragmentManager;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.FragmentTransaction;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.view.PagerAdapter;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.view.ViewPager;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.ViewGroup;<br></span><span style="color: #008080;"> 10</span><br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;"> 12</span><br><span style="color: #008080;"> 13</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 14</span> <span style="color: #008000;"> <em> 为ViewPager添加布局（Fragment），绑定和处理fragments和viewpager之间的逻辑关系<br></em></span><span style="color: #008080;"> 15</span> <span style="color: #008000;"> <br></span><span style="color: #008080;"> 16</span> <span style="color: #008000;"> <em> Created with IntelliJ IDEA.<br></em></span><span style="color: #008080;"> 17</span> <span style="color: #008000;">  Author: wangjie  email:tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 18</span> <span style="color: #008000;"> <em> Date: 13-10-11<br></em></span><span style="color: #008080;"> 19</span> <span style="color: #008000;">  Time: 下午3:03<br></span><span style="color: #008080;"> 20</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> FragmentViewPagerAdapter <span style="color: #0000ff;">extends</span> PagerAdapter <span style="color: #0000ff;">implements</span><span style="color: #000000;"> ViewPager.OnPageChangeListener{<br></span><span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">private</span> List&lt;Fragment&gt; fragments; <span style="color: #008000;">//</span><span style="color: #008000;"> 每个Fragment对应一个Page</span><br><span style="color: #008080;"> 23</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> FragmentManager fragmentManager;<br></span><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">private</span> ViewPager viewPager; <span style="color: #008000;">//</span><span style="color: #008000;"> viewPager对象</span><br><span style="color: #008080;"> 25</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> currentPageIndex = 0; <span style="color: #008000;">//</span><span style="color: #008000;"> 当前page索引（切换之前）</span><br><span style="color: #008080;"> 26</span><br><span style="color: #008080;"> 27</span>     <span style="color: #0000ff;">private</span> OnExtraPageChangeListener onExtraPageChangeListener; <span style="color: #008000;">//</span><span style="color: #008000;"> ViewPager切换页面时的额外功能添加接口</span><br><span style="color: #008080;"> 28</span><br><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">public</span> FragmentViewPagerAdapter(FragmentManager fragmentManager, ViewPager viewPager , List&lt;Fragment&gt;<span style="color: #000000;"> fragments) {<br></span><span style="color: #008080;"> 30</span>         <span style="color: #0000ff;">this</span>.fragments =<span style="color: #000000;"> fragments;<br></span><span style="color: #008080;"> 31</span>         <span style="color: #0000ff;">this</span>.fragmentManager =<span style="color: #000000;"> fragmentManager;<br></span><span style="color: #008080;"> 32</span>         <span style="color: #0000ff;">this</span>.viewPager =<span style="color: #000000;"> viewPager;<br></span><span style="color: #008080;"> 33</span>         <span style="color: #0000ff;">this</span>.viewPager.setAdapter(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 34</span>         <span style="color: #0000ff;">this</span>.viewPager.setOnPageChangeListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 35</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 36</span><br><span style="color: #008080;"> 37</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 38</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getCount() {<br></span><span style="color: #008080;"> 39</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> fragments.size();<br></span><span style="color: #008080;"> 40</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 43</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isViewFromObject(View view, Object o) {<br></span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">return</span> view ==<span style="color: #000000;"> o;<br></span><span style="color: #008080;"> 45</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 46</span><br><span style="color: #008080;"> 47</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 48</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> destroyItem(ViewGroup container, <span style="color: #0000ff;">int</span><span style="color: #000000;"> position, Object object) {<br></span><span style="color: #008080;"> 49</span>         container.removeView(fragments.get(position).getView()); <span style="color: #008000;">//</span><span style="color: #008000;"> 移出viewpager两边之外的page布局</span><br><span style="color: #008080;"> 50</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 51</span><br><span style="color: #008080;"> 52</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">public</span> Object instantiateItem(ViewGroup container, <span style="color: #0000ff;">int</span><span style="color: #000000;"> position) {<br></span><span style="color: #008080;"> 54</span>         Fragment fragment =<span style="color: #000000;"> fragments.get(position);<br></span><span style="color: #008080;"> 55</span>         <span style="color: #0000ff;">if</span>(!fragment.isAdded()){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果fragment还没有added</span><br><span style="color: #008080;"> 56</span>             FragmentTransaction ft =<span style="color: #000000;"> fragmentManager.beginTransaction();<br></span><span style="color: #008080;"> 57</span> <span style="color: #000000;">            ft.add(fragment, fragment.getClass().getSimpleName());<br></span><span style="color: #008080;"> 58</span> <span style="color: #000000;">            ft.commit();<br></span><span style="color: #008080;"> 59</span>             <span style="color: #008000;">/</span><br><span style="color: #008080;"> 60</span> <span style="color: #008000;">             <em> 在用FragmentTransaction.commit()方法提交FragmentTransaction对象后<br></em></span><span style="color: #008080;"> 61</span> <span style="color: #008000;">              会在进程的主线程中，用异步的方式来执行。<br></span><span style="color: #008080;"> 62</span> <span style="color: #008000;">             <em> 如果想要立即执行这个等待中的操作，就要调用这个方法（只能在主线程中调用）。<br></em></span><span style="color: #008080;"> 63</span> <span style="color: #008000;">              要注意的是，所有的回调和相关的行为都会在这个调用中被执行完成，因此要仔细确认这个方法的调用位置。<br></span><span style="color: #008080;"> 64</span>              <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 65</span> <span style="color: #000000;">            fragmentManager.executePendingTransactions();<br></span><span style="color: #008080;"> 66</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 67</span><br><span style="color: #008080;"> 68</span>         <span style="color: #0000ff;">if</span>(fragment.getView().getParent() == <span style="color: #0000ff;">null</span><span style="color: #000000;">){<br></span><span style="color: #008080;"> 69</span>             container.addView(fragment.getView()); <span style="color: #008000;">//</span><span style="color: #008000;"> 为viewpager增加布局</span><br><span style="color: #008080;"> 70</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 71</span><br><span style="color: #008080;"> 72</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> fragment.getView();<br></span><span style="color: #008080;"> 73</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 74</span><br><span style="color: #008080;"> 75</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 76</span> <span style="color: #008000;">      当前page索引（切换之前）<br></span><span style="color: #008080;"> 77</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 78</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 79</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getCurrentPageIndex() {<br></span><span style="color: #008080;"> 80</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> currentPageIndex;<br></span><span style="color: #008080;"> 81</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 82</span><br><span style="color: #008080;"> 83</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> OnExtraPageChangeListener getOnExtraPageChangeListener() {<br></span><span style="color: #008080;"> 84</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> onExtraPageChangeListener;<br></span><span style="color: #008080;"> 85</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 86</span><br><span style="color: #008080;"> 87</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 88</span> <span style="color: #008000;">     <em> 设置页面切换额外功能监听器<br></em></span><span style="color: #008080;"> 89</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> onExtraPageChangeListener<br></span><span style="color: #008080;"> 90</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 91</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnExtraPageChangeListener(OnExtraPageChangeListener onExtraPageChangeListener) {<br></span><span style="color: #008080;"> 92</span>         <span style="color: #0000ff;">this</span>.onExtraPageChangeListener =<span style="color: #000000;"> onExtraPageChangeListener;<br></span><span style="color: #008080;"> 93</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 94</span><br><span style="color: #008080;"> 95</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 96</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onPageScrolled(<span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">float</span> v, <span style="color: #0000ff;">int</span><span style="color: #000000;"> i2) {<br></span><span style="color: #008080;"> 97</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> != onExtraPageChangeListener){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了额外功能接口</span><br><span style="color: #008080;"> 98</span> <span style="color: #000000;">            onExtraPageChangeListener.onExtraPageScrolled(i, v, i2);<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">100</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">101</span><br><span style="color: #008080;">102</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">103</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onPageSelected(<span style="color: #0000ff;">int</span><span style="color: #000000;"> i) {<br></span><span style="color: #008080;">104</span>         fragments.get(currentPageIndex).onPause(); <span style="color: #008000;">//</span><span style="color: #008000;"> 调用切换前Fargment的onPause()<br></span><span style="color: #008080;">105</span> <span style="color: #008000;">//</span><span style="color: #008000;">        fragments.get(currentPageIndex).onStop(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> 调用切换前Fargment的onStop()</span><br><span style="color: #008080;">106</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(fragments.get(i).isAdded()){<br></span><span style="color: #008080;">107</span> <span style="color: #008000;">//</span><span style="color: #008000;">            fragments.get(i).onStart(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> 调用切换后Fargment的onStart()</span><br><span style="color: #008080;">108</span>             fragments.get(i).onResume(); <span style="color: #008000;">//</span><span style="color: #008000;"> 调用切换后Fargment的onResume()</span><br><span style="color: #008080;">109</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">110</span>         currentPageIndex =<span style="color: #000000;"> i;<br></span><span style="color: #008080;">111</span><br><span style="color: #008080;">112</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> != onExtraPageChangeListener){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了额外功能接口</span><br><span style="color: #008080;">113</span> <span style="color: #000000;">            onExtraPageChangeListener.onExtraPageSelected(i);<br></span><span style="color: #008080;">114</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">115</span><br><span style="color: #008080;">116</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">117</span><br><span style="color: #008080;">118</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">119</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onPageScrollStateChanged(<span style="color: #0000ff;">int</span><span style="color: #000000;"> i) {<br></span><span style="color: #008080;">120</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> != onExtraPageChangeListener){ <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了额外功能接口</span><br><span style="color: #008080;">121</span> <span style="color: #000000;">            onExtraPageChangeListener.onExtraPageScrollStateChanged(i);<br></span><span style="color: #008080;">122</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">123</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">124</span><br><span style="color: #008080;">125</span><br><span style="color: #008080;">126</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">127</span> <span style="color: #008000;">     <em> page切换额外功能接口<br></em></span><span style="color: #008080;">128</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">129</span>     <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> OnExtraPageChangeListener{<br></span><span style="color: #008080;">130</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onExtraPageScrolled(<span style="color: #0000ff;">int</span> i, <span style="color: #0000ff;">float</span> v, <span style="color: #0000ff;">int</span><span style="color: #000000;"> i2){}<br></span><span style="color: #008080;">131</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onExtraPageSelected(<span style="color: #0000ff;">int</span><span style="color: #000000;"> i){}<br></span><span style="color: #008080;">132</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onExtraPageScrollStateChanged(<span style="color: #0000ff;">int</span><span style="color: #000000;"> i){}<br></span><span style="color: #008080;">133</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">134</span><br><span style="color: #008080;">135</span><br><span style="color: #008080;">136</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p><span>这里解决Fragment切换重新加载布局的办法，用的是把几个Fragment全部Add，然后根据要显示的哪个Fragment就把哪个Fragment的View给添加到&ldquo;ViewGroup container&rdquo;上去。</span></p>
<p><span>效果输出：</span></p>
<p><span>// 以下打开程序后，加载PageA和PageB</span></p>
<p>10-12 09:42:46.671: INFO/System.out(27248): AAAAAAAAAA<strong><strong>onAttach<br>10-12 09:42:46.671: INFO/System.out(27248): AAAAAAAAAA</strong></strong>onCreate<br>10-12 09:42:46.671: INFO/System.out(27248): AAAAAAAAAA<strong><strong>onCreateView<br>10-12 09:42:46.761: INFO/System.out(27248): AAAAAAAAAA</strong></strong>onActivityCreated<br>10-12 09:42:46.765: INFO/System.out(27248): AAAAAAAAAA<strong><strong>onStart<br>10-12 09:42:46.765: INFO/System.out(27248): AAAAAAAAAA</strong></strong>onResume<br>10-12 09:42:46.847: INFO/System.out(27248): BBBBBBBBBBB<strong><strong>onAttach<br>10-12 09:42:46.847: INFO/System.out(27248): BBBBBBBBBBB</strong></strong>onCreate<br>10-12 09:42:46.851: INFO/System.out(27248): BBBBBBBBBBB<strong><strong>onCreateView<br>10-12 09:42:46.867: INFO/System.out(27248): BBBBBBBBBBB</strong></strong>onActivityCreated<br>10-12 09:42:46.867: INFO/System.out(27248): BBBBBBBBBBB<strong><strong>onStart<br>10-12 09:42:46.867: INFO/System.out(27248): BBBBBBBBBBB</strong></strong>onResume</p>
<p>// 以下切换到PageB</p>
<p>10-12 09:42:57.285: INFO/System.out(27248): AAAAAAAAAA<strong><strong>onPause　　　　// 切换到PageB前会调用PageA的onPause()方法<br>10-12 09:42:57.285: INFO/System.out(27248): BBBBBBBBBBB</strong></strong>onResume　　// 切换到PageB后会调用PageB的onResume()方法<br>10-12 09:42:57.285: INFO/System.out(27248): Extra…i: 1　　　　　　　　　　　　// 切换页面时会调用切换额外功能接口（用户可以自己写需要的逻辑）<br>10-12 09:42:57.582: INFO/System.out(27248): CCCCCCCCCC<strong><strong>onAttach　　　　// 切换到PageB后会加载PageC<br>10-12 09:42:57.586: INFO/System.out(27248): CCCCCCCCCC</strong></strong>onCreate<br>10-12 09:42:57.586: INFO/System.out(27248): CCCCCCCCCC<strong><strong>onCreateView<br>10-12 09:42:57.675: INFO/System.out(27248): CCCCCCCCCC</strong></strong>onActivityCreated<br>10-12 09:42:57.675: INFO/System.out(27248): CCCCCCCCCC<strong><strong>onStart<br>10-12 09:42:57.675: INFO/System.out(27248): CCCCCCCCCC</strong></strong>onResume</p>
<p>// 以下切换到PageC</p>
<p>10-12 09:43:18.261: INFO/System.out(27248): BBBBBBBBBBB<strong><strong>onPause&nbsp;　　　　// 切换到PageC前会调用PageB的onPause()方法<br>10-12 09:43:18.261: INFO/System.out(27248): CCCCCCCCCC</strong></strong>onResume　　　　// 切换到PageC后会调用PageC的onResume()方法<br>10-12 09:43:18.261: INFO/System.out(27248): Extra…i: 2　　　　　　　　　　　　　　// 切换页面时会调用切换额外功能接口（用户可以自己写需要的逻辑）<br>10-12 09:43:18.726: INFO/System.out(27248): DDDDDDDDD<strong><strong>onAttach　　　　　　// 切换到PageC后会加载PageD<br>10-12 09:43:18.726: INFO/System.out(27248): DDDDDDDDD</strong></strong>onCreate<br>10-12 09:43:18.726: INFO/System.out(27248): DDDDDDDDD<strong><strong>onCreateView<br>10-12 09:43:18.738: INFO/System.out(27248): DDDDDDDDD</strong></strong>onActivityCreated<br>10-12 09:43:18.738: INFO/System.out(27248): DDDDDDDDD<strong><strong>onStart<br>10-12 09:43:18.742: INFO/System.out(27248): DDDDDDDDD</strong></strong>onResume</p>
<p>// 以下切换到PageB<br>10-12 09:43:20.742: INFO/System.out(27248): CCCCCCCCCC<strong><strong>onPause　　　　　　// 切换到PageB前会调用PageC的onPause()方法<br>10-12 09:43:20.742: INFO/System.out(27248): BBBBBBBBBBB</strong></strong>onResume　　　　//&nbsp;切换到PageB后会调用PageB的onResume()方法<br>10-12 09:43:20.746: INFO/System.out(27248): Extra…i: 1　　　　　　　　　　　　　　// 切换页面时会调用切换额外功能接口（用户可以自己写需要的逻辑）</p>
<p>&nbsp;</p>
<p>好了，到此为止，我们已经用Fragment实现了ViewPager的功能了，同样，下面来看下各个Fragment之间的通信</p>
<p>现在的情况是TabAFm中有个EditText，TabBFm中有个Button，MainActivity中有个变量&ldquo;hello&rdquo;</p>
<p>要做的是，切换到A，输入&ldquo;I’m PageA&rdquo;，切换到B，点击Button后，Toast显示&ldquo;hello I’m PageA&rdquo;</p>
<p>MainActivity中没什么好说的，就一个hello变量：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> String hello = “hello “;</pre><br></div>

<p><span>TabBFm中：</span></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('0e5b4cd8-d376-4ab8-aae2-68446bfeb227')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_0e5b4cd8-d376-4ab8-aae2-68446bfeb227" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">@Override<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onActivityCreated(Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onActivityCreated(savedInstanceState);<br></span><span style="color: #008080;"> 4</span>         System.out.println(“BBBBBBBBBBB____onActivityCreated”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">this</span>.getView().findViewById(R.id.clickme).setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener() {<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 7</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View view) {<br></span><span style="color: #008080;"> 8</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 获得绑定的FragmentActivity</span><br><span style="color: #008080;"> 9</span>                 MainActivity activity =<span style="color: #000000;"> ((MainActivity)getActivity());<br></span><span style="color: #008080;">10</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 获得TabAFm的控件</span><br><span style="color: #008080;">11</span>                 EditText editText = (EditText) activity.fragments.get(0<span style="color: #000000;">).getView().findViewById(R.id.edit);<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span>                 Toast.makeText(activity, activity.hello +<span style="color: #000000;"> editText.getText(), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">16</span>     }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>&nbsp;</p>
<p>最终效果图：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201310/12095728-8961829b190244259fb98e23eb7f59b5.png" alt=""></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong>demo下载：<a href="http://pan.baidu.com/s/1stGQ7" target="_blank" rel="noopener">http://pan.baidu.com/s/1stGQ7</a></strong></span></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2013/10/10/Android使用Fragment来实现TabHost的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/10/10/Android使用Fragment来实现TabHost的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信/" itemprop="url">Android使用Fragment来实现TabHost的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-10-10T11:37:00+08:00">
                2013-10-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2013/10/10/Android使用Fragment来实现TabHost的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2013/10/10/Android使用Fragment来实现TabHost的功能（解决切换Fragment状态不保存）以及各个Fragment之间的通信/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><span style="color: #ff0000;">以下内容为原创，转载请注明：<a href="http://www.cnblogs.com/tiantianbyconan/p/3360938.html" target="_blank" rel="noopener"><span style="color: #ff0000;">http://www.cnblogs.com/tiantianbyconan/p/3360938.html</span></a></span></strong></p>
<p><img src="http://images.cnitblog.com/blog/378300/201310/10104944-40b5dbc296894475bdaf8914a59d0498.png" alt=""></p>
<p>如新浪微博下面的标签切换功能，我以前也写过一篇博文（<a href="http://www.cnblogs.com/tiantianbyconan/archive/2012/02/24/2366237.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/archive/2012/02/24/2366237.html</a>），可以实现，用的是TabHost。但是android发展比较迅速，TabHost这玩意现在已经被弃用了，虽说用现在也能用，但是被弃用的东西还是少用为妙。</p>
<p>官方有个FragmentTabHost这么一个替代品，于是试了一下，发现每次切换tab，都会调用<span>onCreateView()方法，控件被重新加载，也就是说你从tab1切换到别的tab后，再切换回来，tab1的状态并没有保存，重新加载了控件。</span></p>
<p><span>搞了半天，暂时没有好的解决办法（有朋友知道解决办法的话，希望联系我，赐教下哈）</span></p>
<p><span style="line-height: 1.5;">于是，怒了，自己实现一个吧- -</span></p>
<p>&nbsp;</p>
<p><span style="line-height: 1.5;">先来看看整个demo的结构：</span></p>
<p><span style="line-height: 1.5;"><img src="http://images.cnitblog.com/blog/378300/201310/10110710-b8f18222f40441d4b46f9ae54fc2c83f.jpg" alt=""></span></p>
<p><span style="line-height: 1.5;">TabAFm到TabEFm都是Fragment，并且每个Fragment对应一个布局文件。</span></p>
<p><span style="line-height: 1.5;">TabAFm.java：</span></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('85262c98-765c-40bc-8095-dbdf4707c217')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_85262c98-765c-40bc-8095-dbdf4707c217" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.fragmenttabhost;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.app.Activity;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.Fragment;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.LayoutInflater;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.ViewGroup;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">11</span> <span style="color: #008000;">  Created with IntelliJ IDEA.<br></span><span style="color: #008080;">12</span> <span style="color: #008000;"> <em> Author: wangjie  email:tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">13</span> <span style="color: #008000;">  Date: 13-6-14<br></span><span style="color: #008080;">14</span> <span style="color: #008000;"> <em> Time: 下午2:39<br></em></span><span style="color: #008080;">15</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TabAFm <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Fragment{<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">18</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onAttach(Activity activity) {<br></span><span style="color: #008080;">19</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onAttach(activity);<br></span><span style="color: #008080;">20</span>         System.out.println(“AAAAAAAAAA<strong><strong>onAttach”<span style="color: #000000;">);<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">24</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;">25</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;">26</span>         System.out.println(“AAAAAAAAAA</strong></strong>onCreate”<span style="color: #000000;">);<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">30</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {<br></span><span style="color: #008080;">31</span>         System.out.println(“AAAAAAAAAA<strong><strong>onCreateView”<span style="color: #000000;">);<br></span><span style="color: #008080;">32</span>         <span style="color: #0000ff;">return</span> inflater.inflate(R.layout.tab_a, container, <span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">34</span><br><span style="color: #008080;">35</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">36</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onActivityCreated(Bundle savedInstanceState) {<br></span><span style="color: #008080;">37</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onActivityCreated(savedInstanceState);<br></span><span style="color: #008080;">38</span>         System.out.println(“AAAAAAAAAA</strong></strong>onActivityCreated”<span style="color: #000000;">);<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">42</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onStart() {<br></span><span style="color: #008080;">43</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onStart();<br></span><span style="color: #008080;">44</span>         System.out.println(“AAAAAAAAAA<strong><strong>onStart”<span style="color: #000000;">);<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">48</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onResume() {<br></span><span style="color: #008080;">49</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onResume();<br></span><span style="color: #008080;">50</span>         System.out.println(“AAAAAAAAAA</strong></strong>onResume”<span style="color: #000000;">);<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">52</span><br><span style="color: #008080;">53</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">54</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPause() {<br></span><span style="color: #008080;">55</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPause();<br></span><span style="color: #008080;">56</span>         System.out.println(“AAAAAAAAAA<strong><strong>onPause”<span style="color: #000000;">);<br></span><span style="color: #008080;">57</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">58</span><br><span style="color: #008080;">59</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">60</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onStop() {<br></span><span style="color: #008080;">61</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onStop();<br></span><span style="color: #008080;">62</span>         System.out.println(“AAAAAAAAAA</strong></strong>onStop”<span style="color: #000000;">);<br></span><span style="color: #008080;">63</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">64</span><br><span style="color: #008080;">65</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">66</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDestroyView() {<br></span><span style="color: #008080;">67</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDestroyView();<br></span><span style="color: #008080;">68</span>         System.out.println(“AAAAAAAAAA<strong><strong>onDestroyView”<span style="color: #000000;">);<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">70</span><br><span style="color: #008080;">71</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">72</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDestroy() {<br></span><span style="color: #008080;">73</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDestroy();<br></span><span style="color: #008080;">74</span>         System.out.println(“AAAAAAAAAA</strong></strong>onDestroy”<span style="color: #000000;">);<br></span><span style="color: #008080;">75</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">76</span><br><span style="color: #008080;">77</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">78</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDetach() {<br></span><span style="color: #008080;">79</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDetach();<br></span><span style="color: #008080;">80</span>         System.out.println(“AAAAAAAAAA____onDetach”<span style="color: #000000;">);<br></span><span style="color: #008080;">81</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">82</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>如上述代码所示，TabAFm是一个Fragment，对应的布局文件是tab_a.xml，并实现了他的所有的生命周期回调函数并打印，便于调试</p>
<p>tab_a.xml布局中有个EditText</p>
<p>其他的Fragment大同小异，这里就不贴出代码了</p>
<p>&nbsp;</p>
<p>现在来看MainActivity：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('fd8312f8-350d-43e1-95d2-8e9f8c7ec8dc')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_fd8312f8-350d-43e1-95d2-8e9f8c7ec8dc" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.fragmenttabhost;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.Fragment;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.FragmentActivity;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.RadioGroup;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> FragmentActivity {<br></span><span style="color: #008080;">12</span>     <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">13</span> <span style="color: #008000;">      Called when the activity is first created.<br></span><span style="color: #008080;">14</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> RadioGroup rgs;<br></span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">public</span> List&lt;Fragment&gt; fragments = <span style="color: #0000ff;">new</span> ArrayList&lt;Fragment&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">public</span> String hello = “hello “<span style="color: #000000;">;<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">        setContentView(R.layout.main);<br></span><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabAFm());<br></span><span style="color: #008080;">26</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabBFm());<br></span><span style="color: #008080;">27</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabCFm());<br></span><span style="color: #008080;">28</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabDFm());<br></span><span style="color: #008080;">29</span>         fragments.add(<span style="color: #0000ff;">new</span><span style="color: #000000;"> TabEFm());<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span><br><span style="color: #008080;">32</span>         rgs =<span style="color: #000000;"> (RadioGroup) findViewById(R.id.tabs_rg);<br></span><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span>         FragmentTabAdapter tabAdapter = <span style="color: #0000ff;">new</span> FragmentTabAdapter(<span style="color: #0000ff;">this</span><span style="color: #000000;">, fragments, R.id.tab_content, rgs);<br></span><span style="color: #008080;">35</span>         tabAdapter.setOnRgsExtraCheckedChangedListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> FragmentTabAdapter.OnRgsExtraCheckedChangedListener(){<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">37</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> OnRgsExtraCheckedChanged(RadioGroup radioGroup, <span style="color: #0000ff;">int</span> checkedId, <span style="color: #0000ff;">int</span><span style="color: #000000;"> index) {<br></span><span style="color: #008080;">38</span>                 System.out.println(“Extra—- “ + index + “ checked!!! “<span style="color: #000000;">);<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">41</span><br><span style="color: #008080;">42</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">43</span><br><span style="color: #008080;">44</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>MainActivity上述代码所示</p>
<p>MainActivity是包含Fragment的Activity（也就是这里的5个Fragment）</p>
<p>他继承了FragmentActivity（因为我这里用的是android-support-v4.jar）</p>
<p>用一个List&lt;Fragment&gt;去维护5个Fragment，也就是5个tab</p>
<p>main布局中有一个id为tab_content的FrameLayout，用来存放要显示的Fragment。底部有一个RadioGroup，用于tab的切换，如下：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('1616a5c6-aec1-4ccd-98f6-7d115ad2bef5')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_1616a5c6-aec1-4ccd-98f6-7d115ad2bef5" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;">  2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><br><span style="color: #008080;">  3</span> <span style="color: #ff0000;">              android:orientation</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;">  4</span> <span style="color: #ff0000;">              android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">  5</span> <span style="color: #ff0000;">              android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">  6</span> <span style="color: #ff0000;">              android:background</span><span style="color: #0000ff;">=”@android:color/white”</span><br><span style="color: #008080;">  7</span>         <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">  8</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout<br></span><span style="color: #008080;">  9</span>             <span style="color: #ff0000;">android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 10</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 11</span> <span style="color: #ff0000;">            android:orientation</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;"> 12</span>         <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 13</span><br><span style="color: #008080;"> 14</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">FrameLayout<br></span><span style="color: #008080;"> 15</span>             <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tab_content”</span><br><span style="color: #008080;"> 16</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 17</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”0dp”</span><br><span style="color: #008080;"> 18</span> <span style="color: #ff0000;">            android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span><br><span style="color: #008080;"> 19</span> <span style="color: #ff0000;">            android:background</span><span style="color: #0000ff;">=”#77557799”</span><br><span style="color: #008080;"> 20</span>             <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 21</span><br><span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioGroup<br></span><span style="color: #008080;"> 23</span>             <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tabs_rg”</span><br><span style="color: #008080;"> 24</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;"> 25</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 26</span> <span style="color: #ff0000;">            android:orientation</span><span style="color: #0000ff;">=”horizontal”</span><br><span style="color: #008080;"> 27</span> <span style="color: #ff0000;">            android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;"> 28</span> <span style="color: #ff0000;">            android:paddingTop</span><span style="color: #0000ff;">=”7dp”</span><br><span style="color: #008080;"> 29</span> <span style="color: #ff0000;">            android:paddingBottom</span><span style="color: #0000ff;">=”7dp”</span><br><span style="color: #008080;"> 30</span>             <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 31</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;"> 32</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tab_rb_a”</span><br><span style="color: #008080;"> 33</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”0dp”</span><br><span style="color: #008080;"> 34</span> <span style="color: #ff0000;">                android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 35</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tablatestalert”</span><br><span style="color: #008080;"> 36</span> <span style="color: #ff0000;">                android:button</span><span style="color: #0000ff;">=”@null”</span><br><span style="color: #008080;"> 37</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”Tab1”</span><br><span style="color: #008080;"> 38</span> <span style="color: #ff0000;">                android:textColor</span><span style="color: #0000ff;">=”#000000”</span><br><span style="color: #008080;"> 39</span> <span style="color: #ff0000;">                android:textSize</span><span style="color: #0000ff;">=”13sp”</span><br><span style="color: #008080;"> 40</span> <span style="color: #ff0000;">                android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span><br><span style="color: #008080;"> 41</span> <span style="color: #ff0000;">                android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;"> 42</span> <span style="color: #ff0000;">                android:singleLine</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;"> 43</span> <span style="color: #ff0000;">                android:checked</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;"> 44</span> <span style="color: #ff0000;">                android:background</span><span style="color: #0000ff;">=”@drawable/selector_tab”</span><br><span style="color: #008080;"> 45</span>                 <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;"> 47</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tab_rb_b”</span><br><span style="color: #008080;"> 48</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”0dp”</span><br><span style="color: #008080;"> 49</span> <span style="color: #ff0000;">                android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 50</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tabsearch”</span><br><span style="color: #008080;"> 51</span> <span style="color: #ff0000;">                android:button</span><span style="color: #0000ff;">=”@null”</span><br><span style="color: #008080;"> 52</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”Tab2”</span><br><span style="color: #008080;"> 53</span> <span style="color: #ff0000;">                android:textColor</span><span style="color: #0000ff;">=”#000000”</span><br><span style="color: #008080;"> 54</span> <span style="color: #ff0000;">                android:textSize</span><span style="color: #0000ff;">=”13sp”</span><br><span style="color: #008080;"> 55</span> <span style="color: #ff0000;">                android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span><br><span style="color: #008080;"> 56</span> <span style="color: #ff0000;">                android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;"> 57</span> <span style="color: #ff0000;">                android:singleLine</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;"> 58</span> <span style="color: #ff0000;">                android:background</span><span style="color: #0000ff;">=”@drawable/selector_tab”</span><br><span style="color: #008080;"> 59</span>                 <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 60</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;"> 61</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tab_rb_c”</span><br><span style="color: #008080;"> 62</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”0dp”</span><br><span style="color: #008080;"> 63</span> <span style="color: #ff0000;">                android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 64</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tabrecommd”</span><br><span style="color: #008080;"> 65</span> <span style="color: #ff0000;">                android:button</span><span style="color: #0000ff;">=”@null”</span><br><span style="color: #008080;"> 66</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”Tab3”</span><br><span style="color: #008080;"> 67</span> <span style="color: #ff0000;">                android:textColor</span><span style="color: #0000ff;">=”#000000”</span><br><span style="color: #008080;"> 68</span> <span style="color: #ff0000;">                android:textSize</span><span style="color: #0000ff;">=”13sp”</span><br><span style="color: #008080;"> 69</span> <span style="color: #ff0000;">                android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span><br><span style="color: #008080;"> 70</span> <span style="color: #ff0000;">                android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;"> 71</span> <span style="color: #ff0000;">                android:singleLine</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;"> 72</span> <span style="color: #ff0000;">                android:background</span><span style="color: #0000ff;">=”@drawable/selector_tab”</span><br><span style="color: #008080;"> 73</span>                 <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 74</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;"> 75</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tab_rb_d”</span><br><span style="color: #008080;"> 76</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”0dp”</span><br><span style="color: #008080;"> 77</span> <span style="color: #ff0000;">                android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 78</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tabconfigicon”</span><br><span style="color: #008080;"> 79</span> <span style="color: #ff0000;">                android:button</span><span style="color: #0000ff;">=”@null”</span><br><span style="color: #008080;"> 80</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”Tab4”</span><br><span style="color: #008080;"> 81</span> <span style="color: #ff0000;">                android:textColor</span><span style="color: #0000ff;">=”#000000”</span><br><span style="color: #008080;"> 82</span> <span style="color: #ff0000;">                android:textSize</span><span style="color: #0000ff;">=”13sp”</span><br><span style="color: #008080;"> 83</span> <span style="color: #ff0000;">                android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span><br><span style="color: #008080;"> 84</span> <span style="color: #ff0000;">                android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;"> 85</span> <span style="color: #ff0000;">                android:singleLine</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;"> 86</span> <span style="color: #ff0000;">                android:background</span><span style="color: #0000ff;">=”@drawable/selector_tab”</span><br><span style="color: #008080;"> 87</span>                 <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 88</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RadioButton<br></span><span style="color: #008080;"> 89</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/tab_rb_e”</span><br><span style="color: #008080;"> 90</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”0dp”</span><br><span style="color: #008080;"> 91</span> <span style="color: #ff0000;">                android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 92</span> <span style="color: #ff0000;">                android:drawableTop</span><span style="color: #0000ff;">=”@drawable/tababoutus”</span><br><span style="color: #008080;"> 93</span> <span style="color: #ff0000;">                android:button</span><span style="color: #0000ff;">=”@null”</span><br><span style="color: #008080;"> 94</span> <span style="color: #ff0000;">                android:text</span><span style="color: #0000ff;">=”Tab5”</span><br><span style="color: #008080;"> 95</span> <span style="color: #ff0000;">                android:textColor</span><span style="color: #0000ff;">=”#000000”</span><br><span style="color: #008080;"> 96</span> <span style="color: #ff0000;">                android:textSize</span><span style="color: #0000ff;">=”13sp”</span><br><span style="color: #008080;"> 97</span> <span style="color: #ff0000;">                android:layout_weight</span><span style="color: #0000ff;">=”1.0”</span><br><span style="color: #008080;"> 98</span> <span style="color: #ff0000;">                android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;"> 99</span> <span style="color: #ff0000;">                android:singleLine</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;">100</span> <span style="color: #ff0000;">                android:background</span><span style="color: #0000ff;">=”@drawable/selector_tab”</span><br><span style="color: #008080;">101</span>                 <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">102</span><br><span style="color: #008080;">103</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">RadioGroup</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">104</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">105</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>现在回到MainActivity中，下面这个FragmentTabAdapter类是关键，是我自己编写的用于绑定和处理fragments和RadioGroup之间的逻辑关系</p>
<div class="cnblogs_code"><br><pre>FragmentTabAdapter tabAdapter = <span style="color: #0000ff;">new</span> FragmentTabAdapter(<span style="color: #0000ff;">this</span>, fragments, R.id.tab_content, rgs);</pre><br></div>

<p>&nbsp;</p>
<p>现在看下FragmentTabAdapter：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('1827caab-5f05-4ffc-9974-0616b027aa79')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_1827caab-5f05-4ffc-9974-0616b027aa79" class="cnblogs_code_hide"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.fragmenttabhost;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.Fragment;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.FragmentActivity;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v4.app.FragmentTransaction;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.RadioGroup;<br></span><span style="color: #008080;">  7</span><br><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;">  9</span><br><span style="color: #008080;"> 10</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 11</span> <span style="color: #008000;"> <em> Created with IntelliJ IDEA.<br></em></span><span style="color: #008080;"> 12</span> <span style="color: #008000;">  Author: wangjie  email:tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 13</span> <span style="color: #008000;"> <em> Date: 13-10-10<br></em></span><span style="color: #008080;"> 14</span> <span style="color: #008000;">  Time: 上午9:25<br></span><span style="color: #008080;"> 15</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> FragmentTabAdapter <span style="color: #0000ff;">implements</span><span style="color: #000000;"> RadioGroup.OnCheckedChangeListener{<br></span><span style="color: #008080;"> 17</span>     <span style="color: #0000ff;">private</span> List&lt;Fragment&gt; fragments; <span style="color: #008000;">//</span><span style="color: #008000;"> 一个tab页面对应一个Fragment</span><br><span style="color: #008080;"> 18</span>     <span style="color: #0000ff;">private</span> RadioGroup rgs; <span style="color: #008000;">//</span><span style="color: #008000;"> 用于切换tab</span><br><span style="color: #008080;"> 19</span>     <span style="color: #0000ff;">private</span> FragmentActivity fragmentActivity; <span style="color: #008000;">//</span><span style="color: #008000;"> Fragment所属的Activity</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> fragmentContentId; <span style="color: #008000;">//</span><span style="color: #008000;"> Activity中所要被替换的区域的id</span><br><span style="color: #008080;"> 21</span><br><span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> currentTab; <span style="color: #008000;">//</span><span style="color: #008000;"> 当前Tab页面索引</span><br><span style="color: #008080;"> 23</span><br><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">private</span> OnRgsExtraCheckedChangedListener onRgsExtraCheckedChangedListener; <span style="color: #008000;">//</span><span style="color: #008000;"> 用于让调用者在切换tab时候增加新的功能</span><br><span style="color: #008080;"> 25</span><br><span style="color: #008080;"> 26</span>     <span style="color: #0000ff;">public</span> FragmentTabAdapter(FragmentActivity fragmentActivity, List&lt;Fragment&gt; fragments, <span style="color: #0000ff;">int</span><span style="color: #000000;"> fragmentContentId, RadioGroup rgs) {<br></span><span style="color: #008080;"> 27</span>         <span style="color: #0000ff;">this</span>.fragments =<span style="color: #000000;"> fragments;<br></span><span style="color: #008080;"> 28</span>         <span style="color: #0000ff;">this</span>.rgs =<span style="color: #000000;"> rgs;<br></span><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">this</span>.fragmentActivity =<span style="color: #000000;"> fragmentActivity;<br></span><span style="color: #008080;"> 30</span>         <span style="color: #0000ff;">this</span>.fragmentContentId =<span style="color: #000000;"> fragmentContentId;<br></span><span style="color: #008080;"> 31</span><br><span style="color: #008080;"> 32</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 默认显示第一页</span><br><span style="color: #008080;"> 33</span>         FragmentTransaction ft =<span style="color: #000000;"> fragmentActivity.getSupportFragmentManager().beginTransaction();<br></span><span style="color: #008080;"> 34</span>         ft.add(fragmentContentId, fragments.get(0<span style="color: #000000;">));<br></span><span style="color: #008080;"> 35</span> <span style="color: #000000;">        ft.commit();<br></span><span style="color: #008080;"> 36</span><br><span style="color: #008080;"> 37</span>         rgs.setOnCheckedChangeListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 38</span><br><span style="color: #008080;"> 39</span><br><span style="color: #008080;"> 40</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 43</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCheckedChanged(RadioGroup radioGroup, <span style="color: #0000ff;">int</span><span style="color: #000000;"> checkedId) {<br></span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; rgs.getChildCount(); i++<span style="color: #000000;">){<br></span><span style="color: #008080;"> 45</span>             <span style="color: #0000ff;">if</span>(rgs.getChildAt(i).getId() ==<span style="color: #000000;"> checkedId){<br></span><span style="color: #008080;"> 46</span>                 Fragment fragment =<span style="color: #000000;"> fragments.get(i);<br></span><span style="color: #008080;"> 47</span>                 FragmentTransaction ft =<span style="color: #000000;"> obtainFragmentTransaction(i);<br></span><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span>                 getCurrentFragment().onPause(); <span style="color: #008000;">//</span><span style="color: #008000;"> 暂停当前tab<br></span><span style="color: #008080;"> 50</span> <span style="color: #008000;">//</span><span style="color: #008000;">                getCurrentFragment().onStop(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> 暂停当前tab</span><br><span style="color: #008080;"> 51</span><br><span style="color: #008080;"> 52</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;">(fragment.isAdded()){<br></span><span style="color: #008080;"> 53</span> <span style="color: #008000;">//</span><span style="color: #008000;">                    fragment.onStart(); </span><span style="color: #008000;">//</span><span style="color: #008000;"> 启动目标tab的onStart()</span><br><span style="color: #008080;"> 54</span>                     fragment.onResume(); <span style="color: #008000;">//</span><span style="color: #008000;"> 启动目标tab的onResume()</span><br><span style="color: #008080;"> 55</span>                 }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">                    ft.add(fragmentContentId, fragment);<br></span><span style="color: #008080;"> 57</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 58</span>                 showTab(i); <span style="color: #008000;">//</span><span style="color: #008000;"> 显示目标tab</span><br><span style="color: #008080;"> 59</span> <span style="color: #000000;">                ft.commit();<br></span><span style="color: #008080;"> 60</span><br><span style="color: #008080;"> 61</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了切换tab额外功能功能接口</span><br><span style="color: #008080;"> 62</span>                 <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> onRgsExtraCheckedChangedListener){<br></span><span style="color: #008080;"> 63</span> <span style="color: #000000;">                    onRgsExtraCheckedChangedListener.OnRgsExtraCheckedChanged(radioGroup, checkedId, i);<br></span><span style="color: #008080;"> 64</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 65</span><br><span style="color: #008080;"> 66</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 68</span><br><span style="color: #008080;"> 69</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 70</span><br><span style="color: #008080;"> 71</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 72</span> <span style="color: #008000;">     <em> 切换tab<br></em></span><span style="color: #008080;"> 73</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> idx<br></span><span style="color: #008080;"> 74</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 75</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> showTab(<span style="color: #0000ff;">int</span><span style="color: #000000;"> idx){<br></span><span style="color: #008080;"> 76</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i = 0; i &lt; fragments.size(); i++<span style="color: #000000;">){<br></span><span style="color: #008080;"> 77</span>             Fragment fragment =<span style="color: #000000;"> fragments.get(i);<br></span><span style="color: #008080;"> 78</span>             FragmentTransaction ft =<span style="color: #000000;"> obtainFragmentTransaction(idx);<br></span><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span>             <span style="color: #0000ff;">if</span>(idx ==<span style="color: #000000;"> i){<br></span><span style="color: #008080;"> 81</span> <span style="color: #000000;">                ft.show(fragment);<br></span><span style="color: #008080;"> 82</span>             }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 83</span> <span style="color: #000000;">                ft.hide(fragment);<br></span><span style="color: #008080;"> 84</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 85</span> <span style="color: #000000;">            ft.commit();<br></span><span style="color: #008080;"> 86</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 87</span>         currentTab = idx; <span style="color: #008000;">//</span><span style="color: #008000;"> 更新目标tab为当前tab</span><br><span style="color: #008080;"> 88</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 89</span><br><span style="color: #008080;"> 90</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 91</span> <span style="color: #008000;">      获取一个带动画的FragmentTransaction<br></span><span style="color: #008080;"> 92</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> index<br></span><span style="color: #008080;"> 93</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 94</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 95</span>     <span style="color: #0000ff;">private</span> FragmentTransaction obtainFragmentTransaction(<span style="color: #0000ff;">int</span><span style="color: #000000;"> index){<br></span><span style="color: #008080;"> 96</span>         FragmentTransaction ft =<span style="color: #000000;"> fragmentActivity.getSupportFragmentManager().beginTransaction();<br></span><span style="color: #008080;"> 97</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置切换动画</span><br><span style="color: #008080;"> 98</span>         <span style="color: #0000ff;">if</span>(index &gt;<span style="color: #000000;"> currentTab){<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">            ft.setCustomAnimations(R.anim.slide_left_in, R.anim.slide_left_out);<br></span><span style="color: #008080;">100</span>         }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;">101</span> <span style="color: #000000;">            ft.setCustomAnimations(R.anim.slide_right_in, R.anim.slide_right_out);<br></span><span style="color: #008080;">102</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">103</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> ft;<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">105</span><br><span style="color: #008080;">106</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getCurrentTab() {<br></span><span style="color: #008080;">107</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> currentTab;<br></span><span style="color: #008080;">108</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">109</span><br><span style="color: #008080;">110</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Fragment getCurrentFragment(){<br></span><span style="color: #008080;">111</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> fragments.get(currentTab);<br></span><span style="color: #008080;">112</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">113</span><br><span style="color: #008080;">114</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> OnRgsExtraCheckedChangedListener getOnRgsExtraCheckedChangedListener() {<br></span><span style="color: #008080;">115</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> onRgsExtraCheckedChangedListener;<br></span><span style="color: #008080;">116</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">117</span><br><span style="color: #008080;">118</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnRgsExtraCheckedChangedListener(OnRgsExtraCheckedChangedListener onRgsExtraCheckedChangedListener) {<br></span><span style="color: #008080;">119</span>         <span style="color: #0000ff;">this</span>.onRgsExtraCheckedChangedListener =<span style="color: #000000;"> onRgsExtraCheckedChangedListener;<br></span><span style="color: #008080;">120</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">121</span><br><span style="color: #008080;">122</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">123</span> <span style="color: #008000;">       切换tab额外功能功能接口<br></span><span style="color: #008080;">124</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">125</span>     <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> OnRgsExtraCheckedChangedListener{<br></span><span style="color: #008080;">126</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> OnRgsExtraCheckedChanged(RadioGroup radioGroup, <span style="color: #0000ff;">int</span> checkedId, <span style="color: #0000ff;">int</span><span style="color: #000000;"> index){<br></span><span style="color: #008080;">127</span><br><span style="color: #008080;">128</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">129</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">130</span><br><span style="color: #008080;">131</span> }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div>

<p>这里解决Fragment切换重新加载布局的办法，用的是把几个Fragment全部Add，然后根据要显示的哪个Fragment设置show或者hide</p>
<p>效果输出：</p>
<p>10-10 11:55:41.168: INFO/System.out(18368): AAAAAAAAAA<strong><strong>onAttach　　　　　　<span style="color: #0000ff;">// 第一次进入，显示TabA</span><br>10-10 11:55:41.168: INFO/System.out(18368): AAAAAAAAAA</strong></strong>onCreate<br>10-10 11:55:41.168: INFO/System.out(18368): AAAAAAAAAA<strong><strong>onCreateView<br>10-10 11:55:41.175: INFO/System.out(18368): AAAAAAAAAA</strong></strong>onActivityCreated<br>10-10 11:55:41.179: INFO/System.out(18368): AAAAAAAAAA<strong><strong>onStart<br>10-10 11:55:41.179: INFO/System.out(18368): AAAAAAAAAA</strong></strong>onResume<br>10-10 11:55:44.980: INFO/System.out(18368): AAAAAAAAAA<strong><strong>onPause　　　　　　<span style="color: #0000ff;">// 从TabA切换到TabB（TabA调用onPause）</span><br>10-10 11:55:44.980: INFO/System.out(18368): Extra—- 1 checked!!!<br>10-10 11:55:44.996: INFO/System.out(18368): BBBBBBBBBBB</strong></strong>onAttach<br>10-10 11:55:44.996: INFO/System.out(18368): BBBBBBBBBBB<strong><strong>onCreate<br>10-10 11:55:44.996: INFO/System.out(18368): BBBBBBBBBBB</strong></strong>onCreateView<br>10-10 11:55:45.004: INFO/System.out(18368): BBBBBBBBBBB<strong><strong>onActivityCreated<br>10-10 11:55:45.004: INFO/System.out(18368): BBBBBBBBBBB</strong></strong>onStart<br>10-10 11:55:45.004: INFO/System.out(18368): BBBBBBBBBBB<strong><strong>onResume<br>10-10 11:55:52.062: INFO/System.out(18368): BBBBBBBBBBB</strong></strong>onPause　　　　　　<span style="color: #0000ff;">// 从TabB切换到TabC（TabB调用onPause）</span><br>10-10 11:55:52.062: INFO/System.out(18368): Extra—- 2 checked!!!<br>10-10 11:55:52.082: INFO/System.out(18368): CCCCCCCCCC<strong><strong>onAttach<br>10-10 11:55:52.082: INFO/System.out(18368): CCCCCCCCCC</strong></strong>onCreate<br>10-10 11:55:52.086: INFO/System.out(18368): CCCCCCCCCC<strong><strong>onCreateView<br>10-10 11:55:52.090: INFO/System.out(18368): CCCCCCCCCC</strong></strong>onActivityCreated<br>10-10 11:55:52.090: INFO/System.out(18368): CCCCCCCCCC<strong><strong>onStart<br>10-10 11:55:52.090: INFO/System.out(18368): CCCCCCCCCC</strong></strong>onResume<br>10-10 11:56:06.535: INFO/System.out(18368): CCCCCCCCCC<strong><strong>onPause　　　　　　<span style="color: #0000ff;">// 从TabC切换到TabB（TabC调用onPause）</span><br>10-10 11:56:06.535: INFO/System.out(18368): BBBBBBBBBBB</strong></strong>onResume　　　　<span style="color: #0000ff;">//&nbsp;从TabC切换到TabB（TabB调用onResume）</span><br>10-10 11:56:06.535: INFO/System.out(18368): Extra—- 1 checked!!!</p>
<p>&nbsp;</p>
<p>好了，到此为止，我们已经用Fragment实现了类似TabHost的功能了，下面来看下各个Fragment之间的通信</p>
<p>现在的情况是TabAFm中有个EditText，TabBFm中有个Button，MainActivity中有个变量&ldquo;hello&rdquo;</p>
<p>要做的是，切换到TabA，输入&ldquo;I’m TabA&rdquo;，切换到B，点击Button后，Toast显示&ldquo;hello I’m TabA&rdquo;</p>
<p>MainActivity中没什么好说的，就一个hello变量：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">public</span> String hello = “hello “;</pre><br></div>

<p>TabAFm在布局文件tab_a.xml中加个EditText，设置个id就可以了</p>
<p>TabBFm中：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('584d6f2a-4f17-4bc3-b261-291e61788031')"><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""><br><div id="cnblogs_code_open_584d6f2a-4f17-4bc3-b261-291e61788031" class="cnblogs_code_hide"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">@Override<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onActivityCreated(Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onActivityCreated(savedInstanceState);<br></span><span style="color: #008080;"> 4</span>         System.out.println(“BBBBBBBBBBB____onActivityCreated”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">this</span>.getView().findViewById(R.id.clickme).setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener() {<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 7</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View view) {<br></span><span style="color: #008080;"> 8</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 获得绑定的FragmentActivity</span><br><span style="color: #008080;"> 9</span>                 MainActivity activity =<span style="color: #000000;"> ((MainActivity)getActivity());<br></span><span style="color: #008080;">10</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 获得TabAFm的控件</span><br><span style="color: #008080;">11</span>                 EditText editText = (EditText) activity.fragments.get(0<span style="color: #000000;">).getView().findViewById(R.id.edit);<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span>                 Toast.makeText(activity, activity.hello +<span style="color: #000000;"> editText.getText(), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">16</span>     }</pre><br></div><br><span class="cnblogs_code_collapse">View Code </span></div><br><div class="cnblogs_code"><br><pre><span style="color: #008000;">//</span><span style="color: #008000;"> 获得绑定的FragmentActivity</span><br>MainActivity activity = ((MainActivity)getActivity());</pre><br></div>

<p>通过getActivity()即可得到Fragment所在的FragmentActivity</p>
<p>&nbsp;</p>
<p>最终效果图：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201310/10114324-42b27a496916463e91d7400c5c3d1884.png" alt=""></p>
<p><span style="color: #ff0000;"><strong>demo下载地址：<a href="http://pan.baidu.com/s/1wxsIX" target="_blank" rel="noopener"><span style="color: #ff0000;">http://pan.baidu.com/s/1wxsIX</span></a></strong></span></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2013/10/08/Hibernate3注解-转/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2013/10/08/Hibernate3注解-转/" itemprop="url">Hibernate3注解[转]</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-10-08T14:40:00+08:00">
                2013-10-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2013/10/08/Hibernate3注解-转/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2013/10/08/Hibernate3注解-转/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>&nbsp;Hibernate3注解 收藏&nbsp;<br>1、@Entity(name=”EntityName”)&nbsp;<br>必须,name为可选,对应数据库中一的个表</p>
<p>2、@Table(name=””,catalog=””,schema=””)&nbsp;<br>可选,通常和@Entity配合使用,只能标注在实体的class定义处,表示实体对应的数据库表的信息&nbsp;<br>name:可选,表示表的名称.默认地,表名和实体名称一致,只有在不一致的情况下才需要指定表名&nbsp;<br>catalog:可选,表示Catalog名称,默认为Catalog(“”).&nbsp;<br>schema:可选,表示Schema名称,默认为Schema(“”).</p>
<p>3、@id&nbsp;<br>必须&nbsp;<br>@id定义了映射到数据库表的主键的属性,一个实体只能有一个属性被映射为主键.置于getXxxx()前.</p>
<p>4、@GeneratedValue(strategy=GenerationType,generator=””)&nbsp;<br>可选&nbsp;<br>strategy:表示主键生成策略,有AUTO,INDENTITY,SEQUENCE 和 TABLE 4种,分别表示让ORM框架自动选择,&nbsp;<br>根据数据库的Identity字段生成,根据数据库表的Sequence字段生成,以有根据一个额外的表生成主键,默认为AUTO&nbsp;<br>generator:表示主键生成器的名称,这个属性通常和ORM框架相关,例如,Hibernate可以指定uuid等主键生成方式.&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @Id&nbsp;<br>&nbsp;&nbsp;&nbsp; @GeneratedValues(strategy=StrategyType.SEQUENCE)&nbsp;<br>&nbsp;&nbsp;&nbsp; public int getPk() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return pk;&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>5、@Basic(fetch=FetchType,optional=true)&nbsp;<br>可选&nbsp;<br>@Basic表示一个简单的属性到数据库表的字段的映射,对于没有任何标注的getXxxx()方法,默认即为@Basic&nbsp;<br>fetch: 表示该属性的读取策略,有EAGER和LAZY两种,分别表示主支抓取和延迟加载,默认为EAGER.&nbsp;<br>optional:表示该属性是否允许为null,默认为true&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @Basic(optional=false)&nbsp;<br>&nbsp;&nbsp;&nbsp; public String getAddress() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return address;&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>6、@Column&nbsp;<br>可选&nbsp;<br>@Column描述了数据库表中该字段的详细定义,这对于根据JPA注解生成数据库表结构的工具非常有作用.&nbsp;<br>name:表示数据库表中该字段的名称,默认情形属性名称一致&nbsp;<br>nullable:表示该字段是否允许为null,默认为true&nbsp;<br>unique:表示该字段是否是唯一标识,默认为false&nbsp;<br>length:表示该字段的大小,仅对String类型的字段有效&nbsp;<br>insertable:表示在ORM框架执行插入操作时,该字段是否应出现INSETRT语句中,默认为true&nbsp;<br>updateable:表示在ORM框架执行更新操作时,该字段是否应该出现在UPDATE语句中,默认为true.对于一经创建就不可以更改的字段,该属性非常有用,如对于birthday字段.&nbsp;<br>columnDefinition:表示该字段在数据库中的实际类型.通常ORM框架可以根据属性类型自动判断数据库中字段的类型,但是对于Date类型仍无法确定数据库中字段类型究竟是DATE,TIME还是TIMESTAMP.此外,String的默认映射类型为VARCHAR,如果要将String类型映射到特定数据库的BLOB或TEXT字段类型,该属性非常有用.&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @Column(name=”BIRTH”,nullable=”false”,columnDefinition=”DATE”)&nbsp;<br>&nbsp;&nbsp;&nbsp; public String getBithday() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return birthday;&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>7、@Transient&nbsp;<br>可选&nbsp;<br>@Transient表示该属性并非一个到数据库表的字段的映射,ORM框架将忽略该属性.&nbsp;<br>如果一个属性并非数据库表的字段映射,就务必将其标示为@Transient,否则,ORM框架默认其注解为@Basic&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; //根据birth计算出age属性&nbsp;<br>&nbsp;&nbsp;&nbsp; @Transient&nbsp;<br>&nbsp;&nbsp;&nbsp; public int getAge() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return getYear(new Date()) - getYear(birth);&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>8、@ManyToOne(fetch=FetchType,cascade=CascadeType)&nbsp;<br>可选&nbsp;<br>@ManyToOne表示一个多对一的映射,该注解标注的属性通常是数据库表的外键&nbsp;<br>optional:是否允许该字段为null,该属性应该根据数据库表的外键约束来确定,默认为true&nbsp;<br>fetch:表示抓取策略,默认为FetchType.EAGER&nbsp;<br>cascade:表示默认的级联操作策略,可以指定为ALL,PERSIST,MERGE,REFRESH和REMOVE中的若干组合,默认为无级联操作&nbsp;<br>targetEntity:表示该属性关联的实体类型.该属性通常不必指定,ORM框架根据属性类型自动判断targetEntity.&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; //订单Order和用户User是一个ManyToOne的关系&nbsp;<br>&nbsp;&nbsp;&nbsp; //在Order类中定义&nbsp;<br>&nbsp;&nbsp;&nbsp; @ManyToOne()&nbsp;<br>&nbsp;&nbsp;&nbsp; @JoinColumn(name=”USER”)&nbsp;<br>&nbsp;&nbsp;&nbsp; public User getUser() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return user;&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>9、@JoinColumn&nbsp;<br>可选&nbsp;<br>@JoinColumn和@Column类似,介量描述的不是一个简单字段,而一一个关联字段,例如.描述一个@ManyToOne的字段.&nbsp;<br>name:该字段的名称.由于@JoinColumn描述的是一个关联字段,如ManyToOne,则默认的名称由其关联的实体决定.&nbsp;<br>例如,实体Order有一个user属性来关联实体User,则Order的user属性为一个外键,&nbsp;<br>其默认的名称为实体User的名称+下划线+实体User的主键名称&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; 见@ManyToOne</p>
<p>10、@OneToMany(fetch=FetchType,cascade=CascadeType)&nbsp;<br>可选&nbsp;<br>@OneToMany描述一个一对多的关联,该属性应该为集体类型,在数据库中并没有实际字段.&nbsp;<br>fetch:表示抓取策略,默认为FetchType.LAZY,因为关联的多个对象通常不必从数据库预先读取到内存&nbsp;<br>cascade:表示级联操作策略,对于OneToMany类型的关联非常重要,通常该实体更新或删除时,其关联的实体也应当被更新或删除&nbsp;<br>例如:实体User和Order是OneToMany的关系,则实体User被删除时,其关联的实体Order也应该被全部删除&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @OneTyMany(cascade=ALL)&nbsp;<br>&nbsp;&nbsp;&nbsp; public List getOrders() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return orders;&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>11、@OneToOne(fetch=FetchType,cascade=CascadeType)&nbsp;<br>可选&nbsp;<br>@OneToOne描述一个一对一的关联&nbsp;<br>fetch:表示抓取策略,默认为FetchType.LAZY&nbsp;<br>cascade:表示级联操作策略&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @OneToOne(fetch=FetchType.LAZY)&nbsp;<br>&nbsp;&nbsp;&nbsp; public Blog getBlog() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return blog;&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>12、@ManyToMany&nbsp;<br>可选&nbsp;<br>@ManyToMany 描述一个多对多的关联.多对多关联上是两个一对多关联,但是在ManyToMany描述中,中间表是由ORM框架自动处理&nbsp;<br>targetEntity:表示多对多关联的另一个实体类的全名,例如:package.Book.class&nbsp;<br>mappedBy:表示多对多关联的另一个实体类的对应集合属性名称&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; User实体表示用户,Book实体表示书籍,为了描述用户收藏的书籍,可以在User和Book之间建立ManyToMany关联&nbsp;<br>&nbsp;&nbsp;&nbsp; @Entity&nbsp;<br>&nbsp;&nbsp;&nbsp; public class User {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private List books;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @ManyToMany(targetEntity=package.Book.class)&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public List getBooks() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return books;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void setBooks(List books) {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.books=books;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; @Entity&nbsp;<br>&nbsp;&nbsp;&nbsp; public class Book {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private List users;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @ManyToMany(targetEntity=package.Users.class, mappedBy=”books”)&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public List getUsers() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return users;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void setUsers(List users) {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.users=users;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp; }&nbsp;<br>两个实体间相互关联的属性必须标记为@ManyToMany,并相互指定targetEntity属性,&nbsp;<br>需要注意的是,有且只有一个实体的@ManyToMany注解需要指定mappedBy属性,指向targetEntity的集合属性名称&nbsp;<br>利用ORM工具自动生成的表除了User和Book表外,还自动生成了一个User_Book表,用于实现多对多关联</p>
<p>13、@MappedSuperclass&nbsp;<br>可选&nbsp;<br>@MappedSuperclass可以将超类的JPA注解传递给子类,使子类能够继承超类的JPA注解&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @MappedSuperclass&nbsp;<br>&nbsp;&nbsp;&nbsp; public class Employee() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ….&nbsp;<br>&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp; @Entity&nbsp;<br>&nbsp;&nbsp;&nbsp; public class Engineer extends Employee {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; …..&nbsp;<br>&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp; @Entity&nbsp;<br>&nbsp;&nbsp;&nbsp; public class Manager extends Employee {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; …..&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>14、@Embedded&nbsp;<br>可选&nbsp;<br>@Embedded将几个字段组合成一个类,并作为整个Entity的一个属性.&nbsp;<br>例如User包括id,name,city,street,zip属性.&nbsp;<br>我们希望city,street,zip属性映射为Address对象.这样,User对象将具有id,name和address这三个属性.&nbsp;<br>Address对象必须定义为@Embededable&nbsp;<br>示例:&nbsp;<br>&nbsp;&nbsp;&nbsp; @Embeddable&nbsp;<br>&nbsp;&nbsp;&nbsp; public class Address {city,street,zip}&nbsp;<br>&nbsp;&nbsp;&nbsp; @Entity&nbsp;<br>&nbsp;&nbsp;&nbsp; public class User {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @Embedded&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Address getAddress() {&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ……….&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br>&nbsp;&nbsp;&nbsp; }</p>
<p>　　现在，让我们来动手使用Hibernate Annotation。</p>
<p>安装 Hibernate Annotation&nbsp;<br>　　要使用 Hibernate Annotation，您至少需要具备 Hibernate 3.2和Java 5。可以从 Hibernate 站点 下载 Hibernate 3.2 和 Hibernate Annotation库。除了标准的 Hibernate JAR 和依赖项之外，您还需要 Hibernate Annotations .jar 文件（hibernate-annotations.jar）、Java 持久性 API （lib/ejb3-persistence.jar）。如果您正在使用 Maven，只需要向 POM 文件添加相应的依赖项即可，如下所示：</p>
<p>&nbsp;&nbsp;&nbsp; …&nbsp;<br>&lt;dependency&gt;&nbsp;<br>&lt;groupId&gt;org.hibernate&lt;/groupId&gt;&nbsp;<br>&lt;artifactId&gt;hibernate&lt;/artifactId&gt;&nbsp;<br>&lt;version&gt;3.2.1.ga&lt;/version&gt;&nbsp;<br>&lt;/dependency&gt;&nbsp;<br>&lt;dependency&gt;&nbsp;<br>&lt;groupId&gt;org.hibernate&lt;/groupId&gt;&nbsp;<br>&lt;artifactId&gt;hibernate-annotations&lt;/artifactId&gt;&nbsp;<br>&lt;version&gt;3.2.0.ga&lt;/version&gt;&nbsp;<br>&lt;/dependency&gt;&nbsp;<br>&lt;dependency&gt;&nbsp;<br>&lt;groupId&gt;javax.persistence&lt;/groupId&gt;&nbsp;<br>&lt;artifactId&gt;persistence-api&lt;/artifactId&gt;&nbsp;<br>&lt;version&gt;1.0&lt;/version&gt;&nbsp;<br>&lt;/dependency&gt;&nbsp;<br>…&nbsp;<br>　　下一步就是获取 Hibernate 会话工厂。尽管无需惊天的修改，但这一工作与使用 Hibernate Annotations有所不同。您需要使用 AnnotationConfiguration 类来建立会话工厂：</p>
<p>sessionFactory = new&nbsp;<br>AnnotationConfiguration().buildSessionFactory();&nbsp;<br>　　尽管通常使用 &lt;mapping&gt; 元素来声明持久性类，您还是需要在 Hibernate 配置文件（通常是 hibernate.cfg.xml）中声明持久性类：</p>
<p>&lt;!DOCTYPE hibernate-configuration PUBLIC&nbsp;<br>“-//Hibernate/Hibernate Configuration DTD 3.0//EN”&nbsp;<br>“<a href="http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd" target="_blank" rel="noopener">http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd</a>“&gt;&nbsp;<br>&lt;hibernate-configuration&gt;&nbsp;<br>&lt;session-factory&gt;&nbsp;<br>&lt;mapping class=”com.onjava.modelplanes.domain.PlaneType”/&gt;&nbsp;<br>&lt;mapping class=”com.onjava.modelplanes.domain.ModelPlane”/&gt;&nbsp;<br>&lt;/session-factory&gt;&nbsp;<br>&lt;/hibernate-configuration&gt;&nbsp;<br>　　近期的许多 Java 项目都使用了轻量级的应用框架，例如 Spring。如果您正在使用 Spring 框架，可以使用 AnnotationSessionFactoryBean 类轻松建立一个基于注释的 Hibernate 会话工厂，如下所示：</p>
<p>&lt;!– Hibernate session factory –&gt;&nbsp;<br>&lt;bean id=”sessionFactory”&nbsp;<br>class=”org.springframework.orm.hibernate3.annotation.AnnotationSessionFactoryBean”&gt;&nbsp;<br>&lt;property name=”dataSource”&gt;&nbsp;<br>&lt;ref bean=”dataSource”/&gt;&nbsp;<br>&lt;/property&gt;&nbsp;<br>&lt;property name=”hibernateProperties”&gt;&nbsp;<br>&lt;props&gt;&nbsp;<br>&lt;prop key=”hibernate.dialect”&gt;org.hibernate.dialect.DerbyDialect&lt;/prop&gt;&nbsp;<br>&lt;prop key=”hibernate.hbm2ddl.auto”&gt;create&lt;/prop&gt;&nbsp;<br>…&nbsp;<br>&lt;/props&gt;&nbsp;<br>&lt;/property&gt;&nbsp;<br>&lt;property name=”annotatedClasses”&gt;&nbsp;<br>&lt;list&gt;&nbsp;<br>&lt;value&gt;com.onjava.modelplanes.domain.PlaneType&lt;/value&gt;&nbsp;<br>&lt;value&gt;com.onjava.modelplanes.domain.ModelPlane&lt;/value&gt;&nbsp;<br>…&nbsp;<br>&lt;/list&gt;&nbsp;<br>&lt;/property&gt;&nbsp;<br>&lt;/bean&gt;&nbsp;<br>第一个持久性类&nbsp;<br>　　既然已经知道了如何获得注释所支持的 Hibernate 会话，下面让我们来了解一下带注释的持久性类的情况：</p>
<p>　　像在其他任何 Hibernate应用程序中一样，带注释的持久性类也是普通 POJO。差不多可以说是。您需要向 Java 持久性 API （javax.persistence.<em>）添加依赖项，如果您正在使用任何特定于 Hibernate的扩展，那很可能就是 Hibernate Annotation 程序包（org.hibernate.annotations.</em>），但除此之外，它们只是具备了持久性注释的普通 POJO 。下面是一个简单的例子：</p>
<p>@Entity&nbsp;<br>public class ModelPlane {&nbsp;<br>private Long id;&nbsp;<br>private String name;&nbsp;<br>@Id&nbsp;<br>public Long getId() {&nbsp;<br>return id;&nbsp;<br>}&nbsp;<br>public void setId(Long id) {&nbsp;<br>this.id = id;&nbsp;<br>}&nbsp;<br>public String getName() {&nbsp;<br>return name;&nbsp;<br>}&nbsp;<br>public void setName(String name) {&nbsp;<br>this.name = name;&nbsp;<br>}&nbsp;<br>}&nbsp;<br>　　正像我们所提到的，这非常简单。@Entity 注释声明该类为持久类。@Id 注释可以表明哪种属性是该类中的独特标识符。事实上，您既可以保持字段（注释成员变量），也可以保持属性（注释getter方法）的持久性。后文中将使用基于属性的注释。基于注释的持久性的优点之一在于大量使用了默认值（最大的优点就是 &ldquo;惯例优先原则（convention over configuration）&rdquo;）。例如，您无需说明每个属性的持久性&mdash;&mdash;任何属性都被假定为持久的，除非您使用 @Transient 注释来说明其他情况。这简化了代码，相对使用老的 XML 映射文件而言也大幅地减少了输入工作量。</p>
<p>生成主键&nbsp;<br>　　Hibernate 能够出色地自动生成主键。Hibernate/EBJ 3 注释也可以为主键的自动生成提供丰富的支持，允许实现各种策略。下面的示例说明了一种常用的方法，其中 Hibernate 将会根据底层数据库来确定一种恰当的键生成策略：</p>
<p>@Id&nbsp;<br>@GeneratedValue(strategy=GenerationType.AUTO)&nbsp;<br>public Long getId() {&nbsp;<br>return id;&nbsp;<br>}&nbsp;<br>定制表和字段映射&nbsp;<br>　　默认情况下，Hibernate 会将持久类以匹配的名称映射到表和字段中。例如，前一个类可以与映射到以如下代码创建的表中：</p>
<p>CREATE TABLE MODELPLANE&nbsp;<br>(&nbsp;<br>ID long,&nbsp;<br>NAME varchar&nbsp;<br>)&nbsp;<br>　　如果您是自己生成并维护数据库，那么这种方法很有效，通过省略代码可以大大简化代码维护。然而，这并不能满足所有人的需求。有些应用程序需要访问外部数据库，而另一些可能需要遵从公司的数据库命名惯例。如果有必要，您可以使用 @Table 和 @Column 注释来定制您自己的持久性映射，如下所示：</p>
<p>@Entity&nbsp;<br>@Table(name=”T_MODEL_PLANE”)&nbsp;<br>public class ModelPlane {&nbsp;<br>private Long id;&nbsp;<br>private String name;&nbsp;<br>@Id&nbsp;<br>@Column(name=”PLANE_ID”)&nbsp;<br>public Long getId() {&nbsp;<br>return id;&nbsp;<br>}&nbsp;<br>public void setId(Long id) {&nbsp;<br>this.id = id;&nbsp;<br>}&nbsp;<br>@Column(name=”PLANE_NAME”)&nbsp;<br>public String getName() {&nbsp;<br>return name;&nbsp;<br>}&nbsp;<br>public void setName(String name) {&nbsp;<br>this.name = name;&nbsp;<br>}&nbsp;<br>}&nbsp;<br>　　该内容将映射到下表中：</p>
<p>CREATE TABLE T_MODEL_PLANE&nbsp;<br>(&nbsp;<br>PLANE_ID long,&nbsp;<br>PLANE_NAME varchar&nbsp;<br>)&nbsp;<br>　　也可以使用其他图和列的属性来定制映射。这使您可以指定诸如列长度、非空约束等详细内容。Hibernate支持大量针对这些注释的属性。下例中就包含了几种属性：</p>
<p>&nbsp;&nbsp;&nbsp; …&nbsp;<br>@Column(name=”PLANE_ID”, length=80, nullable=true)&nbsp;<br>public String getName() {&nbsp;<br>return name;&nbsp;<br>}&nbsp;<br>…&nbsp;<br>映射关系&nbsp;<br>　　Java 持久性映射过程中最重要和最复杂的一环就是确定如何映射表间的关系。像其他产品一样， Hibernate 在该领域中提供了高度的灵活性，但却是以复杂度的增加为代价。我们将通过研究几个常见案例来了解如何使用注释来处理这一问题。</p>
<p>　　其中一种最常用的关系就是多对一的关系。假定在以上示例中每个 ModelPlane 通过多对一的关系（也就是说，每个飞机模型只与一种飞机类型建立联系，尽管指定的飞机类型可以与七种飞机模型建立联系）来与 PlaneType 建立联系。可如下进行映射：</p>
<p>&nbsp;&nbsp;&nbsp; @ManyToOne( cascade = {CascadeType.PERSIST, CascadeType.MERGE} )&nbsp;<br>public PlaneType getPlaneType() {&nbsp;<br>return planeType;&nbsp;<br>}&nbsp;<br>　　CascadeType 值表明 Hibernate 应如何处理级联操作。</p>
<p>　　另一种常用的关系与上述关系相反：一对多再对一关系，也称为集合。在老式的 Hibernate 版本中进行映射或使用注释时，集合令人头疼，这里我们将简要加以探讨，以使您了解如何处理集合，例如，在以上示例中每个 PlaneType 对象都可能会包含一个 ModelPlanes 集合。可映射如下：</p>
<p>@OneToMany(mappedBy=”planeType”,&nbsp;<br>cascade=CascadeType.ALL,&nbsp;<br>fetch=FetchType.EAGER)&nbsp;<br>@OrderBy(“name”)&nbsp;<br>public List&lt;ModelPlane&gt; getModelPlanes() {&nbsp;<br>return modelPlanes;&nbsp;<br>}&nbsp;<br>命名查询&nbsp;<br>　　Hibernate 最优秀的功能之一就在于它能够在您的映射文件中声明命名查询。随后即可通过代码中的名称调用此类查询，这使您可以专注于查询，而避免了 SQL 或者 HQL 代码分散于整个应用程序中的情况。</p>
<p>　　也可以使用注释来实现命名查询，可以使用 @NamedQueries 和 @NamedQuery 注释，如下所示：</p>
<p>@NamedQueries(&nbsp;<br>{&nbsp;<br>@NamedQuery(&nbsp;<br>name=”planeType.findById”,&nbsp;<br>query=”select p from PlaneType p left join fetch p.modelPlanes where id=:id”&nbsp;<br>),&nbsp;<br>@NamedQuery(&nbsp;<br>name=”planeType.findAll”,&nbsp;<br>query=”select p from PlaneType p”&nbsp;<br>),&nbsp;<br>@NamedQuery(&nbsp;<br>name=”planeType.delete”,&nbsp;<br>query=”delete from PlaneType where id=:id”&nbsp;<br>)&nbsp;<br>}&nbsp;<br>)&nbsp;<br>　　一旦完成了定义，您就可以像调用其他任何其他命名查询一样来调用它们。</p>
<p>结束语&nbsp;<br>　　Hibernate 3 注释提供了强大而精致的 API，简化了 Java 数据库中的持久性代码，本文中只进行了简单的讨论。您可以选择遵从标准并使用 Java 持久性 API，也可以利用特定于 Hibernate的扩展，这些功能以损失可移植性为代价提供了更为强大的功能和更高的灵活性。无论如何，通过消除对 XML 映射文件的需求，Hibernate 注释将简化应用程序的维护，同时也可以使您对EJB 3 有初步认识。来试试吧！&nbsp;<br>&nbsp;<br>&nbsp;<br>本文来自CSDN博客，转载请标明出处：<a href="http://blog.csdn.net/dingqinghu/archive/2011/03/25/6275798.aspx" target="_blank" rel="noopener">http://blog.csdn.net/dingqinghu/archive/2011/03/25/6275798.aspx</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/my_avatar.jpg"
                alt="Wang Jie" />
            
              <p class="site-author-name" itemprop="name">Wang Jie</p>
              <p class="site-description motion-element" itemprop="description">Wang Jie's blog</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">144</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wangjiegulu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:tiantian.china.2@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/+%E5%A4%A9%E5%A4%A9wangjie" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/wangjiegulu" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/users/2124006/wangjie" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/wangjiegulu" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i></a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.cnblogs.com/tiantianbyconan/" title="cnblog" target="_blank">cnblog</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Jie</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>








        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://blog-wangjiegulu-com.disqus.com/count.js" async></script>
    

    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "default";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "GooglePlus,Evernote,Twitter,Facebook,Douban,Weibo";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  

  

  

</body>
</html>

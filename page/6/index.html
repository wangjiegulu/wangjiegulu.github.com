<!DOCTYPE html>




<html class="theme-next muse" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="WAND JIE" type="application/atom+xml" />






<meta name="description" content="Wang Jie&apos;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="WAND JIE">
<meta property="og:url" content="http://blog.wangjiegulu.com/page/6/index.html">
<meta property="og:site_name" content="WAND JIE">
<meta property="og:description" content="Wang Jie&apos;s blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WAND JIE">
<meta name="twitter:description" content="Wang Jie&apos;s blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.wangjiegulu.com/page/6/"/>





  <title>WAND JIE</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-111189680-2', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WAND JIE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">TO BE AN ARTIST-ENGINNER</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/04/02/Android-使用Gradle提交自己开源Android库到Maven中心库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/04/02/Android-使用Gradle提交自己开源Android库到Maven中心库/" itemprop="url">[Android]使用Gradle提交自己开源Android库到Maven中心库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-04-02T19:38:00+08:00">
                2015-04-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/04/02/Android-使用Gradle提交自己开源Android库到Maven中心库/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/04/02/Android-使用Gradle提交自己开源Android库到Maven中心库/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="color: #ff0000;"><strong>以下内容为原创，欢迎转载，转载请注明</strong></span></p>
<p><span style="color: #ff0000;"><strong>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/4388175.html%20" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4388175.html&nbsp;</a></strong></span></p>
<p>&nbsp;</p>
<p>此文针对开源爱好者。</p>
<p>如果你想让别人使用你的Android开源库，第一种方法是，提供你的Github地址，让别人clone一份，然后让别人import到他的项目中。另一种更简单的方式就是直接让别人在他的Gradle中添加你的库依赖，如下：</p>
<div class="cnblogs_code"><br><pre>compile ‘com.github.wangjiegulu:AndroidBucket:1.0.1’</pre><br></div>

<p>如果想使用第二种方式，你需要将你的项目提交到公共的中心库。</p>
<p>这里介绍使用sonatype来把你的开源库（snapshot或release）提交到Maven的中心库。<strong>
</strong></p>
<p>1. 首先，在<a href="https://issues.sonatype.org" target="_blank" rel="noopener">https://issues.sonatype.org</a>中注册账号。</p>
<p>2. 然后在<a href="https://issues.sonatype.org/secure/CreateIssue.jspa?issuetype=21&amp;pid=10134" target="_blank" rel="noopener">https://issues.sonatype.org/secure/CreateIssue.jspa?issuetype=21&amp;pid=10134</a>中新建一个&ldquo;Project ticket&rdquo;。</p>
<p>－Summary：填写项目名称<span class="aui-icon icon-required"><br></span></p>
<p>－Description：填写描述</p>
<p>－Group Id：域名反转，如果没有域名，就直接使用github反转（如github.com/wangjiegulu –&gt; com.github.wangjiegulu），具体看<a href="http://central.sonatype.org/pages/choosing-your-coordinates.html" target="_blank" rel="noopener">http://central.sonatype.org/pages/choosing-your-coordinates.html</a><span class="aui-icon icon-required"><br></span></p>
<p>－Project URL：项目的url，可以是项目的github地址。如<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket</a></p>
<p>－SCM url：版本控制的uri，如<a href="https://github.com/wangjiegulu/AndroidBucket.git" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket.git</a></p>
<p>3. 创建完毕后就等待状态变为&ldquo;resolved&rdquo;，然后你就可以使用Gradle上传项目了。</p>
<p>4. 上传前需要进行GPG签名，所以先去下载GPG（<a href="https://www.gnupg.org/download/index.html" target="_blank" rel="noopener">https://www.gnupg.org/download/index.html</a>），然后打开</p>
<p><img src="http://images.cnitblog.com/blog2015/378300/201504/021841366545243.png" alt=""></p>
<p>新建一个Keychain，完成后右键&ldquo;Send Public Key to Key Server&rdquo;，这样就能把你的public key发送到服务端。</p>
<p>5. 然后我们再打包项目的aar文件，intellij idea和android studio使用gradle构建后，会在build中自动生成该文件，直接把他拷出来即可。</p>
<p>6. 然后新建build.gradle来进行我们的上传操作，大概内容如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008000;">//</span><span style="color: #008000;"> <strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></span><span style="color: #000000;"><br>apply plugin: </span>‘maven’<span style="color: #000000;"><br>apply plugin: </span>‘signing’ <span style="color: #008000;">//</span><span style="color: #008000;">使用signing plugin做数字签名<br><br></span><span style="color: #008000;">//</span><span style="color: #008000;">定义GroupID和Version，ArtefactID会自动使用Project名</span><br>group = ‘com.github.wangjiegulu’<span style="color: #000000;"><br>version </span>= ‘1.0.1’<br><span style="color: #000000;"><br>repositories {<br>    mavenCentral();<br>}<br><br>artifacts {<br>    archives file(</span>‘AndroidBucket.aar’<span style="color: #000000;">)<br>}<br>signing {<br>    sign configurations.archives<br>}</span><br><span style="color: #000000;"><br>uploadArchives {<br>    repositories {<br>        mavenDeployer {<br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">为Pom文件做数字签名</span><br>            beforeDeployment { MavenDeployment deployment -&gt;<span style="color: #000000;"> signing.signPom(deployment) }<br><br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">指定项目部署到的中央库地址，UserName和Password就是Part 1中注册的账号。</span><br>            repository(url: “<a href="https://oss.sonatype.org/service/local/staging/deploy/maven2/" target="_blank" rel="noopener">https://oss.sonatype.org/service/local/staging/deploy/maven2/</a>“<span style="color: #000000;">) {<br>                authentication(userName: ossrhUsername, password: ossrhPassword)<br>            }<br>            snapshotRepository(url: </span>“<a href="https://oss.sonatype.org/content/repositories/snapshots/" target="_blank" rel="noopener">https://oss.sonatype.org/content/repositories/snapshots/</a>“<span style="color: #000000;">) {<br>                authentication(userName: ossrhUsername, password: ossrhPassword)<br>            }<br><br>            </span><span style="color: #008000;">//</span><span style="color: #008000;">构造项目的Pom文件，参见Part 2中Pom文件的规范，不要遗漏必填项</span><br><span style="color: #000000;">            pom.project {<br>                name project.name<br>                packaging </span>‘aar’<span style="color: #000000;"><br>                description </span>‘Android开发常用整理’<span style="color: #000000;"><br>                url </span>‘<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket</a>‘<span style="color: #000000;"><br><br>                scm {<br>                    url </span>‘scm:git@github.com:wangjiegulu/AndroidBucket.git’<span style="color: #000000;"><br>                    connection </span>‘scm:git@github.com:wangjiegulu/AndroidBucket.git’<span style="color: #000000;"><br>                    developerConnection </span>‘git@github.com:wangjiegulu/AndroidBucket.git’<span style="color: #000000;"><br>                }<br><br>                licenses {<br>                    license {<br>                        name </span>‘The Apache Software License, Version 2.0’<span style="color: #000000;"><br>                        url </span>‘<a href="http://www.apache.org/licenses/LICENSE-2.0.txt" target="_blank" rel="noopener">http://www.apache.org/licenses/LICENSE-2.0.txt</a>‘<span style="color: #000000;"><br>                        distribution </span>‘wangjie’<span style="color: #000000;"><br>                    }<br>                }<br><br>                developers {<br>                    developer {<br>                        id </span>‘wangjie’<span style="color: #000000;"><br>                        name </span>‘Wagn Jie’<span style="color: #000000;"><br>                        email </span>‘tiantian.china.2@gmail.com’<span style="color: #000000;"><br>                    }<br>                }<br>            }<br>        }<br>    }<br>}</span></pre><br></div>

<p>archives file(‘AndroidBucket.aar’) 表示指定上传的aar文件。</p>
<div class="cnblogs_code"><br><pre><span style="color: #000000;">signing {<br>    sign configurations.archives<br>}</span></pre><br></div>

<p>表示对内容进行gpg签名，既然需要签名，那需要在gradle.properites中配置key的信息，还有上传的账号密码：</p>
<div class="cnblogs_code"><br><pre>signing.keyId=<span style="color: #000000;">XXXXXXXXX<br>signing.password</span>=XXXXXXXXX<span style="color: #000000;"><br>signing.secretKeyRingFile</span>=/Users/wangjie/.gnupg/secring.gpg</pre><br><br>&nbsp; ossrhUsername=oss.sonatype.org或者issues.sonatype.org的账号（同一个）<br>&nbsp; ossrhPassword=oss.sonatype.org或者issues.sonatype.org的密码（同一个）<br><br></div>

<p>所有配置完毕后执行gradle&nbsp;uploadArchives进行上传操作。</p>
<p>7. 登录<a href="https://oss.sonatype.org" target="_blank" rel="noopener">https://oss.sonatype.org</a>，点击左边的&ldquo;Staging Repositories&rdquo;，然后刚刚上传的项目名称为com.github.wangjiegulu去掉点-数字</p>
<p>选中后点击&ldquo;Close&rdquo;，如果成功，则再点击&ldquo;Release&rdquo;按钮发布。</p>
<p>然后再等待2小时，就可以在Maven中心库中搜索到了。</p>
<p>&nbsp;</p>
<p>注意：以后如果需要再上传其它项目的时候，直接从第4步开始即可，因为你的groupId已经申请过了，以后新的artifacts可以直接部署到这个groupId中。</p>
<p>&nbsp;</p>
<p>参考：<a href="http://central.sonatype.org/pages/ossrh-guide.html" target="_blank" rel="noopener">http://central.sonatype.org/pages/ossrh-guide.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/02/28/100个高质量Java开发者博客/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/28/100个高质量Java开发者博客/" itemprop="url">100个高质量Java开发者博客</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-02-28T18:22:00+08:00">
                2015-02-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/02/28/100个高质量Java开发者博客/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/02/28/100个高质量Java开发者博客/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ImportNew注：原文中还没有100个。作者希望大家一起来推荐高质量的Java开发博客，然后不段补充到这个列表。欢迎你也参与推荐优质的Java开发博客。（声明一下：我们的数学不是体育老师教的！:) ）</p>
<p>本文的主要目的是收集全球范围内100个高质量Java开发者博客。其中会有一些博客并不是由纯粹的Java开发者撰写的，但是Java开发者们能够从中发现一些有用的或者有趣的东西。阅读这些博客将会非常有趣，有时会给你带来一些新鲜的想法。</p>
<p>Google的排名算法中，大型网站的排位会比较高。这对一些小型的高质量博客来说并不公平。有些站点的流量非常大，但是质量并不高。我对高质量的定义是：</p>
<ol>
<li>文章具有可读性并且是原创的。</li>
<li>文章作者对技术本身有着浓厚的兴趣。</li>
<li>文章在个人理解的基础上提出一些创造性的想法。</li>
<li>博客中没有太多的广告。</li>
<li>博客的更新频率比较高。</li>
</ol>
<p>因此，很多Google排名靠前的博客并没有出现在下面的列表里。如果你知道一些值得推荐的博客，请留言告诉我。由于这个列表正在快速增长，请只推荐高质量的博客站点。</p>
<div id="text-13"><br><div class="textwidget"><br><table style="height: 1033px; width: 763px;"><br><tbody><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">&nbsp;</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><strong>名称(站点名或人名)</strong></span></td><br><td valign="top" width="101"><span style="font-size: 14px;"><strong>国家</strong></span></td><br><td valign="top" width="261"><span style="font-size: 14px;"><strong>备注</strong></span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">1</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.adam-bien.com/roller/abien/" target="_blank" rel="noopener">Adam&nbsp;Bien</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">德国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE相关</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">2</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://antoniogoncalves.org/" target="_blank" rel="noopener">Antonio&nbsp;Goncalves</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">法国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE相关（《Java&nbsp;EE&nbsp;5》和《Java&nbsp;EE&nbsp;7》的作者）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">3</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://henrikwarne.com/" target="_blank" rel="noopener">Henrik&nbsp;Warne</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">瑞典</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">编程过程中的一些思考</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">4</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://keaplogik.blogspot.com/" target="_blank" rel="noopener">Billy&nbsp;Yarosh</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java日常开发中的实用代码示例</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">5</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.vogella.com/" target="_blank" rel="noopener">Lars&nbsp;Vogel</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">德国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java、Android&nbsp;和<span class="wp_keywordlink"><a href="http://res.importnew.com/eclipse" title="Eclipse ImportNew主页" target="_blank" rel="noopener">Eclipse</a></span></span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">6</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://javax0.wordpress.com/" target="_blank" rel="noopener">Peter&nbsp;Verhas</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">匈牙利</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">纯粹的Java</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">7</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://martinfowler.com/" target="_blank" rel="noopener">Martin&nbsp;Fowler</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">面向对象设计专家和咨询师</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">8</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://techblog.bozho.net/" target="_blank" rel="noopener">Bozhidar&nbsp;Bozhanov</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">保加利亚</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE相关</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">9</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://insightfullogic.com/blog/" target="_blank" rel="noopener">Richard&nbsp;Warburton</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">英国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;8&nbsp;Lambdas</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">10</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://invariantproperties.com/" target="_blank" rel="noopener">Bear&nbsp;Giles</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE相关</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">11</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.mikiobraun.de/" target="_blank" rel="noopener">Marginally&nbsp;Interesting</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">德国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">机器学习</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">12</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://pragmaticintegrator.wordpress.com/" target="_blank" rel="noopener">Pascal&nbsp;Alma</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE相关</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">13</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.drorhelper.com/" target="_blank" rel="noopener">Dror&nbsp;Helper</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">代码测试和代码质量</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">14</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://juristr.com/" target="_blank" rel="noopener">Juri&nbsp;Strumpflohner</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">意大利</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">JavaScript</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">15</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="https://blogs.oracle.com/reza/" target="_blank" rel="noopener">Reza&nbsp;Rahman</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE/Glassfish</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">16</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.bigfastblog.com/" target="_blank" rel="noopener">Phil&nbsp;Whelan</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">加拿大</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Web技术</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">17</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://brettporter.wordpress.com/" target="_blank" rel="noopener">Brett&nbsp;Porter</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">澳大利亚</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Apache&nbsp;Maven&nbsp;2的作者</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">18</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.benmccann.com/blog/" target="_blank" rel="noopener">Ben&nbsp;McCann</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">一些实用的操作指南（Connectifier的联合创始人）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">19</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.javaposse.com/" target="_blank" rel="noopener">Java&nbsp;Posse</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java相关的一些有用的链接</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">20</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.markhneedham.com/blog/" target="_blank" rel="noopener">Mark&nbsp;Needham</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">英国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">数据处理</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">21</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.takipiblog.com/" target="_blank" rel="noopener">Iris&nbsp;Shoor</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">以色列</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">调试技术、性能等</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">22</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.pengyifan.com/" target="_blank" rel="noopener">Yifan&nbsp;Peng</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java开发、算法与数据结构等（一个本科毕业生的博客）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">23</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://plumbr.eu/blog" target="_blank" rel="noopener">Nikita&nbsp;Salnikov&nbsp;Tarnovski</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">爱沙尼亚</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">内存泄露</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">24</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://marxsoftware.blogspot.com/" target="_blank" rel="noopener">Dustin&nbsp;Marx</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">一些通用的开发技术以及Java、&nbsp;JavaFX、Groovy等相关技术</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">25</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.thesoftwarecraft.com/" target="_blank" rel="noopener">Bart&nbsp;Bakker</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">荷兰</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">敏捷开发</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">26</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://gunnarpeipman.com/" target="_blank" rel="noopener">Gunnar&nbsp;Peipman</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">非Java（C#、.Net相关）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">27</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://jobtipsforgeeks.com/" target="_blank" rel="noopener">Dave&nbsp;Fecak</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">程序员需要知道的工作技巧</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">28</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.jooq.org/" target="_blank" rel="noopener">JOOQ</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">瑞士</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">SQL</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">29</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.petrikainulainen.net/" target="_blank" rel="noopener">Petri&nbsp;Kainulainen</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">芬兰</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Web技术</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">30</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.informatech.cr/" target="_blank" rel="noopener">Informatech&nbsp;CR</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">哥斯达黎加</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java、Web、Mobile开发</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">31</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.arungupta.me/" target="_blank" rel="noopener">Arun&nbsp;Gupta</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">32</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://mechanical-sympathy.blogspot.com/" target="_blank" rel="noopener">Mechanical&nbsp;Sympathy</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">英国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">性能（锁、垃圾回收、编译优化等）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">33</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://matteo.vaccari.name/blog/" target="_blank" rel="noopener">Extreme&nbsp;Enthusiasm</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">意大利</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">敏捷开发</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">34</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://steveblank.com/" target="_blank" rel="noopener">Steve&nbsp;Blank</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">The&nbsp;Startup&nbsp;Owner&rsquo;s&nbsp;Manual（创业者指南）的作者</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">35</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://olivergierke.de/" target="_blank" rel="noopener">Oliver&nbsp;Gierke</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">德国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">SpringSource（现为VMware旗下部门，提供Java企业应用开发平台）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">36</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.frankel.ch/" target="_blank" rel="noopener">Nicolas&nbsp;Fr&auml;nkel</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">瑞士</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java&nbsp;EE</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">37</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://blog.bdoughan.com/" target="_blank" rel="noopener">Blaise&nbsp;Doughan</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">XML和JSON相关</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">38</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://vladmihalcea.wordpress.com/" target="_blank" rel="noopener">Vlad&nbsp;Mihalcea</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">罗马尼亚</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">软件集成</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">39</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://lckymn.com/about-kevin" target="_blank" rel="noopener">Kevin&nbsp;Lee</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">澳大利亚</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Web技术</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">40</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://java-performance.info/" target="_blank" rel="noopener">Mikhail&nbsp;Vorontsov</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">澳大利亚</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">性能（语言本身的性能研究）</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">41</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://jenkov.com/" target="_blank" rel="noopener">Jakob&nbsp;Jenkov</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">丹麦</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">Java基础</span></td><br></tr><br><tr><br><td valign="top" width="32"><span style="font-size: 14px;">42</span></td><br><td valign="top" width="173"><span style="font-size: 14px;"><a href="http://www.programcreek.com/" target="_blank" rel="noopener">Program&nbsp;Creek</a></span></td><br><td valign="top" width="101"><span style="font-size: 14px;">美国</span></td><br><td valign="top" width="261"><span style="font-size: 14px;">深入理解Java</span></td><br></tr><br></tbody><br></table><br><br>&nbsp;<br><br><span style="line-height: 1.5;">原文链接：&nbsp;</span><a href="http://www.programcreek.com/2012/11/top-100-java-developers-blogs/" target="_blank" rel="noopener">programcreek</a><span style="line-height: 1.5;">&nbsp;翻译：&nbsp;</span><a href="http://www.importnew.com/" target="_blank" rel="noopener">ImportNew.com&nbsp;</a><span style="line-height: 1.5;">-&nbsp;</span><a href="http://www.importnew.com/author/xiaqianlin" target="_blank" rel="noopener">夏千林</a><br><br></div><br></div>

<p>译文链接：&nbsp;<a href="http://www.importnew.com/7469.html" target="_blank" rel="noopener">http://www.importnew.com/7469.html</a><br>[&nbsp;<strong>转载请保留原文出处、译者和译文链接。</strong>]</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/02/27/Android-实现类似微信的延迟加载的Fragment——LazyFragment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/27/Android-实现类似微信的延迟加载的Fragment——LazyFragment/" itemprop="url">[Android]实现类似微信的延迟加载的Fragment——LazyFragment</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-02-27T18:02:00+08:00">
                2015-02-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/02/27/Android-实现类似微信的延迟加载的Fragment——LazyFragment/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/02/27/Android-实现类似微信的延迟加载的Fragment——LazyFragment/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="color: #ff0000;"><strong>以下内容为原创，转载请注明：</strong></span></p>
<p><span style="color: #ff0000;"><strong>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/4303910.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4303910.html</a>&nbsp;</strong></span></p>
<p>&nbsp;</p>
<p>参考微信，使用ViewPager来显示不同的tab，每个tab是一个Fragment，</p>
<p>假设有3个tab，对应的fragment是FragmentA、FragmentB、FragmentC</p>
<p>需要实现的效果是进入后，默认先只加载FragmentA，具体滑动到了哪个Fragment，再去加载该Fragment的数据。</p>
<p>可以参考如下BaseLazyFragment代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">  2</span> <span style="color: #008000;"> <em> Author: wangjie<br></em></span><span style="color: #008080;">  3</span> <span style="color: #008000;">  Email: tiantian.china.2@gmail.com<br></span><span style="color: #008080;">  4</span> <span style="color: #008000;"> <em> Date: 1/23/15.<br></em></span><span style="color: #008080;">  5</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">  6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> BaseLazyFragment <span style="color: #0000ff;">extends</span><span style="color: #000000;"> BaseFragment {<br></span><span style="color: #008080;">  7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = BaseLazyFragment.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;">  8</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isPrepared;<br></span><span style="color: #008080;">  9</span><br><span style="color: #008080;"> 10</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 11</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onActivityCreated(Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 12</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onActivityCreated(savedInstanceState);<br></span><span style="color: #008080;"> 13</span> <span style="color: #000000;">        initPrepare();<br></span><span style="color: #008080;"> 14</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 15</span><br><span style="color: #008080;"> 16</span><br><span style="color: #008080;"> 17</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 18</span> <span style="color: #008000;">     <em> 第一次onResume中的调用onUserVisible避免操作与onFirstUserVisible操作重复<br></em></span><span style="color: #008080;"> 19</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isFirstResume = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 21</span><br><span style="color: #008080;"> 22</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 23</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onResume() {<br></span><span style="color: #008080;"> 24</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onResume();<br></span><span style="color: #008080;"> 25</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFirstResume) {<br></span><span style="color: #008080;"> 26</span>             isFirstResume = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 27</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 28</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (getUserVisibleHint()) {<br></span><span style="color: #008080;"> 30</span> <span style="color: #000000;">            onUserVisible();<br></span><span style="color: #008080;"> 31</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 32</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 33</span><br><span style="color: #008080;"> 34</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 35</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPause() {<br></span><span style="color: #008080;"> 36</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPause();<br></span><span style="color: #008080;"> 37</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (getUserVisibleHint()) {<br></span><span style="color: #008080;"> 38</span> <span style="color: #000000;">            onUserInvisible();<br></span><span style="color: #008080;"> 39</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 40</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isFirstVisible = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 43</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isFirstInvisible = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 44</span><br><span style="color: #008080;"> 45</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 46</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setUserVisibleHint(<span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isVisibleToUser) {<br></span><span style="color: #008080;"> 47</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.setUserVisibleHint(isVisibleToUser);<br></span><span style="color: #008080;"> 48</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isVisibleToUser) {<br></span><span style="color: #008080;"> 49</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFirstVisible) {<br></span><span style="color: #008080;"> 50</span>                 isFirstVisible = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 51</span> <span style="color: #000000;">                initPrepare();<br></span><span style="color: #008080;"> 52</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 53</span> <span style="color: #000000;">                onUserVisible();<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 55</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 56</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isFirstInvisible) {<br></span><span style="color: #008080;"> 57</span>                 isFirstInvisible = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 58</span> <span style="color: #000000;">                onFirstUserInvisible();<br></span><span style="color: #008080;"> 59</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 60</span> <span style="color: #000000;">                onUserInvisible();<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 62</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 63</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 64</span><br><span style="color: #008080;"> 65</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> initPrepare() {<br></span><span style="color: #008080;"> 66</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isPrepared) {<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">            onFirstUserVisible();<br></span><span style="color: #008080;"> 68</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 69</span>             isPrepared = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 70</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 71</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 72</span><br><span style="color: #008080;"> 73</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 74</span> <span style="color: #008000;">     <em> 第一次fragment可见（进行初始化工作）<br></em></span><span style="color: #008080;"> 75</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 76</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onFirstUserVisible() {<br></span><span style="color: #008080;"> 77</span><br><span style="color: #008080;"> 78</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 81</span> <span style="color: #008000;">     <em> fragment可见（切换回来或者onResume）<br></em></span><span style="color: #008080;"> 82</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 83</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onUserVisible() {<br></span><span style="color: #008080;"> 84</span><br><span style="color: #008080;"> 85</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 86</span><br><span style="color: #008080;"> 87</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 88</span> <span style="color: #008000;">     <em> 第一次fragment不可见（不建议在此处理事件）<br></em></span><span style="color: #008080;"> 89</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 90</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onFirstUserInvisible() {<br></span><span style="color: #008080;"> 91</span><br><span style="color: #008080;"> 92</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 93</span><br><span style="color: #008080;"> 94</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 95</span> <span style="color: #008000;">     <em> fragment不可见（切换掉或者onPause）<br></em></span><span style="color: #008080;"> 96</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 97</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onUserInvisible() {<br></span><span style="color: #008080;"> 98</span><br><span style="color: #008080;"> 99</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">100</span><br><span style="color: #008080;">101</span> }</pre><br></div>

<p>如上代码，使用setUserVisibleHint方法作为回调的依据，</p>
<p>暴露出来让子类使用的新的生命周期方法为：</p>
<ul>
<li>onFirstUserVisible();</li>
</ul>
<p>第一次fragment可见（进行初始化工作）</p>
<ul>
<li>onUserVisible();&nbsp;</li>
</ul>
<p>fragment可见（切换回来或者onResume）</p>
<ul>
<li>onFirstUserInvisible();</li>
</ul>
<p>第一次fragment不可见（不建议在此处理事件）</p>
<ul>
<li>onUserInvisible();</li>
</ul>
<p>fragment不可见（切换掉或者onPause）</p>
<p>&nbsp;</p>
<p>具体的效果是：</p>
<p>1. 首先加载ViewPager，回调FragmentA（第一个默认呈现的Fragment）的onFirstUserVisible()，可以在这里进行FragmentA的初始化工作，其他Fragment保持不变。</p>
<p>2. 用户从FragmentA滑动到FragmentB，回调FragmentA的onUserInvisible()、FragmentB的onFirstUserVisible()（因为第一次切换到FragmentB，可以在这里进行初始化工作）。</p>
<p>3. 用户从FragmentB滑动到FragmentC，回调FragmentB的onUserInvisible()、FragmentC的onFirstUserVisible()（因为第一次切换到FragmentC，可以在这里进行初始化工作）。</p>
<p>4. 用户从FragmentC滑动到FragmentB，回调FragmentC的onUserInvisible()、FragmentB的onUserVisible()（因为FragmentB之前已经被加载过）。</p>
<p>5. 因为到此为止，suoyou的Fragment都已经被加载过了，所以以后这3个Fragment互相任意切换，只会回调原来Fragment的onUserInvisible()和切换后的Fragment的onUserVisible()。</p>
<p>6. 用户处于FragmentB，关闭手机屏幕，回调FragmentB的onUserInvisible()。</p>
<p>7.&nbsp;用户处于FragmentB，手机屏幕处关闭状态，然后开启手机屏幕解锁，只回调FragmentB的onUserVisible()。</p>
<p>&nbsp;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/02/02/android多分辨率多屏幕密度下UI适配方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/02/android多分辨率多屏幕密度下UI适配方案/" itemprop="url">android多分辨率多屏幕密度下UI适配方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-02-02T19:12:00+08:00">
                2015-02-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/02/02/android多分辨率多屏幕密度下UI适配方案/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/02/02/android多分辨率多屏幕密度下UI适配方案/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>文章转载自<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2013/0627/1393.html" target="_blank" rel="noopener">http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2013/0627/1393.html</a></strong></p>
<p><strong>摘要</strong>&nbsp;前言 Android 设计之初就考虑到了 UI 在多平台的适配，它本身提供了一套完善的适配机制，随着版本的发展适配也越来越精确， UI 适配主要受平台两个因素的影响：屏幕尺寸（屏幕的像素宽度及像素高度）和屏幕密度，针对不同的应用场景采用的适配方案也不一样，</p>
<div class="first"><br><br># 前言<br><br>Android设计之初就考虑到了UI在多平台的适配，它本身提供了一套完善的适配机制，随着版本的发展适配也越来越精确，UI适配主要受平台两个因素的影响：屏幕尺寸（屏幕的像素宽度及像素高度）和屏幕密度，针对不同的应用场景采用的适配方案也不一样，此文档仅针对Android4.0及以下版本<br><br>&nbsp;<br><br><strong>相关概念</strong><br><br><strong>分辨率：</strong>整个屏幕的像素数目，为了表示方便一般用屏幕的像素宽度（水平像素数目）乘以像素高度表示，形如1280x720，反之分辨率为1280x720的屏幕，像素宽度不一定为1280<br><br><strong>屏幕密度：</strong>表示单位面积内的像素个数，通常用dpi为单位，即每英寸多少个像素点<br><br><strong>px**</strong>：<strong>长度单位，以具体像素为单位

</strong>dp<strong>**：</strong>长度单位，与具体屏幕密度无关，显示的时候根据具体平台屏幕密度的不同最终转换为相应的像素长度，具体转换规则是: 1dp =&nbsp;（目标屏幕密度/标准密度）<em>px,标准密度为160dpi，例如，1dp长度在密度为160dpi的平台表示一个像素的长度，而在240dpi的平台则表示1.5个像素的长度<br><br><strong>屏幕尺寸：</strong>屏幕的大小，通常用屏幕对角线的长度表示<br><br># Android界面适配机制<br><br>UI界面在不同平台的适配受屏幕尺寸和屏幕密度影响，Android适配机制就是在资源后面添加对这两种因素的限定，通过不同的限定区分不同的平台资源，Android在使用资源的时候会优先选择满足本平台限定的资源，再找最接近条件的，再找默认（即不加限定），通过选择适合当前平台的资源来完成不同平台的适配。<br><br>&nbsp;<br><br>屏幕尺寸分为：small,normal,large,xlarge分别表示小，中，大，超大屏<br><br>屏幕密度分为：ldpi,mdpi,hdpi,xhdpi，它们的标准值分别是：120dpi，160dpi，240dpi，320dpi<br><br>以上划分均表示的是一个范围：<br><br><img src="http://www.jcodecraeer.com/uploads/20130627/13722624421110.jpg" alt="" title="image001.jpg"><br><br>在资源目录后面加上上面的限定就能为资源指定特定的适用平台，如下所示<br><br><img src="http://www.jcodecraeer.com/uploads/20130627/13722624942474.jpg" alt="" title="image002.jpg"><br><br>表示大屏，中密度布局会选择上面那个main.xml，超大屏，中密度会选择下面那个main.xml<br><br>&nbsp;<br><br>在实际开发过程中屏幕尺寸不够直观，android将其转换为分辨率表示，根据屏幕具体分辨率可选择相应的限定符<br><br><img src="http://www.jcodecraeer.com/uploads/20130627/13722625497179.jpg" alt="" title="image003.jpg"><br><br>小结：通过加上上述限定可以实现一个apk适配几种主流的屏幕尺寸和屏幕密度，这种限定方式比较适用于对外发布应用，不知道终端具体参数的情况，但是不能做到精确适配，对于屏幕尺寸和密度相差不大的两种平台不能很好的区分。<br><br>&nbsp;<br><br>为了解决上述问题，自Android3.2开始，引入了精确适配，理论上可以适配任意像素宽度，高度，屏幕密度的平台，需用以下方式添加限定符<br><br><img src="http://www.jcodecraeer.com/uploads/20130627/13722625806649.jpg" alt="" title="image004.jpg"><br><br>其中w1280dp表示屏幕宽度为1280dp，h752dp表示屏幕高度为752dp，160dpi表示屏幕密度，其中屏幕宽，高必须以dp为单位，在知道屏幕像素宽高度的情况下可以通过公式：1dp =&nbsp;（目标屏幕密度/标准密度）</em>px&nbsp;转换成dp单位。<br><br>例如：某平台屏幕宽，高分别为1920px，720px，屏幕密度为240dpi<br><br>适配该平台的限定为：<br><br><img src="http://www.jcodecraeer.com/uploads/20130627/13722626152563.jpg" alt="" title="image005.jpg"><br><br>或者<br><br><img src="http://www.jcodecraeer.com/uploads/20130627/13722626311624.jpg" alt="" title="image006.jpg"><br><br>根据公式1dp=（240/160）px=1.5px,宽度，高度转为dp单位分别是1280dp和480dp.<br><br>&nbsp;<br><br><strong>Android自适应不同分辨率或不同屏幕大小的layout布局(横屏|竖屏</strong>)<br><br>一：不同的layout<br><br>Android手机屏幕大小不一，有480x320, 640x360, 800x480.怎样才能让App自动适应不同的屏幕呢？<br>其实很简单，只需要在res目录下创建不同的layout文件夹，比如layout-640x360,layout-800x480,所有的layout文件在编译之后都会写入R.java里，而系统会根据屏幕的大小自己选择合适的layout进行使用。<br><br>二：hdpi、mdpi、ldpi<br><br>在之前的版本中，只有一个drawable，而2.1版本中有drawable-mdpi、drawable-ldpi、drawable-hdpi三个，这三个主要是为了支持多分辨率。<br><br>drawable- hdpi、drawable- mdpi、drawable-ldpi的区别：<br><br>(1)drawable-hdpi里面存放高分辨率的图片,如WVGA (480x800),FWVGA (480x854)<br><br>(2)drawable-mdpi里面存放中等分辨率的图片,如HVGA (320x480)<br><br>(3)drawable-ldpi里面存放低分辨率的图片,如QVGA (240x320)<br><br>　　系统会根据机器的分辨率来分别到这几个文件夹里面去找对应的图片。<br><br>更正：应该是对应不同density 的图片<br><br>　　在开发程序时为了兼容不同平台不同屏幕，建议各自文件夹根据需求均存放不同版本图片。<br><br>[i]备注：三者的解析度不一样，就像你把电脑的分辨率调低，图片会变大一样，反之分辨率高，图片缩小。 [/i]&nbsp;<br>屏幕方向：<br><br>横屏竖屏自动切换：<br><br>可以在res目录下建立layout-port-800x600和layout-land两个目录，里面分别放置竖屏和横屏两种布局文件，这样在手机屏幕方向变化的时候系统会自动调用相应的布局文件，避免一种布局文件无法满足两种屏幕显示的问题。<br><br>不同分辨率横屏竖屏自动切换：<br><br>以800x600为例<br>可以在res目录下建立layout-port-800x600和layout-land-800x600两个目录<br><br>不切换：<br><br>以下步骤是网上流传的，不过我自己之前是通过图形化界面实现这个配置，算是殊途同归，有空我会把图片贴上来。<br><br>还要说明一点：每个activity都有这个属性screenOrientation，每个activity都需要设置，可以设置为竖屏（portrait），也可以设置为无重力感应（nosensor）。<br><br>要让程序界面保持一个方向，不随手机方向转动而变化的处理办法：<br><br>在AndroidManifest.xml里面配置一下就可以了。加入这一行android:screenOrientation=”landscape”。<br>例如（landscape是横向，portrait是纵向）：<br><br>Java代码:<br><br>&lt;?xml version=”1.0” encoding=”utf-8”?&gt;<br>&lt;manifestxmlns:android=”<a href="http://schemas.android.com/apk/res/android&quot;&amp;nbsp" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android&quot;&amp;nbsp</a>;<br>package=”com.ray.linkit”&nbsp;<br>android:versionCode=”1”&nbsp;<br>android:versionName=”1.0”&gt;&nbsp;<br>&lt;application android:icon=”@drawable/icon”android:label=”@string/app_name”&gt;&nbsp;<br>&lt;activity android:name=”.Main”&nbsp;<br>android:label=”@string/app_name”&nbsp;<br>android:screenOrientation=”portrait”&gt;&nbsp;<br>&lt;intent-filter&gt;&nbsp;<br>&lt;action android:name=”android.intent.action.MAIN” /&gt;&nbsp;<br>&lt;category android:name=”android.intent.category.LAUNCHER” /&gt;&nbsp;<br>&lt;/intent-filter&gt;&nbsp;<br>&lt;/activity&gt;&nbsp;<br>&lt;activity android:name=”.GamePlay”&nbsp;<br>android:screenOrientation=”portrait”&gt;&lt;/activity&gt;&nbsp;<br>&lt;activity android:name=”.OptionView”&nbsp;<br>android:screenOrientation=”portrait”&gt;&lt;/activity&gt;&nbsp;<br>&lt;/application&gt;&nbsp;<br>&lt;uses-sdk android:minSdkVersion=”3” /&gt;&nbsp;<br>&lt;/manifest&gt;<br><br>另外，android中每次屏幕的切换动会重启Activity，所以应该在Activity销毁前保存当前活动的状态，在Activity再次Create的时候载入配置，那样，进行中的游戏就不会自动重启了！<br><br>有的程序适合从竖屏切换到横屏，或者反过来，这个时候怎么办呢？可以在配置Activity的地方进行如下的配置android:screenOrientation=”portrait”。这样就可以保证是竖屏总是竖屏了，或者landscape横向。<br><br>而有的程序是适合横竖屏切换的。如何处理呢？首先要在配置Activity的时候进行如下的配置：android:configChanges=”keyboardHidden|orientation”，另外需要重写Activity的 onConfigurationChanged方法。实现方式如下，不需要做太多的内容：<br><br>@Override&nbsp;<br>public void onConfigurationChanged(Configuration newConfig) {&nbsp;<br>super.onConfigurationChanged(newConfig);&nbsp;<br>if (this.getResources().getConfiguration().orientation ==Configuration.ORIENTATION_LANDSCAPE) {&nbsp;<br>// land do nothing is ok&nbsp;<br>} else if (this.getResources().getConfiguration().orientation ==Configuration.ORIENTATION_PORTRAIT) {&nbsp;<br>// port do nothing is ok&nbsp;<br>}&nbsp;<br>}<br><br>写一个支持多分辨的程序，基于1.6开发的，建立了三个资源文件夹drawable-hdpi drawable-mdpidrawable-ldpi，里面分别存放72<em>72 48</em>48 36<em>36的icon图标文件。当我在G1（1.5的系统）上测试时，图标应该自适应为48</em>48才对啊，但实际显示的是36<em>36。怎么才能让其自适应 48</em>48的icon图标呢<br><br>解决办法 drawable-hdpi drawable-mdpi drawable-ldpi改成drawable-480X320 drawable-800X480的多分辨支持的文件夹<br><br>对于Android游戏开发我们不得不像iPhone那样思考兼容 Android平板电脑，对于苹果要考虑iPad、iPhone 3GS和iPhone 4等屏幕之间的兼容性，对于几乎所有的分辨率总结了大约超过20中粉笔阿女郎的大小和对应关系，对于开发Android游戏而言可以考虑到未来的3.0以及很多平板电脑的需要。<br><br>常规的我们可能只考虑QVGA，HVGA，WVGA，FWVGA和DVGA，但是抛去了手机不谈，可能平板使用类似WSVGA的1024&times;576以及WXGA的1280&times;768等等。<br>QVGA = 320 <em> 240;<br>WQVGA = 320 </em> 480;<br>WQVGA2 = 400 <em> 240;<br>WQVGA3 = 432 </em> 240;<br>HVGA = 480 <em> 320;<br>VGA = 640 </em> 480;<br>WVGA = 800 <em> 480;<br>WVGA2 = 768 </em> 480;<br>FWVGA = 854 <em> 480;<br>DVGA = 960 </em> 640;<br>PAL = 576 <em> 520;<br>NTSC = 486 </em> 440;<br>SVGA = 800 <em> 600;<br>WSVGA […]<br><br>这是一个比较有代表性的Android软件资源包，drawable里面存放的是应用的图标文件，layout存放的是布局，简单说就是这些图标如何摆放。为什么Android上需要这么多资源包文件和布局文件是我们接下来需要讨论的问题。<br><br>Android设备屏幕的尺寸是各式各样的，如小米是4英寸的，Xoom平板是10英寸；分辨率也千奇百怪，800&times;480，960&times;540等；Android版本的碎片化问题更是萦绕于心，不过在设计应用时可以分为两大块：3.0之前的版本和3.0之后的版本。这种情况会带来什么问题我们用三个假设来说明一下。<br><br>1. 假设你的手上有两个4英寸的设备，设备A的分辨率是800&times;480，设备B的分辨率是1600&times;960。你在设备A上设计了一个64&times;64像素的图标，感觉它大小正合适，但放到设备B上的时候，这个图标看上去就只有之前一半大小了。<br><br>2. 假设你手上的两个设备，设备A是4英寸，设备B是10英寸。在设备A上方放了一个tab控件，有三个页签。放到设备B上看时tab控件的三个页签被拉得很长，本来放6个页签的空间只放了三个页签。<br><br>3. 假设你手上的两个设备，设备A装的是Android2.3，设备B装的是Android4.0，而设备B没有menu建，风格也不一样。你发现两个设备上用同一套风格的皮肤并不合适。<br><br>Google提供了一套体系去解决这些问题。我们再回到上面的那张图，drawable文件夹有ldpi、mdpi、hdpi、xhdpi四种。dpi指像素/英寸，而ldpi指120，mdpi指160，hdpi指240，xhdpi指320。小米手机是4英寸、854&times;480的分辨率，那么小米手机的dpi就是854的平方加480的平方和开2次方后除以4，结果大约是245。如果应用安装在小米手机上，那么系统会调用图中drawable-hdpi里面的资源。这样，你只要做4套资源分别放在drawable-ldpi、drawable-mdpi、drawable-hdpi以及drawable-xdpi下（图标可以按照3：4：6：8的比例制作图片资源），那么就可以解决上面假设1当中提到的问题。<br><br>对于相同dpi、但尺寸不一样的设备，可以通过layout文件控制各种资源的布局。Google将设备分为small（2～3英寸）、normal（4英寸左右）、large（5～7英寸）、xlarge（7英寸以上）。在上面的假设2种，我们可以在layout-normal里配置3个页签的tab栏，在layout-xlarge里配置6个页签的tab栏。如果应用在所有设备上布局都一样，那么就不用考虑针对不同尺寸的layout。从图中那些layout</em>文件夹可以看出，该应用在hdpi及xhdpi上支持横竖屏，而且横竖屏的布局不一致，但没有考虑不同尺寸的设备使用不同布局的情况。<br><br>Android3.0之前的风格与Android3.0（包含3.0）之后的风格区别很大，图中那个应用就使用了两种风格的资源及布局。Android2.3的小米会使用drawable-hdpi及layout-hdpi当中的文件，而Android4.0的小米就会使用drawable-hdpi-v11及layout-hdpi-v11里面的文件。<br><br>今天就到此为止了，有空的时候再说说9-Patch的使用。这篇文章也就只能起到抛砖引玉的作用，在实际设计应用的时候还需要多去参考其他文档资料，特别是Android开发的官方文档。<br><br></div>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/02/02/Android-使用RecyclerView替代ListView（三）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/02/Android-使用RecyclerView替代ListView（三）/" itemprop="url">[Android]使用RecyclerView替代ListView（三）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-02-02T16:32:00+08:00">
                2015-02-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/02/02/Android-使用RecyclerView替代ListView（三）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/02/02/Android-使用RecyclerView替代ListView（三）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="color: #ff0000;"><strong>以下内容为原创，转载请注明：</strong></span></p>
<p><span style="color: #ff0000;"><strong>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/4268097.html" title="view: [Android]使用RecyclerView替代ListView（三）" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4268097.html</a>&nbsp;</strong></span></p>
<p>&nbsp;</p>
<p>这次来使用RecyclerView实现PinnedListView的效果，效果很常见：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201502/021602294536998.gif" alt=""></p>
<p>开发的代码建立在上一篇（<strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener">[Android]使用RecyclerView替代ListView（二）</a>：<a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4242541.html</a></strong>）基础之上。</p>
<p>修改布局如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><br><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">              android:orientation</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">              android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;"> 6</span> <span style="color: #ff0000;">              android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">android.support.v7.widget.Toolbar<br></span><span style="color: #008080;"> 9</span>             <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_pinned_toolbar”</span><br><span style="color: #008080;">10</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">11</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">12</span> <span style="color: #ff0000;">            android:background</span><span style="color: #0000ff;">=”?attr/colorPrimary”</span><br><span style="color: #008080;">13</span>             <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">14</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">android.support.v4.widget.SwipeRefreshLayout<br></span><span style="color: #008080;">15</span>             <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_pinned_srl”</span><br><span style="color: #008080;">16</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">17</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">18</span>             <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">com.wangjie.androidbucket.support.recyclerview.pinnedlayout.PinnedRecyclerViewLayout<br></span><span style="color: #008080;">21</span>                 <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_pinned_layout”</span><br><span style="color: #008080;">22</span> <span style="color: #ff0000;">                android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"> android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">23</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">android.support.v7.widget.RecyclerView<br></span><span style="color: #008080;">24</span>                     <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_pinned_rv”</span><br><span style="color: #008080;">25</span> <span style="color: #ff0000;">                    android:scrollbars</span><span style="color: #0000ff;">=”vertical”</span><br><span style="color: #008080;">26</span> <span style="color: #ff0000;">                    android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">27</span> <span style="color: #ff0000;">                    android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;">28</span> <span style="color: #ff0000;">                    android:background</span><span style="color: #0000ff;">=”#bbccaa”</span><br><span style="color: #008080;">29</span>                     <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">30</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Button<br></span><span style="color: #008080;">31</span>                     <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_pinned_add_btn”</span><br><span style="color: #008080;">32</span> <span style="color: #ff0000;">                    android:layout_width</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"> android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">33</span> <span style="color: #ff0000;">                    android:layout_centerVertical</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;">34</span> <span style="color: #ff0000;">                    android:background</span><span style="color: #0000ff;">=”#abcabc”</span><br><span style="color: #008080;">35</span> <span style="color: #ff0000;">                    android:text</span><span style="color: #0000ff;">=”add”</span><br><span style="color: #008080;">36</span>                     <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">37</span><br><span style="color: #008080;">38</span>         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">com.wangjie.androidbucket.support.recyclerview.pinnedlayout.PinnedRecyclerViewLayout</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">39</span><br><span style="color: #008080;">40</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">android.support.v4.widget.SwipeRefreshLayout</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">41</span><br><span style="color: #008080;">42</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>可以看到RecyclerView是被一个<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/pinnedlayout/PinnedRecyclerViewLayout.java" target="_blank" rel="noopener">PinnedRecyclerViewLayout</a>（<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/pinnedlayout/PinnedRecyclerViewLayout.java" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/pinnedlayout/PinnedRecyclerViewLayout.java</a>）</strong>包含在里面的。这个在项目<strong><a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">AndroidBucket</a>（<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket</a>）</strong>中。先看看代码中怎么使用吧，具体实现待会说。</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> pinnedLayout.initRecyclerPinned(recyclerView, layoutManager, LayoutInflater.from(context).inflate(R.layout.recycler_view_item_float, <span style="color: #0000ff;">null</span><span style="color: #000000;">));<br></span><span style="color: #008080;">2</span> pinnedLayout.setOnRecyclerViewPinnedViewListener(<span style="color: #0000ff;">this</span>);</pre><br></div>

<p>如上，使用方式很简单：</p>
<p>Line1：初始化绑定PinnedRecyclerViewLayout和RecyclerView，并设置需要被顶上去的pinnedView</p>
<p>Line2：设置OnRecyclerViewPinnedViewListener，作用是在顶部被顶上去替换掉的时候，会回调重新渲染数据，传入的OnRecyclerViewPinnedViewListener是this，显然，此Activity实现了这个接口，实现代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">//</span><span style="color: #008000;"> 渲染pinnedView数据</span><br><span style="color: #008080;"> 2</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onPinnedViewRender(PinnedRecyclerViewLayout pinnedRecyclerViewLayout, View pinnedView, <span style="color: #0000ff;">int</span><span style="color: #000000;"> position) {<br></span><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (pinnedRecyclerViewLayout.getId()) {<br></span><span style="color: #008080;"> 5</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.recycler_view_pinned_layout:<br></span><span style="color: #008080;"> 6</span>                 TextView nameTv =<span style="color: #000000;"> (TextView) pinnedView.findViewById(R.id.recycler_view_item_float_name_tv);<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">                nameTv.setText(personList.get(position).getName());<br></span><span style="color: #008080;"> 8</span>                 TextView ageTv =<span style="color: #000000;"> (TextView) pinnedView.findViewById(R.id.recycler_view_item_float_age_tv);<br></span><span style="color: #008080;"> 9</span>                 ageTv.setText(personList.get(position).getAge() + “岁”<span style="color: #000000;">);<br></span><span style="color: #008080;">10</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">12</span>     }</pre><br></div>

<p>然后，我们来看看<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/pinnedlayout/PinnedRecyclerViewLayout.java" target="_blank" rel="noopener">PinnedRecyclerViewLayout</a></strong>是怎么实现的。</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">  2</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;">  3</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">  4</span> <span style="color: #008000;">  Date: 2/2/15.<br></span><span style="color: #008080;">  5</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;">  6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> PinnedRecyclerViewLayout <span style="color: #0000ff;">extends</span><span style="color: #000000;"> RelativeLayout {<br></span><span style="color: #008080;">  7</span><br><span style="color: #008080;">  8</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = PinnedRecyclerViewLayout.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;">  9</span><br><span style="color: #008080;"> 10</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> OnRecyclerViewPinnedViewListener {<br></span><span style="color: #008080;"> 11</span>         <span style="color: #0000ff;">void</span> onPinnedViewRender(PinnedRecyclerViewLayout pinnedRecyclerViewLayout, View pinnedView, <span style="color: #0000ff;">int</span><span style="color: #000000;"> position);<br></span><span style="color: #008080;"> 12</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 13</span><br><span style="color: #008080;"> 14</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> OnRecyclerViewPinnedViewListener onRecyclerViewPinnedViewListener;<br></span><span style="color: #008080;"> 15</span><br><span style="color: #008080;"> 16</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnRecyclerViewPinnedViewListener(OnRecyclerViewPinnedViewListener onRecyclerViewPinnedViewListener) {<br></span><span style="color: #008080;"> 17</span>         <span style="color: #0000ff;">this</span>.onRecyclerViewPinnedViewListener =<span style="color: #000000;"> onRecyclerViewPinnedViewListener;<br></span><span style="color: #008080;"> 18</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 19</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> PinnedRecyclerViewLayout(Context context) {<br></span><span style="color: #008080;"> 21</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;"> 22</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 23</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 24</span><br><span style="color: #008080;"> 25</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> PinnedRecyclerViewLayout(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;"> 26</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;"> 27</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 28</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 29</span><br><span style="color: #008080;"> 30</span>     <span style="color: #0000ff;">public</span> PinnedRecyclerViewLayout(Context context, AttributeSet attrs, <span style="color: #0000ff;">int</span><span style="color: #000000;"> defStyleAttr) {<br></span><span style="color: #008080;"> 31</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs, defStyleAttr);<br></span><span style="color: #008080;"> 32</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 34</span><br><span style="color: #008080;"> 35</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> init(Context context) {<br></span><span style="color: #008080;"> 36</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 37</span><br><span style="color: #008080;"> 38</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> View pinnedView;<br></span><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> ABaseLinearLayoutManager layoutManager;<br></span><span style="color: #008080;"> 40</span><br><span style="color: #008080;"> 41</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> initRecyclerPinned(RecyclerView recyclerView, ABaseLinearLayoutManager layoutManager, View pinnedView) {<br></span><span style="color: #008080;"> 42</span>         <span style="color: #0000ff;">this</span>.pinnedView =<span style="color: #000000;"> pinnedView;<br></span><span style="color: #008080;"> 43</span>         <span style="color: #0000ff;">this</span>.layoutManager =<span style="color: #000000;"> layoutManager;<br></span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">this</span>.addView(<span style="color: #0000ff;">this</span><span style="color: #000000;">.pinnedView);<br></span><span style="color: #008080;"> 45</span>         RelativeLayout.LayoutParams lp = <span style="color: #0000ff;">new</span><span style="color: #000000;"> RelativeLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT);<br></span><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">this</span><span style="color: #000000;">.pinnedView.setLayoutParams(lp);<br></span><span style="color: #008080;"> 47</span>         layoutManager.getRecyclerViewScrollManager().addScrollListener(recyclerView, <span style="color: #0000ff;">new</span><span style="color: #000000;"> OnRecyclerViewScrollListener() {<br></span><span style="color: #008080;"> 48</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 49</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onScrollStateChanged(RecyclerView recyclerView, <span style="color: #0000ff;">int</span><span style="color: #000000;"> newState) {<br></span><span style="color: #008080;"> 50</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 51</span><br><span style="color: #008080;"> 52</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 53</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onScrolled(RecyclerView recyclerView, <span style="color: #0000ff;">int</span> dx, <span style="color: #0000ff;">int</span><span style="color: #000000;"> dy) {<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">                refreshPinnedView();<br></span><span style="color: #008080;"> 55</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;"> 57</span> <span style="color: #000000;">        pinnedView.setVisibility(GONE);<br></span><span style="color: #008080;"> 58</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 59</span><br><span style="color: #008080;"> 60</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 保存上次的position</span><br><span style="color: #008080;"> 61</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> lastPosition =<span style="color: #000000;"> RecyclerView.NO_POSITION;<br></span><span style="color: #008080;"> 62</span><br><span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> refreshPinnedView() {<br></span><span style="color: #008080;"> 64</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> == pinnedView || <span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> layoutManager) {<br></span><span style="color: #008080;"> 65</span>             Logger.e(TAG, “Please init pinnedView and layoutManager with initRecyclerPinned method first!”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 66</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 68</span>         <span style="color: #0000ff;">if</span> (VISIBLE !=<span style="color: #000000;"> pinnedView.getVisibility()) {<br></span><span style="color: #008080;"> 69</span> <span style="color: #000000;">            pinnedView.setVisibility(VISIBLE);<br></span><span style="color: #008080;"> 70</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 71</span>         <span style="color: #0000ff;">int</span> curPosition =<span style="color: #000000;"> layoutManager.findFirstVisibleItemPosition();<br></span><span style="color: #008080;"> 72</span>         <span style="color: #0000ff;">if</span> (RecyclerView.NO_POSITION ==<span style="color: #000000;"> curPosition) {<br></span><span style="color: #008080;"> 73</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 74</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 75</span>         View curItemView =<span style="color: #000000;"> layoutManager.findViewByPosition(curPosition);<br></span><span style="color: #008080;"> 76</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> curItemView) {<br></span><span style="color: #008080;"> 77</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 78</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 79</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 如果当前的curPosition和上次的lastPosition不一样，则说明需要重新刷新数据，避免curPosition一样的情况下重复刷新相同数据</span><br><span style="color: #008080;"> 80</span>         <span style="color: #0000ff;">if</span> (curPosition !=<span style="color: #000000;"> lastPosition) {<br></span><span style="color: #008080;"> 81</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> onRecyclerViewPinnedViewListener) {<br></span><span style="color: #008080;"> 82</span>                 onRecyclerViewPinnedViewListener.onPinnedViewRender(<span style="color: #0000ff;">this</span><span style="color: #000000;">, pinnedView, curPosition);<br></span><span style="color: #008080;"> 83</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 84</span>             lastPosition =<span style="color: #000000;"> curPosition;<br></span><span style="color: #008080;"> 85</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 86</span><br><span style="color: #008080;"> 87</span>         <span style="color: #0000ff;">int</span><span style="color: #000000;"> displayTop;<br></span><span style="color: #008080;"> 88</span>         <span style="color: #0000ff;">int</span> itemHeight =<span style="color: #000000;"> curItemView.getHeight();<br></span><span style="color: #008080;"> 89</span>         <span style="color: #0000ff;">int</span> curTop =<span style="color: #000000;"> curItemView.getTop();<br></span><span style="color: #008080;"> 90</span>         <span style="color: #0000ff;">int</span> floatHeight =<span style="color: #000000;"> pinnedView.getHeight();<br></span><span style="color: #008080;"> 91</span>         <span style="color: #0000ff;">if</span> (curTop &lt; floatHeight -<span style="color: #000000;"> itemHeight) {<br></span><span style="color: #008080;"> 92</span>             displayTop = itemHeight + curTop -<span style="color: #000000;"> floatHeight;<br></span><span style="color: #008080;"> 93</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 94</span>             displayTop = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 95</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 96</span>         RelativeLayout.LayoutParams lp =<span style="color: #000000;"> (LayoutParams) pinnedView.getLayoutParams();<br></span><span style="color: #008080;"> 97</span>         lp.topMargin =<span style="color: #000000;"> displayTop;<br></span><span style="color: #008080;"> 98</span> <span style="color: #000000;">        pinnedView.setLayoutParams(lp);<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">        pinnedView.invalidate();<br></span><span style="color: #008080;">100</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">101</span><br><span style="color: #008080;">102</span><br><span style="color: #008080;">103</span> }</pre><br></div>

<p>&nbsp;</p>
<p>这个<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/pinnedlayout/PinnedRecyclerViewLayout.java" target="_blank" rel="noopener">PinnedRecyclerViewLayout</a>&nbsp;</strong>是继承RelativeLayout的，因为我们需要在里面添加一个被顶上去的pinnedView，需要覆盖在RecyclerView上面。</p>
<p>Line44：把传进来的pinnedView增加到<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/pinnedlayout/PinnedRecyclerViewLayout.java" target="_blank" rel="noopener">PinnedRecyclerViewLayout</a>&nbsp;</strong>里面</p>
<p>Line47～56：在ABaseLinearLayoutManager中增加一个滚动的监听器，因为我们需要在滚动的时候动态的改变pinnedView的位置，这样才能模拟顶上去的效果。并滚动时调用refreshPinnedView来刷新pinnedView的位置。</p>
<p>Line57：因为在调用initRecyclerPinned方法时，RecyclerView可能还没有数据源，所以不需要显示这个pinnedView，等到真正滚动的时候再显示就可以了。</p>
<p>refreshPinnedView()方法的作用是在滚动的同时用来刷新pinnedView的位置和显示的数据：</p>
<p>Line71～78：通过layoutManager获取当前第一个显示的数据position，然后根据position获取当前第一个显示的View。</p>
<p>Line79~85：如果当前的curPosition和上次的lastPosition不一样，则说明需要重新刷新数据，避免curPosition一样的情况下重复刷新相同数据。</p>
<p>Line87～95：根据当前第一个显示的View，根据它的top、它的高度和pinnedView的高度计算出pinnedView需要往上移动的距离（画个几何图一目了然了）。</p>
<p>Line96～99：刷新pinnedView的位置</p>
<p>&nbsp;</p>
<p><strong>示例代码：</strong></p>
<p><strong><a href="https://github.com/wangjiegulu/RecyclerViewSample" target="_blank" rel="noopener">https://github.com/wangjiegulu/RecyclerViewSample</a></strong></p>
<p>&nbsp;</p>
<p><span style="font-size: 16px; color: #ff0000;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4232560.html" target="_blank" rel="noopener"><span style="color: #ff0000;">[Android]使用RecyclerView替代ListView（一）</span></a></strong>：</span></p>
<p><span style="font-size: 16px;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4232560.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4232560.html</a></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><span style="font-size: 16px;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener"><span style="color: #ff0000;">[Android]使用RecyclerView替代ListView（二）</span></a></strong>：</span>&nbsp;</span></p>
<p><strong><span style="font-size: 16px;"><span style="color: #ff0000;"><a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4242541.html</a></span></span></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/01/22/Android-使用RecyclerView替代ListView（二）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/01/22/Android-使用RecyclerView替代ListView（二）/" itemprop="url">[Android]使用RecyclerView替代ListView（二）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-01-22T19:51:00+08:00">
                2015-01-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/01/22/Android-使用RecyclerView替代ListView（二）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/01/22/Android-使用RecyclerView替代ListView（二）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="color: #ff0000;"><strong>以下内容为原创，转载请注明：</strong></span></p>
<p><strong><span style="color: #ff0000;">来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" title="view: [Android]使用RecyclerView替代ListView（二）" target="_blank" rel="noopener"><span style="color: #ff0000;">http://www.cnblogs.com/tiantianbyconan/p/4242541.html</span></a></span>
</strong></p>
<p>&nbsp;</p>
<p>以前写过一篇&ldquo;<a href="http://www.cnblogs.com/tiantianbyconan/p/3992843.html" target="_blank" rel="noopener">[Android]使用AdapterTypeRender对不同类型的item数据到UI的渲染</a>（<a href="http://www.cnblogs.com/tiantianbyconan/p/3992843.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/3992843.html</a>）&rdquo;，用于在有很多不同类型不同布局的item的时候怎么去较好的进行view的绑定和数据的渲染，但是这个是针对ListView写的。这次我针对RecyclerView也重新实现了一遍。</p>
<p>接下来演示下怎么去渲染不同类型的item，并且使它支持下拉刷新，滚动到底部显示加载进度条显示。</p>
<p>以下所有的封装都在<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener"><strong>AndroidBucket</strong></a>项目中：<strong><a href="https://github.com/wangjiegulu/AndroidBucket/tree/master/src/com/wangjie/androidbucket/support/recyclerview" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/tree/master/src/com/wangjie/androidbucket/support/recyclerview</a>
</strong></p>
<p><img src="http://images.cnitblog.com/blog/378300/201501/221902087508177.png" alt="">&nbsp;<img src="http://images.cnitblog.com/blog/378300/201501/221902461722079.png" alt=""></p>
<p>使用的方式如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">final</span> View footerView = LayoutInflater.from(context).inflate(R.layout.recycler_view_item_type_footer, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 2</span> <span style="color: #008000;">//</span><span style="color: #008000;">        不知道为什么在xml设置的&ldquo;android:layout_width=”match_parent”&rdquo;无效了，需要在这里重新设置</span><br><span style="color: #008080;"> 3</span>         LinearLayout.LayoutParams lp = <span style="color: #0000ff;">new</span><span style="color: #000000;"> LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT);<br></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">        footerView.setLayoutParams(lp);<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span>         recyclerView.setHasFixedSize(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">final</span> ABaseLinearLayoutManager layoutManager = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ABaseLinearLayoutManager(context);<br></span><span style="color: #008080;"> 9</span>         layoutManager.setOnRecyclerViewScrollLocationListener(recyclerView, <span style="color: #0000ff;">new</span><span style="color: #000000;"> OnRecyclerViewScrollLocationListener() {<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">11</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onTopWhenScrollIdle(RecyclerView recyclerView) {<br></span><span style="color: #008080;">12</span>                 Logger.d(TAG, “onTopWhenScrollIdle…”<span style="color: #000000;">);<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">16</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onBottomWhenScrollIdle(RecyclerView recyclerView) {<br></span><span style="color: #008080;">17</span>                 Logger.d(TAG, “onBottomWhenScrollIdle…”<span style="color: #000000;">);<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">                footerView.setVisibility(View.VISIBLE);<br></span><span style="color: #008080;">19</span>                 ThreadPool.go(<span style="color: #0000ff;">new</span> Runtask&lt;Object, Object&gt;<span style="color: #000000;">() {<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">                    @Override<br></span><span style="color: #008080;">21</span>                     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Object runInBackground() {<br></span><span style="color: #008080;">22</span>                         ABThreadUtil.sleep(3000<span style="color: #000000;">);<br></span><span style="color: #008080;">23</span>                         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">25</span><br><span style="color: #008080;">26</span> <span style="color: #000000;">                    @Override<br></span><span style="color: #008080;">27</span>                     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onResult(Object result) {<br></span><span style="color: #008080;">28</span>                         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onResult(result);<br></span><span style="color: #008080;">29</span>                         refreshLayout.setRefreshing(<span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">                        footerView.setVisibility(View.GONE);<br></span><span style="color: #008080;">31</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">                });<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">        layoutManager.setOrientation(LinearLayoutManager.VERTICAL);<br></span><span style="color: #008080;">36</span>         layoutManager.getRecyclerViewScrollManager().addScrollListener(recyclerView, <span style="color: #0000ff;">new</span><span style="color: #000000;"> OnRecyclerViewScrollListener() {<br></span><span style="color: #008080;">37</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">38</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onScrollStateChanged(RecyclerView recyclerView, <span style="color: #0000ff;">int</span><span style="color: #000000;"> newState) {<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">40</span><br><span style="color: #008080;">41</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">42</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onScrolled(RecyclerView recyclerView, <span style="color: #0000ff;">int</span> dx, <span style="color: #0000ff;">int</span><span style="color: #000000;"> dy) {<br></span><span style="color: #008080;">43</span>                 refreshLayout.setEnabled(layoutManager.findFirstCompletelyVisibleItemPosition() == 0<span style="color: #000000;">);<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">46</span> <span style="color: #000000;">        recyclerView.setLayoutManager(layoutManager);<br></span><span style="color: #008080;">47</span><br><span style="color: #008080;">48</span> <span style="color: #000000;">        initData();<br></span><span style="color: #008080;">49</span><br><span style="color: #008080;">50</span>         adapter = <span style="color: #0000ff;">new</span> PersonTypeAdapter(context, personList, <span style="color: #0000ff;">null</span><span style="color: #000000;">, footerView);<br></span><span style="color: #008080;">51</span>         adapter.setOnRecyclerViewListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">52</span> <span style="color: #000000;">        recyclerView.setAdapter(adapter);<br></span><span style="color: #008080;">53</span><br><span style="color: #008080;">54</span> <span style="color: #000000;">        refreshLayout.setColorSchemeColors(Color.BLUE, Color.RED, Color.YELLOW, Color.GREEN);<br></span><span style="color: #008080;">55</span>         refreshLayout.setOnRefreshListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> SwipeRefreshLayout.OnRefreshListener() {<br></span><span style="color: #008080;">56</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">57</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onRefresh() {<br></span><span style="color: #008080;">58</span>                 ThreadPool.go(<span style="color: #0000ff;">new</span> Runtask&lt;Object, Object&gt;<span style="color: #000000;">() {<br></span><span style="color: #008080;">59</span> <span style="color: #000000;">                    @Override<br></span><span style="color: #008080;">60</span>                     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Object runInBackground() {<br></span><span style="color: #008080;">61</span>                         ABThreadUtil.sleep(3000<span style="color: #000000;">);<br></span><span style="color: #008080;">62</span>                         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">63</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">64</span><br><span style="color: #008080;">65</span> <span style="color: #000000;">                    @Override<br></span><span style="color: #008080;">66</span>                     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onResult(Object result) {<br></span><span style="color: #008080;">67</span>                         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onResult(result);<br></span><span style="color: #008080;">68</span>                         refreshLayout.setRefreshing(<span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">                        footerView.setVisibility(View.GONE);<br></span><span style="color: #008080;">70</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">71</span> <span style="color: #000000;">                });<br></span><span style="color: #008080;">72</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">73</span>         });</pre><br></div>

<p>&nbsp;</p>
<p><span style="line-height: 1.5;">如上述代码：</span></p>
<p>Line1：从布局文件中inflate出一个View实例，这个View实例，下面会被用于作为下载提示的footer。</p>
<p>Line8：生成一个<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/layoutmanager/ABaseLinearLayoutManager.java" target="_blank" rel="noopener">ABaseLinearLayoutManager</a></strong>实例，显然这个类是继承LinearLayoutManager之后扩展的，详见：<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/layoutmanager/ABaseLinearLayoutManager.java" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/layoutmanager/ABaseLinearLayoutManager.java</a>，这个类对滑动的监听进行了扩展，可以监听滑动到顶部或者底部的事件</p>
<p>Line9～34：设置滑动到顶部或底部的监听器，然后一旦滑动到底部则加载更多数据。</p>
<p>Line36～45：也是设置滑动监听器，滑动过程中如果不是处在第一个item，如果是，则就可以下拉使用SwipeRefreshLayout进行刷新，如果不是则，仅用SwipeRefreshLayout。之所以需要做这个处理，是因为Google事件处理的一个bug－－。</p>
<p>Line50：使用了一个PersonTypeAdapter，这个类继承了<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraViewAdapter.java" target="_blank" rel="noopener">ABRecyclerViewTypeExtraViewAdapter</a>，</strong>这个类继承RecyclerView.Adapter实现了对不同type渲染数据的封装。</p>
<p>&nbsp;</p>
<p>接下来重点分析下ABRecyclerViewTypeExtraViewAdapter这个类（这个类在平常使用时不需要关注）：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">  2</span> <span style="color: #008000;"> <em> Author: wangjie<br></em></span><span style="color: #008080;">  3</span> <span style="color: #008000;">  Email: tiantian.china.2@gmail.com<br></span><span style="color: #008080;">  4</span> <span style="color: #008000;"> <em> Date: 1/22/15.<br></em></span><span style="color: #008080;">  5</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">  6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">class</span> ABRecyclerViewTypeExtraViewAdapter <span style="color: #0000ff;">extends</span> RecyclerView.Adapter&lt;ABRecyclerViewTypeExtraHolder&gt;<span style="color: #000000;"> {<br></span><span style="color: #008080;">  7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> TYPE_HEADER_VIEW = 0x7683<span style="color: #000000;">;<br></span><span style="color: #008080;">  8</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> View headerView;<br></span><span style="color: #008080;">  9</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> TYPE_FOOTER_VIEW = 0x7684<span style="color: #000000;">;<br></span><span style="color: #008080;"> 10</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> View footerView;<br></span><span style="color: #008080;"> 11</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> extraCount;<br></span><span style="color: #008080;"> 12</span><br><span style="color: #008080;"> 13</span>     <span style="color: #0000ff;">protected</span><span style="color: #000000;"> ABRecyclerViewTypeExtraViewAdapter(View headerView, View footerView) {<br></span><span style="color: #008080;"> 14</span>         <span style="color: #0000ff;">this</span>.headerView =<span style="color: #000000;"> headerView;<br></span><span style="color: #008080;"> 15</span>         <span style="color: #0000ff;">this</span>.footerView =<span style="color: #000000;"> footerView;<br></span><span style="color: #008080;"> 16</span>         extraCount += hasHeaderView() ? 0 : 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 17</span>         extraCount += hasFooterView() ? 0 : 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 18</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 19</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> hasHeaderView() {<br></span><span style="color: #008080;"> 21</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> headerView;<br></span><span style="color: #008080;"> 22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 23</span><br><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> hasFooterView() {<br></span><span style="color: #008080;"> 25</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> footerView;<br></span><span style="color: #008080;"> 26</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 27</span><br><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> innerPositionToRealItemPosition(<span style="color: #0000ff;">int</span><span style="color: #000000;"> innerPosition) {<br></span><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">return</span> hasHeaderView() ? innerPosition - 1<span style="color: #000000;"> : innerPosition;<br></span><span style="color: #008080;"> 30</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 31</span><br><span style="color: #008080;"> 32</span> <span style="color: #000000;">    @TargetApi(Build.VERSION_CODES.DONUT)<br></span><span style="color: #008080;"> 33</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 34</span>     <span style="color: #0000ff;">public</span> ABRecyclerViewTypeExtraHolder onCreateViewHolder(ViewGroup viewGroup, <span style="color: #0000ff;">int</span><span style="color: #000000;"> viewType) {<br></span><span style="color: #008080;"> 35</span>         ABAdapterTypeRender&lt;ABRecyclerViewTypeExtraHolder&gt; render =<span style="color: #000000;"> getAdapterTypeRender(viewType);<br></span><span style="color: #008080;"> 36</span>         ABRecyclerViewTypeExtraHolder holder =<span style="color: #000000;"> render.getReusableComponent();<br></span><span style="color: #008080;"> 37</span> <span style="color: #000000;">        holder.itemView.setTag(R.id.ab<strong>id_adapter_item_type_render, render);<br></strong></span><span style="color: #008080;"> 38</span> <span style="color: #000000;">        render.fitEvents();<br></span><span style="color: #008080;"> 39</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> holder;<br></span><span style="color: #008080;"> 40</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span> <span style="color: #000000;">    @TargetApi(Build.VERSION_CODES.DONUT)<br></span><span style="color: #008080;"> 43</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 44</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onBindViewHolder(ABRecyclerViewTypeExtraHolder holder, <span style="color: #0000ff;">int</span><span style="color: #000000;"> innerPosition) {<br></span><span style="color: #008080;"> 45</span>         ABAdapterTypeRender&lt;ABRecyclerViewTypeExtraHolder&gt; render = (ABAdapterTypeRender&lt;ABRecyclerViewTypeExtraHolder&gt;<span style="color: #000000;">) holder.itemView.getTag(R.id.abid_adapter_item_type_render);<br></span><span style="color: #008080;"> 46</span>         <span style="color: #008000;">/</span><br><span style="color: #008080;"> 47</span> <span style="color: #008000;">         <em> 计算该item在list中的index（不包括headerView和footerView）<br></em></span><span style="color: #008080;"> 48</span>          <span style="color: #008000;">/</span><br><span style="color: #008080;"> 49</span>         <span style="color: #0000ff;">int</span> realItemPosition =<span style="color: #000000;"> innerPositionToRealItemPosition(innerPosition);<br></span><span style="color: #008080;"> 50</span> <span style="color: #000000;">        render.fitDatas(realItemPosition);<br></span><span style="color: #008080;"> 51</span>         <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 52</span> <span style="color: #008000;">         <em> 重新设置item在list中的index（不包括headerView和footerView）<br></em></span><span style="color: #008080;"> 53</span>          <span style="color: #008000;">/</span><br><span style="color: #008080;"> 54</span> <span style="color: #000000;">        holder.setRealItemPosition(realItemPosition);<br></span><span style="color: #008080;"> 55</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 56</span><br><span style="color: #008080;"> 57</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 58</span> <span style="color: #008000;">     <em> 通过类型获得对应的render（不包括headerView和footerView）<br></em></span><span style="color: #008080;"> 59</span> <span style="color: #008000;">     <br></span><span style="color: #008080;"> 60</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> type<br></span><span style="color: #008080;"> 61</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 62</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> ABAdapterTypeRender&lt;ABRecyclerViewTypeExtraHolder&gt; getAdapterTypeRenderExcludeExtraView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> type);<br></span><span style="color: #008080;"> 64</span><br><span style="color: #008080;"> 65</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 66</span> <span style="color: #008000;">      获取item的数量（不包括headerView和footerView）<br></span><span style="color: #008080;"> 67</span> <span style="color: #008000;">     <em><br></em></span><span style="color: #008080;"> 68</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 69</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 70</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getItemCountExcludeExtraView();<br></span><span style="color: #008080;"> 71</span><br><span style="color: #008080;"> 72</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 73</span> <span style="color: #008000;">      通过realItemPosition得到该item的类型（不包括headerView和footerView）<br></span><span style="color: #008080;"> 74</span> <span style="color: #008000;">     <em><br></em></span><span style="color: #008080;"> 75</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> realItemPosition<br></span><span style="color: #008080;"> 76</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 77</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 78</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">int</span> getItemViewTypeExcludeExtraView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> realItemPosition);<br></span><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span>     <span style="color: #0000ff;">public</span> ABAdapterTypeRender&lt;ABRecyclerViewTypeExtraHolder&gt; getAdapterTypeRender(<span style="color: #0000ff;">int</span><span style="color: #000000;"> type) {<br></span><span style="color: #008080;"> 81</span>         <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (type) {<br></span><span style="color: #008080;"> 82</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> TYPE_HEADER_VIEW:<br></span><span style="color: #008080;"> 83</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ABRecyclerViewTypeExtraRender(headerView);<br></span><span style="color: #008080;"> 84</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> TYPE_FOOTER_VIEW:<br></span><span style="color: #008080;"> 85</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ABRecyclerViewTypeExtraRender(footerView);<br></span><span style="color: #008080;"> 86</span>             <span style="color: #0000ff;">default</span><span style="color: #000000;">:<br></span><span style="color: #008080;"> 87</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> getAdapterTypeRenderExcludeExtraView(type);<br></span><span style="color: #008080;"> 88</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 89</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 90</span><br><span style="color: #008080;"> 91</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 92</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getItemCount() {<br></span><span style="color: #008080;"> 93</span>         <span style="color: #0000ff;">return</span> getItemCountExcludeExtraView() +<span style="color: #000000;"> extraCount;<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 95</span><br><span style="color: #008080;"> 96</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 97</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> getItemViewType(<span style="color: #0000ff;">int</span><span style="color: #000000;"> innerPosition) {<br></span><span style="color: #008080;"> 98</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> != headerView &amp;&amp; 0 == innerPosition) { <span style="color: #008000;">//</span><span style="color: #008000;"> header</span><br><span style="color: #008080;"> 99</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> TYPE_HEADER_VIEW;<br></span><span style="color: #008080;">100</span>         } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> != footerView &amp;&amp; getItemCount() - 1 == innerPosition) { <span style="color: #008000;">//</span><span style="color: #008000;"> footer</span><br><span style="color: #008080;">101</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> TYPE_FOOTER_VIEW;<br></span><span style="color: #008080;">102</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">103</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> getItemViewTypeExcludeExtraView(innerPositionToRealItemPosition(innerPosition));<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">105</span> }</pre><br></div>

<p>如上述代码所示：</p>
<p>因为我们的需求是需要添加&ldquo;加载进度条&rdquo;，所以需要像ListView那样，添加一个FooterView。可是坑爹的是，RecyclerView不提供addheaderView()和addFooterView()方法，所以只能我们自己去实现了，方法当然是使用不同type来区分类型。虽然headerView这里没有用到，但是也顺带实现下好了。</p>
<p>这里我们使用的Holder是<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraHolder.java" target="_blank" rel="noopener"><strong>ABRecyclerViewTypeExtraHolder</strong></a>，这个类待会分析。</p>
<p>headerView和footerView这里使用构造方法传入，并缓存headerView和footerView。在onCreateViewHolder中，我们通过不同type，生成相应的render。并把render绑定到holder的itemView上面，因为既然现在复用的是holder，那我的render也要实现复用的话，也绑定在holder里面吧。然后调用render的fitEvents方法，来实现render里面的事件绑定。</p>
<p>onBindViewHolder方法中，通过holder，取出render，然后注意Line49～54，里面执行了innerPositionToRealItemPosition()方法对innerPosition到RealItemPosition的转换，这里的innerPosition代表内部的position，因为这里可能会添加了headerView，一旦添加了headerView，那position跟数据源List中的index就不匹配了，这样的话绑定点击事件后，通过holder.getPositon()得到的position就不是index了，所以不能写&ldquo;list.get(position)…&rdquo;了。这里的realItemPosition就代表数据源对应的index 。所以我们要把innerPosition转换为realItemPosition，方法很简单，innerPosition－1=realItemPosition（这里的减去1实际上就是减去了headerView）。其实holder中本来就缓存了当前使用了这个holder的item的position，但是因为有了headerView的存在，position就不等于realItemPosition了，所以我们还需要缓存realItemPosition。所以代码Line46～54诞生了。</p>
<p>getItemCountExcludeExtraView()方法需要子类实现，返回数据源中的数据数量，然后再加上extraCount即是getItemCount的值。</p>
<p>getItemViewType()方法先执行了header类型和footer类型的逻辑，然后再让自类去实现getItemViewTypeExcludeExtraView()来执行其他类型的逻辑。</p>
<p>至于<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraRender.java" target="_blank" rel="noopener">ABRecyclerViewTypeExtraRender</a>（<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraRender.java" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraRender.java</a>）</strong></p>
<p>部分的实现可以查看</p>
<p><strong><a href="http://www.cnblogs.com/[Android]使用AdapterTypeRender对不同类型的item数据到UI的渲染" target="_blank" rel="noopener">[Android]使用AdapterTypeRender对不同类型的item数据到UI的渲染</a></strong>（<strong><a href="http://www.cnblogs.com/tiantianbyconan/p/3992843.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/3992843.html</a></strong>）</p>
<p>实现的原理大同小异了。</p>
<p>&nbsp;</p>
<p>然后分析下<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraHolder.java" target="_blank" rel="noopener">ABRecyclerViewTypeExtraHolder</a>（<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraHolder.java" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/extra/ABRecyclerViewTypeExtraHolder.java</a>）</strong>这个类，代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;"> <em> Author: wangjie<br></em></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">  Email: tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;"> <em> Date: 1/22/15.<br></em></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> ABRecyclerViewTypeExtraHolder <span style="color: #0000ff;">extends</span><span style="color: #000000;"> ABRecyclerViewHolder {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ABRecyclerViewTypeExtraHolder(View itemView) {<br></span><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(itemView);<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">12</span> <span style="color: #008000;">     <em> 保存当前position（list index，不包括headerView和footerView）<br></em></span><span style="color: #008080;">13</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">14</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> realItemPosition;<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getRealItemPosition() {<br></span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> realItemPosition;<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> setRealItemPosition(<span style="color: #0000ff;">int</span><span style="color: #000000;"> realItemPosition) {<br></span><span style="color: #008080;">21</span>         <span style="color: #0000ff;">this</span>.realItemPosition =<span style="color: #000000;"> realItemPosition;<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span> }</pre><br></div>

<p>它继承了<a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/ABRecyclerViewHolder.java" target="_blank" rel="noopener"><strong>ABRecyclerViewHolder</strong></a>（<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/ABRecyclerViewHolder.java" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/ABRecyclerViewHolder.java</a></strong>），只是保存了一个刚刚讲到的realItemPosition对象。</p>
<p>所以我们再贴下<strong><a href="https://github.com/wangjiegulu/AndroidBucket/blob/master/src/com/wangjie/androidbucket/support/recyclerview/adapter/ABRecyclerViewHolder.java" target="_blank" rel="noopener">ABRecyclerViewHolder</a></strong>的代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;"> <em> Author: wangjie<br></em></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">  Email: tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;"> <em> Date: 1/19/15.<br></em></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> ABRecyclerViewHolder <span style="color: #0000ff;">extends</span><span style="color: #000000;"> RecyclerView.ViewHolder {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = ABRecyclerViewHolder.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">private</span> SparseArray&lt;View&gt; holder = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ABRecyclerViewHolder(View itemView) {<br></span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(itemView);<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">15</span> <span style="color: #008000;">     <em> 获取一个缓存的view<br></em></span><span style="color: #008080;">16</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">17</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> id<br></span><span style="color: #008080;">18</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> &lt;T&gt;<br></span><span style="color: #008080;">19</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">20</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span> &lt;T <span style="color: #0000ff;">extends</span> View&gt; T obtainView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> id) {<br></span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> holder) {<br></span><span style="color: #008080;">23</span>             holder = <span style="color: #0000ff;">new</span> SparseArray&lt;&gt;<span style="color: #000000;">();<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">25</span>         View view =<span style="color: #000000;"> holder.get(id);<br></span><span style="color: #008080;">26</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> view) {<br></span><span style="color: #008080;">27</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> (T) view;<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">29</span>         view =<span style="color: #000000;"> itemView.findViewById(id);<br></span><span style="color: #008080;">30</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> view) {<br></span><span style="color: #008080;">31</span>             Logger.e(TAG, “no view that id is “ +<span style="color: #000000;"> id);<br></span><span style="color: #008080;">32</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">        holder.put(id, view);<br></span><span style="color: #008080;">35</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> (T) view;<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">37</span><br><span style="color: #008080;">38</span>     <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">39</span> <span style="color: #008000;">      获取一个缓存的view，并自动转型<br></span><span style="color: #008080;">40</span> <span style="color: #008000;">     <em><br></em></span><span style="color: #008080;">41</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> id<br></span><span style="color: #008080;">42</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> &lt;T&gt;<br></span><span style="color: #008080;">43</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;">44</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">45</span>     <span style="color: #0000ff;">public</span> &lt;T&gt; T obtainView(<span style="color: #0000ff;">int</span> id, Class&lt;T&gt;<span style="color: #000000;"> viewClazz) {<br></span><span style="color: #008080;">46</span>         View view =<span style="color: #000000;"> obtainView(id);<br></span><span style="color: #008080;">47</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> view) {<br></span><span style="color: #008080;">48</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">49</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">50</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> (T) view;<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">52</span><br><span style="color: #008080;">53</span> }</pre><br></div>

<p>然后发现，它的作用是在于使用SparseArray来缓存findViewById后的控件。这样做的好处是，这个holder可以适用于任何的RecyclerView.Adapter中。只要通过obtainView()方法就能得到itemView中的具体的view对象，如下代码所示：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> Person person =<span style="color: #000000;"> adapter.getList().get(position);<br></span><span style="color: #008080;">2</span> holder.obtainView(R.id.recycler_view_test_item_person_name_tv, TextView.<span style="color: #0000ff;">class</span><span style="color: #000000;">).setText(person.getName());＝<br></span><span style="color: #008080;">3</span> holder.obtainView(R.id.recycler_view_test_item_person_age_tv, TextView.<span style="color: #0000ff;">class</span>).setText(person.getAge() + “岁”);</pre><br></div>

<p>&nbsp;</p>
<p><strong>示例代码：</strong></p>
<p><strong><a href="https://github.com/wangjiegulu/RecyclerViewSample" target="_blank" rel="noopener">https://github.com/wangjiegulu/RecyclerViewSample</a></strong></p>
<p>&nbsp;</p>
<p><span style="font-size: 16px; color: #ff0000;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4232560.html" target="_blank" rel="noopener"><span style="color: #ff0000;">[Android]使用RecyclerView替代ListView（一）</span></a></strong>：</span></p>
<p><span style="font-size: 16px;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4232560.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4232560.html</a></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><span style="font-size: 16px;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4268097.html" target="_blank" rel="noopener"><span style="color: #ff0000;">[Android]使用RecyclerView替代ListView（三）</span></a></strong>：</span>&nbsp;</span></p>
<p><span style="font-size: 16px; line-height: 24px;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4268097.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4268097.html</a></strong></span></p>
<p>&nbsp;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/01/18/Android-使用RecyclerView替代ListView（一）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/01/18/Android-使用RecyclerView替代ListView（一）/" itemprop="url">[Android]使用RecyclerView替代ListView（一）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-01-18T23:01:00+08:00">
                2015-01-18
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/01/18/Android-使用RecyclerView替代ListView（一）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/01/18/Android-使用RecyclerView替代ListView（一）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="color: #ff0000;"><strong>以下内容为原创，欢迎转载，转载请注明</strong></span></p>
<p><span style="color: #ff0000;"><strong>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/4232560.html" title="view: [Android]使用RecyclerView替代ListView（一）" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4232560.html</a></strong></span></p>
<p>&nbsp;</p>
<p>RecyclerView是一个比ListView更灵活的一个控件，以后可以直接抛弃ListView了。具体好在哪些地方，往下看就知道了。</p>
<p>首先我们来使用RecyclerView来实现ListView的效果，一个滚动列表，先看下效果图（除了有动画之外，没什么特别－－）：</p>
<p><img src="http://images.cnitblog.com/blog/378300/201501/182259096511353.png" alt=""></p>
<p>&nbsp;</p>
<p>每个item的布局如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="noopener">http://schemas.android.com/apk/res/android</a>“</span><span style="color: #ff0000;"><br>              android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_test_item_person_view”</span><span style="color: #ff0000;"><br>              android:orientation</span><span style="color: #0000ff;">=”vertical”</span><span style="color: #ff0000;"><br>              android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br>              android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br>              android:padding</span><span style="color: #0000ff;">=”15dp”</span><span style="color: #ff0000;"><br>              android:background</span><span style="color: #0000ff;">=”#aabbcc”</span><br>        <span style="color: #0000ff;">&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextView<br>            </span><span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_test_item_person_name_tv”</span><span style="color: #ff0000;"><br>            android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br>            android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br>            android:textSize</span><span style="color: #0000ff;">=”18sp”</span><span style="color: #ff0000;"><br>            android:background</span><span style="color: #0000ff;">=”#ccbbaa”</span><br>            <span style="color: #0000ff;">/&gt;</span><br>    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextView<br>            </span><span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_test_item_person_age_tv”</span><span style="color: #ff0000;"><br>            android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br>            android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><span style="color: #ff0000;"><br>            android:paddingLeft</span><span style="color: #0000ff;">=”5dp”</span><span style="color: #ff0000;"><br>            android:background</span><span style="color: #0000ff;">=”#aaccbb”</span><span style="color: #ff0000;"><br>            android:textSize</span><span style="color: #0000ff;">=”15sp”</span><br>            <span style="color: #0000ff;">/&gt;</span><br><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>item的布局很简单，只有两个TextView，一个用来显示名字，一个用来显示年龄。</p>
<p>Person的实体类就不贴代码了，两个属性：名字和年龄。</p>
<p>然后需要使用到RecyclerView，所以需要把support v7添加到class path，并在布局中添加该控件：</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">android.support.v7.widget.RecyclerView<br>                </span><span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/recycler_view_test_rv”</span><span style="color: #ff0000;"><br>                android:scrollbars</span><span style="color: #0000ff;">=”vertical”</span><span style="color: #ff0000;"><br>                android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br>                android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"><br>                android:background</span><span style="color: #0000ff;">=”#bbccaa”</span><br>                <span style="color: #0000ff;">/&gt;</span></pre><br></div>

<p>然后在onCreate中：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span>         recyclerView.setHasFixedSize(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">2</span><br><span style="color: #008080;">3</span>         RecyclerView.LayoutManager layoutManager = <span style="color: #0000ff;">new</span><span style="color: #000000;"> LinearLayoutManager(context);<br></span><span style="color: #008080;">4</span> <span style="color: #000000;">        recyclerView.setLayoutManager(layoutManager);<br></span><span style="color: #008080;">5</span><br><span style="color: #008080;">6</span> <span style="color: #000000;">        initData();<br></span><span style="color: #008080;">7</span>         adapter = <span style="color: #0000ff;">new</span><span style="color: #000000;"> PersonAdapter(personList);<br></span><span style="color: #008080;">8</span>         adapter.setOnRecyclerViewListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">9</span>         recyclerView.setAdapter(adapter);    </pre><br></div>

<p>&nbsp;</p>
<p>如上述代码：</p>
<p>Line1: 使RecyclerView保持固定的大小,这样会提高RecyclerView的性能。</p>
<p>Line3: LinearLayoutManager，如果你需要显示的是横向滚动的列表或者竖直滚动的列表，则使用这个LayoutManager。显然，我们要实现的是ListView的效果，所以需要使用它。生成这个LinearLayoutManager之后可以设置他滚动的方向，默认竖直滚动，所以这里没有显式地设置。</p>
<p>Line6: 初始化数据源。</p>
<p>Line7～9: 跟ListView一样，需要设置RecyclerView的Adapter，但是这里的Adapter跟ListView使用的Adapter不一样，这里的Adapter需要继承RecyclerView.Adapter，需要实现3个方法：</p>
<p>-&nbsp;onCreateViewHolder()</p>
<p>-&nbsp;onBindViewHolder()</p>
<p>-&nbsp;getItemCount()</p>
<p>直接看代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.wangjie.helloandroid.sample.recycler.person;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.support.v7.widget.RecyclerView;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.LayoutInflater;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.ViewGroup;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.LinearLayout;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.TextView;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.androidbucket.log.Logger;<br></span><span style="color: #008080;">10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.wangjie.helloandroid.R;<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">15</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;">16</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">17</span> <span style="color: #008000;">  Date: 1/17/15.<br></span><span style="color: #008080;">18</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;">19</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> PersonAdapter <span style="color: #0000ff;">extends</span><span style="color: #000000;"> RecyclerView.Adapter {<br></span><span style="color: #008080;">20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> OnRecyclerViewListener {<br></span><span style="color: #008080;">21</span>         <span style="color: #0000ff;">void</span> onItemClick(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position);<br></span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">boolean</span> onItemLongClick(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position);<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> OnRecyclerViewListener onRecyclerViewListener;<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnRecyclerViewListener(OnRecyclerViewListener onRecyclerViewListener) {<br></span><span style="color: #008080;">28</span>         <span style="color: #0000ff;">this</span>.onRecyclerViewListener =<span style="color: #000000;"> onRecyclerViewListener;<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = PersonAdapter.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;">32</span>     <span style="color: #0000ff;">private</span> List&lt;Person&gt;<span style="color: #000000;"> list;<br></span><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span>     <span style="color: #0000ff;">public</span> PersonAdapter(List&lt;Person&gt;<span style="color: #000000;"> list) {<br></span><span style="color: #008080;">35</span>         <span style="color: #0000ff;">this</span>.list =<span style="color: #000000;"> list;<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">37</span><br><span style="color: #008080;">38</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">39</span>     <span style="color: #0000ff;">public</span> RecyclerView.ViewHolder onCreateViewHolder(ViewGroup viewGroup, <span style="color: #0000ff;">int</span><span style="color: #000000;"> i) {<br></span><span style="color: #008080;">40</span>         Logger.d(TAG, “onCreateViewHolder, i: “ +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">41</span>         View view = LayoutInflater.from(viewGroup.getContext()).inflate(R.layout.recycler_view_test_item_person, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">42</span>         LinearLayout.LayoutParams lp = <span style="color: #0000ff;">new</span><span style="color: #000000;"> LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT);<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">        view.setLayoutParams(lp);<br></span><span style="color: #008080;">44</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> PersonViewHolder(view);<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">46</span><br><span style="color: #008080;">47</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">48</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onBindViewHolder(RecyclerView.ViewHolder viewHolder, <span style="color: #0000ff;">int</span><span style="color: #000000;"> i) {<br></span><span style="color: #008080;">49</span>         Logger.d(TAG, “onBindViewHolder, i: “ + i + “, viewHolder: “ +<span style="color: #000000;"> viewHolder);<br></span><span style="color: #008080;">50</span>         PersonViewHolder holder =<span style="color: #000000;"> (PersonViewHolder) viewHolder;<br></span><span style="color: #008080;">51</span>         holder.position =<span style="color: #000000;"> i;<br></span><span style="color: #008080;">52</span>         Person person =<span style="color: #000000;"> list.get(i);<br></span><span style="color: #008080;">53</span> <span style="color: #000000;">        holder.nameTv.setText(person.getName());<br></span><span style="color: #008080;">54</span>         holder.ageTv.setText(person.getAge() + “岁”<span style="color: #000000;">);<br></span><span style="color: #008080;">55</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">56</span><br><span style="color: #008080;">57</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">58</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getItemCount() {<br></span><span style="color: #008080;">59</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> list.size();<br></span><span style="color: #008080;">60</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">61</span><br><span style="color: #008080;">62</span>     <span style="color: #0000ff;">class</span> PersonViewHolder <span style="color: #0000ff;">extends</span> RecyclerView.ViewHolder <span style="color: #0000ff;">implements</span><span style="color: #000000;"> View.OnClickListener, View.OnLongClickListener<br></span><span style="color: #008080;">63</span> <span style="color: #000000;">    {<br></span><span style="color: #008080;">64</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> View rootView;<br></span><span style="color: #008080;">65</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> TextView nameTv;<br></span><span style="color: #008080;">66</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> TextView ageTv;<br></span><span style="color: #008080;">67</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> position;<br></span><span style="color: #008080;">68</span><br><span style="color: #008080;">69</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> PersonViewHolder(View itemView) {<br></span><span style="color: #008080;">70</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">(itemView);<br></span><span style="color: #008080;">71</span>             nameTv =<span style="color: #000000;"> (TextView) itemView.findViewById(R.id.recycler_view_test_item_person_name_tv);<br></span><span style="color: #008080;">72</span>             ageTv =<span style="color: #000000;"> (TextView) itemView.findViewById(R.id.recycler_view_test_item_person_age_tv);<br></span><span style="color: #008080;">73</span>             rootView =<span style="color: #000000;"> itemView.findViewById(R.id.recycler_view_test_item_person_view);<br></span><span style="color: #008080;">74</span>             rootView.setOnClickListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">75</span>             rootView.setOnLongClickListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">76</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">77</span><br><span style="color: #008080;">78</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">79</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v) {<br></span><span style="color: #008080;">80</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> onRecyclerViewListener) {<br></span><span style="color: #008080;">81</span> <span style="color: #000000;">                onRecyclerViewListener.onItemClick(position);<br></span><span style="color: #008080;">82</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">83</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">84</span><br><span style="color: #008080;">85</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">86</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onLongClick(View v) {<br></span><span style="color: #008080;">87</span>             <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> onRecyclerViewListener){<br></span><span style="color: #008080;">88</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> onRecyclerViewListener.onItemLongClick(position);<br></span><span style="color: #008080;">89</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">90</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">91</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">92</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">93</span><br><span style="color: #008080;">94</span> }</pre><br></div>

<p>如上代码所示：</p>
<p>public RecyclerView.ViewHolder onCreateViewHolder(ViewGroup viewGroup, int i)</p>
<p>这个方法主要生成为每个Item inflater出一个View，但是该方法返回的是一个ViewHolder。方法是把View直接封装在ViewHolder中，然后我们面向的是ViewHolder这个实例，当然这个ViewHolder需要我们自己去编写。直接省去了当初的convertView.setTag(holder)和convertView.getTag()这些繁琐的步骤。</p>
<p>&nbsp;</p>
<p>public void onBindViewHolder(RecyclerView.ViewHolder viewHolder, int i)</p>
<p>这个方法主要用于适配渲染数据到View中。方法提供给你了一个viewHolder，而不是原来的convertView。</p>
<p>对比下以前的写法就一目了然了：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">@Override<br></span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">public</span> View getView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position, View convertView, ViewGroup parent) {<br></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">        ViewHolder holder;<br></span><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">if</span>(<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> convertView){<br></span><span style="color: #008080;"> 5</span>             holder = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ViewHolder();<br></span><span style="color: #008080;"> 6</span>             LayoutInflater mInflater =<span style="color: #000000;"> (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);<br></span><span style="color: #008080;"> 7</span>             convertView = mInflater.inflate(R.layout.item, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 8</span>             holder.btn =<span style="color: #000000;"> (Button) convertView.findViewById(R.id.btn);<br></span><span style="color: #008080;"> 9</span>             holder.tv =<span style="color: #000000;"> (TextView) convertView.findViewById(R.id.tv);<br></span><span style="color: #008080;">10</span>             holder.iv =<span style="color: #000000;"> (TextView) convertView.findViewById(R.id.iv);<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span> <span style="color: #000000;">            convertView.setTag(holder);<br></span><span style="color: #008080;">13</span>         }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;">14</span>             holder =<span style="color: #000000;"> (ViewHolder) convertView.getTag();<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">final</span> HashMap&lt;String, Object&gt; map =<span style="color: #000000;"> list.get(position);<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>         holder.iv.setImageResource(Integer.valueOf(map.get(“iv”<span style="color: #000000;">).toString()));<br></span><span style="color: #008080;">19</span>         holder.tv.setText(map.get(“tv”<span style="color: #000000;">).toString());<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>         holder.btn.setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener() {<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">23</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v) {<br></span><span style="color: #008080;">24</span>                 Toast.makeText(context, map.get(“btn”<span style="color: #000000;">).toString(), Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">27</span><br><span style="color: #008080;">28</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> convertView;<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span>     <span style="color: #0000ff;">class</span><span style="color: #000000;"> ViewHolder{<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">        Button btn;<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">        ImageView iv;<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">        TextView tv;<br></span><span style="color: #008080;">35</span><br><span style="color: #008080;">36</span>     }</pre><br></div>

<p>对比后可以发现：</p>
<p>旧的写法中Line5～Line12＋Line28部分的代码其实起到的作用相当于新的写法的onCreateViewHolder()；</p>
<p>旧的写法中Line14～Line26部分的代码其实起到的作用相当于新的写法的onBindViewHolder()；</p>
<p>既然是这样，那我们就把原来相应的代码搬到对应的onCreateViewHolder()和onBindViewHolder()这两个方法中就可以了。</p>
<p>因为RecyclerView帮我们封装了Holder，所以我们自己写的ViewHolder就需要继承RecyclerView.ViewHolder，只有这样，RecyclerView才能帮你去管理这个ViewHolder类。</p>
<p>既然getView方法的渲染数据部分的代码相当于onBindViewHolder()，所以如果调用adapter.notifyDataSetChanged()方法，应该也会重新调用onBindViewHolder()方法才对吧？实验后，果然如此！</p>
<p>除了adapter.notifyDataSetChanged()这个方法之外，新的Adapter还提供了其他的方法，如下：</p>
<div class="cnblogs_code"><br><pre>        <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> notifyDataSetChanged()<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemChanged(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position)<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemRangeChanged(<span style="color: #0000ff;">int</span> positionStart, <span style="color: #0000ff;">int</span><span style="color: #000000;"> itemCount)<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemInserted(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position)<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemMoved(<span style="color: #0000ff;">int</span> fromPosition, <span style="color: #0000ff;">int</span><span style="color: #000000;"> toPosition)<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemRangeInserted(<span style="color: #0000ff;">int</span> positionStart, <span style="color: #0000ff;">int</span><span style="color: #000000;"> itemCount)<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemRemoved(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position)<br>        </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> notifyItemRangeRemoved(<span style="color: #0000ff;">int</span> positionStart, <span style="color: #0000ff;">int</span> itemCount) </pre><br></div>

<p>基本上看到方法的名字就知道这个方法是干嘛的了，</p>
<p>第一个方法没什么好讲的，跟以前一样。</p>
<p>notifyItemChanged(int position)，position数据发生了改变，那调用这个方法，就会回调对应position的onBindViewHolder()方法了，当然，因为ViewHolder是复用的，所以如果position在当前屏幕以外，也就不会回调了，因为没有意义，下次position滚动会当前屏幕以内的时候同样会调用onBindViewHolder()方法刷新数据了。其他的方法也是同样的道理。</p>
<p>public final void notifyItemRangeChanged(int positionStart, int itemCount)，顾名思义，可以刷新从positionStart开始itemCount数量的item了（这里的刷新指回调onBindViewHolder()方法）。</p>
<p>public final void notifyItemInserted(int position)，这个方法是在第position位置被插入了一条数据的时候可以使用这个方法刷新，注意这个方法调用后会有插入的动画，这个动画可以使用默认的，也可以自己定义。</p>
<p>public final void notifyItemMoved(int fromPosition, int toPosition)，这个方法是从fromPosition移动到toPosition为止的时候可以使用这个方法刷新</p>
<p>public final void notifyItemRangeInserted(int positionStart, int itemCount)，显然是批量添加。</p>
<p>public final void notifyItemRemoved(int position)，第position个被删除的时候刷新，同样会有动画。</p>
<p>public final void notifyItemRangeRemoved(int positionStart, int itemCount)，批量删除。</p>
<p>&nbsp;</p>
<p>这些方法分析完之后，我们来实现一个点击一个按钮，新增一条数据，长按一个item，删除一条数据的场景。</p>
<p>以下是新增一条数据的代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> Person person = <span style="color: #0000ff;">new</span> Person(i, “WangJie_” + i, 10 +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">2</span> adapter.notifyItemInserted(2<span style="color: #000000;">);<br></span><span style="color: #008080;">3</span> personList.add(2<span style="color: #000000;">, person);<br></span><span style="color: #008080;">4</span> adapter.notifyItemRangeChanged(2, adapter.getItemCount());</pre><br></div>

<p>如上代码：</p>
<p>Line2：表示在position为2的位置，插入一条数据，这个时候动画开始执行。</p>
<p>Line3: 表示在数据源中position为2的位置新增一条数据（其实这个才是真正的新增数据啦）。</p>
<p>Line4: 为什么要刷新position为2以后的数据呢？因为，在position为2的位置插入了一条数据后，新数据的position变成了2，那原来的position为2的应该变成了3，3的应该变成了4，所以2以后的所有数据的position都发生了改变，所以需要把position2以后的数据都要刷新。理论上是这样，但是实际上刷新的数量只有在屏幕上显示的position为2以后的数据而已。如果这里使用notifyDataSetChanged()来刷新屏幕上显示的所有item可以吗？结果不会出错，但是会有一个问题，前面调用了notifyItemInserted()方法后会在执行动画，如果你调用notifyDataSetChanged()刷新屏幕上显示的所有item的话，必然也会刷新当前正在执行动画的那个item，这样导致的结果是，前面的动画还没执行完，它马上又被刷新了，动画就看不见了。所以只要刷新2以后的item就可以了。</p>
<p>&nbsp;</p>
<p>看了RecyclerView的api，发现没有setOnItemClickListener－－，所以还是自己把onItemClick从Adapter中回调出来吧。这个很简单，就像上面PersonAdaper中写的OnRecyclerViewListener那样。</p>
<p>&nbsp;</p>
<p>长按删除的代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #000000;">adapter.notifyItemRemoved(position);<br></span><span style="color: #008080;">2</span> <span style="color: #000000;">personList.remove(position);<br></span><span style="color: #008080;">3</span> adapter.notifyItemRangeChanged(position, adapter.getItemCount());</pre><br></div>

<p>代码跟之前插入的代码基本一致。先通知执行动画，然后删除数据源中的数据，然后通知position之后的数据刷新就可以了。</p>
<p>这样ListView的效果就实现了。</p>
<p>&nbsp;</p>
<p><strong>示例代码：</strong></p>
<p><strong><a href="https://github.com/wangjiegulu/RecyclerViewSample" target="_blank" rel="noopener">https://github.com/wangjiegulu/RecyclerViewSample</a></strong></p>
<p>&nbsp;</p>
<p><span style="font-size: 16px; color: #ff0000;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener"><span style="color: #ff0000;">[Android]使用RecyclerView替代ListView（二）</span></a></strong>：</span></p>
<p><span style="font-size: 16px; color: #0000ff;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener"><span style="color: #0000ff;">http://www.cnblogs.com/tiantianbyconan/p/4242541.html</span></a></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><span style="font-size: 16px;"><strong><a href="http://www.cnblogs.com/tiantianbyconan/p/4242541.html" target="_blank" rel="noopener"><span style="color: #ff0000;">[Android]使用RecyclerView替代ListView（三）</span></a></strong>：</span>&nbsp;</span></p>
<p><span style="color: #0000ff;"><a href="http://www.cnblogs.com/tiantianbyconan/p/4268097.html" target="_blank" rel="noopener"><span style="color: #0000ff;"><span style="font-size: 16px; line-height: 24px;"><strong><span style="text-decoration: underline;">http://www.cnblogs.com/tiantianbyconan/p/4268097.html</span></strong></span></span></a></span></p>
<p>&nbsp;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2014/12/24/Android-仿新版QQ的tab下面拖拽标记为已读的效果/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/12/24/Android-仿新版QQ的tab下面拖拽标记为已读的效果/" itemprop="url">[Android]仿新版QQ的tab下面拖拽标记为已读的效果</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-12-24T17:39:00+08:00">
                2014-12-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/12/24/Android-仿新版QQ的tab下面拖拽标记为已读的效果/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/12/24/Android-仿新版QQ的tab下面拖拽标记为已读的效果/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="color: #ff0000;"><strong>以下内容为原创，欢迎转载，转载请注明</strong></span></p>
<p><span style="color: #ff0000;"><strong>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/4182929.html" title="view: [Android]仿新版QQ的tab下面拖拽标记为已读的效果" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4182929.html</a></strong></span></p>
<p>可拖拽的红点，（仿新版QQ，tab下面拖拽标记为已读的效果），拖拽一定的距离可以消失回调。</p>
<p><img src="https://raw.githubusercontent.com/wangjiegulu/DraggableFlagView/master/screenshot/draggableflagview.gif" alt=""></p>
<p>&nbsp;<img src="https://raw.githubusercontent.com/wangjiegulu/DraggableFlagView/master/screenshot/draggableflagview_b.png" alt=""><span style="line-height: 1.5;">&nbsp;</span><img src="https://raw.githubusercontent.com/wangjiegulu/DraggableFlagView/master/screenshot/draggableflagview_d.png" alt=""></p>
<p>&nbsp;</p>
<p><strong>GitHub：<a href="https://github.com/wangjiegulu/DraggableFlagView" target="_blank" rel="noopener">DraggableFlagView</a>（<a href="https://github.com/wangjiegulu/DraggableFlagView" target="_blank" rel="noopener">https://github.com/wangjiegulu/DraggableFlagView</a>）</strong></p>
<p>实现原理：</p>
<p>当根据touch事件的移动，不断调用onDraw()方法进行刷新绘制。</p>
<p><span style="color: #ff0000;">*注意：这里原来的小红点称为红点A；根据手指移动绘制的小红点称为红点B。</span></p>
<p>touch事件移动的时候需要处理的逻辑：</p>
<p>1. <span style="color: #000000;">红点A的半径根据滑动的距离会不断地变小。</span></p>
<p><span style="color: #000000;">2. 红点B会紧随手指的位置移动。</span></p>
<p><span style="color: #000000;">3. 在红点A和红点B之间需要用贝塞尔曲线绘制连接区域。</span></p>
<p><span style="color: #000000;">4. 如果红点A和红点B之间的间距达到了设置的最大的距离，则表示，这次的拖拽会有效，一旦放手红点就会消失。</span></p>
<p><span style="color: #000000;">5. 如果达到了第4中情况，则红点A和中间连接的贝塞尔曲线不会被绘制。</span></p>
<p><span style="color: #000000;">6. 如果红点A和红点B之间的距离没有达到设置的最大的距离，则放手后，红点B消失，红点A从原来变小的半径使用反弹动画变换到原来最初的状态</span></p>
<p>一些工具类需要依赖&nbsp;<strong><a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">AndroidBucket</a>(<a href="https://github.com/wangjiegulu/AndroidBucket" target="_blank" rel="noopener">https://github.com/wangjiegulu/AndroidBucket</a>)，nineoldandroid</strong></p>
<p><span style="font-size: 16px;"><strong><span style="color: #000000;">使用方式：</span></strong></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">com.wangjie.draggableflagview.DraggableFlagView<br>　　　　　　　</span><span style="color: #ff0000;">xmlns:dfv</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/com.wangjie.draggableflagview" target="_blank" rel="noopener">http://schemas.android.com/apk/res/com.wangjie.draggableflagview</a>“</span><span style="color: #ff0000;"><br>            android:id</span><span style="color: #0000ff;">=”@+id/main_dfv”</span><span style="color: #ff0000;"><br>            android:layout_width</span><span style="color: #0000ff;">=”20dp”</span><span style="color: #ff0000;"><br>            android:layout_height</span><span style="color: #0000ff;">=”20dp”</span><span style="color: #ff0000;"><br>            android:layout_alignParentBottom</span><span style="color: #0000ff;">=”true”</span><span style="color: #ff0000;"><br>            android:layout_margin</span><span style="color: #0000ff;">=”15dp”</span><span style="color: #ff0000;"><br>            dfv:color</span><span style="color: #0000ff;">=”#FF3B30”</span><br>            <span style="color: #0000ff;">/&gt;</span></pre><br></div>

<p>&nbsp;</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span> Activity <span style="color: #0000ff;">implements</span><span style="color: #000000;"> DraggableFlagView.OnDraggableFlagViewListener, View.OnClickListener {<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">        setContentView(R.layout.main);<br></span><span style="color: #008080;"> 7</span>         findViewById(R.id.main_btn).setOnClickListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>         DraggableFlagView draggableFlagView =<span style="color: #000000;"> (DraggableFlagView) findViewById(R.id.main_dfv);<br></span><span style="color: #008080;">10</span>         draggableFlagView.setOnDraggableFlagViewListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">11</span>         draggableFlagView.setText(“7”<span style="color: #000000;">);<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">15</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onFlagDismiss(DraggableFlagView view) {<br></span><span style="color: #008080;">16</span>         Toast.makeText(<span style="color: #0000ff;">this</span>, “onFlagDismiss”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v) {<br></span><span style="color: #008080;">21</span>         <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (v.getId()) {<br></span><span style="color: #008080;">22</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> R.id.main_btn:<br></span><span style="color: #008080;">23</span>                 Toast.makeText(<span style="color: #0000ff;">this</span>, “hello world”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">24</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">27</span> }</pre><br></div>

<p><span style="font-size: 16px;"><strong>DraggableFlagView代码：</strong></span></p>
<p>&nbsp;</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">  2</span> <span style="color: #008000;"> <em> Author: wangjie<br></em></span><span style="color: #008080;">  3</span> <span style="color: #008000;">  Email: tiantian.china.2@gmail.com<br></span><span style="color: #008080;">  4</span> <span style="color: #008000;"> <em> Date: 12/23/14.<br></em></span><span style="color: #008080;">  5</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">  6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> DraggableFlagView <span style="color: #0000ff;">extends</span><span style="color: #000000;"> View {<br></span><span style="color: #008080;">  7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = DraggableFlagView.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;">  8</span><br><span style="color: #008080;">  9</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> OnDraggableFlagViewListener {<br></span><span style="color: #008080;"> 10</span>         <span style="color: #008000;">/</span><br><span style="color: #008080;"> 11</span> <span style="color: #008000;">         <em> 拖拽销毁圆点后的回调<br></em></span><span style="color: #008080;"> 12</span> <span style="color: #008000;">         <br></span><span style="color: #008080;"> 13</span> <span style="color: #008000;">         <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> view<br></span><span style="color: #008080;"> 14</span>          <span style="color: #008000;">/</span><br><span style="color: #008080;"> 15</span>         <span style="color: #0000ff;">void</span><span style="color: #000000;"> onFlagDismiss(DraggableFlagView view);<br></span><span style="color: #008080;"> 16</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 17</span><br><span style="color: #008080;"> 18</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> OnDraggableFlagViewListener onDraggableFlagViewListener;<br></span><span style="color: #008080;"> 19</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnDraggableFlagViewListener(OnDraggableFlagViewListener onDraggableFlagViewListener) {<br></span><span style="color: #008080;"> 21</span>         <span style="color: #0000ff;">this</span>.onDraggableFlagViewListener =<span style="color: #000000;"> onDraggableFlagViewListener;<br></span><span style="color: #008080;"> 22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 23</span><br><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> DraggableFlagView(Context context) {<br></span><span style="color: #008080;"> 25</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;"> 26</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 27</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 28</span><br><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> patientColor =<span style="color: #000000;"> Color.RED;<br></span><span style="color: #008080;"> 30</span><br><span style="color: #008080;"> 31</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> DraggableFlagView(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;"> 32</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;"> 33</span>         TypedArray a =<span style="color: #000000;"> context.obtainStyledAttributes(attrs, R.styleable.DraggableFlagView);<br></span><span style="color: #008080;"> 34</span>         <span style="color: #0000ff;">int</span> indexCount =<span style="color: #000000;"> a.getIndexCount();<br></span><span style="color: #008080;"> 35</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; indexCount; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;"> 36</span>             <span style="color: #0000ff;">int</span> attrIndex =<span style="color: #000000;"> a.getIndex(i);<br></span><span style="color: #008080;"> 37</span>             <span style="color: #0000ff;">if</span> (attrIndex ==<span style="color: #000000;"> R.styleable.DraggableFlagView_color) {<br></span><span style="color: #008080;"> 38</span>                 patientColor =<span style="color: #000000;"> a.getColor(attrIndex, Color.RED);<br></span><span style="color: #008080;"> 39</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 40</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 41</span> <span style="color: #000000;">        a.recycle();<br></span><span style="color: #008080;"> 42</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 43</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 44</span><br><span style="color: #008080;"> 45</span>     <span style="color: #0000ff;">public</span> DraggableFlagView(Context context, AttributeSet attrs, <span style="color: #0000ff;">int</span><span style="color: #000000;"> defStyle) {<br></span><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs, defStyle);<br></span><span style="color: #008080;"> 47</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 48</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 49</span><br><span style="color: #008080;"> 50</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br></span><span style="color: #008080;"> 51</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> originRadius; <span style="color: #008000;">//</span><span style="color: #008000;"> 初始的圆的半径</span><br><span style="color: #008080;"> 52</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> originWidth;<br></span><span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> originHeight;<br></span><span style="color: #008080;"> 54</span><br><span style="color: #008080;"> 55</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> maxMoveLength; <span style="color: #008000;">//</span><span style="color: #008000;"> 最大的移动拉长距离</span><br><span style="color: #008080;"> 56</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isArrivedMaxMoved; <span style="color: #008000;">//</span><span style="color: #008000;"> 达到了最大的拉长距离（松手可以触发事件）</span><br><span style="color: #008080;"> 57</span><br><span style="color: #008080;"> 58</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> curRadius; <span style="color: #008000;">//</span><span style="color: #008000;"> 当前点的半径</span><br><span style="color: #008080;"> 59</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> touchedPointRadius; <span style="color: #008000;">//</span><span style="color: #008000;"> touch的圆的半径</span><br><span style="color: #008080;"> 60</span>     <span style="color: #0000ff;">private</span> Point startPoint = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Point();<br></span><span style="color: #008080;"> 61</span>     <span style="color: #0000ff;">private</span> Point endPoint = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Point();<br></span><span style="color: #008080;"> 62</span><br><span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">private</span> Paint paint; <span style="color: #008000;">//</span><span style="color: #008000;"> 绘制圆形图形</span><br><span style="color: #008080;"> 64</span>     <span style="color: #0000ff;">private</span> Paint textPaint; <span style="color: #008000;">//</span><span style="color: #008000;"> 绘制圆形图形</span><br><span style="color: #008080;"> 65</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Paint.FontMetrics textFontMetrics;<br></span><span style="color: #008080;"> 66</span><br><span style="color: #008080;"> 67</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;">[] location;<br></span><span style="color: #008080;"> 68</span><br><span style="color: #008080;"> 69</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isTouched; <span style="color: #008000;">//</span><span style="color: #008000;"> 是否是触摸状态</span><br><span style="color: #008080;"> 70</span><br><span style="color: #008080;"> 71</span>     <span style="color: #0000ff;">private</span> Triangle triangle = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Triangle();<br></span><span style="color: #008080;"> 72</span><br><span style="color: #008080;"> 73</span>     <span style="color: #0000ff;">private</span> String text = “”; <span style="color: #008000;">//</span><span style="color: #008000;"> 正常状态下显示的文字</span><br><span style="color: #008080;"> 74</span><br><span style="color: #008080;"> 75</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> init(Context context) {<br></span><span style="color: #008080;"> 76</span>         <span style="color: #0000ff;">this</span>.context =<span style="color: #000000;"> context;<br></span><span style="color: #008080;"> 77</span><br><span style="color: #008080;"> 78</span> <span style="color: #000000;">        setBackgroundColor(Color.TRANSPARENT);<br></span><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置绘制flag的paint</span><br><span style="color: #008080;"> 81</span>         paint = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Paint();<br></span><span style="color: #008080;"> 82</span> <span style="color: #000000;">        paint.setColor(patientColor);<br></span><span style="color: #008080;"> 83</span>         paint.setAntiAlias(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 84</span><br><span style="color: #008080;"> 85</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置绘制文字的paint</span><br><span style="color: #008080;"> 86</span>         textPaint = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Paint();<br></span><span style="color: #008080;"> 87</span>         textPaint.setAntiAlias(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 88</span> <span style="color: #000000;">        textPaint.setColor(Color.WHITE);<br></span><span style="color: #008080;"> 89</span>         textPaint.setTextSize(ABTextUtil.sp2px(context, 12<span style="color: #000000;">));<br></span><span style="color: #008080;"> 90</span> <span style="color: #000000;">        textPaint.setTextAlign(Paint.Align.CENTER);<br></span><span style="color: #008080;"> 91</span>         textFontMetrics =<span style="color: #000000;"> paint.getFontMetrics();<br></span><span style="color: #008080;"> 92</span><br><span style="color: #008080;"> 93</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 94</span><br><span style="color: #008080;"> 95</span>     RelativeLayout.LayoutParams originLp; <span style="color: #008000;">//</span><span style="color: #008000;"> 实际的layoutparams</span><br><span style="color: #008080;"> 96</span>     RelativeLayout.LayoutParams newLp; <span style="color: #008000;">//</span><span style="color: #008000;"> 触摸时候的LayoutParams</span><br><span style="color: #008080;"> 97</span><br><span style="color: #008080;"> 98</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> isFirst = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 99</span><br><span style="color: #008080;">100</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">101</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> onSizeChanged(<span style="color: #0000ff;">int</span> w, <span style="color: #0000ff;">int</span> h, <span style="color: #0000ff;">int</span> oldw, <span style="color: #0000ff;">int</span><span style="color: #000000;"> oldh) {<br></span><span style="color: #008080;">102</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onSizeChanged(w, h, oldw, oldh);<br></span><span style="color: #008080;">103</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Logger.d(TAG, String.format(“onSizeChanged, w: %s, h: %s, oldw: %s, oldh: %s”, w, h, oldw, oldh));</span><br><span style="color: #008080;">104</span>         <span style="color: #0000ff;">if</span> (isFirst &amp;&amp; w &gt; 0 &amp;&amp; h &gt; 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">105</span>             isFirst = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">106</span><br><span style="color: #008080;">107</span>             originWidth =<span style="color: #000000;"> w;<br></span><span style="color: #008080;">108</span>             originHeight =<span style="color: #000000;"> h;<br></span><span style="color: #008080;">109</span><br><span style="color: #008080;">110</span>             originRadius = Math.min(originWidth, originHeight) / 2<span style="color: #000000;">;<br></span><span style="color: #008080;">111</span>             curRadius =<span style="color: #000000;"> originRadius;<br></span><span style="color: #008080;">112</span>             touchedPointRadius =<span style="color: #000000;"> originRadius;<br></span><span style="color: #008080;">113</span><br><span style="color: #008080;">114</span>             maxMoveLength = ABAppUtil.getDeviceHeight(context) / 6<span style="color: #000000;">;<br></span><span style="color: #008080;">115</span><br><span style="color: #008080;">116</span> <span style="color: #000000;">            refreshStartPoint();<br></span><span style="color: #008080;">117</span><br><span style="color: #008080;">118</span>             ViewGroup.LayoutParams lp = <span style="color: #0000ff;">this</span><span style="color: #000000;">.getLayoutParams();<br></span><span style="color: #008080;">119</span>             <span style="color: #0000ff;">if</span> (RelativeLayout.LayoutParams.<span style="color: #0000ff;">class</span><span style="color: #000000;">.isAssignableFrom(lp.getClass())) {<br></span><span style="color: #008080;">120</span>                 originLp =<span style="color: #000000;"> (RelativeLayout.LayoutParams) lp;<br></span><span style="color: #008080;">121</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">122</span>             newLp = <span style="color: #0000ff;">new</span><span style="color: #000000;"> RelativeLayout.LayoutParams(lp.width, lp.height);<br></span><span style="color: #008080;">123</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">124</span><br><span style="color: #008080;">125</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">126</span><br><span style="color: #008080;">127</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">128</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setLayoutParams(ViewGroup.LayoutParams params) {<br></span><span style="color: #008080;">129</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.setLayoutParams(params);<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">        refreshStartPoint();<br></span><span style="color: #008080;">131</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">132</span><br><span style="color: #008080;">133</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">134</span> <span style="color: #008000;">     <em> 修改layoutParams后，需要重新设置startPoint<br></em></span><span style="color: #008080;">135</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">136</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> refreshStartPoint() {<br></span><span style="color: #008080;">137</span>         location = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">int</span>[2<span style="color: #000000;">];<br></span><span style="color: #008080;">138</span>         <span style="color: #0000ff;">this</span><span style="color: #000000;">.getLocationInWindow(location);<br></span><span style="color: #008080;">139</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Logger.d(TAG, “location on screen: “ + Arrays.toString(location));<br></span><span style="color: #008080;">140</span> <span style="color: #008000;">//</span><span style="color: #008000;">            startPoint.set(location[0], location[1] + h);</span><br><span style="color: #008080;">141</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">142</span>             location[1] = location[1] -<span style="color: #000000;"> ABAppUtil.getTopBarHeight((Activity) context);<br></span><span style="color: #008080;">143</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception ex) {<br></span><span style="color: #008080;">144</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">145</span><br><span style="color: #008080;">146</span>         startPoint.set(location[0], location[1] +<span style="color: #000000;"> getMeasuredHeight());<br></span><span style="color: #008080;">147</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Logger.d(TAG, “startPoint: “ + startPoint);</span><br><span style="color: #008080;">148</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">149</span><br><span style="color: #008080;">150</span>     Path path = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Path();<br></span><span style="color: #008080;">151</span><br><span style="color: #008080;">152</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">153</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDraw(Canvas canvas) {<br></span><span style="color: #008080;">154</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDraw(canvas);<br></span><span style="color: #008080;">155</span> <span style="color: #000000;">        canvas.drawColor(Color.TRANSPARENT);<br></span><span style="color: #008080;">156</span><br><span style="color: #008080;">157</span>         <span style="color: #0000ff;">int</span> startCircleX = 0, startCircleY = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">158</span>         <span style="color: #0000ff;">if</span> (isTouched) { <span style="color: #008000;">//</span><span style="color: #008000;"> 触摸状态</span><br><span style="color: #008080;">159</span><br><span style="color: #008080;">160</span>             startCircleX = startPoint.x +<span style="color: #000000;"> curRadius;<br></span><span style="color: #008080;">161</span>             startCircleY = startPoint.y -<span style="color: #000000;"> curRadius;<br></span><span style="color: #008080;">162</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 绘制原来的圆形（触摸移动的时候半径会不断变化）</span><br><span style="color: #008080;">163</span> <span style="color: #000000;">            canvas.drawCircle(startCircleX, startCircleY, curRadius, paint);<br></span><span style="color: #008080;">164</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 绘制手指跟踪的圆形</span><br><span style="color: #008080;">165</span>             <span style="color: #0000ff;">int</span> endCircleX =<span style="color: #000000;"> endPoint.x;<br></span><span style="color: #008080;">166</span>             <span style="color: #0000ff;">int</span> endCircleY =<span style="color: #000000;"> endPoint.y;<br></span><span style="color: #008080;">167</span> <span style="color: #000000;">            canvas.drawCircle(endCircleX, endCircleY, originRadius, paint);<br></span><span style="color: #008080;">168</span><br><span style="color: #008080;">169</span>             <span style="color: #0000ff;">if</span> (!isArrivedMaxMoved) { <span style="color: #008000;">//</span><span style="color: #008000;"> 没有达到拉伸最大值</span><br><span style="color: #008080;">170</span> <span style="color: #000000;">                path.reset();<br></span><span style="color: #008080;">171</span>                 <span style="color: #0000ff;">double</span> sin = triangle.deltaY /<span style="color: #000000;"> triangle.hypotenuse;<br></span><span style="color: #008080;">172</span>                 <span style="color: #0000ff;">double</span> cos = triangle.deltaX /<span style="color: #000000;"> triangle.hypotenuse;<br></span><span style="color: #008080;">173</span><br><span style="color: #008080;">174</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> A点</span><br><span style="color: #008080;">175</span> <span style="color: #000000;">                path.moveTo(<br></span><span style="color: #008080;">176</span>                         (<span style="color: #0000ff;">float</span>) (startCircleX - curRadius <em><span style="color: #000000;"> sin),<br></span><span style="color: #008080;">177</span>                         (<span style="color: #0000ff;">float</span>) (startCircleY - curRadius </em><span style="color: #000000;"> cos)<br></span><span style="color: #008080;">178</span> <span style="color: #000000;">                );<br></span><span style="color: #008080;">179</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> B点</span><br><span style="color: #008080;">180</span> <span style="color: #000000;">                path.lineTo(<br></span><span style="color: #008080;">181</span>                         (<span style="color: #0000ff;">float</span>) (startCircleX + curRadius <em><span style="color: #000000;"> sin),<br></span><span style="color: #008080;">182</span>                         (<span style="color: #0000ff;">float</span>) (startCircleY + curRadius </em><span style="color: #000000;"> cos)<br></span><span style="color: #008080;">183</span> <span style="color: #000000;">                );<br></span><span style="color: #008080;">184</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> C点</span><br><span style="color: #008080;">185</span> <span style="color: #000000;">                path.quadTo(<br></span><span style="color: #008080;">186</span>                         (startCircleX + endCircleX) / 2, (startCircleY + endCircleY) / 2<span style="color: #000000;">,<br></span><span style="color: #008080;">187</span>                         (<span style="color: #0000ff;">float</span>) (endCircleX + originRadius <em> sin), (<span style="color: #0000ff;">float</span>) (endCircleY + originRadius </em><span style="color: #000000;"> cos)<br></span><span style="color: #008080;">188</span> <span style="color: #000000;">                );<br></span><span style="color: #008080;">189</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> D点</span><br><span style="color: #008080;">190</span> <span style="color: #000000;">                path.lineTo(<br></span><span style="color: #008080;">191</span>                         (<span style="color: #0000ff;">float</span>) (endCircleX - originRadius <em><span style="color: #000000;"> sin),<br></span><span style="color: #008080;">192</span>                         (<span style="color: #0000ff;">float</span>) (endCircleY - originRadius </em><span style="color: #000000;"> cos)<br></span><span style="color: #008080;">193</span> <span style="color: #000000;">                );<br></span><span style="color: #008080;">194</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> A点</span><br><span style="color: #008080;">195</span> <span style="color: #000000;">                path.quadTo(<br></span><span style="color: #008080;">196</span>                         (startCircleX + endCircleX) / 2, (startCircleY + endCircleY) / 2<span style="color: #000000;">,<br></span><span style="color: #008080;">197</span>                         (<span style="color: #0000ff;">float</span>) (startCircleX - curRadius <em> sin), (<span style="color: #0000ff;">float</span>) (startCircleY - curRadius </em><span style="color: #000000;"> cos)<br></span><span style="color: #008080;">198</span> <span style="color: #000000;">                );<br></span><span style="color: #008080;">199</span> <span style="color: #000000;">                canvas.drawPath(path, paint);<br></span><span style="color: #008080;">200</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">201</span><br><span style="color: #008080;">202</span><br><span style="color: #008080;">203</span>         } <span style="color: #0000ff;">else</span> { <span style="color: #008000;">//</span><span style="color: #008000;"> 非触摸状态</span><br><span style="color: #008080;">204</span>             <span style="color: #0000ff;">if</span> (curRadius &gt; 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">205</span>                 startCircleX =<span style="color: #000000;"> curRadius;<br></span><span style="color: #008080;">206</span>                 startCircleY = originHeight -<span style="color: #000000;"> curRadius;<br></span><span style="color: #008080;">207</span> <span style="color: #000000;">                canvas.drawCircle(startCircleX, startCircleY, curRadius, paint);<br></span><span style="color: #008080;">208</span>                 <span style="color: #0000ff;">if</span> (curRadius == originRadius) { <span style="color: #008000;">//</span><span style="color: #008000;"> 只有在恢复正常的情况下才显示文字<br></span><span style="color: #008080;">209</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 绘制文字</span><br><span style="color: #008080;">210</span>                     <span style="color: #0000ff;">float</span> textH = textFontMetrics.bottom -<span style="color: #000000;"> textFontMetrics.top;<br></span><span style="color: #008080;">211</span>                     canvas.drawText(text, startCircleX, startCircleY + textH / 2<span style="color: #000000;">, textPaint);<br></span><span style="color: #008080;">212</span> <span style="color: #008000;">//</span><span style="color: #008000;">                    canvas.drawText(text, startCircleX, startCircleY, textPaint);</span><br><span style="color: #008080;">213</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">214</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">215</span><br><span style="color: #008080;">216</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">217</span><br><span style="color: #008080;">218</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Logger.d(TAG, “circleX: “ + startCircleX + “, circleY: “ + startCircleY + “, curRadius: “ + curRadius);</span><br><span style="color: #008080;">219</span><br><span style="color: #008080;">220</span><br><span style="color: #008080;">221</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">222</span><br><span style="color: #008080;">223</span>     <span style="color: #0000ff;">float</span> downX =<span style="color: #000000;"> Float.MAX_VALUE;<br></span><span style="color: #008080;">224</span>     <span style="color: #0000ff;">float</span> downY =<span style="color: #000000;"> Float.MAX_VALUE;<br></span><span style="color: #008080;">225</span><br><span style="color: #008080;">226</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">227</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onTouchEvent(MotionEvent event) {<br></span><span style="color: #008080;">228</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onTouchEvent(event);<br></span><span style="color: #008080;">229</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Logger.d(TAG, “onTouchEvent: “ + event);</span><br><span style="color: #008080;">230</span>         <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (event.getAction()) {<br></span><span style="color: #008080;">231</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_DOWN:<br></span><span style="color: #008080;">232</span>                 isTouched = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">233</span>                 <span style="color: #0000ff;">this</span><span style="color: #000000;">.setLayoutParams(newLp);<br></span><span style="color: #008080;">234</span>                 endPoint.x = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) downX;<br></span><span style="color: #008080;">235</span>                 endPoint.y = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) downY;<br></span><span style="color: #008080;">236</span><br><span style="color: #008080;">237</span>                 changeViewHeight(<span style="color: #0000ff;">this</span><span style="color: #000000;">, ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT);<br></span><span style="color: #008080;">238</span> <span style="color: #000000;">                postInvalidate();<br></span><span style="color: #008080;">239</span><br><span style="color: #008080;">240</span>                 downX = event.getX() + location[0<span style="color: #000000;">];<br></span><span style="color: #008080;">241</span>                 downY = event.getY() + location[1<span style="color: #000000;">];<br></span><span style="color: #008080;">242</span> <span style="color: #008000;">//</span><span style="color: #008000;">                Logger.d(TAG, String.format(“downX: %f, downY: %f”, downX, downY));</span><br><span style="color: #008080;">243</span><br><span style="color: #008080;">244</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">245</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_MOVE:<br></span><span style="color: #008080;">246</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 计算直角边和斜边（用于计算绘制两圆之间的填充去）</span><br><span style="color: #008080;">247</span>                 triangle.deltaX = event.getX() -<span style="color: #000000;"> downX;<br></span><span style="color: #008080;">248</span>                 triangle.deltaY = -1 <em> (event.getY() - downY); <span style="color: #008000;">//</span><span style="color: #008000;"> y轴方向相反，所有需要取反</span><br><span style="color: #008080;">249</span>                 <span style="color: #0000ff;">double</span> distance = Math.sqrt(triangle.deltaX </em> triangle.deltaX + triangle.deltaY <em><span style="color: #000000;"> triangle.deltaY);<br></span><span style="color: #008080;">250</span>                 triangle.hypotenuse =<span style="color: #000000;"> distance;<br></span><span style="color: #008080;">251</span> <span style="color: #008000;">//</span><span style="color: #008000;">                Logger.d(TAG, “triangle: “ + triangle);</span><br><span style="color: #008080;">252</span>                 refreshCurRadiusByMoveDistance((<span style="color: #0000ff;">int</span><span style="color: #000000;">) distance);<br></span><span style="color: #008080;">253</span><br><span style="color: #008080;">254</span>                 endPoint.x = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) event.getX();<br></span><span style="color: #008080;">255</span>                 endPoint.y = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) event.getY();<br></span><span style="color: #008080;">256</span><br><span style="color: #008080;">257</span> <span style="color: #000000;">                postInvalidate();<br></span><span style="color: #008080;">258</span><br><span style="color: #008080;">259</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">260</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_UP:<br></span><span style="color: #008080;">261</span>                 isTouched = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">262</span>                 <span style="color: #0000ff;">this</span><span style="color: #000000;">.setLayoutParams(originLp);<br></span><span style="color: #008080;">263</span><br><span style="color: #008080;">264</span>                 <span style="color: #0000ff;">if</span> (isArrivedMaxMoved) { <span style="color: #008000;">//</span><span style="color: #008000;"> 触发事件</span><br><span style="color: #008080;">265</span>                     changeViewHeight(<span style="color: #0000ff;">this</span><span style="color: #000000;">, originWidth, originHeight);<br></span><span style="color: #008080;">266</span> <span style="color: #000000;">                    postInvalidate();<br></span><span style="color: #008080;">267</span>                     <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> onDraggableFlagViewListener) {<br></span><span style="color: #008080;">268</span>                         onDraggableFlagViewListener.onFlagDismiss(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">269</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">270</span>                     Logger.d(TAG, “触发事件…”<span style="color: #000000;">);<br></span><span style="color: #008080;">271</span> <span style="color: #000000;">                    resetAfterDismiss();<br></span><span style="color: #008080;">272</span>                 } <span style="color: #0000ff;">else</span> { <span style="color: #008000;">//</span><span style="color: #008000;"> 还原</span><br><span style="color: #008080;">273</span>                     changeViewHeight(<span style="color: #0000ff;">this</span><span style="color: #000000;">, originWidth, originHeight);<br></span><span style="color: #008080;">274</span>                     startRollBackAnimation(500<span style="color: #008000;">/</span></em><span style="color: #008000;">ms</span><span style="color: #008000;">*/</span><span style="color: #000000;">);<br></span><span style="color: #008080;">275</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">276</span><br><span style="color: #008080;">277</span>                 downX =<span style="color: #000000;"> Float.MAX_VALUE;<br></span><span style="color: #008080;">278</span>                 downY =<span style="color: #000000;"> Float.MAX_VALUE;<br></span><span style="color: #008080;">279</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">280</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">281</span><br><span style="color: #008080;">282</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">283</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">284</span><br><span style="color: #008080;">285</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">286</span> <span style="color: #008000;">     <em> 触发事件之后重置<br></em></span><span style="color: #008080;">287</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">288</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> resetAfterDismiss() {<br></span><span style="color: #008080;">289</span>         <span style="color: #0000ff;">this</span><span style="color: #000000;">.setVisibility(GONE);<br></span><span style="color: #008080;">290</span>         text = “”<span style="color: #000000;">;<br></span><span style="color: #008080;">291</span>         isArrivedMaxMoved = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">292</span>         curRadius =<span style="color: #000000;"> originRadius;<br></span><span style="color: #008080;">293</span> <span style="color: #000000;">        postInvalidate();<br></span><span style="color: #008080;">294</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">295</span><br><span style="color: #008080;">296</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">297</span> <span style="color: #008000;">     <em> 根据移动的距离来刷新原来的圆半径大小<br></em></span><span style="color: #008080;">298</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">299</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> distance<br></span><span style="color: #008080;">300</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">301</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> refreshCurRadiusByMoveDistance(<span style="color: #0000ff;">int</span><span style="color: #000000;"> distance) {<br></span><span style="color: #008080;">302</span>         <span style="color: #0000ff;">if</span> (distance &gt;<span style="color: #000000;"> maxMoveLength) {<br></span><span style="color: #008080;">303</span>             isArrivedMaxMoved = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">304</span>             curRadius = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">305</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">306</span>             isArrivedMaxMoved = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">307</span>             <span style="color: #0000ff;">float</span> calcRadius = (1 - 1f <em> distance / maxMoveLength) </em><span style="color: #000000;"> originRadius;<br></span><span style="color: #008080;">308</span>             <span style="color: #0000ff;">float</span> maxRadius = ABTextUtil.dip2px(context, 2<span style="color: #000000;">);<br></span><span style="color: #008080;">309</span>             curRadius = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) Math.max(calcRadius, maxRadius);<br></span><span style="color: #008080;">310</span> <span style="color: #008000;">//</span><span style="color: #008000;">            Logger.d(TAG, “[refreshCurRadiusByMoveDistance]curRadius: “ + curRadius + “, calcRadius: “ + calcRadius + “, maxRadius: “ + maxRadius);</span><br><span style="color: #008080;">311</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">312</span><br><span style="color: #008080;">313</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">314</span><br><span style="color: #008080;">315</span><br><span style="color: #008080;">316</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">317</span> <span style="color: #008000;">     <em> 改变某控件的高度<br></em></span><span style="color: #008080;">318</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">319</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> view<br></span><span style="color: #008080;">320</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> height<br></span><span style="color: #008080;">321</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">322</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> changeViewHeight(View view, <span style="color: #0000ff;">int</span> width, <span style="color: #0000ff;">int</span><span style="color: #000000;"> height) {<br></span><span style="color: #008080;">323</span>         ViewGroup.LayoutParams lp =<span style="color: #000000;"> view.getLayoutParams();<br></span><span style="color: #008080;">324</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> lp) {<br></span><span style="color: #008080;">325</span>             lp =<span style="color: #000000;"> originLp;<br></span><span style="color: #008080;">326</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">327</span>         lp.width =<span style="color: #000000;"> width;<br></span><span style="color: #008080;">328</span>         lp.height =<span style="color: #000000;"> height;<br></span><span style="color: #008080;">329</span> <span style="color: #000000;">        view.setLayoutParams(lp);<br></span><span style="color: #008080;">330</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">331</span><br><span style="color: #008080;">332</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">333</span> <span style="color: #008000;">      回滚状态动画<br></span><span style="color: #008080;">334</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">335</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> ValueAnimator rollBackAnim;<br></span><span style="color: #008080;">336</span><br><span style="color: #008080;">337</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> startRollBackAnimation(<span style="color: #0000ff;">long</span><span style="color: #000000;"> duration) {<br></span><span style="color: #008080;">338</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> rollBackAnim) {<br></span><span style="color: #008080;">339</span>             rollBackAnim =<span style="color: #000000;"> ValueAnimator.ofFloat(curRadius, originRadius);<br></span><span style="color: #008080;">340</span>             rollBackAnim.addUpdateListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> ValueAnimator.AnimatorUpdateListener() {<br></span><span style="color: #008080;">341</span> <span style="color: #000000;">                @Override<br></span><span style="color: #008080;">342</span>                 <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onAnimationUpdate(ValueAnimator animation) {<br></span><span style="color: #008080;">343</span>                     <span style="color: #0000ff;">float</span> value = (<span style="color: #0000ff;">float</span><span style="color: #000000;">) animation.getAnimatedValue();<br></span><span style="color: #008080;">344</span>                     curRadius = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) value;<br></span><span style="color: #008080;">345</span> <span style="color: #000000;">                    postInvalidate();<br></span><span style="color: #008080;">346</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">347</span> <span style="color: #000000;">            });<br></span><span style="color: #008080;">348</span>             rollBackAnim.setInterpolator(<span style="color: #0000ff;">new</span> BounceInterpolator()); <span style="color: #008000;">//</span><span style="color: #008000;"> 反弹效果</span><br><span style="color: #008080;">349</span>             rollBackAnim.addListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> AnimatorListenerAdapter() {<br></span><span style="color: #008080;">350</span> <span style="color: #000000;">                @Override<br></span><span style="color: #008080;">351</span>                 <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onAnimationEnd(Animator animation) {<br></span><span style="color: #008080;">352</span>                     <span style="color: #0000ff;">super</span><span style="color: #000000;">.onAnimationEnd(animation);<br></span><span style="color: #008080;">353</span>                     DraggableFlagView.<span style="color: #0000ff;">this</span><span style="color: #000000;">.clearAnimation();<br></span><span style="color: #008080;">354</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">355</span> <span style="color: #000000;">            });<br></span><span style="color: #008080;">356</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">357</span> <span style="color: #000000;">        rollBackAnim.setDuration(duration);<br></span><span style="color: #008080;">358</span> <span style="color: #000000;">        rollBackAnim.start();<br></span><span style="color: #008080;">359</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">360</span><br><span style="color: #008080;">361</span><br><span style="color: #008080;">362</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">363</span> <span style="color: #008000;">      计算四个坐标的三角边关系<br></span><span style="color: #008080;">364</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">365</span>     <span style="color: #0000ff;">class</span><span style="color: #000000;"> Triangle {<br></span><span style="color: #008080;">366</span>         <span style="color: #0000ff;">double</span><span style="color: #000000;"> deltaX;<br></span><span style="color: #008080;">367</span>         <span style="color: #0000ff;">double</span><span style="color: #000000;"> deltaY;<br></span><span style="color: #008080;">368</span>         <span style="color: #0000ff;">double</span><span style="color: #000000;"> hypotenuse;<br></span><span style="color: #008080;">369</span><br><span style="color: #008080;">370</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">371</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> String toString() {<br></span><span style="color: #008080;">372</span>             <span style="color: #0000ff;">return</span> “Triangle{“ +<br><span style="color: #008080;">373</span>                     “deltaX=” + deltaX +<br><span style="color: #008080;">374</span>                     “, deltaY=” + deltaY +<br><span style="color: #008080;">375</span>                     “, hypotenuse=” + hypotenuse +<br><span style="color: #008080;">376</span>                     ‘}’<span style="color: #000000;">;<br></span><span style="color: #008080;">377</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">378</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">379</span><br><span style="color: #008080;">380</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String getText() {<br></span><span style="color: #008080;">381</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> text;<br></span><span style="color: #008080;">382</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">383</span><br><span style="color: #008080;">384</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setText(String text) {<br></span><span style="color: #008080;">385</span>         <span style="color: #0000ff;">this</span>.text =<span style="color: #000000;"> text;<br></span><span style="color: #008080;">386</span> <span style="color: #000000;">        postInvalidate();<br></span><span style="color: #008080;">387</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">388</span> }</pre><br></div>

<p>&nbsp;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2014/12/18/Android-下拉刷新控件RefreshableView的实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/12/18/Android-下拉刷新控件RefreshableView的实现/" itemprop="url">[Android]下拉刷新控件RefreshableView的实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-12-18T19:35:00+08:00">
                2014-12-18
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/12/18/Android-下拉刷新控件RefreshableView的实现/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/12/18/Android-下拉刷新控件RefreshableView的实现/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><span style="color: #ff0000;"><strong>以下内容为原创，欢迎转载，转载请注明</strong></span></p>
<p><span style="color: #ff0000;"><strong>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/4172483.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4172483.html</a></strong></span></p>
<p>&nbsp;</p>
<p>需求：自定义一个ViewGroup，实现可以下拉刷新的功能。下拉一定距离后（下拉时显示的界面可以自定义任何复杂的界面）释放手指可以回调刷新的功能，用户处理完刷新的内容后，可以调用方法onCompleteRefresh()通知刷新完毕，然后回归正常状态。效果如下：</p>
<p><img src="https://raw.githubusercontent.com/wangjiegulu/RefreshableView/master/screenshot/refreshableview.gif" alt="">&nbsp;&nbsp;&nbsp;<img src="https://raw.githubusercontent.com/wangjiegulu/RefreshableView/master/screenshot/refreshablelistview.gif" alt=""></p>
<p>&nbsp;</p>
<p><strong>源代码：<span style="color: #ff0000;"><a href="https://github.com/wangjiegulu/RefreshableView" target="_blank" rel="noopener"><span style="color: #ff0000;">RefreshableView</span></a></span>（<span style="color: #ff0000;"><a href="https://github.com/wangjiegulu/RefreshableView" target="_blank" rel="noopener"><span style="color: #ff0000;">https://github.com/wangjiegulu/RefreshableView</span></a></span>）</strong></p>
<p><span style="font-size: 18px;"><strong>分析：</strong></span></p>
<p>我们的目的是不管什么控件，只要在xml中外面包一层标签，那这个标签下面的所有子标签所在的控件都被支持可以下拉刷新了。所以，我们可以使用ViewGroup来实现，这里我选择的是继承LinearLayout，当然其他的（FrameLayout等）也一样了。</p>
<p>因为根据手指下滑，需要有一个刷新的view被显示出来，所以这里需要添加一个子view（称为refreshHeaderView），并放置在最顶部，使用LinearLayout的好处是可以设置为VERTICAL，这样可以直接&ldquo;this.addView(refreshHeaderView, 0);&rdquo;搞定了。然后就要根据手指滑动的距离，动态地去改变refreshHeaderView的高度。同时检测是否到达了可以刷新的高度了，如果达到了，更新当前的刷新状态。手指放开时，根据之前移动的刷新状态，执行刷新或者回归正常状态。</p>
<p>RefreshableView代码如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">  2</span> <span style="color: #008000;"> <em> 下拉刷新控件<br></em></span><span style="color: #008080;">  3</span> <span style="color: #008000;">  Author: wangjie<br></span><span style="color: #008080;">  4</span> <span style="color: #008000;"> <em> Email: tiantian.china.2@gmail.com<br></em></span><span style="color: #008080;">  5</span> <span style="color: #008000;">  Date: 12/13/14.<br></span><span style="color: #008080;">  6</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;">  7</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> RefreshableView <span style="color: #0000ff;">extends</span><span style="color: #000000;"> LinearLayout {<br></span><span style="color: #008080;">  8</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = RefreshableView.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;">  9</span><br><span style="color: #008080;"> 10</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> RefreshableView(Context context) {<br></span><span style="color: #008080;"> 11</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;"> 12</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 13</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 14</span><br><span style="color: #008080;"> 15</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> RefreshableView(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;"> 16</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;"> 17</span><br><span style="color: #008080;"> 18</span>         TypedArray a =<span style="color: #000000;"> context.obtainStyledAttributes(attrs, R.styleable.refreshableView);<br></span><span style="color: #008080;"> 19</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0, len = a.length(); i &lt; len; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;"> 20</span>             <span style="color: #0000ff;">int</span> attrIndex =<span style="color: #000000;"> a.getIndex(i);<br></span><span style="color: #008080;"> 21</span>             <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (attrIndex) {<br></span><span style="color: #008080;"> 22</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> R.styleable.refreshableView_interceptAllMoveEvents:<br></span><span style="color: #008080;"> 23</span>                     interceptAllMoveEvents = a.getBoolean(i, <span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 24</span>                     <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 25</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 26</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 27</span> <span style="color: #000000;">        a.recycle();<br></span><span style="color: #008080;"> 28</span><br><span style="color: #008080;"> 29</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 30</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 31</span><br><span style="color: #008080;"> 32</span>     <span style="color: #0000ff;">public</span> RefreshableView(Context context, AttributeSet attrs, <span style="color: #0000ff;">int</span><span style="color: #000000;"> defStyle) {<br></span><span style="color: #008080;"> 33</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs, defStyle);<br></span><span style="color: #008080;"> 34</span> <span style="color: #000000;">        init(context);<br></span><span style="color: #008080;"> 35</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 36</span><br><span style="color: #008080;"> 37</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 38</span> <span style="color: #008000;">     <em> 刷新状态<br></em></span><span style="color: #008080;"> 39</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 40</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> STATE_REFRESH_NORMAL = 0x21<span style="color: #000000;">;<br></span><span style="color: #008080;"> 41</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> STATE_REFRESH_NOT_ARRIVED = 0x22<span style="color: #000000;">;<br></span><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> STATE_REFRESH_ARRIVED = 0x23<span style="color: #000000;">;<br></span><span style="color: #008080;"> 43</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> STATE_REFRESHING = 0x24<span style="color: #000000;">;<br></span><span style="color: #008080;"> 44</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshState;<br></span><span style="color: #008080;"> 45</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 刷新状态监听</span><br><span style="color: #008080;"> 46</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> RefreshableHelper refreshableHelper;<br></span><span style="color: #008080;"> 47</span><br><span style="color: #008080;"> 48</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setRefreshableHelper(RefreshableHelper refreshableHelper) {<br></span><span style="color: #008080;"> 49</span>         <span style="color: #0000ff;">this</span>.refreshableHelper =<span style="color: #000000;"> refreshableHelper;<br></span><span style="color: #008080;"> 50</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 51</span><br><span style="color: #008080;"> 52</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br></span><span style="color: #008080;"> 53</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 54</span> <span style="color: #008000;">     <em> 刷新的view<br></em></span><span style="color: #008080;"> 55</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 56</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> View refreshHeaderView;<br></span><span style="color: #008080;"> 57</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 58</span> <span style="color: #008000;">     <em> 刷新的view的真实高度<br></em></span><span style="color: #008080;"> 59</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 60</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> originRefreshHeight;<br></span><span style="color: #008080;"> 61</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 62</span> <span style="color: #008000;">     <em> 有效下拉刷新需要达到的高度<br></em></span><span style="color: #008080;"> 63</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 64</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshArrivedStateHeight;<br></span><span style="color: #008080;"> 65</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 66</span> <span style="color: #008000;">     <em> 刷新时显示的高度<br></em></span><span style="color: #008080;"> 67</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 68</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshingHeight;<br></span><span style="color: #008080;"> 69</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 70</span> <span style="color: #008000;">     <em> 正常未刷新高度<br></em></span><span style="color: #008080;"> 71</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 72</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshNormalHeight;<br></span><span style="color: #008080;"> 73</span><br><span style="color: #008080;"> 74</span><br><span style="color: #008080;"> 75</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 76</span> <span style="color: #008000;">     <em> 默认不允许拦截（即，往子view传递事件），该属性只有在interceptAllMoveEvents为false的时候才有效<br></em></span><span style="color: #008080;"> 77</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 78</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> disallowIntercept = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 79</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 80</span> <span style="color: #008000;">     <em> xml中可设置它的值为false，表示不把移动的事件传递给子控件<br></em></span><span style="color: #008080;"> 81</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 82</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> interceptAllMoveEvents;<br></span><span style="color: #008080;"> 83</span><br><span style="color: #008080;"> 84</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> init(Context context) {<br></span><span style="color: #008080;"> 85</span>         <span style="color: #0000ff;">this</span>.context =<span style="color: #000000;"> context;<br></span><span style="color: #008080;"> 86</span>         <span style="color: #0000ff;">this</span><span style="color: #000000;">.setOrientation(VERTICAL);<br></span><span style="color: #008080;"> 87</span><br><span style="color: #008080;"> 88</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Log.d(TAG, “[init]originRefreshHeight: “ + refreshHeaderView.getMeasuredHeight());</span><br><span style="color: #008080;"> 89</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 90</span><br><span style="color: #008080;"> 91</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 92</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> onSizeChanged(<span style="color: #0000ff;">int</span> w, <span style="color: #0000ff;">int</span> h, <span style="color: #0000ff;">int</span> oldw, <span style="color: #0000ff;">int</span><span style="color: #000000;"> oldh) {<br></span><span style="color: #008080;"> 93</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onSizeChanged(w, h, oldw, oldh);<br></span><span style="color: #008080;"> 94</span><br><span style="color: #008080;"> 95</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> refreshableHelper) {<br></span><span style="color: #008080;"> 96</span>             refreshHeaderView =<span style="color: #000000;"> refreshableHelper.onInitRefreshHeaderView();<br></span><span style="color: #008080;"> 97</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 98</span> <span style="color: #008000;">//</span><span style="color: #008000;">        refreshHeaderView = LayoutInflater.from(context).inflate(R.layout.refresh_head, null);</span><br><span style="color: #008080;"> 99</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> refreshHeaderView) {<br></span><span style="color: #008080;">100</span>             Log.e(TAG, “refreshHeaderView is null!”<span style="color: #000000;">);<br></span><span style="color: #008080;">101</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">102</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">103</span>         <span style="color: #0000ff;">this</span><span style="color: #000000;">.removeView(refreshHeaderView);<br></span><span style="color: #008080;">104</span>         <span style="color: #0000ff;">this</span>.addView(refreshHeaderView, 0<span style="color: #000000;">);<br></span><span style="color: #008080;">105</span><br><span style="color: #008080;">106</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 计算refreshHeadView尺寸</span><br><span style="color: #008080;">107</span>         <span style="color: #0000ff;">int</span> width = View.MeasureSpec.makeMeasureSpec(0<span style="color: #000000;">, View.MeasureSpec.UNSPECIFIED);<br></span><span style="color: #008080;">108</span>         <span style="color: #0000ff;">int</span> expandSpec = View.MeasureSpec.makeMeasureSpec(Integer.MAX_VALUE &gt;&gt; 2<span style="color: #000000;">, View.MeasureSpec.AT_MOST);<br></span><span style="color: #008080;">109</span> <span style="color: #000000;">        refreshHeaderView.measure(width, expandSpec);<br></span><span style="color: #008080;">110</span><br><span style="color: #008080;">111</span>         Log.d(TAG, “[onSizeChanged]w: “ + w + “, h: “ +<span style="color: #000000;"> h);<br></span><span style="color: #008080;">112</span>         Log.d(TAG, “[onSizeChanged]oldw: “ + oldw + “, oldh: “ +<span style="color: #000000;"> oldh);<br></span><span style="color: #008080;">113</span>         Log.d(TAG, “[onSizeChanged]child counts: “ + <span style="color: #0000ff;">this</span><span style="color: #000000;">.getChildCount());<br></span><span style="color: #008080;">114</span>         originRefreshHeight =<span style="color: #000000;"> refreshHeaderView.getMeasuredHeight();<br></span><span style="color: #008080;">115</span><br><span style="color: #008080;">116</span>         <span style="color: #0000ff;">boolean</span> isUseDefault = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">117</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> refreshableHelper) {<br></span><span style="color: #008080;">118</span>             isUseDefault =<span style="color: #000000;"> refreshableHelper.onInitRefreshHeight(originRefreshHeight);<br></span><span style="color: #008080;">119</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">120</span><br><span style="color: #008080;">121</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 初始化各个高度</span><br><span style="color: #008080;">122</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isUseDefault) {<br></span><span style="color: #008080;">123</span>             refreshArrivedStateHeight =<span style="color: #000000;"> originRefreshHeight;<br></span><span style="color: #008080;">124</span>             refreshingHeight =<span style="color: #000000;"> originRefreshHeight;<br></span><span style="color: #008080;">125</span>             refreshNormalHeight = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">126</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">127</span>         Log.d(TAG, “[onSizeChanged]refreshHeaderView origin height: “ +<span style="color: #000000;"> originRefreshHeight);<br></span><span style="color: #008080;">128</span> <span style="color: #000000;">        changeViewHeight(refreshHeaderView, refreshNormalHeight);<br></span><span style="color: #008080;">129</span><br><span style="color: #008080;">130</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 初始化为正常状态</span><br><span style="color: #008080;">131</span> <span style="color: #000000;">        setRefreshState(STATE_REFRESH_NORMAL);<br></span><span style="color: #008080;">132</span><br><span style="color: #008080;">133</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">134</span><br><span style="color: #008080;">135</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">136</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> dispatchTouchEvent(MotionEvent ev) {<br></span><span style="color: #008080;">137</span>         Log.d(TAG, “[dispatchTouchEvent]ev action: “ +<span style="color: #000000;"> ev.getAction());<br></span><span style="color: #008080;">138</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">super</span><span style="color: #000000;">.dispatchTouchEvent(ev);<br></span><span style="color: #008080;">139</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">140</span><br><span style="color: #008080;">141</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">142</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onInterceptTouchEvent(MotionEvent ev) {<br></span><span style="color: #008080;">143</span>         Log.d(TAG, “[onInterceptTouchEvent]ev action: “ +<span style="color: #000000;"> ev.getAction());<br></span><span style="color: #008080;">144</span>         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">interceptAllMoveEvents) {<br></span><span style="color: #008080;">145</span>             <span style="color: #0000ff;">return</span> !<span style="color: #000000;">disallowIntercept;<br></span><span style="color: #008080;">146</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">147</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 如果设置了拦截所有move事件，即interceptAllMoveEvents为true</span><br><span style="color: #008080;">148</span>         <span style="color: #0000ff;">if</span> (MotionEvent.ACTION_MOVE ==<span style="color: #000000;"> ev.getAction()) {<br></span><span style="color: #008080;">149</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">150</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">151</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">152</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">153</span><br><span style="color: #008080;">154</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">155</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> requestDisallowInterceptTouchEvent(<span style="color: #0000ff;">boolean</span><span style="color: #000000;"> disallowIntercept) {<br></span><span style="color: #008080;">156</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.disallowIntercept ==<span style="color: #000000;"> disallowIntercept) {<br></span><span style="color: #008080;">157</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">158</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">159</span>         <span style="color: #0000ff;">this</span>.disallowIntercept =<span style="color: #000000;"> disallowIntercept;<br></span><span style="color: #008080;">160</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.requestDisallowInterceptTouchEvent(disallowIntercept);<br></span><span style="color: #008080;">161</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">162</span><br><span style="color: #008080;">163</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">float</span> downY =<span style="color: #000000;"> Float.MAX_VALUE;<br></span><span style="color: #008080;">164</span><br><span style="color: #008080;">165</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">166</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onTouchEvent(MotionEvent event) {<br></span><span style="color: #008080;">167</span> <span style="color: #008000;">//</span><span style="color: #008000;">        super.onTouchEvent(event);</span><br><span style="color: #008080;">168</span>         Log.d(TAG, “[onTouchEvent]ev action: “ +<span style="color: #000000;"> event.getAction());<br></span><span style="color: #008080;">169</span>         <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (event.getAction()) {<br></span><span style="color: #008080;">170</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_DOWN:<br></span><span style="color: #008080;">171</span>                 downY =<span style="color: #000000;"> event.getY();<br></span><span style="color: #008080;">172</span>                 Log.d(TAG, “Down –&gt; downY: “ +<span style="color: #000000;"> downY);<br></span><span style="color: #008080;">173</span>                 requestDisallowInterceptTouchEvent(<span style="color: #0000ff;">true</span>); <span style="color: #008000;">//</span><span style="color: #008000;"> 保证事件可往下传递</span><br><span style="color: #008080;">174</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">175</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_MOVE:<br></span><span style="color: #008080;">176</span><br><span style="color: #008080;">177</span>                 <span style="color: #0000ff;">float</span> curY =<span style="color: #000000;"> event.getY();<br></span><span style="color: #008080;">178</span>                 <span style="color: #0000ff;">float</span> deltaY = curY -<span style="color: #000000;"> downY;<br></span><span style="color: #008080;">179</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 是否是有效的往下拖动事件（则需要显示加载header）</span><br><span style="color: #008080;">180</span>                 <span style="color: #0000ff;">boolean</span> isDropDownValidate = Float.MAX_VALUE !=<span style="color: #000000;"> downY;<br></span><span style="color: #008080;">181</span>                 <span style="color: #008000;">/</span><br><span style="color: #008080;">182</span> <span style="color: #008000;">                 <em> 修改拦截设置<br></em></span><span style="color: #008080;">183</span> <span style="color: #008000;">                  如果是有效往下拖动事件，则事件需要在本ViewGroup中处理，所以需要拦截不往子控件传递，即不允许拦截设为false<br></span><span style="color: #008080;">184</span> <span style="color: #008000;">                 <em> 如果是有效往下拖动事件，则事件传递给子控件处理，所以不需要拦截，并往子控件传递，即不允许拦截设为true<br></em></span><span style="color: #008080;">185</span>                  <span style="color: #008000;">/</span><br><span style="color: #008080;">186</span>                 requestDisallowInterceptTouchEvent(!<span style="color: #000000;">isDropDownValidate);<br></span><span style="color: #008080;">187</span><br><span style="color: #008080;">188</span>                 downY =<span style="color: #000000;"> curY;<br></span><span style="color: #008080;">189</span>                 Log.d(TAG, “Move –&gt; deltaY(curY - downY): “ +<span style="color: #000000;"> deltaY);<br></span><span style="color: #008080;">190</span>                 <span style="color: #0000ff;">int</span> curHeight =<span style="color: #000000;"> refreshHeaderView.getMeasuredHeight();<br></span><span style="color: #008080;">191</span>                 <span style="color: #0000ff;">int</span> exceptHeight = curHeight + (<span style="color: #0000ff;">int</span>) (deltaY / 2<span style="color: #000000;">);<br></span><span style="color: #008080;">192</span><br><span style="color: #008080;">193</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 如果当前没有处在正在刷新状态，则更新刷新状态</span><br><span style="color: #008080;">194</span>                 <span style="color: #0000ff;">if</span> (STATE_REFRESHING !=<span style="color: #000000;"> refreshState) {<br></span><span style="color: #008080;">195</span>                     <span style="color: #0000ff;">if</span> (curHeight &gt;= refreshArrivedStateHeight) { <span style="color: #008000;">//</span><span style="color: #008000;"> 达到可刷新状态</span><br><span style="color: #008080;">196</span> <span style="color: #000000;">                        setRefreshState(STATE_REFRESH_ARRIVED);<br></span><span style="color: #008080;">197</span>                     } <span style="color: #0000ff;">else</span> { <span style="color: #008000;">//</span><span style="color: #008000;"> 未达到可刷新状态</span><br><span style="color: #008080;">198</span> <span style="color: #000000;">                        setRefreshState(STATE_REFRESH_NOT_ARRIVED);<br></span><span style="color: #008080;">199</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">200</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">201</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isDropDownValidate) {<br></span><span style="color: #008080;">202</span> <span style="color: #000000;">                    changeViewHeight(refreshHeaderView, Math.max(refreshNormalHeight, exceptHeight));<br></span><span style="color: #008080;">203</span>                 } <span style="color: #0000ff;">else</span> { <span style="color: #008000;">//</span><span style="color: #008000;"> 防止从子控件修改拦截后引发的downY为Float.MAX_VALUE的问题</span><br><span style="color: #008080;">204</span> <span style="color: #000000;">                    changeViewHeight(refreshHeaderView, Math.max(curHeight, exceptHeight));<br></span><span style="color: #008080;">205</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">206</span><br><span style="color: #008080;">207</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">208</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_UP:<br></span><span style="color: #008080;">209</span>                 downY =<span style="color: #000000;"> Float.MAX_VALUE;<br></span><span style="color: #008080;">210</span>                 Log.d(TAG, “Up –&gt; downY: “ +<span style="color: #000000;"> downY);<br></span><span style="color: #008080;">211</span>                 requestDisallowInterceptTouchEvent(<span style="color: #0000ff;">true</span>); <span style="color: #008000;">//</span><span style="color: #008000;"> 保证事件可往下传递<br></span><span style="color: #008080;">212</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 如果是达到刷新状态，则设置正在刷新状态的高度</span><br><span style="color: #008080;">213</span>                 <span style="color: #0000ff;">if</span> (STATE_REFRESH_ARRIVED == refreshState) { <span style="color: #008000;">//</span><span style="color: #008000;"> 达到了刷新的状态</span><br><span style="color: #008080;">214</span> <span style="color: #000000;">                    startHeightAnimation(refreshHeaderView, refreshHeaderView.getMeasuredHeight(), refreshingHeight);<br></span><span style="color: #008080;">215</span> <span style="color: #000000;">                    setRefreshState(STATE_REFRESHING);<br></span><span style="color: #008080;">216</span>                 } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (STATE_REFRESHING == refreshState) { <span style="color: #008000;">//</span><span style="color: #008000;"> 正在刷新的状态</span><br><span style="color: #008080;">217</span> <span style="color: #000000;">                    startHeightAnimation(refreshHeaderView, refreshHeaderView.getMeasuredHeight(), refreshingHeight);<br></span><span style="color: #008080;">218</span>                 } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">219</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 执行动画后回归正常状态</span><br><span style="color: #008080;">220</span> <span style="color: #000000;">                    startHeightAnimation(refreshHeaderView, refreshHeaderView.getMeasuredHeight(), refreshNormalHeight, normalAnimatorListener);<br></span><span style="color: #008080;">221</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">222</span><br><span style="color: #008080;">223</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">224</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_CANCEL:<br></span><span style="color: #008080;">225</span>                 Log.d(TAG, “cancel”<span style="color: #000000;">);<br></span><span style="color: #008080;">226</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">227</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">228</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">229</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">230</span><br><span style="color: #008080;">231</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">232</span> <span style="color: #008000;">     <em> 刷新完毕后调用此方法<br></em></span><span style="color: #008080;">233</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">234</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCompleteRefresh() {<br></span><span style="color: #008080;">235</span>         <span style="color: #0000ff;">if</span> (STATE_REFRESHING ==<span style="color: #000000;"> refreshState) {<br></span><span style="color: #008080;">236</span> <span style="color: #000000;">            setRefreshState(STATE_REFRESH_NORMAL);<br></span><span style="color: #008080;">237</span> <span style="color: #000000;">            startHeightAnimation(refreshHeaderView, refreshHeaderView.getMeasuredHeight(), refreshNormalHeight);<br></span><span style="color: #008080;">238</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">239</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">240</span><br><span style="color: #008080;">241</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">242</span> <span style="color: #008000;">     <em> 修改当前的刷新状态<br></em></span><span style="color: #008080;">243</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">244</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> expectRefreshState<br></span><span style="color: #008080;">245</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">246</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> setRefreshState(<span style="color: #0000ff;">int</span><span style="color: #000000;"> expectRefreshState) {<br></span><span style="color: #008080;">247</span>         <span style="color: #0000ff;">if</span> (expectRefreshState !=<span style="color: #000000;"> refreshState) {<br></span><span style="color: #008080;">248</span>             refreshState =<span style="color: #000000;"> expectRefreshState;<br></span><span style="color: #008080;">249</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> refreshableHelper) {<br></span><span style="color: #008080;">250</span> <span style="color: #000000;">                refreshableHelper.onRefreshStateChanged(refreshHeaderView, refreshState);<br></span><span style="color: #008080;">251</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">252</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">253</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">254</span><br><span style="color: #008080;">255</span><br><span style="color: #008080;">256</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">257</span> <span style="color: #008000;">     <em> 改变某控件的高度<br></em></span><span style="color: #008080;">258</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">259</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> view<br></span><span style="color: #008080;">260</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> height<br></span><span style="color: #008080;">261</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">262</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> changeViewHeight(View view, <span style="color: #0000ff;">int</span><span style="color: #000000;"> height) {<br></span><span style="color: #008080;">263</span>         Log.d(TAG, “[changeViewHeight]change Height: “ +<span style="color: #000000;"> height);<br></span><span style="color: #008080;">264</span>         ViewGroup.LayoutParams lp =<span style="color: #000000;"> view.getLayoutParams();<br></span><span style="color: #008080;">265</span>         lp.height =<span style="color: #000000;"> height;<br></span><span style="color: #008080;">266</span> <span style="color: #000000;">        view.setLayoutParams(lp);<br></span><span style="color: #008080;">267</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">268</span><br><span style="color: #008080;">269</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">270</span> <span style="color: #008000;">     <em> 改变某控件的高度动画<br></em></span><span style="color: #008080;">271</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">272</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> view<br></span><span style="color: #008080;">273</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> fromHeight<br></span><span style="color: #008080;">274</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> toHeight<br></span><span style="color: #008080;">275</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">276</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> startHeightAnimation(<span style="color: #0000ff;">final</span> View view, <span style="color: #0000ff;">int</span> fromHeight, <span style="color: #0000ff;">int</span><span style="color: #000000;"> toHeight) {<br></span><span style="color: #008080;">277</span>         startHeightAnimation(view, fromHeight, toHeight, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">278</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">279</span><br><span style="color: #008080;">280</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> startHeightAnimation(<span style="color: #0000ff;">final</span> View view, <span style="color: #0000ff;">int</span> fromHeight, <span style="color: #0000ff;">int</span><span style="color: #000000;"> toHeight, Animator.AnimatorListener animatorListener) {<br></span><span style="color: #008080;">281</span>         <span style="color: #0000ff;">if</span> (toHeight ==<span style="color: #000000;"> view.getMeasuredHeight()) {<br></span><span style="color: #008080;">282</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">283</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">284</span>         ValueAnimator heightAnimator =<span style="color: #000000;"> ValueAnimator.ofInt(fromHeight, toHeight);<br></span><span style="color: #008080;">285</span>         heightAnimator.addUpdateListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> ValueAnimator.AnimatorUpdateListener() {<br></span><span style="color: #008080;">286</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">287</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onAnimationUpdate(ValueAnimator valueAnimator) {<br></span><span style="color: #008080;">288</span>                 Integer value =<span style="color: #000000;"> (Integer) valueAnimator.getAnimatedValue();<br></span><span style="color: #008080;">289</span>                 <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> == value) <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">290</span> <span style="color: #000000;">                changeViewHeight(view, value);<br></span><span style="color: #008080;">291</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">292</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">293</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> animatorListener) {<br></span><span style="color: #008080;">294</span> <span style="color: #000000;">            heightAnimator.addListener(animatorListener);<br></span><span style="color: #008080;">295</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">296</span>         heightAnimator.setInterpolator(<span style="color: #0000ff;">new</span><span style="color: #000000;"> LinearInterpolator());<br></span><span style="color: #008080;">297</span>         heightAnimator.setDuration(300<span style="color: #008000;">/<em></em></span><span style="color: #008000;">ms</span><span style="color: #008000;">/</span><span style="color: #000000;">);<br></span><span style="color: #008080;">298</span> <span style="color: #000000;">        heightAnimator.start();<br></span><span style="color: #008080;">299</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">300</span><br><span style="color: #008080;">301</span>     AnimatorListenerAdapter normalAnimatorListener = <span style="color: #0000ff;">new</span><span style="color: #000000;"> AnimatorListenerAdapter() {<br></span><span style="color: #008080;">302</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">303</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onAnimationEnd(Animator animation) {<br></span><span style="color: #008080;">304</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">.onAnimationEnd(animation);<br></span><span style="color: #008080;">305</span>             setRefreshState(STATE_REFRESH_NORMAL); <span style="color: #008000;">//</span><span style="color: #008000;"> 回归正常状态</span><br><span style="color: #008080;">306</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">307</span> <span style="color: #000000;">    };<br></span><span style="color: #008080;">308</span><br><span style="color: #008080;">309</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setRefreshArrivedStateHeight(<span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshArrivedStateHeight) {<br></span><span style="color: #008080;">310</span>         <span style="color: #0000ff;">this</span>.refreshArrivedStateHeight =<span style="color: #000000;"> refreshArrivedStateHeight;<br></span><span style="color: #008080;">311</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">312</span><br><span style="color: #008080;">313</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setRefreshingHeight(<span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshingHeight) {<br></span><span style="color: #008080;">314</span>         <span style="color: #0000ff;">this</span>.refreshingHeight =<span style="color: #000000;"> refreshingHeight;<br></span><span style="color: #008080;">315</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">316</span><br><span style="color: #008080;">317</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setRefreshNormalHeight(<span style="color: #0000ff;">int</span><span style="color: #000000;"> refreshNormalHeight) {<br></span><span style="color: #008080;">318</span>         <span style="color: #0000ff;">this</span>.refreshNormalHeight =<span style="color: #000000;"> refreshNormalHeight;<br></span><span style="color: #008080;">319</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">320</span><br><span style="color: #008080;">321</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getOriginRefreshHeight() {<br></span><span style="color: #008080;">322</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> originRefreshHeight;<br></span><span style="color: #008080;">323</span>     }</pre><br></div>

<p>其中：</p>
<p>originRefreshHeight，表示头部刷新view的实际高度。</p>
<p>refreshArrivedStateHeight，表示下拉多少距离可以执行刷新了</p>
<p>refreshingHeight，表示刷新的时候显示的高度时多少</p>
<p>refreshNormalHeight，表示正常状态下refreshHeaderView显示的高度是多少</p>
<p>&nbsp;</p>
<p>主要的核心代码应该是在onTouchEvent方法中，</p>
<p>先简单分析里面的主要代码：在ACTION_DOWN的时候，纪录当前手指下落的y坐标，然后再ACTION_MOVE的时候，去计算滑动的距离，并且判断如果滑动的距离大于refreshArrivedStateHeight，更新处于已经达到可刷新的状态，反之就更新处于未达到可刷新的状态。然后再ACTION_UP中，如果已经达到了可刷新的状态，则更新当前状态为正在刷新状态，并且回调状态改变的方法。</p>
<p>&nbsp;</p>
<p>如果里面有ScrollView等可以滚动的控件的时候，应该怎么处理里面的事件呢？</p>
<p>就以<a href="https://github.com/wangjiegulu/RefreshableView" target="_blank" rel="noopener">https://github.com/wangjiegulu/RefreshableView</a>&nbsp;为例</p>
<p>xml布局如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">com.wangjie.refreshableview.RefreshableView<br></span><span style="color: #008080;"> 2</span>             <span style="color: #ff0000;">xmlns:rv</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/com.wangjie.refreshableview" target="_blank" rel="noopener">http://schemas.android.com/apk/res/com.wangjie.refreshableview</a>“</span><br><span style="color: #008080;"> 3</span> <span style="color: #ff0000;">            android:id</span><span style="color: #0000ff;">=”@+id/main_refresh_view”</span><br><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">            android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">            android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;"> 6</span> <span style="color: #ff0000;">            rv:interceptAllMoveEvents</span><span style="color: #0000ff;">=”false”</span><br><span style="color: #008080;"> 7</span>             <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">com.wangjie.refreshableview.NestScrollView </span><span style="color: #ff0000;">android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"> android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;"> 9</span> <span style="color: #ff0000;">                android:fillViewport</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;">10</span>                 <span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span>             <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextView<br></span><span style="color: #008080;">13</span>                     <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/main_tv”</span><br><span style="color: #008080;">14</span> <span style="color: #ff0000;">                    android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">15</span> <span style="color: #ff0000;">                    android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">16</span> <span style="color: #ff0000;">                    android:gravity</span><span style="color: #0000ff;">=”center”</span><br><span style="color: #008080;">17</span> <span style="color: #ff0000;">                    android:padding</span><span style="color: #0000ff;">=”20dp”</span><br><span style="color: #008080;">18</span> <span style="color: #ff0000;">                    android:textSize</span><span style="color: #0000ff;">=”18sp”</span><br><span style="color: #008080;">19</span> <span style="color: #ff0000;">                    android:text</span><span style="color: #0000ff;">=”Drop Down For Refresh\n\n\n\n\n\n\n\n\n\n\nDrop Down For Refresh\nDrop Down For Refresh\n\n\n\n\n\n\n\n\n\n\nDrop Down For Refresh\nDrop Down For Refresh\n\n\n\n\n\n\n\n\n\n\nDrop Down For Refresh\nDrop Down For Refresh\n\n\n\n\n\n\n\n\n\n\nDrop Down For Refresh”</span><br><span style="color: #008080;">20</span>                     <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span>         <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">com.wangjie.refreshableview.NestScrollView</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">23</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">com.wangjie.refreshableview.RefreshableView</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>如上，最外面是一个RefreshableView，然后里面是一个NestScrollView，NestScrollView里面是TextView，其中TextView中因为文字较多，所以使用NestScrollView来实现滚动（NestScrollView扩展自ScrollView，下面会讲到）。这个时候的逻辑应该是，当NestScrollView处于顶部的时候，手指向下滑动，这时这个touch事件应该交给RefreshableView处理；当手指向上滑动时，也就是ScrollView向下滚动，这时，需要把touch事件给RefreshableView来处理。</p>
<p>&nbsp;</p>
<p>下面分析里面的代码：</p>
<p>RefreshableView的interceptAllMoveEvents表示是否需要RefreshableView阻止所有MOVE的事件（也就是说由RefreshableView自己处理所有MOVE事件），如果自控件中没有ScrollView等需要处理MOVE事件的控件，则可以设置为true；如果有类似ScrollView等控件，则需要设置为false，这样的话，RefreshableView会把MOVE事件传递给子类，由子类去处理。显然，现在例子中的情况是需要把interceptAllMoveEvents设置为false。设置的方法可以看上面的xml文件，使用rv:interceptAllMoveEvents=”false”这个属性即可。</p>
<p>onInterceptTouchEvent()方法中，我们返回的是disallowIntercept，这个disallowIntercept是根据requestDisallowInterceptTouchEvent()方法的调用来动态变化的，这样可以做到切换touch事件的处理对象。</p>
<p>在手指落下的时候，先调用requestDisallowInterceptTouchEvent()方法，保证当前的事件可以正常往子控件传递，也就是现在的ScrollView。然后手指会开始移动，在ACTION_MOVE中，先计算出当前滑动的距离。</p>
<p>如果是有效往下拖动事件，则事件需要在RefreshableView中处理，所以需要拦截不往子控件传递，即不允许拦截设为false；如果不是有效往下拖动事件，则事件传递给子控件处理，所以不需要拦截，并往子控件传递，即不允许拦截设为true。</p>
<p>怎么去判断是否有效呢？根据downY，如果downY是原来的初始值Float.MAX_VALUE，说明，这个MOVE事件刚开始DOWN的时候是被子控件处理的，而不是RefreshableView处理的，说明对于RefreshableView来说，是一个无效的往下拖动事件；如果downY不是原来的初始值Float.MAX_VALUE，说明，这个MOVE事件在DOWN的时候就已经是RefreshableView处理的了，所以是有效的。</p>
<p>然后，计算refreshHeaderView的高度，根据滑动的差量对refreshHeaderView的高度进行变换。</p>
<p>如果当前的状态是正在刷新，那MOVE事件直接无效。</p>
<p>否则，再去判断当前的高度是不是达到了可刷新状态，或者没有达到可刷新状态，更新状态值。</p>
<p>在UP的时候，还是先保证事件往下传递。并重置downY。然后根据当前的状态，如果达到了刷新的状态，则开始刷新，并更新当前的额状态时正在刷新状态；如果没有达到刷新状态，则执行动画返回到正常状态；如果本来就是正在刷新状态，也执行动画回归到正在刷新的高度。</p>
<p>&nbsp;</p>
<p>然后分析下NestScrollView：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;"> <em> Author: wangjie<br></em></span><span style="color: #008080;"> 3</span> <span style="color: #008000;">  Email: tiantian.china.2@gmail.com<br></span><span style="color: #008080;"> 4</span> <span style="color: #008000;"> <em> Date: 12/13/14.<br></em></span><span style="color: #008080;"> 5</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> NestScrollView <span style="color: #0000ff;">extends</span><span style="color: #000000;"> ScrollView {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = NestScrollView.<span style="color: #0000ff;">class</span><span style="color: #000000;">.getSimpleName();<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> NestScrollView(Context context) {<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> NestScrollView(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;">14</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span> NestScrollView(Context context, AttributeSet attrs, <span style="color: #0000ff;">int</span><span style="color: #000000;"> defStyle) {<br></span><span style="color: #008080;">18</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs, defStyle);<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">22</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> dispatchTouchEvent(MotionEvent ev) {<br></span><span style="color: #008080;">23</span>         Log.d(TAG, “<strong><em>[dispatchTouchEvent]ev action: “ +<span style="color: #000000;"> ev.getAction());<br></span><span style="color: #008080;">24</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">super</span><span style="color: #000000;">.dispatchTouchEvent(ev);<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onInterceptTouchEvent(MotionEvent ev) {<br></span><span style="color: #008080;">29</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onInterceptTouchEvent(ev);<br></span><span style="color: #008080;">30</span>         Log.d(TAG, “</em></strong>[onInterceptTouchEvent]ev action: “ +<span style="color: #000000;"> ev.getAction());<br></span><span style="color: #008080;">31</span>         <span style="color: #0000ff;">if</span> (MotionEvent.ACTION_MOVE ==<span style="color: #000000;"> ev.getAction()) {<br></span><span style="color: #008080;">32</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">34</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">36</span><br><span style="color: #008080;">37</span>     <span style="color: #0000ff;">float</span><span style="color: #000000;"> lastDownY;<br></span><span style="color: #008080;">38</span><br><span style="color: #008080;">39</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">40</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onTouchEvent(MotionEvent event) {<br></span><span style="color: #008080;">41</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onTouchEvent(event);<br></span><span style="color: #008080;">42</span>         <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (event.getAction()) {<br></span><span style="color: #008080;">43</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_DOWN:<br></span><span style="color: #008080;">44</span>                 lastDownY =<span style="color: #000000;"> event.getY();<br></span><span style="color: #008080;">45</span>                 parentRequestDisallowInterceptTouchEvent(<span style="color: #0000ff;">true</span>); <span style="color: #008000;">//</span><span style="color: #008000;"> 保证事件可往下传递</span><br><span style="color: #008080;">46</span>                 Log.d(TAG, “<strong>_Down”<span style="color: #000000;">);<br></span><span style="color: #008080;">47</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">48</span> <span style="color: #008000;">//</span><span style="color: #008000;">                break;</span><br><span style="color: #008080;">49</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION<em>MOVE:<br></em></span><span style="color: #008080;">50</span>                 Log.d(TAG, “</strong>move, this.getScrollY(): “ + <span style="color: #0000ff;">this</span><span style="color: #000000;">.getScrollY());<br></span><span style="color: #008080;">51</span>                 <span style="color: #0000ff;">boolean</span> isTop = event.getY() - lastDownY &gt; 0 &amp;&amp; <span style="color: #0000ff;">this</span>.getScrollY() == 0<span style="color: #000000;">;<br></span><span style="color: #008080;">52</span>                 <span style="color: #0000ff;">if</span> (isTop) { <span style="color: #008000;">//</span><span style="color: #008000;"> 允许父控件拦截，即不允许父控件拦截设为false</span><br><span style="color: #008080;">53</span>                     parentRequestDisallowInterceptTouchEvent(<span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;">54</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">55</span>                 } <span style="color: #0000ff;">else</span> { <span style="color: #008000;">//</span><span style="color: #008000;"> 不允许父控件拦截，即不允许父控件拦截设为true</span><br><span style="color: #008080;">56</span>                     parentRequestDisallowInterceptTouchEvent(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">57</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">58</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">59</span> <span style="color: #008000;">//</span><span style="color: #008000;">                break;</span><br><span style="color: #008080;">60</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION_UP:<br></span><span style="color: #008080;">61</span>                 Log.d(TAG, “<strong>_up, this.getScrollY(): “ + <span style="color: #0000ff;">this</span><span style="color: #000000;">.getScrollY());<br></span><span style="color: #008080;">62</span>                 parentRequestDisallowInterceptTouchEvent(<span style="color: #0000ff;">true</span>); <span style="color: #008000;">//</span><span style="color: #008000;"> 保证事件可往下传递</span><br><span style="color: #008080;">63</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">64</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> MotionEvent.ACTION<em>CANCEL:<br></em></span><span style="color: #008080;">65</span>                 Log.d(TAG, “</strong>cancel”<span style="color: #000000;">);<br></span><span style="color: #008080;">66</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">67</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">68</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">70</span><br><span style="color: #008080;">71</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">72</span> <span style="color: #008000;">     <em> 是否允许父控件拦截事件<br></em></span><span style="color: #008080;">73</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> disallowIntercept<br></span><span style="color: #008080;">74</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">75</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> parentRequestDisallowInterceptTouchEvent(<span style="color: #0000ff;">boolean</span><span style="color: #000000;"> disallowIntercept) {<br></span><span style="color: #008080;">76</span>         ViewParent vp =<span style="color: #000000;"> getParent();<br></span><span style="color: #008080;">77</span>         <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> ==<span style="color: #000000;"> vp) {<br></span><span style="color: #008080;">78</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">79</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">80</span> <span style="color: #000000;">        vp.requestDisallowInterceptTouchEvent(disallowIntercept);<br></span><span style="color: #008080;">81</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">82</span><br><span style="color: #008080;">83</span> }</pre><br></div>

<p>如上所示，也需要重写onInterceptTouchEvent()方法，它需要把除了MOVE事件外的所有事件传递下去，这样最里面的TextView才有OnClick等事件。</p>
<p>在onTouchEvent方法中，在ACTION_DOWN的时候，先纪录down的y坐标，然后保证parent（即，RefreshableView）的事件可以传递过来，所以需要调用getParent().requestDisallowInterceptTouchEvent()方法。因为下拉刷新只能发生在ScrollView滚动条在顶部的时候，所以在MOVE中，如果当前状态在顶部，那就需要让父控件（RefreshableView）拦截，然后直接返回false，让当前的事件传递到RefreshableView中的onTouchEvent方法中处理。如果不是在top，那就屏蔽调用父控件（RefreshableView）的处理，直接自己处理。最后在UP的时候再确保事件可以传递到ScrollView这里来。</p>
<p>&nbsp;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2014/12/11/基于git的源代码管理模型——git-flow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/12/11/基于git的源代码管理模型——git-flow/" itemprop="url">基于git的源代码管理模型——git flow</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-12-11T23:24:00+08:00">
                2014-12-11
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2014/12/11/基于git的源代码管理模型——git-flow/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2014/12/11/基于git的源代码管理模型——git-flow/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>说明：</strong>&nbsp;本文以nvie的&ldquo;<a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="noopener">a successful git branching model</a>&rdquo;为蓝本，结合我个人理解写成。如有谬误，还请各位指出。多谢！</p>
<p><strong>Note:</strong>&nbsp;This article is highly based on nvie’s&nbsp;<a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="noopener">a successful git branching model</a>. Thanks nvie.</p>
<div class="post-text"><br><br># Git Flow 是什么<br><br>Git Flow是构建在Git之上的一个组织软件开发活动的模型，是在Git之上构建的一项软件开发最佳实践。Git Flow是一套使用Git进行源代码管理时的一套行为规范和简化部分Git操作的工具。<br><br>2010年5月，在一篇名为&ldquo;<a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="noopener">一种成功的Git分支模型</a>&rdquo;的博文中，@nvie介绍了一种在Git之上的软件开发模型。通过利用Git创建和管理分支的能力，为每个分支设定具有特定的含义名称，并将软件生命周期中的各类活动归并到不同的分支上。实现了软件开发过程不同操作的相互隔离。这种软件开发的活动模型被nwie称为&ldquo;Git Flow&rdquo;。<br><br>一般而言，软件开发模型有常见的瀑布模型、迭代开发模型、以及最近出现的敏捷开发模型等不同的模型。每种模型有各自应用场景。Git Flow重点解决的是由于源代码在开发过程中的各种冲突导致开发活动混乱的问题。因此，Git flow可以很好的于各种现有开发模型相结合使用。<br><br>在开始研究Git Flow的具体内容前，下面这张图可以看到模型的全貌（引自nvie的<a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="noopener">博文</a>)：<br><br>&nbsp;<br><br># Git Flow中的分支<br><br>Git Flow模型中定义了主分支和辅助分支两类分支。其中主分支用于组织与软件开发、部署相关的活动；辅助分支组织为了解决特定的问题而进行的各种开发活动。<br><br>## 主分支<br><br>主分支是所有开发活动的核心分支。所有的开发活动产生的输出物最终都会反映到主分支的代码中。主分支分为master分支和development分支。<br><br>&nbsp;<br><br>### master分支<br><br>master分支上存放的应该是随时可供在生产环境中部署的代码（Production Ready state）。当开发活动告一段落，产生了一份新的可供部署的代码时，master分支上的代码会被更新。同时，每一次更新，最好添加对应的版本号标签（TAG）。<br><br>### develop分支<br><br>develop分支是保存当前最新开发成果的分支。通常这个分支上的代码也是可进行每日夜间发布的代码（Nightly build）。因此这个分支有时也可以被称作&ldquo;integration branch&rdquo;。<br><br>当develop分支上的代码已实现了软件需求说明书中所有的功能，通过了所有的测试后，并且代码已经足够稳定时，就可以将所有的开发成果合并回master分支了。对于master分支上的新提交的代码建议都打上一个新的版本号标签（TAG），供后续代码跟踪使用。<br><br>因此，每次将develop分支上的代码合并回master分支时，我们都可以认为一个新的可供在生产环境中部署的版本就产生了。通常而言，&ldquo;仅在发布新的可供部署的代码时才更新master分支上的代码&rdquo;是推荐所有人都遵守的行为准则。基于此，理论上说，每当有代码提交到master分支时，我们可以使用Git Hook触发软件自动测试以及生产环境代码的自动更新工作。这些自动化操作将有利于减少新代码发布之后的一些事务性工作。<br><br>## 辅助分支<br><br>辅助分支是用于组织解决特定问题的各种软件开发活动的分支。辅助分支主要用于组织软件新功能的并行开发、简化新功能开发代码的跟踪、辅助完成版本发布工作以及对生产代码的缺陷进行紧急修复工作。这些分支与主分支不同，通常只会在有限的时间范围内存在。<br><br>辅助分支包括：<br><br><em>   用于开发新功能时所使用的feature分支；
</em>   用于辅助版本发布的release分支；<br><em>   用于修正生产代码中的缺陷的hotfix分支。<br><br>以上这些分支都有固定的使用目的和分支操作限制。从单纯技术的角度说，这些分支与Git其他分支并没有什么区别，但通过命名，我们定义了使用这些分支的方法。<br><br>### feature分支<br><br>使用规范：

</em>   可以从develop分支发起feature分支<br><em>   代码必须合并回develop分支
</em>   feature分支的命名可以使用除<code>master</code>，<code>develop</code>，<code>release-*</code>，<code>hotfix-*</code>之外的任何名称<br><br>feature分支（有时也可以被叫做&ldquo;topic分支&rdquo;）通常是在开发一项新的软件功能的时候使用，这个分支上的代码变更最终合并回develop分支或者干脆被抛弃掉（例如实验性且效果不好的代码变更）。<br><br>一般而言，feature分支代码可以保存在开发者自己的代码库中而不强制提交到主代码库里。<br><br>&nbsp;<br><br>### release分支<br><br>使用规范：<br><br><em>   可以从develop分支派生
</em>   必须合并回develop分支和master分支<br><em>   分支命名惯例：`release-</em><code>release分支是为发布新的产品版本而设计的。在这个分支上的代码允许做小的缺陷修正、准备发布版本所需的各项说明信息（版本号、发布时间、编译时间等等）。通过在release分支上进行这些工作可以让develop分支空闲出来以接受新的feature分支上的代码提交，进入新的软件开发迭代周期。

当develop分支上的代码已经包含了所有即将发布的版本中所计划包含的软件功能，并且已通过所有测试时，我们就可以考虑准备创建release分支了。而所有在当前即将发布的版本之外的业务需求一定要确保不能混到release分支之内（避免由此引入一些不可控的系统缺陷）。

成功的派生了release分支，并被赋予版本号之后，develop分支就可以为&amp;ldquo;下一个版本&amp;rdquo;服务了。所谓的&amp;ldquo;下一个版本&amp;rdquo;是在当前即将发布的版本之后发布的版本。版本号的命名可以依据项目定义的版本号命名规则进行。

### hotfix分支

使用规范：

*   可以从master分支派生
*   必须合并回master分支和develop分支
*   分支命名惯例：</code>hotfix-<em><code>除了是计划外创建的以外，hotfix分支与release分支十分相似：都可以产生一个新的可供在生产环境部署的软件版本。

当生产环境中的软件遇到了异常情况或者发现了严重到必须立即修复的软件缺陷的时候，就需要从master分支上指定的TAG版本派生hotfix分支来组织代码的紧急修复工作。

这样做的显而易见的好处是不会打断正在进行的develop分支的开发工作，能够让团队中负责新功能开发的人与负责代码紧急修复的人并行的开展工作。

&amp;nbsp;

# 更进一步

Git Flow开发模型从源代码管理角度对通常意义上的软件开发活动进行了约束。应该说，为我们的软件开发提供了一个可供参考的管理模型。Git Flow开发模型让nvie的开发代码仓库保持整洁，让小组各个成员之间的开发相互隔离，能够有效避免处于开发状态中的代码相互影响而导致的效率低下和混乱。

所谓模型，在不同的开发团队，不同的文化，不同的项目背景情况下都有可能需要进行适当的裁剪或扩充。祝各位好运！

PS：为了简化使用Git Flow模型时Git指令的复杂性，nvie开发出了一套[git增强指令集](https://github.com/nvie/gitflow)。可以运行于Windows、Linux、Unix和Mac操作系统之下。有兴趣的同学可以去看看。

# 附录

## 安装Git Flow

Git Flow的在不同的操作系统之下有一些轻微的不同。好在nvie给出了详细的指导。

### Windows

配合Cygwin使用。Cygwin之下的安装非常简单。执行如下指令即可：</code>wget -q -O - –no-check-certificate <a href="https://github.com/nvie/gitflow/raw/develop/contrib/gitflow-installer.sh" target="_blank" rel="noopener">https://github.com/nvie/gitflow/raw/develop/contrib/gitflow-installer.sh</a> | bash`<br><br>使用这条命令在大多数情况下都可以完成Git Flow的安装。但在少数情况下也会遇到异常：

</em>   执行 git flow init 命令后出现错误：”flags: FATAL unable to determine getopt version”<br><br>需要使用Cygwin的Util-linux安装包。重新使用cywgin的setup安装吧。<br><br><em>   如果出现类似”$’\r’: command not found”的错误，则可能是换行符出现了问题。可以使用sed命令来快速解决。<br><br>`$ sed -i ‘s/\n\r/\n/mg’ /usr/local/bin/git-flow</em><br>$ sed -i ‘s/\n\r/\n/mg’ /usr/local/bin/gitflow-*`<br><br>&nbsp;<br><br></div><br><div class="copyright-announce">来自：<a href="http://www.ituring.com.cn/article/56870" target="_blank" rel="noopener">http://www.ituring.com.cn/article/56870</a></div>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/my_avatar.jpg"
                alt="Wang Jie" />
            
              <p class="site-author-name" itemprop="name">Wang Jie</p>
              <p class="site-description motion-element" itemprop="description">Wang Jie's blog</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">144</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wangjiegulu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:tiantian.china.2@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/+%E5%A4%A9%E5%A4%A9wangjie" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/wangjiegulu" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/users/2124006/wangjie" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/wangjiegulu" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i></a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.cnblogs.com/tiantianbyconan/" title="cnblog" target="_blank">cnblog</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Jie</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>








        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://blog-wangjiegulu-com.disqus.com/count.js" async></script>
    

    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "default";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "GooglePlus,Evernote,Twitter,Facebook,Douban,Weibo";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  

  

  

</body>
</html>

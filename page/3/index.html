<!DOCTYPE html>




<html class="theme-next muse" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="WAND JIE" type="application/atom+xml" />






<meta name="description" content="Wang Jie&apos;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="WAND JIE">
<meta property="og:url" content="http://blog.wangjiegulu.com/page/3/index.html">
<meta property="og:site_name" content="WAND JIE">
<meta property="og:description" content="Wang Jie&apos;s blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WAND JIE">
<meta name="twitter:description" content="Wang Jie&apos;s blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.wangjiegulu.com/page/3/"/>





  <title>WAND JIE</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-111189680-2', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WAND JIE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">TO BE AN ARTIST-ENGINNER</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/06/29/Android-Android端ORM框架——RapidORM-v2-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/29/Android-Android端ORM框架——RapidORM-v2-0/" itemprop="url">[Android]Android端ORM框架——RapidORM(v2.0)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-29T14:28:00+08:00">
                2016-06-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/06/29/Android-Android端ORM框架——RapidORM-v2-0/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/06/29/Android-Android端ORM框架——RapidORM-v2-0/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br><br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5626716.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5626716.html</a>
</strong></font>

<h1 id="Android-Android端ORM框架——RapidORM-v2-0"><a href="#Android-Android端ORM框架——RapidORM-v2-0" class="headerlink" title="[Android]Android端ORM框架——RapidORM(v2.0)"></a>[Android]Android端ORM框架——RapidORM(<code>v2.0</code>)</h1><p><strong><a href="https://github.com/wangjiegulu/RapidORM" target="_blank" rel="noopener">RapidORM</a>：Android端轻量高性能的ORM框架</strong></p>
<p><strong>GitHub:</strong> <a href="https://github.com/wangjiegulu/RapidORM" target="_blank" rel="noopener">https://github.com/wangjiegulu/RapidORM</a></p>
<h2 id="1-RapidORM-v1-0"><a href="#1-RapidORM-v1-0" class="headerlink" title="1. RapidORM v1.0"></a>1. RapidORM <code>v1.0</code></h2><blockquote>
<p><code>v1.0</code>博客文档：<a href="http://www.cnblogs.com/tiantianbyconan/p/4748077.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4748077.html</a></p>
</blockquote>
<p><code>v1.0</code>版本支持使用反射和非反射（模版生成）两种方式实现执行SQL。</p>
<h3 id="1-1-v1-0缺点："><a href="#1-1-v1-0缺点：" class="headerlink" title="1.1. v1.0缺点："></a>1.1. <code>v1.0</code>缺点：</h3><p>1. 其中默认为反射实现，对性能有一定的影响。</p>
<p>2. 而如果要采用非反射实现，则需要使用RapidORM提供的模版工具类手动生成相关的帮助类，当数据表需要修改时，必须要手动手动生成帮助类，有潜在的风险。</p>
<p>3. 非反射时生成的文件是通过<code>getter/setter</code>方法调用的，但是<code>getter/setter</code>方法名可能会不一致，导致需要手动调整<code>setter/getter</code>方法名称。</p>
<h2 id="2-RapidORM-v2-0"><a href="#2-RapidORM-v2-0" class="headerlink" title="2. RapidORM v2.0"></a>2. RapidORM <code>v2.0</code></h2><p>相比较于<code>v1.0</code>版本，<code>v2.0</code>版本则更加侧重于非反射操作，所有默认都是非反射的。</p>
<p>通过在编译时期根据<code>@Table</code>、<code>@Column</code>等注解自动生成辅助类<code>Xxx_RORM.java</code>文件，<strong>RapidORM</strong>库会使用这些生成的辅助类来进行数据表的初始化、执行SQL等操作，如果数据表有结构有改动，则会自动重新生成或者<code>rebuild</code>来手动生成。</p>
<h3 id="2-1-v2-0-使用指南"><a href="#2-1-v2-0-使用指南" class="headerlink" title="2.1 v2.0 使用指南"></a>2.1 <code>v2.0</code> 使用指南</h3><blockquote>
<p>与<code>v1.0</code>相同部分省略。</p>
</blockquote>
<h4 id="2-1-1-同样，创建持久类Person"><a href="#2-1-1-同样，创建持久类Person" class="headerlink" title="2.1.1 同样，创建持久类Person"></a>2.1.1 同样，创建持久类<code>Person</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Author: wangjie</span></span><br><span class="line"><span class="comment"> * Email: tiantian.china.2@gmail.com</span></span><br><span class="line"><span class="comment"> * Date: 6/25/15.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(primaryKey = <span class="keyword">true</span>)</span><br><span class="line">    Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(primaryKey = <span class="keyword">true</span>, name = <span class="string">"type_id"</span>)</span><br><span class="line">    Integer typeId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    Long birth;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    Boolean student;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"is_succeed"</span>)</span><br><span class="line">    <span class="keyword">boolean</span> isSucceed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter/setter</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，v2.0版本不支持变量为<code>private</code>类型，这是为了避免使用<code>getter/setter</code>方法来进行数据绑定。如果变量为<code>private</code>类型，则编译会报错，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error:Execution failed <span class="keyword">for</span> task <span class="string">':example:compileDebugJavaWithJavac'</span>.</span><br><span class="line">&gt; java.lang.RuntimeException: id in com.wangjie.rapidorm.example.database.model.Person can not be <span class="keyword">private</span>!</span><br></pre></td></tr></table></figure>
<h4 id="2-1-2-Rebuild-Project"><a href="#2-1-2-Rebuild-Project" class="headerlink" title="2.1.2 Rebuild Project"></a>2.1.2 Rebuild Project</h4><blockquote>
<p>Android Studio -&gt; Build -&gt; Rebuild Project</p>
</blockquote>
<p>Build成功后，在主项目<code>build/generated/source/apt/</code>目录下会生成<code>Person_RORM</code>类, 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GENERATED CODE BY RapidORM. DO NOT MODIFY! "2016-06-29 14:08:504", Source table: "com.wangjie.rapidorm.example.database.model.Person"</span></span><br><span class="line"><span class="keyword">package</span> com.wangjie.rapidorm.example.database.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.database.Cursor;</span><br><span class="line"><span class="keyword">import</span> com.wangjie.rapidorm.core.config.ColumnConfig;</span><br><span class="line"><span class="keyword">import</span> com.wangjie.rapidorm.core.config.TableConfig;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person_RORM</span> <span class="keyword">extends</span> <span class="title">TableConfig</span>&lt;<span class="title">Person</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "id", field name: &#123;<span class="doctag">@link</span> Person#id&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ID = <span class="string">"id"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "type_id", field name: &#123;<span class="doctag">@link</span> Person#typeId&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_ID = <span class="string">"type_id"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "name", field name: &#123;<span class="doctag">@link</span> Person#name&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"name"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "age", field name: &#123;<span class="doctag">@link</span> Person#age&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AGE = <span class="string">"age"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "address", field name: &#123;<span class="doctag">@link</span> Person#address&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ADDRESS = <span class="string">"address"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "birth", field name: &#123;<span class="doctag">@link</span> Person#birth&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BIRTH = <span class="string">"birth"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "student", field name: &#123;<span class="doctag">@link</span> Person#student&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String STUDENT = <span class="string">"student"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Column name: "is_succeed", field name: &#123;<span class="doctag">@link</span> Person#isSucceed&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String IS_SUCCEED = <span class="string">"is_succeed"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Person_RORM</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(Person.class);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseAllConfigs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    tableName = <span class="string">"Person"</span>;</span><br><span class="line">    ColumnConfig idColumnConfig = buildColumnConfig(<span class="string">"id"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">true</span><span class="comment">/*primaryKey*/</span>, <span class="string">"INTEGER"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(idColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"id"</span><span class="comment">/*field name*/</span>, idColumnConfig);</span><br><span class="line">    pkColumnConfigs.add(idColumnConfig);</span><br><span class="line">    ColumnConfig typeIdColumnConfig = buildColumnConfig(<span class="string">"type_id"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">true</span><span class="comment">/*primaryKey*/</span>, <span class="string">"INTEGER"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(typeIdColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"typeId"</span><span class="comment">/*field name*/</span>, typeIdColumnConfig);</span><br><span class="line">    pkColumnConfigs.add(typeIdColumnConfig);</span><br><span class="line">    ColumnConfig nameColumnConfig = buildColumnConfig(<span class="string">"name"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">false</span><span class="comment">/*primaryKey*/</span>, <span class="string">"TEXT"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(nameColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"name"</span><span class="comment">/*field name*/</span>, nameColumnConfig);</span><br><span class="line">    noPkColumnConfigs.add(nameColumnConfig);</span><br><span class="line">    ColumnConfig ageColumnConfig = buildColumnConfig(<span class="string">"age"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">false</span><span class="comment">/*primaryKey*/</span>, <span class="string">"INTEGER"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(ageColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"age"</span><span class="comment">/*field name*/</span>, ageColumnConfig);</span><br><span class="line">    noPkColumnConfigs.add(ageColumnConfig);</span><br><span class="line">    ColumnConfig addressColumnConfig = buildColumnConfig(<span class="string">"address"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">false</span><span class="comment">/*primaryKey*/</span>, <span class="string">"TEXT"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(addressColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"address"</span><span class="comment">/*field name*/</span>, addressColumnConfig);</span><br><span class="line">    noPkColumnConfigs.add(addressColumnConfig);</span><br><span class="line">    ColumnConfig birthColumnConfig = buildColumnConfig(<span class="string">"birth"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">false</span><span class="comment">/*primaryKey*/</span>, <span class="string">"LONG"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(birthColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"birth"</span><span class="comment">/*field name*/</span>, birthColumnConfig);</span><br><span class="line">    noPkColumnConfigs.add(birthColumnConfig);</span><br><span class="line">    ColumnConfig studentColumnConfig = buildColumnConfig(<span class="string">"student"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">false</span><span class="comment">/*primaryKey*/</span>, <span class="string">"INTEGER"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(studentColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"student"</span><span class="comment">/*field name*/</span>, studentColumnConfig);</span><br><span class="line">    noPkColumnConfigs.add(studentColumnConfig);</span><br><span class="line">    ColumnConfig isSucceedColumnConfig = buildColumnConfig(<span class="string">"is_succeed"</span><span class="comment">/*column name*/</span>, <span class="keyword">false</span><span class="comment">/*autoincrement*/</span>, <span class="keyword">false</span><span class="comment">/*notNull*/</span>, <span class="string">""</span><span class="comment">/*defaultValue*/</span>, <span class="keyword">false</span><span class="comment">/*index*/</span>, <span class="keyword">false</span><span class="comment">/*unique*/</span>, <span class="keyword">false</span><span class="comment">/*uniqueCombo*/</span>, <span class="keyword">false</span><span class="comment">/*primaryKey*/</span>, <span class="string">"INTEGER"</span><span class="comment">/*dbType*/</span>);</span><br><span class="line">    allColumnConfigs.add(isSucceedColumnConfig);</span><br><span class="line">    allFieldColumnConfigMapper.put(<span class="string">"isSucceed"</span><span class="comment">/*field name*/</span>, isSucceedColumnConfig);</span><br><span class="line">    noPkColumnConfigs.add(isSucceedColumnConfig);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindInsertArgs</span><span class="params">(Person model, List&lt;Object&gt; insertArgs)</span> </span>&#123;</span><br><span class="line">    Integer id = model.id;</span><br><span class="line">    insertArgs.add(<span class="keyword">null</span> == id ? <span class="keyword">null</span> : id );</span><br><span class="line">    Integer typeId = model.typeId;</span><br><span class="line">    insertArgs.add(<span class="keyword">null</span> == typeId ? <span class="keyword">null</span> : typeId );</span><br><span class="line">    String name = model.name;</span><br><span class="line">    insertArgs.add(<span class="keyword">null</span> == name ? <span class="keyword">null</span> : name );</span><br><span class="line">    <span class="keyword">int</span> age = model.age;</span><br><span class="line">    insertArgs.add(age);</span><br><span class="line">    String address = model.address;</span><br><span class="line">    insertArgs.add(<span class="keyword">null</span> == address ? <span class="keyword">null</span> : address );</span><br><span class="line">    Long birth = model.birth;</span><br><span class="line">    insertArgs.add(<span class="keyword">null</span> == birth ? <span class="keyword">null</span> : birth );</span><br><span class="line">    Boolean student = model.student;</span><br><span class="line">    insertArgs.add(<span class="keyword">null</span> == student ? <span class="keyword">null</span> : student  ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">boolean</span> isSucceed = model.isSucceed;</span><br><span class="line">    insertArgs.add(isSucceed ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindUpdateArgs</span><span class="params">(Person model, List&lt;Object&gt; updateArgs)</span> </span>&#123;</span><br><span class="line">    String name = model.name;</span><br><span class="line">    updateArgs.add(<span class="keyword">null</span> == name ? <span class="keyword">null</span> : name);</span><br><span class="line">    <span class="keyword">int</span> age = model.age;</span><br><span class="line">    updateArgs.add(age);</span><br><span class="line">    String address = model.address;</span><br><span class="line">    updateArgs.add(<span class="keyword">null</span> == address ? <span class="keyword">null</span> : address);</span><br><span class="line">    Long birth = model.birth;</span><br><span class="line">    updateArgs.add(<span class="keyword">null</span> == birth ? <span class="keyword">null</span> : birth);</span><br><span class="line">    Boolean student = model.student;</span><br><span class="line">    updateArgs.add(<span class="keyword">null</span> == student ? <span class="keyword">null</span> : student ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">boolean</span> isSucceed = model.isSucceed;</span><br><span class="line">    updateArgs.add(isSucceed ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindPkArgs</span><span class="params">(Person model, List&lt;Object&gt; pkArgs)</span> </span>&#123;</span><br><span class="line">    Integer id = model.id;</span><br><span class="line">    pkArgs.add(<span class="keyword">null</span> == id ? <span class="keyword">null</span> : id);</span><br><span class="line">    Integer typeId = model.typeId;</span><br><span class="line">    pkArgs.add(<span class="keyword">null</span> == typeId ? <span class="keyword">null</span> : typeId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Person <span class="title">parseFromCursor</span><span class="params">(Cursor cursor)</span> </span>&#123;</span><br><span class="line">    Person model = <span class="keyword">new</span> Person();</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"id"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.id = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getInt(index));</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"type_id"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.typeId = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getInt(index));</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"name"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.name = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getString(index));</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"age"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.age = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getInt(index));</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"address"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.address = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getString(index));</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"birth"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.birth = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getLong(index));</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"student"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.student = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getInt(index) == <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    index = cursor.getColumnIndex(<span class="string">"is_succeed"</span>);</span><br><span class="line">    <span class="keyword">if</span>(-<span class="number">1</span> != index) &#123;</span><br><span class="line">      model.isSucceed = cursor.isNull(index) ? <span class="keyword">null</span> : (cursor.getInt(index) == <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> model;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-3-注册持久类"><a href="#2-1-3-注册持久类" class="headerlink" title="2.1.3 注册持久类"></a>2.1.3 注册持久类</h4><p>与<code>v1.0</code>一样，新建类DatabaseFactory，继承RapidORMConnection（可参考<a href="http://www.cnblogs.com/tiantianbyconan/p/4748077.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/4748077.html</a>）。</p>
<p>需要注意的是需要实现的并不是原来的<code>registerAllTableClass()</code>方法，而是<code>registerTableConfigMapper(HashMap&lt;Class, TableConfig&gt; tableConfigMapper)</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerTableConfigMapper</span><span class="params">(HashMap&lt;Class, TableConfig&gt; tableConfigMapper)</span> </span>&#123;</span><br><span class="line">    tableConfigMapper.put(Person.class, <span class="keyword">new</span> Person_RORM());</span><br><span class="line">    <span class="comment">// register all table config here...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>注意：注册<code>Person</code>时，需要连带生成的<code>Person_RORM</code>同时注册。</p>
<h4 id="2-1-4-构建Builder"><a href="#2-1-4-构建Builder" class="headerlink" title="2.1.4 构建Builder"></a>2.1.4 构建Builder</h4><p>构建Builder时与<code>v1.0</code>的方式一致，但是可以直接使用<code>Person_RORM</code>中的static变量来作为column name：</p>
<p><strong>PersonDaoImpl</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Person&gt; <span class="title">findPersonsByWhere</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> queryBuilder()</span><br><span class="line">            .addSelectColumn(Person_RORM.ID, Person_RORM.TYPE_ID, Person_RORM.NAME,</span><br><span class="line">                    Person_RORM.AGE, Person_RORM.BIRTH, Person_RORM.ADDRESS)</span><br><span class="line">            .setWhere(</span><br><span class="line">            	Where.and(</span><br><span class="line">	                Where.like(Person_RORM.NAME, <span class="string">"%wangjie%"</span>),</span><br><span class="line">	                Where.lt(Person_RORM.ID, <span class="number">200</span>),</span><br><span class="line">	                Where.or(</span><br><span class="line">	                        Where.between(Person_RORM.AGE, <span class="number">19</span>, <span class="number">39</span>),</span><br><span class="line">	                        Where.isNull(Person_RORM.ADDRESS)</span><br><span class="line">	                ),</span><br><span class="line">	                Where.eq(Person_RORM.TYPE_ID, <span class="number">1</span>)</span><br><span class="line">        		)</span><br><span class="line">            )</span><br><span class="line">            .addOrder(Person_RORM.ID, <span class="keyword">false</span>)</span><br><span class="line">            .addOrder(Person_RORM.NAME, <span class="keyword">true</span>)</span><br><span class="line">            .setLimit(<span class="number">10</span>)</span><br><span class="line">            .query(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-5-兼容SqlCipher"><a href="#2-1-5-兼容SqlCipher" class="headerlink" title="2.1.5 兼容SqlCipher"></a>2.1.5 兼容SqlCipher</h4><p>与<code>v1.0</code>一致.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/05/31/Android-Google-开源的-Android-排版库：FlexboxLayout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/31/Android-Google-开源的-Android-排版库：FlexboxLayout/" itemprop="url">[Android]Google 开源的 Android 排版库：FlexboxLayout</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-31T21:57:00+08:00">
                2016-05-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/05/31/Android-Google-开源的-Android-排版库：FlexboxLayout/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/05/31/Android-Google-开源的-Android-排版库：FlexboxLayout/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近Google开源了一个项目叫「FlexboxLayout」。</p>
<h2 id="1-什么是-Flexbox"><a href="#1-什么是-Flexbox" class="headerlink" title="1.什么是 Flexbox"></a>1.什么是 Flexbox</h2><p>简单来说 Flexbox 是属于web前端领域CSS的一种布局方案，是2009年W3C提出了一种新的布局方案，可以简便、完整、响应式地实现各种页面布局，并且 React Native 也是使用的 Flex 布局。</p>
<p>你可以简单的理解为 Flexbox 是CSS领域类似 Linearlayout 的一种布局，但是要比 Linearlayout 要强大的多。</p>
<h2 id="2-什么是-FlexboxLayout？"><a href="#2-什么是-FlexboxLayout？" class="headerlink" title="2.什么是 FlexboxLayout？"></a>2.什么是 FlexboxLayout？</h2><p>刚才说了 Flexbox 是CSS领域的比较强大的一个布局，我们在 Android 开发中使用 Linearlayout + RelativeLayout 基本可以实现大部分复杂的布局，但是Google就想了，有没有类似 Flexbox 的一个布局呢？这使用起来一个布局就可以搞定各种复杂的情况了，于是 FlexboxLayout 就应运而生了。</p>
<p>所以 FlexboxLayout 是针对 Android 平台的，实现类似 Flexbox 布局方案的一个开源项目，开源地址：<a href="https://github.com/google/flexbox-layout" target="_blank" rel="noopener">https://github.com/google/flexbox-layout</a></p>
<h2 id="3-使用方式"><a href="#3-使用方式" class="headerlink" title="3.使用方式"></a>3.使用方式</h2><p>使用方式很简单，只需要添加以下依赖：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">'com.google.android:flexbox:0.1.2'</span></span><br></pre></td></tr></table></figure>
<p>xml中这样使用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.google.android.flexbox.FlexboxLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:flexWrap</span>=<span class="string">"wrap"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:alignItems</span>=<span class="string">"stretch"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:alignContent</span>=<span class="string">"stretch"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/textview1"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"120dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"80dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_flexBasisPercent</span>=<span class="string">"50%"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/textview2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"80dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"80dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_alignSelf</span>=<span class="string">"center"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/textview3"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"160dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"80dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_alignSelf</span>=<span class="string">"flex_end"</span></span></span><br><span class="line"><span class="tag">        /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">com.google.android.flexbox.FlexboxLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>或者代码中这样使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FlexboxLayout flexboxLayout = (FlexboxLayout) findViewById(R.id.flexbox_layout);</span><br><span class="line">flexboxLayout.setFlexDirection(FlexboxLayout.FLEX_DIRECTION_COLUMN);</span><br><span class="line"></span><br><span class="line">View view = flexboxLayout.getChildAt(<span class="number">0</span>);</span><br><span class="line">FlexboxLayout.LayoutParams lp = (FlexboxLayout.LayoutParams) view.getLayoutParams();</span><br><span class="line">lp.order = -<span class="number">1</span>;</span><br><span class="line">lp.flexGrow = <span class="number">2</span>;</span><br><span class="line">view.setLayoutParams(lp);</span><br></pre></td></tr></table></figure>
<p>使用起来是不是很像Linearlayout的用法，只不过有很多属性你们比较陌生，这些属性都是Flexbox布局本身具备的，别着急，下面跟你们介绍下FlexboxLayout的一些具体属性的用法与意义。</p>
<h2 id="4-支持的属性"><a href="#4-支持的属性" class="headerlink" title="4.支持的属性"></a>4.支持的属性</h2><h3 id="flexDirection"><a href="#flexDirection" class="headerlink" title="flexDirection"></a>flexDirection</h3><p>flexDirection 属性决定主轴的方向（即项目的排列方向）。类似 LinearLayout 的 vertical 和 horizontal。</p>
<p>有四个值可以选择：</p>
<ul>
<li>row（默认值）：主轴为水平方向，起点在左端。</li>
<li>row-reverse：主轴为水平方向，起点在右端。</li>
<li>column：主轴为垂直方向，起点在上沿。</li>
<li>column-reverse：主轴为垂直方向，起点在下沿。</li>
</ul>
<h3 id="flexWrap"><a href="#flexWrap" class="headerlink" title="flexWrap"></a>flexWrap</h3><p>默认情况下 Flex 跟 LinearLayout 一样，都是不带换行排列的，但是flexWrap属性可以支持换行排列。有三个值：</p>
<p><img src="http://static.oschina.net/uploads/space/2016/0516/075805_YI0O_2652078.png" alt=""></p>
<ul>
<li>nowrap ：不换行</li>
<li>wrap：按正常方向换行</li>
<li>wrap-reverse：按反方向换行</li>
</ul>
<h3 id="justifyContent"><a href="#justifyContent" class="headerlink" title="justifyContent"></a>justifyContent</h3><p>justifyContent属性定义了项目在主轴上的对齐方式。</p>
<ul>
<li>flex-start（默认值）：左对齐</li>
<li>flex-end：右对齐</li>
<li>center： 居中</li>
<li>space-between：两端对齐，项目之间的间隔都相等。</li>
<li>space-around：每个项目两侧的间隔相等。所以，项目之间的间隔比项目与边框的间隔大一倍。</li>
</ul>
<h3 id="alignItems"><a href="#alignItems" class="headerlink" title="alignItems"></a>alignItems</h3><p>alignItems属性定义项目在副轴轴上如何对齐。</p>
<ul>
<li>flex-start：交叉轴的起点对齐。</li>
<li>flex-end：交叉轴的终点对齐。</li>
<li>center：交叉轴的中点对齐。</li>
<li>baseline: 项目的第一行文字的基线对齐。</li>
<li>stretch（默认值）：如果项目未设置高度或设为auto，将占满整个容器的高度。</li>
</ul>
<p><img src="http://static.oschina.net/uploads/space/2016/0516/075958_K7iO_2652078.png" alt=""></p>
<h3 id="alignContent"><a href="#alignContent" class="headerlink" title="alignContent"></a>alignContent</h3><p>alignContent属性定义了多根轴线的对齐方式。如果项目只有一根轴线，该属性不起作用。</p>
<ul>
<li>flex-start：与交叉轴的起点对齐。</li>
<li>flex-end：与交叉轴的终点对齐。</li>
<li>center：与交叉轴的中点对齐。</li>
<li>space-between：与交叉轴两端对齐，轴线之间的间隔平均分布。</li>
<li>space-around：每根轴线两侧的间隔都相等。所以，轴线之间的间隔比轴线与边框的间隔大一倍。</li>
<li>stretch（默认值）：轴线占满整个交叉轴。</li>
</ul>
<h2 id="5-子元素属性"><a href="#5-子元素属性" class="headerlink" title="5.子元素属性"></a>5.子元素属性</h2><p>除以上之外，FlexboxLayout还支持如下子元素属性：</p>
<h3 id="layout-order"><a href="#layout-order" class="headerlink" title="layout_order"></a>layout_order</h3><p>默认情况下子元素的排列方式按照文档流的顺序依次排序，而order属性可以控制排列的顺序，负值在前，正值灾后，按照从小到大的顺序依次排列。我们说之所以 FlexboxLayout 相对LinearLayout强就是因为一些属性比较给力，order就是其中之一。</p>
<p><img src="http://static.oschina.net/uploads/space/2016/0516/080144_woPx_2652078.png" alt=""></p>
<h3 id="layout-flexGrow"><a href="#layout-flexGrow" class="headerlink" title="layout_flexGrow"></a>layout_flexGrow</h3><p>layout_flexGrow 属性定义项目的放大比例，默认为0，即如果存在剩余空间，也不放大。一张图看懂。跟 LinearLayout 中的weight属性一样。</p>
<p><img src="http://static.oschina.net/uploads/space/2016/0516/080148_QD0P_2652078.png" alt=""></p>
<p>如果所有项目的 layout_flexGrow  属性都为1，则它们将等分剩余空间（如果有的话）。如果一个项目的 layout_flexGrow  属性为2，其他项目都为1，则前者占据的剩余空间将比其他项多一倍。</p>
<h3 id="layout-flexShrink"><a href="#layout-flexShrink" class="headerlink" title="layout_flexShrink"></a>layout_flexShrink</h3><p>layout_flexShrink  属性定义了项目的缩小比例，默认为1，即如果空间不足，该项目将缩小。</p>
<p>如果所有项目的 layout_flexShrink  属性都为1，当空间不足时，都将等比例缩小。如果一个项目的flex-shrink属性为0，其他项目都为1，则空间不足时，前者不缩小。</p>
<p>负值对该属性无效。</p>
<h3 id="layout-alignSelf"><a href="#layout-alignSelf" class="headerlink" title="layout_alignSelf"></a>layout_alignSelf</h3><p>layout_alignSelf  属性允许单个子元素有与其他子元素不一样的对齐方式，可覆盖 alignItems 属性。默认值为auto，表示继承父元素的 alignItems 属性，如果没有父元素，则等同于stretch。</p>
<ul>
<li>auto (default)</li>
<li>flex_start</li>
<li>flex_end</li>
<li>center</li>
<li>baseline</li>
<li>stretch</li>
</ul>
<blockquote>
<p>该属性可能取6个值，除了auto，其他都与align-items属性完全一致。</p>
</blockquote>
<h3 id="layout-flexBasisPercent"><a href="#layout-flexBasisPercent" class="headerlink" title="layout_flexBasisPercent"></a>layout_flexBasisPercent</h3><p>layout_flexBasisPercent 属性定义了在分配多余空间之前，子元素占据的main size主轴空间，浏览器根据这个属性，计算主轴是否有多余空间。它的默认值为auto，即子元素的本来大小。</p>
<h2 id="6-不同之处"><a href="#6-不同之处" class="headerlink" title="6.不同之处"></a>6.不同之处</h2><p>跟传统的CSS中的Flexbox布局有些不同的是：</p>
<p>1. 没有 flex-flow 属性</p>
<p>2. 没有 flex 属性</p>
<p>3. layout_flexBasisPercent 属性即为CSS中 flexbox 中的 flexBasis 属性</p>
<p>4. 不支持 min-width 和 min-height 两个属性</p>
<p>以上就是 FlexboxLayout 的一些基本介绍与基本用法，值得提醒大家的是，本身这个项目也是一个很好的自定义View的学习资料，值得大家学习借鉴！</p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p>本文的很多 Flexbox 方面的知识大量参考了我司同事的这篇文章，想要更多的了解 Flexbox 相关的知识建议阅读这里：</p>
<p><a href="http://w4lle.github.io/2016/05/08/Flexbox/" target="_blank" rel="noopener">http://w4lle.github.io/2016/05/08/Flexbox/</a></p>
<blockquote>
<p>出处：微信公众平台 <a href="http://mp.weixin.qq.com/s?__biz=MzA4NTQwNDcyMA==&amp;mid=2650661681&amp;idx=1&amp;sn=b151aba0c5fb702492f6bbd82211988d#rd" target="_blank" rel="noopener">AndroidDeveloper</a></p>
<p>相关链接<br>FlexboxLayout 的详细介绍：<a href="http://www.oschina.net/p/flexboxlayout" target="_blank" rel="noopener">请点这里</a></p>
<p>FlexboxLayout 的下载地址：<a href="http://www.oschina.net/action/project/go?id=42172&amp;p=download" target="_blank" rel="noopener">请点这里</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/04/22/Android-Android-MVP-依赖注入-单元测试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/22/Android-Android-MVP-依赖注入-单元测试/" itemprop="url">[Android]Android MVP&依赖注入&单元测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-04-22T18:44:00+08:00">
                2016-04-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/04/22/Android-Android-MVP-依赖注入-单元测试/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/04/22/Android-Android-MVP-依赖注入-单元测试/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5422443.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5422443.html</a>
</strong></font>

<h1 id="Android-MVP-amp-依赖注入-amp-单元测试"><a href="#Android-MVP-amp-依赖注入-amp-单元测试" class="headerlink" title="Android MVP&amp;依赖注入&amp;单元测试"></a>Android MVP&amp;依赖注入&amp;单元测试</h1><blockquote>
<p><strong>注意</strong>：为了区分<code>MVP</code>中的<code>View</code>与<code>Android</code>中控件的<code>View</code>，以下<code>MVP</code>中的<code>View</code>使用<code>Viewer</code>来表示。</p>
</blockquote>
<p>这里暂时先只讨论 <code>Viewer</code> 和 <code>Presenter</code>，<code>Model</code>暂时不去涉及。</p>
<h2 id="1-1-MVP-基础框架"><a href="#1-1-MVP-基础框架" class="headerlink" title="1.1 MVP 基础框架"></a>1.1 MVP 基础框架</h2><h3 id="1-1-1-前提"><a href="#1-1-1-前提" class="headerlink" title="1.1.1 前提"></a>1.1.1 前提</h3><p>首先需要解决以下问题：</p>
<blockquote>
<p><code>MVP</code>中把Layout布局和<code>Activity</code>等组件作为<code>Viewer</code>层，增加了<code>Presenter</code>，<code>Presenter</code>层与<code>Model</code>层进行业务的交互，完成后再与<code>Viewer</code>层交互,进行回调来刷新UI。这样一来，业务逻辑的工作都交给了<code>Presenter</code>中进行，使得<code>Viewer</code>层与<code>Model</code>层的耦合度降低，<code>Viewer</code>中的工作也进行了简化。但是在实际项目中，随着逻辑的复杂度越来越大，<code>Viewer</code>（如<code>Activity</code>）臃肿的缺点仍然体现出来了，因为<code>Activity</code>中还是充满了大量与<code>Viewer</code>层无关的代码，比如各种事件的处理派发，就如<code>MVC</code>中的那样<code>Viewer</code>层和<code>Controller</code>代码耦合在一起无法自拔。</p>
</blockquote>
<p>转自我之前的博客（<strong><a href="http://www.cnblogs.com/tiantianbyconan/p/5036289.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5036289.html</a></strong>）中第二阶段所引发的问题。</p>
<p>解决的方法之一在上述文章中也有提到 —— 加入<code>Controller</code>层来分担<code>Viewer</code>的职责。</p>
<h3 id="1-1-2-Contract"><a href="#1-1-2-Contract" class="headerlink" title="1.1.2 Contract"></a>1.1.2 Contract</h3><p>根据以上的解决方案，首先考虑到<code>Viewer</code>直接交互的对象可能是<code>Presenter</code>（原来的方式），也有可能是<code>Controller</code>。</p>
<ul>
<li><p>如果直接交互的对象是<code>Presenter</code>，由于<code>Presenter</code>中可能会进行很多同步、异步操作来调用<code>Model</code>层的代码，并且会回调到UI来进行UI的更新，所以，我们需要在<code>Viewer</code>层对象销毁时能够停止<code>Presenter</code>中执行的任务，或者执行完成后拦截UI的相关回调。因此，<code>Presenter</code>中应该绑定<code>Viewer</code>对象的生命周期（至少<code>Viewer</code>销毁的生命周期是需要关心的）</p>
</li>
<li><p>如果直接交互的对象是<code>Controller</code>，由于<code>Controller</code>中会承担<code>Viewer</code>中的事件回调并派发的职责（比如，ListView item 的点击回调和点击之后对相应的逻辑进行派发、或者<code>Viewer</code>生命周期方法回调后的处理），所以<code>Controller</code>层也是需要绑定<code>Viewer</code>对象的生命周期的。</p>
</li>
</ul>
<p>这里，使用<code>Viewer</code>生命周期回调进行抽象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnViewerDestroyListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onViewerDestroy</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnViewerLifecycleListener</span> <span class="keyword">extends</span> <span class="title">OnViewerDestroyListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onViewerResume</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onViewerPause</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>OnViewerDestroyListener</code>接口提供给需要关心<code>Viewer</code>层销毁时期的组件，如上，应该是<code>Presenter</code>所需要关心的。</p>
<p><code>OnViewerLifecycleListener</code>接口提供给需要关心<code>Viewer</code>层生命周期回调的组件，可以根据项目需求增加更多的生命周期的方法，这里我们只关心<code>Viewer</code>的<code>resume</code>和<code>pause</code>。</p>
<h3 id="1-1-3-Viewer层"><a href="#1-1-3-Viewer层" class="headerlink" title="1.1.3 Viewer层"></a>1.1.3 Viewer层</h3><h4 id="1-1-3-1-Viewer-抽象"><a href="#1-1-3-1-Viewer-抽象" class="headerlink" title="1.1.3.1 Viewer 抽象"></a>1.1.3.1 Viewer 抽象</h4><p><code>Viewer</code>层，也就是表现层，当然有相关常用的UI操作，比如显示一个<code>toast</code>、显示/取消一个加载进度条等等。除此之外，由于<code>Viewer</code>层可能会直接与<code>Presenter</code>或者<code>Controller</code>层交互，所以应该还提供对这两者的绑定操作，所以如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Viewer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Viewer <span class="title">bind</span><span class="params">(OnViewerLifecycleListener onViewerLifecycleListener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Viewer <span class="title">bind</span><span class="params">(OnViewerDestroyListener onViewerDestroyListener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Context <span class="title">context</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showToast</span><span class="params">(String message)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showToast</span><span class="params">(<span class="keyword">int</span> resStringId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showLoadingDialog</span><span class="params">(String message)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showLoadingDialog</span><span class="params">(<span class="keyword">int</span> resStringId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">cancelLoadingDialog</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上代码，两个<code>bind()</code>方法就是用于跟<code>Presenter</code>/<code>Controller</code>的绑定。</p>
<h4 id="1-1-3-2-Viewer-委托实现"><a href="#1-1-3-2-Viewer-委托实现" class="headerlink" title="1.1.3.2 Viewer 委托实现"></a>1.1.3.2 Viewer 委托实现</h4><p>又因为，在Android中<code>Viewer</code>层对象可能是<code>Activity</code>、<code>Fragment</code>、<code>View</code>（包括<code>ViewGroup</code>），甚至还有自己实现的组件，当然实现的方式一般不外乎上面这几种。所以我们需要使用统一的<code>Activity</code>、<code>Fragment</code>、<code>View</code>，每个都需要实现<code>Viewer</code>接口。为了复用相关代码，这里提供默认的委托实现<code>ViewerDelegate</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewerDelegate</span> <span class="keyword">implements</span> <span class="title">Viewer</span>, <span class="title">OnViewerLifecycleListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ViewerDelegate</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;OnViewerDestroyListener&gt; mOnViewerDestroyListeners;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;OnViewerLifecycleListener&gt; mOnViewerLifecycleListeners;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Toast toast;</span><br><span class="line">    <span class="keyword">private</span> ProgressDialog loadingDialog;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Viewer <span class="title">bind</span><span class="params">(OnViewerLifecycleListener onViewerLifecycleListener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == mOnViewerLifecycleListeners) &#123;</span><br><span class="line">            mOnViewerLifecycleListeners = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            mOnViewerLifecycleListeners.add(onViewerLifecycleListener);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mOnViewerLifecycleListeners.contains(onViewerLifecycleListener)) &#123;</span><br><span class="line">                mOnViewerLifecycleListeners.add(onViewerLifecycleListener);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Viewer <span class="title">bind</span><span class="params">(OnViewerDestroyListener onViewerDestroyListener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == mOnViewerDestroyListeners) &#123;</span><br><span class="line">            mOnViewerDestroyListeners = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            mOnViewerDestroyListeners.add(onViewerDestroyListener);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mOnViewerDestroyListeners.contains(onViewerDestroyListener)) &#123;</span><br><span class="line">                mOnViewerDestroyListeners.add(onViewerDestroyListener);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">context</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showToast</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!checkViewer()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == toast) &#123;</span><br><span class="line">            toast = Toast.makeText(mContext, <span class="string">""</span>, Toast.LENGTH_SHORT);</span><br><span class="line">            toast.setGravity(Gravity.CENTER, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        toast.setText(message);</span><br><span class="line">        toast.show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showToast</span><span class="params">(<span class="keyword">int</span> resStringId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!checkViewer()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        showToast(mContext.getString(resStringId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showLoadingDialog</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!checkViewer()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == loadingDialog) &#123;</span><br><span class="line">            loadingDialog = <span class="keyword">new</span> ProgressDialog(mContext);</span><br><span class="line">            loadingDialog.setCanceledOnTouchOutside(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        loadingDialog.setMessage(message);</span><br><span class="line">        loadingDialog.show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showLoadingDialog</span><span class="params">(<span class="keyword">int</span> resStringId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!checkViewer()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        showLoadingDialog(mContext.getString(resStringId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelLoadingDialog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!checkViewer()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != loadingDialog) &#123;</span><br><span class="line">            loadingDialog.cancel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkViewer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span> != mContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != mOnViewerLifecycleListeners) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OnViewerLifecycleListener oll : mOnViewerLifecycleListeners) &#123;</span><br><span class="line">                oll.onViewerResume();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != mOnViewerLifecycleListeners) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OnViewerLifecycleListener oll : mOnViewerLifecycleListeners) &#123;</span><br><span class="line">                oll.onViewerPause();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != mOnViewerLifecycleListeners) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OnViewerLifecycleListener oll : mOnViewerLifecycleListeners) &#123;</span><br><span class="line">                oll.onViewerDestroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != mOnViewerDestroyListeners) &#123;</span><br><span class="line">            <span class="keyword">for</span> (OnViewerDestroyListener odl : mOnViewerDestroyListeners) &#123;</span><br><span class="line">                odl.onViewerDestroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mContext = <span class="keyword">null</span>;</span><br><span class="line">        mOnViewerDestroyListeners = <span class="keyword">null</span>;</span><br><span class="line">        mOnViewerLifecycleListeners = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上代码：</p>
<ul>
<li><p>它提供了默认基本的<code>toast</code>、和显示/隐藏加载进度条的方法。</p>
</li>
<li><p>它实现了两个重载<code>bind()</code>方法，并把需要回调的<code>OnViewerLifecycleListener</code>和<code>OnViewerDestroyListener</code>对应保存在<code>mOnViewerDestroyListeners</code>和<code>mOnViewerLifecycleListeners</code>中。</p>
</li>
<li><p>它实现了<code>OnViewerLifecycleListener</code>接口，在回调方法中回调到每个<code>mOnViewerDestroyListeners</code>和<code>mOnViewerLifecycleListeners</code>。</p>
</li>
</ul>
<p><code>mOnViewerDestroyListeners</code>：Viewer destroy 时的回调，一般情况下只会有Presenter一个对象，但是由于一个Viewer是可以有多个Presenter的,所以可能会维护一个Presenter列表，还有可能是其他需要关心 Viewer destroy 的组件</p>
<p><code>mOnViewerLifecycleListeners</code>：Viewer 简单的生命周期监听对象，一般情况下只有一个Controller一个对象，但是一个Viewer并不限制只有一个Controller对象,所以可能会维护一个Controller列表，还有可能是其他关心 Viewer 简单生命周期的组件</p>
<h4 id="1-1-3-3-真实-Viewer-实现"><a href="#1-1-3-3-真实-Viewer-实现" class="headerlink" title="1.1.3.3 真实 Viewer 实现"></a>1.1.3.3 真实 Viewer 实现</h4><p>然后在真实的<code>Viewer</code>中（这里以<code>Activity</code>为例，其他<code>Fragment</code>/<code>View</code>等也是一样），首先，应该实现<code>Viewer</code>接口，并且应该维护一个委托对象<code>mViewerDelegate</code>，在实现的<code>Viewer</code>方法中使用<code>mViewerDelegate</code>的具体实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">Viewer</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ViewerDelegate mViewerDelegate;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    	<span class="comment">// ...</span></span><br><span class="line">    	mViewerDelegate = <span class="keyword">new</span> ViewerDelegate(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.onViewerResume();</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.onViewerPause();</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.onViewerDestroy();</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Viewer <span class="title">bind</span><span class="params">(OnViewerDestroyListener onViewerDestroyListener)</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.bind(onViewerDestroyListener);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Viewer <span class="title">bind</span><span class="params">(OnViewerLifecycleListener onViewerLifecycleListener)</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.bind(onViewerLifecycleListener);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">context</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mViewerDelegate.context();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showToast</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.showToast(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showToast</span><span class="params">(<span class="keyword">int</span> resStringId)</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.showToast(resStringId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showLoadingDialog</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.showLoadingDialog(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showLoadingDialog</span><span class="params">(<span class="keyword">int</span> resStringId)</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.showLoadingDialog(resStringId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelLoadingDialog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mViewerDelegate.cancelLoadingDialog();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，<code>BaseActivity</code>构建完成。</p>
<p><strong>在具体真实的<code>Viewer</code>实现中，包含的方法应该都是类似<code>onXxxYyyZzz()</code>的回调方法，并且这些回调方法应该只进行UI操作，比如<code>onLoadMessage(List&lt;Message&gt; message)</code>方法在加载完<code>Message</code>数据后回调该方法来进行UI的更新。</strong></p>
<p>在项目中使用时，应该使用依赖注入来把<code>Controller</code>对象注入到<code>Viewer</code>中（这个后面会提到）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RInject</span></span><br><span class="line">IBuyingRequestPostSucceedController controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    BuyingRequestPostSucceedView_Rapier</span><br><span class="line">            .create()</span><br><span class="line">            .inject(<span class="keyword">module</span>, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    controller.bind(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>RInject</code>通过<code>BuyingRequestPostSucceedView_Rapier</code>扩展类来进行注入<code>Controller</code>对象，然后调用<code>Controller</code>的<code>bind</code>方法进行生命周期的绑定。</p>
<h3 id="1-1-4-Controller-层"><a href="#1-1-4-Controller-层" class="headerlink" title="1.1.4 Controller 层"></a>1.1.4 Controller 层</h3><h4 id="1-1-4-1-Controller-抽象"><a href="#1-1-4-1-Controller-抽象" class="headerlink" title="1.1.4.1 Controller 抽象"></a>1.1.4.1 Controller 抽象</h4><p>前面讲过，<code>Controller</code>是需要关心<code>Viewer</code>生命周期的，所以需要实现<code>OnViewerLifecycleListener</code>接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Controller</span> <span class="keyword">extends</span> <span class="title">OnViewerLifecycleListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bind</span><span class="params">(Viewer bindViewer)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又提供一个<code>bind()</code>方法来进行对自身进行绑定到对应的<code>Viewer</code>上面。</p>
<h4 id="1-1-4-2-Controller-实现"><a href="#1-1-4-2-Controller-实现" class="headerlink" title="1.1.4.2 Controller 实现"></a>1.1.4.2 Controller 实现</h4><p>调用<code>Viewer</code>层的<code>bind()</code>方法来进行绑定，对生命周期进行空实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseController</span> <span class="keyword">implements</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Viewer bindViewer)</span> </span>&#123;</span><br><span class="line">        bindViewer.bind(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// empty</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// empty</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// empty</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该<code>bind()</code>方法除了用于绑定<code>Viewer</code>之外，还可以让子类重写用于做为Controller的初始化方法,但是注意重写的时候必须要调用<code>super.bind()</code>。</p>
<p><strong>具体<code>Controller</code>实现中，应该只包含类似<code>onXxxYyyZzz()</code>的回调方法，并且这些回调方法应该都是各种事件回调，比如<code>onClick()</code>用于View点击事件的回调，<code>onItemClick()</code>表示AdapterView item点击事件的回调。</strong></p>
<h3 id="1-1-5-Presenter-层"><a href="#1-1-5-Presenter-层" class="headerlink" title="1.1.5 Presenter 层"></a>1.1.5 Presenter 层</h3><h4 id="1-1-5-1-Presenter-抽象"><a href="#1-1-5-1-Presenter-抽象" class="headerlink" title="1.1.5.1 Presenter 抽象"></a>1.1.5.1 Presenter 抽象</h4><blockquote>
<p><code>Presenter</code>层，作为沟通 <code>View</code> 和 <code>Model</code> 的桥梁，它从 <code>Model</code> 层检索数据后，返回给 <code>View</code> 层，它也可以决定与 <code>View</code> 层的交互操作。</p>
</blockquote>
<p>前面讲到过，<code>View</code>也是与<code>Presenter</code>直接交互的，Presenter中可能会进行很多同步、异步操作来调用Model层的代码，并且会回调到UI来进行UI的更新，所以，我们需要在Viewer层对象销毁时能够停止Presenter中执行的任务，或者执行完成后拦截UI的相关回调。</p>
<p>因此：</p>
<ul>
<li><code>Presenter</code> 中应该也有<code>bind()</code>方法来进行与<code>Viewer</code>层的生命周期的绑定</li>
<li><code>Presenter</code> 中应该提供一个方法<code>closeAllTask()</code>来终止或拦截掉UI相关的异步任务。</li>
</ul>
<p>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Presenter</span> <span class="keyword">extends</span> <span class="title">OnViewerDestroyListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bind</span><span class="params">(Viewer bindViewer)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">closeAllTask</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-1-5-2-Presenter-RxJava-抽象"><a href="#1-1-5-2-Presenter-RxJava-抽象" class="headerlink" title="1.1.5.2 Presenter RxJava 抽象"></a>1.1.5.2 Presenter RxJava 抽象</h4><p>因为项目技术需求，需要实现对<code>RxJava</code>的支持，因此，这里对<code>Presenter</code>进行相关的扩展，提供两个方法以便于<code>Presenter</code>对任务的扩展。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RxPresenter</span> <span class="keyword">extends</span> <span class="title">Presenter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">goSubscription</span><span class="params">(Subscription subscription)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeSubscription</span><span class="params">(Subscription subscription)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>goSubscription()</code>方法主要用处是，订阅时缓存该订阅对象到<code>Presenter</code>中，便于管理（怎么管理，下面会讲到）。</p>
<p><code>removeSubscription()</code>方法可以从<code>Presenter</code>中管理的订阅缓存中移除掉该订阅。</p>
<h4 id="1-1-5-3-Presenter-RxJava-实现"><a href="#1-1-5-3-Presenter-RxJava-实现" class="headerlink" title="1.1.5.3 Presenter RxJava 实现"></a>1.1.5.3 Presenter RxJava 实现</h4><p>在Presenter RxJava 实现（<code>RxBasePresenter</code>）中，我们使用<code>WeakHashMap</code>来构建一个弱引用的<code>Set</code>，用它来缓存所有订阅。在调用<code>goSubscription()</code>方法中，把对应的<code>Subscription</code>加入到<code>Set</code>中，在<code>removeSubscription()</code>方法中，把对应的<code>Subscription</code>从<code>Set</code>中移除掉。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxBasePresenter</span> <span class="keyword">implements</span> <span class="title">RxPresenter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = RxBasePresenter.class.getSimpleName();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Subscription&gt; subscriptions = Collections.newSetFromMap(<span class="keyword">new</span> WeakHashMap&lt;Subscription, Boolean&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeAllTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (subscriptions) &#123;</span><br><span class="line">            Iterator iter = <span class="keyword">this</span>.subscriptions.iterator();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                Subscription subscription = (Subscription) iter.next();</span><br><span class="line">                XLog.i(TAG, <span class="string">"closeAllTask[subscriptions]: "</span> + subscription);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != subscription &amp;&amp; !subscription.isUnsubscribed()) &#123;</span><br><span class="line">                    subscription.unsubscribe();</span><br><span class="line">                &#125;</span><br><span class="line">                iter.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">goSubscription</span><span class="params">(Subscription subscription)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (subscriptions) &#123;</span><br><span class="line">            <span class="keyword">this</span>.subscriptions.add(subscription);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeSubscription</span><span class="params">(Subscription subscription)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (subscriptions) &#123;</span><br><span class="line">            XLog.i(TAG, <span class="string">"removeSubscription: "</span> + subscription);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != subscription &amp;&amp; !subscription.isUnsubscribed()) &#123;</span><br><span class="line">                subscription.unsubscribe();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.subscriptions.remove(subscription);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(Viewer bindViewer)</span> </span>&#123;</span><br><span class="line">        bindViewer.bind(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewerDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        closeAllTask();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上代码，在<code>onViewerDestroy()</code>回调时（因为跟<code>Viewer</code>生命周期进行了绑定），会调用<code>closeAllTask</code>把所有缓存中的<code>Subscription</code>取消订阅。</p>
<blockquote>
<p><strong>注意</strong>：因为缓存中使用了弱引用，所以上面的<code>removeSubscription</code>不需要再去手动调用，在订阅completed后，gc自然会回收掉没有强引用指向的<code>Subscription</code>对象。</p>
</blockquote>
<h4 id="1-1-5-4-Presenter-具体实现"><a href="#1-1-5-4-Presenter-具体实现" class="headerlink" title="1.1.5.4 Presenter 具体实现"></a>1.1.5.4 Presenter 具体实现</h4><p>在<code>Presenter</code>具体的实现中，同样依赖注入各种来自<code>Model</code>层的<code>Interactor/Api</code>（网络、数据库、文件等等），然后订阅这些对象返回的<code>Observable</code>，然后进行订阅，并调用<code>goSubscription()</code>缓存<code>Subscription</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuyingRequestPostSucceedPresenter</span> <span class="keyword">extends</span> <span class="title">RxBasePresenter</span> <span class="keyword">implements</span> <span class="title">IBuyingRequestPostSucceedPresenter</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> IBuyingRequestPostSucceedView viewer;</span><br><span class="line">	<span class="meta">@RInject</span></span><br><span class="line">    ApiSearcher apiSearcher;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BuyingRequestPostSucceedPresenter</span><span class="params">(IBuyingRequestPostSucceedView viewer, BuyingRequestPostSucceedPresenterModule <span class="keyword">module</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.viewer = viewer;</span><br><span class="line">        <span class="comment">// inject</span></span><br><span class="line">        BuyingRequestPostSucceedPresenter_Rapier</span><br><span class="line">                .create()</span><br><span class="line">                .inject(<span class="keyword">module</span>, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadSomeThing</span><span class="params">(<span class="keyword">final</span> String foo, <span class="keyword">final</span> String bar)</span> </span>&#123;</span><br><span class="line">        goSubscription(</span><br><span class="line">                apiSearcher.searcherSomeThing(foo, bar)</span><br><span class="line">                        .compose(TransformerBridge.&lt;OceanServerResponse&lt;SomeThing&gt;&gt;subscribeOnNet())</span><br><span class="line">                        .map(<span class="keyword">new</span> Func1&lt;OceanServerResponse&lt;SomeThing&gt;, SomeThing&gt;() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> SomeThing <span class="title">call</span><span class="params">(OceanServerResponse&lt;SomeThing&gt; response)</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">return</span> response.getBody();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;)</span><br><span class="line">                        .compose(TransformerBridge.&lt;SomeThing&gt;observableOnMain())</span><br><span class="line">                        .subscribe(<span class="keyword">new</span> Subscriber&lt;SomeThing&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                                XLog.e(TAG, <span class="string">""</span>, e);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(SomeThing someThing)</span> </span>&#123;</span><br><span class="line">                                XLog.d(TAG, <span class="string">"XLog onNext..."</span>);</span><br><span class="line">                                viewer.onLoadSomeThing(someThing);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;)</span><br><span class="line">        );</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ... </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-6-Model-层"><a href="#1-1-6-Model-层" class="headerlink" title="1.1.6 Model 层"></a>1.1.6 Model 层</h3><p>暂不讨论。</p>
<h2 id="1-2-针对-MVP-进行依赖注入"><a href="#1-2-针对-MVP-进行依赖注入" class="headerlink" title="1.2 针对 MVP 进行依赖注入"></a>1.2 针对 MVP 进行依赖注入</h2><p>上面提到，<code>Viewer</code>、<code>Controller</code>和<code>Presenter</code>中都使用了<code>RInject</code>注解来进行依赖的注入。</p>
<p>这里并没有使用其他第三方实现的<code>DI</code>框架，比如<code>Dagger/Dagger2</code>等，而是自己实现的<a href="https://github.com/wangjiegulu/Rapier" target="_blank" rel="noopener">Rapier</a>，它的原理与<code>Dagger2</code>类似，会在编译时期生成一些扩展扩展类来简化代码，比如前面的<code>BuyingRequestPostSucceedView_Rapier</code>、<code>BuyingRequestPostSucceedPresenter_Rapier</code>、<code>BuyingRequestPostSucceedController_Rapier</code>等。它也支持<code>Named</code>、<code>Lazy</code>等功能，但是它比<code>Dagger2</code>更加轻量，<code>Module</code>的使用方式更加简单，更加倾向于对<code>Module</code>的复用，更强的可控性，但是由于这次的重构主要是基于在兼容旧版本的情况下使用，暂时没有加上<code>Scope</code>的支持。</p>
<p>之后再针对这个<code>Rapier</code>库进行详细讨论。</p>
<h2 id="1-3-针对-MVP-进行单元测试"><a href="#1-3-针对-MVP-进行单元测试" class="headerlink" title="1.3 针对 MVP 进行单元测试"></a>1.3 针对 MVP 进行单元测试</h2><p>这里主要还是讨论针对<code>Viewer</code>和<code>Presenter</code>的单元测试。</p>
<h3 id="1-3-1-针对-Viewer-进行单元测试"><a href="#1-3-1-针对-Viewer-进行单元测试" class="headerlink" title="1.3.1 针对 Viewer 进行单元测试"></a>1.3.1 针对 Viewer 进行单元测试</h3><p>针对<code>Viewer</code>进行单元测试，这里不涉及任何业务相关的逻辑，而且，<code>Viewer</code>层的测试都是UI相关，必须要Android环境，所以需要在手机或者模拟器安装一个<code>test</code> apk，然后进行测试。</p>
<p>为了不被<code>Viewer</code>中的<code>Controller</code>和<code>Presenter</code>的逻辑所干扰，我们必须要mock掉<code>Viewer</code>中的<code>Controller</code>和<code>Presenter</code>对象，又因为<code>Controller</code>对象是通过依赖注入的方式提供的，也就是来自<code>Rapier</code>中的<code>Module</code>，所以，我们只需要mock掉<code>Viewer</code>对应的<code>module</code>。</p>
<h3 id="1-3-1-1-如果-Viewer-是-View"><a href="#1-3-1-1-如果-Viewer-是-View" class="headerlink" title="1.3.1.1 如果 Viewer 是 View"></a>1.3.1.1 如果 Viewer 是 View</h3><p>如果<code>Viewer</code>层是由<code>View</code>实现的，比如继承<code>FrameLayout</code>。这个时候，测试时，就必须要放在一个<code>Activity</code>中测试（<code>Fragment</code>也一样，也必须依赖于<code>Activity</code>），所以我们应该有一个专门用于测试<code>View/Fragment</code>的<code>Activity</code> —— <code>TestContainerActivity</code>，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestContainerActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>记得在<code>AndroidManifest.xml</code>中注册。</p>
<p>前面说过，我们需要mock掉<code>Module</code>。</p>
<p>如果<code>Viewer</code>是<code>View</code>，mock掉<code>Module</code>就非常容易了，只要在<code>View</code>中提供一个传入mock的<code>Module</code>的构造方法即可，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BuyingRequestPostSucceedView</span><span class="params">(Context context, BuyingRequestPostSucceedModule <span class="keyword">module</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>(context);</span><br><span class="line">	<span class="comment">// inject</span></span><br><span class="line">	BuyingRequestPostSucceedView_Rapier</span><br><span class="line">	        .create()</span><br><span class="line">	        .inject(<span class="keyword">module</span>, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上代码，这里为测试专门提供了一个构造方法来进行对<code>Module</code>的mock，之后的测试如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">BuyingRequestPostSucceedView requestPostSucceedView;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Rule</span></span><br><span class="line"><span class="keyword">public</span> ActivityTestRule&lt;TestContainerActivity&gt; mActivityTestRule = <span class="keyword">new</span> ActivityTestRule&lt;TestContainerActivity&gt;(TestContainerActivity.class) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterActivityLaunched</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.afterActivityLaunched();</span><br><span class="line">            <span class="keyword">final</span> TestContainerActivity activity = getActivity();</span><br><span class="line">            logger(<span class="string">"afterActivityLaunched"</span>);</span><br><span class="line">            activity.runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    BuyingRequestPostSucceedModule <span class="keyword">module</span> = mock(BuyingRequestPostSucceedModule.class);</span><br><span class="line">                    when(<span class="keyword">module</span>.pickController()).thenReturn(mock(IBuyingRequestPostSucceedController.class));</span><br><span class="line">                    requestPostSucceedView = <span class="keyword">new</span> BuyingRequestPostSucceedView(activity, <span class="keyword">module</span>);</span><br><span class="line">                    activity.setContentView(requestPostSucceedView);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOnLoadSomeThings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> SomeThings products = mock(SomeThings.class);</span><br><span class="line">        ArrayList&lt;SomeThing&gt; list = mock(ArrayList.class);</span><br><span class="line"></span><br><span class="line">        SomeThing product = mock(SomeThing.class);</span><br><span class="line"></span><br><span class="line">        when(list.get(anyInt())).thenReturn(product);</span><br><span class="line">        products.productList = list;</span><br><span class="line"></span><br><span class="line">        TestContainerActivity activity = mActivityTestRule.getActivity();</span><br><span class="line"></span><br><span class="line">        when(list.size()).thenReturn(<span class="number">1</span>);</span><br><span class="line">        when(list.isEmpty()).thenReturn(<span class="keyword">false</span>);</span><br><span class="line">        activity.runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                requestPostSucceedView.onLoadSomeThing(products);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        onView(withId(R.id.id_tips_you_may_also_like_tv)).check(matches(isDisplayed()));</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如上代码，在<code>TestContainerActivity</code>启动后，构造一个mock了<code>Module</code>的待测试<code>View</code>，并增加到<code>Activity</code>的content view中。</p>
<h3 id="1-3-1-2-如果-Viewer-是-Activity"><a href="#1-3-1-2-如果-Viewer-是-Activity" class="headerlink" title="1.3.1.2 如果 Viewer 是 Activity"></a>1.3.1.2 如果 Viewer 是 Activity</h3><p>如果<code>Viewer</code>是<code>Activity</code>，由于它本来就是Activity，所以它不需要借助<code>TestContainerActivity</code>来测试；mock <code>module</code>时就不能使用构造方法的方式了，因为我们是不能直接对<code>Activity</code>进行实例化的，那应该怎么办呢？</p>
<p>一般情况下，我们会在调用<code>onCreate</code>方法的时候去进行对依赖的注入，也就是调用<code>XxxYyyZzz_Rapier</code>扩展类，而且，如果这个<code>Activity</code>需要在一启动就去进行一些数据请求，我们要拦截掉这个请求，因为这个请求返回的数据可能会对我们的UI测试造成干扰，所以我们需要在<code>onCreate</code>在被调用之前把<code>module</code> mock掉。</p>
<p>首先看test support 中的 <code>ActivityTestRule</code>这个类，它提供了以下几个方法：</p>
<ul>
<li><p><code>getActivityIntent()</code>：这个方法只能在Intent中增加携带的参数，我们要mock的是整个<code>Module</code>，无法序列化，所以也无法通过这个传入。</p>
</li>
<li><p><code>beforeActivityLaunched()</code>：这个方法回调时，<code>Activity</code>实例还没有生成，所以无法拿到<code>Activity</code>实例，并进行<code>Module</code>的替换。</p>
</li>
<li><p><code>afterActivityFinished()</code>：这个方法就更不可能了-.-</p>
</li>
<li><p><code>afterActivityLaunched()</code>：这个方法看它的源码（无关代码已省略）：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">launchActivity</span><span class="params">(@Nullable Intent startIntent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        beforeActivityLaunched();</span><br><span class="line">        <span class="comment">// The following cast is correct because the activity we're creating is of the same type as</span></span><br><span class="line">        <span class="comment">// the one passed in</span></span><br><span class="line">        mActivity = mActivityClass.cast(mInstrumentation.startActivitySync(startIntent));</span><br><span class="line"></span><br><span class="line">        mInstrumentation.waitForIdleSync();</span><br><span class="line"></span><br><span class="line">        afterActivityLaunched();</span><br><span class="line">        <span class="keyword">return</span> mActivity;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如上代码，<code>afterActivityLaunched()</code>方法是在真正启动<code>Activity</code>（<code>mInstrumentation.startActivitySync(startIntent)</code>）后调用的。但是显然这个方法是同步的，之后再进入源码，来查看启动的流程，整个流程有些复杂我就不赘述了，可以查看我以前写的分析启动流程的博客（<strong><a href="http://www.cnblogs.com/tiantianbyconan/p/5017056.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5017056.html</a></strong>），最后会调用<code>mInstrumentation.callActivityOnCreate(...)</code>。</p>
<p>但是因为测试时，启动<code>Activity</code>的过程也是同步的，所以显然这个方法是在<code>onCreate()</code>被调用后才会被回调的，所以，这个方法也不行。</p>
<p>既然貌似已经找到了mock的正确位置，那就继续分析下去：</p>
<p>这里的<code>mInstrumentation</code>是哪个<code>Instrumentation</code>实例呢？</p>
<p>我们回到<code>ActivityTestRule</code>中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityTestRule</span><span class="params">(Class&lt;T&gt; activityClass, <span class="keyword">boolean</span> initialTouchMode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> launchActivity)</span> </span>&#123;</span><br><span class="line">        mActivityClass = activityClass;</span><br><span class="line">        mInitialTouchMode = initialTouchMode;</span><br><span class="line">        mLaunchActivity = launchActivity;</span><br><span class="line">        mInstrumentation = InstrumentationRegistry.getInstrumentation();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>继续进入<code>InstrumentationRegistry.getInstrumentation()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Instrumentation <span class="title">getInstrumentation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Instrumentation instance = sInstrumentationRef.get();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == instance) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No instrumentation registered! "</span></span><br><span class="line">                    + <span class="string">"Must run under a registering instrumentation."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续查找<code>sInstrumentationRef</code>是在哪里<code>set</code>进去的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerInstance</span><span class="params">(Instrumentation instrumentation, Bundle arguments)</span> </span>&#123;</span><br><span class="line">        sInstrumentationRef.set(instrumentation);</span><br><span class="line">        sArguments.set(<span class="keyword">new</span> Bundle(arguments));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续查找调用，终于在<code>MonitoringInstrumentation</code>中找到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arguments)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    InstrumentationRegistry.registerInstance(<span class="keyword">this</span>, arguments);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，测试使用的<code>MonitoringInstrumentation</code>，然后进入<code>MonitoringInstrumentation</code>的<code>callActivityOnCreate()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle bundle)</span> </span>&#123;</span><br><span class="line">        mLifecycleMonitor.signalLifecycleChange(Stage.PRE_ON_CREATE, activity);</span><br><span class="line">        <span class="keyword">super</span>.callActivityOnCreate(activity, bundle);</span><br><span class="line">        mLifecycleMonitor.signalLifecycleChange(Stage.CREATED, activity);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>既然我们需要在<code>Activity</code>真正执行<code>onCreate()</code>方法时拦截掉，那如上代码，只要关心<code>signalLifecycleChange()</code>方法，发现了<code>ActivityLifecycleCallback</code>的回调：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">signalLifecycleChange</span><span class="params">(Stage stage, Activity activity)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	Iterator&lt;WeakReference&lt;ActivityLifecycleCallback&gt;&gt; refIter = mCallbacks.iterator();</span><br><span class="line">    <span class="keyword">while</span> (refIter.hasNext()) &#123;</span><br><span class="line">        ActivityLifecycleCallback callback = refIter.next().get();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == callback) &#123;</span><br><span class="line">            refIter.remove();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        		<span class="comment">// ...</span></span><br><span class="line">        		callback.onActivityLifecycleChanged(activity, stage);</span><br><span class="line">        		<span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，问题解决了，我们只要添加一个<code>Activity</code>生命周期回调就搞定了，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ActivityLifecycleMonitorRegistry.getInstance().addLifecycleCallback(<span class="keyword">new</span> ActivityLifecycleCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityLifecycleChanged</span><span class="params">(Activity activity, Stage stage)</span> </span>&#123;</span><br><span class="line">        logger(<span class="string">"onActivityLifecycleChanged, activity"</span> + activity + <span class="string">", stage: "</span> + stage);</span><br><span class="line">        <span class="keyword">if</span>(activity <span class="keyword">instanceof</span> SomethingActivity &amp;&amp; Stage.PRE_ON_CREATE == stage)&#123;</span><br><span class="line">            logger(<span class="string">"onActivityLifecycleChanged, got it!!!"</span>);</span><br><span class="line">            ((SomethingActivity)activity).setModule(mock(SomethingModule.class));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>至此，<code>Activity</code>的 mock <code>module</code>成功了。</p>
<h3 id="1-3-2-针对-Presenter-进行单元测试"><a href="#1-3-2-针对-Presenter-进行单元测试" class="headerlink" title="1.3.2 针对 Presenter 进行单元测试"></a>1.3.2 针对 Presenter 进行单元测试</h3><h4 id="1-3-2-1-测试与-Android-SDK-分离"><a href="#1-3-2-1-测试与-Android-SDK-分离" class="headerlink" title="1.3.2.1 测试与 Android SDK 分离"></a>1.3.2.1 测试与 Android SDK 分离</h4><p><code>Presenter</code> 的单元测试与 <code>Viewer</code> 不一样，在<code>Presenter</code>中不应该有<code>Android SDK</code>相关存在，所有的<code>Inteactor/Api</code>等都是与<code>Android</code>解耦的。显然更加不能有<code>TextView</code>等存在。正是因为这个，使得它可以基于PC上的JVM来进行单元测试，也就是说，<code>Presenter</code>测试不需要Android环境，省去了安装到手机或者模拟器的步骤。</p>
<p>怎么去避免<code>Anroid</code>相关的SDK在<code>Presenter</code>中存在？</p>
<p>的确有极个别的SDK很难避免，比如<code>Log</code>。</p>
<h5 id="1-3-2-1-1-使用-XLog-与-Log-分离"><a href="#1-3-2-1-1-使用-XLog-与-Log-分离" class="headerlink" title="1.3.2.1.1 使用 XLog 与 Log 分离"></a>1.3.2.1.1 使用 XLog 与 Log 分离</h5><p>所以，我们需要一个<code>XLog</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XLog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IXLog delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> DEBUG = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDebug</span><span class="params">(<span class="keyword">boolean</span> debug)</span> </span>&#123;</span><br><span class="line">        XLog.DEBUG = debug;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDelegate</span><span class="params">(IXLog delegate)</span> </span>&#123;</span><br><span class="line">        XLog.delegate = delegate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">v</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG &amp;&amp; <span class="keyword">null</span> != delegate) &#123;</span><br><span class="line">            delegate.v(tag, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">v</span><span class="params">(String tag, String msg, Throwable tr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG &amp;&amp; <span class="keyword">null</span> != delegate) &#123;</span><br><span class="line">            delegate.v(tag, msg, tr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">d</span><span class="params">(String tag, String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG &amp;&amp; <span class="keyword">null</span> != delegate) &#123;</span><br><span class="line">            delegate.d(tag, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>在Android环境中使用的策略：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XLog.setDelegate(<span class="keyword">new</span> XLogDef());</span><br></pre></td></tr></table></figure>
<p>其中<code>XLogDef</code>类中的实现为原生Androd SDK的Log实现。</p>
<p>在测试环境中使用的策略：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logDelegateSpy = Mockito.spy(<span class="keyword">new</span> XLogJavaTest());</span><br><span class="line">XLog.setDelegate(logDelegateSpy);</span><br></pre></td></tr></table></figure>
<p>其中<code>XLogJavaTest</code>使用的是纯Java的<code>System.out.println()</code></p>
<h4 id="1-3-2-2-异步操作同步化"><a href="#1-3-2-2-异步操作同步化" class="headerlink" title="1.3.2.2 异步操作同步化"></a>1.3.2.2 异步操作同步化</h4><p>因为<code>Presenter</code>中会有很多的异步任务存在，但是在细粒度的单元测试中，没有异步任务存在的必要性，相应反而增加了测试复杂度。所以，我们应该把所有异步任务切换成同步操作。</p>
<p>调度的切换使用的是<code>RxJava</code>，所以所有切换到主线程也是使用了<code>Android SDK</code>。这里也要采用策略进行处理。</p>
<p>首先定义了几种不同的<code>ScheduleType</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAIN = <span class="number">0x3783</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NET = <span class="number">0x8739</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DB = <span class="number">0x1385</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Schedule</code>选择器中根据<code>ScheduleType</code>进行对应类型的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SchedulerSelector schedulerSelector = SchedulerSelector.get();</span><br><span class="line"></span><br><span class="line">schedulerSelector.putScheduler(SchedulerType.MAIN, <span class="keyword">new</span> SchedulerSelector.SchedulerCreation&lt;Scheduler&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> AndroidSchedulers.mainThread();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">schedulerSelector.putScheduler(SchedulerType.NET, <span class="keyword">new</span> SchedulerSelector.SchedulerCreation&lt;Scheduler&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Schedulers.from(THREAD_POOL_EXECUTOR_NETWORK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">schedulerSelector.putScheduler(SchedulerType.DB, <span class="keyword">new</span> SchedulerSelector.SchedulerCreation&lt;Scheduler&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Schedulers.from(THREAD_POOL_EXECUTOR_DATABASE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>当测试时，对调度选择器中的不同类型的实现进行如下替换：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SchedulerSelector.get().putScheduler(SchedulerType.NET, <span class="keyword">new</span> SchedulerSelector.SchedulerCreation&lt;Scheduler&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Schedulers.immediate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">SchedulerSelector.get().putScheduler(SchedulerType.MAIN, <span class="keyword">new</span> SchedulerSelector.SchedulerCreation&lt;Scheduler&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Schedulers.immediate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>把所有调度都改成当前线程执行即可。</p>
<p>最后<code>Presenter</code>测试几个范例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mock</span></span><br><span class="line">    AccountContract.IAccountViewer viewer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    UserInteractor userInteractor;</span><br><span class="line"></span><br><span class="line">    AccountPresenter presenter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>);</span><br><span class="line">        presenter = <span class="keyword">new</span> AccountPresenter(viewer);</span><br><span class="line">        presenter.userInteractor = userInteractor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestEditUserInfo</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// case 1, succeed</span></span><br><span class="line">        reset(viewer);</span><br><span class="line">        resetLog();</span><br><span class="line"></span><br><span class="line">        when(userInteractor.requestEditUserInfo(any(User.class))).thenReturn(Observable.just(anyBoolean()));</span><br><span class="line">        presenter.requestEditUserInfo(<span class="keyword">new</span> User());</span><br><span class="line"></span><br><span class="line">        verifyOnce(viewer).onRequestEditUserInfo();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// case 2, null</span></span><br><span class="line">        reset(viewer);</span><br><span class="line">        resetLog();</span><br><span class="line">        when(userInteractor.requestEditUserInfo(any(User.class))).thenReturn(Observable.just(<span class="keyword">null</span>));</span><br><span class="line">        presenter.requestEditUserInfo(<span class="keyword">new</span> User());</span><br><span class="line"></span><br><span class="line">        verifyOnce(viewer).onRequestEditUserInfo();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// case 3, error</span></span><br><span class="line">        assertFailedAndError(() -&gt; userInteractor.requestEditUserInfo(any(User.class)), () -&gt; presenter.requestEditUserInfo(<span class="keyword">new</span> User()));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SBuyingRequestPostSucceedViewPresenterTest</span> <span class="keyword">extends</span> <span class="title">BaseJavaTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">public</span> IBuyingRequestPostSucceedView viewer;</span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">public</span> BuyingRequestPostSucceedPresenterModule <span class="keyword">module</span>;</span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">public</span> ApiSearcher apiSearcher;</span><br><span class="line">    <span class="keyword">public</span> IBuyingRequestPostSucceedPresenter presenter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        when(<span class="keyword">module</span>.pickApiSearcher()).thenReturn(apiSearcher);</span><br><span class="line">        presenter = <span class="keyword">new</span> BuyingRequestPostSucceedPresenter(viewer, <span class="keyword">module</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLoadSomethingSuccess</span><span class="params">()</span> <span class="keyword">throws</span> TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">// Mock success observable</span></span><br><span class="line">        when(apiSearcher.searcherSomething(anyString(), anyString(), anyString()))</span><br><span class="line">                .thenReturn(Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;OceanServerResponse&lt;Something&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> OceanServerResponse&lt;Something&gt;&gt; subscriber)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            OceanServerResponse&lt;Something&gt; oceanServerResponse = mock(OceanServerResponse.class);</span><br><span class="line">                            when(oceanServerResponse.getBody(any(Class.class))).thenReturn(mock(Something.class));</span><br><span class="line">                            subscriber.onNext(oceanServerResponse);</span><br><span class="line">                            subscriber.onCompleted();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">                            subscriber.onError(throwable);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;I</span><br><span class="line">                &#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ExecuteStuff executeStuff = <span class="keyword">new</span> ExecuteStuff();</span><br><span class="line">        Answer succeedAnswer = <span class="keyword">new</span> Answer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">answer</span><span class="params">(InvocationOnMock invocationOnMock)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                loggerMockAnswer(invocationOnMock);</span><br><span class="line">                executeStuff.setSucceed(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        doAnswer(succeedAnswer).when(viewer).onLoadSomething(Matchers.any(Something.class));</span><br><span class="line"></span><br><span class="line">        presenter.loadSomething(<span class="string">"whatever"</span>, <span class="string">"whatever"</span>);</span><br><span class="line"></span><br><span class="line">        logger(<span class="string">"loadSomething result: "</span> + executeStuff.isSucceed());</span><br><span class="line">        Assert.assertTrue(<span class="string">"testLoadSomethingSuccess result true"</span>, executeStuff.isSucceed());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLoadSomethingFailed</span><span class="params">()</span> <span class="keyword">throws</span> TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">// Mock error observable</span></span><br><span class="line">        when(apiSearcher.searcherRFQInterestedProductsSuggestion(anyString(), anyString(), anyString()))</span><br><span class="line">                .thenReturn(Observable.&lt;OceanServerResponse&lt;Something&gt;&gt;error(<span class="keyword">new</span> RuntimeException(<span class="string">"mock error observable"</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ExecuteStuff executeStuff = <span class="keyword">new</span> ExecuteStuff();</span><br><span class="line">        Answer failedAnswer = <span class="keyword">new</span> Answer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">answer</span><span class="params">(InvocationOnMock invocationOnMock)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                loggerMockAnswer(invocationOnMock);</span><br><span class="line">                executeStuff.setSucceed(<span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        doAnswerWhenLogError(failedAnswer);</span><br><span class="line"></span><br><span class="line">        presenter.loadSomething(<span class="string">"whatever"</span>, <span class="string">"whatever"</span>);</span><br><span class="line"></span><br><span class="line">        logger(<span class="string">"testLoadSomethingFailed result: "</span> + executeStuff.isSucceed());</span><br><span class="line">        Assert.assertFalse(<span class="string">"testLoadSomethingFailed result false"</span>, executeStuff.isSucceed());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/03/14/Android-一个干净的架构（翻译）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/14/Android-一个干净的架构（翻译）/" itemprop="url">[Android]一个干净的架构（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-03-14T17:52:00+08:00">
                2016-03-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/03/14/Android-一个干净的架构（翻译）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/03/14/Android-一个干净的架构（翻译）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5276587.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5276587.html</a>
</strong></font>

<h1 id="一个干净的架构"><a href="#一个干净的架构" class="headerlink" title="一个干净的架构"></a>一个干净的架构</h1><blockquote>
<p>原文：<a href="https://blog.8thlight.com/uncle-bob/2012/08/13/the-clean-architecture.html" target="_blank" rel="noopener">https://blog.8thlight.com/uncle-bob/2012/08/13/the-clean-architecture.html</a></p>
</blockquote>
<p><img src="https://blog.8thlight.com/assets/posts/2012-08-13-the-clean-architecture/CleanArchitecture-81565aba46f035911a5018e77a0f2d4e.jpg" alt=""></p>
<p>在过去几年中我们能看到的一系列关于系统架构的思想。它们包括：</p>
<ul>
<li><p><a href="http://alistair.cockburn.us/Hexagonal+architecture" target="_blank" rel="noopener">Hexagonal Architecture</a>（也称为<code>Ports and Adapters</code>），作者是 Alistair Cockburn，并被 Steve Freeman 和 Nat Pryce 在他们很棒的 <a href="http://www.amazon.com/Growing-Object-Oriented-Software-Guided-Tests/dp/0321503627" target="_blank" rel="noopener">Growing Object Oriented Software</a> 这本书中采用。</p>
</li>
<li><p><a href="http://jeffreypalermo.com/blog/the-onion-architecture-part-1/" target="_blank" rel="noopener">Onion Architecture</a>，作者是 Jeffrey Palermo。</p>
</li>
<li><p><a href="http://blog.8thlight.com/uncle-bob/2011/09/30/Screaming-Architecture.html" target="_blank" rel="noopener">Screaming Architecture</a>，来自我去年写的一篇博客。</p>
</li>
<li><p><a href="http://www.amazon.com/Lean-Architecture-Agile-Software-Development/dp/0470684208/" target="_blank" rel="noopener">DCI</a>，来自 James Coplien 和 Trygve Reenskaug。</p>
</li>
<li><p><a href="http://www.amazon.com/Object-Oriented-Software-Engineering-Approach/dp/0201544350" target="_blank" rel="noopener">BCE</a>，来自 Ivar Jacobson 的一本书 <em>Object Oriented Software Engineering: A Use-Case Driven Approach</em></p>
</li>
</ul>
<p>尽管这些书在细节上有些不同之处，但是它们是非常相似的。从分离的观点上来讲它们都有着同样的目标。它们都是通过软件分层来实现分离的。每一个都至少有一层是用于业务规则，另外一层用于接口。</p>
<p>这些架构生产系统：</p>
<p>1. <strong>框架独立性</strong>。架构并不依赖于已经存在的某些库的有负载的特性。这允许你作为工具去使用框架，而不是把你的系统强塞到限制和约束中。</p>
<p>2. <strong>可测试性</strong>。业务规则可以脱离UI、数据库、web服务器和其它外部元素去进行测试。</p>
<p>3. <strong>UI的独立性</strong>。UI可以在不修改系统其它地方的情况下很容易地被改变。比如，一个Web UI可以使用console UI替换，而不改变任何业务规则。</p>
<p>4. <strong>数据库独立</strong>。你可以使用Mongo、BitTable、CouchDB或者其它来置换Oracle或SQL Server。你的业务规则不会被数据库束缚。</p>
<p>5. <strong>外部代理的独立性</strong>。事实上，你的业务规则根本不知道外面的世界。</p>
<p>这篇文章顶部的图表就是尝试所有这些结构到单个可操作的思想中去。</p>
<h2 id="依赖准则"><a href="#依赖准则" class="headerlink" title="依赖准则"></a>依赖准则</h2><p>同心圆表示不同软件的区域。一般情况下，走得越远，软件水平也会变得越高。外面的圆是机制，而内部的圆是政策。</p>
<p>使得这个架构可行的最重要的规则是 <em>依赖准则</em> 。这个准则指 <em>代码的依赖</em> 只能 <em>向内</em> 。没有一个内部圆可以知道外部圆的任何东西。尤其是在内部圆声明的东西名字不能被内部圆中的代码提到。这里包括方法、类、变量、或者其它软件实体的名字。</p>
<p>同样的原因，外部圆中用到的数据格式不能被内部圆使用，尤其是这些格式是被外部圆中的框架生成的。我们不希望任何在外部圆中的东西影响到内部圆。</p>
<h3 id="Entities"><a href="#Entities" class="headerlink" title="Entities"></a><em>Entities</em></h3><p>实体封装了 <em>企业级</em> 业务规则。一个实体可以是一个有方法的对象，或者有一系列的数据结构和函数。只要这个实体可以被很多不同企业中的应用使用就没关系。</p>
<p>如果你没有一个企业，并且只是编写单个的应用程序，那么这些实体就是应用程序中的业务对象。它封装了大部分一般的和高级别的规则。它们最不可能在外部改变的时候被改变。比如，由于安全你不希望这些对象被导航页面改变而影响。没有特别的可操作的改变可以影响实体层。</p>
<h2 id="用例"><a href="#用例" class="headerlink" title="用例"></a>用例</h2><p>软件在这一层包含应用程序指定的业务规则。它封装和实现了这个系统的所有用例。这些用例转化数据流到实体和从实体转化到数据流，然后这些实体直接使用它们企业范围的业务规则来达到用例的目的。</p>
<p>我们不期望改变这一层来影响到实体。我们也不希望这一层被外部的改变，比如数据库、UI、任何常见的框架等影响。在这一层在这的观点上是被孤立的。</p>
<p>然而，我们要做的是希望应用程序操作的改变会影响到软件的用例，所以应该是在这一层。如果用例的细节改变了，那么这一层的某些代码当然也会受到影响。</p>
<h2 id="接口适配器"><a href="#接口适配器" class="headerlink" title="接口适配器"></a>接口适配器</h2><p>在软件的这一层是一系列的适配器，通过最方便的用例和实体转换数据格式，最方便的外部代理格式有数据库或者Web等。在这一层，举个例子，将会完整包含 GUI 的 MVC 架构。Presenters、Views、 Controllers 都属于这里。Models有可能仅仅是数据结构，它们从 contrllers 被传入到用例中，然后从用例到 presenters 和 views。</p>
<p>同样的，在这一层，数据会被转换，从最方便的方式如实体和用例，转换到使用的用于持久框架的最方便的方式，即数据库。<br>这个圆中没有代码可以向内知道任何关于数据库的东西。如果数据库是一个 SQL database，那么所有 SQL 应该在这一层被限制，特别是在这一层需要进行数据库操作的部分。</p>
<p>在这一层也有必要从一些外部形式去转换数据，比如一个外部服务，转化为内部用例和实体使用的形式。</p>
<h2 id="框架和驱动"><a href="#框架和驱动" class="headerlink" title="框架和驱动"></a>框架和驱动</h2><p>最外层通常是框架和工具，通常是数据库、Web 框架等的组合。通常你不需要在这一层编写太多的代码，除了一些用于向内圈进行通信的固定代码。</p>
<p>这一层是所有细节走向的地方。Web是一个细节。数据库是一个细节。我们把这些东西放置在外部，这样它们就难以造成伤害。</p>
<h2 id="只有四个圆？"><a href="#只有四个圆？" class="headerlink" title="只有四个圆？"></a>只有四个圆？</h2><p>不，这些圆只是简图。你可能会需要多于这四个圆。这里并没有一个规则来让你必须要使用这四个圆。然而，<em>依赖规则</em> 总是适用的。代码依赖总是指向内部。当你向内移动时，抽象级别增加。最外层的圆是最低级别的具体细节。当你向内移动，就会变得更加抽象和更高级别策略的封装。最内部的圆是最通用的。</p>
<h2 id="跨越边界"><a href="#跨越边界" class="headerlink" title="跨越边界"></a>跨越边界</h2><p>右下方的图是一个我们怎么去跨越圆的边界的例子。它展示了 Controllers 和 Presenters 通过下一层使用用例进行通信。注意控制流。它在controller中开始，通过用例，然后再Presenter中执行。也要注意代码的依赖。它们每一个都是向内指向用例。</p>
<p>我们通常使用 <a href="http://en.wikipedia.org/wiki/Dependency_inversion_principle" target="_blank" rel="noopener">依赖反转准则</a> 来解决这个明显的矛盾。在像Java的语言中，举个例子，我们使用了interfaces和继承关系，这样代码依赖关系控制权被反转，达到跨越边界的目的。</p>
<p>举个例子，考虑到用例需要调用Presenter。然而，这些调用必须不能是直接的，因为它会违反<em>依赖准则</em>：内部圆不能提到外部圆中的任何名字。所以我们这种情况我们会调用在内部圆中的接口（就像这里展示的 Use Case Output Port)），然后在外部圆中的Presenter去实现它。</p>
<p>同样的技术在架构的所有跨越边界的地方被使用到。我们利用动态代理的优势去创建代码依赖来达到控制反转，所以我们可以确保无论什么方向的 <em>依赖准则</em> 控制流都能有效。</p>
<h2 id="什么数据跨越边界。"><a href="#什么数据跨越边界。" class="headerlink" title="什么数据跨越边界。"></a>什么数据跨越边界。</h2><p>典型的跨越边界的数据就是简单的数据结构。如果你喜欢你可以使用基本结构或者简单的数据传输对象。或者是方法调用时的简单的参数数据。或者你可以把它放进一个HashMap，或者构建它到一个对象中。重要的是分离的、简单的数据结构跨越过边界。我们不希望去欺骗并传递 <em>Entities</em> 或者数据库的行。我们不希望数据结构有任何的违反 <em>依赖准则</em> 的依赖。</p>
<p>举个例子，很多数据库框架通过一个查询返回一个方便的数据形式的响应。我们可能称它为一个RowStructure。我们不希望这个行结构向内跨越边界。这将违反 <em>依赖准则</em> 因为这将强制一个内部圆去知道外部圆的一些东西。</p>
<p>所以当我们跨越边界传递数据时，它对于内圆来说总是以最方便的形式的。</p>
<p>遵守这些简单的规则并不难，前进的道路上会解决很多头疼的事情。通过分离软件到不同层次，并遵守 <em>依赖准则</em> ，你将会创建一个本质上可测试的系统，这意味这所有的好处。当任何系统外置的部分变得过时，就像数据库，或者web框架，你可以在最小的改动下替换这些外置元素。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/02/16/Android-Dagger2Metrics-测量DI图表初始化的性能（翻译）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/02/16/Android-Dagger2Metrics-测量DI图表初始化的性能（翻译）/" itemprop="url">[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-02-16T17:39:00+08:00">
                2016-02-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/02/16/Android-Dagger2Metrics-测量DI图表初始化的性能（翻译）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/02/16/Android-Dagger2Metrics-测量DI图表初始化的性能（翻译）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a>
</strong></font>

<h1 id="Dagger2Metrics-测量DI图表初始化的性能"><a href="#Dagger2Metrics-测量DI图表初始化的性能" class="headerlink" title="Dagger2Metrics - 测量DI图表初始化的性能"></a>Dagger2Metrics - 测量DI图表初始化的性能</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/dagger2metrics-measure-performance-of-graph-initialization/" target="_blank" rel="noopener">http://frogermcs.github.io/dagger2metrics-measure-performance-of-graph-initialization/</a></p>
</blockquote>
<p>几个月前我们通过 <a href="http://frogermcs.github.io/dagger-graph-creation-performance/" target="_blank" rel="noopener">Dagger 2 - graph creation performance</a> 经历了一些可能会遇到的问题。多亏 <a href="http://tools.android.com/tips/traceview" target="_blank" rel="noopener">TraceView</a> 这个工具我们可以很确切地看到初始化所有需要的依赖需要多少时间。但是这并不简单 - 我们必须要在我们代码中找出需要开始和停止测量的地方，然后在Android Studio中dump和分析它们。为了让它变得更简单，我们准备了一个简单的库，它可以帮助我们捕捉潜在的性能问题。</p>
<h2 id="Dagger2Metrics"><a href="#Dagger2Metrics" class="headerlink" title="Dagger2Metrics"></a>Dagger2Metrics</h2><h3 id="Dagger-2-初始化过程的性能测量库"><a href="#Dagger-2-初始化过程的性能测量库" class="headerlink" title="Dagger 2 初始化过程的性能测量库"></a>Dagger 2 初始化过程的性能测量库</h3><p><em>下面的描述内容是从 Dagger2Metrics Github <a href="https://github.com/frogermcs/dagger2metrics" target="_blank" rel="noopener">项目网站</a>拷贝过来的。</em></p>
<p>如果你在Android应用中使用Dagger 2来进行依赖注入，你可能知道它最大的一处优化就是Google（原来是Square）的优秀工程师通过使用非反射代码实现。</p>
<p>即使有了所有的这些优化以及完全的非动态代码生成，但是仍然有潜在的性能问题隐藏在我们的代码中和所有通过Dagger 2注入的第三方代码中。</p>
<p>性能的问题通常是慢慢地变慢的，所以在每天的开发中是很难意识到我们的app（或者Activity、或者其他View）启动50ms或者更长。又一次变成150ms，又一次变成100ms…</p>
<p>使用Dagger2Metrics，你将可以看到初始化所有需要的依赖需要多少时间（以及这些依赖之间的依赖关系）。</p>
<p><img src="https://raw.githubusercontent.com/frogermcs/dagger2metrics/master/art/dagger2metrics.png" alt=""></p>
<h3 id="准备开始"><a href="#准备开始" class="headerlink" title="准备开始"></a>准备开始</h3><p>在你的<code>build.gradle</code>中：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">  repositories &#123;</span><br><span class="line">    jcenter()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dependencies &#123;</span><br><span class="line">    classpath <span class="string">'com.frogermcs.dagger2metrics:dagger2metrics-plugin:0.2'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.android.application'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'com.frogermcs.dagger2metrics'</span></span><br></pre></td></tr></table></figure>
<p>在你的<code>Application</code>类中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">super</span>.onCreate();</span><br><span class="line">     <span class="comment">//Use it only in debug builds</span></span><br><span class="line">     <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">         Dagger2Metrics.enableCapturing(<span class="keyword">this</span>);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这样就完成了。在你的app中，你将会看到notification，它可以打开所有已完成的初始化的一个简单的概述。</p>
<p><img src="https://raw.githubusercontent.com/frogermcs/dagger2metrics/master/art/dagger2metrics-notification.png" alt=""></p>
<h3 id="它是怎么工作的？"><a href="#它是怎么工作的？" class="headerlink" title="它是怎么工作的？"></a>它是怎么工作的？</h3><p>Dagger2Metrics会捕捉所有的初始化，通过 - 所有带有 <code>@Module</code> -&gt; <code>@Provides</code> 注解的方法和<code>@Inject</code>注解的构造方法。</p>
<p>总之，你会看到大多数顶级注入依赖地依赖关系树。每一个依赖显示了提供这些对象到Dagger 2对象图表需要多少时间（构建本身所用时间以及所有的依赖）。</p>
<p><img src="https://raw.githubusercontent.com/frogermcs/dagger2metrics/master/art/dagger2metrics.png" alt=""></p>
<h3 id="为什么我看不到所有（子）依赖？"><a href="#为什么我看不到所有（子）依赖？" class="headerlink" title="为什么我看不到所有（子）依赖？"></a>为什么我看不到所有（子）依赖？</h3><p>测量树不会显示那些已经提供给Dagger图表的依赖，所以只有从头开始构建的才会显示出来。主要是因为可读性以及另外一个简单的理由就是 - 我们不想在大多数没有错误的情况下去测量Dagger 2的性能。我们应该确保我们的代码尽可能快地提供依赖。</p>
<h3 id="自定义"><a href="#自定义" class="headerlink" title="自定义"></a>自定义</h3><p>Dagger2Metrics 有3种默认级别的警告：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Dagger2Metrics.WARNING_1_LIMIT_MILLIS // 30ms</span><br><span class="line">Dagger2Metrics.WARNING_2_LIMIT_MILLIS // 50ms</span><br><span class="line">Dagger2Metrics.WARNING_3_LIMIT_MILLIS // 100ms</span><br></pre></td></tr></table></figure>
<p>你可以根据你的需要对它们进行调整。</p>
<h3 id="例子app"><a href="#例子app" class="headerlink" title="例子app"></a>例子app</h3><p>你可以查看 <a href="https://github.com/frogermcs/githubclient" target="_blank" rel="noopener">GithubClient</a> 项目 - 一个展示怎么使用Dagger 2的Android app的例子。最近的版本在debug build中使用了Dagger2Metrics。</p>
<h3 id="更多关于Dagger-2"><a href="#更多关于Dagger-2" class="headerlink" title="更多关于Dagger 2"></a>更多关于Dagger 2</h3><p>如果你刚开始接触Dagger 2，下面的资源列表可以帮助你：</p>
<p><a href="https://github.com/frogermcs/githubclient" target="_blank" rel="noopener">GithubClient</a> - 基于Dagger 2依赖注入框架的Github API 客户端实现的例子。</p>
<p>Blog posts：</p>
<ul>
<li><a href="http://frogermcs.github.io/dagger-1-to-2-migration/" target="_blank" rel="noopener">Dagger 1 to 2 migration process</a></li>
<li><a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-introdution-to-di/" target="_blank" rel="noopener">Introdution to Dependency Injection</a></li>
<li><a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-the-api/" target="_blank" rel="noopener">Dagger 2 API</a></li>
<li><a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-custom-scopes/" target="_blank" rel="noopener">Dagger 2 - custom scopes</a></li>
<li><a href="http://frogermcs.github.io/dagger-graph-creation-performance/" target="_blank" rel="noopener">Dagger 2 - graph creation performance</a></li>
</ul>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3><p>以上描述的完整代码可见Github <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">repository</a>。</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/01/04/Android-使用Dagger-2依赖注入-图表创建的性能（翻译）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/04/Android-使用Dagger-2依赖注入-图表创建的性能（翻译）/" itemprop="url">[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-01-04T14:55:00+08:00">
                2016-01-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/01/04/Android-使用Dagger-2依赖注入-图表创建的性能（翻译）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/01/04/Android-使用Dagger-2依赖注入-图表创建的性能（翻译）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a>
</strong></font>

<h1 id="使用Dagger-2依赖注入-图表创建的性能"><a href="#使用Dagger-2依赖注入-图表创建的性能" class="headerlink" title="使用Dagger 2依赖注入 - 图表创建的性能"></a>使用Dagger 2依赖注入 - 图表创建的性能</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/dagger-graph-creation-performance/" target="_blank" rel="noopener">http://frogermcs.github.io/dagger-graph-creation-performance/</a></p>
</blockquote>
<p><a href="https://twitter.com/search?q=%23perfmatters" target="_blank" rel="noopener">#PerfMatters</a> - 最近非常流行标签，尤其在Android世界中。不管怎样，apps只需要正常工作就可以的时代已经过去了。现在所有的一切都应该是令人愉悦的，流畅并且快速。举个例子，Instagram <a href="http://instagram-engineering.tumblr.com/post/97740520316/betterandroid" target="_blank" rel="noopener">花费了半年的时间</a> 只是让app更加快速，更加美观，和更好的屏幕适配性。</p>
<p>这就是为什么今天我想去分享给你一些小的建议，它会在你app启动时间上有很大的影响（尤其是当app使用了一些额外库的时候）。</p>
<h2 id="对象图表的创建"><a href="#对象图表的创建" class="headerlink" title="对象图表的创建"></a>对象图表的创建</h2><p>大多情况下，在app开发过程中，它的启动时间或多或少会增加。有时随着一天天地开发它是很难被注意到的，但是当你把第一个版本和你能找到的最近的版本比较时区别就会相对比较大了。</p>
<p>原因很可能就在于dagger对象图表的创建过程。</p>
<p>Dagger 2？你可能会问，确切地说 - 就算你移除了那些基于反射的实现方案，并且你的代码是在编译时期生成的，但是别忘了对象的创建仍然发生是在运行时。</p>
<p>对象（还有它的依赖）会在第一次被注入时创建。Jake Wharton 在Dagger 2演示中的一些幻灯片很清楚地展示了这一点：</p>
<p>以下表示在我们的 <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">GithubClient</a> 例子app中它是怎样的：</p>
<p>1. App第一次（被kill之后）被启动。Application对象并没有<code>@Inject</code>属性，所以只有<code>AppComponent</code>对象被创建。<br>2. App创建了<code>SplashActivity</code> - 它有两个<code>@Inject</code>属性：<code>AnalyticsManager</code>和<code>SplashActivityPresenter</code>。<br>3. <code>AnalyticsManager</code>依赖已被创建的<code>Application</code>对象。所以只有<code>AnalyticsManager</code>构造方法被调用。<br>4. <code>SplashSctivityPresenter</code>依赖：<code>SplashActivity</code>，<code>Validator</code>和<code>UserManager</code>。<code>SplashActivity</code>已被提供，<code>Validator</code>和<code>UserManager</code>应该被创建。<br>5. <code>UserManager</code>依赖需要被创建的<code>GithubApiService</code>。之后<code>UserManager</code>被创建。<br>6. 现在我们拥有了所有依赖，<code>SplashActivityPresenter</code>被创建。</p>
<p><img src="http://frogermcs.github.io/images/18/graph.png" alt=""></p>
<p>有点混乱，但是就结果来说，在<code>SplashActivity</code>被创建之前（我们假设对象注入的操作只会在<code>onCreate()</code>方法中执行）我们必须要等待以下构造方法（可选配置）：</p>
<ul>
<li><code>GithubApiService</code>（它也使用了一些依赖，如<code>OkHttpClient</code>，一个<code>RestAdapter</code>）</li>
<li><code>UserManager</code></li>
<li><code>Validator</code></li>
<li><code>SplashActivityPresenter</code></li>
<li><code>AnalyticsManager</code></li>
</ul>
<p>一个接一个地被创建。</p>
<p>嘿，别担心，更复杂地图表也几乎被立即创建。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>现在让我们想象下，我们有两个外部的库需要在app启动时被初始化（比如，Crashlytics, Mixpanel, Google Analytics, Parse等等）。想象下我们的<code>HeavyExternalLibrary</code>看起来如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeavyExternalLibrary</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> initialized = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HeavyExternalLibrary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        initialized = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!initialized) <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Call init() before you use this library"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单说 - 构造方法是空的，并且调用几乎不花费任何东西。但是有一个<code>init()</code>方法，它耗时500ms并且在我们使用这个库之前必须要被调用。确保在我们module的某处的某一时刻调用了<code>init()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AppModule</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="function">HeavyExternalLibrary <span class="title">provideHeavyExternalLibrary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HeavyExternalLibrary heavyExternalLibrary = <span class="keyword">new</span> HeavyExternalLibrary();</span><br><span class="line">    heavyExternalLibrary.init();</span><br><span class="line">    <span class="keyword">return</span> heavyExternalLibrary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们的<code>HeavyExternalLibrary</code>成为了<code>SplashActivityPresenter</code>的一部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="meta">@ActivityScope</span></span><br><span class="line">SplashActivityPresenter</span><br><span class="line">provideSplashActivityPresenter(Validator validator, UserManager userManager, HeavyExternalLibrary heavyExternalLibrary) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SplashActivityPresenter(splashActivity, validator, userManager, heavyExternalLibrary);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后会发生什么？我们app启动时间需要500ms还多，只是因为<code>HeavyExternalLibrary</code>的初始化，这过程会在SplashActivityPresenter依赖图表创建中执行。</p>
<h2 id="测量"><a href="#测量" class="headerlink" title="测量"></a>测量</h2><p>Android SDK（Android Studio本身）给我们提供了一个随着应用执行的时间的可视化的工具 - <a href="http://tools.android.com/tips/traceview" target="_blank" rel="noopener">Traceview</a>。多亏这个我们可以看见每个方法花了多少时间，并且找出注入过程中的瓶颈。</p>
<p>顺便说一下，如果你以前没有见过它，可以在<a href="http://blog.udinic.com/2015/09/15/speed-up-your-app/" target="_blank" rel="noopener">Udi Cohen的博客</a>看下这篇Android性能优化相关的文章。</p>
<p>Traceview可以直接从Android Studio（Android Monitor tab -&gt; CPU -&gt; Start/Stop Method Tracing）启动，它有时并不是那么精确的，尤其是当我们尝试在app启动时点击<code>Start</code>。</p>
<p>对于我们而言，幸运的是当我们知道确切的需要被测量的代码位置时，有一个可以使用的方法。<a href="http://developer.android.com/reference/android/os/Debug.html#startMethodTracing(java.lang.String)" target="_blank" rel="noopener">Debug.startMethodTracing()</a>可以用来指定我们代码中需要被启动测量的位置。<code>Debug.stopMethodTracing()</code>停止追踪并且创建一个新的文件。</p>
<p>为了实践，我们测量了SplashActivity的注入过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupActivityComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Debug.startMethodTracing(<span class="string">"SplashTrace"</span>);</span><br><span class="line">    GithubClientApplication.get(<span class="keyword">this</span>)</span><br><span class="line">            .getAppComponent()</span><br><span class="line">            .plus(<span class="keyword">new</span> SplashActivityModule(<span class="keyword">this</span>))</span><br><span class="line">            .inject(<span class="keyword">this</span>);</span><br><span class="line">    Debug.stopMethodTracing();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>setupActivityComponent()</code>是在<code>onCreate()</code>中调用的。</p>
<p>文档结果被保存在<code>/sdcard/SplashTrace.trace</code>中。</p>
<p>在你的terminal中把它pull出来：</p>
<p><code>$ adb pull /sdcard/SplashTrace.trace</code></p>
<p>现在阅读这个文件所要做的全部事情只是把它拖拽到Android Studio：</p>
<p><img src="http://frogermcs.github.io/images/18/trace.png" alt=""></p>
<p>你应该会看到类似以下的东西：</p>
<p><img src="http://frogermcs.github.io/images/18/traceview.png" alt=""></p>
<p>当然，我们这个例子中的结果是非常清晰的：<code>AppModule_ProvideHeavyExternalLibraryFactory.get()</code>（HeavyExternalLibrary被创建的地方）花费了500ms。</p>
<p>真正好玩的地方是，缩放trace尾部的那一小块地方：</p>
<p><img src="http://frogermcs.github.io/images/18/traceview2.png" alt=""></p>
<p>看到不同之处了吗？比如构建类：<code>AnalyticsManager</code>花了小于1ms。</p>
<p>如果你想看到它，这里有这个例子中的<a href="https://github.com/frogermcs/frogermcs.github.io/raw/master/files/18/SplashTrace.trace" target="_blank" rel="noopener">SplashTrace.trace</a>文件。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>不幸的是，对于这类性能问题，有时并没有明确的回答。这里有两种方式会给我们很大的帮助。</p>
<h3 id="懒加载（临时的解决方案）"><a href="#懒加载（临时的解决方案）" class="headerlink" title="懒加载（临时的解决方案）"></a>懒加载（临时的解决方案）</h3><p>首先，我们要思考是否你需要所有的注入依赖。也许其中一部分可以延迟一定时间后再加载？当然这并不解决真正的问题（UI线程将会在第一次调用Lazy&lt;&gt;.get()方法的时候阻塞）。但是在某些情况下对启动耗时有帮助（尤其是很少地方会使用到的一些对象）。查看<a href="http://google.github.io/dagger/api/2.0/dagger/Lazy.html" target="_blank" rel="noopener">Lazy&lt;&gt;</a>接口文档获取更多的信息和例子代码。</p>
<p>简单说，每一个你使用<code>@Inject SomeClass someClass</code>的地方都可以替换成<code>@Inject Lazy&lt;SomeClass&gt; someClassLazy</code>（构造方法注入也是）。然后获取某个类的实例时必须要调用<code>someClassLazy.get()</code>。</p>
<h3 id="异步对象创建"><a href="#异步对象创建" class="headerlink" title="异步对象创建"></a>异步对象创建</h3><p>第二种选择（它仍然只是更多的想法而不是最终的解决方案）是在后台线程中的某处进行对象的初始化，缓存所有方法的调用并在初始化之后再回调它们。</p>
<p>这种方案的缺点是它必须要单独地准备我们要包含的所有类。并且它只有在方法调用可以被执行的将来（就像任何的analytics - 在一些事件被发生之后才可以），这些对象才可能正常工作。</p>
<p>以下就是我们的<code>HeavyExternalLibrary</code>使用这种解决方案后的样子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeavyLibraryWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HeavyExternalLibrary heavyExternalLibrary;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isInitialized = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    ConnectableObservable&lt;HeavyExternalLibrary&gt; initObservable;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HeavyLibraryWrapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        initObservable = Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> HeavyExternalLibrary&gt; subscriber)</span> </span>&#123;</span><br><span class="line">                HeavyLibraryWrapper.<span class="keyword">this</span>.heavyExternalLibrary = <span class="keyword">new</span> HeavyExternalLibrary();</span><br><span class="line">                HeavyLibraryWrapper.<span class="keyword">this</span>.heavyExternalLibrary.init();</span><br><span class="line">                subscriber.onNext(heavyExternalLibrary);</span><br><span class="line">                subscriber.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()).publish();</span><br><span class="line"></span><br><span class="line">        initObservable.subscribe(<span class="keyword">new</span> SimpleObserver&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(HeavyExternalLibrary heavyExternalLibrary)</span> </span>&#123;</span><br><span class="line">                isInitialized = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        initObservable.connect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isInitialized) &#123;</span><br><span class="line">            HeavyExternalLibrary.callMethod();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            initObservable.subscribe(<span class="keyword">new</span> SimpleObserver&lt;HeavyExternalLibrary&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(HeavyExternalLibrary heavyExternalLibrary)</span> </span>&#123;</span><br><span class="line">                    heavyExternalLibrary.callMethod();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当<code>HeavyLibraryWrapper</code>构造方法被调用，库的初始化会在后台线程（这里的<code>Schedulers.io()</code>）中执行。在此期间，当用户调用<code>callMethod()</code>，它会增加一个新的subscription到我们的初始化过程中。当它完成时（onNext()方法返回一个已初始化的HeavyExternalLibrary对象）被缓存的回调会被传送到这个对象。</p>
<p>目前为止，这个想法还是非常简单并且仍然是在开发之中。这里可能会引起内存泄漏（比如，我们不得不在callMethod()方法中传入一些参数），但一般还是适用于简单的情况下的。</p>
<h3 id="还有其它方案？"><a href="#还有其它方案？" class="headerlink" title="还有其它方案？"></a>还有其它方案？</h3><p>性能优化的过程是非常孤独的。但是如果你想要分享你的ideas，请在这里分享吧。</p>
<p>感谢你的阅读！</p>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3><p>以上描述的完整代码可见Github <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">repository</a>。</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2016/01/02/Android-使用Dagger-2依赖注入-自定义Scope（翻译）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/02/Android-使用Dagger-2依赖注入-自定义Scope（翻译）/" itemprop="url">[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-01-02T22:21:00+08:00">
                2016-01-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/01/02/Android-使用Dagger-2依赖注入-自定义Scope（翻译）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/01/02/Android-使用Dagger-2依赖注入-自定义Scope（翻译）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a>
</strong></font>

<h1 id="使用Dagger-2依赖注入-自定义Scope"><a href="#使用Dagger-2依赖注入-自定义Scope" class="headerlink" title="使用Dagger 2依赖注入 - 自定义Scope"></a>使用Dagger 2依赖注入 - 自定义Scope</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-custom-scopes/" target="_blank" rel="noopener">http://frogermcs.github.io/dependency-injection-with-dagger-2-custom-scopes/</a></p>
</blockquote>
<p>这章是展示使用Dagger 2在Android端实现依赖注入的系列中的一部分。今天我会花点时间在自定义Scope（作用域）上面 - 它是很实用，但是对于刚接触依赖注入的人会有一点困难。</p>
<h2 id="Scope-它给我们带来了什么？"><a href="#Scope-它给我们带来了什么？" class="headerlink" title="Scope - 它给我们带来了什么？"></a>Scope - 它给我们带来了什么？</h2><p>几乎所有的项目都会用到单例 - 比如API clients，database helpers，analytics managers等。因为我们不需要去关心实例化（由于依赖注入），我们不应该在我们的代码中考虑关于怎么得到这些对象。取而代之的是<code>@Inject</code>注解应该提供给我们适合的实例。</p>
<p>在Dagger 2中，Scope机制可以使得在scope存在时保持类的单例。在实践中，这意味着被限定范围为<code>@ApplicationScope</code>的实例与Applicaiton对象的生命周期一致。<code>@ActivityScope</code>保证引用与Activity的生命周期一致（举个例子我们可以在这个Activity中持有的所有fragment之间分享一个任何类的单例）。</p>
<p>简单来说 - scope给我们带来了“局部单例”，生命周期取决于scope自己。</p>
<p>但是需要弄清楚的是 - Dagger 2默认并不提供<code>@ActivityScope</code> 或者/并且 <code>@ApplicationScope</code> 这些注解。这些只是最常用的自定义Scope。只有<code>@Singleton</code> scope是默认提供的（由Java自己提供）。</p>
<h2 id="Scope-实践案例"><a href="#Scope-实践案例" class="headerlink" title="Scope - 实践案例"></a>Scope - 实践案例</h2><p>为了更好地去理解Dagger 2中的scope，我们直接进入实践案例。我们将要去实现比Application/Activity scope更加复杂一点的scope。为此我们将使用 <a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-the-api/" target="_blank" rel="noopener">上一文章</a> 中的 <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">GithubClient</a> 例子。我们的app应需要三种scope：</p>
<ul>
<li><strong>@Sigleton</strong> - application scope</li>
<li><strong>@UserScope</strong> - 用于与被选中的用户联系起来的类实例的scope（在真实的app中可以是当前登录的用户）。</li>
<li><strong>@ActivityScope</strong> - 生命周期与Activity（在我们例子中的呈现者）一致的实例的scope</li>
</ul>
<p>讲解的<code>@UserScope</code>是今天方案与以前文章之间的主要的不同之处。从用户体验的角度来说它没有带给我们任何东西，但是从架构的观点来说它帮助我们在不传入任何意图参数的情况下提供了User实例。使用方法参数获取用户数据的类（在我们的例子中是<code>RepositoriesManager</code>）中我们可以通过构造参数（它将通过依赖图表提供）的方式来获取User实例并在需要的时候被初始化，而不是在app启动的时候创建它。这意味着<code>RepositoriesManager</code>可以在我们从Github API获取到用户信息（在<code>RepositoriesListActivity</code>呈现之前）之后被创建。</p>
<p>这里有个我们app中scopes和components呈现的简单图表。</p>
<p><img src="http://frogermcs.github.io/images/15/dagger-scopes.png" alt=""></p>
<p>单例（Application scope）是最长的scope（在实践中是与application一样长）。UserScope作为Application scope的一个子集scope，它可以访问它的对象（我们可以从父scope中得到对象）。ActivityScope（生命周期与Activity一致）也是如此 - 它可以从UserScope和ApplicationScope中得到对象。</p>
<h2 id="Scope生命周期的例子"><a href="#Scope生命周期的例子" class="headerlink" title="Scope生命周期的例子"></a>Scope生命周期的例子</h2><p>这里有一个我们app中scope生命周期的案例：</p>
<p><img src="http://frogermcs.github.io/images/15/scopes-lifecycle.png" alt=""></p>
<p>单例的生命周期是从app启动后的所有的时期，当我们从Github API（在真实app中是用户登录之后）得到了<code>User</code>实例时UserScope被创建了，然后当我们回退到SplashActivity（在真实app中是用户退出之后）时被销毁。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>在Dagger 2中，Scope的实现归结于对Components的一个正确的设置。一般情况下我们有两种方式 - 使用<code>Subcomponent</code>注解或者使用Components依赖。它们两者最大的区别就是对象图表的共享。Subcomponents可以访问它们parent的所有对象图表，而Component依赖只能访问通过Component接口暴露的对象。</p>
<p>我选择第一种使用 <code>@Subcomponent</code> 注解，如果你之前使用过Dagger 1，它几乎与从<code>ObjectGraph</code>创建一个subgraphs（子图表）是一样的。此外，对于创建一个subgraphs的方法我们会使用类似的命名法则（但这不是强制性的）。</p>
<p>我们从<code>AppComponent</code>的实现开始：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component</span>(</span><br><span class="line">        modules = &#123;</span><br><span class="line">                AppModule.class,</span><br><span class="line">                GithubApiModule.class</span><br><span class="line">        &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">UserComponent <span class="title">plus</span><span class="params">(UserModule userModule)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">SplashActivityComponent <span class="title">plus</span><span class="params">(SplashActivityModule splashActivityModule)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它将会是其它subcomponents的根Components：<code>UserComponent</code>和Activities Components。正如你注意到的那样（尤其如果你在前面的文章中看过的<a href="https://github.com/frogermcs/GithubClient/blob/1bf53a2a36c8a85435e877847b987395e482ab4a/app/src/main/java/frogermcs/io/githubclient/AppComponent.java" target="_blank" rel="noopener">AppComponent 实现</a>）所有的返回依赖图表对象的公开方法全部消失了。因为我们有subcomponents了，我们不需要去公开去暴露依赖了 - 无论如何subgraphs都可以访问它们全部了。</p>
<p>作为替代，我们新增了两个方法：</p>
<ul>
<li><code>UserComponent plus(UserModule userModule);</code></li>
<li><code>SplashActivityComponent plus(SplashActivityModule splashActivityModule);</code></li>
</ul>
<p>这表示，我们可以从<code>AppComponent</code>创建两个子Components（subcomponents）：<code>UserComponent</code>和<code>SplashActivityComponent</code>。因为它们都是AppComponent的subcomponents，所以它们两者都可以访问<code>AppModule</code>和<code>GithubApiModule</code>创建的实例。</p>
<p><em>这些方法的命名法则是：返回类型是subcomponent类，方法名字随意，参数是这个subcomponent需要的modules。</em></p>
<p>如你所见，<code>UserComponent</code>需要另一个module（它通过<code>plus()</code>方法的参数传入）。这样，我们通过增加一个新的用于生成对象的module，继承<code>AppComponent</code>图表。<code>UserComponent</code>类看起来这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UserScope</span></span><br><span class="line"><span class="meta">@Subcomponent</span>(</span><br><span class="line">        modules = &#123;</span><br><span class="line">                UserModule.class</span><br><span class="line">        &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line">    <span class="function">RepositoriesListActivityComponent <span class="title">plus</span><span class="params">(RepositoriesListActivityModule repositoriesListActivityModule)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">RepositoryDetailsActivityComponent <span class="title">plus</span><span class="params">(RepositoryDetailsActivityModule repositoryDetailsActivityModule)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然<code>@UserScope</code>注解是我们自己创建的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scope</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> UserScope &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以从<code>UserComponent</code>创建另外两个subcomponents：<code>RepositoriesListActivityComponent</code>和<code>RepositoryDetailsActivityComponent</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UserScope</span></span><br><span class="line"><span class="meta">@Subcomponent</span>(</span><br><span class="line">        modules = &#123;</span><br><span class="line">                UserModule.class</span><br><span class="line">        &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line">    <span class="function">RepositoriesListActivityComponent <span class="title">plus</span><span class="params">(RepositoriesListActivityModule repositoriesListActivityModule)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">RepositoryDetailsActivityComponent <span class="title">plus</span><span class="params">(RepositoryDetailsActivityModule repositoryDetailsActivityModule)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并且更重要的是所有scope的东西都发生在这里。所有<code>UserComponent</code>中从<code>AppComponent</code>继承过来的仍然shi是单例的（是 Applicaton scope）。但是<code>UserModule</code>（<code>UserComponent</code>的那部分）创建的对象将会是“局部单例”，它的生命周期跟<code>UserComponent</code>实例是一样的。</p>
<p>所以，每次一创建另一个<code>UserComponent</code>实例将会调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UserComponent appComponent = appComponent.plus(<span class="keyword">new</span> UserModule(user))</span><br></pre></td></tr></table></figure>
<p>从<code>UserModule</code>中获取的对象将是不同的实例。</p>
<p>但是这里很重要的一点是 - 我们要负责<code>UserComponent</code>的生命周期。所以我们应该关心它的初始化和释放。在我们的例子中，我为它增加了两个额外的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GithubClientApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AppComponent appComponent;</span><br><span class="line">    <span class="keyword">private</span> UserComponent userComponent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserComponent <span class="title">createUserComponent</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userComponent = appComponent.plus(<span class="keyword">new</span> UserModule(user));</span><br><span class="line">        <span class="keyword">return</span> userComponent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">releaseUserComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        userComponent = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>createUserComponent()</code>方法会在我们从Github API（在<code>SplashActivity</code>中）获取到<code>User</code>对象时调用。<code>releaseUserComponent()</code>方法会在我们从<code>RepositoriesListActivity</code>（这个时候我们不再需要user scope了）中返回时调用。</p>
<h2 id="Dagger-2中的Scope-内部实现"><a href="#Dagger-2中的Scope-内部实现" class="headerlink" title="Dagger 2中的Scope - 内部实现"></a>Dagger 2中的Scope - 内部实现</h2><p>查看它的内部的工作原理是很不错的。通常在这种情况下可以确定，在Dagger 2的scope机制下并不存在什么魔法。</p>
<p>我们从<code>UserModule.provideRepositoriesManager()</code>方法开始研究。它提供了<code>RepositoriesManager</code>实例，它应该使用<code>@UserScope</code>Scope。我们来检验这个方法哪里被调用（第8行）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Generated</span>(<span class="string">"dagger.internal.codegen.ComponentProcessor"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule_ProvideRepositoriesManagerFactory</span> <span class="keyword">implements</span> <span class="title">Factory</span>&lt;<span class="title">RepositoriesManager</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RepositoriesManager <span class="title">get</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    RepositoriesManager provided = <span class="keyword">module</span>.provideRepositoriesManager(userProvider.get(), githubApiServiceProvider.get());</span><br><span class="line">    <span class="keyword">if</span> (provided == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Cannot return null from a non-@Nullable @Provides method"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> provided;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Factory&lt;RepositoriesManager&gt; <span class="title">create</span><span class="params">(UserModule <span class="keyword">module</span>, Provider&lt;User&gt; userProvider, Provider&lt;GithubApiService&gt; githubApiServiceProvider)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UserModule_ProvideRepositoriesManagerFactory(<span class="keyword">module</span>, userProvider, githubApiServiceProvider);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>UserModule_ProvideRepositoriesManagerFactory</code>仅仅是一个工厂模式的现实，它从<code>UserModule</code>中获取到<code>RepositoriesManager</code>实例。我们应该往更深层次挖掘。</p>
<p><code>UserModule_ProvideRepositoriesManagerFactory</code>在<code>UserComponentImpl</code>中被使用 - 我们component的实现（line 15）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UserComponentImpl</span> <span class="keyword">implements</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">UserComponentImpl</span><span class="params">(UserModule userModule)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (userModule == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.userModule = userModule;</span><br><span class="line">      initialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.provideUserProvider = ScopedProvider.create(UserModule_ProvideUserFactory.create(userModule));</span><br><span class="line">      <span class="keyword">this</span>.provideRepositoriesManagerProvider = ScopedProvider.create(UserModule_ProvideRepositoriesManagerFactory.create(userModule, provideUserProvider, DaggerAppComponent.<span class="keyword">this</span>.provideGithubApiServiceProvider));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>provideRepositoriesManagerProvider</code>对象在我们每次请求它时负责提供<code>RepositoriesManager</code>实例。如我们所见，provider是通过<code>ScopedProvider</code>实现的。来看下它的部分代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ScopedProvider</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Provider</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">ScopedProvider</span><span class="params">(Factory&lt;T&gt; factory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> factory != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.factory = factory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) <span class="comment">// cast only happens when result comes from the factory</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// double-check idiom from EJ2: Item 71</span></span><br><span class="line">    Object result = instance;</span><br><span class="line">    <span class="keyword">if</span> (result == UNINITIALIZED) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        result = instance;</span><br><span class="line">        <span class="keyword">if</span> (result == UNINITIALIZED) &#123;</span><br><span class="line">          instance = result = factory.get();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (T) result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再简单不过了吧？第一次调用<code>ScopedProvider</code>从factory（我们的例子中是<code>UserModule_ProvideRepositoriesManagerFactory</code>）中获取实例并像单例模式一样存储起来。我们的scoped provider只是<code>UserComponentImpl</code>中的一个属性，所以简单说就是<code>ScopedProvider</code>返回一个与依赖于Component的单例。</p>
<p>在这里你可以查看 <a href="https://github.com/google/dagger/blob/master/core/src/main/java/dagger/internal/ScopedProvider.java" target="_blank" rel="noopener">ScopedProvider</a> 的所有的实现。</p>
<p>就是这样。我们弄清楚了Dagger 2中Scope底层是怎么工作的。现在我们知道，它们没有以任何方式于Scope注解连接。自定义注解只是给了我们一个简单的方式来进行编译时代码校验和标记一个类是单例/非单例。所有的scope相关东西都是与Component的生命周期相关联。</p>
<p>以上就是今天的全部内容。我希望从现在开始scopes会变得更加容易使用。感谢阅读！</p>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3><p>以上描述的完整代码可见Github <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">repository</a>。</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/12/31/Android-使用Dagger-2依赖注入-API（翻译）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/12/31/Android-使用Dagger-2依赖注入-API（翻译）/" itemprop="url">[Android]使用Dagger 2依赖注入 - API（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-31T18:55:00+08:00">
                2015-12-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/12/31/Android-使用Dagger-2依赖注入-API（翻译）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/12/31/Android-使用Dagger-2依赖注入-API（翻译）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a>
</strong></font>

<h1 id="使用Dagger-2依赖注入-API"><a href="#使用Dagger-2依赖注入-API" class="headerlink" title="使用Dagger 2依赖注入 - API"></a>使用Dagger 2依赖注入 - API</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-the-api/" target="_blank" rel="noopener">http://frogermcs.github.io/dependency-injection-with-dagger-2-the-api/</a></p>
</blockquote>
<p>这章是展示使用Dagger 2在Android端实现依赖注入的系列中的一部分。今天我会探索Dagger 2的基础并且学习这个依赖注入框架的所有的API。</p>
<h2 id="Dagger-2"><a href="#Dagger-2" class="headerlink" title="Dagger 2"></a>Dagger 2</h2><p>在我上一章中我提到了DI框架给我们带来了什么 - 它让只写一小部分代码就可以使一切联系在一起成为可能。Dagger 2就是DI框架的一个例子，它可以为我们生成很多模版代码。但是为什么它比其它的要更好呢？目前为止它是唯一一个可以生成完整模仿用户手写的可追踪的代码的DI框架。这意味着让依赖图表构建过程不再充满魔幻。Dagger 2相比其它是不具有动态性的（使用时完全不使用反射）但是生成的代码的简洁性和性能都是与手写的代码同水准的。</p>
<h3 id="Dagger-2-基础"><a href="#Dagger-2-基础" class="headerlink" title="Dagger 2 基础"></a>Dagger 2 基础</h3><p>下面是Dagger 2的API：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Component &#123;</span><br><span class="line">    Class&lt;?&gt;[] modules() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;?&gt;[] dependencies() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Subcomponent &#123;</span><br><span class="line">    Class&lt;?&gt;[] modules() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Module &#123;</span><br><span class="line">    Class&lt;?&gt;[] includes() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Provides &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MapKey &#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">unwrapValue</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Lazy</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还有在Dagger 2中用到的定义在 <a href="https://jcp.org/en/jsr/detail?id=330" target="_blank" rel="noopener">JSR-330</a> （Java中依赖注入的标准）中的其它元素：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Inject &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Scope &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Qualifier &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让我们来学习它们。</p>
<h4 id="Inject-注解"><a href="#Inject-注解" class="headerlink" title="@Inject 注解"></a>@Inject 注解</h4><p>DI中第一个并且是最重要的就是<code>@Inject</code>注解。JSR-330标准中的一部分，标记那些应该被依赖注入框架提供的依赖。在Dagger 2中有3种不同的方式来提供依赖：</p>
<h5 id="构造器注入："><a href="#构造器注入：" class="headerlink" title="构造器注入："></a>构造器注入：</h5><p><code>@Inject</code>使用在类的构造器上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivityPresenter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoginActivity loginActivity;</span><br><span class="line">    <span class="keyword">private</span> UserDataStore userDataStore;</span><br><span class="line">    <span class="keyword">private</span> UserManager userManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginActivityPresenter</span><span class="params">(LoginActivity loginActivity,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  UserDataStore userDataStore,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  UserManager userManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loginActivity = loginActivity;</span><br><span class="line">        <span class="keyword">this</span>.userDataStore = userDataStore;</span><br><span class="line">        <span class="keyword">this</span>.userManager = userManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有的参数都是通过依赖图表中获取。<code>@Inject</code>注解被使用在构造器中也会标记这个类为依赖图表的一部分。这意味着它也可以在我们需要的时候被注入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    LoginActivityPresenter presenter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个例子中的局限性是我们不能给这个类中的多个构造器作<code>@Inject</code>注解。</p>
<h5 id="属性注入"><a href="#属性注入" class="headerlink" title="属性注入"></a>属性注入</h5><p>另一种选择是给指定的属性作<code>@Inject</code>注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplashActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    LoginActivityPresenter presenter;</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    AnalyticsManager analyticsManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(bundle);</span><br><span class="line">        getAppComponent().inject(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是在这个例子中，注入过程必须要在我们类的某处“手动”调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplashActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(bundle);</span><br><span class="line">        getAppComponent().inject(<span class="keyword">this</span>);    <span class="comment">//Requested depenencies are injected in this moment</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个调用之前，我们的依赖是null值。</p>
<p>属性注入的局限性是我们不能使用<code>private</code>。为什么？简单说，生成的代码会直接地调用它们来设置属性，就像这里：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//This class is generated automatically by Dagger 2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SplashActivity_MembersInjector</span> <span class="keyword">implements</span> <span class="title">MembersInjector</span>&lt;<span class="title">SplashActivity</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">injectMembers</span><span class="params">(SplashActivity splashActivity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (splashActivity == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Cannot inject members into a null reference"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        supertypeInjector.injectMembers(splashActivity);</span><br><span class="line">        splashActivity.presenter = presenterProvider.get();</span><br><span class="line">        splashActivity.analyticsManager = analyticsManagerProvider.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="方法注入"><a href="#方法注入" class="headerlink" title="方法注入"></a>方法注入</h5><p>最后一种方法使用<code>@Inject</code>注解提供依赖的方式是在这个类的<code>public</code>方法中作注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivityPresenter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoginActivity loginActivity;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginActivityPresenter</span><span class="params">(LoginActivity loginActivity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loginActivity = loginActivity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enableWatches</span><span class="params">(Watches watches)</span> </span>&#123;</span><br><span class="line">        watches.register(<span class="keyword">this</span>);    <span class="comment">//Watches instance required fully constructed LoginActivityPresenter</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法的所有参数都是通过依赖图表提供的。但是为什么我们需要方法注入呢？在某些情况下会用到，如当我们希望传入类的当前实例（<code>this</code>引用）到被注入的依赖中。方法注入会在构造器调用后马上被调用，所以这表示我们可以传入完全被构造的<code>this</code>。</p>
<h4 id="Module-注解"><a href="#Module-注解" class="headerlink" title="@Module 注解"></a>@Module 注解</h4><p><code>@Module</code>是Dagger 2 API的一部分。这个注解用于标记提供依赖的类 - 多亏它Dagger才会知道某些地方需要的对象被构建。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GithubApiModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="function">OkHttpClient <span class="title">provideOkHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OkHttpClient okHttpClient = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">        okHttpClient.setConnectTimeout(<span class="number">60</span> * <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        okHttpClient.setReadTimeout(<span class="number">60</span> * <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">return</span> okHttpClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="function">RestAdapter <span class="title">provideRestAdapter</span><span class="params">(Application application, OkHttpClient okHttpClient)</span> </span>&#123;</span><br><span class="line">        RestAdapter.Builder builder = <span class="keyword">new</span> RestAdapter.Builder();</span><br><span class="line">        builder.setClient(<span class="keyword">new</span> OkClient(okHttpClient))</span><br><span class="line">               .setEndpoint(application.getString(R.string.endpoint));</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">view rawGithubApiModule.java hosted with ❤ by GitHub</span><br></pre></td></tr></table></figure>
<h4 id="Provides-注解"><a href="#Provides-注解" class="headerlink" title="@Provides 注解"></a>@Provides 注解</h4><p>这个注解用在<code>@Module</code>类中。<code>@Provides</code>会标记Module中那些返回依赖的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Module</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GithubApiModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Provides</span>   <span class="comment">//This annotation means that method below provides dependency</span></span><br><span class="line">    <span class="meta">@Singleton</span></span><br><span class="line">    <span class="function">RestAdapter <span class="title">provideRestAdapter</span><span class="params">(Application application, OkHttpClient okHttpClient)</span> </span>&#123;</span><br><span class="line">        RestAdapter.Builder builder = <span class="keyword">new</span> RestAdapter.Builder();</span><br><span class="line">        builder.setClient(<span class="keyword">new</span> OkClient(okHttpClient))</span><br><span class="line">               .setEndpoint(application.getString(R.string.endpoint));</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Component-注解"><a href="#Component-注解" class="headerlink" title="@Component 注解"></a>@Component 注解</h4><p>这个注解用在把一切联系在一起的接口上面。在这里我们可以定义从哪些module（或者哪些Components）中获取依赖。这里也可以用来定义哪些图表依赖应该公开可见（可以被注入）和哪里我们的component可以注入对象。<code>@Component</code>通常是<code>@Module</code>和<code>@Inject</code>之间的桥梁。</p>
<p>这里有个使用了两个module的<code>@Component</code>例子代码，可以注入依赖到<code>GithubClientApplication</code>，并且标记了三个依赖公开可见：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component</span>(</span><br><span class="line">    modules = &#123;</span><br><span class="line">        AppModule.class,</span><br><span class="line">        GithubApiModule.class</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(GithubClientApplication githubClientApplication)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Application <span class="title">getApplication</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">AnalyticsManager <span class="title">getAnalyticsManager</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">UserManager <span class="title">getUserManager</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@Component</code>也可以依赖其它的component，并且定义了生命周期（我会在以后的文章中讲解Scope）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ActivityScope</span></span><br><span class="line"><span class="meta">@Component</span>(      </span><br><span class="line">    modules = SplashActivityModule.class,</span><br><span class="line">    dependencies = AppComponent.class</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SplashActivityComponent</span> </span>&#123;</span><br><span class="line">    <span class="function">SplashActivity <span class="title">inject</span><span class="params">(SplashActivity splashActivity)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">SplashActivityPresenter <span class="title">presenter</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Scope-注解"><a href="#Scope-注解" class="headerlink" title="@Scope 注解"></a>@Scope 注解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scope</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ActivityScope &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JSR-330标准的又一部分。在Dagger 2中，<code>@Scope</code>被用于标记自定义的scope注解。简单说它们可以类似单例地标记依赖。被作注解的依赖会变成单例，但是这会与component的生命周期（不是整个应用）关联。但是正如我刚才所说 - 我会在下一篇文章中深入scope。现在值得一提的是所有自定义scope做的是同样的事情（从代码角度）- 它们为对象保持单例。但是他们也会被在图表认证处理中使用，这对尽可能地捕捉图表结构问题是有帮助的。</p>
<hr>
<p>接下来是一些不太重要，不会经常用到的东西：</p>
<h4 id="MapKey"><a href="#MapKey" class="headerlink" title="MapKey"></a>MapKey</h4><p>这个注解用在定义一些依赖集合（目前为止，Maps和Sets）。让例子代码自己来解释吧：</p>
<p>定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapKey</span>(unwrapValue = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@interface</span> TestKey &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>提供依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span>(type = Type.MAP)</span><br><span class="line"><span class="meta">@TestKey</span>(<span class="string">"foo"</span>)</span><br><span class="line"><span class="function">String <span class="title">provideFooKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"foo value"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Provides</span>(type = Type.MAP)</span><br><span class="line"><span class="meta">@TestKey</span>(<span class="string">"bar"</span>)</span><br><span class="line"><span class="function">String <span class="title">provideBarKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"bar value"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Inject</span></span><br><span class="line">Map&lt;String, String&gt; map;</span><br><span class="line"></span><br><span class="line">map.toString() <span class="comment">// =&gt; „&#123;foo=foo value, bar=bar value&#125;”</span></span><br></pre></td></tr></table></figure>
<p><code>@MapKey</code>注解目前只提供两种类型 - String和Enum。</p>
<h4 id="Qualifier"><a href="#Qualifier" class="headerlink" title="@Qualifier"></a>@Qualifier</h4><p><code>@Qualifier</code>注解帮助我们去为相同接口的依赖创建“tags”。想象下你需要提供两个<code>RestAdapter</code>对象 - 一个用于Github API，另一个用于Fackbook API。<code>Qualifier</code>会帮助你区分对应的一个：</p>
<p>命名依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@GithubRestAdapter</span>  <span class="comment">//Qualifier</span></span><br><span class="line"><span class="function">RestAdapter <span class="title">provideRestAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestAdapter.Builder()</span><br><span class="line">        .setEndpoint(<span class="string">"https://api.github.com"</span>)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Provides</span></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@FacebookRestAdapter</span>  <span class="comment">//Qualifier</span></span><br><span class="line"><span class="function">RestAdapter <span class="title">provideRestAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestAdapter.Builder()</span><br><span class="line">        .setEndpoint(<span class="string">"https://api.facebook.com"</span>)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注入依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Inject</span></span><br><span class="line"><span class="meta">@GithubRestAdapter</span></span><br><span class="line">RestAdapter githubRestAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Inject</span></span><br><span class="line"><span class="meta">@FacebookRestAdapter</span></span><br><span class="line">RestAdapter facebookRestAdapter;</span><br></pre></td></tr></table></figure>
<p>以上就是全部了。我们刚刚已经了解了所有Dagger 2 API中重要的元素了。</p>
<h3 id="App-example"><a href="#App-example" class="headerlink" title="App example"></a>App example</h3><p>现在是时候让我们在实践中检验我们的知识了。我们会基于Dagger 2来实现一个简单的Github客户端app。</p>
<h4 id="想法"><a href="#想法" class="headerlink" title="想法"></a>想法</h4><p>我们的Github客户端有三个Activity和非常简单的使用case。它的全部流程：</p>
<p>1. 输入Github用户名<br>2. 如果用户存在则显示它所有公开的库。<br>3. 当用户按下list的item后显示库的详情。</p>
<p>这里就是我们的app看起来的样子：</p>
<p><img src="http://frogermcs.github.io/images/14/app_flow.png" alt=""></p>
<p>在内部，从DI角度我们的app结构看起来如下：</p>
<p><img src="http://frogermcs.github.io/images/14/local_components.png" alt=""></p>
<p>简单说 - 每一个Activity都有它自己的依赖图表。每个图表（_Component类）有两个对象 - <code>_Prresenter</code>和<code>_Activity</code>。每个component也会从全局的component（<code>AppComponent</code>，包含了<code>Application</code>, <code>UserManager</code>, <code>RepositoriesManager</code>等）中获取依赖。</p>
<p><img src="http://frogermcs.github.io/images/14/app_component.png" alt=""></p>
<p>讲讲<code>AppComponent</code> - 看上面最近的图表。它包含了两个modules：<code>AppModule</code>和<code>GithubApiModule</code>。</p>
<p><code>GithubApiModule</code>提供了一些依赖，比如<code>OkHttpClient</code>或<code>RestAdapter</code>，他们只会在这个module的其它依赖使用。在Dagger 2中我们可以控制哪些对象对外部的component可见。在我们例子中我们不希望暴露这些被使用了的对象。所以我们只是暴露了<code>UserManager</code>和<code>RepositoriesManager</code>，因为这有这些对象才会被我们的Activity用到。所有都通过public、返回非void类型并无参数的方法被定义。</p>
<p>文档中的例子：</p>
<p><strong>提供依赖的方法</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SomeType <span class="title">getSomeType</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">Set&lt;SomeType&gt; <span class="title">getSomeTypes</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">@PortNumber</span> <span class="function"><span class="keyword">int</span> <span class="title">getPortNumber</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>此外，我们必须要定义哪里我们希望要去注入依赖（通过成员注入）。在我们例子中<code>AppComponent</code>没有任何地方可以去注入，因为它只是作为我们Components的依赖。所以它们每一个都被定义了 一个<code>inject(_Activity activity)</code>方法。这里我们也有一些简单的规则 - 注入通过一个单个参数的方法被定义（定义一个实例，它代表我们需要往这个实例中注入依赖），它可以有任意的名字，但是必须要返回类型是void或者返回被传入的参数类型。</p>
<p>文档中的例子：</p>
<p><strong>成员注入的方法</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SomeType <span class="title">getSomeType</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">Provider&lt;SomeType&gt; <span class="title">getSomeTypeProvider</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">Lazy&lt;SomeType&gt; <span class="title">getLazySomeType</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>我不想深入太多的代码。clone <a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">GithubClient</a> 代码并导入到最新的Android Studio。这里给出一些开始的提示：</p>
<h4 id="Dagger-2-安装"><a href="#Dagger-2-安装" class="headerlink" title="Dagger 2 安装"></a>Dagger 2 安装</h4><p>只需要获得<code>/app/build.gradle</code>文件。我们需要增加Dagger 2依赖和使用 <a href="https://bitbucket.org/hvisser/android-apt" target="_blank" rel="noopener">android-apt</a> 插件来对生成的代码和Android Studio IDE之间进行绑定。</p>
<h5 id="AppComponent"><a href="#AppComponent" class="headerlink" title="AppComponent"></a>AppComponent</h5><p>从<code>GithubClientApplication</code>类开始探索。在这里<code>AppComponent</code>会被创建和存储。这意味着所有单例的对象的生命周期都会与Applicaiton一致（所以每时每刻都是如此）。</p>
<p><code>AppComponent</code>的实现由Dagger 2（对象可以通过builder模式被创建）生成的代码提供。在这里我们也可以放入所有的Component的依赖（module和其他components）。</p>
<h5 id="限定的component"><a href="#限定的component" class="headerlink" title="限定的component"></a>限定的component</h5><p>可以通过<code>SplashActivity</code>来探索Activities Components是怎么创建的。它重写了<code>setupActivityComponent(AppComponent)</code>，在这里它创建它自己的Component（<code>SplashActivityComponent</code>），然后注入所有被做<code>@Inject</code>注解的依赖（这个例子中的<code>SplashActivityPresenter</code>和<code>AnalyticsManager</code>）。</p>
<p>在这里我们也会提供AppComponent实例（因为<code>SplashActivityComponent</code>是依赖它的）以及<code>SplashActivityModule</code>（它提供了Presenter和Activity实例）。</p>
<p>剩下的就靠你自己了。认真的说 - 尝试弄清楚一切是怎么合适地联系在一起的。下一章节我们尝试深入Dagger 2的那些紧密的元素（在底层它们是怎么工作的）。</p>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3><p>以上描述的完整代码可见Github <a href="https://github.com/frogermcs/GithubClient/tree/1bf53a2a36c8a85435e877847b987395e482ab4a" target="_blank" rel="noopener">repository</a>。</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/12/31/Android-使用Dagger-2依赖注入-DI介绍（翻译）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/12/31/Android-使用Dagger-2依赖注入-DI介绍（翻译）/" itemprop="url">[Android]使用Dagger 2依赖注入 - DI介绍（翻译）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-31T16:19:00+08:00">
                2015-12-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/12/31/Android-使用Dagger-2依赖注入-DI介绍（翻译）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/12/31/Android-使用Dagger-2依赖注入-DI介绍（翻译）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a><br></font>

<h2 id="使用Dagger-2依赖注入-DI介绍"><a href="#使用Dagger-2依赖注入-DI介绍" class="headerlink" title="使用Dagger 2依赖注入 - DI介绍"></a>使用Dagger 2依赖注入 - DI介绍</h2><blockquote>
<p>原文：<a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-introdution-to-di/" target="_blank" rel="noopener">http://frogermcs.github.io/dependency-injection-with-dagger-2-introdution-to-di/</a></p>
</blockquote>
<p>不久之前，在克拉科夫的 <a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-introdution-to-di/" target="_blank" rel="noopener">Tech Space</a> 的 Google I/O 扩展中，我 <a href="https://speakerdeck.com/frogermcs/dependency-injection-with-dagger-2" target="_blank" rel="noopener">展示</a> 了一些关于使用Dagger 2来进行依赖注入。在准备期间我认识到有太多相关的东西需要去讲，无法用一打幻灯片就能覆盖到全部。但是它可以作为一个很好的进入点来开展更多这一系列主题－Android端的依赖注入。</p>
<p>在这一章中我会去通过之前所展示的来进行一个总结。可能并不是按部就班的 - 我认为现在是时候打破过去，使用一些原本我们不会使用或者不应该使用的方法来解决问题了。<strong>Jake Wharton</strong> <a href="https://www.parleys.com/tutorial/5471cdd1e4b065ebcfa1d557/" target="_blank" rel="noopener">讲述</a> 了相关历史（Guice, Dagger 1），<strong>Gregory Kick</strong> <a href="https://www.youtube.com/watch?v=oK_XtfXPkqw" target="_blank" rel="noopener">也是</a>（几乎有一半是关于Spring, Guice, Dagger 1）。我也会花几分钟的时间讲述以前的解决方式。但是此刻是时候开始了。</p>
<h3 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h3><p>依赖注入的全部就是构建对象并在我们需要时把它们传入。我不会深入到它的学说（查看维基百科对<a href="http://en.wikipedia.org/wiki/Dependency_injection" target="_blank" rel="noopener">DI的定义</a>）。想象一个简单的类：<code>UserManager</code>，它依赖<code>UserStore</code>和<code>ApiService</code>。如果没有使用依赖注入，这个类会看起来像这样：</p>
<p><img src="http://frogermcs.github.io/images/13/user_manager_no_di.png" alt=""></p>
<p><code>UserStore</code> 和 <code>ApiService</code> 两者都是在<code>UserManager</code>类中构造和提供的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApiService apiService;</span><br><span class="line">    <span class="keyword">private</span> UserStore userStore;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//No-args constructor. Dependencies are created inside.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.apiService = <span class="keyword">new</span> ApiSerivce();</span><br><span class="line">        <span class="keyword">this</span>.userStore = <span class="keyword">new</span> UserStore();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerUser</span><span class="params">()</span> </span>&#123;<span class="comment">/*  */</span>&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserManager userManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(b);</span><br><span class="line">        <span class="keyword">this</span>.userManager = <span class="keyword">new</span> UserManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRegisterClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        userManager.registerUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么这些代码会给我们制造一些问题呢？让我们想象一下，你希望去改变<code>UserStore</code>的实现，用<code>SharedPreferences</code>来作为它的存储机制。它需要至少一个<code>Context</code>对象来创建一个实例，所以我们需要把它通过构造器传入到<code>UserStore</code>。它意味着<code>UserManager</code>类中也需要被修改来使用新的<code>UserStore</code>构造器。现在想象下有很多类使用了<code>UserStore</code> - 它们全部都需要被修改。</p>
<p>现在再来看下我们使用了依赖注入的<code>UserManager</code>类：</p>
<p><img src="http://frogermcs.github.io/images/13/user_manager_di.png" alt=""></p>
<p>它的依赖是在类的外面创建和提供的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApiService apiService;</span><br><span class="line">    <span class="keyword">private</span> UserStore userStore;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Dependencies are passed as arguments</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserManager</span><span class="params">(ApiService apiService, UserStore userStore)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.apiService = apiService;</span><br><span class="line">        <span class="keyword">this</span>.userStore = userStore;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerUser</span><span class="params">()</span> </span>&#123;<span class="comment">/*  */</span>&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserManager userManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(b);</span><br><span class="line">        ApiService api = ApiService.getInstance();</span><br><span class="line">        UserStore store = UserStore.getInstance();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.userManager = <span class="keyword">new</span> UserManager(api, store);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRegisterClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        userManager.registerUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在在相似的情况下 - 我们改变它其中一个依赖的实现方式 - 我们不需要修改<code>UserManager</code>源代码。所有它的依赖都是从外面提供的，所以我们唯一一个需要修改的地方就是我们构造的<code>UserStore</code>对象。</p>
<p>所以使用依赖注入的优势是什么呢？</p>
<h4 id="构造-使用-的分离"><a href="#构造-使用-的分离" class="headerlink" title="构造/使用 的分离"></a>构造/使用 的分离</h4><p>当我们构造类的实例 - 通常这些对象会在其它的地方被使用到，多亏这个方法让我们的代码更加模块化 - 所有的依赖都可以被很简单地替换掉（只要他们实现了相同的接口），并且不会与我们应用的逻辑产生冲突。想要改变<code>DatabaseUserStore</code>为<code>SharedPrefsUserStore</code> ？好的，只需要关心公开的API（与<code>DatabaseUserStore</code>相同的）或者实现相同的接口。</p>
<h4 id="单元测试（Unit-testing）"><a href="#单元测试（Unit-testing）" class="headerlink" title="单元测试（Unit testing）"></a>单元测试（Unit testing）</h4><p>真正的单元测试假设一个类是可以完全被隔离进行测试的 - 不需要了解它的相关依赖。在实践中，基于我们的<code>UserManager</code>类，这里有一个我们应该编写的单元测试的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserManagerTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    UserManager userManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    ApiService apiServiceMock;</span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    UserStore userStoreMock;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>);</span><br><span class="line">        userManager = <span class="keyword">new</span> UserManager(apiServiceMock, userStoreMock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Test our userManager here - all its dependencies are satisfied</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它可能只能使用DI - 多亏<code>UserManager</code>是完全独立于<code>UserStore</code>和<code>ApiService</code>实现的。我们可以提供这些类的mock（简单地说 - mocks是一些拥有相同公开API的类，它在方法中不做任何事情并且/或者返回我们期望的值），然后在一个与所依赖的真实实现分离出来的环境下进行对<code>UserManager</code>的测试。</p>
<h4 id="独立-并行开发"><a href="#独立-并行开发" class="headerlink" title="独立/并行开发"></a>独立/并行开发</h4><p>多亏模块化的代码（<code>UserStore</code>可以从<code>UserManager</code>中独立出来进行实现），它也可以非常方便在程序员间进行代码的分离。只需要<code>UserStore</code>相关的接口被每个人知道（尤其是在<code>UserManager</code>中使用到的<code>UserStore</code>中的公开方法）即可。剩下的（实现，逻辑）可以通过单元测试来测试。</p>
<h3 id="依赖注入框架"><a href="#依赖注入框架" class="headerlink" title="依赖注入框架"></a>依赖注入框架</h3><p>依赖注入除了这些优点之外还有一些缺点。其中一个缺点是会产生很大的模版代码。想象一个简单的<code>LoginActivity</code>类，它在MVP（model-view-presenter）模式中被实现。这个类看起来就像这样：</p>
<p><img src="http://frogermcs.github.io/images/13/login_activity_diagram.png" alt=""></p>
<p>唯一有问题的部分代码就是<code>LoginActivityPresenter</code>的初始化，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    LoginActivityPresenter presenter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        OkHttpClient okHttpClient = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">        RestAdapter.Builder builder = <span class="keyword">new</span> RestAdapter.Builder();</span><br><span class="line">        builder.setClient(<span class="keyword">new</span> OkClient(okHttpClient));</span><br><span class="line">        RestAdapter restAdapter = builder.build();</span><br><span class="line">        ApiService apiService = restAdapter.create(ApiService.class);</span><br><span class="line">        UserManager userManager = UserManager.getInstance(apiService);</span><br><span class="line"></span><br><span class="line">        UserDataStore userDataStore = UserDataStore.getInstance(</span><br><span class="line">                getSharedPreferences(<span class="string">"prefs"</span>, MODE_PRIVATE)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Presenter is initialized here</span></span><br><span class="line">        presenter = <span class="keyword">new</span> LoginActivityPresenter(<span class="keyword">this</span>, userManager, userDataStore);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它看起来不太友好，不是吗？</p>
<p>这就是DI框架需要解决的问题。相同功能的代码看起来就像这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    LoginActivityPresenter presenter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Satisfy all dependencies requested by @Inject annotation</span></span><br><span class="line">        getDependenciesGraph().inject(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单多了，对吧？当然DI框架没有地方可以获取到对象 - 他们仍然需要在我们代码的某个地方进行初始化和配置。但是对象构建从使用中分离出来了（实质上这是DI模式的准则）。DI框架关心怎么样去把它们联系在一起（怎么在对象被需要时分配给它们）。</p>
<h3 id="未完待续"><a href="#未完待续" class="headerlink" title="未完待续"></a>未完待续</h3><p>我上面所有描述的东西都是使用Dagger 2的简单的背景 - 用于Android和Java开发的依赖注入框架。在下一章我将尝试讲解所有Dagger 2的API。如果你等不急可以尝试我的<a href="https://github.com/frogermcs/GithubClient" target="_blank" rel="noopener">Github client example</a>，它建立在Dagger 2之上并且会用在我的展示中。一个小提示 - <code>@Module</code>和<code>@Component</code>就是构建/提供对象的地方。<code>@Inject</code>是我们对象使用到的地方。</p>
<p>More detailed description - soon.</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.youtube.com/watch?v=oK_XtfXPkqw" target="_blank" rel="noopener">DAGGER 2 - A New Type of dependency injection</a> by Gregory Kick</li>
<li><a href="https://www.parleys.com/tutorial/the-future-dependency-injection-dagger-2" target="_blank" rel="noopener">The Future of Dependency Injection with Dagger 2</a> by Jake Wharton</li>
<li><a href="http://frogermcs.github.io/dagger-1-to-2-migration/" target="_blank" rel="noopener">Dagger 1 to 2 migration process</a></li>
</ul>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.wangjiegulu.com/2015/12/16/Android-官网《monkeyrunner》中文翻译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wang Jie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my_avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WAND JIE">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/12/16/Android-官网《monkeyrunner》中文翻译/" itemprop="url">[Android]官网《monkeyrunner》中文翻译</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-12-16T12:20:00+08:00">
                2015-12-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/12/16/Android-官网《monkeyrunner》中文翻译/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/12/16/Android-官网《monkeyrunner》中文翻译/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/5050768.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5050768.html</a>
</strong></font>

<p>翻译自 Android Developer 官网：<a href="http://developer.android.com/tools/help/monkeyrunner_concepts.html" target="_blank" rel="noopener">http://developer.android.com/tools/help/monkeyrunner_concepts.html</a></p>
<h1 id="monkeyrunner"><a href="#monkeyrunner" class="headerlink" title="monkeyrunner"></a>monkeyrunner</h1><p>monkeyrunner工具提供了一套API，在不通过Android代码的情况下编写程序来控制一个Android设备或者模拟器。使用monkeyrunner，你可以编写一个<code>Python</code>程序来安装一个Android应用程序或者测试包，运行它，给它发送按键，使用它的interface来创建一个截图，并保存在工作站上。monkeytunner工具主要是被设计用来在功能/框架级别测试应用程序和设备，并运行单元测试套件，但是你也可以使用它来达到其它的目的。</p>
<p>Monkeyrunner工具与也被称为<code>monkey</code>的<a href="http://developer.android.com/tools/help/monkey.html" target="_blank" rel="noopener">UI/Application Exerciser Monkey</a>没有任何关系。<code>Monkey</code>工具是直接在<code>adb</code> shell中运行，通过在设备或者模拟器中产生伪随机流的用户和系统事件的方式。比较之下，monkeyrunner工具在一个工作站中通过API发送指定的命令和事件来控制设备和模拟器。</p>
<p>monkeyrunner工具提供了以下这些在Android测试中独一无二的特性：</p>
<ul>
<li><p>多设备控制：monkeyrunner可以应用在一个或者多个测试套件跨越多个设备和模拟器。你可以在物理层面上一次性attach所有的设备或者启动所有的模拟器（或者两者都有），按照程序依次连接上每一个，然后运行一个或者多个测试。</p>
</li>
<li><p>功能性测试：monkeyrunner可以运行从头至尾全自动化地测试Android应用程序。由你提供输入的按键或者触摸事件，并且查看结果截图。</p>
</li>
<li><p>回归测试：monkeyrunner可以通过运行一个应用程序并且把它输出的结果截图与已知正确的截图比较的方式测试应用程序的稳定性。</p>
</li>
<li><p>可扩展的自动化：因为monkeyrunner是一套API工具包，你可以基于<code>Python</code>模块和程序的开发一个完整的系统来控制Android设备。除了使用monkeyrunner自己的API，你可以使用标准的Python <code>os</code>和<code>subprocess</code>模块来调用 <a href="http://developer.android.com/tools/help/adb.html" target="_blank" rel="noopener">Android Debug Bridge</a> 等Android工具。你也可以为monkeyrunner API增加自己的类。这个我们会在 <a href="http://developer.android.com/tools/help/monkeyrunner_concepts.html#Plugins" target="_blank" rel="noopener">Extending monkeyrunner with plugins</a> 栏中讨论到更多的细节。</p>
</li>
</ul>
<p>monkeyrunner工具使用了<a href="http://www.jython.org/" target="_blank" rel="noopener">Jython</a>，一个使用Java编程语言的Python实现。Jython允许monkeyrunner API很容易地与Android framework交互。使用Jython，你可以使用Python语法去访问API常量、类和方法。</p>
<h2 id="一个简单的monkeyrunner程序"><a href="#一个简单的monkeyrunner程序" class="headerlink" title="一个简单的monkeyrunner程序"></a>一个简单的monkeyrunner程序</h2><p>这里有一个简单的monkeyrunner程序，它可以连接到一个设备，创建一个 <a href="http://developer.android.com/tools/help/MonkeyDevice.html" target="_blank" rel="noopener"><code>MonkeyDevice</code></a> 对象。程序中使用 <code>MonkeyDevice</code> 对象安装一个Android应用程序，运行它其中的一个Activity，并且发送一个按键的事件给这个Activity。然后程序把结果截图，创建了一个 <a href="http://developer.android.com/tools/help/MonkeyImage.html" target="_blank" rel="noopener"><code>MonkeyImage</code></a> 对象。通过这个对象，程序把截图输出到一个<code>.png</code>文件中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Import 程序所有使用到的monkeyrunner模块</span></span><br><span class="line"><span class="keyword">from</span> com.android.monkeyrunner <span class="keyword">import</span> MonkeyRunner, MonkeyDevice</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接当前的设备，返回一个MonkeyDevice对象</span></span><br><span class="line">device = MonkeyRunner.waitForConnection()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Android应用。注意这个方法返回一个boolean，所以你需要检查是否安装成功</span></span><br><span class="line">device.installPackage(<span class="string">'myproject/bin/MyApplication.apk'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把安装文件的内部包名设置到一个变量中</span></span><br><span class="line">package = <span class="string">'com.example.android.myapplication'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把Activity的完整类名设置到一个变量中</span></span><br><span class="line">activity = <span class="string">'com.example.android.myapplication.MainActivity'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置要启动的component名字</span></span><br><span class="line">runComponent = package + <span class="string">'/'</span> + activity</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行该component</span></span><br><span class="line">device.startActivity(component=runComponent)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按下菜单按钮</span></span><br><span class="line">device.press(<span class="string">'KEYCODE_MENU'</span>, MonkeyDevice.DOWN_AND_UP)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 截图</span></span><br><span class="line">result = device.takeSnapshot()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把截图写入到一个文件中</span></span><br><span class="line">result.writeToFile(<span class="string">'myproject/shot1.png'</span>,<span class="string">'png'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="The-monkeyrunner-API"><a href="#The-monkeyrunner-API" class="headerlink" title="The monkeyrunner API"></a>The monkeyrunner API</h2><p>monkeyrunner的API处于<code>com.android.monkeyrunner</code>中，包括三个模块：</p>
<ul>
<li><p><a href="http://developer.android.com/tools/help/MonkeyRunner.html" target="_blank" rel="noopener"><code>MonkeyRunner</code></a>：一个包含monkeyrunner程序实用方法的类。这个类提供了一个方法用来把monkeyrunner连接到一个设备或者模拟器。它也提供了方法为monkeyrunner程序创建UI，还有显示内置的help界面。</p>
</li>
<li><p><a href="http://developer.android.com/tools/help/MonkeyDevice.html" target="_blank" rel="noopener"><code>MonkeyDevice</code></a>：代表一个设备或者模拟器。这个类提供了一些方法用于安装和卸载应用、启动一个Activity、发送键盘活着触摸事件到一个应用。你也可以使用这个类来运行一个测试应用。</p>
</li>
<li><p><a href="http://developer.android.com/tools/help/MonkeyImage.html" target="_blank" rel="noopener"><code>MonkeyImage</code></a>：代表一个屏幕截图图片。这个类提供了一些方法用于截图、把bitmap图片转换成各种格式，对比两个MonkeyImage对象、还有把图片写入到文件中。</p>
</li>
</ul>
<p>在一个Python程序中，你可以像一个Python模块一样访问每一个类。monkeyrunner工具不会自动帮你import这些模块。import模块的方式是使用Python的<code>from</code>语句：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> com.android.monkeyrunner <span class="keyword">import</span> &lt;module&gt;</span><br></pre></td></tr></table></figure>
<p><code>&lt;module&gt;</code>就是你希望import的类名。你可以使用同一个的<code>from</code>语句通过逗号分隔的方式import多个模块。</p>
<h2 id="运行monkeyrunner"><a href="#运行monkeyrunner" class="headerlink" title="运行monkeyrunner"></a>运行monkeyrunner</h2><p>你可以从一个文件中运行monkeyrunner程序，也可以在交互会话模式中输入monkeyrunner语句来运行。两者都需要通过调用<code>monkeyrunner</code>命令进行，你可以在SDK目录下的<code>tools/</code>子目录下可以找到这些命令。如果你提供了一个文件名作为草书，monkeyrunner命令会把这个文件中的内容作为Python程序来运行，否则，它就是以交互会话的方式运行。</p>
<p>monkeyrunner命令的语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">monkeyrunner -plugin &lt;plugin_jar&gt; &lt;program_filename&gt; &lt;program_options&gt;</span><br></pre></td></tr></table></figure>
<p>表1解释了flags和参数。</p>
<p><strong>Table 1</strong>. <code>monkeyrunner</code> flags和参数。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-plugin &lt;plugin_jar&gt;</code></td>
<td>（可选）指定一个<code>.jar</code>文件作为monkeyrunner的插件。更多monkeyrunner插件学习，见<a href="http://developer.android.com/tools/help/monkeyrunner_concepts.html#Plugins" target="_blank" rel="noopener">使用插件扩展monkeyrunner</a>。要指定多个文件，那就多次使用这个参数。</td>
</tr>
<tr>
<td><code>&lt;program_filename&gt;</code></td>
<td>如果你提供了这个参数，<code>monkeyrunner</code>命令就会把这个文件中的内容作为Python程序运行。如果该参数没有被提供，则它就是以交互会话的方式运行。</td>
</tr>
<tr>
<td><code>&lt;program_options&gt;</code></td>
<td>（可选）<program_file>中该程序的flags和参数。</program_file></td>
</tr>
</tbody>
</table>
<h2 id="monkeyrunner内置的Help"><a href="#monkeyrunner内置的Help" class="headerlink" title="monkeyrunner内置的Help"></a>monkeyrunner内置的Help</h2><p>你可以通过以下命令生成monkeyrunner的API reference：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">monkeyrunner help.py &lt;format&gt; &lt;outfile&gt;</span><br></pre></td></tr></table></figure>
<p>参数是：</p>
<ul>
<li><p><code>&lt;format&gt;</code>：<code>text</code>表示纯文本输出，或者<code>html</code>表示HTML输出。</p>
</li>
<li><p><code>&lt;outfile&gt;</code>：输出文件的路径。</p>
</li>
</ul>
<h2 id="使用插件扩展monkeyrunner"><a href="#使用插件扩展monkeyrunner" class="headerlink" title="使用插件扩展monkeyrunner"></a>使用插件扩展monkeyrunner</h2><p>你可以使用Java编程语言编写你的类并构建到一个或者多个<code>.jar</code>中来扩展monkeyrunner的API。你可以使用这个特性通过使用你自己的类或者继承已有的类来扩展monkeyrunner API。你也可以使用这个特性来初始化monkeyrunner环境。</p>
<p>要提供一个插件给monkeyrunner，就要调用在<code>monkeyrunner</code>命令的时候加上<a href="http://developer.android.com/tools/help/monkeyrunner_concepts.html#table1" target="_blank" rel="noopener">表1</a>中所描述的<code>-plugin &lt;plugin_jar&gt;</code>参数。</p>
<p>在你的插件代码中，你可以import和继承monkeyrunner在<code>com.android.monkeyrunner</code>中的主要类<code>MonkeyDevice</code>、<code>MonkeyImage</code>、和<code>MonkeyRunner</code>（见<a href="http://developer.android.com/tools/help/monkeyrunner_concepts.html#APIClasses" target="_blank" rel="noopener">The monkeyrunner API</a>）。</p>
<p>注意插件不能让你去访问Android SDK。你不能import像<code>com.android.app</code>类似的包。因为monkeyrunner是在framework APIs之外与设备或者模拟器交互的。</p>
<h3 id="插件启动类"><a href="#插件启动类" class="headerlink" title="插件启动类"></a>插件启动类</h3><p><code>.jar</code>插件文件可以指定一个类会在脚本运行之前被初始化。要指定这个类，就要在<code>.jar</code>文件的manifest中增加一个<code>MonkeyRunnerStartupRunner</code>属性。它的值应该就是启动时要运行的类的名字。这面这个片段展示了你怎么在<code>ant</code> build脚本中去设置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jar</span> <span class="attr">jarfile</span>=<span class="string">"myplugin"</span> <span class="attr">basedir</span>=<span class="string">"$&#123;build.dir&#125;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"MonkeyRunnerStartupRunner"</span> <span class="attr">value</span>=<span class="string">"com.myapp.myplugin"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">jar</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>要去访问monkeyrunner的运行时环境，启动类可以实现<code>com.google.common.base.Predicate&lt;PythonInterpreter&gt;</code>接口。举个例子，这个类在默认的命名空间中设置了一些变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.android.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Predicate;</span><br><span class="line"><span class="keyword">import</span> org.python.util.PythonInterpreter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> <span class="keyword">implements</span> <span class="title">Predicate</span>&lt;<span class="title">PythonInterpreter</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(PythonInterpreter anInterpreter)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 一个例子使用来在monkeyrunner环境的命名空间中初始化一些变量。</span></span><br><span class="line"><span class="comment">        * 在执行期间，monkeyrunner程序可以使用“newtest”和“use_emulator”这些变量</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        anInterpreter.set(<span class="string">"newtest"</span>, <span class="string">"enabled"</span>);</span><br><span class="line">        anInterpreter.set(<span class="string">"use_emulator"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/my_avatar.jpg"
                alt="Wang Jie" />
            
              <p class="site-author-name" itemprop="name">Wang Jie</p>
              <p class="site-description motion-element" itemprop="description">Wang Jie's blog</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">144</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wangjiegulu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:tiantian.china.2@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/+%E5%A4%A9%E5%A4%A9wangjie" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/wangjiegulu" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/users/2124006/wangjie" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/wangjiegulu" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i></a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.cnblogs.com/tiantianbyconan/" title="cnblog" target="_blank">cnblog</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Jie</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>








        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://blog-wangjiegulu-com.disqus.com/count.js" async></script>
    

    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "default";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "GooglePlus,Evernote,Twitter,Facebook,Douban,Weibo";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  

  

  

</body>
</html>

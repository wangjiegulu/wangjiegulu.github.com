<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="以下内容为原创，欢迎转载，转载请注明来自天天博客：http://www.cnblogs.com/tiantianbyconan/p/6237731.html   使用Dagger 2来构建UserScope 原文：http://frogermcs.github.io/building-userscope-with-dagger2/  在Dagger 2中自定义scopes可以在不寻常存活时间（与A">
<meta name="keywords" content="android,dependency injection,翻译,dagger2,DI,google">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Dagger 2来构建UserScope（翻译）">
<meta property="og:url" content="http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/index.html">
<meta property="og:site_name" content="Wang Jie">
<meta property="og:description" content="以下内容为原创，欢迎转载，转载请注明来自天天博客：http://www.cnblogs.com/tiantianbyconan/p/6237731.html   使用Dagger 2来构建UserScope 原文：http://frogermcs.github.io/building-userscope-with-dagger2/  在Dagger 2中自定义scopes可以在不寻常存活时间（与A">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://frogermcs.github.io/images/15/scopes-lifecycle.png">
<meta property="og:image" content="http://frogermcs.github.io/images/28/scopes.png">
<meta property="og:updated_time" content="2018-01-31T05:37:54.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用Dagger 2来构建UserScope（翻译）">
<meta name="twitter:description" content="以下内容为原创，欢迎转载，转载请注明来自天天博客：http://www.cnblogs.com/tiantianbyconan/p/6237731.html   使用Dagger 2来构建UserScope 原文：http://frogermcs.github.io/building-userscope-with-dagger2/  在Dagger 2中自定义scopes可以在不寻常存活时间（与A">
<meta name="twitter:image" content="http://frogermcs.github.io/images/15/scopes-lifecycle.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>使用Dagger 2来构建UserScope（翻译）</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3">
    
      <div id="header-post-nav">
  <span id="nav">
      <ul>
         
          <li><b><a href="/">Home</a></b></li>
         
          <li><b><a href="/archives/">Writing</a></b></li>
         
          <li><b><a href="/tags/">Tags</a></b></li>
         
          <li><b><a href="/about/">About</a></b></li>
         
          <li><b><a href="/feed.xml">RSS</a></b></li>
        
      </ul>
  </span>
</div>

<div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/feed.xml">RSS</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2017/01/09/Android-在Dagger-2中Activities和Subcomponents的多绑定（翻译）/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2016/12/30/Android-在Dagger-2中使用RxJava来进行异步注入（翻译）/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&text=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&title=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&is_video=false&description=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=使用Dagger 2来构建UserScope（翻译）&body=Check out this article: http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&title=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&title=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&title=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&title=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&name=使用Dagger 2来构建UserScope（翻译）&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#使用Dagger-2来构建UserScope"><span class="toc-number">1.</span> <span class="toc-text">使用Dagger 2来构建UserScope</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Example-app"><span class="toc-number">1.1.</span> <span class="toc-text">Example app</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#它怎么工作的呢？"><span class="toc-number">1.1.1.</span> <span class="toc-text">它怎么工作的呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Components的层次结构"><span class="toc-number">1.1.2.</span> <span class="toc-text">Components的层次结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在app的多次启动中恢复UserScope"><span class="toc-number">1.1.3.</span> <span class="toc-text">在app的多次启动中恢复UserScope</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#用户从头开始启动程序"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">用户从头开始启动程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用户进程被系统kill"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">用户进程被系统kill</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#如果用户不再存在怎么办？"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">如果用户不再存在怎么办？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#怎么去模拟应用进程被系统杀死"><span class="toc-number">1.1.4.</span> <span class="toc-text">怎么去模拟应用进程被系统杀死</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#源码"><span class="toc-number">1.2.</span> <span class="toc-text">源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#作者"><span class="toc-number">1.3.</span> <span class="toc-text">作者</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        使用Dagger 2来构建UserScope（翻译）
    </h1>



    <div class="meta"  style="margin-top:12px;">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name" style="margin-left: 12px">Wang Jie</span>
      </span>
      
    <div class="postdate">
        <time datetime="2016-12-30T09:23:00.000Z" itemprop="datePublished">2016-12-30</time>
    </div>

<br/>
      
    <div class="article-tag">
        <i class="fas fa-tag" style="margin-top: 20px"></i>
        <a class="tag-link" href="/tags/DI/">DI</a>, <a class="tag-link" href="/tags/android/">android</a>, <a class="tag-link" href="/tags/dagger2/">dagger2</a>, <a class="tag-link" href="/tags/dependency-injection/">dependency injection</a>, <a class="tag-link" href="/tags/google/">google</a>, <a class="tag-link" href="/tags/翻译/">翻译</a>
    </div>


    </div>
  </header>
  

  
  <div class="content" itemprop="articleBody" style="word-wrap:break-word;overflow:hidden;">
    
    

    <font color="#ff0000"><strong><br>以下内容为原创，欢迎转载，转载请注明<br>来自天天博客：<a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a>
</strong></font>

<h1 id="使用Dagger-2来构建UserScope"><a href="#使用Dagger-2来构建UserScope" class="headerlink" title="使用Dagger 2来构建UserScope"></a>使用Dagger 2来构建UserScope</h1><blockquote>
<p>原文：<a href="http://frogermcs.github.io/building-userscope-with-dagger2/" target="_blank" rel="noopener">http://frogermcs.github.io/building-userscope-with-dagger2/</a></p>
</blockquote>
<p>在Dagger 2中自定义scopes可以在不寻常存活时间（与Application和界面生命周期不同的）的依赖上给我带来更好的控制。但是在Android app中正确地实现它需要记住几个事情：scope不能存活比application进程更长的周期，进程可以被系统杀死并且在更多的对象实例的用户流中恢复过来。今天我们将介绍所有这些，并尝试实现可用于生产的UserScope。</p>
<p>在我的其中一篇博客中<a href="http://frogermcs.github.io/dependency-injection-with-dagger-2-custom-scopes/" target="_blank" rel="noopener">写了</a>关于<strong>自定义scopes</strong>和<strong>Subcomponents</strong>。作为一个例子，我使用了<code>UserScope</code>，只要用户是登录状态就应该存活。一个scopes生命周期的例子：</p>
<p><img src="http://frogermcs.github.io/images/15/scopes-lifecycle.png" alt=""></p>
<p>虽然它看起来非常简单，它的实现在那篇文章中已经展示，但是它的代码是脱离与生产环境的。这就是为什么我想要又一次深入这个话题 - 但是会有更多实现的上下文细节。</p>
<h2 id="Example-app"><a href="#Example-app" class="headerlink" title="Example app"></a>Example app</h2><p>我们将构建3个界面的应用，它可以从<a href="https://developer.github.com/v3/" target="_blank" rel="noopener">Github API</a>获取用户详情（让我们假设这在生产环境app中作为一个认证的事件）。</p>
<p>App将会有3个scopes：</p>
<ul>
<li>(Application scope, <strong>@Singleton</strong>) - 只要application存活依赖就存活。</li>
<li><strong>@UserScope</strong> - 只要用户会话是激活状态依赖就存活（在单个应用程序中启动）。<strong>重要的是：</strong>这个scope存活时间不会超过application本身。每一个新的app实例都会创建一个新的@UserScope（甚至app不同的启动间用户会话没有关闭）。</li>
<li><strong>@ActivityScope</strong> - 只要Activity界面存活依赖就存活。</li>
</ul>
<h3 id="它怎么工作的呢？"><a href="#它怎么工作的呢？" class="headerlink" title="它怎么工作的呢？"></a>它怎么工作的呢？</h3><p>当app从Github API得到特定用户名的数据，新的界面会被打开（UserDetails）。在内部，<code>LoginActivityPresenter</code>访问<code>UserManager</code>来开启一个会话（从Github API获取数据）。当操作成功，用户保存到<code>UserDataStore</code>，并且<code>UserManager</code>创建<code>UserComponent</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UserManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Observable&lt;User&gt; <span class="title">startSessionForUser</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> githubApiService.getUser(username)</span><br><span class="line">            .map(User.UserResponseToUser())</span><br><span class="line">            .doOnNext(<span class="keyword">new</span> Action1&lt;User&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">                    userDataStore.createUser(user);</span><br><span class="line">                    startUserSession();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .subscribeOn(Schedulers.io())</span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">startUserSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user = userDataStore.getUser();</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Timber.i(<span class="string">"Session started, user: %s"</span>, user);</span><br><span class="line">        userComponent = userComponentBuilder.sessionModule(<span class="keyword">new</span> UserModule(user)).build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>UserManager</strong>是一个单例，所以它的存活时间与Applicaiton一致，而且它对生命周期与用户会话一样的<code>UserComponet</code>负责。当用户决定去关闭会话，component会被移除，这样所有<code>@UserScope</code>注解了的对象应该准备被GC回收。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UserManager</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeUserSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Timber.i(<span class="string">"Close session for user: %s"</span>, userDataStore.getUser());</span><br><span class="line">    userComponent.logoutManager().startLogoutProcess();</span><br><span class="line">    userDataStore.clearUser();</span><br><span class="line">    userComponent = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Components的层次结构"><a href="#Components的层次结构" class="headerlink" title="Components的层次结构"></a>Components的层次结构</h3><p>在我们的app中所有的subcomponents使用了一个<code>AppComponent</code>作为一个根component。显示用户相关内容的Subcomponents使用保持了带<code>@Userscope</code>注解的对象（一个用户会话一个实例）的<code>UserComponent</code>。</p>
<p><img src="http://frogermcs.github.io/images/28/scopes.png" alt=""></p>
<p><code>UserDetailsActivityComponent</code>组件层次结构示例如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AppComponent.java </span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="meta">@Component</span>(modules = &#123;</span><br><span class="line">        AppModule.class,</span><br><span class="line">        GithubApiModule.class</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</span><br><span class="line">    UserComponent.<span class="function">Builder <span class="title">userComponentBuilder</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserComponent.java </span></span><br><span class="line"></span><br><span class="line"><span class="meta">@UserScope</span></span><br><span class="line"><span class="meta">@Subcomponent</span>(modules = UserModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserComponent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Subcomponent</span>.Builder</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">        UserComponent.<span class="function">Builder <span class="title">sessionModule</span><span class="params">(UserModule userModule)</span></span>;</span><br><span class="line">        <span class="function">UserComponent <span class="title">build</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">UserDetailsActivityComponent <span class="title">plus</span><span class="params">(UserDetailsActivityComponent.UserDetailsActivityModule <span class="keyword">module</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UserDetailsActivityComponent.java </span></span><br><span class="line"></span><br><span class="line"><span class="meta">@ActivityScope</span></span><br><span class="line"><span class="meta">@Subcomponent</span>(modules = UserDetailsActivityComponent.UserDetailsActivityModule.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailsActivityComponent</span> </span>&#123;</span><br><span class="line">    <span class="function">UserDetailsActivity <span class="title">inject</span><span class="params">(UserDetailsActivity activity)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于<code>UserComponent</code>，我们使用<a href="http://google.github.io/dagger/subcomponents.html#subcomponent-builders" target="_blank" rel="noopener">Subcomponent builder</a>模式来让我们的代码更加整洁，有可能注入这个Builder到<code>UserModule</code>（<code>UserComponent.Builder</code>用于创建组件<code>UserModule.startUserSession</code>方法如上所示）。</p>
<h3 id="在app的多次启动中恢复UserScope"><a href="#在app的多次启动中恢复UserScope" class="headerlink" title="在app的多次启动中恢复UserScope"></a>在app的多次启动中恢复UserScope</h3><p>就像我之前提到的UserScope的存活时间不能超过application进程。所以如果我们假设用户会话可以在app的多次启动之间保存，我们需要为我们的<code>UserScope</code>去处理状态恢复操作。有两种场景我们需要记住：</p>
<h4 id="用户从头开始启动程序"><a href="#用户从头开始启动程序" class="headerlink" title="用户从头开始启动程序"></a>用户从头开始启动程序</h4><p>这是最常见的情况，应该很简单地去处理。用户从头开始启动app（比如，通过点击app icon）。<code>Application</code>对象被创建，然后第一个<code>Activity</code>（<strong>LAUNCHER</strong>）被启动。我们需要提供简单的逻辑检查我们是否有保存的用户在我们的数据存储中。如果是则将用户传送到UserComponent自动创建的正确的界面（在我们案例中是<code>UserDetailsActivity</code>）。</p>
<h4 id="用户进程被系统kill"><a href="#用户进程被系统kill" class="headerlink" title="用户进程被系统kill"></a>用户进程被系统kill</h4><p>但是还有一种情况我们经常会忘记。Application进程可以被系统杀死（比如，因为内存不足）。这意味着所有application数据被销毁（application，activities，static fields）。不幸的是这不能被很好的处理 - 我们在Applicaiton生命周期中没有任何回调。令它更复杂的是，android保存了activity栈。也就是说，当用户决定启动之前被杀死于流中间的应用程序时，系统将试图带用户回到此界面。</p>
<p>对于我们而言我们需要准备在任何被使用的屏幕中去恢复<code>UserComponent</code>。</p>
<p>让我们考虑这个例子：</p>
<p>1. 用户在<code>UserDetailsActivity</code>界面最小化app。<br>2. 整个app被系统杀死（稍后我会展示如何模拟它）<br>3. 用户打开任务切换栏，点击我们的app界面。<br>4. 系统创建了一个新的<code>Application</code>实例。也就是说有一个新的<code>AppComponent</code>被创建。然后系统并不会打开<code>LoginActivity</code>（我们的启动activity），而是立即打开<code>UserDetailsActivity</code>。</p>
<p>对于我们而言，<code>UserComponent</code>被恢复回来（新的实例被创建）。然后这是我们的责任。例子的解决方案看起来如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseUserActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    UserManager userManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupActivityComponent</span><span class="params">(AppComponent appComponent)</span> </span>&#123;</span><br><span class="line">        appComponent.inject(<span class="keyword">this</span>);</span><br><span class="line">        setupUserComponent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupUserComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    isUserSessionStarted = userManager.isUserSessionStartedOrStartSessionIfPossible();</span><br><span class="line">    onUserComponentSetup(userManager.getUserComponent());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//This screen cannot work when user session is not started.</span></span><br><span class="line">    <span class="keyword">if</span> (!isUserSessionStarted) &#123;</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onUserComponentSetup</span><span class="params">(UserComponent userComponent)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每一个使用了UserComponent的Activity都继承了我们的<code>BaseUserActivity</code>类（<code>setupActivityComponent()</code>方法在<code>BaseActivity</code>的<code>onCreate()</code>方法中调用）。</p>
<p><code>UserManager</code>从Application创建的<code>AppComponent</code>中被注入。会话通过这种方式开启：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isUserSessionStartedOrStartSessionIfPossible</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userComponent != <span class="keyword">null</span> || startUserSession();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">startUserSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//This method was described earlier</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="如果用户不再存在怎么办？"><a href="#如果用户不再存在怎么办？" class="headerlink" title="如果用户不再存在怎么办？"></a>如果用户不再存在怎么办？</h4><p>这里有另外一种方式来处理 - 如果用户登出（比如，通过<code>SyncAdapter</code>），然后<code>UserComponent</code>不能被创建怎么办？这就是为什么在我们的<code>BaseUserActivity</code>中有这几行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupUserComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//This screen cannot work when user session is not started.</span></span><br><span class="line">    <span class="keyword">if</span> (!isUserSessionStarted) &#123;</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是这里有一个情况时当UserComponent不能被创建时我们必须要记住依赖注入将不会发生。这就是为什么我每次需要在<code>onCreate()</code>方法中检查来防止来自依赖注入的NullPointerExceptions。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//UserDetailsActivity</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_user_details);</span><br><span class="line">    tvUser = (TextView) findViewById(R.id.tvUser);</span><br><span class="line">    tvUserUrl = (TextView) findViewById(R.id.tvUserUrl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//This check has to be called. Otherwise, when user is not logged in, presenter won't be injected and this line will cause NPE</span></span><br><span class="line">    <span class="keyword">if</span> (isUserSessionStarted()) &#123;</span><br><span class="line">        presenter.onCreate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="怎么去模拟应用进程被系统杀死"><a href="#怎么去模拟应用进程被系统杀死" class="headerlink" title="怎么去模拟应用进程被系统杀死"></a>怎么去模拟应用进程被系统杀死</h3><p>1. 打开你想测试的用户界面<br>2. 通过系统Home键最小化app。<br>3. 在Android Studio，Android Monitor 选中你的应用，然后点击Terminate<br>4. 现在在你的设备上打开任务切换栏，找到你的app（你应该仍然能在最后一个可见的界面上预览到）。<br>5. 你的app被启动，新的Application实例被创建，并且Activity被恢复。</p>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>例子中展示怎么样去创建和使用<code>UserComponent</code>的可用的源码已经在Github上：<a href="https://github.com/frogermcs/Dagger2Recipes-UserScope" target="_blank" rel="noopener">Dagger 2 recipes - UserScope</a>。</p>
<p>感谢阅读！</p>
<h2 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h2><p><a href="http://about.me/froger_mcs" target="_blank" rel="noopener">Miroslaw Stanek</a></p>
<p>Head of Mobile Development @ <a href="https://azimo.com/" target="_blank" rel="noopener">Azimo</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - DI介绍（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092083.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092083.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - API（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5092525.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5092525.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 自定义Scope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5095426.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5095426.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2依赖注入 - 图表创建的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5098943.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5098943.html</a></p>
<blockquote>
<p><strong>[Android]Dagger2Metrics - 测量DI图表初始化的性能（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/5193437.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/5193437.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2进行依赖注入 - Producers（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6234811.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6234811.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中使用RxJava来进行异步注入（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6236646.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6236646.html</a></p>
<blockquote>
<p><strong>[Android]使用Dagger 2来构建UserScope（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6237731.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6237731.html</a></p>
<blockquote>
<p><strong>[Android]在Dagger 2中Activities和Subcomponents的多绑定（翻译）:</strong></p>
</blockquote>
<p><a href="http://www.cnblogs.com/tiantianbyconan/p/6266442.html" target="_blank" rel="noopener">http://www.cnblogs.com/tiantianbyconan/p/6266442.html</a></p>


    <br/>
    <hr>

    
    <div class="post-copyright" style="margin-top: 20px;">
        <strong>来源博客：</strong><a href="http://blog.wangjiegulu.com">Wang Jie's Blog</a><br/>
         <strong>本文链接：</strong><a href="http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/">http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/</a><br/>
         <strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处。
    </div>
    

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/feed.xml">RSS</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#使用Dagger-2来构建UserScope"><span class="toc-number">1.</span> <span class="toc-text">使用Dagger 2来构建UserScope</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Example-app"><span class="toc-number">1.1.</span> <span class="toc-text">Example app</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#它怎么工作的呢？"><span class="toc-number">1.1.1.</span> <span class="toc-text">它怎么工作的呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Components的层次结构"><span class="toc-number">1.1.2.</span> <span class="toc-text">Components的层次结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在app的多次启动中恢复UserScope"><span class="toc-number">1.1.3.</span> <span class="toc-text">在app的多次启动中恢复UserScope</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#用户从头开始启动程序"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">用户从头开始启动程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用户进程被系统kill"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">用户进程被系统kill</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#如果用户不再存在怎么办？"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">如果用户不再存在怎么办？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#怎么去模拟应用进程被系统杀死"><span class="toc-number">1.1.4.</span> <span class="toc-text">怎么去模拟应用进程被系统杀死</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#源码"><span class="toc-number">1.2.</span> <span class="toc-text">源码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#作者"><span class="toc-number">1.3.</span> <span class="toc-text">作者</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&text=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&title=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&is_video=false&description=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=使用Dagger 2来构建UserScope（翻译）&body=Check out this article: http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&title=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&title=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&title=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&title=使用Dagger 2来构建UserScope（翻译）"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://blog.wangjiegulu.com/2016/12/30/Android-使用Dagger-2来构建UserScope（翻译）/&name=使用Dagger 2来构建UserScope（翻译）&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Wang Jie
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/feed.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-111189680-2', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'blog-wangjiegulu-com';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


